<svg xmlns="http://www.w3.org/2000/svg" height="3829" preserveAspectRatio="none" style="width:2159px;height:3829px" width="2159">
  <defs>
    <filter height="300%" id="a" width="300%" x="-1" y="-1">
      <feGaussianBlur result="blurOut" stdDeviation="2"/>
      <feColorMatrix in="blurOut" result="blurOut2" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
      <feOffset dx="4" dy="4" in="blurOut2" result="blurOut3"/>
      <feBlend in="SourceGraphic" in2="blurOut3"/>
    </filter>
  </defs>
  <text font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="366" x="894.5" y="28.708">
    1.3.1. Prepare Position Handler Consume
  </text>
  <path fill="#FFFFE0" stroke="#a80036" d="M36 40.953h1856v3782.234H36z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="908.5" y="53.02">
    Central Service
  </text>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M94 150.977h10v3556.32H94zM420 2820.047h10v30h-10zM420 3677.297h10v30h-10zM549 196.242h10v2168.219h-10zM1357 2972.383h10v175.664h-10zM1835 379.172h10v77.398h-10zM1835 848.227h10v62.266h-10zM1835 996.891h10v30h-10zM1835 1104.289h10v107.664h-10zM1835 1863.203h10v30h-10zM1835 1985.734h10v30h-10zM1835 2265.195h10v30h-10zM1835 3055.781h10v30h-10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M10 157.977h2135v3564.32H10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M495.5 253.375H2135v2082.953H495.5zM20 2379.461h1919v1335.836H20z"/>
  <path fill="#FFF" d="M20 2858.047h1919v857.25H20z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M30 2918.984h1899v237.063H30z"/>
  <path stroke="#a80036" stroke-dasharray="5,5" d="M99 140.977v3598.32M424.5 140.977v3598.32M553.5 140.977v3598.32M1362 140.977v3598.32M1840 140.977v3598.32"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="40" y="137.675">
    Position Handler
  </text>
  <circle cx="99" cy="108.68" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M95 96.68l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="40" y="3751.292">
    Position Handler
  </text>
  <circle cx="99" cy="3770.594" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M95 3758.594l6-5-2 5 2 5-6-5z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M358.5 101.68h133v30.297h-133z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M354.5 105.68h133v30.297h-133z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="361.5" y="125.675">
    Notification-Topic
  </text>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M358.5 3738.297h133v30.297h-133z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M354.5 3742.297h133v30.297h-133z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="361.5" y="3762.292">
    Notification-Topic
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="523.5" y="105.081">
    Position
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="505.5" y="121.378">
    Management
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="526" y="137.675">
    Facade
  </text>
  <circle cx="554" cy="76.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M542 90.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="523.5" y="3751.292">
    Position
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="505.5" y="3767.589">
    Management
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="526" y="3783.886">
    Facade
  </text>
  <circle cx="554" cy="3803.188" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M542 3817.188h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1314" y="137.675">
    Position DAO
  </text>
  <circle cx="1362" cy="108.68" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1350 122.68h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1314" y="3751.292">
    Position DAO
  </text>
  <circle cx="1362" cy="3770.594" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1350 3784.594h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1792" y="137.675">
    Central Store
  </text>
  <path d="M1822 88.68c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1822 88.68c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1792" y="3751.292">
    Central Store
  </text>
  <path d="M1822 3764.594c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1822 3764.594c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M94 150.977h10v3556.32H94zM420 2820.047h10v30h-10zM420 3677.297h10v30h-10zM549 196.242h10v2168.219h-10zM1357 2972.383h10v175.664h-10zM1835 379.172h10v77.398h-10zM1835 848.227h10v62.266h-10zM1835 996.891h10v30h-10zM1835 1104.289h10v107.664h-10zM1835 1863.203h10v30h-10zM1835 1985.734h10v30h-10zM1835 2265.195h10v30h-10zM1835 3055.781h10v30h-10z"/>
  <path d="M10 157.977h304v7l-10 10H10v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M10 157.977h2135v3564.32H10z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="259" x="25" y="171.043">
    Prepare Position Handler Consume
  </text>
  <path fill="#A80036" stroke="#a80036" d="M537 192.242l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M104 196.242h439"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="111" y="191.176">
    1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="124" y="191.176">
    Request transfers to be processed
  </text>
  <path stroke="#a80036" d="M559 225.375h42M601 225.375v13M560 238.375h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 234.375l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="220.309">
    2
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="579" y="220.309">
    Check 1st transfer to select the Participant and Currency
  </text>
  <path d="M495.5 253.375h173v7l-10 10h-163v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M495.5 253.375H2135v2082.953H495.5z"/>
  <text fill="#00F" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="510.5" y="266.442">
    DB TRANSACTION
  </text>
  <path stroke="#a80036" d="M559 321.906h42M601 321.906v13M560 334.906h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 330.906l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="301.707">
    3
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="579" y="286.575">
    Loop through batch and build list of transferIds and calculate sumTransfersInBatch,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="579" y="301.707">
    checking all in Batch are for the correct Paricipant and Currency
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="579" y="316.84">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="665" y="316.84">
    2001, 3100
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 375.172l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 379.172h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="366.54">
    4
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="579" y="358.973">
    Retrieve current state of all transfers in array from DB with select whereIn
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1244" x="579" y="374.106">
    (FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE =&gt; RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1771 392.172h138l10 19-10 19h-138l-10-19 10-19z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1773" y="408.239">
    transferStateChange
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1773" y="423.372">
    transferParticipant
  </text>
  <path fill="#A80036" stroke="#a80036" d="M570 452.57l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M564 456.57h1275"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="576" y="451.504">
    5
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="589" y="451.504">
    Return current state of all selected transfers from DB
  </text>
  <path stroke="#a80036" d="M559 515.969h42M601 515.969v13M560 528.969h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 524.969l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="495.77">
    6
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="550" x="579" y="480.637">
    Validate current state (transferStateChange.transferStateId == &apos;RECEIVED_PREPARE&apos;)
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="579" y="495.77">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="665" y="495.77">
    2001
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="701" y="495.77">
    against failing transfers
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="579" y="510.903">
    Batch is not rejected as a whole.
  </text>
  <path d="M564 541.969v221h1516v-211l-10-10H564" fill="#D3D3D3" filter="url(#a)" stroke="#a80036"/>
  <path d="M2070 541.969v10h10l-10-10" fill="#D3D3D3" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="570" y="559.036">
    List of transfers used during processing
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="570" y="574.168">
    reservedTransfers
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="708" y="574.168">
    is list of transfers to be processed in the batch
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="570" y="589.301">
    abortedTransfers
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1212" x="702" y="589.301">
    is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="570" y="604.434">
    processedTransfers
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1345" x="720" y="604.434">
    is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and &quot;running position&quot; against each is necessary for reconciliation
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="570" y="634.7">
    Scalar intermidate values used in the algorithm
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="570" y="649.832">
    transferAmount
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="690" y="649.832">
    = payload.amount.amount
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="570" y="664.965">
    sumTransfersInBatch
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="729" y="664.965">
    = SUM amount against each Transfer in batch
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="570" y="680.098">
    currentPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="686" y="680.098">
    = participantPosition.value
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="570" y="695.231">
    reservedPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="698" y="695.231">
    = participantPosition.{original}reservedValue
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="570" y="710.364">
    effectivePosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="698" y="710.364">
    = currentPosition + reservedPosition
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="570" y="725.497">
    heldPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="665" y="725.497">
    = effectivePosition + sumTransfersInBatch
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="570" y="740.629">
    availablePosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="699" y="740.629">
    =
  </text>
  <text font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="288" x="714" y="740.629">
    if settlement model delay is IMMEDIATE then:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="1006" y="740.629">
    settlementBalance + participantLimit(NetDebitCap) - effectivePosition,
  </text>
  <text font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="65" x="1462" y="740.629">
    otherwise:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="1531" y="740.629">
    participantLimit(NetDebitCap) - effectivePosition
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="570" y="755.762">
    sumReserved
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="674" y="755.762">
    = SUM of transfers that have met rule criteria and processed
  </text>
  <path d="M508 777.828v40h1377v-30l-10-10H508" fill="#FBFB77" filter="url(#a)" stroke="#a80036"/>
  <path d="M1875 777.828v10h10l-10-10" fill="#FBFB77" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="768" x="806.25" y="794.895">
    Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="806.25" y="810.028">
    and calculate the available position for the Participant to use
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 844.227l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 848.227h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="843.161">
    7
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="579" y="843.161">
    Select effectivePosition FOR UPDATE from DB for Payer
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1779 861.227h122l10 11-10 12h-122l-10-12 10-11z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1781" y="877.293">
    participantPosition
  </text>
  <path fill="#A80036" stroke="#a80036" d="M570 906.492l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M564 910.492h1275"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="576" y="905.426">
    8
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="516" x="589" y="905.426">
    Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
  </text>
  <path stroke="#a80036" d="M559 954.758h42M601 954.758v13M560 967.758h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 963.758l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="566" y="942.125">
    9
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="579" y="934.559">
    Increment reservedValue to heldPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="579" y="949.692">
    (reservedValue = reservedPosition + sumTransfersInBatch)
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 992.89l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 996.891h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="991.825">
    10
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="588" y="991.825">
    Persist reservedValue
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1695 1039.89h289l10 19-10 19h-289l-10-19 10-19z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1697" y="1055.957">
    UPDATE
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1753" y="1055.957">
    participantPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1697" y="1071.09">
    SET reservedValue += sumTransfersInBatch
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 1100.29l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 1104.289h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1099.223">
    11
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="588" y="1099.223">
    Request position limits for Payer Participant
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1646 1117.29h388l10 34-10 34h-388l-10-34 10-34z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1648" y="1133.356">
    FROM
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="1688" y="1133.356">
    participantLimit
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1648" y="1148.489">
    WHERE participantLimit.limitTypeId = &apos;NET-DEBIT-CAP&apos;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1648" y="1163.622">
    AND participantLimit.participantId = payload.payerFsp
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="1648" y="1178.754">
    AND participantLimit.currencyId = payload.amount.currency
  </text>
  <path fill="#A80036" stroke="#a80036" d="M570 1207.953l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M564 1211.953h1275"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="576" y="1206.887">
    12
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="598" y="1206.887">
    Return position limits
  </text>
  <path stroke="#a80036" d="M559 1301.617h42M601 1301.617v13M560 1314.617h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 1310.617l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1266.286">
    13
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="588" y="1236.02">
    availablePosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="717" y="1236.02">
    =
  </text>
  <text font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="288" x="732" y="1236.02">
    if settlement model delay is IMMEDIATE then:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="592" y="1251.153">
    settlementBalance + participantLimit(NetDebitCap) - effectivePosition
  </text>
  <text font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="65" x="592" y="1266.286">
    otherwise:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="592" y="1281.418">
    participantLimit(NetDebitCap) - effectivePosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="549" x="588" y="1296.551">
    (same as = (settlementBalance?) + netDebitCap - currentPosition - reservedPosition)
  </text>
  <path d="M508 1327.617v40h1377v-30l-10-10H508" fill="#FBFB77" filter="url(#a)" stroke="#a80036"/>
  <path d="M1875 1327.617v10h10l-10-10" fill="#FBFB77" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="603" x="888.75" y="1344.684">
    For each transfer in the batch, validate the availablility of position to meet the transfer amount
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="888.75" y="1359.817">
    this will be as per the position algorithm documented below
  </text>
  <path stroke="#a80036" d="M559 1413.148h42M601 1413.148v13M560 1426.148h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 1422.148l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1400.516">
    14
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="588" y="1392.95">
    Validate availablePosition for each tranfser (see algorithm below)
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="588" y="1408.082">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="674" y="1408.082">
    4001
  </text>
  <path d="M564 1439.148v267h1401v-257l-10-10H564" fill="#D3D3D3" filter="url(#a)" stroke="#a80036"/>
  <path d="M1955 1439.148v10h10l-10-10" fill="#D3D3D3" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="579" x="570" y="1456.215">
    01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="563" x="570" y="1471.348">
    02: sumProcessed =0 // Record the sum of the transfers already processed in this batch
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1090" x="570" y="1486.481">
    03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the &quot;running&quot; position
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="570" y="1501.614">
    04: foreach transfer in reservedTransfers
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="586" y="1516.747">
    05: sumProcessed += transfer.amount // the total processed so far
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="1022" y="1516.747">
    (NEED TO UPDATE IN CODE)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="586" y="1531.879">
    06: if availablePosition &gt;= transfer.amount
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="602" y="1547.012">
    07: transfer.state = &quot;RESERVED&quot;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="602" y="1562.145">
    08: availablePosition -= preparedTransfer.amount
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="602" y="1577.278">
    09: sumRESERVED += preparedTransfer.amount
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="586" y="1592.411">
    10: else
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="602" y="1607.543">
    11: preparedTransfer.state = &quot;ABORTED&quot;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="686" x="602" y="1622.676">
    12: preparedTransfer.reason = &quot;Net Debit Cap exceeded by this request at this time, please try again later&quot;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="586" y="1637.809">
    13: end if
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1031" x="586" y="1652.942">
    14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="553" x="586" y="1668.075">
    15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="1143" y="1668.075">
    (NEED TO UPDATE IN CODE)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="1352" y="1668.075">
    // the running down of the total reserved value at the begining of the batch.
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1364" x="586" y="1683.207">
    16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount, runningPosition, runningReservedValue }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="570" y="1698.34">
    16: end foreach
  </text>
  <path d="M508 1720.406v55h1377v-45l-10-10H508" fill="#FBFB77" filter="url(#a)" stroke="#a80036"/>
  <path d="M1875 1720.406v10h10l-10-10" fill="#FBFB77" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="874" x="593.25" y="1737.473">
    Once the outcome for all transfers is known,update the Participant&apos;s position and remove the reserved amount associated with the batch
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="654" x="593.25" y="1752.606">
    (If there are any alarm limits, process those returning limits in which the threshold has been breached)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1194" x="593.25" y="1767.739">
    Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position
  </text>
  <path stroke="#a80036" d="M559 1821.07h42M601 1821.07v13M560 1834.07h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 1830.07l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1808.438">
    15
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="588" y="1800.872">
    Assess any limit thresholds on the final position
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="588" y="1816.004">
    adding to alarm list if triggered
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 1859.203l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 1863.203h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1858.137">
    16
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="588" y="1858.137">
    Persist latest position
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="729" y="1858.137">
    value
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="772" y="1858.137">
    and
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="800" y="1858.137">
    reservedValue
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="910" y="1858.137">
    to DB for Payer
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1712 1906.203h255l10 26-10 27h-255l-10-27 10-26z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1714" y="1922.27">
    UPDATE
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1770" y="1922.27">
    participantPosition
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="1714" y="1937.403">
    SET value += sumRESERVED,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1714" y="1952.536">
    reservedValue -= sumTransfersInBatch
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 1981.734l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 1985.734h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="1980.668">
    17
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="588" y="1980.668">
    Bulk persist transferStateChange for all processedTransfers
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1565 2028.734h550l10 34-10 34h-550l-10-34 10-34z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1567" y="2044.801">
    batch INSERT
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1656" y="2044.801">
    transferStateChange
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="546" x="1567" y="2059.934">
    select for update from transfer table where transferId in ([transferBatch.transferId,...])
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1567" y="2075.067">
    build list of transferStateChanges from transferBatch
  </text>
  <path stroke="#a80036" d="M559 2123.398h42M601 2123.398v13M560 2136.398h41"/>
  <path fill="#A80036" stroke="#a80036" d="M570 2132.398l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="2118.332">
    18
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="762" x="588" y="2118.332">
    Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list
  </text>
  <path d="M564 2149.398v85h500v-75l-10-10H564" fill="#D3D3D3" filter="url(#a)" stroke="#a80036"/>
  <path d="M1054 2149.398v10h10l-10-10" fill="#D3D3D3" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="570" y="2166.465">
    Effectively:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="586" y="2181.598">
    SET transferStateChangeId = processedTransfer.transferStateChangeId,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="586" y="2196.731">
    participantPositionId = preparedTransfer.participantPositionId,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="586" y="2211.864">
    value = preparedTransfer.positionValue,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="586" y="2226.997">
    reservedValue = preparedTransfer.positionReservedValue
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 2261.195l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M559 2265.195h1270"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="566" y="2260.129">
    19
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444" x="588" y="2260.129">
    Bulk persist the participant position change for all processedTransfers
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1695 2308.195h289l10 11-10 12h-289l-10-12 10-11z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1697" y="2324.262">
    batch INSERT
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="1786" y="2324.262">
    participantPositionChange
  </text>
  <path fill="#A80036" stroke="#a80036" d="M115 2360.46l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M109 2364.461h444"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="121" y="2359.395">
    20
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="143" y="2359.395">
    Return a map of transferIds and their transferStateChanges
  </text>
  <path d="M20 2379.46h64v7l-10 10H20v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M20 2379.461h1919v1335.836H20z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="35" y="2392.528">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="99" y="2391.671">
    [Calculate &amp; Validate Latest Position Prepare (success)]
  </text>
  <path d="M109 2401.594v373h270v-363l-10-10H109" fill="#FF0" filter="url(#a)" stroke="#a80036"/>
  <path d="M369 2401.594v10h10l-10-10" fill="#FF0" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="115" y="2418.661">
    Message:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="115" y="2433.794">
    {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="131" y="2448.926">
    id: &lt;transferMessage.transferId&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="131" y="2464.059">
    from: &lt;transferMessage.payerFsp&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="131" y="2479.192">
    to: &lt;transferMessage.payeeFsp&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="131" y="2494.325">
    type: application/json
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="131" y="2509.457">
    content: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="147" y="2524.59">
    headers: &lt;transferHeaders&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="147" y="2539.723">
    payload: &lt;transferMessage&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="131" y="2554.856">
    },
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="131" y="2569.989">
    metadata: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="147" y="2585.122">
    event: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="163" y="2600.254">
    id: &lt;uuid&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="163" y="2615.387">
    responseTo: &lt;previous.uuid&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="163" y="2630.52">
    type: transfer,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="163" y="2645.653">
    action: prepare,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="163" y="2660.786">
    createdAt: &lt;timestamp&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="163" y="2675.919">
    state: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="179" y="2691.051">
    status: &quot;success&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="179" y="2706.184">
    code: 0
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="2721.317">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="2736.45">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="131" y="2751.582">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="115" y="2766.715">
    }
  </text>
  <path fill="#A80036" stroke="#a80036" d="M408 2816.047l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M104 2820.047h310"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="111" y="2807.415">
    21
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="133" y="2799.848">
    Publish Notification event
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="133" y="2814.981">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="219" y="2814.981">
    2003
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M20 2859.047h1919"/>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="352" x="25" y="2869.257">
    [Calculate &amp; Validate Latest Position Prepare (failure)]
  </text>
  <path d="M109 2877.852v25h132v-15l-10-10H109" fill="red" filter="url(#a)" stroke="#a80036"/>
  <path d="M231 2877.852v10h10l-10-10" fill="red" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="115" y="2894.919">
    Validation failure!
  </text>
  <path d="M30 2918.984h608v7l-10 10H30v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M30 2918.984h1899v237.063H30z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="563" x="45" y="2932.051">
    Persist Transfer State (with transferState=&apos;ABORTED&apos; on position check fail)
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1345 2968.383l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M104 2972.383h1247"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="111" y="2959.751">
    22
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="133" y="2952.184">
    Request to persist transfer
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="133" y="2967.317">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="219" y="2967.317">
    2003
  </text>
  <path d="M109 2985.383v40h707v-30l-10-10H109" fill="#D3D3D3" filter="url(#a)" stroke="#a80036"/>
  <path d="M806 2985.383v10h10l-10-10" fill="#D3D3D3" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="115" y="3002.45">
    transferStateChange.state = &quot;ABORTED&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="686" x="115" y="3017.582">
    transferStateChange.reason = &quot;Net Debit Cap exceeded by this request at this time, please try again later&quot;
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1823 3051.781l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1367 3055.781h462"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1374" y="3050.715">
    23
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1396" y="3050.715">
    Persist transfer state
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1771 3098.781h138l10 11-10 12h-138l-10-12 10-11z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1773" y="3114.848">
    transferStateChange
  </text>
  <path fill="#A80036" stroke="#a80036" d="M115 3144.047l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M109 3148.047h1252"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="121" y="3142.981">
    24
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="143" y="3142.981">
    Return success
  </text>
  <path d="M109 3168.047v463h408v-453l-10-10H109" fill="#FF0" filter="url(#a)" stroke="#a80036"/>
  <path d="M507 3168.047v10h10l-10-10" fill="#FF0" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="115" y="3185.114">
    Message:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="115" y="3200.247">
    {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="131" y="3215.379">
    id: &lt;transferMessage.transferId&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="131" y="3230.512">
    from: &lt;ledgerName&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="131" y="3245.645">
    to: &lt;transferMessage.payerFsp&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="131" y="3260.778">
    type: application/json
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="131" y="3275.911">
    content: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="147" y="3291.044">
    headers: &lt;transferHeaders&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="147" y="3306.176">
    payload: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="163" y="3321.309">
    &quot;errorInformation&quot;: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="179" y="3336.442">
    &quot;errorCode&quot;: 4001,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="179" y="3351.575">
    &quot;errorDescription&quot;: &quot;Payer FSP insufficient liquidity&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="179" y="3366.707">
    &quot;extensionList&quot;: &lt;transferMessage.extensionList&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="3381.84">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="131" y="3396.973">
    },
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="131" y="3412.106">
    metadata: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="147" y="3427.239">
    event: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="163" y="3442.372">
    id: &lt;uuid&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="163" y="3457.504">
    responseTo: &lt;previous.uuid&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="163" y="3472.637">
    type: notification,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="163" y="3487.77">
    action: prepare,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="163" y="3502.903">
    createdAt: &lt;timestamp&gt;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="163" y="3518.036">
    state: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="179" y="3533.169">
    status: &apos;error&apos;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="179" y="3548.301">
    code: &lt;errorInformation.errorCode&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="179" y="3563.434">
    description: &lt;errorInformation.errorDescription&gt;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="3578.567">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="3593.7">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="131" y="3608.832">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="115" y="3623.965">
    }
  </text>
  <path fill="#A80036" stroke="#a80036" d="M408 3673.297l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M104 3677.297h310"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="111" y="3664.665">
    25
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="133" y="3657.098">
    Publish Notification (failure) event for Payer
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="133" y="3672.231">
    Error code:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="219" y="3672.231">
    2003
  </text>
</svg>
