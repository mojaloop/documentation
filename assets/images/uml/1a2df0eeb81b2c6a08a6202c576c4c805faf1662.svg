<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6952px" preserveAspectRatio="none" style="width:1733px;height:6952px;" version="1.1" viewBox="0 0 1733 6952" width="1733px" zoomAndPan="magnify"><defs><filter height="300%" id="fx67m4y7jlmw5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="740" y="22.9951">1.1.1. Bulk Prepare Handler Consume</text><rect fill="#FFFFE0" height="6907.5234" style="stroke: #A80036; stroke-width: 1.0;" width="1584" x="39" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="782" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="739.6797"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="5580.7891"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="199.5" y="173.2891"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="6736.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="426.5" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="6238.1719"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="2328.2422"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="2819.6328"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="3401.8203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="4007.0078"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="6812.2266"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1076.8047"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1517.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1730.8594"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="4110.0781"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="166.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="4901.6641"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="181.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="5173.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="5678.3203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1316" y="4298.7422"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1316" y="4551.9375"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1105.9375"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1546.9297"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1759.9922"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4139.2109"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4327.875"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4581.0703"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4930.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="5202.9297"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="5707.4531"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="6722.2031" style="stroke: #000000; stroke-width: 2.0;" width="1709" x="13" y="135.0234"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="522.5" x="366" y="218.2891"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="502.5" x="376" y="242.4219"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="685" x="376" y="337.8203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="4869.2422" style="stroke: #000000; stroke-width: 2.0;" width="1689" x="23" y="508.4844"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="90.5313" style="stroke: #000000; stroke-width: 2.0;" width="454" x="33" y="686.2813"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="3368.1328" style="stroke: #000000; stroke-width: 2.0;" width="1366" x="336" y="878.3438"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="3027.1406" style="stroke: #000000; stroke-width: 2.0;" width="1346" x="346" y="1212.3359"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="685" x="376" y="1236.4688"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="2587.6094" style="stroke: #000000; stroke-width: 2.0;" width="1326" x="356" y="1464.3984"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="1778.3594" style="stroke: #000000; stroke-width: 2.0;" width="1306" x="366" y="1668.4609"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="1747.2266" style="stroke: #000000; stroke-width: 2.0;" width="1286" x="376" y="1692.5938"/><rect fill="#FFFFFF" height="491.3906" style="stroke: none; stroke-width: 1.0;" width="1286" x="376" y="2366.2422"/><rect fill="#FFFFFF" height="582.1875" style="stroke: none; stroke-width: 1.0;" width="1286" x="376" y="2857.6328"/><rect fill="#FFFFFF" height="598.1875" style="stroke: none; stroke-width: 1.0;" width="1326" x="356" y="3453.8203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="569.3828" style="stroke: #000000; stroke-width: 2.0;" width="789" x="376" y="3475.625"/><rect fill="#FFFFFF" height="180.4688" style="stroke: none; stroke-width: 1.0;" width="1346" x="346" y="4059.0078"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1279" x="376" y="4260.4766"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1279" x="376" y="4513.6719"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="546.5938" style="stroke: #000000; stroke-width: 2.0;" width="1315" x="366" y="4824.1328"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="228.1953" style="stroke: #000000; stroke-width: 2.0;" width="1295" x="376" y="4848.2656"/><rect fill="#FFFFFF" height="287.2656" style="stroke: none; stroke-width: 1.0;" width="1315" x="366" y="5083.4609"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="258.4609" style="stroke: #000000; stroke-width: 2.0;" width="1295" x="376" y="5105.2656"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="1458.5" style="stroke: #000000; stroke-width: 2.0;" width="1664" x="23" y="5391.7266"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="748.7813" style="stroke: #000000; stroke-width: 2.0;" width="1644" x="33" y="5527.3906"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1291" x="376" y="5624.9219"/><rect fill="#FFFFFF" height="567.0547" style="stroke: none; stroke-width: 1.0;" width="1664" x="23" y="6283.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="93" x2="93" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="204" x2="204" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="431" x2="431" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="883" x2="883" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1003" x2="1003" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1108" x2="1108" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1211" x2="1211" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1321" x2="1321" y1="118.0234" y2="6874.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1575" x2="1575" y1="118.0234" y2="6874.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="47" y="62.4297"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="43" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="64.5" y="86.4248">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="50" y="102.7217">object-store</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="47" y="6873.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="43" y="6877.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="64.5" y="6897.2217">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="50" y="6913.5186">object-store</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="157" y="62.4297"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="153" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="182" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="160" y="102.7217">bulk-prepare</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="157" y="6873.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="153" y="6877.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="182" y="6897.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="160" y="6913.5186">bulk-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="386" y="98.4248">Bulk Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="403.5" y="114.7217">Handler</text><ellipse cx="431.5" cy="69.4297" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="427.5,57.4297,433.5,52.4297,431.5,57.4297,433.5,62.4297,427.5,57.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="386" y="6886.2217">Bulk Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="403.5" y="6902.5186">Handler</text><ellipse cx="431.5" cy="6921.8203" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="427.5,6909.8203,433.5,6904.8203,431.5,6909.8203,433.5,6914.8203,427.5,6909.8203" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="825" y="62.4297"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="821" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="861" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="828" y="102.7217">transfer-prepare</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="825" y="6873.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="821" y="6877.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="861" y="6897.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="828" y="6913.5186">transfer-prepare</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="960" y="78.7266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="956" y="82.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="963" y="102.7217">topic-event</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="960" y="6873.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="956" y="6877.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="963" y="6897.2217">topic-event</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1065" y="62.4297"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1061" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="1085.5" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1068" y="102.7217">notification</text><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1065" y="6873.2266"/><rect fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1061" y="6877.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="1085.5" y="6897.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1068" y="6913.5186">notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1165" y="114.7217">Position DAO</text><ellipse cx="1211" cy="85.7266" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1199" x2="1223" y1="99.7266" y2="99.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1165" y="6886.2217">Position DAO</text><ellipse cx="1211" cy="6905.5234" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1199" x2="1223" y1="6919.5234" y2="6919.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1267" y="114.7217">Participant DAO</text><ellipse cx="1321" cy="85.7266" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1309" x2="1333" y1="99.7266" y2="99.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1267" y="6886.2217">Participant DAO</text><ellipse cx="1321" cy="6905.5234" fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1309" x2="1333" y1="6919.5234" y2="6919.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1531" y="114.7217">Central Store</text><path d="M1557,65.7266 C1557,55.7266 1575,55.7266 1575,55.7266 C1575,55.7266 1593,55.7266 1593,65.7266 L1593,91.7266 C1593,101.7266 1575,101.7266 1575,101.7266 C1575,101.7266 1557,101.7266 1557,91.7266 L1557,65.7266 " fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1557,65.7266 C1557,75.7266 1575,75.7266 1575,75.7266 C1575,75.7266 1593,75.7266 1593,65.7266 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1531" y="6886.2217">Central Store</text><path d="M1557,6899.5234 C1557,6889.5234 1575,6889.5234 1575,6889.5234 C1575,6889.5234 1593,6889.5234 1593,6899.5234 L1593,6925.5234 C1593,6935.5234 1575,6935.5234 1575,6935.5234 C1575,6935.5234 1557,6935.5234 1557,6925.5234 L1557,6899.5234 " fill="#FEFECE" filter="url(#fx67m4y7jlmw5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1557,6899.5234 C1557,6909.5234 1575,6909.5234 1575,6909.5234 C1575,6909.5234 1593,6909.5234 1593,6899.5234 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="739.6797"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="5580.7891"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="199.5" y="173.2891"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="6736.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="426.5" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="6238.1719"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="2328.2422"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="2819.6328"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="3401.8203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="4007.0078"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="6812.2266"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1076.8047"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1517.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="1730.8594"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="4110.0781"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="166.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="4901.6641"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="181.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="5173.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1206" y="5678.3203"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1316" y="4298.7422"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1316" y="4551.9375"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1105.9375"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1546.9297"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="1759.9922"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4139.2109"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4327.875"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4581.0703"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="4930.7969"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="5202.9297"/><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1570" y="5707.4531"/><path d="M13,135.0234 L256,135.0234 L256,142.0234 L246,152.0234 L13,152.0234 L13,135.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="6722.2031" style="stroke: #000000; stroke-width: 2.0;" width="1709" x="13" y="135.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="28" y="148.0903">Bulk Prepare Handler Consume</text><polygon fill="#A80036" points="220.5,169.2891,210.5,173.2891,220.5,177.2891,216.5,173.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="214.5" x2="425.5" y1="173.2891" y2="173.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="226.5" y="168.2231">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="237.5" y="168.2231">Consume Bulk Prepare message</text><path d="M366,218.2891 L449,218.2891 L449,225.2891 L439,235.2891 L366,235.2891 L366,218.2891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="522.5" x="366" y="218.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="381" y="231.356">break</text><path d="M376,242.4219 L514,242.4219 L514,249.4219 L504,259.4219 L376,259.4219 L376,242.4219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="502.5" x="376" y="242.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="391" y="255.4888">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="295.8203" y2="295.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="295.8203" y2="308.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="308.8203" y2="308.8203"/><polygon fill="#A80036" points="447.5,304.8203,437.5,308.8203,447.5,312.8203,443.5,308.8203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="283.188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="412" x="454.5" y="275.6216">Validate event - Rule: type == 'bulk-prepare' &amp;&amp; action == 'bulk-prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="454.5" y="290.7544">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="534.5" y="290.7544">2001</text><path d="M376,337.8203 L586,337.8203 L586,344.8203 L576,354.8203 L376,354.8203 L376,337.8203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="685" x="376" y="337.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="391" y="350.8872">Persist Event Information</text><polygon fill="#A80036" points="991.5,397.0859,1001.5,401.0859,991.5,405.0859,995.5,401.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="997.5" y1="401.0859" y2="401.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="396.02">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="454.5" y="396.02">Publish event information</text><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="667" x="383" y="409.0859"/><polygon fill="#EEEEEE" points="383,409.0859,447,409.0859,447,416.0859,437,426.0859,383,426.0859,383,409.0859" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="396" y="423.1528">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="648" y="442.1528">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="651" y="457.2856"/><path d="M23,508.4844 L264,508.4844 L264,515.4844 L254,525.4844 L23,525.4844 L23,508.4844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4869.2422" style="stroke: #000000; stroke-width: 2.0;" width="1689" x="23" y="508.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="38" y="521.5513">Validate Bulk Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="546.75" y2="546.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="546.75" y2="559.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="559.75" y2="559.75"/><polygon fill="#A80036" points="447.5,555.75,437.5,559.75,447.5,563.75,443.5,559.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="541.6841">4</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="454.5" y="541.6841">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="588.8828" y2="588.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="588.8828" y2="601.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="601.8828" y2="601.8828"/><polygon fill="#A80036" points="447.5,597.8828,437.5,601.8828,447.5,605.8828,443.5,601.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="583.8169">5</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="454.5" y="583.8169">Verify the message's signature (to be confirmed in future requirement)</text><path d="M441,614.8828 L441,669.8828 L782,669.8828 L782,624.8828 L772,614.8828 L441,614.8828 " fill="#D3D3D3" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M772,614.8828 L772,624.8828 L782,624.8828 L772,614.8828 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="447" y="631.9497">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="447" y="647.0825">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="447" y="662.2153">It may need to be added in future for custom adapters.</text><path d="M33,686.2813 L276,686.2813 L276,693.2813 L266,703.2813 L33,703.2813 L33,686.2813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.5313" style="stroke: #000000; stroke-width: 2.0;" width="454" x="33" y="686.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="48" y="699.3481">Individual transfers in the bulk</text><polygon fill="#A80036" points="109,735.6797,99,739.6797,109,743.6797,105,739.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="103" x2="425.5" y1="739.6797" y2="739.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="115" y="727.0474">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="126" y="719.481">Retrieve all individual transfer IDs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="126" y="734.6138">in the bulk using its reference</text><polygon fill="#A80036" points="414.5,764.8125,424.5,768.8125,414.5,772.8125,418.5,768.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="93" x2="420.5" y1="768.8125" y2="768.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="100" y="763.7466">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="111" y="763.7466">Return individual transfers as queried</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="850.3438" y2="850.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="850.3438" y2="863.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="863.3438" y2="863.3438"/><polygon fill="#A80036" points="447.5,859.3438,437.5,863.3438,447.5,867.3438,443.5,863.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="822.5786">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="454.5" y="799.8794">Validate that there are no duplicate individualTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="454.5" y="815.0122">(transfer IDs) from the same bulk.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="454.5" y="830.145">On failure, send bulk error message to Payer.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="454.5" y="845.2778">No further processing on individual transfers is done</text><path d="M336,878.3438 L541,878.3438 L541,885.3438 L531,895.3438 L336,895.3438 L336,878.3438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3368.1328" style="stroke: #000000; stroke-width: 2.0;" width="1366" x="336" y="878.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="351" y="891.4106">Validate Duplicate check</text><path d="M441,900.4766 L441,1046.4766 L841,1046.4766 L841,910.4766 L831,900.4766 L441,900.4766 " fill="#00FFFF" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M831,900.4766 L831,910.4766 L841,910.4766 L831,900.4766 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="447" y="917.5435">The Specification doesn't touch on the duplicate handling</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="447" y="932.6763">of bulk transfers, so the current design mostly follows the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="447" y="947.8091">strategy used for individual transfers, except in two places.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="447" y="962.9419">For duplicate requests where hash matches, the current design</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="447" y="978.0747">includes only the status of the bulk &amp; timestamp (if completed),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="447" y="993.2075">but not the individual transfers (for which a GET should be used).</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="450" y="1008.3403"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="447" y="1023.4731">For duplicate requests where hash matches but are not in a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="447" y="1038.606">finalized state, only the state of the bulkTransfer is sent.</text><polygon fill="#A80036" points="1194,1072.8047,1204,1076.8047,1194,1080.8047,1198,1076.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="1076.8047" y2="1076.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="443.5" y="1071.7388">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="454.5" y="1071.7388">Request to retrieve Hash for a bulkTransferId</text><polygon fill="#A80036" points="1558,1101.9375,1568,1105.9375,1558,1109.9375,1562,1105.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="1105.9375" y2="1105.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="1100.8716">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="1241" y="1100.8716">Request Transfer Hash for a bulkTransferId</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1491,1118.9375,1659,1118.9375,1669,1129.9375,1659,1141.9375,1491,1141.9375,1481,1129.9375,1491,1118.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="1493" y="1135.0044">bulkTransferDuplicateCheck</text><polygon fill="#A80036" points="1227,1164.2031,1217,1168.2031,1227,1172.2031,1223,1168.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1221" x2="1574" y1="1168.2031" y2="1168.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1233" y="1163.1372">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1251" y="1163.1372">Return hash if it exists</text><polygon fill="#A80036" points="447.5,1193.3359,437.5,1197.3359,447.5,1201.3359,443.5,1197.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="1197.3359" y2="1197.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="1192.27">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="471.5" y="1192.27">Return hash if it exists</text><path d="M346,1212.3359 L409,1212.3359 L409,1219.3359 L399,1229.3359 L346,1229.3359 L346,1212.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3027.1406" style="stroke: #000000; stroke-width: 2.0;" width="1346" x="346" y="1212.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="361" y="1225.4028">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="424" y="1224.5464">[If bulkTransferId exists]</text><path d="M376,1236.4688 L586,1236.4688 L586,1243.4688 L576,1253.4688 L376,1253.4688 L376,1236.4688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="685" x="376" y="1236.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="391" y="1249.5356">Persist Event Information</text><polygon fill="#A80036" points="991.5,1295.7344,1001.5,1299.7344,991.5,1303.7344,995.5,1299.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="997.5" y1="1299.7344" y2="1299.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="1294.6685">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="461.5" y="1294.6685">Publish event information</text><rect fill="#FFFFFF" filter="url(#fx67m4y7jlmw5)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="667" x="383" y="1307.7344"/><polygon fill="#EEEEEE" points="383,1307.7344,447,1307.7344,447,1314.7344,437,1324.7344,383,1324.7344,383,1307.7344" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="396" y="1321.8013">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="648" y="1340.8013">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="651" y="1355.9341"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="1436.3984" y2="1436.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="1436.3984" y2="1449.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="1449.3984" y2="1449.3984"/><polygon fill="#A80036" points="447.5,1445.3984,437.5,1449.3984,447.5,1453.3984,443.5,1449.3984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="1423.7661">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="461.5" y="1416.1997">Generate Hash for the incoming message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="461.5" y="1431.3325">and compare hashes</text><path d="M356,1464.3984 L419,1464.3984 L419,1471.3984 L409,1481.3984 L356,1481.3984 L356,1464.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2587.6094" style="stroke: #000000; stroke-width: 2.0;" width="1326" x="356" y="1464.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="371" y="1477.4653">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="434" y="1476.6089">[BulkTransfer exists, hash matches]</text><polygon fill="#A80036" points="1194,1513.7969,1204,1517.7969,1194,1521.7969,1198,1517.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="1517.7969" y2="1517.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="1505.1646">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="461.5" y="1497.5981">Request to retrieve Bulk Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="461.5" y="1512.731">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="535.5" y="1512.731">2003</text><polygon fill="#A80036" points="1558,1542.9297,1568,1546.9297,1558,1550.9297,1562,1546.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="1546.9297" y2="1546.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="1541.8638">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="1241" y="1541.8638">Request BulkTransfer state</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1499,1559.9297,1651,1559.9297,1661,1578.9297,1651,1597.9297,1499,1597.9297,1489,1578.9297,1499,1559.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1501" y="1575.9966">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1501" y="1591.1294">bulkTransferStateChange</text><polygon fill="#A80036" points="1227,1620.3281,1217,1624.3281,1227,1628.3281,1223,1624.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1221" x2="1574" y1="1624.3281" y2="1624.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1233" y="1619.2622">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1251" y="1619.2622">Return Transfer state</text><polygon fill="#A80036" points="447.5,1649.4609,437.5,1653.4609,447.5,1657.4609,443.5,1653.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="1653.4609" y2="1653.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="1648.395">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="471.5" y="1648.395">Return Transfer state</text><path d="M366,1668.4609 L449,1668.4609 L449,1675.4609 L439,1685.4609 L366,1685.4609 L366,1668.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1778.3594" style="stroke: #000000; stroke-width: 2.0;" width="1306" x="366" y="1668.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="381" y="1681.5278">break</text><path d="M376,1692.5938 L439,1692.5938 L439,1699.5938 L429,1709.5938 L376,1709.5938 L376,1692.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1747.2266" style="stroke: #000000; stroke-width: 2.0;" width="1286" x="376" y="1692.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="391" y="1705.6606">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="276" x="454" y="1704.8042">[If bulkTransferState IN ['COMPLETED', 'REJECTED']]</text><polygon fill="#A80036" points="1194,1726.8594,1204,1730.8594,1194,1734.8594,1198,1730.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="1730.8594" y2="1730.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="1725.7935">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="461.5" y="1725.7935">Request to retrieve completedTimestamp</text><polygon fill="#A80036" points="1558,1755.9922,1568,1759.9922,1558,1763.9922,1562,1759.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="1759.9922" y2="1759.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="1754.9263">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="1241" y="1754.9263">Return completedTimestamp</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1507,1772.9922,1642,1772.9922,1652,1791.9922,1642,1810.9922,1507,1810.9922,1497,1791.9922,1507,1772.9922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1509" y="1789.0591">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="1509" y="1804.1919">bulkTransferFulfilment</text><polygon fill="#A80036" points="1227,1833.3906,1217,1837.3906,1227,1841.3906,1223,1837.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1221" x2="1574" y1="1837.3906" y2="1837.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1233" y="1832.3247">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="1251" y="1832.3247">Return completedTimestamp</text><polygon fill="#A80036" points="447.5,1862.5234,437.5,1866.5234,447.5,1870.5234,443.5,1866.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="1866.5234" y2="1866.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="1861.4575">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="471.5" y="1861.4575">Return completedTimestamp</text><path d="M441,1879.5234 L441,2297.5234 L818,2297.5234 L818,1889.5234 L808,1879.5234 L441,1879.5234 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M808,1879.5234 L808,1889.5234 L818,1889.5234 L808,1879.5234 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="1896.5903">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="1911.7231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="459" y="1926.856">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="459" y="1941.9888">from: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="459" y="1957.1216">to: &lt;bulkTransferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="1972.2544">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="1987.3872">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="471" y="2002.52">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="471" y="2017.6528">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="483" y="2032.7856">bulkTransferState: "COMPLETED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="483" y="2047.9185">completedTimestamp: "2019-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="2063.0513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="2078.1841">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="2093.3169">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="2108.4497">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="2123.5825">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="2138.7153">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="483" y="2153.8481">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="483" y="2168.981">action: bulk-prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="2184.1138">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="2199.2466">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="495" y="2214.3794">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="495" y="2229.5122">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="2244.645">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="2259.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="2274.9106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="2290.0435">}</text><polygon fill="#A80036" points="1091,2324.2422,1101,2328.2422,1091,2332.2422,1095,2328.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1097" y1="2328.2422" y2="2328.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="2323.1763">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="461.5" y="2323.1763">Publish Notification event for Payer with the completed bulk transfer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="376" x2="1662" y1="2367.2422" y2="2367.2422"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="564" x="381" y="2377.4526">[If bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE', 'ACCEPTED', 'PROCESSING', 'PENDING_FULFIL']]</text><path d="M441,2386.0469 L441,2789.0469 L720,2789.0469 L720,2396.0469 L710,2386.0469 L441,2386.0469 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M710,2386.0469 L710,2396.0469 L720,2396.0469 L710,2386.0469 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="2403.1138">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="2418.2466">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="459" y="2433.3794">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="459" y="2448.5122">from: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="459" y="2463.645">to: &lt;bulkTransferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="2478.7778">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="2493.9106">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="471" y="2509.0435">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="471" y="2524.1763">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="483" y="2539.3091">bulkTransferState: "?TODO?"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="2554.4419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="2569.5747">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="2584.7075">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="2599.8403">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="2614.9731">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="2630.106">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="483" y="2645.2388">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="483" y="2660.3716">action: bulk-prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="2675.5044">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="2690.6372">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="495" y="2705.77">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="495" y="2720.9028">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="2736.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="2751.1685">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="2766.3013">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="2781.4341">}</text><polygon fill="#A80036" points="447.5,2815.6328,437.5,2819.6328,447.5,2823.6328,443.5,2819.6328" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="1091,2815.6328,1101,2819.6328,1091,2823.6328,1095,2819.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="441.5" x2="1097" y1="2819.6328" y2="2819.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="2814.5669">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="471.5" y="2814.5669">Publish Notification event for Payer with the completed bulk transfer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="376" x2="1662" y1="2858.6328" y2="2858.6328"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="381" y="2868.8433">[If bulkTransferState does not exist]</text><path d="M441,2877.4375 L441,3340.4375 L797,3340.4375 L797,2887.4375 L787,2877.4375 L441,2877.4375 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M787,2877.4375 L787,2887.4375 L797,2887.4375 L787,2877.4375 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="2894.5044">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="2909.6372">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="459" y="2924.77">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="459" y="2939.9028">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="459" y="2955.0356">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="2970.1685">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="2985.3013">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="471" y="3000.4341">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="471" y="3015.5669">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="483" y="3030.6997">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="495" y="3045.8325">"errorCode": "3100",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="495" y="3060.9653">"errorDescription": "&lt;error description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="495" y="3076.0981">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="3091.231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="3106.3638">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="3121.4966">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="3136.6294">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="3151.7622">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="3166.895">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="483" y="3182.0278">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="483" y="3197.1606">action: bulk-prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="3212.2935">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="3227.4263">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="495" y="3242.5591">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="495" y="3257.6919">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="495" y="3272.8247">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="3287.9575">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="3303.0903">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="3318.2231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="3333.356">}</text><polygon fill="#A80036" points="1091,3397.8203,1101,3401.8203,1091,3405.8203,1095,3401.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1097" y1="3401.8203" y2="3401.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="3381.6216">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="461.5" y="3366.4888">Send /error callback with appropriate error message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="461.5" y="3381.6216">(Invalid duplicate request)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="461.5" y="3396.7544">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="535.5" y="3396.7544">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="1682" y1="3454.8203" y2="3454.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="361" y="3465.0308">[BulkTransfer exists, hash does not match]</text><path d="M376,3475.625 L459,3475.625 L459,3482.625 L449,3492.625 L376,3492.625 L376,3475.625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="569.3828" style="stroke: #000000; stroke-width: 2.0;" width="789" x="376" y="3475.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="391" y="3488.6919">break</text><path d="M441,3497.7578 L441,3960.7578 L797,3960.7578 L797,3507.7578 L787,3497.7578 L441,3497.7578 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M787,3497.7578 L787,3507.7578 L797,3507.7578 L787,3497.7578 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="3514.8247">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="3529.9575">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="459" y="3545.0903">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="459" y="3560.2231">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="459" y="3575.356">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="3590.4888">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="3605.6216">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="471" y="3620.7544">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="471" y="3635.8872">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="483" y="3651.02">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="495" y="3666.1528">"errorCode": "3106"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="495" y="3681.2856">"errorDescription": "&lt;error description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="495" y="3696.4185">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="3711.5513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="3726.6841">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="3741.8169">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="3756.9497">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="3772.0825">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="3787.2153">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="483" y="3802.3481">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="483" y="3817.481">action: bulk-prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="3832.6138">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="3847.7466">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="495" y="3862.8794">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="495" y="3878.0122">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="495" y="3893.145">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="3908.2778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="3923.4106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="3938.5435">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="3953.6763">}</text><polygon fill="#A80036" points="1091,4003.0078,1101,4007.0078,1091,4011.0078,1095,4007.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1097" y1="4007.0078" y2="4007.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="3994.3755">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="461.5" y="3986.8091">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="4001.9419">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="4001.9419">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="1692" y1="4060.0078" y2="4060.0078"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="351" y="4070.2183">[If bulkTransferId does NOT exist]</text><polygon fill="#A80036" points="1194,4106.0781,1204,4110.0781,1194,4114.0781,1198,4110.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="4110.0781" y2="4110.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4097.4458">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="461.5" y="4089.8794">Request to persist Transfer Hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="461.5" y="4105.0122">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="535.5" y="4105.0122">2003</text><polygon fill="#A80036" points="1558,4135.2109,1568,4139.2109,1558,4143.2109,1562,4139.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="4139.2109" y2="4139.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="4134.145">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1241" y="4134.145">Persist Bulk Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1491,4182.2109,1659,4182.2109,1669,4193.2109,1659,4205.2109,1491,4205.2109,1481,4193.2109,1491,4182.2109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="1493" y="4198.2778">bulkTransferDuplicateCheck</text><polygon fill="#A80036" points="447.5,4227.4766,437.5,4231.4766,447.5,4235.4766,443.5,4231.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="4231.4766" y2="4231.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="4226.4106">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="471.5" y="4226.4106">Return success</text><path d="M376,4260.4766 L515,4260.4766 L515,4267.4766 L505,4277.4766 L376,4277.4766 L376,4260.4766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1279" x="376" y="4260.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="391" y="4273.5435">Validate Payer</text><polygon fill="#A80036" points="1304,4294.7422,1314,4298.7422,1304,4302.7422,1308,4298.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1310" y1="4298.7422" y2="4298.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4293.6763">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="461.5" y="4293.6763">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1558,4323.875,1568,4327.875,1558,4331.875,1562,4327.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1326" x2="1564" y1="4327.875" y2="4327.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1333" y="4322.8091">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1351" y="4322.8091">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1515,4340.875,1635,4340.875,1645,4359.875,1635,4378.875,1515,4378.875,1505,4359.875,1515,4340.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1517" y="4356.9419">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1517" y="4372.0747">participantCurrency</text><polygon fill="#A80036" points="1337,4401.2734,1327,4405.2734,1337,4409.2734,1333,4405.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1331" x2="1574" y1="4405.2734" y2="4405.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1343" y="4400.2075">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1361" y="4400.2075">Return Participant details if it exists</text><polygon fill="#A80036" points="447.5,4430.4063,437.5,4434.4063,447.5,4438.4063,443.5,4434.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1320" y1="4434.4063" y2="4434.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="4429.3403">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="471.5" y="4429.3403">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="4478.6719" y2="4478.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="4478.6719" y2="4491.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="4491.6719" y2="4491.6719"/><polygon fill="#A80036" points="447.5,4487.6719,437.5,4491.6719,447.5,4495.6719,443.5,4491.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4466.0396">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="461.5" y="4458.4731">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="4473.606">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="4473.606">3202</text><path d="M376,4513.6719 L517,4513.6719 L517,4520.6719 L507,4530.6719 L376,4530.6719 L376,4513.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1279" x="376" y="4513.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="391" y="4526.7388">Validate Payee</text><polygon fill="#A80036" points="1304,4547.9375,1314,4551.9375,1304,4555.9375,1308,4551.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1310" y1="4551.9375" y2="4551.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4546.8716">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="461.5" y="4546.8716">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1558,4577.0703,1568,4581.0703,1558,4585.0703,1562,4581.0703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1326" x2="1564" y1="4581.0703" y2="4581.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1333" y="4576.0044">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1351" y="4576.0044">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1515,4594.0703,1635,4594.0703,1645,4613.0703,1635,4632.0703,1515,4632.0703,1505,4613.0703,1515,4594.0703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1517" y="4610.1372">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1517" y="4625.27">participantCurrency</text><polygon fill="#A80036" points="1337,4654.4688,1327,4658.4688,1337,4662.4688,1333,4658.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1331" x2="1574" y1="4658.4688" y2="4658.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1343" y="4653.4028">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1361" y="4653.4028">Return Participant details if it exists</text><polygon fill="#A80036" points="447.5,4683.6016,437.5,4687.6016,447.5,4691.6016,443.5,4687.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1320" y1="4687.6016" y2="4687.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="4682.5356">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="471.5" y="4682.5356">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="4731.8672" y2="4731.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="4731.8672" y2="4744.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="4744.8672" y2="4744.8672"/><polygon fill="#A80036" points="447.5,4740.8672,437.5,4744.8672,447.5,4748.8672,443.5,4744.8672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4719.2349">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="461.5" y="4711.6685">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="4726.8013">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="4726.8013">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="4796.1328" y2="4796.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="4796.1328" y2="4809.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="4809.1328" y2="4809.1328"/><polygon fill="#A80036" points="447.5,4805.1328,437.5,4809.1328,447.5,4813.1328,443.5,4809.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4783.5005">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="461.5" y="4775.9341">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="4791.0669">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="4791.0669">3100</text><path d="M366,4824.1328 L429,4824.1328 L429,4831.1328 L419,4841.1328 L366,4841.1328 L366,4824.1328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="546.5938" style="stroke: #000000; stroke-width: 2.0;" width="1315" x="366" y="4824.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="381" y="4837.1997">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="444" y="4836.3433">[Validate Bulk Prepare Transfer (success)]</text><path d="M376,4848.2656 L823,4848.2656 L823,4855.2656 L813,4865.2656 L376,4865.2656 L376,4848.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="228.1953" style="stroke: #000000; stroke-width: 2.0;" width="1295" x="376" y="4848.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="402" x="391" y="4861.3325">Persist Bulk Transfer State (with bulkTransferState='RECEIVED')</text><polygon fill="#A80036" points="1194,4897.6641,1204,4901.6641,1194,4905.6641,1198,4901.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="4901.6641" y2="4901.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="4889.0317">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="461.5" y="4881.4653">Request to persist bulk transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="4896.5981">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="4896.5981">2003</text><polygon fill="#A80036" points="1558,4926.7969,1568,4930.7969,1558,4934.7969,1562,4930.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="4930.7969" y2="4930.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="4925.731">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="1241" y="4925.731">Persist bulkTransfer</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1499,4973.7969,1651,4973.7969,1661,5007.7969,1651,5041.7969,1499,5041.7969,1489,5007.7969,1499,4973.7969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1501" y="4989.8638">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1501" y="5004.9966">bulkTransferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1501" y="5020.1294">bulkTransferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1501" y="5035.2622">bulkTransferAssociation</text><polygon fill="#A80036" points="447.5,5064.4609,437.5,5068.4609,447.5,5072.4609,443.5,5068.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="5068.4609" y2="5068.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="5063.395">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="471.5" y="5063.395">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="366" x2="1681" y1="5084.4609" y2="5084.4609"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="371" y="5094.6714">[Validate Bulk Prepare Transfer (failure)]</text><path d="M376,5105.2656 L1184,5105.2656 L1184,5112.2656 L1174,5122.2656 L376,5122.2656 L376,5105.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="258.4609" style="stroke: #000000; stroke-width: 2.0;" width="1295" x="376" y="5105.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="763" x="391" y="5118.3325">Persist Bulk Transfer State (with bulkTransferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1194,5169.7969,1204,5173.7969,1194,5177.7969,1198,5173.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="5173.7969" y2="5173.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="5153.5981">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="461.5" y="5138.4653">Request to persist bulk transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="461.5" y="5153.5981">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="5168.731">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="5168.731">2003</text><polygon fill="#A80036" points="1558,5198.9297,1568,5202.9297,1558,5206.9297,1562,5202.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="5202.9297" y2="5202.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="5197.8638">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1241" y="5197.8638">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1499,5245.9297,1651,5245.9297,1661,5286.9297,1651,5328.9297,1499,5328.9297,1489,5286.9297,1499,5245.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1501" y="5261.9966">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1501" y="5277.1294">bulkTransferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1501" y="5292.2622">bulkTransferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1501" y="5307.395">bulkTransferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1501" y="5322.5278">bulkTransferAssociation</text><polygon fill="#A80036" points="447.5,5351.7266,437.5,5355.7266,447.5,5359.7266,443.5,5355.7266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="5355.7266" y2="5355.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="5350.6606">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="471.5" y="5350.6606">Return success</text><path d="M23,5391.7266 L86,5391.7266 L86,5398.7266 L76,5408.7266 L23,5408.7266 L23,5391.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1458.5" style="stroke: #000000; stroke-width: 2.0;" width="1664" x="23" y="5391.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="38" y="5404.7935">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="101" y="5403.937">[Validate Bulk Prepare Transfer (success)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="478.5" y1="5445.125" y2="5445.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478.5" x2="478.5" y1="5445.125" y2="5458.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437.5" x2="478.5" y1="5458.125" y2="5458.125"/><polygon fill="#A80036" points="447.5,5454.125,437.5,5458.125,447.5,5462.125,443.5,5458.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="5432.4927">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="461.5" y="5424.9263">Break down the bulk into individual transfers</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="5440.0591">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="5440.0591">2003</text><path d="M441,5471.125 L441,5511.125 L852,5511.125 L852,5481.125 L842,5471.125 L441,5471.125 " fill="#D3D3D3" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M842,5471.125 L842,5481.125 L852,5481.125 L842,5471.125 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="447" y="5488.1919">Add elements such as Expiry time, Payer FSP, Payee FSP, etc. to each</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="447" y="5503.3247">transfer to make their format similar to a single transfer</text><path d="M33,5527.3906 L106,5527.3906 L106,5534.3906 L96,5544.3906 L33,5544.3906 L33,5527.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="748.7813" style="stroke: #000000; stroke-width: 2.0;" width="1644" x="33" y="5527.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="48" y="5540.4575">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219" x="121" y="5539.6011">[for every individual transfer in the bulk]</text><polygon fill="#A80036" points="109,5576.7891,99,5580.7891,109,5584.7891,105,5580.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="103" x2="425.5" y1="5580.7891" y2="5580.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="115" y="5568.1567">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="133" y="5560.5903">Retrieve each individual transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="133" y="5575.7231">in the bulk using the reference</text><polygon fill="#A80036" points="414.5,5605.9219,424.5,5609.9219,414.5,5613.9219,418.5,5609.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="93" x2="420.5" y1="5609.9219" y2="5609.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="100" y="5604.856">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="118" y="5604.856">Return individual transfers as queried</text><path d="M376,5624.9219 L872,5624.9219 L872,5631.9219 L862,5641.9219 L376,5641.9219 L376,5624.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1291" x="376" y="5624.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="451" x="391" y="5637.9888">Insert Bulk Transfer Association (with bulkProcessingState='RECEIVED')</text><polygon fill="#A80036" points="1194,5674.3203,1204,5678.3203,1194,5682.3203,1198,5678.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1200" y1="5678.3203" y2="5678.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="5665.688">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="461.5" y="5658.1216">Request to persist bulk transfer association</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="5673.2544">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="5673.2544">2003</text><polygon fill="#A80036" points="1558,5703.4531,1568,5707.4531,1558,5711.4531,1562,5707.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1216" x2="1564" y1="5707.4531" y2="5707.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1223" y="5702.3872">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="1241" y="5702.3872">Insert bulkTransferAssociation</text><polygon fill="#FFFFE0" filter="url(#fx67m4y7jlmw5)" points="1502,5750.4531,1647,5750.4531,1657,5761.4531,1647,5773.4531,1502,5773.4531,1492,5761.4531,1502,5750.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1504" y="5766.52">bulkTransferAssociation</text><polygon fill="#A80036" points="447.5,5795.7188,437.5,5799.7188,447.5,5803.7188,443.5,5799.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="1210" y1="5799.7188" y2="5799.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="5794.6528">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="471.5" y="5794.6528">Return success</text><path d="M441,5819.7188 L441,6192.7188 L678,6192.7188 L678,5829.7188 L668,5819.7188 L441,5819.7188 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M668,5819.7188 L668,5829.7188 L678,5829.7188 L668,5819.7188 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="5836.7856">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="5851.9185">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="459" y="5867.0513">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="459" y="5882.1841">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="459" y="5897.3169">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="5912.4497">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="5927.5825">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="471" y="5942.7153">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="471" y="5957.8481">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="5972.981">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="5988.1138">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="6003.2466">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="6018.3794">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="6033.5122">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="483" y="6048.645">type: bulk-prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="483" y="6063.7778">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="6078.9106">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="6094.0435">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="495" y="6109.1763">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="495" y="6124.3091">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="6139.4419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="6154.5747">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="6169.7075">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="6184.8403">}</text><polygon fill="#A80036" points="866.5,6234.1719,876.5,6238.1719,866.5,6242.1719,870.5,6238.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="872.5" y1="6238.1719" y2="6238.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="6225.5396">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="461.5" y="6217.9731">Route &amp; Publish Prepare event to the Payer for the Individual Transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="6233.106">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="6233.106">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1687" y1="6284.1719" y2="6284.1719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="28" y="6294.3823">[Validate Bulk Prepare Transfer (failure)]</text><path d="M441,6302.9766 L441,6765.9766 L968,6765.9766 L968,6312.9766 L958,6302.9766 L441,6302.9766 " fill="#FFFF00" filter="url(#fx67m4y7jlmw5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M958,6302.9766 L958,6312.9766 L968,6312.9766 L958,6302.9766 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="447" y="6320.0435">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="6335.1763">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="459" y="6350.3091">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="459" y="6365.4419">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="459" y="6380.5747">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="459" y="6395.7075">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="459" y="6410.8403">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="471" y="6425.9731">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="471" y="6441.106">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="483" y="6456.2388">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="495" y="6471.3716">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="495" y="6486.5044">"errorDescription": "&lt;refer to section 7.6 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="495" y="6501.6372">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="6516.77">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="459" y="6531.9028">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="459" y="6547.0356">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="471" y="6562.1685">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="483" y="6577.3013">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="483" y="6592.4341">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="483" y="6607.5669">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="483" y="6622.6997">action: bulk-abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="483" y="6637.8325">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="483" y="6652.9653">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="495" y="6668.0981">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="495" y="6683.231">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="495" y="6698.3638">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="483" y="6713.4966">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="471" y="6728.6294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="459" y="6743.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="447" y="6758.895">}</text><polygon fill="#A80036" points="1091,6808.2266,1101,6812.2266,1091,6816.2266,1095,6812.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436.5" x2="1097" y1="6812.2266" y2="6812.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="443.5" y="6799.5942">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="461.5" y="6792.0278">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="461.5" y="6807.1606">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="541.5" y="6807.1606">2003</text><!--
@startuml
title 1.1.1. Bulk Prepare Handler Consume

autonumber


collections "topic-\nbulk-prepare" as TOPIC_BULK_PREPARE
collections "mongo-\nobject-store" as OBJECT_STORE
control "Bulk Prepare \nHandler" as BULK_PREP_HANDLER
collections "topic-\ntransfer-prepare" as TOPIC_TRANSFER_PREPARE
collections "topic-event" as TOPIC_EVENTS
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant OBJECT_STORE
    participant TOPIC_BULK_PREPARE
    participant BULK_PREP_HANDLER
    participant TOPIC_TRANSFER_PREPARE
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate BULK_PREP_HANDLER
group Bulk Prepare Handler Consume
    TOPIC_BULK_PREPARE <- BULK_PREP_HANDLER: Consume Bulk Prepare message
    activate TOPIC_BULK_PREPARE
    deactivate TOPIC_BULK_PREPARE

    break
        group Validate Event
            BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: Validate event - Rule: type == 'bulk-prepare' && action == 'bulk-prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        BULK_PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over BULK_PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
        |||
    end

    group Validate Bulk Prepare Transfer 
        BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: <color #gray>Schema validation of the incoming message</color>
        BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: <color #gray>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of BULK_PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        
        Group Individual transfers in the bulk
            BULK_PREP_HANDLER -> OBJECT_STORE: Retrieve all individual transfer IDs\nin the bulk using its reference
            activate OBJECT_STORE
            OBJECT_STORE - -> BULK_PREP_HANDLER: Return individual transfers as queried
            deactivate OBJECT_STORE
        end
        BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: Validate that there are no duplicate individualTransfers \n(transfer IDs) from the same bulk. \nOn failure, send bulk error message to Payer. \nNo further processing on individual transfers is done
        

        group Validate Duplicate check
            note right of BULK_PREP_HANDLER #Cyan
                The Specification doesn't touch on the duplicate handling
                of bulk transfers, so the current design mostly follows the
                strategy used for individual transfers, except in two places.
                For duplicate requests where hash matches, the current design
                includes only the status of the bulk & timestamp (if completed),
                but not the individual transfers (for which a GET should be used).

                For duplicate requests where hash matches but are not in a
                finalized state, only the state of the bulkTransfer is sent.
            end note
            BULK_PREP_HANDLER -> POS_DAO: Request to retrieve Hash for a bulkTransferId
            activate POS_DAO
            POS_DAO -> DB: Request Transfer Hash for a bulkTransferId
            activate DB
            hnote over DB #lightyellow
                bulkTransferDuplicateCheck
            end note
            POS_DAO <- - DB: Return hash if it exists
            deactivate DB
            BULK_PREP_HANDLER <- - POS_DAO: Return hash if it exists
            deactivate POS_DAO

            alt If bulkTransferId exists
                group Persist Event Information
                    |||
                    BULK_PREP_HANDLER -> TOPIC_EVENTS: Publish event information
                    ref over BULK_PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
                    |||
                end
                BULK_PREP_HANDLER -> BULK_PREP_HANDLER: Generate Hash for the incoming message \nand compare hashes

                alt BulkTransfer exists, hash matches    
                    BULK_PREP_HANDLER -> POS_DAO: Request to retrieve Bulk Transfer state \n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Request BulkTransfer state
                    hnote over DB #lightyellow
                        bulkTransfer
                        bulkTransferStateChange
                    end note
                    activate DB
                    POS_DAO <- - DB: Return Transfer state
                    deactivate DB
                    POS_DAO - -> BULK_PREP_HANDLER: Return Transfer state
                    deactivate POS_DAO
                    break
                        alt If bulkTransferState IN ['COMPLETED', 'REJECTED']
                            BULK_PREP_HANDLER -> POS_DAO: Request to retrieve completedTimestamp
                            activate POS_DAO
                            POS_DAO -> DB: Return completedTimestamp
                            activate DB
                            hnote over DB #lightyellow
                                bulkTransfer
                                bulkTransferFulfilment
                            end note
                            POS_DAO <- - DB: Return completedTimestamp
                            deactivate DB
                            BULK_PREP_HANDLER <- - POS_DAO: Return completedTimestamp
                            deactivate POS_DAO
                            note right of BULK_PREP_HANDLER #yellow
                                Message:
                                {
                                    id: <bulkTransferMessage.bulkTransferId>
                                    from: <bulkTransferMessage.payerFsp>,
                                    to: <bulkTransferMessage.payeeFsp>,
                                    type: application/json
                                    content: {
                                        headers: <bulkTransferHeaders>,
                                        payload: {
                                            bulkTransferState: "COMPLETED",
                                            completedTimestamp: "2019-10-24T08:38:08.699-04:00"
                                        }
                                    },
                                    metadata: {
                                        event: {
                                            id: <uuid>,
                                            responseTo: <previous.uuid>,
                                            type: bulk-notification,
                                            action: bulk-prepare-duplicate,
                                            createdAt: <timestamp>,
                                            state: {
                                                status: "success",
                                                code: 0
                                            }
                                        }
                                    }
                                }
                            end note
                            BULK_PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event for Payer with the completed bulk transfer
                            activate TOPIC_NOTIFICATIONS
                            deactivate TOPIC_NOTIFICATIONS
                        else If bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE', 'ACCEPTED', 'PROCESSING', 'PENDING_FULFIL']
                            note right of BULK_PREP_HANDLER #yellow
                                Message:
                                {
                                    id: <bulkTransferMessage.bulkTransferId>
                                    from: <bulkTransferMessage.payerFsp>,
                                    to: <bulkTransferMessage.payeeFsp>,
                                    type: application/json
                                    content: {
                                        headers: <bulkTransferHeaders>,
                                        payload: {
                                            bulkTransferState: "?TODO?"
                                        }
                                    },
                                    metadata: {
                                        event: {
                                            id: <uuid>,
                                            responseTo: <previous.uuid>,
                                            type: bulk-notification,
                                            action: bulk-prepare-duplicate,
                                            createdAt: <timestamp>,
                                            state: {
                                                status: "success",
                                                code: 0
                                            }
                                        }
                                    }
                                }
                            end note
                            BULK_PREP_HANDLER <-> TOPIC_NOTIFICATIONS: Publish Notification event for Payer with the completed bulk transfer
                            activate TOPIC_NOTIFICATIONS
                            deactivate TOPIC_NOTIFICATIONS
                        else If bulkTransferState does not exist
                            note right of BULK_PREP_HANDLER #yellow
                                Message:
                                {
                                    id: <bulkTransferMessage.bulkTransferId>
                                    from: <ledgerName>,
                                    to: <bulkTransferMessage.payerFsp>,
                                    type: application/json
                                    content: {
                                        headers: <bulkTransferHeaders>,
                                        payload: {
                                            "errorInformation": {
                                                "errorCode": "3100",
                                                "errorDescription": "<error description>",
                                                "extensionList": <transferMessage.extensionList>
                                        }
                                    },
                                    metadata: {
                                        event: {
                                            id: <uuid>,
                                            responseTo: <previous.uuid>,
                                            type: bulk-notification,
                                            action: bulk-prepare-duplicate,
                                            createdAt: <timestamp>,
                                            state: {
                                                status: 'error',
                                                code: <errorInformation.errorCode>
                                                description: <errorInformation.errorDescription>
                                            }
                                        }
                                    }
                                }
                            end note
                            BULK_PREP_HANDLER -> TOPIC_NOTIFICATIONS: Send /error callback with appropriate error message\n(Invalid duplicate request)\n<color #FF0000><b>Error code:</b> 3100</color>
                            activate TOPIC_NOTIFICATIONS
                            deactivate TOPIC_NOTIFICATIONS
                        end
                    end
                else BulkTransfer exists, hash does not match
                    break
                        note right of BULK_PREP_HANDLER #yellow
                                Message:
                                {
                                    id: <bulkTransferMessage.bulkTransferId>
                                    from: <ledgerName>,
                                    to: <bulkTransferMessage.payerFsp>,
                                    type: application/json
                                    content: {
                                        headers: <bulkTransferHeaders>,
                                        payload: {
                                            "errorInformation": {
                                                "errorCode": "3106"
                                                "errorDescription": "<error description>",
                                                "extensionList": <transferMessage.extensionList>
                                        }
                                    },
                                    metadata: {
                                        event: {
                                            id: <uuid>,
                                            responseTo: <previous.uuid>,
                                            type: bulk-notification,
                                            action: bulk-prepare-duplicate,
                                            createdAt: <timestamp>,
                                            state: {
                                                status: 'error',
                                                code: <errorInformation.errorCode>
                                                description: <errorInformation.errorDescription>
                                            }
                                        }
                                    }
                                }
                            end note
                        BULK_PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 3106</color>
                        activate TOPIC_NOTIFICATIONS
                        deactivate TOPIC_NOTIFICATIONS
                    end
                end

            else If bulkTransferId does NOT exist
                BULK_PREP_HANDLER -> POS_DAO: Request to persist Transfer Hash \n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist Bulk Transfer message hash
                hnote over DB #lightyellow
                    bulkTransferDuplicateCheck
                end note
                activate DB
                deactivate DB
                POS_DAO - -> BULK_PREP_HANDLER: Return success
                deactivate POS_DAO
            end
            deactivate POS_DAO
            
        end

        group Validate Payer
            BULK_PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> BULK_PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            BULK_PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> BULK_PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        BULK_PREP_HANDLER <-> BULK_PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Bulk Prepare Transfer (success)
            group Persist Bulk Transfer State (with bulkTransferState='RECEIVED')
                BULK_PREP_HANDLER -> POS_DAO: Request to persist bulk transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist bulkTransfer
                hnote over DB #lightyellow
                    bulkTransfer
                    bulkTransferStateChange
                    bulkTransferExtension
                    bulkTransferAssociation
                end note
                activate DB
                deactivate DB
                POS_DAO - -> BULK_PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        else Validate Bulk Prepare Transfer (failure)
            group Persist Bulk Transfer State (with bulkTransferState='INVALID') (Introducing a new status INVALID to mark these entries)
                BULK_PREP_HANDLER -> POS_DAO: Request to persist bulk transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    bulkTransfer
                    bulkTransferStateChange
                    bulkTransferExtension
                    bulkTransferError
                    bulkTransferAssociation
                end note
                activate DB
                deactivate DB
                POS_DAO - -> BULK_PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        end

    end
    alt Validate Bulk Prepare Transfer (success)
        BULK_PREP_HANDLER -> BULK_PREP_HANDLER: Break down the bulk into individual transfers\n<color #FF0000><b>Error codes:</b> 2003</color>
        note right of BULK_PREP_HANDLER #lightgrey
            Add elements such as Expiry time, Payer FSP, Payee FSP, etc. to each
            transfer to make their format similar to a single transfer
        end note
        loop for every individual transfer in the bulk
            BULK_PREP_HANDLER -> OBJECT_STORE: Retrieve each individual transfer\nin the bulk using the reference
            activate OBJECT_STORE
            OBJECT_STORE - -> BULK_PREP_HANDLER: Return individual transfers as queried
            deactivate OBJECT_STORE
            group Insert Bulk Transfer Association (with bulkProcessingState='RECEIVED')
                BULK_PREP_HANDLER -> POS_DAO: Request to persist bulk transfer association\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Insert bulkTransferAssociation
                hnote over DB #lightyellow
                    bulkTransferAssociation
                end note
                activate DB
                deactivate DB
                POS_DAO - -> BULK_PREP_HANDLER: Return success
                deactivate POS_DAO
            end

            note right of BULK_PREP_HANDLER #yellow
                Message:
                {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: bulk-prepare,
                            action: prepare,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0
                            }
                        }
                    }
                }
            end note
            BULK_PREP_HANDLER -> TOPIC_TRANSFER_PREPARE: Route & Publish Prepare event to the Payer for the Individual Transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TOPIC_TRANSFER_PREPARE
            deactivate TOPIC_TRANSFER_PREPARE
        end
    else Validate Bulk Prepare Transfer (failure)
        note right of BULK_PREP_HANDLER #yellow
            Message:
            {
                id: <bulkTransferMessage.bulkTransferId>
                from: <ledgerName>,
                to: <bulkTransferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <bulkTransferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 7.6 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-notification,
                        action: bulk-abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        BULK_PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate BULK_PREP_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="254px" preserveAspectRatio="none" style="width:512px;height:254px;background:#000000;" version="1.1" viewBox="0 0 512 254" width="512px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="211.1348" style="stroke: #FFFFFF; stroke-width: 1.0;" width="511" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="5" y="16.1387">Welcome to PlantUML!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="30.1074"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="251" x="5" y="44.0762">If you use this software, you accept its license.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="91" x="5" y="59.9023">(details by typing</text><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="39" x="99" y="59.4805">license</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="49" x="141" y="59.9023">keyword)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="73.8711"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="250" x="5" y="87.8398">You can start with a simple UML Diagram like:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="101.8086"/><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="5" y="117.2129">Bob-&gt;Alice:Hello</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="131.6035"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="13" x="5" y="145.5723">Or</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="159.541"/><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="79" x="5" y="174.9453">classExample</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="189.3359"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="309" x="5" y="203.3047">You will find more information about PlantUML syntax on</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="109" x="317" y="203.3047">http://plantuml.com</text><line style="stroke: #000000; stroke-width: 1.0;" x1="317" x2="426" y1="205.3047" y2="205.3047"/><image height="71" width="80" x="425" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABHCAMAAACnHDC8AAADAFBMVEX///+BpbvD3u/f7vfPz8+nz+g3ksuZEDkWADr/ujlvsdpTodLCwsOLwOEbg8T//v6pqamZETnLysvT09To5+jqLS4VATj9/f27u7vDw8MTfsK+v7/j4+SOweJprdjL4/KxsbEri8jk8PgXa57c29uUETez1utQoNJ1tNtEmc9cptWBut6ayOW/3O6YEDjY6vUfhcXBwcHs7Ozw9/v83t79uTn7+/vX19ehoaHx8fG2tLXHx8fuVlfrNTYaBjn/vUH5+fmko6WXl5f/+fn95ub+9PT+8PD3qKidmaMxIUrnqDWcFj7n5eX09PTu7u2SkpKfnZ6rq6z0lJTm4tzJrHUfDT339/eFGDn6tjcrEzOvrbBuZ3l4eomSMS7Hz9Smpqasu8SFiYuQETfa2du1m6OOM051J0NWTWL5xse4uLj6zc33r6/4vb7ydHXqLi/72dntTE3tR0ijbn5jW3C+u8NANVQrG0XFubqRVGZza4GQGT2VaS7a0NPJtI6IJj/zszrfqkXXzr/Hw8cgC0LUqltOQ2JsSC5bTGjOpFafSi2+iDGtyt14m7TJhTCPJUSwoIG/qa+ikHiIgpCRHjI9j8KXbnaQH0FLf6FGPlp0cnYyKE2rg49Wj7dFXHmcwtrp6uu+xMjvYWLvW1z97e3sPD3sP0DuUlP709PYzdDPmzqZWWySRVygfHHd1smWkZ+PgnibETqsl260q5fLuppJLC/dpj2HPFLTtHv/ujrTwJy5s6iWjIi0iD3joTTCmU3trjuvZS2zlFvjq0HSyLbYp0qRts10XGxEKC9yPVBQZIOPdlNvMk2NeYNqRlujtcCVrr3j5eY1gK9Qn9GLp7lbeJXRxrCkiZDaozyukoJ+H0B3rc+OYy+iprJkYXdhmr6ee0afs79xq9BikrGKjI3FomEiLFO0ay6nfIm4pZXRjTFuhZSZWm0zcZyJN0KNTk4eebNfdIGGlZ93h5kcED5nOVYyRWbziIk9dJ4kerE5ZYxRUnLG1d7p8PTvY2PtTk/1nZ1ycV/bAAAFfElEQVR42mNgoB7IABFMVDTwlTOVDVyiDiSYqWjgwc93GagJshdRNwzzL8WCKEZqmeemfZp9L5BmoZb7mIwPH2Fg4DelkgtzLpocPsPgxsPwmToudGcyvnzGjSfk0AzqeNn9XPzfCcv/nZi/mzr+dRctcGNYbmsDyijUcCF/nPqvXfy/GTj2UCuCRW0YGExEbfkZqJSwr2kYgqgbqtQycLcBsEAQ7GfIBTuRGoWDwOK3p+59fb4r8jSVDLx7dOnR+2+03v55RLWCwSQbmFlEF1LLywwMz/53rud1enyaioWhM0OGO1VLVwZ+F2qapmIEZ1KjcPBj5gOG4ksIh/JIMWPlPv7ypqQZ11PqGGiox/TtDcefF/fFf6s9p4KBHzku/foNNPAX81t+ga98Xyk2sHNRoNdqsIGMnG87HrC/o9RAxmntyl+5P4AN/HPV+M99SispRt4frP8f/DT9wsYo+F3+/+k/FLuQHWjEZDU2zVvy6s+uPmH6RxUXMv/4G/f+yFtQsv5Daaph5GPj5uJlZWKWhOYTJgYqg1EDB5GBn+nlwpoJ6CrWHkYXKSnBYyBq1hPJYF6Q5nAISSRY236fqOZ1JBHhrNNPbZ5/Q856TH/+M7L+ArsPJeuFuX6uBFL9gWmboSKWLq6guqz87+EDMCtT74AkHVMTP6JkPUbOL+Cc8gdhIH8o4yIoM067AFy41wq6QkXqf9aDrbR5MgkqUvu3DquBcC+XZyzfB2NfvHVz/TuGq8wzemH1RuhjUaVb/I7eRSdhag79jPr2HLeXVzBVIxomLo9vMvT/9y/ZCDPuFNhGQfYC1PB3/L8Dhwt9fN6WfkQovGeodG/nzhfGMBdDqrPfZ0UlbqAY+OBB44UfWFzo6weOCxDgAkWe+k2II+VSTHygroM5yWbHKYbqViQRX4/aN2iRIu4LjwuomVyyQBNXhgPZPbozNqL6slErBL0txy6PamD68ZvIpkERPCUZ1KDq13G7tx5VhO/+8kLkMPxw8dlFuORvGGJYuQYscPV2EaPYU+RO9nHJ2O8JyJnnZ9dCWd9NiDBU/n6PKWMpqqVAbyMc2RPsfwXN37aOaP6eFCEI97Lyd7GP1/4KoxiHqlpdv0cBVcS/uQ7d300710O9LPSH+2eVeE3hdGR/o4C3e5a9eIUiwurEsQNVDTvLw6cQL4MN/HxnnYyZ9GUczd280HeTZqJ0TI6t/PPwJ7JI/OddkIBm+gdrH/Z92ZZpg8W48qjETQwMekgim/9HHWc45bkfIZL79OZ5LA3OkE3XqjagGRcQulwDRBvDRRawJTwB0XZwA/MuHTmOpAWpBRv4Kb8sArmrEW28KAS1GHZ0rb4DYV2FZRXbrieoBWzbIWAYCv1n+sXK9PNGp7spIlEWipbCUqDqB1Cs+DdO3fAOVsyCjeHz2b3uE0oF8I/5yO6gFTADOd5+c639CCkB1t+5uwSuTqxgFQPDjtfVHxDdCFCsAOPiO1qNAioc5r/lmPqP+QsX8yf+m4rsn/a+iX3EUP7s5WZkhS2tW//MWYUs4rk/9+mdU+hxCC2x41o+RMANFPi8alaB3RtoHXDbEmxwv3LDOWiT/5gT2ODiqx+hcWH0SOcAwkBweXjxaEzkArCXBVl+cvzac74DmlkMpd7/ZgEF0vue5xARBQnOC06g4uTvQWhkCCjaifI8QPYypPLZz+cFc6HgC1hkCGg8NH59EiUhffx18wNKIzDgABMj4xu4C2EJ4o1u7TVi6vEXDAwc/BhdATlsFf0ie+eZ6Cp5biielUcR0T7/XxS1lXqYQcP8HFILFFnuwr+9i1C8TDJArpchNTLTfgoNRGvbLPrWeIbazSeZBX+kydbMgnX8UFjvMLkG+q4HABVtKp9tQ9JtAAAAAElFTkSuQmCC" y="6"/><rect fill="#000000" height="42.5938" style="stroke: #000000; stroke-width: 1.0;" width="511" x="0" y="211.1348"/><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="5" y="229.1299">@startuml</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="9" y="245.4268"/><text fill="#FF0000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="9" y="245.4268">Empty description</text><!--
@startuml


@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>