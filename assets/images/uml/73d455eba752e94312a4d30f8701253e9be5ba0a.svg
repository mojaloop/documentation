<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="7198px" preserveAspectRatio="none" style="width:1793px;height:7198px;" version="1.1" viewBox="0 0 1793 7198" width="1793px" zoomAndPan="magnify"><defs><filter height="300%" id="fau1crc8bnqni" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="615" x="590" y="22.9951">1.2.1. Prepare Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="7153.3359" style="stroke: #A80036; stroke-width: 1.0;" width="1667.5" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="803.75" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="6986.6094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="722.25"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="1217.5078"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="1454.7031"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="3524.1406"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="181.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="4400.2578"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="197.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="4687.5234"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="3797.3359"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="4050.5313"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="751.3828"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="1246.6406"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="1483.8359"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="3553.2734"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="3826.4688"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4079.6641"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4429.3906"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4716.6563"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="4911.0625" style="stroke: #000000; stroke-width: 2.0;" width="1769" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="569.5" x="245" y="215.9922"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="549.5" x="255" y="240.125"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="255" y="335.5234"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="4400.3984" style="stroke: #000000; stroke-width: 2.0;" width="1577" x="195" y="506.1875"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="2976.5547" style="stroke: #000000; stroke-width: 2.0;" width="1557" x="205" y="683.9844"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="2795.7578" style="stroke: #000000; stroke-width: 2.0;" width="1537" x="215" y="857.7813"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="255" y="881.9141"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="2301.9609" style="stroke: #000000; stroke-width: 2.0;" width="1517" x="225" y="1164.1094"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="1972.5625" style="stroke: #000000; stroke-width: 2.0;" width="1497" x="235" y="1368.1719"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="1941.4297" style="stroke: #000000; stroke-width: 2.0;" width="1477" x="245" y="1392.3047"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="805.0547" style="stroke: #000000; stroke-width: 2.0;" width="1457" x="255" y="1416.4375"/><rect fill="#FFFFFF" height="56.9375" style="stroke: none; stroke-width: 1.0;" width="1457" x="255" y="2090.3516"/><rect fill="#FFFFFF" height="74.2031" style="stroke: none; stroke-width: 1.0;" width="1457" x="255" y="2147.2891"/><rect fill="#FFFFFF" height="1105.2422" style="stroke: none; stroke-width: 1.0;" width="1477" x="245" y="2228.4922"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="948.5" x="255" y="2250.2969"/><rect fill="#FFFFFF" height="537.0547" style="stroke: none; stroke-width: 1.0;" width="948.5" x="255" y="2789.6797"/><rect fill="#FFFFFF" height="118.3359" style="stroke: none; stroke-width: 1.0;" width="1517" x="225" y="3347.7344"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="89.5313" style="stroke: #000000; stroke-width: 2.0;" width="422.5" x="255" y="3369.5391"/><rect fill="#FFFFFF" height="180.4688" style="stroke: none; stroke-width: 1.0;" width="1537" x="215" y="3473.0703"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1463" x="255" y="3759.0703"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1463" x="255" y="4012.2656"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="576.8594" style="stroke: #000000; stroke-width: 2.0;" width="1485" x="245" y="4322.7266"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1465" x="255" y="4346.8594"/><rect fill="#FFFFFF" height="302.3984" style="stroke: none; stroke-width: 1.0;" width="1485" x="245" y="4597.1875"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="273.5938" style="stroke: #000000; stroke-width: 2.0;" width="1465" x="255" y="4618.9922"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="116.2031" style="stroke: #000000; stroke-width: 2.0;" width="425.5" x="255" y="4920.5859"/><rect fill="#FFFFFF" height="56.9375" style="stroke: none; stroke-width: 1.0;" width="425.5" x="255" y="4979.8516"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="925.9766" style="stroke: #000000; stroke-width: 2.0;" width="662.5" x="245" y="5057.7891"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="894.8438" style="stroke: #000000; stroke-width: 2.0;" width="642.5" x="255" y="5081.9219"/><rect fill="#FFFFFF" height="446.2578" style="stroke: none; stroke-width: 1.0;" width="642.5" x="255" y="5530.5078"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="1107.5703" style="stroke: #000000; stroke-width: 2.0;" width="968.5" x="245" y="5997.7656"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="948.5" x="255" y="6021.8984"/><rect fill="#FFFFFF" height="537.0547" style="stroke: none; stroke-width: 1.0;" width="948.5" x="255" y="6561.2813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="85" x2="85" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="319" x2="319" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="823.5" x2="823.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="926.5" x2="926.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1013.5" x2="1013.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1131.5" x2="1131.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1249.5" x2="1249.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1359.5" x2="1359.5" y1="115.7266" y2="7122.3359"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1638.5" x2="1638.5" y1="115.7266" y2="7122.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="27" y="60.1328"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="23" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="63" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="30" y="100.4248">transfer-prepare</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="27" y="7121.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="23" y="7125.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="63" y="7145.3311">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="30" y="7161.6279">transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="265" y="112.4248">Prepare Handler</text><ellipse cx="319.5" cy="83.4297" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="315.5,71.4297,321.5,66.4297,319.5,71.4297,321.5,76.4297,315.5,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="265" y="7134.3311">Prepare Handler</text><ellipse cx="319.5" cy="7153.6328" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="315.5,7141.6328,321.5,7136.6328,319.5,7141.6328,321.5,7146.6328,315.5,7141.6328" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="763.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="759.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="801" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="766.5" y="100.4248">transfer-position</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="763.5" y="7121.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="759.5" y="7125.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="801" y="7145.3311">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="766.5" y="7161.6279">transfer-position</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="901.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="897.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="904.5" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="905" y="100.4248">event</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="901.5" y="7121.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="897.5" y="7125.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="904.5" y="7145.3311">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="905" y="7161.6279">event</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="970.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="966.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="991" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="973.5" y="100.4248">notification</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="970.5" y="7121.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="966.5" y="7125.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="991" y="7145.3311">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="973.5" y="7161.6279">notification</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="1074.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="1070.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="1109.5" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="1077.5" y="100.4248">bulk-processing</text><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="1074.5" y="7121.3359"/><rect fill="#FEFECE" filter="url(#fau1crc8bnqni)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="1070.5" y="7125.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="1109.5" y="7145.3311">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="1077.5" y="7161.6279">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1203.5" y="112.4248">Position DAO</text><ellipse cx="1249.5" cy="83.4297" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1237.5" x2="1261.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1203.5" y="7134.3311">Position DAO</text><ellipse cx="1249.5" cy="7153.6328" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1237.5" x2="1261.5" y1="7167.6328" y2="7167.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1305.5" y="112.4248">Participant DAO</text><ellipse cx="1359.5" cy="83.4297" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1347.5" x2="1371.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1305.5" y="7134.3311">Participant DAO</text><ellipse cx="1359.5" cy="7153.6328" fill="#FEFECE" filter="url(#fau1crc8bnqni)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1347.5" x2="1371.5" y1="7167.6328" y2="7167.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1594.5" y="112.4248">Central Store</text><path d="M1620.5,63.4297 C1620.5,53.4297 1638.5,53.4297 1638.5,53.4297 C1638.5,53.4297 1656.5,53.4297 1656.5,63.4297 L1656.5,89.4297 C1656.5,99.4297 1638.5,99.4297 1638.5,99.4297 C1638.5,99.4297 1620.5,99.4297 1620.5,89.4297 L1620.5,63.4297 " fill="#FEFECE" filter="url(#fau1crc8bnqni)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1620.5,63.4297 C1620.5,73.4297 1638.5,73.4297 1638.5,73.4297 C1638.5,73.4297 1656.5,73.4297 1656.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1594.5" y="7134.3311">Central Store</text><path d="M1620.5,7147.6328 C1620.5,7137.6328 1638.5,7137.6328 1638.5,7137.6328 C1638.5,7137.6328 1656.5,7137.6328 1656.5,7147.6328 L1656.5,7173.6328 C1656.5,7183.6328 1638.5,7183.6328 1638.5,7183.6328 C1638.5,7183.6328 1620.5,7183.6328 1620.5,7173.6328 L1620.5,7147.6328 " fill="#FEFECE" filter="url(#fau1crc8bnqni)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1620.5,7147.6328 C1620.5,7157.6328 1638.5,7157.6328 1638.5,7157.6328 C1638.5,7157.6328 1656.5,7157.6328 1656.5,7147.6328 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="6986.6094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="722.25"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="1217.5078"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="1454.7031"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="3524.1406"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="181.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="4400.2578"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="197.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="4687.5234"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="3797.3359"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="4050.5313"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="751.3828"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="1246.6406"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="1483.8359"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="3553.2734"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="3826.4688"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4079.6641"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4429.3906"/><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1633.5" y="4716.6563"/><path d="M13,132.7266 L225,132.7266 L225,139.7266 L215,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4911.0625" style="stroke: #000000; stroke-width: 2.0;" width="1769" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="28" y="145.7935">Prepare Handler Consume</text><polygon fill="#A80036" points="101.5,166.9922,91.5,170.9922,101.5,174.9922,97.5,170.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="95.5" x2="313.5" y1="170.9922" y2="170.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="107.5" y="165.9263">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="118.5" y="165.9263">Consume Prepare event message</text><path d="M245,215.9922 L328,215.9922 L328,222.9922 L318,232.9922 L245,232.9922 L245,215.9922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="569.5" x="245" y="215.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="260" y="229.0591">break</text><path d="M255,240.125 L393,240.125 L393,247.125 L383,257.125 L255,257.125 L255,240.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="549.5" x="255" y="240.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="270" y="253.1919">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="293.5234" y2="293.5234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="293.5234" y2="306.5234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="306.5234" y2="306.5234"/><polygon fill="#A80036" points="335.5,302.5234,325.5,306.5234,335.5,310.5234,331.5,306.5234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="331.5" y="280.8911">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="342.5" y="273.3247">Validate event - Rule: type IN ['prepare', 'bulk-prepare'] &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="342.5" y="288.4575">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="422.5" y="288.4575">2001</text><path d="M255,335.5234 L465,335.5234 L465,342.5234 L455,352.5234 L255,352.5234 L255,335.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="255" y="335.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="270" y="348.5903">Persist Event Information</text><polygon fill="#A80036" points="915,394.7891,925,398.7891,915,402.7891,919,398.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="921" y1="398.7891" y2="398.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="331.5" y="393.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="342.5" y="393.7231">Publish event information</text><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="693.5" x="262" y="406.7891"/><polygon fill="#EEEEEE" points="262,406.7891,326,406.7891,326,413.7891,316,423.7891,262,423.7891,262,406.7891" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="275" y="420.856">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="540.25" y="439.856">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="543.25" y="454.9888"/><path d="M195,506.1875 L405,506.1875 L405,513.1875 L395,523.1875 L195,523.1875 L195,506.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4400.3984" style="stroke: #000000; stroke-width: 2.0;" width="1577" x="195" y="506.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="210" y="519.2544">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="544.4531" y2="544.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="544.4531" y2="557.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="557.4531" y2="557.4531"/><polygon fill="#A80036" points="335.5,553.4531,325.5,557.4531,335.5,561.4531,331.5,557.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="331.5" y="539.3872">4</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="342.5" y="539.3872">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="586.5859" y2="586.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="586.5859" y2="599.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="599.5859" y2="599.5859"/><polygon fill="#A80036" points="335.5,595.5859,325.5,599.5859,335.5,603.5859,331.5,599.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="331.5" y="581.52">5</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="342.5" y="581.52">Verify the message's signature (to be confirmed in future requirement)</text><path d="M329,612.5859 L329,667.5859 L670,667.5859 L670,622.5859 L660,612.5859 L329,612.5859 " fill="#D3D3D3" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M660,612.5859 L660,622.5859 L670,622.5859 L660,612.5859 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="335" y="629.6528">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="335" y="644.7856">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="335" y="659.9185">It may need to be added in future for custom adapters.</text><path d="M205,683.9844 L410,683.9844 L410,690.9844 L400,700.9844 L205,700.9844 L205,683.9844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2976.5547" style="stroke: #000000; stroke-width: 2.0;" width="1557" x="205" y="683.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="220" y="697.0513">Validate Duplicate check</text><polygon fill="#A80036" points="1232.5,718.25,1242.5,722.25,1232.5,726.25,1236.5,722.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="722.25" y2="722.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="331.5" y="717.1841">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="342.5" y="717.1841">Request to retrieve Transfer Hash for a transferId</text><polygon fill="#A80036" points="1621.5,747.3828,1631.5,751.3828,1621.5,755.3828,1625.5,751.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="751.3828" y2="751.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1261.5" y="746.3169">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="1272.5" y="746.3169">Request Transfer Hash for a transferId</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1568,764.3828,1708,764.3828,1718,775.3828,1708,787.3828,1568,787.3828,1558,775.3828,1568,764.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1570" y="780.4497">transferDuplicateCheck</text><polygon fill="#A80036" points="1265.5,809.6484,1255.5,813.6484,1265.5,817.6484,1261.5,813.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1259.5" x2="1637.5" y1="813.6484" y2="813.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1271.5" y="808.5825">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1282.5" y="808.5825">Return hash if it exists</text><polygon fill="#A80036" points="335.5,838.7813,325.5,842.7813,335.5,846.7813,331.5,842.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="842.7813" y2="842.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="341.5" y="837.7153">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="352.5" y="837.7153">Return hash if it exists</text><path d="M215,857.7813 L278,857.7813 L278,864.7813 L268,874.7813 L215,874.7813 L215,857.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2795.7578" style="stroke: #000000; stroke-width: 2.0;" width="1537" x="215" y="857.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="230" y="870.8481">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="293" y="869.9917">[If transferId exists]</text><path d="M255,881.9141 L465,881.9141 L465,888.9141 L455,898.9141 L255,898.9141 L255,881.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="255" y="881.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="270" y="894.981">Persist Event Information</text><polygon fill="#A80036" points="915,941.1797,925,945.1797,915,949.1797,919,945.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="921" y1="945.1797" y2="945.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="940.1138">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="349.5" y="940.1138">Publish event information</text><rect fill="#FFFFFF" filter="url(#fau1crc8bnqni)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="693.5" x="262" y="953.1797"/><polygon fill="#EEEEEE" points="262,953.1797,326,953.1797,326,960.1797,316,970.1797,262,970.1797,262,953.1797" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="275" y="967.2466">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="540.25" y="986.2466">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="543.25" y="1001.3794"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="1066.7109" y2="1066.7109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="1066.7109" y2="1079.7109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="1079.7109" y2="1079.7109"/><polygon fill="#A80036" points="335.5,1075.7109,325.5,1079.7109,335.5,1083.7109,331.5,1079.7109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="1061.645">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="349.5" y="1061.645">Generate Hash for the incoming message and compare hashes</text><path d="M329,1092.7109 L329,1147.7109 L696,1147.7109 L696,1102.7109 L686,1092.7109 L329,1092.7109 " fill="#D3D3D3" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,1092.7109 L686,1102.7109 L696,1102.7109 L686,1092.7109 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="335" y="1109.7778">For individual transfers in a bulk, attributes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="335" y="1124.9106">such as payer, payee, expiry time, etc. need</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="335" y="1140.0435">to be added before the hash is generated (in bulk-prepare).</text><path d="M225,1164.1094 L288,1164.1094 L288,1171.1094 L278,1181.1094 L225,1181.1094 L225,1164.1094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2301.9609" style="stroke: #000000; stroke-width: 2.0;" width="1517" x="225" y="1164.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240" y="1177.1763">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="303" y="1176.3198">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1232.5,1213.5078,1242.5,1217.5078,1232.5,1221.5078,1236.5,1217.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="1217.5078" y2="1217.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="1204.8755">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="349.5" y="1197.3091">Request to retrieve Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="349.5" y="1212.4419">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="423.5" y="1212.4419">2003</text><polygon fill="#A80036" points="1621.5,1242.6406,1631.5,1246.6406,1621.5,1250.6406,1625.5,1246.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="1246.6406" y2="1246.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1261.5" y="1241.5747">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="1279.5" y="1241.5747">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1576,1259.6406,1700,1259.6406,1710,1278.6406,1700,1297.6406,1576,1297.6406,1566,1278.6406,1576,1259.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1578" y="1275.7075">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1578" y="1290.8403">transferStateChange</text><polygon fill="#A80036" points="1265.5,1320.0391,1255.5,1324.0391,1265.5,1328.0391,1261.5,1324.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1259.5" x2="1637.5" y1="1324.0391" y2="1324.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1271.5" y="1318.9731">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1289.5" y="1318.9731">Return Transfer state</text><polygon fill="#A80036" points="335.5,1349.1719,325.5,1353.1719,335.5,1357.1719,331.5,1353.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="1353.1719" y2="1353.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="1348.106">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="359.5" y="1348.106">Return Transfer state</text><path d="M235,1368.1719 L318,1368.1719 L318,1375.1719 L308,1385.1719 L235,1385.1719 L235,1368.1719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1972.5625" style="stroke: #000000; stroke-width: 2.0;" width="1497" x="235" y="1368.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="250" y="1381.2388">break</text><path d="M245,1392.3047 L308,1392.3047 L308,1399.3047 L298,1409.3047 L245,1409.3047 L245,1392.3047 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1941.4297" style="stroke: #000000; stroke-width: 2.0;" width="1477" x="245" y="1392.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="260" y="1405.3716">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="323" y="1404.5151">[If type == 'prepare']</text><path d="M255,1416.4375 L318,1416.4375 L318,1423.4375 L308,1433.4375 L255,1433.4375 L255,1416.4375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="805.0547" style="stroke: #000000; stroke-width: 2.0;" width="1457" x="255" y="1416.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="270" y="1429.5044">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="253" x="333" y="1428.6479">[If transferState IN ['COMMITTED', 'ABORTED']]</text><polygon fill="#A80036" points="1232.5,1450.7031,1242.5,1454.7031,1232.5,1458.7031,1236.5,1454.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="1454.7031" y2="1454.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="1449.6372">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="349.5" y="1449.6372">Request to retrieve fulfilment, completedTimestamp for the transferId</text><polygon fill="#A80036" points="1621.5,1479.8359,1631.5,1483.8359,1621.5,1487.8359,1625.5,1483.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="1483.8359" y2="1483.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1261.5" y="1478.77">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="1279.5" y="1478.77">Request fulfilment, completedTimestamp for the transferId</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1585,1496.8359,1692,1496.8359,1702,1507.8359,1692,1519.8359,1585,1519.8359,1575,1507.8359,1585,1496.8359" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="1587" y="1512.9028">transferFulfilment</text><polygon fill="#A80036" points="1265.5,1542.1016,1255.5,1546.1016,1265.5,1550.1016,1261.5,1546.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1259.5" x2="1637.5" y1="1546.1016" y2="1546.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1271.5" y="1541.0356">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1289.5" y="1541.0356">Return fulfilment, completedTimestamp (if they exist)</text><polygon fill="#A80036" points="335.5,1571.2344,325.5,1575.2344,335.5,1579.2344,331.5,1575.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="1575.2344" y2="1575.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="1570.1685">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="359.5" y="1570.1685">Return fulfilment, completedTimestamp (if they exist)</text><path d="M329,1588.2344 L329,2021.2344 L769,2021.2344 L769,1598.2344 L759,1588.2344 L329,1588.2344 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M759,1588.2344 L759,1598.2344 L769,1598.2344 L759,1588.2344 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="1605.3013">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="1620.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="1635.5669">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="347" y="1650.6997">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="1665.8325">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="347" y="1680.9653">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="347" y="1696.0981">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="359" y="1711.231">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="359" y="1726.3638">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="371" y="1741.4966">transferState: "COMMITTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="371" y="1756.6294">fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="371" y="1771.7622">completedTimestamp: "2018-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="1786.895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="347" y="1802.0278">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="347" y="1817.1606">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="359" y="1832.2935">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="371" y="1847.4263">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="371" y="1862.5591">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="371" y="1877.6919">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="371" y="1892.8247">action: prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="371" y="1907.9575">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="371" y="1923.0903">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="383" y="1938.2231">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="383" y="1953.356">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="1968.4888">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="1983.6216">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="1998.7544">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="2013.8872">}</text><polygon fill="#A80036" points="1001.5,2078.3516,1011.5,2082.3516,1001.5,2086.3516,1005.5,2082.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1007.5" y1="2082.3516" y2="2082.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="2062.1528">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="349.5" y="2047.02">Publish Notification (failure) event for the Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="2062.1528">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="2062.1528">3106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="460.5" y="2062.1528"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="443" x="349.5" y="2077.2856">For the Data Model, refer to the final step in this diagram (has the same text).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="1712" y1="2091.3516" y2="2091.3516"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="260" y="2101.562">[If transferState IN ['RECEIVED', 'RESERVED']]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="2126.2891" y2="2126.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="2126.2891" y2="2139.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="2139.2891" y2="2139.2891"/><polygon fill="#A80036" points="335.5,2135.2891,325.5,2139.2891,335.5,2143.2891,331.5,2139.2891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="2121.2231">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="349.5" y="2121.2231">This request can be ignored, because a callback is about to be sent to the client.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="1712" y1="2148.2891" y2="2148.2891"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="260" y="2158.4995">[If transferState does not exist]</text><polygon fill="#A80036" points="1001.5,2209.4922,1011.5,2213.4922,1001.5,2217.4922,1005.5,2213.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1007.5" y1="2213.4922" y2="2213.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="2193.2935">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="349.5" y="2178.1606">Send /error callback with appropriate error message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="349.5" y="2193.2935">(Invalid duplicate request)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="349.5" y="2208.4263">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="423.5" y="2208.4263">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="245" x2="1722" y1="2229.4922" y2="2229.4922"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="250" y="2239.7026">[If type == 'bulk-prepare']</text><path d="M255,2250.2969 L318,2250.2969 L318,2257.2969 L308,2267.2969 L255,2267.2969 L255,2250.2969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="948.5" x="255" y="2250.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="270" y="2263.3638">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="380" x="333" y="2262.5073">[If transferState IN ['COMMITTED', 'ABORTED','RECEIVED', 'RESERVED']]</text><path d="M329,2272.4297 L329,2705.4297 L781,2705.4297 L781,2282.4297 L771,2272.4297 L329,2272.4297 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M771,2272.4297 L771,2282.4297 L781,2282.4297 L771,2272.4297 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="2289.4966">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="2304.6294">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="2319.7622">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="347" y="2334.895">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="2350.0278">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="347" y="2365.1606">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="347" y="2380.2935">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="359" y="2395.4263">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="359" y="2410.5591">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="383" y="2425.6919">transferState: "RECEIVED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="383" y="2440.8247">fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="383" y="2455.9575">completedTimestamp: "2018-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="2471.0903">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="347" y="2486.2231">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="347" y="2501.356">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="359" y="2516.4888">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="371" y="2531.6216">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="371" y="2546.7544">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="371" y="2561.8872">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="371" y="2577.02">action: prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="371" y="2592.1528">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="371" y="2607.2856">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="383" y="2622.4185">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="383" y="2637.5513">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="2652.6841">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="2667.8169">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="2682.9497">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="2698.0825">}</text><polygon fill="#A80036" points="1120,2777.6797,1130,2781.6797,1120,2785.6797,1124,2781.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1126" y1="2781.6797" y2="2781.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="2753.9146">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="349.5" y="2731.2153">Publish Prepare Duplicate event to Bulk Processing Topic</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="349.5" y="2746.3481">(for the individual transfer) with the current transferState</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="2761.481">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="2761.481">2003</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="349.5" y="2776.6138">[Duplicate request]</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="1203.5" y1="2790.6797" y2="2790.6797"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="260" y="2800.8901">[If transferState does not exist]</text><path d="M329,2809.4844 L329,3242.4844 L781,3242.4844 L781,2819.4844 L771,2809.4844 L329,2809.4844 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M771,2809.4844 L771,2819.4844 L781,2819.4844 L771,2809.4844 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="2826.5513">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="2841.6841">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="2856.8169">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="347" y="2871.9497">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="347" y="2887.0825">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="347" y="2902.2153">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="347" y="2917.3481">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="359" y="2932.481">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="359" y="2947.6138">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="383" y="2962.7466">transferState: "RECEIVED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="383" y="2977.8794">fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="383" y="2993.0122">completedTimestamp: "2018-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="3008.145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="347" y="3023.2778">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="347" y="3038.4106">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="359" y="3053.5435">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="371" y="3068.6763">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="371" y="3083.8091">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="371" y="3098.9419">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="371" y="3114.0747">action: prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="371" y="3129.2075">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="371" y="3144.3403">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="383" y="3159.4731">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="383" y="3174.606">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="3189.7388">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="3204.8716">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="3220.0044">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="335" y="3235.1372">}</text><polygon fill="#A80036" points="1120,3314.7344,1130,3318.7344,1120,3322.7344,1124,3318.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1126" y1="3318.7344" y2="3318.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="3290.9692">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="349.5" y="3268.27">Publish Prepare failure event to Bulk Processing Topic</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="349.5" y="3283.4028">(for the individual transfer) with the current transferState</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="3298.5356">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="3298.5356">2003</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="349.5" y="3313.6685">[Duplicate invalid request]</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="225" x2="1742" y1="3348.7344" y2="3348.7344"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="230" y="3358.9448">[Transfer exists, hash does not match]</text><path d="M255,3369.5391 L338,3369.5391 L338,3376.5391 L328,3386.5391 L255,3386.5391 L255,3369.5391 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="89.5313" style="stroke: #000000; stroke-width: 2.0;" width="422.5" x="255" y="3369.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="270" y="3382.606">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="3438.0703" y2="3438.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="3438.0703" y2="3451.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="3451.0703" y2="3451.0703"/><polygon fill="#A80036" points="335.5,3447.0703,325.5,3451.0703,335.5,3455.0703,331.5,3451.0703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="3417.8716">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="349.5" y="3402.7388">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="3417.8716">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="3417.8716">3106</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="349.5" y="3433.0044">Reference: Failure in Prepare Transfer Validation</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="215" x2="1752" y1="3474.0703" y2="3474.0703"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="220" y="3484.2808">[If transferId does NOT exist]</text><polygon fill="#A80036" points="1232.5,3520.1406,1242.5,3524.1406,1232.5,3528.1406,1236.5,3524.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="3524.1406" y2="3524.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="3511.5083">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="349.5" y="3503.9419">Request to persist Transfer Hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="349.5" y="3519.0747">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="423.5" y="3519.0747">2003</text><polygon fill="#A80036" points="1621.5,3549.2734,1631.5,3553.2734,1621.5,3557.2734,1625.5,3553.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="3553.2734" y2="3553.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1261.5" y="3548.2075">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="1279.5" y="3548.2075">Persist Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1568,3596.2734,1708,3596.2734,1718,3607.2734,1708,3619.2734,1568,3619.2734,1558,3607.2734,1568,3596.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1570" y="3612.3403">transferDuplicateCheck</text><polygon fill="#A80036" points="335.5,3641.5391,325.5,3645.5391,335.5,3649.5391,331.5,3645.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="3645.5391" y2="3645.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="3640.4731">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="359.5" y="3640.4731">Return success</text><path d="M329,3672.5391 L329,3742.5391 L790,3742.5391 L790,3682.5391 L780,3672.5391 L329,3672.5391 " fill="#D3D3D3" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M780,3672.5391 L780,3682.5391 L790,3682.5391 L780,3672.5391 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="335" y="3689.606">The validation of Payer, Payee can be skipped for individual transfers in Bulk</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="335" y="3704.7388">as they should've/would've been validated already in the bulk prepare part.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="335" y="3719.8716">However, leaving it here for now, as in the future, this can be leveraged</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="335" y="3735.0044">when bulk transfers to multiple Payees are supported by the Specification.</text><path d="M255,3759.0703 L394,3759.0703 L394,3766.0703 L384,3776.0703 L255,3776.0703 L255,3759.0703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1463" x="255" y="3759.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="270" y="3772.1372">Validate Payer</text><polygon fill="#A80036" points="1342.5,3793.3359,1352.5,3797.3359,1342.5,3801.3359,1346.5,3797.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1348.5" y1="3797.3359" y2="3797.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="3792.27">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="349.5" y="3792.27">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1621.5,3822.4688,1631.5,3826.4688,1621.5,3830.4688,1625.5,3826.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1364.5" x2="1627.5" y1="3826.4688" y2="3826.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1371.5" y="3821.4028">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1389.5" y="3821.4028">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1578,3839.4688,1698,3839.4688,1708,3858.4688,1698,3877.4688,1578,3877.4688,1568,3858.4688,1578,3839.4688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1580" y="3855.5356">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1580" y="3870.6685">participantCurrency</text><polygon fill="#A80036" points="1375.5,3899.8672,1365.5,3903.8672,1375.5,3907.8672,1371.5,3903.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1369.5" x2="1637.5" y1="3903.8672" y2="3903.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1381.5" y="3898.8013">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1399.5" y="3898.8013">Return Participant details if it exists</text><polygon fill="#A80036" points="335.5,3929,325.5,3933,335.5,3937,331.5,3933" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1358.5" y1="3933" y2="3933"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="3927.9341">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="359.5" y="3927.9341">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="3977.2656" y2="3977.2656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="3977.2656" y2="3990.2656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="3990.2656" y2="3990.2656"/><polygon fill="#A80036" points="335.5,3986.2656,325.5,3990.2656,335.5,3994.2656,331.5,3990.2656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="3964.6333">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="349.5" y="3957.0669">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="3972.1997">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="3972.1997">3202</text><path d="M255,4012.2656 L396,4012.2656 L396,4019.2656 L386,4029.2656 L255,4029.2656 L255,4012.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="239.1953" style="stroke: #000000; stroke-width: 2.0;" width="1463" x="255" y="4012.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="270" y="4025.3325">Validate Payee</text><polygon fill="#A80036" points="1342.5,4046.5313,1352.5,4050.5313,1342.5,4054.5313,1346.5,4050.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1348.5" y1="4050.5313" y2="4050.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4045.4653">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="349.5" y="4045.4653">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1621.5,4075.6641,1631.5,4079.6641,1621.5,4083.6641,1625.5,4079.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1364.5" x2="1627.5" y1="4079.6641" y2="4079.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1371.5" y="4074.5981">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1389.5" y="4074.5981">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1578,4092.6641,1698,4092.6641,1708,4111.6641,1698,4130.6641,1578,4130.6641,1568,4111.6641,1578,4092.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1580" y="4108.731">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1580" y="4123.8638">participantCurrency</text><polygon fill="#A80036" points="1375.5,4153.0625,1365.5,4157.0625,1375.5,4161.0625,1371.5,4157.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1369.5" x2="1637.5" y1="4157.0625" y2="4157.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1381.5" y="4151.9966">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1399.5" y="4151.9966">Return Participant details if it exists</text><polygon fill="#A80036" points="335.5,4182.1953,325.5,4186.1953,335.5,4190.1953,331.5,4186.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1358.5" y1="4186.1953" y2="4186.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="4181.1294">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="359.5" y="4181.1294">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="4230.4609" y2="4230.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="4230.4609" y2="4243.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="4243.4609" y2="4243.4609"/><polygon fill="#A80036" points="335.5,4239.4609,325.5,4243.4609,335.5,4247.4609,331.5,4243.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4217.8286">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="349.5" y="4210.2622">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="4225.395">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="4225.395">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="4294.7266" y2="4294.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="4294.7266" y2="4307.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="4307.7266" y2="4307.7266"/><polygon fill="#A80036" points="335.5,4303.7266,325.5,4307.7266,335.5,4311.7266,331.5,4307.7266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4282.0942">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="349.5" y="4274.5278">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="4289.6606">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="4289.6606">3100</text><path d="M245,4322.7266 L308,4322.7266 L308,4329.7266 L298,4339.7266 L245,4339.7266 L245,4322.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="576.8594" style="stroke: #000000; stroke-width: 2.0;" width="1485" x="245" y="4322.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="260" y="4335.7935">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="323" y="4334.937">[Validate Prepare Transfer (success)]</text><path d="M255,4346.8594 L701,4346.8594 L701,4353.8594 L691,4363.8594 L255,4363.8594 L255,4346.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1465" x="255" y="4346.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="401" x="270" y="4359.9263">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1232.5,4396.2578,1242.5,4400.2578,1232.5,4404.2578,1236.5,4400.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="4400.2578" y2="4400.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4387.6255">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="349.5" y="4380.0591">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="4395.1919">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="4395.1919">2003</text><polygon fill="#A80036" points="1621.5,4425.3906,1631.5,4429.3906,1621.5,4433.3906,1625.5,4429.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="4429.3906" y2="4429.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1261.5" y="4424.3247">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1279.5" y="4424.3247">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1576,4472.3906,1700,4472.3906,1710,4513.3906,1700,4555.3906,1576,4555.3906,1566,4513.3906,1576,4472.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1578" y="4488.4575">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1578" y="4503.5903">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1578" y="4518.7231">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1578" y="4533.856">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1578" y="4548.9888">ilpPacket</text><polygon fill="#A80036" points="335.5,4578.1875,325.5,4582.1875,335.5,4586.1875,331.5,4582.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="4582.1875" y2="4582.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="4577.1216">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="359.5" y="4577.1216">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="245" x2="1730" y1="4598.1875" y2="4598.1875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="250" y="4608.3979">[Validate Prepare Transfer (failure)]</text><path d="M255,4618.9922 L1004,4618.9922 L1004,4625.9922 L994,4635.9922 L255,4635.9922 L255,4618.9922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="273.5938" style="stroke: #000000; stroke-width: 2.0;" width="1465" x="255" y="4618.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="704" x="270" y="4632.0591">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1232.5,4683.5234,1242.5,4687.5234,1232.5,4691.5234,1236.5,4687.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1238.5" y1="4687.5234" y2="4687.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4667.3247">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="349.5" y="4652.1919">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="349.5" y="4667.3247">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="4682.4575">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="4682.4575">2003</text><polygon fill="#A80036" points="1621.5,4712.6563,1631.5,4716.6563,1621.5,4720.6563,1625.5,4716.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1254.5" x2="1627.5" y1="4716.6563" y2="4716.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1261.5" y="4711.5903">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1279.5" y="4711.5903">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fau1crc8bnqni)" points="1576,4759.6563,1700,4759.6563,1710,4808.6563,1700,4857.6563,1576,4857.6563,1566,4808.6563,1576,4759.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1578" y="4775.7231">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1578" y="4790.856">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1578" y="4805.9888">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1578" y="4821.1216">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1578" y="4836.2544">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1578" y="4851.3872">ilpPacket</text><polygon fill="#A80036" points="335.5,4880.5859,325.5,4884.5859,335.5,4888.5859,331.5,4884.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="329.5" x2="1248.5" y1="4884.5859" y2="4884.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="341.5" y="4879.52">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="359.5" y="4879.52">Return success</text><path d="M255,4920.5859 L318,4920.5859 L318,4927.5859 L308,4937.5859 L255,4937.5859 L255,4920.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="116.2031" style="stroke: #000000; stroke-width: 2.0;" width="425.5" x="255" y="4920.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="270" y="4933.6528">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="333" y="4932.7964">[Validate Prepare Transfer (success)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="4958.8516" y2="4958.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="4958.8516" y2="4971.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="4971.8516" y2="4971.8516"/><polygon fill="#A80036" points="335.5,4967.8516,325.5,4971.8516,335.5,4975.8516,331.5,4971.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="4953.7856">46</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="308" x="352.5" y="4953.7856">Reference: Prepare -&gt; Position Produce message</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="680.5" y1="4980.8516" y2="4980.8516"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="260" y="4991.062">[Validate Prepare Transfer (failure)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="366.5" y1="5015.7891" y2="5015.7891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366.5" x2="366.5" y1="5015.7891" y2="5028.7891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="366.5" y1="5028.7891" y2="5028.7891"/><polygon fill="#A80036" points="335.5,5024.7891,325.5,5028.7891,335.5,5032.7891,331.5,5028.7891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="5010.7231">47</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="352.5" y="5010.7231">Reference: Failure in Prepare Transfer Validation</text><path d="M245,5057.7891 L598,5057.7891 L598,5064.7891 L588,5074.7891 L245,5074.7891 L245,5057.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="925.9766" style="stroke: #000000; stroke-width: 2.0;" width="662.5" x="245" y="5057.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="308" x="260" y="5070.856">Reference: Prepare -&gt; Position Produce message</text><path d="M255,5081.9219 L318,5081.9219 L318,5088.9219 L308,5098.9219 L255,5098.9219 L255,5081.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="894.8438" style="stroke: #000000; stroke-width: 2.0;" width="642.5" x="255" y="5081.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="270" y="5094.9888">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="333" y="5094.1323">[If type == 'bulk-prepare']</text><path d="M329,5104.0547 L329,5477.0547 L578,5477.0547 L578,5114.0547 L568,5104.0547 L329,5104.0547 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M568,5104.0547 L568,5114.0547 L578,5114.0547 L568,5104.0547 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="5121.1216">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="5136.2544">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="5151.3872">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="359" y="5166.52">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="5181.6528">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="359" y="5196.7856">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="359" y="5211.9185">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="371" y="5227.0513">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="371" y="5242.1841">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="359" y="5257.3169">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="359" y="5272.4497">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="371" y="5287.5825">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="383" y="5302.7153">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="383" y="5317.8481">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="383" y="5332.981">type: bulk-position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="383" y="5348.1138">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="383" y="5363.2466">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="383" y="5378.3794">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="395" y="5393.5122">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="395" y="5408.645">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="383" y="5423.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="5438.9106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="5454.0435">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="5469.1763">}</text><polygon fill="#A80036" points="811.5,5518.5078,821.5,5522.5078,811.5,5526.5078,815.5,5522.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="817.5" y1="5522.5078" y2="5522.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="5509.8755">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="349.5" y="5502.3091">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="5517.4419">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="5517.4419">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="897.5" y1="5531.5078" y2="5531.5078"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="260" y="5541.7183">[If type == 'prepare']</text><path d="M329,5550.3125 L329,5923.3125 L578,5923.3125 L578,5560.3125 L568,5550.3125 L329,5550.3125 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M568,5550.3125 L568,5560.3125 L578,5560.3125 L568,5550.3125 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="5567.3794">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="5582.5122">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="5597.645">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="359" y="5612.7778">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="5627.9106">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="359" y="5643.0435">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="359" y="5658.1763">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="371" y="5673.3091">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="371" y="5688.4419">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="359" y="5703.5747">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="359" y="5718.7075">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="371" y="5733.8403">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="383" y="5748.9731">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="383" y="5764.106">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="383" y="5779.2388">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="383" y="5794.3716">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="383" y="5809.5044">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="383" y="5824.6372">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="395" y="5839.77">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="395" y="5854.9028">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="383" y="5870.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="5885.1685">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="5900.3013">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="5915.4341">}</text><polygon fill="#A80036" points="811.5,5964.7656,821.5,5968.7656,811.5,5972.7656,815.5,5968.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="817.5" y1="5968.7656" y2="5968.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="5956.1333">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="349.5" y="5948.5669">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="5963.6997">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="5963.6997">2003</text><path d="M245,5997.7656 L603,5997.7656 L603,6004.7656 L593,6014.7656 L245,6014.7656 L245,5997.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1107.5703" style="stroke: #000000; stroke-width: 2.0;" width="968.5" x="245" y="5997.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="260" y="6010.8325">Reference: Failure in Prepare Transfer Validation</text><path d="M255,6021.8984 L318,6021.8984 L318,6028.8984 L308,6038.8984 L255,6038.8984 L255,6021.8984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="948.5" x="255" y="6021.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="270" y="6034.9653">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="333" y="6034.1089">[If type == 'bulk-prepare']</text><path d="M329,6044.0313 L329,6507.0313 L868,6507.0313 L868,6054.0313 L858,6044.0313 L329,6044.0313 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M858,6044.0313 L858,6054.0313 L868,6054.0313 L858,6044.0313 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="6061.0981">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="6076.231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="6091.3638">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="359" y="6106.4966">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="359" y="6121.6294">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="359" y="6136.7622">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="359" y="6151.895">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="371" y="6167.0278">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="371" y="6182.1606">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="383" y="6197.2935">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="395" y="6212.4263">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="395" y="6227.5591">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="395" y="6242.6919">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="6257.8247">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="359" y="6272.9575">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="359" y="6288.0903">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="371" y="6303.2231">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="383" y="6318.356">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="383" y="6333.4888">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="383" y="6348.6216">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="383" y="6363.7544">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="383" y="6378.8872">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="383" y="6394.02">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="6409.1528">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="395" y="6424.2856">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="395" y="6439.4185">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="383" y="6454.5513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="6469.6841">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="6484.8169">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="6499.9497">}</text><polygon fill="#A80036" points="1120,6549.2813,1130,6553.2813,1120,6557.2813,1124,6553.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1126" y1="6553.2813" y2="6553.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="6540.6489">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="349.5" y="6533.0825">Publish Prepare failure event to Bulk Processing Topic (for Payer)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="6548.2153">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="6548.2153">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="1203.5" y1="6562.2813" y2="6562.2813"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="260" y="6572.4917">[If type == 'prepare']</text><path d="M329,6581.0859 L329,7044.0859 L868,7044.0859 L868,6591.0859 L858,6581.0859 L329,6581.0859 " fill="#FFFF00" filter="url(#fau1crc8bnqni)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M858,6581.0859 L858,6591.0859 L868,6591.0859 L858,6581.0859 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="335" y="6598.1528">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="6613.2856">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="359" y="6628.4185">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="359" y="6643.5513">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="359" y="6658.6841">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="359" y="6673.8169">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="359" y="6688.9497">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="371" y="6704.0825">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="371" y="6719.2153">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="383" y="6734.3481">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="395" y="6749.481">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="395" y="6764.6138">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="395" y="6779.7466">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="6794.8794">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="359" y="6810.0122">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="359" y="6825.145">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="371" y="6840.2778">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="383" y="6855.4106">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="383" y="6870.5435">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="383" y="6885.6763">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="383" y="6900.8091">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="383" y="6915.9419">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="383" y="6931.0747">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="6946.2075">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="395" y="6961.3403">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="395" y="6976.4731">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="383" y="6991.606">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="371" y="7006.7388">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="359" y="7021.8716">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="347" y="7037.0044">}</text><polygon fill="#A80036" points="1001.5,7086.3359,1011.5,7090.3359,1001.5,7094.3359,1005.5,7090.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="1007.5" y1="7090.3359" y2="7090.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="331.5" y="7077.7036">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="349.5" y="7070.1372">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="349.5" y="7085.27">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="429.5" y="7085.27">2003</text><!--
@startuml
title 1.2.1. Prepare Handler Consume (single message, includes individual transfers from Bulk)

autonumber


collections "topic-\ntransfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Handler" as PREP_HANDLER
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
collections "topic-\nevent" as TOPIC_EVENTS
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event message
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type IN ['prepare', 'bulk-prepare'] && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #gray>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #gray>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            PREP_HANDLER -> POS_DAO: Request to retrieve Transfer Hash for a transferId
            activate POS_DAO
            POS_DAO -> DB: Request Transfer Hash for a transferId
            activate DB
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            POS_DAO <- - DB: Return hash if it exists
            deactivate DB
            PREP_HANDLER <- - POS_DAO: Return hash if it exists
            deactivate POS_DAO

            alt If transferId exists
                group Persist Event Information
                    |||
                    PREP_HANDLER -> TOPIC_EVENTS: Publish event information
                    ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
                    |||
                end
                PREP_HANDLER -> PREP_HANDLER: Generate Hash for the incoming message and compare hashes
                note right of PREP_HANDLER #lightgrey
                    For individual transfers in a bulk, attributes
                    such as payer, payee, expiry time, etc. need
                    to be added before the hash is generated (in bulk-prepare).
                end note

                alt Transfer exists, hash matches    
                    PREP_HANDLER -> POS_DAO: Request to retrieve Transfer state \n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Request Transfer state
                    hnote over DB #lightyellow
                        transfer
                        transferStateChange
                    end note
                    activate DB
                    POS_DAO <- - DB: Return Transfer state
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return Transfer state
                    deactivate POS_DAO
                    break
                        alt If type == 'prepare'
                            alt If transferState IN ['COMMITTED', 'ABORTED']
                                PREP_HANDLER -> POS_DAO: Request to retrieve fulfilment, completedTimestamp for the transferId
                                activate POS_DAO
                                POS_DAO -> DB: Request fulfilment, completedTimestamp for the transferId
                                activate DB
                                hnote over DB #lightyellow
                                    transferFulfilment
                                end note
                                POS_DAO <- - DB: Return fulfilment, completedTimestamp (if they exist)
                                deactivate DB
                                PREP_HANDLER <- - POS_DAO: Return fulfilment, completedTimestamp (if they exist)
                                deactivate POS_DAO
                                note right of PREP_HANDLER #yellow
                                    Message:
                                    {
                                        id: <transferMessage.transferId>
                                        from: <transferMessage.payerFsp>,
                                        to: <transferMessage.payeeFsp>,
                                        type: application/json
                                        content: {
                                            headers: <transferHeaders>,
                                            payload: {
                                                transferState: "COMMITTED",
                                                fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",
                                                completedTimestamp: "2018-10-24T08:38:08.699-04:00"
                                            }
                                        },
                                        metadata: {
                                            event: {
                                                id: <uuid>,
                                                responseTo: <previous.uuid>,
                                                type: notification,
                                                action: prepare-duplicate,
                                                createdAt: <timestamp>,
                                                state: {
                                                    status: "success",
                                                    code: 0
                                                }
                                            }
                                        }
                                    }
                                end note                            
                                PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for the Payer\n<color #FF0000><b>Error codes:</b> 3106</color> \nFor the Data Model, refer to the final step in this diagram (has the same text).
                            else If transferState IN ['RECEIVED', 'RESERVED']
                                PREP_HANDLER <-> PREP_HANDLER: This request can be ignored, because a callback is about to be sent to the client.
                            else If transferState does not exist
                                PREP_HANDLER -> TOPIC_NOTIFICATIONS: Send /error callback with appropriate error message\n(Invalid duplicate request)\n<color #FF0000><b>Error code:</b> 3100</color>
                            end
                        else If type == 'bulk-prepare'
                            alt If transferState IN ['COMMITTED', 'ABORTED','RECEIVED', 'RESERVED']
                                note right of PREP_HANDLER #yellow
                                    Message:
                                    {
                                        id: <transferMessage.transferId>
                                        from: <transferMessage.payerFsp>,
                                        to: <transferMessage.payeeFsp>,
                                        type: application/json
                                        content: {
                                            headers: <transferHeaders>,
                                            payload: {
                                                    transferState: "RECEIVED",
                                                    fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",
                                                    completedTimestamp: "2018-10-24T08:38:08.699-04:00"
                                                }
                                        },
                                        metadata: {
                                            event: {
                                                id: <uuid>,
                                                responseTo: <previous.uuid>,
                                                type: bulk-processing,
                                                action: prepare-duplicate,
                                                createdAt: <timestamp>,
                                                state: {
                                                    status: "success",
                                                    code: 0
                                                }
                                            }
                                        }
                                    }
                                end note
                                PREP_HANDLER -> TOPIC_BULK_PROCESSING: Publish Prepare Duplicate event to Bulk Processing Topic\n(for the individual transfer) with the current transferState\n<color #FF0000><b>Error codes:</b> 2003</color>\n[Duplicate request]
                            else If transferState does not exist
                                note right of PREP_HANDLER #yellow
                                    Message:
                                    {
                                        id: <transferMessage.transferId>
                                        from: <transferMessage.payerFsp>,
                                        to: <transferMessage.payeeFsp>,
                                        type: application/json
                                        content: {
                                            headers: <transferHeaders>,
                                            payload: {
                                                    transferState: "RECEIVED",
                                                    fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",
                                                    completedTimestamp: "2018-10-24T08:38:08.699-04:00"
                                                }
                                        },
                                        metadata: {
                                            event: {
                                                id: <uuid>,
                                                responseTo: <previous.uuid>,
                                                type: bulk-processing,
                                                action: prepare-duplicate,
                                                createdAt: <timestamp>,
                                                state: {
                                                    status: "error",
                                                    code: 0
                                                }
                                            }
                                        }
                                    }
                                end note
                                PREP_HANDLER -> TOPIC_BULK_PROCESSING: Publish Prepare failure event to Bulk Processing Topic\n(for the individual transfer) with the current transferState\n<color #FF0000><b>Error codes:</b> 2003</color>\n[Duplicate invalid request]
                            end
                        end
                    end
                else Transfer exists, hash does not match
                    break
                        PREP_HANDLER -> PREP_HANDLER: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 3106</color>\n<color Magenta><b>Reference: Failure in Prepare Transfer Validation </b></color>
                    end
                end

            else If transferId does NOT exist
                PREP_HANDLER -> POS_DAO: Request to persist Transfer Hash \n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist Transfer message hash
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
            deactivate POS_DAO
            
        end
        note right of PREP_HANDLER #lightgrey
            The validation of Payer, Payee can be skipped for individual transfers in Bulk
            as they should've/would've been validated already in the bulk prepare part.
            However, leaving it here for now, as in the future, this can be leveraged
            when bulk transfers to multiple Payees are supported by the Specification.
        end note
        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Prepare Transfer (success)
            group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        else Validate Prepare Transfer (failure)
            group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    transferError
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        end

    end
    alt Validate Prepare Transfer (success)
        PREP_HANDLER -> PREP_HANDLER: <color Magenta><b> Reference: Prepare -> Position Produce message </b></color>
    else Validate Prepare Transfer (failure)
        PREP_HANDLER -> PREP_HANDLER: <color Magenta><b> Reference: Failure in Prepare Transfer Validation </b></color>
    end
end

group Reference: Prepare -> Position Produce message
    alt If type == 'bulk-prepare'
        note right of PREP_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of PREP_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
    end
    
end

group Reference: Failure in Prepare Transfer Validation
    alt If type == 'bulk-prepare'
        note right of PREP_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-processing,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_BULK_PROCESSING: Publish Prepare failure event to Bulk Processing Topic (for Payer) \n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of PREP_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
    end
    
end

deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="254px" preserveAspectRatio="none" style="width:512px;height:254px;background:#000000;" version="1.1" viewBox="0 0 512 254" width="512px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="211.1348" style="stroke: #FFFFFF; stroke-width: 1.0;" width="511" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="5" y="16.1387">Welcome to PlantUML!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="30.1074"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="251" x="5" y="44.0762">If you use this software, you accept its license.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="91" x="5" y="59.9023">(details by typing</text><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="39" x="99" y="59.4805">license</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="49" x="141" y="59.9023">keyword)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="73.8711"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="250" x="5" y="87.8398">You can start with a simple UML Diagram like:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="101.8086"/><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="95" x="5" y="117.2129">Bob-&gt;Alice:Hello</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="131.6035"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="13" x="5" y="145.5723">Or</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="159.541"/><text fill="#000000" font-family="monospace" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="79" x="5" y="174.9453">classExample</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="8" y="189.3359"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="309" x="5" y="203.3047">You will find more information about PlantUML syntax on</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="109" x="317" y="203.3047">http://plantuml.com</text><line style="stroke: #000000; stroke-width: 1.0;" x1="317" x2="426" y1="205.3047" y2="205.3047"/><image height="71" width="80" x="425" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABHCAMAAACnHDC8AAADAFBMVEX///+BpbvD3u/f7vfPz8+nz+g3ksuZEDkWADr/ujlvsdpTodLCwsOLwOEbg8T//v6pqamZETnLysvT09To5+jqLS4VATj9/f27u7vDw8MTfsK+v7/j4+SOweJprdjL4/KxsbEri8jk8PgXa57c29uUETez1utQoNJ1tNtEmc9cptWBut6ayOW/3O6YEDjY6vUfhcXBwcHs7Ozw9/v83t79uTn7+/vX19ehoaHx8fG2tLXHx8fuVlfrNTYaBjn/vUH5+fmko6WXl5f/+fn95ub+9PT+8PD3qKidmaMxIUrnqDWcFj7n5eX09PTu7u2SkpKfnZ6rq6z0lJTm4tzJrHUfDT339/eFGDn6tjcrEzOvrbBuZ3l4eomSMS7Hz9Smpqasu8SFiYuQETfa2du1m6OOM051J0NWTWL5xse4uLj6zc33r6/4vb7ydHXqLi/72dntTE3tR0ijbn5jW3C+u8NANVQrG0XFubqRVGZza4GQGT2VaS7a0NPJtI6IJj/zszrfqkXXzr/Hw8cgC0LUqltOQ2JsSC5bTGjOpFafSi2+iDGtyt14m7TJhTCPJUSwoIG/qa+ikHiIgpCRHjI9j8KXbnaQH0FLf6FGPlp0cnYyKE2rg49Wj7dFXHmcwtrp6uu+xMjvYWLvW1z97e3sPD3sP0DuUlP709PYzdDPmzqZWWySRVygfHHd1smWkZ+PgnibETqsl260q5fLuppJLC/dpj2HPFLTtHv/ujrTwJy5s6iWjIi0iD3joTTCmU3trjuvZS2zlFvjq0HSyLbYp0qRts10XGxEKC9yPVBQZIOPdlNvMk2NeYNqRlujtcCVrr3j5eY1gK9Qn9GLp7lbeJXRxrCkiZDaozyukoJ+H0B3rc+OYy+iprJkYXdhmr6ee0afs79xq9BikrGKjI3FomEiLFO0ay6nfIm4pZXRjTFuhZSZWm0zcZyJN0KNTk4eebNfdIGGlZ93h5kcED5nOVYyRWbziIk9dJ4kerE5ZYxRUnLG1d7p8PTvY2PtTk/1nZ1ycV/bAAAFfElEQVR42mNgoB7IABFMVDTwlTOVDVyiDiSYqWjgwc93GagJshdRNwzzL8WCKEZqmeemfZp9L5BmoZb7mIwPH2Fg4DelkgtzLpocPsPgxsPwmToudGcyvnzGjSfk0AzqeNn9XPzfCcv/nZi/mzr+dRctcGNYbmsDyijUcCF/nPqvXfy/GTj2UCuCRW0YGExEbfkZqJSwr2kYgqgbqtQycLcBsEAQ7GfIBTuRGoWDwOK3p+59fb4r8jSVDLx7dOnR+2+03v55RLWCwSQbmFlEF1LLywwMz/53rud1enyaioWhM0OGO1VLVwZ+F2qapmIEZ1KjcPBj5gOG4ksIh/JIMWPlPv7ypqQZ11PqGGiox/TtDcefF/fFf6s9p4KBHzku/foNNPAX81t+ga98Xyk2sHNRoNdqsIGMnG87HrC/o9RAxmntyl+5P4AN/HPV+M99SispRt4frP8f/DT9wsYo+F3+/+k/FLuQHWjEZDU2zVvy6s+uPmH6RxUXMv/4G/f+yFtQsv5Daaph5GPj5uJlZWKWhOYTJgYqg1EDB5GBn+nlwpoJ6CrWHkYXKSnBYyBq1hPJYF6Q5nAISSRY236fqOZ1JBHhrNNPbZ5/Q856TH/+M7L+ArsPJeuFuX6uBFL9gWmboSKWLq6guqz87+EDMCtT74AkHVMTP6JkPUbOL+Cc8gdhIH8o4yIoM067AFy41wq6QkXqf9aDrbR5MgkqUvu3DquBcC+XZyzfB2NfvHVz/TuGq8wzemH1RuhjUaVb/I7eRSdhag79jPr2HLeXVzBVIxomLo9vMvT/9y/ZCDPuFNhGQfYC1PB3/L8Dhwt9fN6WfkQovGeodG/nzhfGMBdDqrPfZ0UlbqAY+OBB44UfWFzo6weOCxDgAkWe+k2II+VSTHygroM5yWbHKYbqViQRX4/aN2iRIu4LjwuomVyyQBNXhgPZPbozNqL6slErBL0txy6PamD68ZvIpkERPCUZ1KDq13G7tx5VhO/+8kLkMPxw8dlFuORvGGJYuQYscPV2EaPYU+RO9nHJ2O8JyJnnZ9dCWd9NiDBU/n6PKWMpqqVAbyMc2RPsfwXN37aOaP6eFCEI97Lyd7GP1/4KoxiHqlpdv0cBVcS/uQ7d300710O9LPSH+2eVeE3hdGR/o4C3e5a9eIUiwurEsQNVDTvLw6cQL4MN/HxnnYyZ9GUczd280HeTZqJ0TI6t/PPwJ7JI/OddkIBm+gdrH/Z92ZZpg8W48qjETQwMekgim/9HHWc45bkfIZL79OZ5LA3OkE3XqjagGRcQulwDRBvDRRawJTwB0XZwA/MuHTmOpAWpBRv4Kb8sArmrEW28KAS1GHZ0rb4DYV2FZRXbrieoBWzbIWAYCv1n+sXK9PNGp7spIlEWipbCUqDqB1Cs+DdO3fAOVsyCjeHz2b3uE0oF8I/5yO6gFTADOd5+c639CCkB1t+5uwSuTqxgFQPDjtfVHxDdCFCsAOPiO1qNAioc5r/lmPqP+QsX8yf+m4rsn/a+iX3EUP7s5WZkhS2tW//MWYUs4rk/9+mdU+hxCC2x41o+RMANFPi8alaB3RtoHXDbEmxwv3LDOWiT/5gT2ODiqx+hcWH0SOcAwkBweXjxaEzkArCXBVl+cvzac74DmlkMpd7/ZgEF0vue5xARBQnOC06g4uTvQWhkCCjaifI8QPYypPLZz+cFc6HgC1hkCGg8NH59EiUhffx18wNKIzDgABMj4xu4C2EJ4o1u7TVi6vEXDAwc/BhdATlsFf0ie+eZ6Cp5biielUcR0T7/XxS1lXqYQcP8HFILFFnuwr+9i1C8TDJArpchNTLTfgoNRGvbLPrWeIbazSeZBX+kydbMgnX8UFjvMLkG+q4HABVtKp9tQ9JtAAAAAElFTkSuQmCC" y="6"/><rect fill="#000000" height="42.5938" style="stroke: #000000; stroke-width: 1.0;" width="511" x="0" y="211.1348"/><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="5" y="229.1299">@startuml</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="9" y="245.4268"/><text fill="#FF0000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="9" y="245.4268">Empty description</text><!--
@startuml


@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>