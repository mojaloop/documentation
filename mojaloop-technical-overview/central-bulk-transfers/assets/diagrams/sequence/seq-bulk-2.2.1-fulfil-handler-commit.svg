<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3306px" preserveAspectRatio="none" style="width:1685px;height:3306px;" version="1.1" viewBox="0 0 1685 3306" width="1685px" zoomAndPan="magnify"><defs><filter height="300%" id="f13iwocc3tpasp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="506" x="590.5" y="23.5352">2.2.1. Fulfil Handler Consume (Success) individual transfers from Bulk</text><rect fill="#FFFFE0" height="3261.0391" style="stroke: #A80036; stroke-width: 1.0;" width="1592" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="764.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="3093.752" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="362" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="880" y="2559.7676"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1101.5" y="3175.0391"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1208.0664"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1537.793"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1772.5879"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="2010.0723"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1237.377"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1567.1035"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1801.8984"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="2039.3828"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="2582.3672" style="stroke: #000000; stroke-width: 2.0;" width="1661" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="529" x="298" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="509" x="308" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="731" x="308" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="143.5527" style="stroke: #000000; stroke-width: 2.0;" width="986" x="308" y="458.7031"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="308" y="616.2559"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="348.0156" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="288" y="792.1191"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="298" y="816.4297"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="986" x="308" y="883.0508"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="986" x="308" y="1015.6035"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1026" x="288" y="1070.9141"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="1026" x="288" y="1125.1797"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="1554.5195" style="stroke: #000000; stroke-width: 2.0;" width="1376" x="288" y="1154.1348"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1351" x="298" y="1459.5508"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1331" x="308" y="1483.8613"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1329" x="308" y="1718.6563"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="769.8242" style="stroke: #000000; stroke-width: 2.0;" width="1356" x="298" y="1931.8301"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1336" x="308" y="1956.1406"/><rect fill="#FFFFFF" height="103.8867" style="stroke: none; stroke-width: 1.0;" width="1356" x="298" y="2597.7676"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="382" x="308" y="2619.7227"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="483.3848" style="stroke: #000000; stroke-width: 2.0;" width="876" x="308" y="2729.6543"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="74" x2="74" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="367" x2="367" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="885" x2="885" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="997" x2="997" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1106" x2="1106" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1234" x2="1234" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1342" x2="1342" y1="116.2871" y2="3230.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1559" x2="1559" y1="116.2871" y2="3230.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="3229.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="3233.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="3253.5742">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="318" y="113.334">Fulfil Handler</text><ellipse cx="367" cy="83.7988" fill="#FEFECE" filter="url(#f13iwocc3tpasp)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="363,71.7988,369,66.7988,367,71.7988,369,76.7988,363,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="318" y="3242.5742">Fulfil Handler</text><ellipse cx="367" cy="3261.5273" fill="#FEFECE" filter="url(#f13iwocc3tpasp)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="363,3249.5273,369,3244.5273,367,3249.5273,369,3254.5273,363,3249.5273" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="819" y="60.3105"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="815" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="860" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="822" y="101.334">transfer-position</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="819" y="3229.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="815" y="3233.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="860" y="3253.5742">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="822" y="3270.0625">transfer-position</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="969" y="60.3105"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="965" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="972" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="974.5" y="101.334">event</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="969" y="3229.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="965" y="3233.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="972" y="3253.5742">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="974.5" y="3270.0625">event</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1043" y="60.3105"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1039" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1081.5" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1046" y="101.334">bulk-processing</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1043" y="3229.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1039" y="3233.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1081.5" y="3253.5742">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1046" y="3270.0625">bulk-processing</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1188" y="60.3105"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1184" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1209" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1191" y="101.334">notification</text><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1188" y="3229.0391"/><rect fill="#FEFECE" filter="url(#f13iwocc3tpasp)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1184" y="3233.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1209" y="3253.5742">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1191" y="3270.0625">notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1294" y="113.334">Position DAO</text><ellipse cx="1342" cy="83.7988" fill="#FEFECE" filter="url(#f13iwocc3tpasp)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1330" x2="1354" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1294" y="3242.5742">Position DAO</text><ellipse cx="1342" cy="3261.5273" fill="#FEFECE" filter="url(#f13iwocc3tpasp)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1330" x2="1354" y1="3275.5273" y2="3275.5273"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1511" y="113.334">Central Store</text><path d="M1541,63.7988 C1541,53.7988 1559,53.7988 1559,53.7988 C1559,53.7988 1577,53.7988 1577,63.7988 L1577,89.7988 C1577,99.7988 1559,99.7988 1559,99.7988 C1559,99.7988 1541,99.7988 1541,89.7988 L1541,63.7988 " fill="#FEFECE" filter="url(#f13iwocc3tpasp)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1541,63.7988 C1541,73.7988 1559,73.7988 1559,73.7988 C1559,73.7988 1577,73.7988 1577,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1511" y="3242.5742">Central Store</text><path d="M1541,3255.5273 C1541,3245.5273 1559,3245.5273 1559,3245.5273 C1559,3245.5273 1577,3245.5273 1577,3255.5273 L1577,3281.5273 C1577,3291.5273 1559,3291.5273 1559,3291.5273 C1559,3291.5273 1541,3291.5273 1541,3281.5273 L1541,3255.5273 " fill="#FEFECE" filter="url(#f13iwocc3tpasp)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1541,3255.5273 C1541,3265.5273 1559,3265.5273 1559,3265.5273 C1559,3265.5273 1577,3265.5273 1577,3255.5273 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="3093.752" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="362" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="880" y="2559.7676"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1101.5" y="3175.0391"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1208.0664"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1537.793"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="1772.5879"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1337" y="2010.0723"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1237.377"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1567.1035"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="1801.8984"/><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1554" y="2039.3828"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2582.3672" style="stroke: #000000; stroke-width: 2.0;" width="1661" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><polygon fill="#A80036" points="90,167.9082,80,171.9082,90,175.9082,86,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="84" x2="361" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="96" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="109" y="167.166">Consume Fulfil event message for Payer</text><path d="M298,216.9082 L382,216.9082 L382,223.9082 L372,233.9082 L298,233.9082 L298,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="529" x="298" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="313" y="230.4766">break</text><path d="M308,241.2188 L450,241.2188 L450,248.2188 L440,258.2188 L308,258.2188 L308,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="509" x="308" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="323" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="414" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414" x2="414" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373" x2="414" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="383,304.1504,373,308.1504,383,312.1504,379,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="392" y="275.0977">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'bulk-commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="392" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="476" y="290.4082">2001</text><path d="M308,337.1504 L523,337.1504 L523,344.1504 L513,354.1504 L308,354.1504 L308,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="731" x="308" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="323" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="985,371.7715,995,375.7715,985,379.7715,989,375.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="991" y1="375.7715" y2="375.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="371.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="392" y="371.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="713" x="315" y="383.7715"/><polygon fill="#EEEEEE" points="315,383.7715,379,383.7715,379,390.7715,369,400.7715,315,400.7715,315,383.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328" y="398.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="598.5" y="417.3398">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="602.5" y="432.6504"/><path d="M308,458.7031 L530,458.7031 L530,465.7031 L520,475.7031 L308,475.7031 L308,458.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="143.5527" style="stroke: #000000; stroke-width: 2.0;" width="986" x="308" y="458.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="323" y="472.2715">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="71.2422" style="stroke: #000000; stroke-width: 2.0;" width="968" x="315" y="501.0137"/><polygon fill="#EEEEEE" points="315,501.0137,379,501.0137,379,508.0137,369,518.0137,315,518.0137,315,501.0137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328" y="515.582">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="633" y="534.582">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="851" y="534.582">FSPIOP-Signature</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="633" y="549.8926">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="717" y="549.8926">3105/3106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="637" y="565.2031"/><path d="M308,616.2559 L521,616.2559 L521,623.2559 L511,633.2559 L308,633.2559 L308,616.2559 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="308" y="616.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="323" y="629.8242">Validate Duplicate Check</text><polygon fill="#A80036" points="1547,675.877,1557,679.877,1547,683.877,1551,679.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1553" y1="679.877" y2="679.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="675.1348">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="392" y="675.1348">Request Duplicate Check</text><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1291" x="315" y="687.877"/><polygon fill="#EEEEEE" points="315,687.877,379,687.877,379,694.877,369,704.877,315,704.877,315,687.877" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328" y="702.4453">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="884" y="721.4453">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="888" y="736.7559"/><polygon fill="#A80036" points="383,766.1191,373,770.1191,383,774.1191,379,770.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377" x2="1558" y1="770.1191" y2="770.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="765.377">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="402" y="765.377">Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }</text><path d="M288,792.1191 L350,792.1191 L350,799.1191 L340,809.1191 L288,809.1191 L288,792.1191 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="348.0156" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="288" y="792.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="303" y="805.6875">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="365" y="804.7539">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M298,816.4297 L382,816.4297 L382,823.4297 L372,833.4297 L298,833.4297 L298,816.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="1006" x="298" y="816.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="313" y="829.998">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="414" y1="855.0508" y2="855.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414" x2="414" y1="855.0508" y2="868.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373" x2="414" y1="868.0508" y2="868.0508"/><polygon fill="#A80036" points="383,864.0508,373,868.0508,383,872.0508,379,868.0508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="850.3086">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="392" y="850.3086">stateRecord = await getTransferState(transferId)</text><path d="M308,883.0508 L370,883.0508 L370,890.0508 L360,900.0508 L308,900.0508 L308,883.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="986" x="308" y="883.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="323" y="896.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="385" y="895.6855">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#f13iwocc3tpasp)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="968" x="315" y="925.3613"/><polygon fill="#EEEEEE" points="315,925.3613,379,925.3613,379,932.3613,369,942.3613,315,942.3613,315,925.3613" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328" y="939.9297">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="737" y="958.9297">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="741" y="974.2402"/><polygon fill="#A80036" points="1222,1003.6035,1232,1007.6035,1222,1011.6035,1226,1007.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1228" y1="1007.6035" y2="1007.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="1002.8613">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="392" y="1002.8613">Produce message</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="308" x2="1294" y1="1016.6035" y2="1016.6035"/><path d="M377,1022.6035 L377,1047.6035 L571,1047.6035 L571,1032.6035 L561,1022.6035 L377,1022.6035 " fill="#D3D3D3" filter="url(#f13iwocc3tpasp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M561,1022.6035 L561,1032.6035 L571,1032.6035 L561,1022.6035 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="383" y="1040.1719">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="288" x2="1314" y1="1071.9141" y2="1071.9141"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="293" y="1082.5488">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M377,1090.8691 L377,1115.8691 L731,1115.8691 L731,1100.8691 L721,1090.8691 L377,1090.8691 " fill="#D3D3D3" filter="url(#f13iwocc3tpasp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M721,1090.8691 L721,1100.8691 L731,1100.8691 L721,1090.8691 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="383" y="1108.4375">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="288" x2="1314" y1="1126.1797" y2="1126.1797"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="293" y="1136.8145">[hasDuplicateId == FALSE]</text><path d="M288,1154.1348 L602,1154.1348 L602,1161.1348 L592,1171.1348 L288,1171.1348 L288,1154.1348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1554.5195" style="stroke: #000000; stroke-width: 2.0;" width="1376" x="288" y="1154.1348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="303" y="1167.7031">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1325,1204.0664,1335,1208.0664,1325,1212.0664,1329,1208.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1331" y1="1208.0664" y2="1208.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="379" y="1195.6689">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="392" y="1188.0137">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="392" y="1203.3242">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="469" y="1203.3242">2003</text><polygon fill="#A80036" points="1542,1233.377,1552,1237.377,1542,1241.377,1546,1237.377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1347" x2="1548" y1="1237.377" y2="1237.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1354" y="1232.6348">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1367" y="1232.6348">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#f13iwocc3tpasp)" points="1532,1250.377,1585,1250.377,1595,1261.377,1585,1273.377,1532,1273.377,1522,1261.377,1532,1250.377" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1534" y="1266.9453">transfer</text><polygon fill="#A80036" points="1358,1295.998,1348,1299.998,1358,1303.998,1354,1299.998" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1352" x2="1558" y1="1299.998" y2="1299.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="1295.2559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1390" y="1295.2559"/><polygon fill="#A80036" points="383,1325.3086,373,1329.3086,383,1333.3086,379,1329.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377" x2="1341" y1="1329.3086" y2="1329.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1324.5664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="411" y="1324.5664">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="414" y1="1373.9297" y2="1373.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414" x2="414" y1="1373.9297" y2="1386.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373" x2="414" y1="1386.9297" y2="1386.9297"/><polygon fill="#A80036" points="383,1382.9297,373,1386.9297,383,1390.9297,379,1386.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="1361.5322">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="401" y="1353.877">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="401" y="1369.1875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="478" y="1369.1875">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="414" y1="1431.5508" y2="1431.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414" x2="414" y1="1431.5508" y2="1444.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373" x2="414" y1="1444.5508" y2="1444.5508"/><polygon fill="#A80036" points="383,1440.5508,373,1444.5508,383,1448.5508,379,1444.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="1419.1533">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="401" y="1411.498">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="401" y="1426.8086">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="478" y="1426.8086">3303</text><path d="M298,1459.5508 L365,1459.5508 L365,1466.5508 L355,1476.5508 L298,1476.5508 L298,1459.5508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1351" x="298" y="1459.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="313" y="1473.1191">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="380" y="1472.1855">[Transfer.ilpCondition validate successful]</text><path d="M308,1483.8613 L595,1483.8613 L595,1490.8613 L585,1500.8613 L308,1500.8613 L308,1483.8613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1331" x="308" y="1483.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="323" y="1497.4297">Request current Settlement Window</text><polygon fill="#A80036" points="1325,1533.793,1335,1537.793,1325,1541.793,1329,1537.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1331" y1="1537.793" y2="1537.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="1525.3955">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="401" y="1517.7402">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="401" y="1533.0508">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="478" y="1533.0508">2003</text><polygon fill="#A80036" points="1542,1563.1035,1552,1567.1035,1542,1571.1035,1546,1567.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1347" x2="1548" y1="1567.1035" y2="1567.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1354" y="1562.3613">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1376" y="1562.3613">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#f13iwocc3tpasp)" points="1499,1580.1035,1619,1580.1035,1629,1591.1035,1619,1603.1035,1499,1603.1035,1489,1591.1035,1499,1580.1035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1501" y="1596.6719">settlementWindow</text><polygon fill="#A80036" points="1358,1625.7246,1348,1629.7246,1358,1633.7246,1354,1629.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1352" x2="1558" y1="1629.7246" y2="1629.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1364" y="1624.9824">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1390" y="1624.9824"/><polygon fill="#A80036" points="383,1685.6563,373,1689.6563,383,1693.6563,379,1689.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377" x2="1341" y1="1689.6563" y2="1689.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1669.6035">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="411" y="1654.293">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="411" y="1669.6035">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="452" y="1669.6035">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="411" y="1684.9141">state are updated to the next settlement window</text><path d="M308,1718.6563 L468,1718.6563 L468,1725.6563 L458,1735.6563 L308,1735.6563 L308,1718.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1329" x="308" y="1718.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="323" y="1732.2246">Persist fulfilment</text><polygon fill="#A80036" points="1325,1768.5879,1335,1772.5879,1325,1776.5879,1329,1772.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1331" y1="1772.5879" y2="1772.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="1760.1904">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="401" y="1752.5352">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="401" y="1767.8457">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="478" y="1767.8457">2003</text><polygon fill="#A80036" points="1542,1797.8984,1552,1801.8984,1542,1805.8984,1546,1801.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1347" x2="1548" y1="1801.8984" y2="1801.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1354" y="1797.1563">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1376" y="1797.1563">Persist to database</text><polygon fill="#FFFFE0" filter="url(#f13iwocc3tpasp)" points="1500,1844.8984,1617,1844.8984,1627,1863.8984,1617,1882.8984,1500,1882.8984,1490,1863.8984,1500,1844.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1502" y="1861.4668">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1502" y="1876.7773">transferExtension</text><polygon fill="#A80036" points="383,1905.8301,373,1909.8301,383,1913.8301,379,1909.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377" x2="1341" y1="1909.8301" y2="1909.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1905.0879">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="411" y="1905.0879">Return success</text><path d="M298,1931.8301 L360,1931.8301 L360,1938.8301 L350,1948.8301 L298,1948.8301 L298,1931.8301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="769.8242" style="stroke: #000000; stroke-width: 2.0;" width="1356" x="298" y="1931.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="313" y="1945.3984">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="375" y="1944.4648">[Transfer.ilpCondition validate successful]</text><path d="M308,1956.1406 L764,1956.1406 L764,1963.1406 L754,1973.1406 L308,1973.1406 L308,1956.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1336" x="308" y="1956.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="323" y="1969.709">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1325,2006.0723,1335,2010.0723,1325,2014.0723,1329,2010.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1331" y1="2010.0723" y2="2010.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="1997.6748">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="401" y="1990.0195">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="401" y="2005.3301">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="478" y="2005.3301">2003</text><polygon fill="#A80036" points="1542,2035.3828,1552,2039.3828,1542,2043.3828,1546,2039.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1347" x2="1548" y1="2039.3828" y2="2039.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1354" y="2034.6406">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1376" y="2034.6406">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f13iwocc3tpasp)" points="1493,2082.3828,1624,2082.3828,1634,2093.3828,1624,2105.3828,1493,2105.3828,1483,2093.3828,1493,2082.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1495" y="2098.9512">transferStateChange</text><polygon fill="#A80036" points="383,2128.0039,373,2132.0039,383,2136.0039,379,2132.0039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377" x2="1341" y1="2132.0039" y2="2132.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2127.2617">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="411" y="2127.2617">Return success</text><path d="M377,2152.0039 L377,2529.0039 L637,2529.0039 L637,2162.0039 L627,2152.0039 L377,2152.0039 " fill="#FFFF00" filter="url(#f13iwocc3tpasp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M627,2152.0039 L627,2162.0039 L637,2162.0039 L627,2152.0039 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="383" y="2169.5723">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="383" y="2184.8828">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="399" y="2200.1934">id: &lt;messageId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="399" y="2215.5039">from: &lt;payeeFspName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="399" y="2230.8145">to: &lt;payerFspName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="399" y="2246.125">type: "application/json",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="399" y="2261.4355">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="415" y="2276.7461">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="415" y="2292.0566">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="399" y="2307.3672">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="399" y="2322.6777">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="415" y="2337.9883">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="431" y="2353.2988">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="431" y="2368.6094">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="431" y="2383.9199">type: "position",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="431" y="2399.2305">action: "bulk-commit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="431" y="2414.541">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="431" y="2429.8516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="447" y="2445.1621">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="447" y="2460.4727">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="431" y="2475.7832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="415" y="2491.0938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="399" y="2506.4043">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="383" y="2521.7148">}</text><polygon fill="#A80036" points="868,2555.7676,878,2559.7676,868,2563.7676,872,2559.7676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="874" y1="2559.7676" y2="2559.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="2555.0254">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="401" y="2555.0254">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="298" x2="1654" y1="2598.7676" y2="2598.7676"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="303" y="2609.4023">[Validate Fulfil Transfer not successful]</text><path d="M308,2619.7227 L392,2619.7227 L392,2626.7227 L382,2636.7227 L308,2636.7227 L308,2619.7227 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="382" x="308" y="2619.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="323" y="2633.291">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="414" y1="2673.6543" y2="2673.6543"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414" x2="414" y1="2673.6543" y2="2686.6543"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373" x2="414" y1="2686.6543" y2="2686.6543"/><polygon fill="#A80036" points="383,2682.6543,373,2686.6543,383,2690.6543,379,2686.6543" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="2661.2568">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="401" y="2653.6016">Route &amp; Publish Notification event for Payee</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="401" y="2668.9121">Reference: Failure in validation</text><path d="M308,2729.6543 L562,2729.6543 L562,2736.6543 L552,2746.6543 L308,2746.6543 L308,2729.6543 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="483.3848" style="stroke: #000000; stroke-width: 2.0;" width="876" x="308" y="2729.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="323" y="2743.2227">Reference: Failure in validation</text><path d="M377,2751.9648 L377,3128.9648 L637,3128.9648 L637,2761.9648 L627,2751.9648 L377,2751.9648 " fill="#FFFF00" filter="url(#f13iwocc3tpasp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M627,2751.9648 L627,2761.9648 L637,2761.9648 L627,2751.9648 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="383" y="2769.5332">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="383" y="2784.8438">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="399" y="2800.1543">id: &lt;messageId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="399" y="2815.4648">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="399" y="2830.7754">to: &lt;payeeFspName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="399" y="2846.0859">type: "application/json",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="399" y="2861.3965">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="415" y="2876.707">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="415" y="2892.0176">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="399" y="2907.3281">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="399" y="2922.6387">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="415" y="2937.9492">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="431" y="2953.2598">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="431" y="2968.5703">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="431" y="2983.8809">type: "bulk-processing",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="431" y="2999.1914">action: "bulk-commit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="431" y="3014.502">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="431" y="3029.8125">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="447" y="3045.123">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="447" y="3060.4336">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="431" y="3075.7441">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="415" y="3091.0547">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="399" y="3106.3652">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="383" y="3121.6758">}</text><polygon fill="#A80036" points="1089.5,3171.0391,1099.5,3175.0391,1089.5,3179.0391,1093.5,3175.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372" x2="1095.5" y1="3175.0391" y2="3175.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="379" y="3162.6416">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="401" y="3154.9863">Publish Notification event for Payee to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="401" y="3170.2969">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="485" y="3170.2969">2003</text><!--
@startuml
title 2.2.1. Fulfil Handler Consume (Success) individual transfers from Bulk

autonumber

collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Handler" as FULF_HANDLER
collections "topic-\nevent" as TOPIC_EVENT
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_BULK_PROCESSING
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
    activate TOPIC_FULFIL
    deactivate TOPIC_FULFIL
    break
        group Validate Event
            FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'bulk-commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end
    group Persist Event Information
        FULF_HANDLER -> TOPIC_EVENT: Publish event information
        ref over FULF_HANDLER, TOPIC_EVENT: Event Handler Consume\n
    end
    group Validate FSPIOP-Signature
        |||
        ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature**\n<color #FF0000><b>Error codes:</b> 3105/3106</color>\n
        |||
    end

    group Validate Duplicate Check
        |||
        FULF_HANDLER -> DB: Request Duplicate Check
        ref over FULF_HANDLER, DB:  Request Duplicate Check\n
        DB - -> FULF_HANDLER: Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }
    end

    alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
        break
            FULF_HANDLER -> FULF_HANDLER: stateRecord = await getTransferState(transferId)
            alt endStateList.includes(stateRecord.transferStateId)
                |||
                ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                FULF_HANDLER -> TOPIC_NOTIFICATIONS: Produce message
            else
                note right of FULF_HANDLER #lightgrey
                    Ignore - resend in progress
                end note
            end
        end
    else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
        note right of FULF_HANDLER #lightgrey
            Validate Prepare Transfer (failure) - Modified Request
        end note
    else hasDuplicateId == FALSE

    end

    group Validate and persist Transfer Fulfilment
        FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Fetch from database
        activate DB
        hnote over DB #lightyellow
            transfer
        end note
        DB - -> POS_DAO
        deactivate DB
        FULF_HANDLER <- - POS_DAO: Return transfer
        deactivate POS_DAO
        FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
        FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

        opt Transfer.ilpCondition validate successful
            group Request current Settlement Window
                FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Fetch settlementWindowId
                activate DB
                hnote over DB #lightyellow
                    settlementWindow
                end note
                DB - -> POS_DAO
                deactivate DB
                FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                deactivate POS_DAO
            end
        end

        group Persist fulfilment
            FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Persist to database
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferFulfilment
                transferExtension
            end note
            FULF_HANDLER <- - POS_DAO: Return success
            deactivate POS_DAO
        end

        alt Transfer.ilpCondition validate successful
            group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer state
                activate DB
                hnote over DB #lightyellow
                    transferStateChange
                end note
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return success
                deactivate POS_DAO
            end

            note right of FULF_HANDLER #yellow
                Message:
                {
                    id: <messageId>,
                    from: <payeeFspName>,
                    to: <payerFspName>,
                    type: "application/json",
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: "position",
                            action: "bulk-commit",
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0
                            }
                        }
                    }
                }
            end note
            FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
            activate TOPIC_TRANSFER_POSITION
            deactivate TOPIC_TRANSFER_POSITION
        else Validate Fulfil Transfer not successful
            break
                FULF_HANDLER -> FULF_HANDLER: Route & Publish Notification event for Payee\n<color Magenta><b>Reference: Failure in validation</b></color>
            end
        end
    end
end

group Reference: Failure in validation
    note right of FULF_HANDLER #yellow
    Message:
    {
        id: <messageId>,
        from: <ledgerName>,
        to: <payeeFspName>,
        type: "application/json",
        content: {
            headers: <transferHeaders>,
            payload: <transferMessage>
        },
        metadata: {
            event: {
                id: <uuid>,
                responseTo: <previous.uuid>,
                type: "bulk-processing",
                action: "bulk-commit",
                createdAt: <timestamp>,
                state: {
                    status: "error",
                    code: 1
                }
            }
        }
    }
    end note
    FULF_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event for Payee to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
    activate TOPIC_BULK_PROCESSING
    deactivate TOPIC_BULK_PROCESSING
end

deactivate FULF_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>