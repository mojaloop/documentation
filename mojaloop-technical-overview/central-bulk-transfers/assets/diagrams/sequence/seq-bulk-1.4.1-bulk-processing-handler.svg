<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4436px" preserveAspectRatio="none" style="width:1389px;height:4436px;" version="1.1" viewBox="0 0 1389 4436" width="1389px" zoomAndPan="magnify"><defs><filter height="300%" id="fox6uhtzdocm5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="289" x="551" y="23.5352">1.4.0. Bulk Processing Handler Consume</text><rect fill="#FFFFE0" height="4391.1641" style="stroke: #A80036; stroke-width: 1.0;" width="1290.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="613.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="4218.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="3707.4043"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="825.5" y="3405.3438"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="825.5" y="4227.4102"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="611.0547"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="152.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2187.9297"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2369.793"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2660.543"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="3486.6094"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="640.3652"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2247.8613"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2399.1035"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2689.8535"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="3515.9199"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="4204.9004" style="stroke: #000000; stroke-width: 2.0;" width="1365" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="167.4844" style="stroke: #000000; stroke-width: 2.0;" width="434.5" x="157.5" y="219.3965"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="136.1738" style="stroke: #000000; stroke-width: 2.0;" width="414.5" x="167.5" y="243.707"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="475" x="167.5" y="400.8809"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="3761.2422" style="stroke: #000000; stroke-width: 2.0;" width="1220.5" x="147.5" y="572.4336"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="1372.7012" style="stroke: #000000; stroke-width: 2.0;" width="522" x="214" y="762.6074"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="1179.5957" style="stroke: #000000; stroke-width: 2.0;" width="502" x="224" y="948.7129"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="319.6152" style="stroke: #000000; stroke-width: 2.0;" width="407" x="234" y="1042.9551"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="407" x="234" y="1099.5762"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="407" x="234" y="1153.8418"/><rect fill="#FFFFFF" height="84.8867" style="stroke: none; stroke-width: 1.0;" width="407" x="234" y="1208.1074"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="407" x="234" y="1292.9941"/><rect fill="#FFFFFF" height="201.084" style="stroke: none; stroke-width: 1.0;" width="502" x="224" y="1369.5703"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="172.1289" style="stroke: #000000; stroke-width: 2.0;" width="413" x="234" y="1391.5254"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="413" x="234" y="1494.0781"/><rect fill="#FFFFFF" height="472.7676" style="stroke: none; stroke-width: 1.0;" width="502" x="224" y="1570.6543"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="373.8809" style="stroke: #000000; stroke-width: 2.0;" width="425" x="234" y="1662.541"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="425" x="234" y="1719.1621"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="425" x="234" y="1773.4277"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="425" x="234" y="1827.6934"/><rect fill="#FFFFFF" height="84.8867" style="stroke: none; stroke-width: 1.0;" width="425" x="234" y="1881.959"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="425" x="234" y="1966.8457"/><rect fill="#FFFFFF" height="84.8867" style="stroke: none; stroke-width: 1.0;" width="502" x="224" y="2043.4219"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="641.166" style="stroke: #000000; stroke-width: 2.0;" width="1190.5" x="167.5" y="2149.3086"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="126.1973" style="stroke: #000000; stroke-width: 2.0;" width="302" x="234" y="2506.0352"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="302" x="234" y="2562.6563"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="1522.2012" style="stroke: #000000; stroke-width: 2.0;" width="1200.5" x="157.5" y="2804.4746"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="614.5586" style="stroke: #000000; stroke-width: 2.0;" width="744" x="167.5" y="2828.7852"/><rect fill="#FFFFFF" height="822.0664" style="stroke: none; stroke-width: 1.0;" width="1200.5" x="157.5" y="3450.3438"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="611.9375" style="stroke: #000000; stroke-width: 2.0;" width="744" x="167.5" y="3653.4727"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1200.5" x="157.5" y="4272.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="74" x2="74" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="233.5" x2="233.5" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="581.5" x2="581.5" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="695.5" x2="695.5" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="830.5" x2="830.5" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="946.5" x2="946.5" y1="118.7754" y2="4357.6758"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1257.5" x2="1257.5" y1="118.7754" y2="4357.6758"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="62.7988"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="87.334">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="103.8223">processing</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="27" y="4356.6758"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="23" y="4360.6758"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="30" y="4381.2109">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="32.5" y="4397.6992">processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="99.334">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="115.8223">Handler</text><ellipse cx="234" cy="69.7988" fill="#FEFECE" filter="url(#fox6uhtzdocm5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,57.7988,236,52.7988,234,57.7988,236,62.7988,230,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="177.5" y="4370.2109">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="204" y="4386.6992">Handler</text><ellipse cx="234" cy="4405.6523" fill="#FEFECE" filter="url(#fox6uhtzdocm5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="230,4393.6523,236,4388.6523,234,4393.6523,236,4398.6523,230,4393.6523" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="535.5" y="79.2871"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="531.5" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="538.5" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="535.5" y="4356.6758"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="531.5" y="4360.6758"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="538.5" y="4381.2109">topic-event</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="646.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="642.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="663.5" y="87.334">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="649.5" y="103.8223">object-store</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="646.5" y="4356.6758"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="642.5" y="4360.6758"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="663.5" y="4381.2109">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="649.5" y="4397.6992">object-store</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="763.5" y="79.2871"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="759.5" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="766.5" y="103.8223">topic-notification</text><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="763.5" y="4356.6758"/><rect fill="#FEFECE" filter="url(#fox6uhtzdocm5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="759.5" y="4360.6758"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="766.5" y="4381.2109">topic-notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="911.5" y="115.8223">Bulk DAO</text><ellipse cx="946.5" cy="86.2871" fill="#FEFECE" filter="url(#fox6uhtzdocm5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="934.5" x2="958.5" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="911.5" y="4370.2109">Bulk DAO</text><ellipse cx="946.5" cy="4389.1641" fill="#FEFECE" filter="url(#fox6uhtzdocm5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="934.5" x2="958.5" y1="4403.1641" y2="4403.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1209.5" y="115.8223">Central Store</text><path d="M1239.5,66.2871 C1239.5,56.2871 1257.5,56.2871 1257.5,56.2871 C1257.5,56.2871 1275.5,56.2871 1275.5,66.2871 L1275.5,92.2871 C1275.5,102.2871 1257.5,102.2871 1257.5,102.2871 C1257.5,102.2871 1239.5,102.2871 1239.5,92.2871 L1239.5,66.2871 " fill="#FEFECE" filter="url(#fox6uhtzdocm5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1239.5,66.2871 C1239.5,76.2871 1257.5,76.2871 1257.5,76.2871 C1257.5,76.2871 1275.5,76.2871 1275.5,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1209.5" y="4370.2109">Central Store</text><path d="M1239.5,4383.1641 C1239.5,4373.1641 1257.5,4373.1641 1257.5,4373.1641 C1257.5,4373.1641 1275.5,4373.1641 1275.5,4383.1641 L1275.5,4409.1641 C1275.5,4419.1641 1257.5,4419.1641 1257.5,4419.1641 C1257.5,4419.1641 1239.5,4419.1641 1239.5,4409.1641 L1239.5,4383.1641 " fill="#FEFECE" filter="url(#fox6uhtzdocm5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1239.5,4383.1641 C1239.5,4393.1641 1257.5,4393.1641 1257.5,4393.1641 C1257.5,4393.1641 1275.5,4393.1641 1275.5,4383.1641 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69" y="174.3965"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="4218.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="229" y="128.7754"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="3707.4043"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="825.5" y="3405.3438"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="825.5" y="4227.4102"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="611.0547"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="152.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2187.9297"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2369.793"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2660.543"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="3486.6094"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="640.3652"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2247.8613"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2399.1035"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="2689.8535"/><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252.5" y="3515.9199"/><path d="M13,135.7754 L289,135.7754 L289,142.7754 L279,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4204.9004" style="stroke: #000000; stroke-width: 2.0;" width="1365" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="28" y="149.3438">Bulk Processing Handler Consume</text><polygon fill="#A80036" points="90,170.3965,80,174.3965,90,178.3965,86,174.3965" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="84" x2="228" y1="174.3965" y2="174.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="96" y="169.6543">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="109" y="169.6543">Consume message</text><path d="M157.5,219.3965 L241.5,219.3965 L241.5,226.3965 L231.5,236.3965 L157.5,236.3965 L157.5,219.3965 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.4844" style="stroke: #000000; stroke-width: 2.0;" width="434.5" x="157.5" y="219.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="172.5" y="232.9648">break</text><path d="M167.5,243.707 L309.5,243.707 L309.5,250.707 L299.5,260.707 L167.5,260.707 L167.5,243.707 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="136.1738" style="stroke: #000000; stroke-width: 2.0;" width="414.5" x="167.5" y="243.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="182.5" y="257.2754">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="358.8809" y2="358.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="358.8809" y2="371.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="371.8809" y2="371.8809"/><polygon fill="#A80036" points="250,367.8809,240,371.8809,250,375.8809,246,371.8809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="315.8623">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="259" y="277.5859">Validate event - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="259" y="292.8965">type == 'bulk-processing' &amp;&amp; action IN</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="259" y="308.207">['prepare-duplicate', 'prepare', 'timeout-received',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="259" y="323.5176">'fulfil-duplicate', 'commit', 'reject', 'abort',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="259" y="338.8281">'timeout-reserved']</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="259" y="354.1387">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="343" y="354.1387">2001</text><path d="M167.5,400.8809 L382.5,400.8809 L382.5,407.8809 L372.5,417.8809 L167.5,417.8809 L167.5,400.8809 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="475" x="167.5" y="400.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="182.5" y="414.4492">Persist Event Information</text><polygon fill="#A80036" points="570,460.502,580,464.502,570,468.502,574,464.502" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="576" y1="464.502" y2="464.502"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="459.7598">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="259" y="459.7598">Publish event information</text><rect fill="#FFFFFF" filter="url(#fox6uhtzdocm5)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="457" x="174.5" y="472.502"/><polygon fill="#EEEEEE" points="174.5,472.502,238.5,472.502,238.5,479.502,228.5,489.502,174.5,489.502,174.5,472.502" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="187.5" y="487.0703">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="330" y="506.0703">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="334" y="521.3809"/><path d="M147.5,572.4336 L306.5,572.4336 L306.5,579.4336 L296.5,589.4336 L147.5,589.4336 L147.5,572.4336 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3761.2422" style="stroke: #000000; stroke-width: 2.0;" width="1220.5" x="147.5" y="572.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="162.5" y="586.002">Process Message</text><polygon fill="#A80036" points="929.5,607.0547,939.5,611.0547,929.5,615.0547,933.5,611.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="935.5" y1="611.0547" y2="611.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="606.3125">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="259" y="606.3125">Retrieve current state of Bulk Transfer</text><polygon fill="#A80036" points="1240.5,636.3652,1250.5,640.3652,1240.5,644.3652,1244.5,640.3652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1246.5" y1="640.3652" y2="640.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="958.5" y="635.623">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="971.5" y="635.623">Retrieve current state of Bulk Transfer</text><polygon fill="#FFFFE0" filter="url(#fox6uhtzdocm5)" points="1176,653.3652,1338,653.3652,1348,672.3652,1338,691.3652,1176,691.3652,1166,672.3652,1176,653.3652" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1178" y="669.9336">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1178" y="685.2441">bulkTransferStateChange</text><polygon fill="#A80036" points="962.5,714.2969,952.5,718.2969,962.5,722.2969,958.5,718.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1256.5" y1="718.2969" y2="718.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="968.5" y="713.5547">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="981.5" y="713.5547">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="1026.5" y="713.5547">bulkTransferInfo</text><polygon fill="#A80036" points="250,743.6074,240,747.6074,250,751.6074,246,747.6074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="945.5" y1="747.6074" y2="747.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="256" y="742.8652">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="269" y="742.8652">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="314" y="742.8652">bulkTransferInfo</text><path d="M214,762.6074 L446,762.6074 L446,769.6074 L436,779.6074 L214,779.6074 L214,762.6074 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1372.7012" style="stroke: #000000; stroke-width: 2.0;" width="522" x="214" y="762.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="229" y="776.1758">Validate Bulk Transfer State</text><path d="M244,784.918 L244,931.918 L459,931.918 L459,794.918 L449,784.918 L244,784.918 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M449,784.918 L449,794.918 L459,794.918 L449,784.918 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="250" y="802.4863">Initialize variables</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="374" y="802.4863">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="250" y="817.7969">let criteriaState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="250" y="833.1074">let incompleteBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="250" y="848.418">let completedBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="250" y="863.7285">let bulkTransferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="250" y="879.0391">let processingState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="250" y="894.3496">let</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="270" y="894.3496">exitCode = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="356" y="894.3496">(success)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="250" y="909.6602">let errorMessage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="250" y="924.9707">let produceNotification = false</text><path d="M224,948.7129 L286,948.7129 L286,955.7129 L276,965.7129 L224,965.7129 L224,948.7129 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1179.5957" style="stroke: #000000; stroke-width: 2.0;" width="502" x="224" y="948.7129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="239" y="962.2813">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="420" x="301" y="961.3477">[bulkTransferInfo.bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE']]</text><path d="M244,971.0234 L244,1026.0234 L534,1026.0234 L534,981.0234 L524,971.0234 L244,971.0234 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M524,971.0234 L524,981.0234 L534,981.0234 L524,971.0234 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="250" y="988.5918">criteriaState = 'RECEIVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="250" y="1003.9023">incompleteBulkState = 'PENDING_PREPARE'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="250" y="1019.2129">completedBulkState = 'ACCEPTED'</text><path d="M234,1042.9551 L296,1042.9551 L296,1049.9551 L286,1059.9551 L234,1059.9551 L234,1042.9551 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="319.6152" style="stroke: #000000; stroke-width: 2.0;" width="407" x="234" y="1042.9551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="249" y="1056.5234">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="311" y="1055.5898">[action == 'prepare-duplicate']</text><path d="M244,1065.2656 L244,1090.2656 L526,1090.2656 L526,1075.2656 L516,1065.2656 L244,1065.2656 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M516,1065.2656 L516,1075.2656 L526,1075.2656 L516,1065.2656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="250" y="1082.834">processingState = 'RECEIVED_DUPLICATE'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="641" y1="1100.5762" y2="1100.5762"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="271" x="239" y="1111.2109">[action == 'prepare' AND state.status == 'error']</text><path d="M244,1119.5313 L244,1144.5313 L508,1144.5313 L508,1129.5313 L498,1119.5313 L244,1119.5313 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M498,1119.5313 L498,1129.5313 L508,1129.5313 L498,1119.5313 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="250" y="1137.0996">processingState = 'RECEIVED_INVALID'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="641" y1="1154.8418" y2="1154.8418"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="239" y="1165.4766">[action == 'prepare' AND state.status == 'success']</text><path d="M244,1173.7969 L244,1198.7969 L455,1198.7969 L455,1183.7969 L445,1173.7969 L244,1173.7969 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M445,1173.7969 L445,1183.7969 L455,1183.7969 L445,1173.7969 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="250" y="1191.3652">processingState = 'ACCEPTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="641" y1="1209.1074" y2="1209.1074"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="239" y="1219.7422">[action IN ['timeout-received', 'timeout-reserved']]</text><path d="M244,1228.0625 L244,1283.0625 L489,1283.0625 L489,1238.0625 L479,1228.0625 L244,1228.0625 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M479,1228.0625 L479,1238.0625 L489,1238.0625 L479,1228.0625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1245.6309">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="250" y="1260.9414">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="250" y="1276.252">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="641" y1="1293.9941" y2="1293.9941"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="239" y="1304.6289">[all other actions]</text><path d="M244,1312.9492 L244,1352.9492 L627,1352.9492 L627,1322.9492 L617,1312.9492 L244,1312.9492 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M617,1312.9492 L617,1322.9492 L627,1322.9492 L617,1312.9492 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="250" y="1330.5176">exitCode = 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="250" y="1345.8281">errorMessage = 'Invalid action for bulk in RECEIVED state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="224" x2="726" y1="1370.5703" y2="1370.5703"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="229" y="1381.2051">[bulkTransferInfo.bulkTransferState IN ['ACCEPTED']]</text><path d="M234,1391.5254 L296,1391.5254 L296,1398.5254 L286,1408.5254 L234,1408.5254 L234,1391.5254 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="172.1289" style="stroke: #000000; stroke-width: 2.0;" width="413" x="234" y="1391.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="249" y="1405.0938">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="311" y="1404.1602">[action == 'timeout-reserved']</text><path d="M244,1413.8359 L244,1484.8359 L489,1484.8359 L489,1423.8359 L479,1413.8359 L244,1413.8359 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M479,1413.8359 L479,1423.8359 L489,1423.8359 L479,1413.8359 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="250" y="1431.4043">criteriaState = 'ACCEPTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1446.7148">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="250" y="1462.0254">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="250" y="1477.3359">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="647" y1="1495.0781" y2="1495.0781"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="239" y="1505.7129">[all other actions]</text><path d="M244,1514.0332 L244,1554.0332 L633,1554.0332 L633,1524.0332 L623,1514.0332 L244,1514.0332 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M623,1514.0332 L623,1524.0332 L633,1524.0332 L623,1514.0332 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="250" y="1531.6016">exitCode = 3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="250" y="1546.9121">errorMessage = 'Invalid action for bulk in ACCEPTED state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="224" x2="726" y1="1571.6543" y2="1571.6543"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="417" x="229" y="1582.2891">[bulkTransferInfo.bulkTransferState IN ['PROCESSING', 'PENDING_FULFIL']]</text><path d="M244,1590.6094 L244,1645.6094 L522,1645.6094 L522,1600.6094 L512,1590.6094 L244,1590.6094 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,1590.6094 L512,1600.6094 L522,1600.6094 L512,1590.6094 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="250" y="1608.1777">criteriaState = 'ACCEPTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="250" y="1623.4883">incompleteBulkState = 'PENDING_FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="250" y="1638.7988">completedBulkState = 'COMPLETED'</text><path d="M234,1662.541 L296,1662.541 L296,1669.541 L286,1679.541 L234,1679.541 L234,1662.541 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="373.8809" style="stroke: #000000; stroke-width: 2.0;" width="425" x="234" y="1662.541"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="249" y="1676.1094">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="161" x="311" y="1675.1758">[action == 'fulfil-duplicate']</text><path d="M244,1684.8516 L244,1709.8516 L507,1709.8516 L507,1694.8516 L497,1684.8516 L244,1684.8516 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M497,1684.8516 L497,1694.8516 L507,1694.8516 L497,1684.8516 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="250" y="1702.4199">processingState = 'FULFIL_DUPLICATE'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="659" y1="1720.1621" y2="1720.1621"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="239" y="1730.7969">[action == 'commit' AND state.status == 'success']</text><path d="M244,1739.1172 L244,1764.1172 L465,1764.1172 L465,1749.1172 L455,1739.1172 L244,1739.1172 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M455,1739.1172 L455,1749.1172 L465,1749.1172 L455,1739.1172 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="250" y="1756.6855">processingState = 'COMPLETED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="659" y1="1774.4277" y2="1774.4277"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="275" x="239" y="1785.0625">[action == 'reject' AND state.status == 'success']</text><path d="M244,1793.3828 L244,1818.3828 L449,1818.3828 L449,1803.3828 L439,1793.3828 L244,1793.3828 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M439,1793.3828 L439,1803.3828 L449,1803.3828 L439,1793.3828 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="250" y="1810.9512">processingState = 'REJECTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="659" y1="1828.6934" y2="1828.6934"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="316" x="239" y="1839.3281">[action IN ['commit', 'abort'] AND state.status == 'error']</text><path d="M244,1847.6484 L244,1872.6484 L489,1872.6484 L489,1857.6484 L479,1847.6484 L244,1847.6484 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M479,1847.6484 L479,1857.6484 L489,1857.6484 L479,1847.6484 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="250" y="1865.2168">processingState = 'FULFIL_INVALID'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="659" y1="1882.959" y2="1882.959"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="239" y="1893.5938">[action == 'timeout-reserved']</text><path d="M244,1901.9141 L244,1956.9141 L489,1956.9141 L489,1911.9141 L479,1901.9141 L244,1901.9141 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M479,1901.9141 L479,1911.9141 L489,1911.9141 L479,1901.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="250" y="1919.4824">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="250" y="1934.793">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="250" y="1950.1035">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="659" y1="1967.8457" y2="1967.8457"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="239" y="1978.4805">[all other actions]</text><path d="M244,1986.8008 L244,2026.8008 L645,2026.8008 L645,1996.8008 L635,1986.8008 L244,1986.8008 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M635,1986.8008 L635,1996.8008 L645,1996.8008 L635,1986.8008 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="250" y="2004.3691">exitCode = 4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="250" y="2019.6797">errorMessage = 'Invalid action for bulk in PROCESSING state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="224" x2="726" y1="2044.4219" y2="2044.4219"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="393" x="229" y="2055.0566">[all other ['PENDING_INVALID', 'COMPLETED', 'REJECTED', 'INVALID']]</text><path d="M244,2063.377 L244,2118.377 L555,2118.377 L555,2073.377 L545,2063.377 L244,2063.377 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M545,2063.377 L545,2073.377 L555,2073.377 L545,2063.377 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="250" y="2080.9453">exitCode = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="250" y="2096.2559">errorMessage = 'Individual transfer can not be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="266" y="2111.5664">processed when bulk transfer state is final'</text><path d="M167.5,2149.3086 L234.5,2149.3086 L234.5,2156.3086 L224.5,2166.3086 L167.5,2166.3086 L167.5,2149.3086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="641.166" style="stroke: #000000; stroke-width: 2.0;" width="1190.5" x="167.5" y="2149.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="182.5" y="2162.877">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="249.5" y="2161.9434">[exitCode == 0 (success)]</text><polygon fill="#A80036" points="929.5,2183.9297,939.5,2187.9297,929.5,2191.9297,933.5,2187.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="935.5" y1="2187.9297" y2="2187.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="246" y="2183.1875">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="259" y="2183.1875">Persist individual transfer processing state</text><polygon fill="#A80036" points="1240.5,2243.8613,1250.5,2247.8613,1240.5,2251.8613,1244.5,2247.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1246.5" y1="2247.8613" y2="2247.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="958.5" y="2227.8086">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="971.5" y="2212.498">Persist individual transfer processing state</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="971.5" y="2227.8086">-- store errorCode/errorMessage when</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="971.5" y="2243.1191">state.status == 'error'</text><polygon fill="#FFFFE0" filter="url(#fox6uhtzdocm5)" points="1178,2290.8613,1336,2290.8613,1346,2301.8613,1336,2313.8613,1178,2313.8613,1168,2301.8613,1178,2290.8613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1180" y="2307.4297">bulkTransferAssociation</text><polygon fill="#A80036" points="250,2336.4824,240,2340.4824,250,2344.4824,246,2340.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="945.5" y1="2340.4824" y2="2340.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="2335.7402">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="278" y="2335.7402">Return success</text><polygon fill="#A80036" points="929.5,2365.793,939.5,2369.793,929.5,2373.793,933.5,2369.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="935.5" y1="2369.793" y2="2369.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="2365.0508">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="268" y="2365.0508">Check previously defined completion criteria</text><polygon fill="#A80036" points="1240.5,2395.1035,1250.5,2399.1035,1240.5,2403.1035,1244.5,2399.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1246.5" y1="2399.1035" y2="2399.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="2394.3613">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="980.5" y="2394.3613">Select EXISTS (LIMIT 1) in criteriaState</text><polygon fill="#FFFFE0" filter="url(#fox6uhtzdocm5)" points="1178,2412.1035,1336,2412.1035,1346,2423.1035,1336,2435.1035,1178,2435.1035,1168,2423.1035,1178,2412.1035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1180" y="2428.6719">bulkTransferAssociation</text><polygon fill="#A80036" points="962.5,2457.7246,952.5,2461.7246,962.5,2465.7246,958.5,2461.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1256.5" y1="2461.7246" y2="2461.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="968.5" y="2456.9824">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="990.5" y="2456.9824">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="1035.5" y="2456.9824">existingIndividualTransfer</text><polygon fill="#A80036" points="250,2487.0352,240,2491.0352,250,2495.0352,246,2491.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="945.5" y1="2491.0352" y2="2491.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="2486.293">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="2486.293">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="323" y="2486.293">existingIndividualTransfer</text><path d="M234,2506.0352 L296,2506.0352 L296,2513.0352 L286,2523.0352 L234,2523.0352 L234,2506.0352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.1973" style="stroke: #000000; stroke-width: 2.0;" width="302" x="234" y="2506.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="249" y="2519.6035">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="311" y="2518.6699">[individual transfer exists]</text><path d="M244,2528.3457 L244,2553.3457 L522,2553.3457 L522,2538.3457 L512,2528.3457 L244,2528.3457 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,2528.3457 L512,2538.3457 L522,2538.3457 L512,2528.3457 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="250" y="2545.9141">bulkTransferState = incompleteBulkState</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="234" x2="536" y1="2563.6563" y2="2563.6563"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="191" x="239" y="2574.291">[no transfer in criteriaState exists]</text><path d="M244,2582.6113 L244,2622.6113 L518,2622.6113 L518,2592.6113 L508,2582.6113 L244,2582.6113 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M508,2582.6113 L508,2592.6113 L518,2592.6113 L508,2582.6113 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="250" y="2600.1797">bulkTransferState = completedBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="250" y="2615.4902">produceNotification = true</text><polygon fill="#A80036" points="929.5,2656.543,939.5,2660.543,929.5,2664.543,933.5,2660.543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="935.5" y1="2660.543" y2="2660.543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="2655.8008">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="268" y="2655.8008">Persist bulkTransferState from previous step</text><polygon fill="#A80036" points="1240.5,2685.8535,1250.5,2689.8535,1240.5,2693.8535,1244.5,2689.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1246.5" y1="2689.8535" y2="2689.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="2685.1113">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="980.5" y="2685.1113">Persist bulkTransferState</text><polygon fill="#FFFFE0" filter="url(#fox6uhtzdocm5)" points="1176,2732.8535,1338,2732.8535,1348,2743.8535,1338,2755.8535,1176,2755.8535,1166,2743.8535,1176,2732.8535" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1178" y="2749.4219">bulkTransferStateChange</text><polygon fill="#A80036" points="250,2778.4746,240,2782.4746,250,2786.4746,246,2782.4746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="945.5" y1="2782.4746" y2="2782.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="2777.7324">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="278" y="2777.7324">Return success</text><path d="M157.5,2804.4746 L219.5,2804.4746 L219.5,2811.4746 L209.5,2821.4746 L157.5,2821.4746 L157.5,2804.4746 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1522.2012" style="stroke: #000000; stroke-width: 2.0;" width="1200.5" x="157.5" y="2804.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="172.5" y="2818.043">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="234.5" y="2817.1094">[exitCode &gt; 0]</text><path d="M167.5,2828.7852 L397.5,2828.7852 L397.5,2835.7852 L387.5,2845.7852 L167.5,2845.7852 L167.5,2828.7852 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="614.5586" style="stroke: #000000; stroke-width: 2.0;" width="744" x="167.5" y="2828.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="185" x="182.5" y="2842.3535">Send Bulk Error Notification</text><path d="M244,2851.0957 L244,3305.0957 L551,3305.0957 L551,2861.0957 L541,2851.0957 L244,2851.0957 " fill="#FFFF00" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M541,2851.0957 L541,2861.0957 L551,2861.0957 L541,2851.0957 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="250" y="2868.6641">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="2883.9746">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="266" y="2899.2852">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="266" y="2914.5957">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="266" y="2929.9063">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="266" y="2945.2168">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="266" y="2960.5273">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="282" y="2975.8379">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="282" y="2991.1484">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="298" y="3006.459">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="314" y="3021.7695">errorCode: exitCode,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="314" y="3037.0801">errorMessage: errorMessage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="298" y="3052.3906">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="282" y="3067.7012">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="266" y="3083.0117">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="266" y="3098.3223">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="282" y="3113.6328">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="298" y="3128.9434">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="298" y="3144.2539">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="298" y="3159.5645">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="298" y="3174.875">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="298" y="3190.1855">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="298" y="3205.4961">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="314" y="3220.8066">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="314" y="3236.1172">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="298" y="3251.4277">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="282" y="3266.7383">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="266" y="3282.0488">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="3297.3594">}</text><path d="M244,3319.1016 L244,3359.1016 L523,3359.1016 L523,3329.1016 L513,3319.1016 L244,3319.1016 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M513,3319.1016 L513,3329.1016 L523,3329.1016 L513,3319.1016 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="250" y="3336.6699">Depending on the action decide where to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="250" y="3351.9805">send notification: payer, payee OR both</text><polygon fill="#A80036" points="813.5,3401.3438,823.5,3405.3438,813.5,3409.3438,817.5,3405.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="819.5" y1="3405.3438" y2="3405.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="3392.9463">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="268" y="3385.291">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="268" y="3400.6016">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="352" y="3400.6016">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157.5" x2="1358" y1="3451.3438" y2="3451.3438"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="162.5" y="3461.9785">[produceNotification == true]</text><polygon fill="#A80036" points="929.5,3482.6094,939.5,3486.6094,929.5,3490.6094,933.5,3486.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="935.5" y1="3486.6094" y2="3486.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="3481.8672">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="268" y="3481.8672">Request to retrieve all bulk transfer and individual transfer results</text><polygon fill="#A80036" points="1240.5,3511.9199,1250.5,3515.9199,1240.5,3519.9199,1244.5,3515.9199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1246.5" y1="3515.9199" y2="3515.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="3511.1777">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="980.5" y="3511.1777">Get bulkTransferResult</text><polygon fill="#FFFFE0" filter="url(#fox6uhtzdocm5)" points="1176,3528.9199,1338,3528.9199,1348,3554.9199,1338,3581.9199,1176,3581.9199,1166,3554.9199,1176,3528.9199" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1178" y="3545.4883">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="1178" y="3560.7988">bulkTransferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1178" y="3576.1094">bulkTransferAssociation</text><polygon fill="#A80036" points="962.5,3605.1621,952.5,3609.1621,962.5,3613.1621,958.5,3609.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1256.5" y1="3609.1621" y2="3609.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="968.5" y="3604.4199">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="990.5" y="3604.4199">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="1035.5" y="3604.4199">bulkTransferResult</text><polygon fill="#A80036" points="250,3634.4727,240,3638.4727,250,3642.4727,246,3638.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="945.5" y1="3638.4727" y2="3638.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="3633.7305">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="278" y="3633.7305">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="323" y="3633.7305">bulkTransferResult</text><path d="M167.5,3653.4727 L359.5,3653.4727 L359.5,3660.4727 L349.5,3670.4727 L167.5,3670.4727 L167.5,3653.4727 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="611.9375" style="stroke: #000000; stroke-width: 2.0;" width="744" x="167.5" y="3653.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="182.5" y="3667.041">Send Bulk Notification</text><polygon fill="#A80036" points="679,3703.4043,689,3707.4043,679,3711.4043,683,3707.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="685" y1="3707.4043" y2="3707.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="3695.0068">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="268" y="3687.3516">Generate &amp; Persist bulk message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="268" y="3702.6621">to object store</text><polygon fill="#A80036" points="250,3732.7148,240,3736.7148,250,3740.7148,246,3736.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="244" x2="695" y1="3736.7148" y2="3736.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="256" y="3731.9727">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="278" y="3731.9727">Return reference to the stored object</text><path d="M244,3749.7148 L244,4126.7148 L561,4126.7148 L561,3759.7148 L551,3749.7148 L244,3749.7148 " fill="#FFFF00" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M551,3749.7148 L551,3759.7148 L561,3759.7148 L551,3749.7148 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="250" y="3767.2832">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="3782.5938">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="266" y="3797.9043">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="266" y="3813.2148">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="266" y="3828.5254">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="266" y="3843.8359">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="266" y="3859.1465">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="282" y="3874.457">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="282" y="3889.7676">payload: &lt;bulkTransferResult_Reference&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="266" y="3905.0781">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="266" y="3920.3887">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="282" y="3935.6992">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="298" y="3951.0098">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="298" y="3966.3203">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="298" y="3981.6309">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="298" y="3996.9414">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="298" y="4012.252">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="298" y="4027.5625">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="314" y="4042.873">status: state.status,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="314" y="4058.1836">code: state.code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="298" y="4073.4941">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="282" y="4088.8047">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="266" y="4104.1152">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="250" y="4119.4258">}</text><path d="M244,4141.168 L244,4181.168 L523,4181.168 L523,4151.168 L513,4141.168 L244,4141.168 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M513,4141.168 L513,4151.168 L523,4151.168 L513,4141.168 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="250" y="4158.7363">Depending on the action decide where to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="250" y="4174.0469">send notification: payer, payee OR both</text><polygon fill="#A80036" points="813.5,4223.4102,823.5,4227.4102,813.5,4231.4102,817.5,4227.4102" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="819.5" y1="4227.4102" y2="4227.4102"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="246" y="4215.0127">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="268" y="4207.3574">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="268" y="4222.668">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="352" y="4222.668">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="157.5" x2="1358" y1="4273.4102" y2="4273.4102"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="162.5" y="4284.0449">[exitCode == 0 &amp;&amp; produceNotification == false]</text><path d="M244,4292.3652 L244,4317.3652 L532,4317.3652 L532,4302.3652 L522,4292.3652 L244,4292.3652 " fill="#D3D3D3" filter="url(#fox6uhtzdocm5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M522,4292.3652 L522,4302.3652 L532,4302.3652 L522,4292.3652 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="250" y="4309.9336">Do nothing (await next individual transfer)</text><!--
@startuml
title 1.4.0. Bulk Processing Handler Consume

autonumber



collections "topic-bulk-\nprocessing" as TOPIC_BULK_PROCESSING
control "Bulk Processing\nHandler" as BULK_PROC_HANDLER
collections "topic-event" as TOPIC_EVENTS
collections "mongo-\nobject-store" as OBJECT_STORE
collections "topic-notification" as TOPIC_NOTIFICATION
entity "Bulk DAO" as BULK_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_BULK_PROCESSING
    participant BULK_PROC_HANDLER
    participant TOPIC_EVENTS
    participant OBJECT_STORE
    participant TOPIC_NOTIFICATION
    participant BULK_DAO
    participant DB
end box

activate BULK_PROC_HANDLER
group Bulk Processing Handler Consume
    TOPIC_BULK_PROCESSING <- BULK_PROC_HANDLER: Consume message
    activate TOPIC_BULK_PROCESSING
    deactivate TOPIC_BULK_PROCESSING

    break
        group Validate Event
            BULK_PROC_HANDLER <-> BULK_PROC_HANDLER: Validate event - Rule:\ntype == 'bulk-processing' && action IN\n['prepare-duplicate', 'prepare', 'timeout-received',\n'fulfil-duplicate', 'commit', 'reject', 'abort',\n'timeout-reserved']\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        BULK_PROC_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over BULK_PROC_HANDLER, TOPIC_EVENTS:  Event Handler Consume\n
        |||
    end

    group Process Message
        BULK_PROC_HANDLER -> BULK_DAO: Retrieve current state of Bulk Transfer
        activate BULK_DAO
        BULK_DAO -> DB: Retrieve current state of Bulk Transfer
        activate DB
        hnote over DB #lightyellow
            bulkTransfer
            bulkTransferStateChange
        end note
        BULK_DAO <- - DB: Return **bulkTransferInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferInfo**
        deactivate BULK_DAO

        group Validate Bulk Transfer State
            note right of BULK_PROC_HANDLER #lightgrey
                **Initialize variables**:
                let criteriaState
                let incompleteBulkState
                let completedBulkState
                let bulkTransferState
                let processingState
                let <color #green>exitCode = 0</color> (success)
                let errorMessage
                let produceNotification = false
            end note
            alt bulkTransferInfo.bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE']
                note right of BULK_PROC_HANDLER #lightgrey
                    criteriaState = 'RECEIVED'
                    incompleteBulkState = 'PENDING_PREPARE'
                    completedBulkState = 'ACCEPTED'
                end note
                alt action == 'prepare-duplicate'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'RECEIVED_DUPLICATE'
                    end note
                else action == 'prepare' AND state.status == 'error'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'RECEIVED_INVALID'
                    end note
                else action == 'prepare' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'ACCEPTED'
                    end note
                else action IN ['timeout-received', 'timeout-reserved']
                    note right of BULK_PROC_HANDLER #lightgrey
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 2</color>
                        errorMessage = 'Invalid action for bulk in RECEIVED state'
                    end note
                end
            else bulkTransferInfo.bulkTransferState IN ['ACCEPTED']
                alt action == 'timeout-reserved'
                    note right of BULK_PROC_HANDLER #lightgrey
                        criteriaState = 'ACCEPTED'
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 3</color>
                        errorMessage = 'Invalid action for bulk in ACCEPTED state'
                    end note
                end
            else bulkTransferInfo.bulkTransferState IN ['PROCESSING', 'PENDING_FULFIL']
                note right of BULK_PROC_HANDLER #lightgrey
                    criteriaState = 'ACCEPTED'
                    incompleteBulkState = 'PENDING_FULFIL'
                    completedBulkState = 'COMPLETED'
                end note
                alt action == 'fulfil-duplicate'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'FULFIL_DUPLICATE'
                    end note
                else action == 'commit' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'COMPLETED'
                    end note
                else action == 'reject' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'REJECTED'
                    end note
                else action IN ['commit', 'abort'] AND state.status == 'error'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'FULFIL_INVALID'
                    end note
                else action == 'timeout-reserved'
                    note right of BULK_PROC_HANDLER #lightgrey
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 4</color>
                        errorMessage = 'Invalid action for bulk in PROCESSING state'
                    end note
                end
            else all other ['PENDING_INVALID', 'COMPLETED', 'REJECTED', 'INVALID']
                note right of BULK_PROC_HANDLER #lightgrey
                    <color #red>exitCode = 1</color>
                    errorMessage = 'Individual transfer can not be
                        processed when bulk transfer state is final'
                end note
            end
        end

        opt exitCode == 0 (success)
            BULK_PROC_HANDLER -> BULK_DAO: Persist individual transfer processing state
            activate BULK_DAO
            BULK_DAO -> DB: Persist individual transfer processing state\n<color #gray>- - store errorCode/errorMessage when</color>\n<color #gray>state.status == 'error'</color>
            activate DB
            hnote over DB #lightyellow
                bulkTransferAssociation
            end note
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO

            BULK_PROC_HANDLER -> BULK_DAO: Check previously defined completion criteria
            activate BULK_DAO
            BULK_DAO -> DB: Select EXISTS (LIMIT 1) in criteriaState
            activate DB
            hnote over DB #lightyellow
                bulkTransferAssociation
            end note
            BULK_DAO <- - DB: Return **existingIndividualTransfer**
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return **existingIndividualTransfer**
            deactivate BULK_DAO

            alt individual transfer exists
                note right of BULK_PROC_HANDLER #lightgrey
                    bulkTransferState = incompleteBulkState
                end note
            else no transfer in criteriaState exists
                note right of BULK_PROC_HANDLER #lightgrey
                    bulkTransferState = completedBulkState
                    produceNotification = true
                end note
            end

            BULK_PROC_HANDLER -> BULK_DAO: Persist bulkTransferState from previous step
            activate BULK_DAO
            BULK_DAO -> DB: Persist bulkTransferState
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                bulkTransferStateChange
            end note
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO
        end


        alt exitCode > 0
            group Send Bulk Error Notification
                note right of BULK_PROC_HANDLER #yellow
                    Message:
                    {
                        id: <bulkTransferMessage.bulkTransferId>
                        from: <ledgerName>,
                        to: <bulkTransferMessage.payerFsp>,
                        type: application/json
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                errorInformation: {
                                    errorCode: exitCode,
                                    errorMessage: errorMessage
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: bulk-notification,
                                action: bulk-notification,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: 1
                                }
                            }
                        }
                    }
                end note
                note right of BULK_PROC_HANDLER #lightgrey
                    Depending on the action decide where to
                    send notification: payer, payee OR both
                end note
                BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TOPIC_NOTIFICATION
                deactivate TOPIC_NOTIFICATION
            end
        else produceNotification == true
            BULK_PROC_HANDLER -> BULK_DAO: Request to retrieve all bulk transfer and individual transfer results
            activate BULK_DAO
            BULK_DAO -> DB: Get bulkTransferResult
            activate DB
            hnote over DB #lightyellow
                bulkTransfer
                bulkTransferStateChange
                bulkTransferAssociation
            end note
            BULK_DAO <- - DB: Return **bulkTransferResult**
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferResult**
            deactivate BULK_DAO

            group Send Bulk Notification
                BULK_PROC_HANDLER -> OBJECT_STORE: Generate & Persist bulk message\nto object store
                activate OBJECT_STORE
                OBJECT_STORE - -> BULK_PROC_HANDLER: Return reference to the stored object
                deactivate OBJECT_STORE
                note right of BULK_PROC_HANDLER #yellow
                    Message:
                    {
                        id: <bulkTransferMessage.bulkTransferId>
                        from: <ledgerName>,
                        to: <bulkTransferMessage.payerFsp>,
                        type: application/json
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: <bulkTransferResult_Reference>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: bulk-notification,
                                action: bulk-notification,
                                createdAt: <timestamp>,
                                state: {
                                    status: state.status,
                                    code: state.code
                                }
                            }
                        }
                    }
                end note
                note right of BULK_PROC_HANDLER #lightgrey
                    Depending on the action decide where to
                    send notification: payer, payee OR both
                end note
                BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TOPIC_NOTIFICATION
                deactivate TOPIC_NOTIFICATION
            end
        else exitCode == 0 && produceNotification == false
            note right of BULK_PROC_HANDLER #lightgrey
                Do nothing (await next individual transfer)
            end note
        end
    end
end
deactivate BULK_PROC_HANDLER
@enduml

PlantUML version 1.2019.06(Fri May 24 22:40:25 IST 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_151-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>