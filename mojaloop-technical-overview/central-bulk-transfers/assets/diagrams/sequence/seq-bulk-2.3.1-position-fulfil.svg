<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2039px" preserveAspectRatio="none" style="width:1600px;height:2039px;" version="1.1" viewBox="0 0 1600 2039" width="1600px" zoomAndPan="magnify"><defs><filter height="300%" id="fa0ycfsbe3kvb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="696" x="453" y="23.5352">2.3.1. Fulfil Position Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="1994.3281" style="stroke: #A80036; stroke-width: 1.0;" width="1353.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="655.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="1827.041" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484.5" y="1901.3281"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="615.5" y="1420.2988"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="187.2188"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="855.5" y="450.3242"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="216.5293"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="503.9453"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="638.1875"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="746.1191"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="1813.041" style="stroke: #000000; stroke-width: 2.0;" width="1576" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1556" x="23" y="396.3926"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="775" x="794" y="465.3242"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="964.4141" style="stroke: #000000; stroke-width: 2.0;" width="675" x="23" y="974.9141"/><rect fill="#FFFFFF" height="481.0293" style="stroke: none; stroke-width: 1.0;" width="675" x="23" y="1458.2988"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="92" x2="92" y1="116.2871" y2="1963.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="489" x2="489" y1="116.2871" y2="1963.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="620" x2="620" y1="116.2871" y2="1963.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="746" x2="746" y1="116.2871" y2="1963.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="860" x2="860" y1="116.2871" y2="1963.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1330.5" x2="1330.5" y1="116.2871" y2="1963.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="113.334">Position Handler</text><ellipse cx="92.5" cy="83.7988" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,71.7988,94.5,66.7988,92.5,71.7988,94.5,76.7988,88.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="1975.8633">Position Handler</text><ellipse cx="92.5" cy="1994.8164" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,1982.8164,94.5,1977.8164,92.5,1982.8164,94.5,1987.8164,88.5,1982.8164" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="440" y="60.3105"/><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="436" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="464.5" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="443" y="101.334">notifications</text><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="440" y="1962.3281"/><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="436" y="1966.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="464.5" y="1986.8633">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="443" y="2003.3516">notifications</text><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="557" y="60.3105"/><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="553" y="64.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="595.5" y="84.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="560" y="101.334">bulk-processing</text><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="557" y="1962.3281"/><rect fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="553" y="1966.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="595.5" y="1986.8633">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="560" y="2003.3516">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="698" y="113.334">Position DAO</text><ellipse cx="746" cy="83.7988" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="698" y="1975.8633">Position DAO</text><ellipse cx="746" cy="1994.8164" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="2008.8164" y2="2008.8164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="804" y="113.334">Position Facade</text><ellipse cx="860.5" cy="83.7988" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="848.5" x2="872.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="804" y="1975.8633">Position Facade</text><ellipse cx="860.5" cy="1994.8164" fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="848.5" x2="872.5" y1="2008.8164" y2="2008.8164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1282.5" y="113.334">Central Store</text><path d="M1312.5,63.7988 C1312.5,53.7988 1330.5,53.7988 1330.5,53.7988 C1330.5,53.7988 1348.5,53.7988 1348.5,63.7988 L1348.5,89.7988 C1348.5,99.7988 1330.5,99.7988 1330.5,99.7988 C1330.5,99.7988 1312.5,99.7988 1312.5,89.7988 L1312.5,63.7988 " fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1312.5,63.7988 C1312.5,73.7988 1330.5,73.7988 1330.5,73.7988 C1330.5,73.7988 1348.5,73.7988 1348.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1282.5" y="1975.8633">Central Store</text><path d="M1312.5,1988.8164 C1312.5,1978.8164 1330.5,1978.8164 1330.5,1978.8164 C1330.5,1978.8164 1348.5,1978.8164 1348.5,1988.8164 L1348.5,2014.8164 C1348.5,2024.8164 1330.5,2024.8164 1330.5,2024.8164 C1330.5,2024.8164 1312.5,2024.8164 1312.5,2014.8164 L1312.5,1988.8164 " fill="#FEFECE" filter="url(#fa0ycfsbe3kvb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1312.5,1988.8164 C1312.5,1998.8164 1330.5,1998.8164 1330.5,1998.8164 C1330.5,1998.8164 1348.5,1998.8164 1348.5,1988.8164 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="1827.041" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484.5" y="1901.3281"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="615.5" y="1420.2988"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="187.2188"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="855.5" y="450.3242"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="216.5293"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="503.9453"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="638.1875"/><rect fill="#FFFFFF" filter="url(#fa0ycfsbe3kvb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1325.5" y="746.1191"/><path d="M13,133.2871 L273,133.2871 L273,140.2871 L263,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1813.041" style="stroke: #000000; stroke-width: 2.0;" width="1576" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="28" y="146.8555">Fulfil Position Handler Consume</text><polygon fill="#A80036" points="729,183.2188,739,187.2188,729,191.2188,733,187.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="735" y1="187.2188" y2="187.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="174.8213">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="117.5" y="167.166">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="182.4766">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="182.4766">2003</text><polygon fill="#A80036" points="1313.5,212.5293,1323.5,216.5293,1313.5,220.5293,1317.5,216.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1319.5" y1="216.5293" y2="216.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="211.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="771" y="211.7871">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fa0ycfsbe3kvb)" points="1265,229.5293,1396,229.5293,1406,248.5293,1396,267.5293,1265,267.5293,1255,248.5293,1265,229.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1267" y="246.0977">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1267" y="261.4082">transferParticipant</text><polygon fill="#A80036" points="762,290.4609,752,294.4609,762,298.4609,758,294.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1329.5" y1="294.4609" y2="294.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="768" y="289.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="781" y="289.7188">Return current state of transfer from DB</text><polygon fill="#A80036" points="108.5,319.7715,98.5,323.7715,108.5,327.7715,104.5,323.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="745" y1="323.7715" y2="323.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="319.0293">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="127.5" y="319.0293">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="139.5" y1="368.3926" y2="368.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="139.5" y1="368.3926" y2="381.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98.5" x2="139.5" y1="381.3926" y2="381.3926"/><polygon fill="#A80036" points="108.5,377.3926,98.5,381.3926,108.5,385.3926,104.5,381.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="355.9951">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="117.5" y="348.3398">Validate current state (transferState is 'RECEIVED-FULFIL')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="363.6504">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="363.6504">2001</text><path d="M23,396.3926 L744,396.3926 L744,403.3926 L734,413.3926 L23,413.3926 L23,396.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1556" x="23" y="396.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="676" x="38" y="409.9609">Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)</text><polygon fill="#A80036" points="843.5,446.3242,853.5,450.3242,843.5,454.3242,847.5,450.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="849.5" y1="450.3242" y2="450.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="437.9268">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="117.5" y="430.2715">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="445.582">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="445.582">2003</text><path d="M794,465.3242 L959,465.3242 L959,472.3242 L949,482.3242 L794,482.3242 L794,465.3242 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="775" x="794" y="465.3242"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="809" y="478.8926">DB TRANSACTION</text><polygon fill="#A80036" points="1313.5,499.9453,1323.5,503.9453,1313.5,507.9453,1317.5,503.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865.5" x2="1319.5" y1="503.9453" y2="503.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="872.5" y="499.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="885.5" y="499.2031">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fa0ycfsbe3kvb)" points="1269,516.9453,1392,516.9453,1402,527.9453,1392,539.9453,1269,539.9453,1259,527.9453,1269,516.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1271" y="533.5137">participantPosition</text><polygon fill="#A80036" points="876.5,562.5664,866.5,566.5664,876.5,570.5664,872.5,566.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="870.5" x2="1329.5" y1="566.5664" y2="566.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="882.5" y="561.8242">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="895.5" y="561.8242">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="865.5" x2="907.5" y1="595.877" y2="595.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="907.5" y1="595.877" y2="608.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="907.5" y1="608.877" y2="608.877"/><polygon fill="#A80036" points="876.5,604.877,866.5,608.877,876.5,612.877,872.5,608.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="872.5" y="591.1348">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="885.5" y="591.1348">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="979.5" y="591.1348">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1313.5,634.1875,1323.5,638.1875,1313.5,642.1875,1317.5,638.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865.5" x2="1319.5" y1="638.1875" y2="638.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="872.5" y="633.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="894.5" y="633.4453">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fa0ycfsbe3kvb)" points="1238,681.1875,1423,681.1875,1433,700.1875,1423,719.1875,1238,719.1875,1228,700.1875,1238,681.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1240" y="697.7559">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1294" y="697.7559">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1240" y="713.0664">SET value = latestPosition</text><polygon fill="#A80036" points="1313.5,742.1191,1323.5,746.1191,1313.5,750.1191,1317.5,746.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865.5" x2="1319.5" y1="746.1191" y2="746.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="872.5" y="741.377">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="894.5" y="741.377">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fa0ycfsbe3kvb)" points="1112,789.1191,1549,789.1191,1559,854.1191,1549,919.1191,1112,919.1191,1102,854.1191,1112,789.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1114" y="805.6875">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1162" y="805.6875">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1305" y="805.6875">transferStateId = 'COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1118" y="820.998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1114" y="836.3086">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1162" y="836.3086">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1114" y="851.6191">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1114" y="866.9297">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1114" y="882.2402">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1114" y="897.5508">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1114" y="912.8613">createdDate = new Date()</text><polygon fill="#A80036" points="108.5,948.9141,98.5,952.9141,108.5,956.9141,104.5,952.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="859.5" y1="952.9141" y2="952.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="948.1719">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="136.5" y="948.1719">Return success</text><path d="M23,974.9141 L85,974.9141 L85,981.9141 L75,991.9141 L23,991.9141 L23,974.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="964.4141" style="stroke: #000000; stroke-width: 2.0;" width="675" x="23" y="974.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="988.4824">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="100" y="987.5488">[If type == 'bulk-position']</text><path d="M102,997.2246 L102,1374.2246 L364,1374.2246 L364,1007.2246 L354,997.2246 L102,997.2246 " fill="#FFFF00" filter="url(#fa0ycfsbe3kvb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M354,997.2246 L354,1007.2246 L364,1007.2246 L354,997.2246 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="108" y="1014.793">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1030.1035">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="124" y="1045.4141">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="124" y="1060.7246">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="124" y="1076.0352">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="124" y="1091.3457">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="124" y="1106.6563">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="140" y="1121.9668">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="140" y="1137.2773">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="124" y="1152.5879">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="124" y="1167.8984">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="140" y="1183.209">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="156" y="1198.5195">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="156" y="1213.8301">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="156" y="1229.1406">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="156" y="1244.4512">action: bulk-commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="156" y="1259.7617">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="156" y="1275.0723">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="172" y="1290.3828">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="172" y="1305.6934">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="156" y="1321.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="140" y="1336.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="124" y="1351.625">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1366.9355">}</text><polygon fill="#A80036" points="603.5,1416.2988,613.5,1420.2988,603.5,1424.2988,607.5,1420.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="609.5" y1="1420.2988" y2="1420.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="104.5" y="1407.9014">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="126.5" y="1400.2461">Publish Transfer event to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="126.5" y="1415.5566">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="210.5" y="1415.5566">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="698" y1="1459.2988" y2="1459.2988"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="28" y="1469.9336">[If type == 'position']</text><path d="M102,1478.2539 L102,1855.2539 L364,1855.2539 L364,1488.2539 L354,1478.2539 L102,1478.2539 " fill="#FFFF00" filter="url(#fa0ycfsbe3kvb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M354,1478.2539 L354,1488.2539 L364,1488.2539 L354,1478.2539 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="108" y="1495.8223">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1511.1328">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="124" y="1526.4434">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="124" y="1541.7539">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="124" y="1557.0645">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="124" y="1572.375">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="124" y="1587.6855">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="140" y="1602.9961">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="140" y="1618.3066">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="124" y="1633.6172">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="124" y="1648.9277">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="140" y="1664.2383">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="156" y="1679.5488">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="156" y="1694.8594">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="156" y="1710.1699">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="156" y="1725.4805">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="156" y="1740.791">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="156" y="1756.1016">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="172" y="1771.4121">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="172" y="1786.7227">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="156" y="1802.0332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="140" y="1817.3438">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="124" y="1832.6543">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1847.9648">}</text><polygon fill="#A80036" points="472.5,1897.3281,482.5,1901.3281,472.5,1905.3281,476.5,1901.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="478.5" y1="1901.3281" y2="1901.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="104.5" y="1888.9307">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="126.5" y="1881.2754">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="126.5" y="1896.5859">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="203.5" y="1896.5859">2003</text><!--
@startuml
title 2.3.1. Fulfil Position Handler Consume (single message, includes individual transfers from Bulk)

autonumber


control "Position Handler" as POS_HANDLER
collections "topic-\nnotifications" as TOPIC_NOTIFICATIONS
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
entity "Position Facade" as POS_FACADE
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_DAO
    participant POS_FACADE
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
    POS_HANDLER -> POS_DAO: Request current state of transfer from DB \n<color #FF0000><b>Error code:</b> 2003</color>
    activate POS_DAO
    POS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
        transferParticipant
    end note
    DB - -> POS_DAO: Return current state of transfer from DB
    deactivate DB
    POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate POS_DAO
    POS_HANDLER <-> POS_HANDLER: Validate current state (transferState is 'RECEIVED-FULFIL')\n<color #FF0000><b>Error code:</b> 2001</color>
    group Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)
        POS_HANDLER -> POS_FACADE: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
        group <color #blue>DB TRANSACTION</color>
            activate POS_FACADE
            POS_FACADE -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participantPosition
            end note
            DB - -> POS_FACADE: Return participantPosition.value from DB for Payee
            deactivate DB
            POS_FACADE <-> POS_FACADE: **latestPosition** = participantPosition.value - payload.amount.amount
            POS_FACADE->DB: Persist latestPosition to DB for Payee
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = latestPosition
            end note
            activate DB
            deactivate DB
            POS_FACADE -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    INSERT **transferStateChange** transferStateId = 'COMMITTED'

                    INSERT **participantPositionChange**
                    SET participantPositionId = participantPosition.participantPositionId,
                    transferStateChangeId = transferStateChange.transferStateChangeId,
                    value = latestPosition,
                    reservedValue = participantPosition.reservedValue
                    createdDate = new Date()
            end note
            activate DB
            deactivate DB
            deactivate POS_DAO
        end
        POS_FACADE - -> POS_HANDLER: Return success
        deactivate POS_FACADE
    end

    alt If type == 'bulk-position'
        note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: bulk-processing,
                    action: bulk-commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Transfer event to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_BULK_PROCESSING
        deactivate TOPIC_BULK_PROCESSING
    else If type == 'position'
        note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end

end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>