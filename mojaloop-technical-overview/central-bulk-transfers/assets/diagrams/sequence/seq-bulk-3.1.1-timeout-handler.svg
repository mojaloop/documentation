<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="5635px" preserveAspectRatio="none" style="width:1724px;height:5635px;" version="1.1" viewBox="0 0 1724 5635" width="1724px" zoomAndPan="magnify"><defs><filter height="300%" id="fjoi852c0kfq7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="382" x="672" y="23.5352">3.1.1. Timeout Handler Consume (incl. Bulk Transfer)</text><rect fill="#FFFFE0" height="5590.1504" style="stroke: #A80036; stroke-width: 1.0;" width="1356.5" x="49" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="676.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5410.8867" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="110.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="4303.5664"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="5480.6621"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="483.5" y="3577.5684"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722" y="4907.7695"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="636.9863"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="987.9551"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1606.4648" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="1185.1289"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1097.5" y="320.2598"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="349.5703"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="666.2969"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1017.2656"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1281.0605"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1557.4082"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1864.377"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="2140.7246"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="2378.1406"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5403.8867" style="stroke: #000000; stroke-width: 2.0;" width="1700" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="616.5" x="43" y="160.0859"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="33" y="281.6387"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="43" y="517.7441"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1606" x="43" y="598.3652"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1506" x="43" y="949.334"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1653.0859" style="stroke: #000000; stroke-width: 2.0;" width="1660" x="43" y="1146.5078"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="898.5" x="794.5" y="1200.1289"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="2719.0684" style="stroke: #000000; stroke-width: 2.0;" width="801.5" x="23" y="2813.5938"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="2662.7578" style="stroke: #000000; stroke-width: 2.0;" width="781.5" x="33" y="2862.9043"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="505.5" x="43" y="2887.2148"/><rect fill="#FFFFFF" height="725.998" style="stroke: none; stroke-width: 1.0;" width="505.5" x="43" y="3615.5684"/><rect fill="#FFFFFF" height="1177.0957" style="stroke: none; stroke-width: 1.0;" width="781.5" x="33" y="4348.5664"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1148.1406" style="stroke: #000000; stroke-width: 2.0;" width="761.5" x="43" y="4370.5215"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="761.5" x="43" y="4945.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="115" x2="115" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="358.5" x2="358.5" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="488.5" x2="488.5" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="598.5" x2="598.5" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="726.5" x2="726.5" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="852.5" x2="852.5" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1102" x2="1102" y1="118.7754" y2="5556.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1353.5" x2="1353.5" y1="118.7754" y2="5556.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="53" y="99.334">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="85.5" y="115.8223">Handler</text><ellipse cx="115.5" cy="69.7988" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="111.5,57.7988,117.5,52.7988,115.5,57.7988,117.5,62.7988,111.5,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="53" y="5569.1973">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="85.5" y="5585.6855">Handler</text><ellipse cx="115.5" cy="5604.6387" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="111.5,5592.6387,117.5,5587.6387,115.5,5592.6387,117.5,5597.6387,111.5,5592.6387" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="292.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="288.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="333.5" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="295.5" y="103.8223">transfer-position</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="292.5" y="5555.6621"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="288.5" y="5559.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="333.5" y="5580.1973">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="295.5" y="5596.6855">transfer-position</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="442.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="438.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="463.5" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="445.5" y="103.8223">notification</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="442.5" y="5555.6621"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="438.5" y="5559.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="463.5" y="5580.1973">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="445.5" y="5596.6855">notification</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="552.5" y="79.2871"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="548.5" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="555.5" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="552.5" y="5555.6621"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="548.5" y="5559.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="555.5" y="5580.1973">topic-event</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="663.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="659.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="702" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="666.5" y="103.8223">bulk-processing</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="663.5" y="5555.6621"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="659.5" y="5559.6621"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="702" y="5580.1973">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="666.5" y="5596.6855">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="804.5" y="115.8223">Position DAO</text><ellipse cx="852.5" cy="86.2871" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="840.5" x2="864.5" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="804.5" y="5569.1973">Position DAO</text><ellipse cx="852.5" cy="5588.1504" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="840.5" x2="864.5" y1="5602.1504" y2="5602.1504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1052" y="115.8223">Segment DAO</text><ellipse cx="1102.5" cy="86.2871" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1090.5" x2="1114.5" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1052" y="5569.1973">Segment DAO</text><ellipse cx="1102.5" cy="5588.1504" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1090.5" x2="1114.5" y1="5602.1504" y2="5602.1504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1305.5" y="115.8223">Central Store</text><path d="M1335.5,66.2871 C1335.5,56.2871 1353.5,56.2871 1353.5,56.2871 C1353.5,56.2871 1371.5,56.2871 1371.5,66.2871 L1371.5,92.2871 C1371.5,102.2871 1353.5,102.2871 1353.5,102.2871 C1353.5,102.2871 1335.5,102.2871 1335.5,92.2871 L1335.5,66.2871 " fill="#FEFECE" filter="url(#fjoi852c0kfq7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1335.5,66.2871 C1335.5,76.2871 1353.5,76.2871 1353.5,76.2871 C1353.5,76.2871 1371.5,76.2871 1371.5,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1305.5" y="5569.1973">Central Store</text><path d="M1335.5,5582.1504 C1335.5,5572.1504 1353.5,5572.1504 1353.5,5572.1504 C1353.5,5572.1504 1371.5,5572.1504 1371.5,5582.1504 L1371.5,5608.1504 C1371.5,5618.1504 1353.5,5618.1504 1353.5,5618.1504 C1353.5,5618.1504 1335.5,5618.1504 1335.5,5608.1504 L1335.5,5582.1504 " fill="#FEFECE" filter="url(#fjoi852c0kfq7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1335.5,5582.1504 C1335.5,5592.1504 1353.5,5592.1504 1353.5,5592.1504 C1353.5,5592.1504 1371.5,5592.1504 1371.5,5582.1504 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5410.8867" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="110.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="4303.5664"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="353.5" y="5480.6621"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="483.5" y="3577.5684"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722" y="4907.7695"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="636.9863"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="987.9551"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1606.4648" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="847.5" y="1185.1289"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1097.5" y="320.2598"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="349.5703"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="666.2969"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1017.2656"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1281.0605"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1557.4082"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="1864.377"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="2140.7246"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1348.5" y="2378.1406"/><path d="M13,135.7754 L239,135.7754 L239,142.7754 L229,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5403.8867" style="stroke: #000000; stroke-width: 2.0;" width="1700" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="28" y="149.3438">Timeout Handler Consume</text><path d="M43,160.0859 L258,160.0859 L258,167.0859 L248,177.0859 L43,177.0859 L43,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="616.5" x="43" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="58" y="173.6543">Persist Event Information</text><polygon fill="#A80036" points="587,194.707,597,198.707,587,202.707,591,198.707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="593" y1="198.707" y2="198.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="193.9648">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="140.5" y="193.9648">Publish event information</text><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="598.5" x="50" y="206.707"/><polygon fill="#EEEEEE" points="50,206.707,114,206.707,114,213.707,104,223.707,50,223.707,50,206.707" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="63" y="221.2754">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="276.25" y="240.2754">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="280.25" y="255.5859"/><path d="M33,281.6387 L585,281.6387 L585,288.6387 L575,298.6387 L33,298.6387 L33,281.6387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="33" y="281.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="507" x="48" y="295.207">Get previous checkpoint of last record processed (Lower limit for inclusion)</text><polygon fill="#A80036" points="1085.5,316.2598,1095.5,320.2598,1085.5,324.2598,1089.5,320.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="1091.5" y1="320.2598" y2="320.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="315.5176">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="140.5" y="315.5176">Get last segment as @intervalMin</text><polygon fill="#A80036" points="1336.5,345.5703,1346.5,349.5703,1336.5,353.5703,1340.5,349.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1107.5" x2="1342.5" y1="349.5703" y2="349.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1114.5" y="344.8281">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1127.5" y="344.8281">Get last segment as @intervalMin</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1226,362.5703,1481,362.5703,1491,404.5703,1481,446.5703,1226,446.5703,1216,404.5703,1226,362.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1228" y="379.1387">SELECT value INTO @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1228" y="394.4492">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1268" y="394.4492">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1228" y="409.7598">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1228" y="425.0703">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1228" y="440.3809">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1118.5,469.4336,1108.5,473.4336,1118.5,477.4336,1114.5,473.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1112.5" x2="1352.5" y1="473.4336" y2="473.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1124.5" y="468.6914">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1137.5" y="468.6914">Return @intervalMin</text><polygon fill="#A80036" points="131.5,498.7441,121.5,502.7441,131.5,506.7441,127.5,502.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="1101.5" y1="502.7441" y2="502.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="137.5" y="498.002">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="150.5" y="498.002">Return @intervalMin</text><path d="M43,517.7441 L110,517.7441 L110,524.7441 L100,534.7441 L43,534.7441 L43,517.7441 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="43" y="517.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="531.3125">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="125" y="530.3789">[@intervalMin IS NULL =&gt; segment record NOT FOUND]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="162.5" y1="556.3652" y2="556.3652"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="162.5" y1="556.3652" y2="569.3652"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="121.5" x2="162.5" y1="569.3652" y2="569.3652"/><polygon fill="#A80036" points="131.5,565.3652,121.5,569.3652,131.5,573.3652,127.5,569.3652" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="551.623">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="140.5" y="551.623">Set @intervalMin = 0</text><path d="M43,598.3652 L166,598.3652 L166,605.3652 L156,615.3652 L43,615.3652 L43,598.3652 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1606" x="43" y="598.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="58" y="611.9336">Do Cleanup</text><polygon fill="#A80036" points="835.5,632.9863,845.5,636.9863,835.5,640.9863,839.5,636.9863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="841.5" y1="636.9863" y2="636.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="632.2441">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="140.5" y="632.2441">Clean up transferTimeout from finalised transfers</text><polygon fill="#A80036" points="1336.5,662.2969,1346.5,666.2969,1336.5,670.2969,1340.5,666.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="666.2969" y2="666.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="864.5" y="661.5547">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="877.5" y="661.5547">Clean up transferTimeout from finalised transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1077,709.2969,1629,709.2969,1639,804.2969,1629,900.2969,1077,900.2969,1067,804.2969,1077,709.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="1079" y="725.8652">DELETE tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1079" y="741.1758">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1119" y="741.1758">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1233" y="741.1758">AS tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="548" x="1079" y="756.4863">JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1103" y="771.7969">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1143" y="771.7969">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1257" y="771.7969">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1103" y="787.1074">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1135" y="787.1074">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1278" y="787.1074">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1103" y="802.418">ON tsc.transferId = tt1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1103" y="817.7285">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1079" y="833.0391">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1079" y="848.3496">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1111" y="848.3496">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1254" y="848.3496">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1079" y="863.6602">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="1079" y="878.9707">WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="1095" y="894.2813">, 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')</text><polygon fill="#A80036" points="131.5,923.334,121.5,927.334,131.5,931.334,127.5,927.334" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="851.5" y1="927.334" y2="927.334"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="137.5" y="922.5918">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="150.5" y="922.5918">Return success</text><path d="M43,949.334 L421,949.334 L421,956.334 L411,966.334 L43,966.334 L43,949.334 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1506" x="43" y="949.334"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="333" x="58" y="962.9023">Determine IntervalMax (Upper limit for inclusion)</text><polygon fill="#A80036" points="835.5,983.9551,845.5,987.9551,835.5,991.9551,839.5,987.9551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="841.5" y1="987.9551" y2="987.9551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="983.2129">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="149.5" y="983.2129">Get last transferStateChangeId as @intervalMax</text><polygon fill="#A80036" points="1336.5,1013.2656,1346.5,1017.2656,1336.5,1021.2656,1340.5,1017.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="1017.2656" y2="1017.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="1012.5234">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="886.5" y="1012.5234">Get last transferStateChangeId as @intervalMax</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1177,1030.2656,1529,1030.2656,1539,1049.2656,1529,1068.2656,1177,1068.2656,1167,1049.2656,1177,1030.2656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1179" y="1046.834">SELECT MAX(transferStateChangeId) INTO @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1179" y="1062.1445">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1219" y="1062.1445">transferStateChange</text><polygon fill="#A80036" points="868.5,1091.1973,858.5,1095.1973,868.5,1099.1973,864.5,1095.1973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="862.5" x2="1352.5" y1="1095.1973" y2="1095.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="874.5" y="1090.4551">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="896.5" y="1090.4551">Return @intervalMax</text><polygon fill="#A80036" points="131.5,1120.5078,121.5,1124.5078,131.5,1128.5078,127.5,1124.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="851.5" y1="1124.5078" y2="1124.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="137.5" y="1119.7656">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="159.5" y="1119.7656">Return @intervalMax</text><path d="M43,1146.5078 L398,1146.5078 L398,1153.5078 L388,1163.5078 L43,1163.5078 L43,1146.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1653.0859" style="stroke: #000000; stroke-width: 2.0;" width="1660" x="43" y="1146.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="58" y="1160.0762">Prepare data and return the list for expiration</text><polygon fill="#A80036" points="835.5,1181.1289,845.5,1185.1289,835.5,1189.1289,839.5,1185.1289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="841.5" y1="1185.1289" y2="1185.1289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="1180.3867">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="149.5" y="1180.3867">Prepare data and get transfers to be expired</text><path d="M794.5,1200.1289 L959.5,1200.1289 L959.5,1207.1289 L949.5,1217.1289 L794.5,1217.1289 L794.5,1200.1289 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="898.5" x="794.5" y="1200.1289"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="809.5" y="1213.6973">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="899.5" y1="1238.75" y2="1238.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="899.5" x2="899.5" y1="1238.75" y2="1251.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="899.5" y1="1251.75" y2="1251.75"/><polygon fill="#A80036" points="868.5,1247.75,858.5,1251.75,868.5,1255.75,864.5,1251.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="1234.0078">15</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="886.5" y="1234.0078">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1042.5" y="1234.0078">= now()</text><polygon fill="#A80036" points="1336.5,1277.0605,1346.5,1281.0605,1336.5,1285.0605,1340.5,1281.0605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="1281.0605" y2="1281.0605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="1276.3184">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="886.5" y="1276.3184">Insert all new transfers still in processing state</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1100,1324.0605,1606,1324.0605,1616,1419.0605,1606,1515.0605,1100,1515.0605,1090,1419.0605,1100,1324.0605" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1102" y="1340.6289">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1186" y="1340.6289">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="1296" y="1340.6289">(transferId, expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1102" y="1355.9395">SELECT t.transferId, t.expirationDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1102" y="1371.25">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="1142" y="1371.25">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1200" y="1371.25">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="502" x="1102" y="1386.5605">JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1126" y="1401.8711">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1166" y="1401.8711">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1126" y="1417.1816">WHERE transferStateChangeId &gt; @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1126" y="1432.4922">AND transferStateChangeId &lt;= @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1126" y="1447.8027">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1102" y="1463.1133">ON ts.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1102" y="1478.4238">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1134" y="1478.4238">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1277" y="1478.4238">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1102" y="1493.7344">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="1102" y="1509.0449">WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')</text><polygon fill="#A80036" points="1336.5,1553.4082,1346.5,1557.4082,1336.5,1561.4082,1340.5,1557.4082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="1557.4082" y2="1557.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="1545.0107">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="886.5" y="1537.3555">Insert transfer state ABORTED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="886.5" y="1552.666">expired RECEIVED_PREPARE transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1035,1600.4082,1672,1600.4082,1682,1711.4082,1672,1822.4082,1035,1822.4082,1025,1711.4082,1035,1600.4082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1037" y="1616.9766">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1121" y="1616.9766">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1037" y="1632.2871">SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1037" y="1647.5977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1077" y="1647.5977">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1191" y="1647.5977">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1037" y="1662.9082">JOIN (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="460" x="1077" y="1662.9082">-- Following subquery is reused 3 times and may be optimized if needed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="528" x="1061" y="1678.2188">SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1061" y="1693.5293">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1101" y="1693.5293">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1244" y="1693.5293">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1061" y="1708.8398">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1093" y="1708.8398">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1207" y="1708.8398">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1061" y="1724.1504">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1061" y="1739.4609">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1037" y="1754.7715">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1037" y="1770.082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1069" y="1770.082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1212" y="1770.082">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1037" y="1785.3926">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1037" y="1800.7031">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1037" y="1816.0137">AND tsc.transferStateId = 'RECEIVED_PREPARE'</text><polygon fill="#A80036" points="1336.5,1860.377,1346.5,1864.377,1336.5,1868.377,1340.5,1864.377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="1864.377" y2="1864.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="1851.9795">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="886.5" y="1844.3242">Insert transfer state EXPIRED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="886.5" y="1859.6348">expired RESERVED transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1034,1907.377,1673,1907.377,1683,2010.377,1673,2114.377,1034,2114.377,1024,2010.377,1034,1907.377" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1036" y="1923.9453">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1120" y="1923.9453">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="635" x="1036" y="1939.2559">SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1036" y="1954.5664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1076" y="1954.5664">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1190" y="1954.5664">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1036" y="1969.877">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1060" y="1985.1875">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1100" y="1985.1875">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1243" y="1985.1875">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1060" y="2000.498">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1092" y="2000.498">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1206" y="2000.498">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1060" y="2015.8086">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1060" y="2031.1191">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1036" y="2046.4297">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1036" y="2061.7402">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1068" y="2061.7402">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1211" y="2061.7402">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1036" y="2077.0508">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1036" y="2092.3613">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1036" y="2107.6719">AND tsc.transferStateId = 'RESERVED'</text><polygon fill="#A80036" points="1336.5,2136.7246,1346.5,2140.7246,1336.5,2144.7246,1340.5,2140.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="2140.7246" y2="2140.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="2135.9824">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="886.5" y="2135.9824">Update segment table to be used for the next run</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1148,2183.7246,1558,2183.7246,1568,2263.7246,1558,2344.7246,1148,2344.7246,1138,2263.7246,1148,2183.7246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="1150" y="2200.293">IF @intervalMin = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1166" y="2215.6035">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1166" y="2230.9141">INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1202" y="2230.9141">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="1261" y="2230.9141">(segmentType, enumeration, tableName, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="1166" y="2246.2246">VALUES ('timeout', 0, 'transferStateChange', @intervalMax)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1150" y="2261.5352">ELSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1166" y="2276.8457">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1220" y="2276.8457">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1166" y="2292.1563">SET value = @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1166" y="2307.4668">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1166" y="2322.7773">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1166" y="2338.0879">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1336.5,2374.1406,1346.5,2378.1406,1336.5,2382.1406,1340.5,2378.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="1342.5" y1="2378.1406" y2="2378.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="864.5" y="2373.3984">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="886.5" y="2373.3984">Get list of transfers to be expired with current state</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1069,2391.1406,1637,2391.1406,1647,2563.1406,1637,2735.1406,1069,2735.1406,1059,2563.1406,1069,2391.1406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="1071" y="2407.709">SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="1103" y="2423.0195">tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1071" y="2438.3301">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1111" y="2438.3301">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1225" y="2438.3301">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1071" y="2453.6406">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1103" y="2468.9512">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1143" y="2468.9512">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1286" y="2468.9512">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1103" y="2484.2617">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1135" y="2484.2617">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1249" y="2484.2617">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1103" y="2499.5723">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1103" y="2514.8828">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1071" y="2530.1934">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1071" y="2545.5039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1103" y="2545.5039">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1246" y="2545.5039">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1071" y="2560.8145">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1071" y="2576.125">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1103" y="2576.125">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1234" y="2576.125">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1071" y="2591.4355">ON tp1.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1071" y="2606.7461">AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1071" y="2622.0566">AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1071" y="2637.3672">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1103" y="2637.3672">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1234" y="2637.3672">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1071" y="2652.6777">ON tp2.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="1071" y="2667.9883">AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1071" y="2683.2988">AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="1071" y="2698.6094">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="1136" y="2698.6094">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1305" y="2698.6094">bta</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1071" y="2713.9199">ON bta.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1071" y="2729.2305">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><polygon fill="#A80036" points="868.5,2758.2832,858.5,2762.2832,868.5,2766.2832,864.5,2762.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="862.5" x2="1352.5" y1="2762.2832" y2="2762.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="874.5" y="2757.541">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="896.5" y="2757.541">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="941.5" y="2757.541">transferTimeoutList</text><polygon fill="#A80036" points="131.5,2787.5938,121.5,2791.5938,131.5,2795.5938,127.5,2791.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="851.5" y1="2791.5938" y2="2791.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="137.5" y="2786.8516">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="159.5" y="2786.8516">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="204.5" y="2786.8516">transferTimeoutList</text><path d="M23,2813.5938 L97,2813.5938 L97,2820.5938 L87,2830.5938 L23,2830.5938 L23,2813.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2719.0684" style="stroke: #000000; stroke-width: 2.0;" width="801.5" x="23" y="2813.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="2827.1621">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="2826.2285">[for each transfer in the list]</text><path d="M33,2862.9043 L95,2862.9043 L95,2869.9043 L85,2879.9043 L33,2879.9043 L33,2862.9043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2662.7578" style="stroke: #000000; stroke-width: 2.0;" width="781.5" x="33" y="2862.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="2876.4727">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="367" x="110" y="2875.5391">[transferTimeoutList.bulkTransferId == NULL (Regular Transfer)]</text><path d="M43,2887.2148 L105,2887.2148 L105,2894.2148 L95,2904.2148 L43,2904.2148 L43,2887.2148 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="505.5" x="43" y="2887.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="58" y="2900.7832">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="120" y="2899.8496">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M125,2909.5254 L125,3546.5254 L525,3546.5254 L525,2919.5254 L515,2909.5254 L125,2909.5254 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,2909.5254 L515,2919.5254 L525,2919.5254 L515,2909.5254 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="2927.0938">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="2942.4043">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="147" y="2957.7148">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="2973.0254">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="2988.3359">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="3003.6465">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="3018.957">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3034.2676">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="179" y="3049.5781">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="179" y="3064.8887">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="179" y="3080.1992">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3095.5098">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="179" y="3110.8203">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="179" y="3126.1309">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="179" y="3141.4414">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3156.752">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="179" y="3172.0625">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="179" y="3187.373">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="3202.6836">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3217.9941">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="3233.3047">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="3248.6152">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="3263.9258">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="3279.2363">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="3294.5469">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="3309.8574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="3325.168">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="3340.4785">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="3355.7891">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="3371.0996">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="179" y="3386.4102">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="179" y="3401.7207">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="3417.0313">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="3432.3418">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="3447.6523">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="3462.9629">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="3478.2734">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="3493.584">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="3508.8945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="3524.2051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="3539.5156">}</text><polygon fill="#A80036" points="471.5,3573.5684,481.5,3577.5684,471.5,3581.5684,475.5,3577.5684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="477.5" y1="3577.5684" y2="3577.5684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="3572.8262">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="149.5" y="3572.8262">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="548.5" y1="3616.5684" y2="3616.5684"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="48" y="3627.2031">[transferStateId == 'RESERVED']</text><path d="M125,3635.5234 L125,4272.5234 L525,4272.5234 L525,3645.5234 L515,3635.5234 L125,3635.5234 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,3635.5234 L515,3645.5234 L525,3645.5234 L515,3635.5234 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="3653.0918">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="3668.4023">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="147" y="3683.7129">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="3699.0234">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="3714.334">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="3729.6445">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="3744.9551">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3760.2656">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="179" y="3775.5762">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="179" y="3790.8867">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="179" y="3806.1973">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3821.5078">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="179" y="3836.8184">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="179" y="3852.1289">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="179" y="3867.4395">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="179" y="3882.75">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="179" y="3898.0605">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="179" y="3913.3711">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="163" y="3928.6816">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3943.9922">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="3959.3027">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="3974.6133">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="3989.9238">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="4005.2344">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4020.5449">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4035.8555">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="4051.166">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="4066.4766">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="4081.7871">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="4097.0977">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="179" y="4112.4082">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="179" y="4127.7188">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="4143.0293">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="4158.3398">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="4173.6504">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="4188.9609">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="4204.2715">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4219.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4234.8926">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="4250.2031">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4265.5137">}</text><polygon fill="#A80036" points="341.5,4299.5664,351.5,4303.5664,341.5,4307.5664,345.5,4303.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="347.5" y1="4303.5664" y2="4303.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="4298.8242">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="149.5" y="4298.8242">Route &amp; Publish Position event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="814.5" y1="4349.5664" y2="4349.5664"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="38" y="4360.2012">[Individual Transfer from a Bulk]</text><path d="M43,4370.5215 L105,4370.5215 L105,4377.5215 L95,4387.5215 L43,4387.5215 L43,4370.5215 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1148.1406" style="stroke: #000000; stroke-width: 2.0;" width="761.5" x="43" y="4370.5215"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="58" y="4384.0898">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="120" y="4383.1563">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M125,4392.832 L125,4876.832 L525,4876.832 L525,4402.832 L515,4392.832 L125,4392.832 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,4392.832 L515,4402.832 L525,4402.832 L515,4392.832 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="4410.4004">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4425.7109">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="4441.0215"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="147" y="4441.0215">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="159" y="4441.0215">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="4456.332"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="147" y="4456.332">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="208" y="4456.332">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="4471.6426">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="4486.9531">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="4502.2637">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="4517.5742">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="163" y="4532.8848">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="4548.1953">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="4563.5059">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="4578.8164">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="4594.127">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="4609.4375">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4624.748">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4640.0586">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="4655.3691">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="4670.6797">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="4685.9902">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="4701.3008">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="179" y="4716.6113">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="179" y="4731.9219">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="4747.2324">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="4762.543">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="4777.8535">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="4793.1641">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="4808.4746">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="4823.7852">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="4839.0957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="4854.4063">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4869.7168">}</text><polygon fill="#A80036" points="710,4903.7695,720,4907.7695,710,4911.7695,714,4907.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="716" y1="4907.7695" y2="4907.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="4903.0273">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="149.5" y="4903.0273">Publish to Bulk Processing topic</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="804.5" y1="4946.7695" y2="4946.7695"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="48" y="4957.4043">[transferStateId == 'RESERVED']</text><path d="M125,4965.7246 L125,5449.7246 L525,5449.7246 L525,4975.7246 L515,4965.7246 L125,4965.7246 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,4965.7246 L515,4975.7246 L525,4975.7246 L515,4965.7246 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="131" y="4983.293">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="4998.6035">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="5013.9141"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="147" y="5013.9141">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="159" y="5013.9141">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="147" y="5029.2246"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="147" y="5029.2246">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="208" y="5029.2246">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="147" y="5044.5352">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="147" y="5059.8457">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="147" y="5075.1563">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="147" y="5090.4668">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="163" y="5105.7773">headers: &lt;bulkTransferHeaders&gt;,,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="5121.0879">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="179" y="5136.3984">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="195" y="5151.709">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="195" y="5167.0195">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="195" y="5182.3301">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="5197.6406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="5212.9512">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="5228.2617">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="147" y="5243.5723">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="163" y="5258.8828">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="179" y="5274.1934">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="179" y="5289.5039">type: bulk-position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="179" y="5304.8145">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="179" y="5320.125">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="179" y="5335.4355">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="195" y="5350.7461">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="195" y="5366.0566">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="195" y="5381.3672">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="5396.6777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="5411.9883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="5427.2988">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="5442.6094">}</text><polygon fill="#A80036" points="341.5,5476.6621,351.5,5480.6621,341.5,5484.6621,345.5,5480.6621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120.5" x2="347.5" y1="5480.6621" y2="5480.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="127.5" y="5475.9199">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="149.5" y="5475.9199">Route &amp; Publish Position event</text><!--
@startuml
title 3.1.1. Timeout Handler Consume (incl. Bulk Transfer)

autonumber


control "Transfer Timeout\nHandler" as TIMEOUT_HANDLER
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nnotification" as NOTIFICATIONS_TOPIC
collections "topic-event" as EVENT_TOPIC
collections "topic-\nbulk-processing" as BULK_PROCESSING_TOPIC
entity "Segment DAO" as SEGMENT_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant BULK_PROCESSING_TOPIC
    participant POS_DAO
    participant SEGMENT_DAO
    participant DB
end box


group Timeout Handler Consume
    activate TIMEOUT_HANDLER
    group Persist Event Information
        TIMEOUT_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_HANDLER, EVENT_TOPIC :  Event Handler Consume\n
    end

    group Get previous checkpoint of last record processed (Lower limit for inclusion)
        TIMEOUT_HANDLER -> SEGMENT_DAO: Get last segment as @intervalMin
        activate SEGMENT_DAO
        SEGMENT_DAO -> DB: Get last segment as @intervalMin
        hnote over DB #lightyellow
            SELECT value INTO @intervalMin
            FROM **segment**
            WHERE segmentType = 'timeout'
            AND enumeration = 0
            AND tableName = 'transferStateChange'
        end note
        activate DB
        DB - -> SEGMENT_DAO: Return @intervalMin
        deactivate DB
        SEGMENT_DAO - -> TIMEOUT_HANDLER: Return @intervalMin
        deactivate SEGMENT_DAO
        opt @intervalMin IS NULL => segment record NOT FOUND
            TIMEOUT_HANDLER->TIMEOUT_HANDLER: Set @intervalMin = 0
        end
    end

    group Do Cleanup
        TIMEOUT_HANDLER -> POS_DAO: Clean up transferTimeout from finalised transfers
        activate POS_DAO
        POS_DAO -> DB: Clean up transferTimeout from finalised transfers
        hnote over DB #lightyellow
            DELETE tt
            FROM **transferTimeout** AS tt
            JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId
                  FROM **transferTimeout** tt1
                  JOIN **transferStateChange** tsc
                  ON tsc.transferId = tt1.transferId
                  GROUP BY transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'
                , 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')
        end note
        activate DB
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return success
        deactivate POS_DAO
    end

    group Determine IntervalMax (Upper limit for inclusion)
        TIMEOUT_HANDLER -> POS_DAO: Get last transferStateChangeId as @intervalMax
        activate POS_DAO
        POS_DAO -> DB: Get last transferStateChangeId as @intervalMax
        hnote over DB #lightyellow
            SELECT MAX(transferStateChangeId) INTO @intervalMax
            FROM **transferStateChange**
        end note
        activate DB
        DB - -> POS_DAO: Return @intervalMax
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return @intervalMax
        deactivate POS_DAO
    end

    
    group Prepare data and return the list for expiration
        TIMEOUT_HANDLER -> POS_DAO: Prepare data and get transfers to be expired
        activate POS_DAO
        group <color #blue>DB TRANSACTION</color>
            POS_DAO <-> POS_DAO: **transactionTimestamp** = now()
            POS_DAO -> DB: Insert all new transfers still in processing state
            hnote over DB #lightyellow
                INSERT INTO **transferTimeout**(transferId, expirationDate)
                SELECT t.transferId, t.expirationDate
                FROM **transfer** t
                JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange**
                      WHERE transferStateChangeId > @intervalMin
                      AND transferStateChangeId <= @intervalMax
                      GROUP BY transferId) ts
                ON ts.transferId = t.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state ABORTED for\nexpired RECEIVED_PREPARE transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN ( <color #FF0000>- - Following subquery is reused 3 times and may be optimized if needed</color>
                      SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RECEIVED_PREPARE'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state EXPIRED for\nexpired RESERVED transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RESERVED'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Update segment table to be used for the next run
            hnote over DB #lightyellow
                IF @intervalMin = 0
                    INSERT
                    INTO **segment**(segmentType, enumeration, tableName, value)
                    VALUES ('timeout', 0, 'transferStateChange', @intervalMax)
                ELSE
                    UPDATE **segment**
                    SET value = @intervalMax
                    WHERE segmentType = 'timeout'
                    AND enumeration = 0
                    AND tableName = 'transferStateChange'
            end note
            activate DB
            deactivate DB
        end

        POS_DAO -> DB: Get list of transfers to be expired with current state
        hnote over DB #lightyellow
            SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId, 
                    tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId
            FROM **transferTimeout** tt
            JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                    FROM **transferStateChange** tsc1
                    JOIN **transferTimeout** tt1
                    ON tt1.transferId = tsc1.transferId
                    GROUP BY tsc1.transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            JOIN **transferParticipant** tp1
            ON tp1.transferId = tt.transferId
            AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}
            AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            JOIN **transferParticipant** tp2
            ON tp2.transferId = tt.transferId
            AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}
            AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            LEFT JOIN **bulkTransferAssociation** bta
            ON bta.transferId = tt.transferId
            WHERE tt.expirationDate < {transactionTimestamp}
        end note
        activate DB
        POS_DAO <- - DB: Return **transferTimeoutList**
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return **transferTimeoutList**
        deactivate POS_DAO
    end

    loop for each transfer in the list
        |||
        alt transferTimeoutList.bulkTransferId == NULL (Regular Transfer)
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: notification,
                                action: timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> NOTIFICATIONS_TOPIC: Publish Notification event
                activate NOTIFICATIONS_TOPIC
                deactivate NOTIFICATIONS_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: position,
                                action: timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        else Individual Transfer from a Bulk
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: bulk-processing,
                                action: timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> BULK_PROCESSING_TOPIC: Publish to Bulk Processing topic
                activate BULK_PROCESSING_TOPIC
                deactivate BULK_PROCESSING_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: bulk-position,
                                action: timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        end
    end

    deactivate TIMEOUT_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>