<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2178px" preserveAspectRatio="none" style="width:1455px;height:2178px;" version="1.1" viewBox="0 0 1455 2178" width="1455px" zoomAndPan="magnify"><defs><filter height="300%" id="fg96u7s42g03v" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="559" x="449" y="23.5352">5.2.1. Record Funds Out - Prepare &amp; Reserve (recordFundsOutPrepareReserve)</text><rect fill="#FFB6C1" height="2133.168" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="2133.168" style="stroke: #A80036; stroke-width: 1.0;" width="917" x="324" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="732" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="1923.8809" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="922.1113" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="945" y="1134.0566"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1184" y="1672.8887"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="1909.8809" style="stroke: #000000; stroke-width: 2.0;" width="1431" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="878.8008" style="stroke: #000000; stroke-width: 2.0;" width="563.5" x="870.5" y="1149.0566"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="118.5527" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="890.5" y="1173.3672"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="225.7266" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="890.5" y="1305.9199"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="450.2109" style="stroke: #000000; stroke-width: 2.0;" width="543.5" x="880.5" y="1570.6465"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="379.5898" style="stroke: #000000; stroke-width: 2.0;" width="523.5" x="890.5" y="1634.2676"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="2081.168"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="382" x2="382" y1="137.2871" y2="2081.168"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="610.5" x2="610.5" y1="137.2871" y2="2081.168"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="809" x2="809" y1="137.2871" y2="2081.168"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="949.5" x2="949.5" y1="137.2871" y2="2081.168"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1189" x2="1189" y1="137.2871" y2="2081.168"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="2093.7031">Hub Employee</text><ellipse cx="75" cy="2106.6563" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,2114.6563 L75,2141.6563 M62,2122.6563 L88,2122.6563 M75,2141.6563 L62,2156.6563 M75,2141.6563 L88,2156.6563 " fill="none" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="134.334">Admin API</text><path d="M361.5,76.3105 L361.5,100.3105 M361.5,88.3105 L378.5,88.3105 " fill="none" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="88.3105" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="328" y="2093.7031">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="345.5" y="2110.1914">Admin API</text><path d="M361.5,2117.1445 L361.5,2141.1445 M361.5,2129.1445 L378.5,2129.1445 " fill="none" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="390.5" cy="2129.1445" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fg96u7s42g03v)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#fg96u7s42g03v)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fg96u7s42g03v)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="525.5" y="2080.168"/><rect fill="#FEFECE" filter="url(#fg96u7s42g03v)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="521.5" y="2084.168"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="528.5" y="2104.7031">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="134.334">Admin Event Handler</text><ellipse cx="809" cy="104.7988" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,92.7988,811,87.7988,809,92.7988,811,97.7988,805,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="734" y="2093.7031">Admin Event Handler</text><ellipse cx="809" cy="2112.6563" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="805,2100.6563,811,2095.6563,809,2100.6563,811,2105.6563,805,2100.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="900.5" y="134.334">Transfer DAO</text><ellipse cx="950" cy="104.7988" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="938" x2="962" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="900.5" y="2093.7031">Transfer DAO</text><ellipse cx="950" cy="2112.6563" fill="#FEFECE" filter="url(#fg96u7s42g03v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="938" x2="962" y1="2126.6563" y2="2126.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1141" y="134.334">Central Store</text><path d="M1171,84.7988 C1171,74.7988 1189,74.7988 1189,74.7988 C1189,74.7988 1207,74.7988 1207,84.7988 L1207,110.7988 C1207,120.7988 1189,120.7988 1189,120.7988 C1189,120.7988 1171,120.7988 1171,110.7988 L1171,84.7988 " fill="#FEFECE" filter="url(#fg96u7s42g03v)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1171,84.7988 C1171,94.7988 1189,94.7988 1189,94.7988 C1189,94.7988 1207,94.7988 1207,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1141" y="2093.7031">Central Store</text><path d="M1171,2106.6563 C1171,2096.6563 1189,2096.6563 1189,2096.6563 C1189,2096.6563 1207,2096.6563 1207,2106.6563 L1207,2132.6563 C1207,2142.6563 1189,2142.6563 1189,2142.6563 C1189,2142.6563 1171,2142.6563 1171,2132.6563 L1171,2106.6563 " fill="#FEFECE" filter="url(#fg96u7s42g03v)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1171,2106.6563 C1171,2116.6563 1189,2116.6563 1189,2116.6563 C1189,2116.6563 1207,2116.6563 1207,2106.6563 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="377" y="507.8086"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606" y="913.2617"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="1923.8809" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="804" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="922.1113" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="945" y="1134.0566"/><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1184" y="1672.8887"/><path d="M13,154.2871 L320,154.2871 L320,161.2871 L310,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1909.8809" style="stroke: #000000; stroke-width: 2.0;" width="1431" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="28" y="167.8555">Record Funds Out - Prepare &amp; Reserve</text><path d="M80,176.5977 L80,476.5977 L383,476.5977 L383,186.5977 L373,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M373,176.5977 L373,186.5977 L383,186.5977 L373,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="102" y="209.4766">"transferId": &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="102" y="224.7871">"externalReference": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="102" y="240.0977">"action": "recordFundsOutPrepareReserve",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="102" y="255.4082">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="118" y="270.7188">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="118" y="286.0293">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="90" y="301.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="102" y="316.6504">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="102" y="331.9609">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="347.2715">"extensionList": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="118" y="362.582">"extension": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="150" y="393.2031">"key": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="150" y="408.5137">"value": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="423.8242">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="102" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="469.7559">}</text><polygon fill="#A80036" points="365,503.8086,375,507.8086,365,511.8086,369,507.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="371" y1="507.8086" y2="507.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="503.0664">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="95" y="503.0664">POST - /participants/{name}/accounts/{id}</text><path d="M392,520.8086 L392,866.8086 L717,866.8086 L717,530.8086 L707,520.8086 L392,520.8086 " fill="#FFFF00" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M707,520.8086 L707,530.8086 L717,530.8086 L707,520.8086 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="398" y="538.377">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="553.6875">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="414" y="568.998">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="414" y="584.3086">from: "Hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="414" y="599.6191">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="414" y="614.9297">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="414" y="630.2402">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="430" y="645.5508">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="430" y="660.8613">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="676.1719">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="414" y="691.4824">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="430" y="706.793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="446" y="722.1035">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="446" y="737.4141">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="446" y="752.7246">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="446" y="768.0352">action: "recordFundsOutPrepareReserve",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="446" y="783.3457">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="446" y="798.6563">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="813.9668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="414" y="829.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="414" y="844.5879">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="398" y="859.8984">}</text><polygon fill="#A80036" points="594,909.2617,604,913.2617,594,917.2617,598,913.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="387" x2="600" y1="913.2617" y2="913.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="394" y="900.8643">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="407" y="893.209">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407" y="908.5195">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484" y="908.5195">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="658" y1="973.1934" y2="973.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="658" x2="658" y1="973.1934" y2="986.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="658" y1="986.1934" y2="986.1934"/><polygon fill="#A80036" points="627,982.1934,617,986.1934,627,990.1934,623,986.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="623" y="953.1406">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="636" y="937.8301">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="636" y="953.1406">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="636" y="968.4512">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="713" y="968.4512">2003</text><polygon fill="#A80036" points="398,1026.8145,388,1030.8145,398,1034.8145,394,1030.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="392" x2="610" y1="1030.8145" y2="1030.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="404" y="1018.417">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="417" y="1010.7617">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="417" y="1026.0723">have been received</text><polygon fill="#A80036" points="86,1056.125,76,1060.125,86,1064.125,82,1060.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="381" y1="1060.125" y2="1060.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="1055.3828">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="1055.3828">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="622,1085.4355,612,1089.4355,622,1093.4355,618,1089.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="616" x2="803" y1="1089.4355" y2="1089.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="628" y="1084.6934">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="641" y="1084.6934">Consume message</text><polygon fill="#A80036" points="933,1130.0566,943,1134.0566,933,1138.0566,937,1134.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="814" x2="939" y1="1134.0566" y2="1134.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="821" y="1121.6592">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="834" y="1114.0039">Prepare transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="834" y="1129.3145">and reserve</text><path d="M870.5,1149.0566 L1035.5,1149.0566 L1035.5,1156.0566 L1025.5,1166.0566 L870.5,1166.0566 L870.5,1149.0566 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="878.8008" style="stroke: #000000; stroke-width: 2.0;" width="563.5" x="870.5" y="1149.0566"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="885.5" y="1162.625">DB TRANSACTION</text><path d="M890.5,1173.3672 L1148.5,1173.3672 L1148.5,1180.3672 L1138.5,1190.3672 L890.5,1190.3672 L890.5,1173.3672 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="118.5527" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="890.5" y="1173.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="213" x="905.5" y="1186.9355">Reconciliation Transfer Prepare</text><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="71.2422" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="897.5" y="1215.6777"/><polygon fill="#EEEEEE" points="897.5,1215.6777,961.5,1215.6777,961.5,1222.6777,951.5,1232.6777,897.5,1232.6777,897.5,1215.6777" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="910.5" y="1230.2461">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="967.75" y="1249.2461">reconciliationTransferPrepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="967.75" y="1264.5566">(payload, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="971.75" y="1279.8672"/><path d="M890.5,1305.9199 L1149.5,1305.9199 L1149.5,1312.9199 L1139.5,1322.9199 L890.5,1322.9199 L890.5,1305.9199 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="225.7266" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="890.5" y="1305.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="214" x="905.5" y="1319.4883">Reconciliation Transfer Reserve</text><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="178.416" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="897.5" y="1348.2305"/><polygon fill="#EEEEEE" points="897.5,1348.2305,961.5,1348.2305,961.5,1355.2305,951.5,1365.2305,897.5,1365.2305,897.5,1348.2305" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="910.5" y="1362.7988">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="217" x="942.75" y="1381.7988">transferStateAndPositionUpdate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="942.75" y="1397.1094">({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="958.75" y="1412.4199">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="958.75" y="1427.7305">transferStateId: "RESERVED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="958.75" y="1443.041">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="958.75" y="1458.3516">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="958.75" y="1473.6621">drUpdated: true,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="958.75" y="1488.9727">crUpdated: false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="942.75" y="1504.2832">}, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="946.75" y="1519.5938"/><path d="M880.5,1570.6465 L947.5,1570.6465 L947.5,1577.6465 L937.5,1587.6465 L880.5,1587.6465 L880.5,1570.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="450.2109" style="stroke: #000000; stroke-width: 2.0;" width="543.5" x="880.5" y="1570.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="895.5" y="1584.2148">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="299" x="962.5" y="1583.2813">[transferStateAndPositionUpdate.crPositionValue &gt; 0]</text><path d="M960,1592.957 L960,1617.957 L1310,1617.957 L1310,1602.957 L1300,1592.957 L960,1592.957 " fill="#D3D3D3" filter="url(#fg96u7s42g03v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1300,1592.957 L1300,1602.957 L1310,1602.957 L1300,1592.957 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="966" y="1610.5254">payload.reason = 'Aborted due to insufficient funds'</text><path d="M890.5,1634.2676 L1133.5,1634.2676 L1133.5,1641.2676 L1123.5,1651.2676 L890.5,1651.2676 L890.5,1634.2676 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="379.5898" style="stroke: #000000; stroke-width: 2.0;" width="523.5" x="890.5" y="1634.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="905.5" y="1647.8359">Reconciliation Transfer Abort</text><polygon fill="#A80036" points="1172,1668.8887,1182,1672.8887,1172,1676.8887,1176,1672.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="955" x2="1178" y1="1672.8887" y2="1672.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="962" y="1668.1465">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="975" y="1668.1465">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#fg96u7s42g03v)" points="983,1715.8887,1394,1715.8887,1404,1757.8887,1394,1799.8887,983,1799.8887,973,1757.8887,983,1715.8887" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="985" y="1732.457">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1069" y="1732.457">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="1001" y="1747.7676">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="1001" y="1763.0781">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="985" y="1778.3887">VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1001" y="1793.6992">1, NULL, {transactionTimestamp})</text><rect fill="#FFFFFF" filter="url(#fg96u7s42g03v)" height="178.416" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="897.5" y="1830.4414"/><polygon fill="#EEEEEE" points="897.5,1830.4414,961.5,1830.4414,961.5,1837.4414,951.5,1847.4414,897.5,1847.4414,897.5,1830.4414" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="910.5" y="1845.0098">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="217" x="942.75" y="1864.0098">transferStateAndPositionUpdate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="942.75" y="1879.3203">({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="958.75" y="1894.6309">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="958.75" y="1909.9414">transferStateId: "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="958.75" y="1925.252">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="958.75" y="1940.5625">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="958.75" y="1955.873">drUpdated: true,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="958.75" y="1971.1836">crUpdated: false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="942.75" y="1986.4941">}, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="946.75" y="2001.8047"/><polygon fill="#A80036" points="825,2052.168,815,2056.168,825,2060.168,821,2056.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="819" x2="949" y1="2056.168" y2="2056.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831" y="2051.4258">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="844" y="2051.4258">Finished await</text><!--
@startuml
title 5.2.1. Record Funds Out - Prepare & Reserve (recordFundsOutPrepareReserve)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out - Prepare & Reserve
    note right of OPERATOR #yellow
        {
            "transferId": <uuid>,
            "externalReference": "string",
            "action": "recordFundsOutPrepareReserve",
            "amount": {
                "amount": <decimal>,
                "currency": "string"

            },
            "reason": "string",
            "extensionList": {
                "extension": [
                    {
                        "key": "string",
                        "value": "string"
                    }
                ]
            }
        }
    end note
    OPERATOR -> CS_ADMIN_API: POST - /participants/{name}/accounts/{id}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "Hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutPrepareReserve",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Prepare transfer\nand reserve
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Prepare
            |||
            ref over TRANSFER_DAO, DB: **reconciliationTransferPrepare**\n(payload, trx)\n
        end

        group Reconciliation Transfer Reserve
            |||
            ref over TRANSFER_DAO, DB: **transferStateAndPositionUpdate**\n({\n    transferId: {payload.transferId},\n    transferStateId: "RESERVED",\n    reason: {payload.reason},\n    createdDate: {transactionTimestamp},\n    drUpdated: true,\n    crUpdated: false\n}, trx)\n
        end

        |||
        opt transferStateAndPositionUpdate.crPositionValue > 0
            note right of TRANSFER_DAO #lightgray
                payload.reason = 'Aborted due to insufficient funds'
            end note

            group Reconciliation Transfer Abort
                TRANSFER_DAO -> DB: Insert transferFulfilment record
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    INSERT INTO **transferFulfilment**
                        (transferFulfilmentId, transferId, ilpFulfilment,
                        completedDate, isValid, settlementWindowId, createdDate)
                    VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},
                        1, NULL, {transactionTimestamp})
                end hnote
                |||
                ref over TRANSFER_DAO, DB: **transferStateAndPositionUpdate**\n({\n    transferId: {payload.transferId},\n    transferStateId: "ABORTED",\n    reason: {payload.reason},\n    createdDate: {transactionTimestamp},\n    drUpdated: true,\n    crUpdated: false\n}, trx)\n
            end
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>