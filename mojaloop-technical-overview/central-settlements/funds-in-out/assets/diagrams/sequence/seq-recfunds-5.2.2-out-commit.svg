<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1481px" preserveAspectRatio="none" style="width:1465px;height:1481px;" version="1.1" viewBox="0 0 1465 1481" width="1465px" zoomAndPan="magnify"><defs><filter height="300%" id="fwkd24kj0zhmd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="421" x="523" y="23.5352">5.2.2. Record Funds Out Commit (recordFundsOutCommit)</text><rect fill="#FFB6C1" height="1435.6094" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="1435.6094" style="stroke: #A80036; stroke-width: 1.0;" width="921" x="296" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="706" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="1226.3223" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="454.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="921" y="904.3984"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1160" y="982.3301"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="1212.3223" style="stroke: #000000; stroke-width: 2.0;" width="1441" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="410.9004" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="856.5" y="919.3984"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="379.5898" style="stroke: #000000; stroke-width: 2.0;" width="567.5" x="866.5" y="943.709"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="1383.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="354" x2="354" y1="137.2871" y2="1383.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="582.5" x2="582.5" y1="137.2871" y2="1383.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781" x2="781" y1="137.2871" y2="1383.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="925.5" x2="925.5" y1="137.2871" y2="1383.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1165" x2="1165" y1="137.2871" y2="1383.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="1396.1445">Hub Employee</text><ellipse cx="75" cy="1409.0977" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,1417.0977 L75,1444.0977 M62,1425.0977 L88,1425.0977 M75,1444.0977 L62,1459.0977 M75,1444.0977 L88,1459.0977 " fill="none" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="134.334">Admin API</text><path d="M333.5,76.3105 L333.5,100.3105 M333.5,88.3105 L350.5,88.3105 " fill="none" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="88.3105" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="1396.1445">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="1412.6328">Admin API</text><path d="M333.5,1419.5859 L333.5,1443.5859 M333.5,1431.5859 L350.5,1431.5859 " fill="none" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="1431.5859" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="1382.6094"/><rect fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="1386.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="1407.1445">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="134.334">Admin Event Handler</text><ellipse cx="781" cy="104.7988" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,92.7988,783,87.7988,781,92.7988,783,97.7988,777,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="1396.1445">Admin Event Handler</text><ellipse cx="781" cy="1415.0977" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,1403.0977,783,1398.0977,781,1403.0977,783,1408.0977,777,1403.0977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="876.5" y="134.334">Transfer DAO</text><ellipse cx="926" cy="104.7988" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="914" x2="938" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="876.5" y="1396.1445">Transfer DAO</text><ellipse cx="926" cy="1415.0977" fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="914" x2="938" y1="1429.0977" y2="1429.0977"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1117" y="134.334">Central Store</text><path d="M1147,84.7988 C1147,74.7988 1165,74.7988 1165,74.7988 C1165,74.7988 1183,74.7988 1183,84.7988 L1183,110.7988 C1183,120.7988 1165,120.7988 1165,120.7988 C1165,120.7988 1147,120.7988 1147,110.7988 L1147,84.7988 " fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1147,84.7988 C1147,94.7988 1165,94.7988 1165,94.7988 C1165,94.7988 1183,94.7988 1183,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1117" y="1396.1445">Central Store</text><path d="M1147,1409.0977 C1147,1399.0977 1165,1399.0977 1165,1399.0977 C1165,1399.0977 1183,1399.0977 1183,1409.0977 L1183,1435.0977 C1183,1445.0977 1165,1445.0977 1165,1445.0977 C1165,1445.0977 1147,1445.0977 1147,1435.0977 L1147,1409.0977 " fill="#FEFECE" filter="url(#fwkd24kj0zhmd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1147,1409.0977 C1147,1419.0977 1165,1419.0977 1165,1419.0977 C1165,1419.0977 1183,1419.0977 1183,1409.0977 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="1226.3223" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="454.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="921" y="904.3984"/><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1160" y="982.3301"/><path d="M13,154.2871 L235,154.2871 L235,161.2871 L225,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1212.3223" style="stroke: #000000; stroke-width: 2.0;" width="1441" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="28" y="167.8555">Record Funds Out Commit</text><path d="M80,176.5977 L80,247.5977 L339,247.5977 L339,186.5977 L329,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M329,176.5977 L329,186.5977 L339,186.5977 L329,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="102" y="209.4766">"action": "recordFundsOutCommit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="224.7871">"reason": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="240.0977">}</text><polygon fill="#A80036" points="337,289.4609,347,293.4609,337,297.4609,341,293.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="343" y1="293.4609" y2="293.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="281.0635">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="95" y="273.4082">PUT - /participants/{name}/accounts/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="139" y="288.7188">{id}/transfers/{transferId}</text><path d="M364,306.4609 L364,652.4609 L645,652.4609 L645,316.4609 L635,306.4609 L364,306.4609 " fill="#FFFF00" filter="url(#fwkd24kj0zhmd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M635,306.4609 L635,316.4609 L645,316.4609 L635,306.4609 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="370" y="324.0293">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="339.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="386" y="354.6504">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="386" y="369.9609">from: "Hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="386" y="385.2715">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="386" y="400.582">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="386" y="415.8926">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="402" y="431.2031">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="402" y="446.5137">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="461.8242">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="386" y="477.1348">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="402" y="492.4453">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="418" y="507.7559">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="418" y="523.0664">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="418" y="538.377">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="418" y="553.6875">action: "recordFundsOutCommit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="418" y="568.998">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="418" y="584.3086">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="402" y="599.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="614.9297">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="386" y="630.2402">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="645.5508">}</text><polygon fill="#A80036" points="566,694.9141,576,698.9141,566,702.9141,570,698.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359" x2="572" y1="698.9141" y2="698.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="366" y="686.5166">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="379" y="678.8613">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="379" y="694.1719">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="456" y="694.1719">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="630" y1="758.8457" y2="758.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="630" x2="630" y1="758.8457" y2="771.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="589" x2="630" y1="771.8457" y2="771.8457"/><polygon fill="#A80036" points="599,767.8457,589,771.8457,599,775.8457,595,771.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="738.793">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="608" y="723.4824">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="608" y="738.793">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="608" y="754.1035">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="685" y="754.1035">2003</text><polygon fill="#A80036" points="370,812.4668,360,816.4668,370,820.4668,366,816.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="364" x2="582" y1="816.4668" y2="816.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="376" y="804.0693">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="389" y="796.4141">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="389" y="811.7246">have been received</text><polygon fill="#A80036" points="86,841.7773,76,845.7773,86,849.7773,82,845.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="353" y1="845.7773" y2="845.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="841.0352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="841.0352">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="594,871.0879,584,875.0879,594,879.0879,590,875.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="775" y1="875.0879" y2="875.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="600" y="870.3457">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="613" y="870.3457">Consume message</text><polygon fill="#A80036" points="909,900.3984,919,904.3984,909,908.3984,913,904.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786" x2="915" y1="904.3984" y2="904.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="793" y="899.6563">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="806" y="899.6563">Commit transfer</text><path d="M856.5,919.3984 L1021.5,919.3984 L1021.5,926.3984 L1011.5,936.3984 L856.5,936.3984 L856.5,919.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="410.9004" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="856.5" y="919.3984"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="871.5" y="932.9668">DB TRANSACTION</text><path d="M866.5,943.709 L1123.5,943.709 L1123.5,950.709 L1113.5,960.709 L866.5,960.709 L866.5,943.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="379.5898" style="stroke: #000000; stroke-width: 2.0;" width="567.5" x="866.5" y="943.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="881.5" y="957.2773">Reconciliation Transfer Commit</text><polygon fill="#A80036" points="1148,978.3301,1158,982.3301,1148,986.3301,1152,982.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="931" x2="1154" y1="982.3301" y2="982.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="938" y="977.5879">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="951" y="977.5879">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#fwkd24kj0zhmd)" points="915,1025.3301,1414,1025.3301,1424,1067.3301,1414,1109.3301,915,1109.3301,905,1067.3301,915,1025.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="917" y="1041.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1001" y="1041.8984">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="933" y="1057.209">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="933" y="1072.5195">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="917" y="1087.8301">VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="933" y="1103.1406">1, NULL, {transactionTimestamp})</text><rect fill="#FFFFFF" filter="url(#fwkd24kj0zhmd)" height="178.416" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="873.5" y="1139.8828"/><polygon fill="#EEEEEE" points="873.5,1139.8828,937.5,1139.8828,937.5,1146.8828,927.5,1156.8828,873.5,1156.8828,873.5,1139.8828" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="886.5" y="1154.4512">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="217" x="918.75" y="1173.4512">transferStateAndPositionUpdate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="918.75" y="1188.7617">({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="934.75" y="1204.0723">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="934.75" y="1219.3828">transferStateId: "COMMITTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="934.75" y="1234.6934">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="934.75" y="1250.0039">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="934.75" y="1265.3145">drUpdated: false,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="934.75" y="1280.625">crUpdated: true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="918.75" y="1295.9355">}, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="922.75" y="1311.2461"/><polygon fill="#A80036" points="797,1354.6094,787,1358.6094,797,1362.6094,793,1358.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="791" x2="925" y1="1358.6094" y2="1358.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="803" y="1353.8672">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="816" y="1353.8672">Finished await</text><!--
@startuml
title 5.2.2. Record Funds Out Commit (recordFundsOutCommit)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out Commit
    note right of OPERATOR #yellow
        {
            "action": "recordFundsOutCommit",
            "reason": "string"
        }
    end note
    OPERATOR -> CS_ADMIN_API: PUT - /participants/{name}/accounts/\n           {id}/transfers/{transferId}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "Hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutCommit",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Commit transfer
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Commit
            TRANSFER_DAO -> DB: Insert transferFulfilment record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment**
                    (transferFulfilmentId, transferId, ilpFulfilment,
                    completedDate, isValid, settlementWindowId, createdDate)
                VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},
                    1, NULL, {transactionTimestamp})
            end hnote
            |||
            ref over TRANSFER_DAO, DB: **transferStateAndPositionUpdate**\n({\n    transferId: {payload.transferId},\n    transferStateId: "COMMITTED",\n    reason: {payload.reason},\n    createdDate: {transactionTimestamp},\n    drUpdated: false,\n    crUpdated: true\n}, trx)\n
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>