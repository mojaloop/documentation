<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1336px" preserveAspectRatio="none" style="width:656px;height:1336px;" version="1.1" viewBox="0 0 656 1336" width="656px" zoomAndPan="magnify"><defs><filter height="300%" id="f1xdekkn052pgd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="503" x="77" y="23.5352">5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)</text><rect fill="#FFFFE0" height="1291.2852" style="stroke: #A80036; stroke-width: 1.0;" width="386.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="161.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="279.8398"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="449.0137"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="787.6953"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1033.4219"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1171.9746"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="1109.998" style="stroke: #000000; stroke-width: 2.0;" width="631" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="141.5078" style="stroke: #000000; stroke-width: 2.0;" width="332" x="67" y="617.877"/><rect fill="#FFFFFF" height="69.5762" style="stroke: none; stroke-width: 1.0;" width="332" x="67" y="689.8086"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="72" x2="72" y1="116.2871" y2="1260.2852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="353.5" x2="353.5" y1="116.2871" y2="1260.2852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="113.334">Transfer DAO</text><ellipse cx="72.5" cy="83.7988" fill="#FEFECE" filter="url(#f1xdekkn052pgd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="60.5" x2="84.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="1272.8203">Transfer DAO</text><ellipse cx="72.5" cy="1291.7734" fill="#FEFECE" filter="url(#f1xdekkn052pgd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="60.5" x2="84.5" y1="1305.7734" y2="1305.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="305.5" y="113.334">Central Store</text><path d="M335.5,63.7988 C335.5,53.7988 353.5,53.7988 353.5,53.7988 C353.5,53.7988 371.5,53.7988 371.5,63.7988 L371.5,89.7988 C371.5,99.7988 353.5,99.7988 353.5,99.7988 C353.5,99.7988 335.5,99.7988 335.5,89.7988 L335.5,63.7988 " fill="#FEFECE" filter="url(#f1xdekkn052pgd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M335.5,63.7988 C335.5,73.7988 353.5,73.7988 353.5,73.7988 C353.5,73.7988 371.5,73.7988 371.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="305.5" y="1272.8203">Central Store</text><path d="M335.5,1285.7734 C335.5,1275.7734 353.5,1275.7734 353.5,1275.7734 C353.5,1275.7734 371.5,1275.7734 371.5,1285.7734 L371.5,1311.7734 C371.5,1321.7734 353.5,1321.7734 353.5,1321.7734 C353.5,1321.7734 335.5,1321.7734 335.5,1311.7734 L335.5,1285.7734 " fill="#FEFECE" filter="url(#f1xdekkn052pgd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M335.5,1285.7734 C335.5,1295.7734 353.5,1295.7734 353.5,1295.7734 C353.5,1295.7734 371.5,1295.7734 371.5,1285.7734 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="279.8398"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="449.0137"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="787.6953"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1033.4219"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="348.5" y="1171.9746"/><path d="M13,133.2871 L354,133.2871 L354,140.2871 L344,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1109.998" style="stroke: #000000; stroke-width: 2.0;" width="631" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="296" x="28" y="146.8555">reconciliationTransferPrepare (payload, trx)</text><polygon fill="#A80036" points="336.5,167.9082,346.5,171.9082,336.5,175.9082,340.5,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="92.5" y="167.166">Insert transferDuplicateCheck</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="82,214.9082,624,214.9082,634,233.9082,624,252.9082,82,252.9082,72,233.9082,82,214.9082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="84" y="231.4766">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="168" y="231.4766">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="331" y="231.4766">(transferId, hash, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="538" x="84" y="246.7871">VALUES ({payload.transferId}, hashCode({payload.transferId}), {transactionTimestamp})</text><polygon fill="#A80036" points="336.5,275.8398,346.5,279.8398,336.5,283.8398,340.5,279.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="279.8398" y2="279.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="275.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="92.5" y="275.0977">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="143,322.8398,563,322.8398,573,371.8398,563,421.8398,143,421.8398,133,371.8398,143,322.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="145" y="339.4082">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="229" y="339.4082">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="287" y="339.4082">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="161" y="354.7188">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="145" y="370.0293">VALUES ({payload.transferId}, {payload.amount.amount},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="161" y="385.3398">{payload.amount.curency}, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="161" y="400.6504">{new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="161" y="415.9609">{transactionTimestamp})</text><polygon fill="#A80036" points="336.5,445.0137,346.5,449.0137,336.5,453.0137,340.5,449.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="449.0137" y2="449.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="444.2715">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="92.5" y="444.2715">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="172,492.0137,535,492.0137,545,534.0137,535,576.0137,172,576.0137,162,534.0137,172,492.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="174" y="508.582">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="174" y="523.8926">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="214" y="523.8926">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="174" y="539.2031">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="554.5137">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="174" y="569.8242">LIMIT 1</text><polygon fill="#A80036" points="83.5,598.877,73.5,602.877,83.5,606.877,79.5,602.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="77.5" x2="352.5" y1="602.877" y2="602.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="89.5" y="598.1348">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="102.5" y="598.1348">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="147.5" y="598.1348">reconciliationAccountId</text><path d="M67,617.877 L129,617.877 L129,624.877 L119,634.877 L67,634.877 L67,617.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="141.5078" style="stroke: #000000; stroke-width: 2.0;" width="332" x="67" y="617.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="82" y="631.4453">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="144" y="630.5117">[payload.action == 'RECORD_FUNDS_IN']</text><path d="M77,640.1875 L77,680.1875 L372,680.1875 L372,650.1875 L362,640.1875 L77,640.1875 " fill="#D3D3D3" filter="url(#f1xdekkn052pgd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M362,640.1875 L362,650.1875 L372,650.1875 L362,640.1875 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="83" y="657.7559">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="214" y="657.7559">= 'RECORD_FUNDS_IN'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="83" y="673.0664">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="139" y="673.0664">=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="153" y="673.0664">payload.amount.amount</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="67" x2="399" y1="690.8086" y2="690.8086"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="72" y="701.4434">[payload.action == 'RECORD_FUNDS_OUT_PREPARE']</text><path d="M77,709.7637 L77,749.7637 L385,749.7637 L385,719.7637 L375,709.7637 L77,709.7637 " fill="#D3D3D3" filter="url(#f1xdekkn052pgd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M375,709.7637 L375,719.7637 L385,719.7637 L375,709.7637 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="83" y="727.332">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="214" y="727.332">= 'RECORD_FUNDS_OUT'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="83" y="742.6426">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="139" y="742.6426">=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="153" y="742.6426">-payload.amount.amount</text><polygon fill="#A80036" points="336.5,783.6953,346.5,787.6953,336.5,791.6953,340.5,787.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="787.6953" y2="787.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="782.9531">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="92.5" y="782.9531">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="92,830.6953,614,830.6953,624,918.6953,614,1006.6953,92,1006.6953,82,918.6953,92,830.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="94" y="847.2637">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="178" y="847.2637">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="110" y="862.5742">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="110" y="877.8848">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="94" y="893.1953">VALUES (payload.transferId, reconciliationAccountId, 'HUB',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="110" y="908.5059">{ledgerEntryTypeId}, {amount}, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="98" y="923.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="94" y="939.127">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="178" y="939.127">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="110" y="954.4375">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="110" y="969.748">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="94" y="985.0586">VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="110" y="1000.3691">{ledgerEntryTypeId}, {-amount}, {transactionTimestamp})</text><polygon fill="#A80036" points="336.5,1029.4219,346.5,1033.4219,336.5,1037.4219,340.5,1033.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="1033.4219" y2="1033.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="1028.6797">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="92.5" y="1028.6797">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="192,1076.4219,514,1076.4219,524,1110.4219,514,1145.4219,192,1145.4219,182,1110.4219,192,1076.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="194" y="1092.9902">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="278" y="1092.9902">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="210" y="1108.3008">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="194" y="1123.6113">VALUES ({payload.transferId}, 'RECEIVED_PREPARE',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="210" y="1138.9219">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="336.5,1167.9746,346.5,1171.9746,336.5,1175.9746,340.5,1171.9746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="342.5" y1="1171.9746" y2="1171.9746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="79.5" y="1167.2324">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="92.5" y="1167.2324">Save externalReference and extensions</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="296,1214.9746,411,1214.9746,421,1225.9746,411,1237.9746,296,1237.9746,286,1225.9746,296,1214.9746" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="298" y="1231.543">transferExtension</text><!--
@startuml
title 5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)

autonumber


entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TRANSFER_DAO
    participant DB
end box

group reconciliationTransferPrepare (payload, trx)
    TRANSFER_DAO -> DB: Insert transferDuplicateCheck
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferDuplicateCheck** (transferId, hash, createdDate)
        VALUES ({payload.transferId}, hashCode({payload.transferId}), {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Insert transfer
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transfer** (transferId, amount, currencyId,
            ilpCondition, expirationDate, createdDate)
        VALUES ({payload.transferId}, {payload.amount.amount},
            {payload.amount.curency}, 0,
            {new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},
            {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Retrieve hub reconciliation account
    activate DB
    hnote over DB #lightyellow
        SELECT participantCurrencyId AS reconciliationAccountId
        FROM **participantCurrency**
        WHERE participantId = 1
        AND currencyId = {payload.amount.currency}
        LIMIT 1
    end hnote
    deactivate DB
    TRANSFER_DAO <- - DB: Return **reconciliationAccountId**

    alt payload.action == 'RECORD_FUNDS_IN'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_IN'
            **amount** = <color #blue>payload.amount.amount</color>
        end note
    else payload.action == 'RECORD_FUNDS_OUT_PREPARE'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_OUT'
            **amount** = <color #red>-payload.amount.amount</color>
        end note
    end

    TRANSFER_DAO -> DB: Insert transferParticipant records
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES (payload.transferId, reconciliationAccountId, 'HUB',
            {ledgerEntryTypeId}, {amount}, {transactionTimestamp})

        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',
            {ledgerEntryTypeId}, {-amount}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Insert transferStateChange record
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferStateChange**
            (transferId, transferStateId, reason, createdDate)
        VALUES ({payload.transferId}, 'RECEIVED_PREPARE',
            {payload.reason}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Save externalReference and extensions
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        transferExtension
    end hnote
end
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>