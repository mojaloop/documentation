<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="10863px" preserveAspectRatio="none" style="width:1333px;height:10863px;" version="1.1" viewBox="0 0 1333 10863" width="1333px" zoomAndPan="magnify"><defs><filter height="300%" id="fvaru276p7rfa" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="410" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="10817.7344" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="107" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="122.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="10817.7344" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="263.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="386.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="10817.7344" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1014" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1017" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="10609.4473" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="10217.6152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="9330.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="568" y="567.7402"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="621.3613"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="805.1563"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1096.125"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1310.541"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7490.2383"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7655.1016"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8834.6953"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8968.9375"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9692.3438"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9784.2754"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="10594.4473" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="9286.8457" style="stroke: #000000; stroke-width: 2.0;" width="836" x="476" y="582.7402"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="506" y="2706.3848"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="573" y="3084.2852"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3140.9063"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3195.1719"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3249.4375"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3303.7031"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3357.9688"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3412.2344"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="573" y="3675.7422"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="563" y="3944.8477"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="573" y="4238.127"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4294.748"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4349.0137"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4403.2793"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4457.5449"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4511.8105"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="2511.1934" style="stroke: #000000; stroke-width: 2.0;" width="797" x="486" y="4926.4238"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="2352.3301" style="stroke: #000000; stroke-width: 2.0;" width="777" x="496" y="5078.2871"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="2239.3984" style="stroke: #000000; stroke-width: 2.0;" width="757" x="506" y="5184.2188"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5375.0137"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5563.4531"/><rect fill="#FFFFFF" height="341.5449" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5813.1348"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6154.6797"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6169.6348"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6184.5898"/><rect fill="#FFFFFF" height="987.3457" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6199.5449"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="316.9004" style="stroke: #000000; stroke-width: 2.0;" width="517" x="573" y="6862.9902"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="7186.8906"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="506" y="7451.6172"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="506" y="7862.8965"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="506" y="8021.7598"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="506" y="8178.2676"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="691.4727" style="stroke: #000000; stroke-width: 2.0;" width="749" x="506" y="8348.7754"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="332.7461" style="stroke: #000000; stroke-width: 2.0;" width="676" x="553" y="8473.6387"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="246.8145" style="stroke: #000000; stroke-width: 2.0;" width="656" x="563" y="8552.5703"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="597" x="573" y="8665.9668"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="496" y="9054.248"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="573" y="9117.8691"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9200.7109"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9283.2422"/><rect fill="#FFFFFF" height="95.4863" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9365.7734"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9461.2598"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9543.791"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="506" y="9599.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="163" x2="163" y1="137.2871" y2="10765.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="10765.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="573" x2="573" y1="137.2871" y2="10765.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1071" x2="1071" y1="137.2871" y2="10765.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="134.334">Hub Employee</text><ellipse cx="163" cy="63.7988" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,71.7988 L163,98.7988 M150,79.7988 L176,79.7988 M163,98.7988 L150,113.7988 M163,98.7988 L176,113.7988 " fill="none" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="10778.2695">Hub Employee</text><ellipse cx="163" cy="10791.2227" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,10799.2227 L163,10826.2227 M150,10807.2227 L176,10807.2227 M163,10826.2227 L150,10841.2227 M163,10826.2227 L176,10841.2227 " fill="none" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="134.334">Settlement Service API</text><path d="M325.5,92.7988 L325.5,116.7988 M325.5,104.7988 L342.5,104.7988 " fill="none" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="104.7988" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="10778.2695">Settlement Service API</text><path d="M325.5,10785.2227 L325.5,10809.2227 M325.5,10797.2227 L342.5,10797.2227 " fill="none" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="10797.2227" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="516" y="134.334">Settlement DAO</text><ellipse cx="573" cy="104.7988" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="561" x2="585" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="516" y="10778.2695">Settlement DAO</text><ellipse cx="573" cy="10797.2227" fill="#FEFECE" filter="url(#fvaru276p7rfa)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="561" x2="585" y1="10811.2227" y2="10811.2227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1023" y="134.334">Central Store</text><path d="M1053,84.7988 C1053,74.7988 1071,74.7988 1071,74.7988 C1071,74.7988 1089,74.7988 1089,84.7988 L1089,110.7988 C1089,120.7988 1071,120.7988 1071,120.7988 C1071,120.7988 1053,120.7988 1053,110.7988 L1053,84.7988 " fill="#FEFECE" filter="url(#fvaru276p7rfa)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1053,84.7988 C1053,94.7988 1071,94.7988 1071,94.7988 C1071,94.7988 1089,94.7988 1089,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1023" y="10778.2695">Central Store</text><path d="M1053,10791.2227 C1053,10781.2227 1071,10781.2227 1071,10781.2227 C1071,10781.2227 1089,10781.2227 1089,10791.2227 L1089,10817.2227 C1089,10827.2227 1071,10827.2227 1071,10827.2227 C1071,10827.2227 1053,10827.2227 1053,10817.2227 L1053,10791.2227 " fill="#FEFECE" filter="url(#fvaru276p7rfa)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1053,10791.2227 C1053,10801.2227 1071,10801.2227 1071,10801.2227 C1071,10801.2227 1089,10801.2227 1089,10791.2227 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="10609.4473" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="10217.6152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="9330.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="568" y="567.7402"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="621.3613"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="805.1563"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1096.125"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1310.541"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7490.2383"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7655.1016"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8834.6953"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8968.9375"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9692.3438"/><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9784.2754"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="10594.4473" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M173,176.5977 L173,492.5977 L880,492.5977 L880,186.5977 L870,176.5977 L173,176.5977 " fill="#FFFF00" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M870,176.5977 L870,186.5977 L880,186.5977 L870,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="195" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="243" y="270.7188">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="613" x="243" y="286.0293">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="243" y="301.3398">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="243" y="316.6504">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="243" y="331.9609">{ "id": 5, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="362.582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="393.2031">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="408.5137">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="243" y="423.8242">{ "id": 6, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="195" y="469.7559">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="485.0664">}</text><polygon fill="#A80036" points="329,519.1191,339,523.1191,329,527.1191,333,523.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="168" x2="335" y1="523.1191" y2="523.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175" y="518.377">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="188" y="518.377">PUT - /settlement/{id}</text><polygon fill="#A80036" points="556,563.7402,566,567.7402,556,571.7402,560,567.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="562" y1="567.7402" y2="567.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="555.3428">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="371" y="547.6875">updateSettlementById routine</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="562.998">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="562.998">2001</text><path d="M476,582.7402 L641,582.7402 L641,589.7402 L631,599.7402 L476,599.7402 L476,582.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="9286.8457" style="stroke: #000000; stroke-width: 2.0;" width="836" x="476" y="582.7402"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="491" y="596.3086">DB TRANSACTION</text><polygon fill="#A80036" points="1054,617.3613,1064,621.3613,1054,625.3613,1058,621.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="621.3613" y2="621.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="616.6191">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="598" y="616.6191">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="884,634.3613,1258,634.3613,1268,691.3613,1258,749.3613,884,749.3613,874,691.3613,884,634.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="886" y="650.9297">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="902" y="666.2402">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="886" y="681.5508">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="926" y="681.5508">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1002" y="681.5508">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="886" y="696.8613">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="918" y="696.8613">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1079" y="696.8613">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="886" y="712.1719">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="886" y="727.4824">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="886" y="742.793">FOR UPDATE</text><polygon fill="#A80036" points="589,771.8457,579,775.8457,589,779.8457,585,775.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="775.8457" y2="775.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="771.1035">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="771.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="653" y="771.1035">settlementData</text><polygon fill="#A80036" points="1054,801.1563,1064,805.1563,1054,809.1563,1058,805.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="805.1563" y2="805.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="800.4141">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="598" y="800.4141">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="887,818.1563,1255,818.1563,1265,913.1563,1255,1009.1563,887,1009.1563,877,913.1563,887,818.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="889" y="834.7246">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="905" y="850.0352">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="905" y="865.3457">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="905" y="880.6563">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1157" y="880.6563">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="889" y="895.9668">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="929" y="895.9668">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1140" y="895.9668">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="889" y="911.2773">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="921" y="911.2773">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1217" y="911.2773">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="889" y="926.5879">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="889" y="941.8984">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="889" y="957.209">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="921" y="957.209">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1061" y="957.209">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="889" y="972.5195">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="889" y="987.8301">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="889" y="1003.1406">FOR UPDATE</text><polygon fill="#A80036" points="589,1032.1934,579,1036.1934,589,1040.1934,585,1036.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1036.1934" y2="1036.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="1031.4512">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="1031.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="653" y="1031.4512">settlementAccountsList</text><polygon fill="#A80036" points="1054,1092.125,1064,1096.125,1054,1100.125,1058,1096.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="1096.125" y2="1096.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="1076.0723">7</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="598" y="1060.7617">Retrieve settlement windows information â€”&gt; no longer possible</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="598" y="1076.0723">We need to add</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="707" y="1076.0723">settlementContentAggregation.settlementId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="598" y="1091.3828">(nullable) to be populated during createSettlement</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="849,1109.125,1292,1109.125,1302,1181.125,1292,1254.125,849,1254.125,839,1181.125,849,1109.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="851" y="1125.6934">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="867" y="1141.0039">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="851" y="1156.3145">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="891" y="1156.3145">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1092" y="1156.3145">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1171.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="883" y="1171.625">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1012" y="1171.625">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="851" y="1186.9355">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1202.2461">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="883" y="1202.2461">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1097" y="1202.2461">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="851" y="1217.5566">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="851" y="1232.8672">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="851" y="1248.1777">FOR UPDATE</text><polygon fill="#A80036" points="589,1277.2305,579,1281.2305,589,1285.2305,585,1281.2305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1281.2305" y2="1281.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="1276.4883">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="1276.4883">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="653" y="1276.4883">windowsList</text><polygon fill="#A80036" points="1054,1306.541,1064,1310.541,1054,1314.541,1058,1310.541" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="1310.541" y2="1310.541"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="1305.7988">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="598" y="1305.7988">Retrieve settlement windows accounts information</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="876,1323.541,1265,1323.541,1275,1357.541,1265,1392.541,876,1392.541,866,1357.541,876,1323.541" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="878" y="1340.1094">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="878" y="1355.4199">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="918" y="1355.4199">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="878" y="1370.7305">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="878" y="1386.041">FOR UPDATE</text><polygon fill="#A80036" points="589,1415.0938,579,1419.0938,589,1423.0938,585,1419.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1419.0938" y2="1419.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="1414.3516">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="1414.3516">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="662" y="1414.3516">windowsAccountsList</text><path d="M583,1432.0938 L583,1503.0938 L1080,1503.0938 L1080,1442.0938 L1070,1432.0938 L583,1432.0938 " fill="#ADD8E6" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1070,1432.0938 L1070,1442.0938 L1080,1442.0938 L1070,1432.0938 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="589" y="1449.6621">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="589" y="1464.9727">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="589" y="1480.2832">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="589" y="1495.5938">B. Move to asyncronous processing where we don't need these objects</text><path d="M583,1517.3359 L583,2399.3359 L1272,2399.3359 L1272,1527.3359 L1262,1517.3359 L583,1517.3359 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1262,1517.3359 L1262,1527.3359 L1272,1527.3359 L1262,1517.3359 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="589" y="1534.9043">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="589" y="1550.2148">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="696" y="1550.2148">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="589" y="1565.5254">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="751" y="1565.5254">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="589" y="1580.8359">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="676" y="1580.8359">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="589" y="1596.1465">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="738" y="1596.1465">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="1611.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="589" y="1626.7676">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="589" y="1642.0781">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="723" y="1642.0781">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="845" y="1642.0781">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="994" y="1642.0781">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="605" y="1657.3887">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="605" y="1672.6992">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="605" y="1688.0098">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="605" y="1703.3203">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="605" y="1718.6309">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="605" y="1733.9414">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="1749.252">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="589" y="1764.5625">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="749" y="1764.5625">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="589" y="1779.873">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="667" y="1779.873">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1077" y="1779.873">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1226" y="1779.873">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="605" y="1795.1836">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="621" y="1810.4941">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="621" y="1825.8047">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="621" y="1841.1152">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="621" y="1856.4258">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="621" y="1871.7363">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="637" y="1887.0469">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="637" y="1902.3574">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="621" y="1917.668">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="621" y="1932.9785">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="621" y="1948.2891">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="651" y="1948.2891">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="677" y="1948.2891">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="1963.5996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="1978.9102">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="589" y="1994.2207">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="665" y="1994.2207">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1175" y="1994.2207">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1253" y="1994.2207">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="605" y="2009.5313">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="621" y="2024.8418">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="621" y="2040.1523">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="621" y="2055.4629">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="621" y="2070.7734">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2086.084">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2101.3945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="589" y="2116.7051">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="710" y="2116.7051">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="605" y="2132.0156">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="621" y="2147.3262">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="621" y="2162.6367">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="621" y="2177.9473">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="621" y="2193.2578">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="621" y="2208.5684">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="621" y="2223.8789">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="621" y="2239.1895">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2254.5">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2269.8105">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="589" y="2285.1211">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="736" y="2285.1211">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="589" y="2300.4316">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="709" y="2300.4316">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="605" y="2315.7422">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="621" y="2331.0527">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="621" y="2346.3633">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2361.6738">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2376.9844">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="589" y="2392.2949">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="609" y="2392.2949">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="765" y="2392.2949">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="2455.3477" y2="2455.3477"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="2455.3477" y2="2468.3477"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="2468.3477" y2="2468.3477"/><polygon fill="#A80036" points="589,2464.3477,579,2468.3477,589,2472.3477,585,2468.3477" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="2450.6055">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="607" y="2450.6055">Declare and initialize variables</text><path d="M583,2481.3477 L583,2690.3477 L875,2690.3477 L875,2491.3477 L865,2481.3477 L583,2481.3477 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,2481.3477 L865,2491.3477 L875,2491.3477 L865,2481.3477 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="589" y="2498.916">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="2514.2266">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="605" y="2529.5371">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="605" y="2544.8477">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="605" y="2560.1582">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="605" y="2575.4688">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="605" y="2590.7793">abortedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="605" y="2606.0898">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2621.4004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="589" y="2636.7109">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="589" y="2652.0215">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="589" y="2667.332">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="589" y="2682.6426">let state</text><path d="M506,2706.3848 L580,2706.3848 L580,2713.3848 L570,2723.3848 L506,2723.3848 L506,2706.3848 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="506" y="2706.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="521" y="2719.9531">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="595" y="2719.0195">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="2745.0059" y2="2745.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="2745.0059" y2="2758.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="2758.0059" y2="2758.0059"/><polygon fill="#A80036" points="589,2754.0059,579,2758.0059,589,2762.0059,585,2758.0059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="2740.2637">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="607" y="2740.2637">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="665" y="2740.2637">allAccounts</text><path d="M583,2771.0059 L583,3025.0059 L831,3025.0059 L831,2781.0059 L821,2771.0059 L583,2771.0059 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M821,2771.0059 L821,2781.0059 L831,2781.0059 L821,2771.0059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="2788.5742">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="589" y="2803.8848">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="589" y="2819.1953">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="2834.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="589" y="2849.8164">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="605" y="2865.127">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="605" y="2880.4375">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="605" y="2895.748">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="605" y="2911.0586">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="605" y="2926.3691">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="621" y="2941.6797">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="621" y="2956.9902">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="605" y="2972.3008">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="605" y="2987.6113">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="605" y="3002.9219">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="3018.2324">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3056.2852" y2="3056.2852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3056.2852" y2="3069.2852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3069.2852" y2="3069.2852"/><polygon fill="#A80036" points="589,3065.2852,579,3069.2852,589,3073.2852,585,3069.2852" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3051.543">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="607" y="3051.543">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="665" y="3051.543">settlementAccounts</text><path d="M573,3084.2852 L635,3084.2852 L635,3091.2852 L625,3101.2852 L573,3101.2852 L573,3084.2852 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="573" y="3084.2852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="3097.8535">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="650" y="3096.9199">[state == 'PENDING_SETTLEMENT']</text><path d="M583,3106.5957 L583,3131.5957 L910,3131.5957 L910,3116.5957 L900,3106.5957 L583,3106.5957 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,3106.5957 L900,3116.5957 L910,3116.5957 L900,3106.5957 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="589" y="3124.1641">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3141.9063" y2="3141.9063"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="578" y="3152.541">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M583,3160.8613 L583,3185.8613 L924,3185.8613 L924,3170.8613 L914,3160.8613 L583,3160.8613 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M914,3160.8613 L914,3170.8613 L924,3170.8613 L914,3160.8613 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="589" y="3178.4297">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3196.1719" y2="3196.1719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="578" y="3206.8066">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M583,3215.127 L583,3240.127 L922,3240.127 L922,3225.127 L912,3215.127 L583,3215.127 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M912,3215.127 L912,3225.127 L922,3225.127 L912,3215.127 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="589" y="3232.6953">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3250.4375" y2="3250.4375"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="578" y="3261.0723">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M583,3269.3926 L583,3294.3926 L936,3294.3926 L936,3279.3926 L926,3269.3926 L583,3269.3926 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M926,3269.3926 L926,3279.3926 L936,3279.3926 L926,3269.3926 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="589" y="3286.9609">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3304.7031" y2="3304.7031"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="578" y="3315.3379">[state == 'SETTLED']</text><path d="M583,3323.6582 L583,3348.6582 L835,3348.6582 L835,3333.6582 L825,3323.6582 L583,3323.6582 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M825,3323.6582 L825,3333.6582 L835,3333.6582 L825,3323.6582 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="589" y="3341.2266">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3358.9688" y2="3358.9688"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="578" y="3369.6035">[state == 'ABORTED']</text><path d="M583,3377.9238 L583,3402.9238 L840,3402.9238 L840,3387.9238 L830,3377.9238 L583,3377.9238 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M830,3377.9238 L830,3387.9238 L840,3387.9238 L830,3377.9238 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="589" y="3395.4922">settlementAccounts.abortedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3413.2344" y2="3413.2344"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="578" y="3423.8691">[default]</text><path d="M583,3432.1895 L583,3457.1895 L850,3457.1895 L850,3442.1895 L840,3432.1895 L583,3432.1895 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M840,3432.1895 L840,3442.1895 L850,3442.1895 L840,3432.1895 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="589" y="3449.7578">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3501.8105" y2="3501.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3501.8105" y2="3514.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3514.8105" y2="3514.8105"/><polygon fill="#A80036" points="589,3510.8105,579,3514.8105,589,3518.8105,585,3514.8105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3497.0684">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="607" y="3497.0684">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="865" y="3497.0684">settlementAccountsInit</text><path d="M583,3527.8105 L583,3552.8105 L1005,3552.8105 L1005,3537.8105 L995,3527.8105 L583,3527.8105 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M995,3527.8105 L995,3537.8105 L1005,3537.8105 L995,3527.8105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="589" y="3545.3789">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3608.4316" y2="3608.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3608.4316" y2="3621.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3621.4316" y2="3621.4316"/><polygon fill="#A80036" points="589,3617.4316,579,3621.4316,589,3625.4316,585,3621.4316" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3603.6895">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="607" y="3603.6895">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="744" y="3603.6895">allWindows</text><path d="M583,3634.4316 L583,3659.4316 L819,3659.4316 L819,3644.4316 L809,3634.4316 L583,3634.4316 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M809,3634.4316 L809,3644.4316 L819,3644.4316 L809,3634.4316 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="589" y="3652">let allWindows = {} // declare map</text><path d="M573,3675.7422 L647,3675.7422 L647,3682.7422 L637,3692.7422 L573,3692.7422 L573,3675.7422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="573" y="3675.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="588" y="3689.3105">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="662" y="3688.377">[windowsList as window]</text><path d="M583,3698.0527 L583,3799.0527 L885,3799.0527 L885,3708.0527 L875,3698.0527 L583,3698.0527 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M875,3698.0527 L875,3708.0527 L885,3708.0527 L875,3698.0527 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="589" y="3715.6211">allWindows[window.settlementWindowId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="605" y="3730.9316">id: window.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="605" y="3746.2422">state: window.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="605" y="3761.5527">reason: window.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="605" y="3776.8633">createDate: window.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="3792.1738">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3862.2266" y2="3862.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3862.2266" y2="3875.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3875.2266" y2="3875.2266"/><polygon fill="#A80036" points="589,3871.2266,579,3875.2266,589,3879.2266,585,3875.2266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3857.4844">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="607" y="3857.4844">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="744" y="3857.4844">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="868" y="3857.4844">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="895" y="3857.4844">windowsAccounts</text><path d="M583,3888.2266 L583,3928.2266 L862,3928.2266 L862,3898.2266 L852,3888.2266 L583,3888.2266 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M852,3888.2266 L852,3898.2266 L862,3898.2266 L852,3888.2266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="589" y="3905.7949">let accountsWindows = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="589" y="3921.1055">let windowsAccounts = {} // declare map</text><path d="M563,3944.8477 L637,3944.8477 L637,3951.8477 L627,3961.8477 L563,3961.8477 L563,3944.8477 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="563" y="3944.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="578" y="3958.416">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="652" y="3957.4824">[windowsAccountsList as record]</text><path d="M583,3967.1582 L583,4221.1582 L1083,4221.1582 L1083,3977.1582 L1073,3967.1582 L583,3967.1582 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1073,3967.1582 L1073,3977.1582 L1083,3977.1582 L1073,3967.1582 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="589" y="3984.7266">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="589" y="4000.0371">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="589" y="4015.3477">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4030.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="589" y="4045.9688">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="605" y="4061.2793">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="605" y="4076.5898">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="4091.9004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="589" y="4107.2109">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4122.5215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="589" y="4137.832">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="605" y="4153.1426">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="4168.4531">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="605" y="4183.7637">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="605" y="4199.0742">abortedCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="4214.3848">}</text><path d="M573,4238.127 L635,4238.127 L635,4245.127 L625,4255.127 L573,4255.127 L573,4238.127 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="573" y="4238.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="4251.6953">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="650" y="4250.7617">[state == 'PENDING_SETTLEMENT']</text><path d="M583,4260.4375 L583,4285.4375 L928,4285.4375 L928,4270.4375 L918,4260.4375 L583,4260.4375 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M918,4260.4375 L918,4270.4375 L928,4270.4375 L918,4260.4375 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="589" y="4278.0059">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4295.748" y2="4295.748"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="578" y="4306.3828">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M583,4314.7031 L583,4339.7031 L942,4339.7031 L942,4324.7031 L932,4314.7031 L583,4314.7031 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M932,4314.7031 L932,4324.7031 L942,4324.7031 L932,4314.7031 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="589" y="4332.2715">windowsAccounts[wid].psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4350.0137" y2="4350.0137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="578" y="4360.6484">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M583,4368.9688 L583,4393.9688 L940,4393.9688 L940,4378.9688 L930,4368.9688 L583,4368.9688 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M930,4368.9688 L930,4378.9688 L940,4378.9688 L930,4368.9688 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="589" y="4386.5371">windowsAccounts[wid].psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4404.2793" y2="4404.2793"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="578" y="4414.9141">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M583,4423.2344 L583,4448.2344 L954,4448.2344 L954,4433.2344 L944,4423.2344 L583,4423.2344 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M944,4423.2344 L944,4433.2344 L954,4433.2344 L944,4423.2344 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="589" y="4440.8027">windowsAccounts[wid].psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4458.5449" y2="4458.5449"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="578" y="4469.1797">[state == 'SETTLED']</text><path d="M583,4477.5 L583,4502.5 L853,4502.5 L853,4487.5 L843,4477.5 L583,4477.5 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M843,4477.5 L843,4487.5 L853,4487.5 L843,4477.5 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="589" y="4495.0684">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4512.8105" y2="4512.8105"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="578" y="4523.4453">[state == 'ABORTED']</text><path d="M583,4531.7656 L583,4556.7656 L858,4556.7656 L858,4541.7656 L848,4531.7656 L583,4531.7656 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M848,4531.7656 L848,4541.7656 L858,4541.7656 L848,4531.7656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="589" y="4549.334">windowsAccounts[wid].abortedCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="4601.3867" y2="4601.3867"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="4601.3867" y2="4614.3867"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="4614.3867" y2="4614.3867"/><polygon fill="#A80036" points="589,4610.3867,579,4614.3867,589,4618.3867,585,4614.3867" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="4596.6445">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="607" y="4596.6445">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="853" y="4596.6445">windowsAccountsInit</text><path d="M583,4627.3867 L583,4652.3867 L981,4652.3867 L981,4637.3867 L971,4627.3867 L583,4627.3867 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M971,4627.3867 L971,4637.3867 L981,4637.3867 L971,4627.3867 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="589" y="4644.9551">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M583,4691.6973 L583,4884.6973 L1277,4884.6973 L1277,4701.6973 L1267,4691.6973 L583,4691.6973 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1267,4691.6973 L1267,4701.6973 L1277,4701.6973 L1267,4691.6973 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="589" y="4709.2656">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="589" y="4724.5762">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="727" y="4724.5762">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="589" y="4739.8867">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="671" y="4739.8867">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="589" y="4755.1973">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="669" y="4755.1973">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="589" y="4770.5078">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="714" y="4770.5078">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="589" y="4785.8184">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="713" y="4785.8184">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4801.1289"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="589" y="4816.4395">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="797" y="4816.4395">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="851" y="4816.4395">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="589" y="4831.75">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="674" y="4831.75">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="589" y="4847.0605">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="708" y="4847.0605">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="589" y="4862.3711">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="885" y="4862.3711">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="589" y="4877.6816">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="724" y="4877.6816">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M486,4926.4238 L560,4926.4238 L560,4933.4238 L550,4943.4238 L486,4943.4238 L486,4926.4238 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2511.1934" style="stroke: #000000; stroke-width: 2.0;" width="797" x="486" y="4926.4238"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="501" y="4939.9922">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="575" y="4939.0586">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="4965.0449" y2="4965.0449"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="4965.0449" y2="4978.0449"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="4978.0449" y2="4978.0449"/><polygon fill="#A80036" points="589,4974.0449,579,4978.0449,589,4982.0449,585,4978.0449" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="4960.3027">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="607" y="4960.3027">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="750" y="4960.3027">participantPayload</text><path d="M583,4991.0449 L583,5062.0449 L963,5062.0449 L963,5001.0449 L953,4991.0449 L583,4991.0449 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M953,4991.0449 L953,5001.0449 L963,5001.0449 L953,4991.0449 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="589" y="5008.6133">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="589" y="5023.9238">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="589" y="5039.2344">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="589" y="5054.5449">participant = participants[pi]</text><path d="M496,5078.2871 L570,5078.2871 L570,5085.2871 L560,5095.2871 L496,5095.2871 L496,5078.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2352.3301" style="stroke: #000000; stroke-width: 2.0;" width="777" x="496" y="5078.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="511" y="5091.8555">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="585" y="5090.9219">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5116.9082" y2="5116.9082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5116.9082" y2="5129.9082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5129.9082" y2="5129.9082"/><polygon fill="#A80036" points="589,5125.9082,579,5129.9082,589,5133.9082,585,5129.9082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5112.166">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="607" y="5112.166">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="750" y="5112.166">accountPayload</text><path d="M583,5142.9082 L583,5167.9082 L975,5167.9082 L975,5152.9082 L965,5142.9082 L583,5142.9082 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M965,5142.9082 L965,5152.9082 L975,5152.9082 L965,5142.9082 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="589" y="5160.4766">let accountPayload = participantPayload.accounts[account]</text><path d="M506,5184.2188 L568,5184.2188 L568,5191.2188 L558,5201.2188 L506,5201.2188 L506,5184.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2239.3984" style="stroke: #000000; stroke-width: 2.0;" width="757" x="506" y="5184.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="521" y="5197.7871">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="583" y="5196.8535">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5222.8398" y2="5222.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5222.8398" y2="5235.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5235.8398" y2="5235.8398"/><polygon fill="#A80036" points="589,5231.8398,579,5235.8398,589,5239.8398,585,5235.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5218.0977">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="607" y="5218.0977">If the account doesn't match the settlement</text><path d="M583,5248.8398 L583,5365.8398 L871,5365.8398 L871,5258.8398 L861,5248.8398 L583,5248.8398 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M861,5248.8398 L861,5258.8398 L871,5258.8398 L861,5248.8398 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5266.4082">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5281.7188">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5297.0293">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5312.3398">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="621" y="5327.6504">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5342.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5358.2715">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5376.0137" y2="5376.0137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="392" x="511" y="5386.6484">[participantPayload.id != allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5411.2793" y2="5411.2793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5411.2793" y2="5424.2793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5424.2793" y2="5424.2793"/><polygon fill="#A80036" points="589,5420.2793,579,5424.2793,589,5428.2793,585,5424.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5406.5371">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="607" y="5406.5371">If the account doesn't match the participant</text><path d="M583,5437.2793 L583,5554.2793 L967,5554.2793 L967,5447.2793 L957,5437.2793 L583,5437.2793 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M957,5437.2793 L957,5447.2793 L967,5447.2793 L957,5437.2793 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5454.8477">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5470.1582">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5485.4688">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5500.7793">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="621" y="5516.0898">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5531.4004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5546.7109">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5564.4531" y2="5564.4531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="511" y="5575.0879">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5599.7188" y2="5599.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5599.7188" y2="5612.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5612.7188" y2="5612.7188"/><polygon fill="#A80036" points="589,5608.7188,579,5612.7188,589,5616.7188,585,5612.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5594.9766">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="607" y="5594.9766">If the account has been previosly processed (duplicated in the payload)</text><path d="M583,5625.7188 L583,5803.7188 L1102,5803.7188 L1102,5635.7188 L1092,5625.7188 L583,5625.7188 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,5625.7188 L1092,5635.7188 L1102,5635.7188 L1092,5625.7188 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5643.2871">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5658.5977">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="605" y="5673.9082">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="605" y="5689.2188">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="605" y="5704.5293">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="5719.8398">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5735.1504">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5750.4609">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="621" y="5765.7715">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5781.082">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5796.3926">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5814.1348" y2="5814.1348"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="371" x="511" y="5824.7695">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5849.4004" y2="5849.4004"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5849.4004" y2="5862.4004"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5862.4004" y2="5862.4004"/><polygon fill="#A80036" points="589,5858.4004,579,5862.4004,589,5866.4004,585,5862.4004" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5844.6582">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="607" y="5844.6582">Same-state reason amendment is always allowed</text><path d="M583,5875.4004 L583,6145.4004 L1102,6145.4004 L1102,5885.4004 L1092,5875.4004 L583,5875.4004 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,5875.4004 L1092,5885.4004 L1102,5885.4004 L1092,5875.4004 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="589" y="5892.9688">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5908.2793">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5923.5898">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="5938.9004">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="5954.2109">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="5969.5215">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="605" y="5984.832">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="6000.1426">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6015.4531">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="589" y="6030.7637">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="605" y="6046.0742">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="605" y="6061.3848">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6076.6953">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="605" y="6092.0059">externalReference: accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6107.3164">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="589" y="6122.627">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="589" y="6137.9375">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6155.6797" y2="6155.6797"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="610" x="511" y="6166.3145">[settlementData.state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6170.6348" y2="6170.6348"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="628" x="511" y="6181.2695">[settlementData.state == 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6185.5898" y2="6185.5898"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="511" y="6196.2246">[settlementData.state == 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6200.5449" y2="6200.5449"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="752" x="511" y="6211.1797">[settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' &amp;&amp; accountPayload.state == 'SETTLED']</text><path d="M583,6219.5 L583,6259.5 L1108,6259.5 L1108,6229.5 L1098,6219.5 L583,6219.5 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1098,6219.5 L1098,6229.5 L1108,6229.5 L1098,6219.5 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="589" y="6237.0684">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="620" y="6237.0684">: Since we previously checked same-state, here we don't need to match</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="504" x="589" y="6252.3789">allAccounts[account.id].state == settlementData.state. We can safely assume it.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="6290.4316" y2="6290.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="6290.4316" y2="6303.4316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="6303.4316" y2="6303.4316"/><polygon fill="#A80036" points="589,6299.4316,579,6303.4316,589,6307.4316,585,6303.4316" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="6285.6895">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="607" y="6285.6895">Settlement acknowledgement</text><path d="M583,6316.4316 L583,6846.4316 L1148,6846.4316 L1148,6326.4316 L1138,6316.4316 L583,6316.4316 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1138,6316.4316 L1138,6326.4316 L1148,6326.4316 L1138,6316.4316 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="589" y="6334">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="6349.3105">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="6364.6211">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="6379.9316">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6395.2422">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="6410.5527">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="605" y="6425.8633">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="6441.1738">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6456.4844">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="589" y="6471.7949">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="605" y="6487.1055">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="605" y="6502.416">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6517.7266">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="6533.0371">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605" y="6548.3477"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="605" y="6548.3477">settlementTransferId: Uuid() -- only for PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6563.6582">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="589" y="6578.9688">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="605" y="6594.2793">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="605" y="6609.5898">settlementAccounts.psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="589" y="6624.9004">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="605" y="6640.2109">settlementAccounts.psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="605" y="6655.5215">settlementAccounts.psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="589" y="6670.832">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="605" y="6686.1426">settlementAccounts.psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="605" y="6701.4531">settlementAccounts.psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="589" y="6716.7637">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="605" y="6732.0742">settlementAccounts.psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="605" y="6747.3848">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="6762.6953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="589" y="6778.0059">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="589" y="6793.3164">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="589" y="6808.627">allAccounts[accountPayload.id].externalReference = accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="589" y="6823.9375">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="589" y="6839.248">let settlementWindowId</text><path d="M573,6862.9902 L647,6862.9902 L647,6869.9902 L637,6879.9902 L573,6879.9902 L573,6862.9902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="316.9004" style="stroke: #000000; stroke-width: 2.0;" width="517" x="573" y="6862.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="588" y="6876.5586">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="662" y="6875.625">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M583,6885.3008 L583,7170.3008 L1076,7170.3008 L1076,6895.3008 L1066,6885.3008 L583,6885.3008 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1066,6885.3008 L1066,6895.3008 L1076,6895.3008 L1066,6885.3008 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="589" y="6902.8691">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="6918.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="589" y="6933.4902">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="605" y="6948.8008">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444" x="605" y="6964.1113">windowsAccounts[settlementWindowId].psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="589" y="6979.4219">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="605" y="6994.7324">windowsAccounts[settlementWindowId].psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="605" y="7010.043">windowsAccounts[settlementWindowId].psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="589" y="7025.3535">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="605" y="7040.6641">windowsAccounts[settlementWindowId].psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="605" y="7055.9746">windowsAccounts[settlementWindowId].psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="589" y="7071.2852">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="605" y="7086.5957">windowsAccounts[settlementWindowId].psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="605" y="7101.9063">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="7117.2168">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="589" y="7132.5273">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="605" y="7147.8379">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="7163.1484">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="7187.8906" y2="7187.8906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="7210.2012" y2="7210.2012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="7210.2012" y2="7223.2012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="7223.2012" y2="7223.2012"/><polygon fill="#A80036" points="589,7219.2012,579,7223.2012,589,7227.2012,585,7223.2012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7205.459">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="607" y="7205.459">All other state transitions are not permitted</text><path d="M583,7236.2012 L583,7414.2012 L1102,7414.2012 L1102,7246.2012 L1092,7236.2012 L583,7236.2012 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,7236.2012 L1092,7246.2012 L1102,7246.2012 L1092,7236.2012 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="7253.7695">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="7269.0801">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="605" y="7284.3906">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="605" y="7299.7012">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="605" y="7315.0117">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="7330.3223">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="7345.6328">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="621" y="7360.9434">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="621" y="7376.2539">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="7391.5645">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="7406.875">})</text><path d="M506,7451.6172 L919,7451.6172 L919,7458.6172 L909,7468.6172 L506,7468.6172 L506,7451.6172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="506" y="7451.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="521" y="7465.1855">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1054,7486.2383,1064,7490.2383,1054,7494.2383,1058,7490.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="7490.2383" y2="7490.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7485.4961">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="607" y="7485.4961">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="935,7503.2383,1207,7503.2383,1217,7514.2383,1207,7526.2383,935,7526.2383,925,7514.2383,935,7503.2383" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="937" y="7519.8066">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="589,7548.8594,579,7552.8594,589,7556.8594,585,7552.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="7552.8594" y2="7552.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="7548.1172">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="7548.1172">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="662" y="7548.1172">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="7612.791" y2="7612.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="7612.791" y2="7625.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="7625.791" y2="7625.791"/><polygon fill="#A80036" points="589,7621.791,579,7625.791,589,7629.791,585,7625.791" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7592.7383">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="607" y="7577.4277">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="607" y="7592.7383">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="607" y="7608.0488">issue the following update in one knex command</text><polygon fill="#A80036" points="1054,7651.1016,1064,7655.1016,1054,7659.1016,1058,7655.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="7655.1016" y2="7655.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7650.3594">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="607" y="7650.3594">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="858,7698.1016,1284,7698.1016,1294,7770.1016,1284,7843.1016,858,7843.1016,848,7770.1016,858,7698.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="860" y="7714.6699">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="914" y="7714.6699">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="860" y="7729.9805">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="876" y="7745.291">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7760.6016"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="876" y="7760.6016">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7775.9121"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="876" y="7775.9121">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7791.2227"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="876" y="7791.2227">-- only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="860" y="7806.5332">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="892" y="7821.8438">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="892" y="7837.1543">.settlementParticipantCurrencyIdList}</text><path d="M506,7862.8965 L568,7862.8965 L568,7869.8965 L558,7879.8965 L506,7879.8965 L506,7862.8965 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="506" y="7862.8965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="521" y="7876.4648">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="583" y="7875.5313">[settlementData.state == 'PENDING_SETTLEMENT']</text><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="7905.207"/><polygon fill="#EEEEEE" points="513,7905.207,577,7905.207,577,7912.207,567,7922.207,513,7922.207,513,7905.207" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="7919.7754">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="640" y="7938.7754">Settlement Transfer Prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="7954.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="7969.3965">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="7969.3965">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="7984.707"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1129" y1="8022.7598" y2="8022.7598"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="511" y="8033.3945">[settlementData.state == 'PS_TRANSFERS_RECORDED']</text><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="8061.7148"/><polygon fill="#EEEEEE" points="513,8061.7148,577,8061.7148,577,8068.7148,567,8078.7148,513,8078.7148,513,8061.7148" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="8076.2832">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="640" y="8095.2832">Settlement Transfer Reserve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8110.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="8125.9043">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="8125.9043">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8141.2148"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1129" y1="8179.2676" y2="8179.2676"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="511" y="8189.9023">[settlementData.state == 'PS_TRANSFERS_RESERVED']</text><rect fill="#FFFFFF" filter="url(#fvaru276p7rfa)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="8218.2227"/><polygon fill="#EEEEEE" points="513,8218.2227,577,8218.2227,577,8225.2227,567,8235.2227,513,8235.2227,513,8218.2227" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="8232.791">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="640" y="8251.791">Settlement Transfer Commit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8267.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="8282.4121">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="8282.4121">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8297.7227"/><path d="M506,8348.7754 L891,8348.7754 L891,8355.7754 L881,8365.7754 L506,8365.7754 L506,8348.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="691.4727" style="stroke: #000000; stroke-width: 2.0;" width="749" x="506" y="8348.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="521" y="8362.3438">Prepare and insert settlementWindowStateChange</text><path d="M583,8371.0859 L583,8457.0859 L895,8457.0859 L895,8381.0859 L885,8371.0859 L583,8371.0859 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M885,8371.0859 L885,8381.0859 L895,8381.0859 L885,8371.0859 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="589" y="8388.6543">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="589" y="8403.9648">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="589" y="8419.2754">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="589" y="8434.5859">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="589" y="8449.8965">let windowState</text><path d="M553,8473.6387 L627,8473.6387 L627,8480.6387 L617,8490.6387 L553,8490.6387 L553,8473.6387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="332.7461" style="stroke: #000000; stroke-width: 2.0;" width="676" x="553" y="8473.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="568" y="8487.207">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="642" y="8486.2734">[let aw IN affectedWindows]</text><path d="M583,8495.9492 L583,8535.9492 L1018,8535.9492 L1018,8505.9492 L1008,8495.9492 L583,8495.9492 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1008,8495.9492 L1008,8505.9492 L1018,8505.9492 L1008,8495.9492 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="589" y="8513.5176">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="589" y="8528.8281">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M563,8552.5703 L630,8552.5703 L630,8559.5703 L620,8569.5703 L563,8569.5703 L563,8552.5703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="246.8145" style="stroke: #000000; stroke-width: 2.0;" width="656" x="563" y="8552.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="578" y="8566.1387">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="509" x="645" y="8565.2051">[windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="549" x="645" y="8578.1602">|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="547" x="645" y="8591.1152">|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="569" x="645" y="8604.0703">|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="389" x="645" y="8617.0254">|| windowAccounts.settledCount != windowAccountsInit.settledCount]</text><path d="M583,8624.6563 L583,8649.6563 L981,8649.6563 L981,8634.6563 L971,8624.6563 L583,8624.6563 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M971,8624.6563 L971,8634.6563 L981,8634.6563 L971,8624.6563 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="589" y="8642.2246">settlementWindows.push(allWindows[affectedWindows[aw]])</text><path d="M573,8665.9668 L640,8665.9668 L640,8672.9668 L630,8682.9668 L573,8682.9668 L573,8665.9668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="597" x="573" y="8665.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="588" y="8679.5352">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="296" x="655" y="8678.6016">[windowAccounts.psTransfersCommittedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="655" y="8691.5566">&amp;&amp; windowAccounts.abortedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="655" y="8704.5117">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M583,8712.1426 L583,8783.1426 L1156,8783.1426 L1156,8722.1426 L1146,8712.1426 L583,8712.1426 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1146,8712.1426 L1146,8722.1426 L1156,8722.1426 L1146,8712.1426 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="589" y="8729.7109">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="552" x="589" y="8745.0215">allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="589" y="8760.332">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="589" y="8775.6426">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="1054,8830.6953,1064,8834.6953,1054,8838.6953,1058,8834.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="8834.6953" y2="8834.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8829.9531">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="607" y="8829.9531">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="972,8847.6953,1170,8847.6953,1180,8858.6953,1170,8870.6953,972,8870.6953,962,8858.6953,972,8847.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="974" y="8864.2637">settlementWindowStateChange</text><polygon fill="#A80036" points="589,8893.3164,579,8897.3164,589,8901.3164,585,8897.3164" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="8897.3164" y2="8897.3164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="8892.5742">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="8892.5742">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="662" y="8892.5742">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="8926.627" y2="8926.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="8926.627" y2="8939.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="8939.627" y2="8939.627"/><polygon fill="#A80036" points="589,8935.627,579,8939.627,589,8943.627,585,8939.627" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8921.8848">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="607" y="8921.8848">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="1054,8964.9375,1064,8968.9375,1054,8972.9375,1058,8968.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="8968.9375" y2="8968.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8964.1953">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="607" y="8964.1953">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="906,9011.9375,1235,9011.9375,1245,9022.9375,1235,9034.9375,906,9034.9375,896,9022.9375,906,9011.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="908" y="9028.5059">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="962" y="9028.5059">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1087" y="9028.5059">.currentStateChangeIds</text><path d="M496,9054.248 L828,9054.248 L828,9061.248 L818,9071.248 L496,9071.248 L496,9054.248 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="496" y="9054.248"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="511" y="9067.8164">Prepare and insert settlementStateChange</text><path d="M583,9076.5586 L583,9101.5586 L820,9101.5586 L820,9086.5586 L810,9076.5586 L583,9076.5586 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M810,9076.5586 L810,9086.5586 L820,9086.5586 L810,9076.5586 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="589" y="9094.127">let settlementStateChanged = true</text><path d="M573,9117.8691 L635,9117.8691 L635,9124.8691 L625,9134.8691 L573,9134.8691 L573,9117.8691 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="573" y="9117.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="9131.4375">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="650" y="9130.5039">[settlementData.state == 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="650" y="9143.459">&amp;&amp; settlementAccounts.pendingSettlementCount == 0]</text><path d="M583,9151.0898 L583,9191.0898 L1114,9191.0898 L1114,9161.0898 L1104,9151.0898 L583,9151.0898 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1104,9151.0898 L1104,9161.0898 L1114,9161.0898 L1104,9151.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="589" y="9168.6582">settlementData.state = 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="510" x="589" y="9183.9688">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9201.7109" y2="9201.7109"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="578" y="9212.3457">[settlementData.state == 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="321" x="578" y="9225.3008">&amp;&amp; settlementAccounts.psTransfersRecordedCount == 0]</text><path d="M583,9233.6211 L583,9273.6211 L1107,9273.6211 L1107,9243.6211 L1097,9233.6211 L583,9233.6211 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1097,9233.6211 L1097,9243.6211 L1107,9243.6211 L1097,9233.6211 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="589" y="9251.1895">settlementData.state = 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="503" x="589" y="9266.5">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9284.2422" y2="9284.2422"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="578" y="9294.877">[settlementData.state == 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="578" y="9307.832">&amp;&amp; settlementAccounts.psTransfersReservedCount == 0]</text><path d="M583,9316.1523 L583,9356.1523 L1123,9356.1523 L1123,9326.1523 L1113,9316.1523 L583,9316.1523 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1113,9316.1523 L1113,9326.1523 L1123,9326.1523 L1113,9316.1523 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="589" y="9333.7207">settlementData.state = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="589" y="9349.0313">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9366.7734" y2="9366.7734"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="578" y="9377.4082">[settlementData.state == 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="318" x="578" y="9390.3633">&amp;&amp; settlementAccounts.psTransfersCommittedCount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="578" y="9403.3184">&amp;&amp; settlementAccounts.settledCount &gt; 0]</text><path d="M583,9411.6387 L583,9451.6387 L1017,9451.6387 L1017,9421.6387 L1007,9411.6387 L583,9411.6387 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1007,9411.6387 L1007,9421.6387 L1017,9421.6387 L1007,9411.6387 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="589" y="9429.207">settlementData.state = 'SETTLING'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="589" y="9444.5176">settlementData.reason = 'Some settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9462.2598" y2="9462.2598"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="534" x="578" y="9472.8945">[(settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="578" y="9485.8496">&amp;&amp; settlementAccounts.psTransfersCommittedCount == 0]</text><path d="M583,9494.1699 L583,9534.1699 L1000,9534.1699 L1000,9504.1699 L990,9494.1699 L583,9494.1699 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M990,9494.1699 L990,9504.1699 L1000,9504.1699 L990,9494.1699 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="589" y="9511.7383">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="589" y="9527.0488">settlementData.reason = 'All settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9544.791" y2="9544.791"/><path d="M583,9550.791 L583,9575.791 L805,9575.791 L805,9560.791 L795,9550.791 L583,9550.791 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M795,9550.791 L795,9560.791 L805,9560.791 L795,9550.791 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="589" y="9568.3594">settlementStateChanged = false</text><path d="M506,9599.1016 L573,9599.1016 L573,9606.1016 L563,9616.1016 L506,9616.1016 L506,9599.1016 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="506" y="9599.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="521" y="9612.6699">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="588" y="9611.7363">[settlementStateChanged == true]</text><path d="M583,9621.4121 L583,9661.4121 L912,9661.4121 L912,9631.4121 L902,9621.4121 L583,9621.4121 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M902,9621.4121 L902,9631.4121 L912,9631.4121 L902,9621.4121 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="589" y="9638.9805">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="589" y="9654.291">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1054,9688.3438,1064,9692.3438,1054,9696.3438,1058,9692.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="9692.3438" y2="9692.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="9687.6016">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="607" y="9687.6016">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="996,9705.3438,1145,9705.3438,1155,9716.3438,1145,9728.3438,996,9728.3438,986,9716.3438,996,9705.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="998" y="9721.9121">settlementStateChange</text><polygon fill="#A80036" points="589,9750.9648,579,9754.9648,589,9758.9648,585,9754.9648" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="9754.9648" y2="9754.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="9750.2227">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="9750.2227">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="662" y="9750.2227">settlementStateChangeId</text><polygon fill="#A80036" points="1054,9780.2754,1064,9784.2754,1054,9788.2754,1058,9784.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="9784.2754" y2="9784.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="9779.5332">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="607" y="9779.5332">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fvaru276p7rfa)" points="936,9827.2754,1205,9827.2754,1215,9838.2754,1205,9850.2754,936,9850.2754,926,9838.2754,936,9827.2754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="938" y="9843.8438">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="992" y="9843.8438">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1064" y="9843.8438">.currentStateChangeId</text><polygon fill="#A80036" points="362,9893.8965,352,9897.8965,362,9901.8965,358,9897.8965" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="572" y1="9897.8965" y2="9897.8965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="9893.1543">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="390" y="9893.1543">Return transaction result</text><path d="M40,9910.8965 L40,10547.8965 L332,10547.8965 L332,9920.8965 L322,9910.8965 L40,9910.8965 " fill="#D3D3D3" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,9910.8965 L322,9920.8965 L332,9920.8965 L322,9910.8965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="46" y="9928.4648">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="9943.7754">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="9943.7754">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="183" y="9943.7754">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="9959.0859">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="9974.3965">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="78" y="9989.707">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="78" y="10005.0176">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="78" y="10020.3281">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10035.6387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="10050.9492">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="10066.2598">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="51" y="10066.2598">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="132" y="10066.2598">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10081.5703">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="10096.8809">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="78" y="10112.1914">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10127.502">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="10142.8125">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="110" y="10158.123">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="10173.4336">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="110" y="10188.7441">"externalReference": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="10204.0547">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="10219.3652">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="10234.6758">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="10249.9863">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="10265.2969">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="10280.6074">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10295.918">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="10311.2285">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="110" y="10326.5391">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="10341.8496">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="10357.1602">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="10372.4707">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="10387.7813">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="10403.0918">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="110" y="10418.4023">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="110" y="10433.7129">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="126" y="10449.0234">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="126" y="10464.334">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="10479.6445">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10494.9551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="10510.2656">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10525.5762">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="10540.8867">]</text><path d="M23,10562.6289 L23,10709.6289 L332,10709.6289 L332,10572.6289 L322,10562.6289 L23,10562.6289 " fill="#FFFFE0" filter="url(#fvaru276p7rfa)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,10562.6289 L322,10572.6289 L332,10572.6289 L322,10562.6289 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="10580.1973">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="10595.5078">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="10610.8184">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="10626.1289">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="10641.4395">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="45" y="10656.75">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="45" y="10672.0605">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="10687.3711">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="10702.6816">]</text><polygon fill="#A80036" points="179,10736.7344,169,10740.7344,179,10744.7344,175,10740.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="173" x2="345" y1="10740.7344" y2="10740.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="185" y="10735.9922">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="207" y="10735.9922">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": <string> },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": <string>, "externalReference": <string> },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": <string> },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": <string>, "externalReference": <string> },
                        { "id": 5, "state": "SETTLED", "reason": <string> }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "SETTLED", "reason": <string> }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById routine\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId,
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: <color #red>Retrieve settlement windows information â€”> no longer possible</color>\n<color #red><b>We need to add</b> settlementContentAggregation.settlementId</color>\n<color #red>(nullable) to be populated during createSettlement</color>
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrieve settlement windows accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT DISTINCT settlementWindowId, participantCurrencyId
            FROM **settlementTransferParticipant**
            WHERE settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsAccountsList**
        deactivate DB

        note right of SETTLE_DAO #lightblue
            All objects below are done for the purposes of the syncronous request.
            If at same point Node process memory limit is reached we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                abortedCount: <integer> // count of accounts in ABORTED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId,
                    reason: reason,
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                    psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                    psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                    psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                    settledCount: <integer>, // count of accounts in SETTLED state
                    abortedCount: <integer> // count of accounts in ABORTED state
                }
            }
            **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                abortedCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts**
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.abortedCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **allWindows**
        note right of SETTLE_DAO #lightgray
            let allWindows = {} // declare map
        end note
        loop windowsList as window
            note right of SETTLE_DAO #lightgray
                allWindows[window.settlementWindowId] = {
                    id: window.settlementWindowId,
                    state: window.settlementWindowStateId,
                    reason: window.reason,
                    createDate: window.createdDate
                }
            end note
        end
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **accountsWindows** and **windowsAccounts**
        note right of SETTLE_DAO #lightgray
            let accountsWindows = {} // declare map
            let windowsAccounts = {} // declare map
        end note
        loop windowsAccountsList as record
            note right of SETTLE_DAO #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid,
                    pendingSettlementCount: 0,
                    settledCount: 0,
                    abortedCount: 0
                }
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].abortedCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of windowsAccounts into **windowsAccountsInit**
        note right of SETTLE_DAO #lightgray
            windowsAccountsInit = Object.assign({}, windowsAccounts)
        end note
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        |||
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id != allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state == 'PENDING_SETTLEMENT' && accountPayload.state == 'PS_TRANSFERS_RECORDED'
                else settlementData.state == 'PS_TRANSFERS_RECORDED' && accountPayload.state == 'PS_TRANSFERS_RESERVED'
                else settlementData.state == 'PS_TRANSFERS_RESERVED' && accountPayload.state == 'PS_TRANSFERS_COMMITTED'
                else settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' && accountPayload.state == 'SETTLED'
                    note right of SETTLE_DAO #lightgray
                        **Note**: Since we previously checked same-state, here we don't need to match
                        allAccounts[account.id].state == settlementData.state. We can safely assume it.
                    end note

                    SETTLE_DAO -> SETTLE_DAO: Settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            <color #blue>settlementTransferId: Uuid() - - only for PS_TRANSFERS_RECORDED</color>
                        })
                        if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.psTransfersRecordedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                            settlementAccounts.psTransfersRecordedCount- -
                            settlementAccounts.psTransfersReservedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                            settlementAccounts.psTransfersReservedCount- -
                            settlementAccounts.psTransfersCommittedCount++
                        } else if (accountPayload.state == 'SETTLED') {
                            settlementAccounts.psTransfersCommittedCount- -
                            settlementAccounts.settledCount++
                        }
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].externalReference = accountPayload.externalReference
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                        let settlementWindowId
                    end note
                    loop let aw IN accountsWindows[accountPayload.id].windows
                        note right of SETTLE_DAO #lightgray
                            settlementWindowId = accountsWindows[accountPayload.id].windows[aw]

                            if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                                windowsAccounts[settlementWindowId].pendingSettlementCount- -
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount- -
                                windowsAccounts[settlementWindowId].psTransfersReservedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                                windowsAccounts[settlementWindowId].psTransfersReservedCount- -
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount++
                            } else if (accountPayload.state == 'SETTLED') {
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount- -
                                windowsAccounts[settlementWindowId].settledCount++
                            }
                            if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                affectedWindows.push(settlementWindowId)
                            }
                        end note
                    end
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId =
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end

        alt settlementData.state == 'PENDING_SETTLEMENT'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Prepare\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RECORDED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Reserve\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RESERVED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Commit\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        end

        group Prepare and insert settlementWindowStateChange
            note right of SETTLE_DAO #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SETTLE_DAO #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount\n|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount\n|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount\n|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount\n|| windowAccounts.settledCount != windowAccountsInit.settledCount
                    note right of SETTLE_DAO #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note

                    opt windowAccounts.psTransfersCommittedCount == 0\n&& windowAccounts.abortedCount == 0\n&& windowAccounts.settledCound > 0
                        note right of SETTLE_DAO #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                end
            end

            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Prepare and insert settlementStateChange
            note right of SETTLE_DAO #lightgray
                let settlementStateChanged = true
            end note
            alt settlementData.state == 'PENDING_SETTLEMENT'\n&& settlementAccounts.pendingSettlementCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RECORDED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RECORDED'\n&& settlementAccounts.psTransfersRecordedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RESERVED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RESERVED'\n&& settlementAccounts.psTransfersReservedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_COMMITTED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'
                end note
            else settlementData.state == 'PS_TRANSFERS_COMMITTED'\n&& settlementAccounts.psTransfersCommittedCount > 0\n&& settlementAccounts.settledCount > 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLING'
                    settlementData.reason = 'Some settlement accounts are SETTLED'
                end note
            else (settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')\n&& settlementAccounts.psTransfersCommittedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All settlement accounts are SETTLED'
                end note
            else
                note right of SETTLE_DAO #lightgray
                    settlementStateChanged = false
                end note
            end
            opt settlementStateChanged == true
                note right of SETTLE_DAO #lightgray
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "externalReference": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>