<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="10832px" preserveAspectRatio="none" style="width:1333px;height:10832px;" version="1.1" viewBox="0 0 1333 10832" width="1333px" zoomAndPan="magnify"><defs><filter height="300%" id="f1myjnxkoqygsf" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="410" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="10787.1133" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="107" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="122.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="10787.1133" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="263.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="386.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="10787.1133" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1014" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1017" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10578.8262" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10186.9941" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9299.5352" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="568" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1065.5039"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1279.9199"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7459.6172"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7624.4805"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8804.0742"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8938.3164"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9661.7227"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9753.6543"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10563.8262" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9256.2246" style="stroke: #000000; stroke-width: 2.0;" width="836" x="476" y="582.7402"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="506" y="2675.7637"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="573" y="3053.6641"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3110.2852"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3164.5508"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3218.8164"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3273.082"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3327.3477"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="573" y="3381.6133"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="573" y="3645.1211"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="563" y="3914.2266"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="573" y="4207.5059"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4264.127"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4318.3926"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4372.6582"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4426.9238"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="395" x="573" y="4481.1895"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2511.1934" style="stroke: #000000; stroke-width: 2.0;" width="797" x="486" y="4895.8027"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2352.3301" style="stroke: #000000; stroke-width: 2.0;" width="777" x="496" y="5047.666"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2239.3984" style="stroke: #000000; stroke-width: 2.0;" width="757" x="506" y="5153.5977"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5344.3926"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5532.832"/><rect fill="#FFFFFF" height="341.5449" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="5782.5137"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6124.0586"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6139.0137"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6153.9688"/><rect fill="#FFFFFF" height="987.3457" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="6168.9238"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="316.9004" style="stroke: #000000; stroke-width: 2.0;" width="517" x="573" y="6832.3691"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="757" x="506" y="7156.2695"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="506" y="7420.9961"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="506" y="7832.2754"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="506" y="7991.1387"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="506" y="8147.6465"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="691.4727" style="stroke: #000000; stroke-width: 2.0;" width="749" x="506" y="8318.1543"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="332.7461" style="stroke: #000000; stroke-width: 2.0;" width="676" x="553" y="8443.0176"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="246.8145" style="stroke: #000000; stroke-width: 2.0;" width="656" x="563" y="8521.9492"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="597" x="573" y="8635.3457"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="496" y="9023.627"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="573" y="9087.248"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9170.0898"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9252.6211"/><rect fill="#FFFFFF" height="95.4863" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9335.1523"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9430.6387"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="564" x="573" y="9513.1699"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="506" y="9568.4805"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="163" x2="163" y1="137.2871" y2="10735.1133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="10735.1133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="573" x2="573" y1="137.2871" y2="10735.1133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1071" x2="1071" y1="137.2871" y2="10735.1133"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="134.334">Hub Employee</text><ellipse cx="163" cy="63.7988" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,71.7988 L163,98.7988 M150,79.7988 L176,79.7988 M163,98.7988 L150,113.7988 M163,98.7988 L176,113.7988 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="10747.6484">Hub Employee</text><ellipse cx="163" cy="10760.6016" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,10768.6016 L163,10795.6016 M150,10776.6016 L176,10776.6016 M163,10795.6016 L150,10810.6016 M163,10795.6016 L176,10810.6016 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="134.334">Settlement Service API</text><path d="M325.5,92.7988 L325.5,116.7988 M325.5,104.7988 L342.5,104.7988 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="104.7988" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="10747.6484">Settlement Service API</text><path d="M325.5,10754.6016 L325.5,10778.6016 M325.5,10766.6016 L342.5,10766.6016 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="10766.6016" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="516" y="134.334">Settlement DAO</text><ellipse cx="573" cy="104.7988" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="561" x2="585" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="516" y="10747.6484">Settlement DAO</text><ellipse cx="573" cy="10766.6016" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="561" x2="585" y1="10780.6016" y2="10780.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1023" y="134.334">Central Store</text><path d="M1053,84.7988 C1053,74.7988 1071,74.7988 1071,74.7988 C1071,74.7988 1089,74.7988 1089,84.7988 L1089,110.7988 C1089,120.7988 1071,120.7988 1071,120.7988 C1071,120.7988 1053,120.7988 1053,110.7988 L1053,84.7988 " fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1053,84.7988 C1053,94.7988 1071,94.7988 1071,94.7988 C1071,94.7988 1089,94.7988 1089,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1023" y="10747.6484">Central Store</text><path d="M1053,10760.6016 C1053,10750.6016 1071,10750.6016 1071,10750.6016 C1071,10750.6016 1089,10750.6016 1089,10760.6016 L1089,10786.6016 C1089,10796.6016 1071,10796.6016 1071,10796.6016 C1071,10796.6016 1053,10796.6016 1053,10786.6016 L1053,10760.6016 " fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1053,10760.6016 C1053,10770.6016 1071,10770.6016 1071,10770.6016 C1071,10770.6016 1089,10770.6016 1089,10760.6016 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10578.8262" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10186.9941" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9299.5352" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="568" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1065.5039"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="1279.9199"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7459.6172"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="7624.4805"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8804.0742"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="8938.3164"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9661.7227"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1066" y="9753.6543"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="10563.8262" style="stroke: #000000; stroke-width: 2.0;" width="1309" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M173,176.5977 L173,492.5977 L880,492.5977 L880,186.5977 L870,176.5977 L173,176.5977 " fill="#FFFF00" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M870,176.5977 L870,186.5977 L880,186.5977 L870,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="195" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="243" y="270.7188">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="613" x="243" y="286.0293">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="243" y="301.3398">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="243" y="316.6504">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="243" y="331.9609">{ "id": 5, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="362.582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="393.2031">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="408.5137">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="243" y="423.8242">{ "id": 6, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="195" y="469.7559">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="485.0664">}</text><polygon fill="#A80036" points="329,519.1191,339,523.1191,329,527.1191,333,523.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="168" x2="335" y1="523.1191" y2="523.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175" y="518.377">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="188" y="518.377">PUT - /settlement/{id}</text><polygon fill="#A80036" points="556,563.7402,566,567.7402,556,571.7402,560,567.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="562" y1="567.7402" y2="567.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="555.3428">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="371" y="547.6875">updateSettlementById routine</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="562.998">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="562.998">2001</text><path d="M476,582.7402 L641,582.7402 L641,589.7402 L631,599.7402 L476,599.7402 L476,582.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="9256.2246" style="stroke: #000000; stroke-width: 2.0;" width="836" x="476" y="582.7402"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="491" y="596.3086">DB TRANSACTION</text><polygon fill="#A80036" points="1054,617.3613,1064,621.3613,1054,625.3613,1058,621.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="621.3613" y2="621.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="616.6191">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="598" y="616.6191">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="884,634.3613,1258,634.3613,1268,691.3613,1258,749.3613,884,749.3613,874,691.3613,884,634.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="886" y="650.9297">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="902" y="666.2402">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="886" y="681.5508">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="926" y="681.5508">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1002" y="681.5508">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="886" y="696.8613">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="918" y="696.8613">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1079" y="696.8613">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="886" y="712.1719">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="886" y="727.4824">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="886" y="742.793">FOR UPDATE</text><polygon fill="#A80036" points="589,771.8457,579,775.8457,589,779.8457,585,775.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="775.8457" y2="775.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="771.1035">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="771.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="653" y="771.1035">settlementData</text><polygon fill="#A80036" points="1054,801.1563,1064,805.1563,1054,809.1563,1058,805.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="805.1563" y2="805.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="800.4141">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="598" y="800.4141">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="887,818.1563,1255,818.1563,1265,913.1563,1255,1009.1563,887,1009.1563,877,913.1563,887,818.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="889" y="834.7246">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="905" y="850.0352">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="905" y="865.3457">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="905" y="880.6563">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1157" y="880.6563">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="889" y="895.9668">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="929" y="895.9668">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1140" y="895.9668">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="889" y="911.2773">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="921" y="911.2773">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1217" y="911.2773">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="889" y="926.5879">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="889" y="941.8984">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="889" y="957.209">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="921" y="957.209">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1061" y="957.209">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="889" y="972.5195">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="889" y="987.8301">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="889" y="1003.1406">FOR UPDATE</text><polygon fill="#A80036" points="589,1032.1934,579,1036.1934,589,1040.1934,585,1036.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1036.1934" y2="1036.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="1031.4512">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="1031.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="653" y="1031.4512">settlementAccountsList</text><polygon fill="#A80036" points="1054,1061.5039,1064,1065.5039,1054,1069.5039,1058,1065.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="1065.5039" y2="1065.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="1060.7617">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="598" y="1060.7617">Retrive settlement windows information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="849,1078.5039,1292,1078.5039,1302,1150.5039,1292,1223.5039,849,1223.5039,839,1150.5039,849,1078.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="851" y="1095.0723">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="867" y="1110.3828">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="851" y="1125.6934">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="891" y="1125.6934">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1092" y="1125.6934">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1141.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="883" y="1141.0039">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1012" y="1141.0039">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="851" y="1156.3145">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1171.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="883" y="1171.625">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1097" y="1171.625">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="851" y="1186.9355">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="851" y="1202.2461">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="851" y="1217.5566">FOR UPDATE</text><polygon fill="#A80036" points="589,1246.6094,579,1250.6094,589,1254.6094,585,1250.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1250.6094" y2="1250.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="1245.8672">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="608" y="1245.8672">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="653" y="1245.8672">windowsList</text><polygon fill="#A80036" points="1054,1275.9199,1064,1279.9199,1054,1283.9199,1058,1279.9199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="1279.9199" y2="1279.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="585" y="1275.1777">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="598" y="1275.1777">Retrieve settlement windows accounts information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="876,1292.9199,1265,1292.9199,1275,1326.9199,1265,1361.9199,876,1361.9199,866,1326.9199,876,1292.9199" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="878" y="1309.4883">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="878" y="1324.7988">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="918" y="1324.7988">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="878" y="1340.1094">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="878" y="1355.4199">FOR UPDATE</text><polygon fill="#A80036" points="589,1384.4727,579,1388.4727,589,1392.4727,585,1388.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="1388.4727" y2="1388.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="1383.7305">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="1383.7305">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="662" y="1383.7305">windowsAccountsList</text><path d="M583,1401.4727 L583,1472.4727 L1080,1472.4727 L1080,1411.4727 L1070,1401.4727 L583,1401.4727 " fill="#ADD8E6" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1070,1401.4727 L1070,1411.4727 L1080,1411.4727 L1070,1401.4727 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="589" y="1419.041">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="589" y="1434.3516">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="589" y="1449.6621">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="589" y="1464.9727">B. Move to asyncronous processing where we don't need these objects</text><path d="M583,1486.7148 L583,2368.7148 L1272,2368.7148 L1272,1496.7148 L1262,1486.7148 L583,1486.7148 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1262,1486.7148 L1262,1496.7148 L1272,1496.7148 L1262,1486.7148 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="589" y="1504.2832">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="589" y="1519.5938">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="696" y="1519.5938">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="589" y="1534.9043">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="751" y="1534.9043">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="589" y="1550.2148">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="676" y="1550.2148">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="589" y="1565.5254">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="738" y="1565.5254">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="1580.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="589" y="1596.1465">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="589" y="1611.457">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="723" y="1611.457">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="845" y="1611.457">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="994" y="1611.457">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="605" y="1626.7676">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="605" y="1642.0781">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="605" y="1657.3887">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="605" y="1672.6992">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="605" y="1688.0098">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="605" y="1703.3203">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="1718.6309">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="589" y="1733.9414">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="749" y="1733.9414">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="589" y="1749.252">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="667" y="1749.252">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1077" y="1749.252">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1226" y="1749.252">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="605" y="1764.5625">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="621" y="1779.873">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="621" y="1795.1836">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="621" y="1810.4941">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="621" y="1825.8047">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="621" y="1841.1152">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="637" y="1856.4258">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="637" y="1871.7363">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="621" y="1887.0469">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="621" y="1902.3574">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="621" y="1917.668">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="651" y="1917.668">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="677" y="1917.668">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="1932.9785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="1948.2891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="589" y="1963.5996">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="665" y="1963.5996">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1175" y="1963.5996">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1253" y="1963.5996">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="605" y="1978.9102">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="621" y="1994.2207">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="621" y="2009.5313">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="621" y="2024.8418">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="621" y="2040.1523">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2055.4629">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2070.7734">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="589" y="2086.084">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="710" y="2086.084">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="605" y="2101.3945">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="621" y="2116.7051">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="621" y="2132.0156">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="621" y="2147.3262">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="621" y="2162.6367">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="621" y="2177.9473">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="621" y="2193.2578">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="621" y="2208.5684">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2223.8789">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2239.1895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="589" y="2254.5">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="736" y="2254.5">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="589" y="2269.8105">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="709" y="2269.8105">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="605" y="2285.1211">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="621" y="2300.4316">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="621" y="2315.7422">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="2331.0527">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2346.3633">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="589" y="2361.6738">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="609" y="2361.6738">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="765" y="2361.6738">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="2424.7266" y2="2424.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="2424.7266" y2="2437.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="2437.7266" y2="2437.7266"/><polygon fill="#A80036" points="589,2433.7266,579,2437.7266,589,2441.7266,585,2437.7266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="2419.9844">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="607" y="2419.9844">Declare and initialize variables</text><path d="M583,2450.7266 L583,2659.7266 L875,2659.7266 L875,2460.7266 L865,2450.7266 L583,2450.7266 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,2450.7266 L865,2460.7266 L875,2460.7266 L865,2450.7266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="589" y="2468.2949">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="2483.6055">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="605" y="2498.916">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="605" y="2514.2266">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="605" y="2529.5371">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="605" y="2544.8477">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="605" y="2560.1582">abortedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="605" y="2575.4688">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2590.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="589" y="2606.0898">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="589" y="2621.4004">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="589" y="2636.7109">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="589" y="2652.0215">let state</text><path d="M506,2675.7637 L580,2675.7637 L580,2682.7637 L570,2692.7637 L506,2692.7637 L506,2675.7637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="506" y="2675.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="521" y="2689.332">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="595" y="2688.3984">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="2714.3848" y2="2714.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="2714.3848" y2="2727.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="2727.3848" y2="2727.3848"/><polygon fill="#A80036" points="589,2723.3848,579,2727.3848,589,2731.3848,585,2727.3848" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="2709.6426">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="607" y="2709.6426">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="665" y="2709.6426">allAccounts</text><path d="M583,2740.3848 L583,2994.3848 L831,2994.3848 L831,2750.3848 L821,2740.3848 L583,2740.3848 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M821,2740.3848 L821,2750.3848 L831,2750.3848 L821,2740.3848 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="2757.9531">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="589" y="2773.2637">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="589" y="2788.5742">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="2803.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="589" y="2819.1953">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="605" y="2834.5059">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="605" y="2849.8164">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="605" y="2865.127">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="605" y="2880.4375">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="605" y="2895.748">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="621" y="2911.0586">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="621" y="2926.3691">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="605" y="2941.6797">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="605" y="2956.9902">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="605" y="2972.3008">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="2987.6113">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3025.6641" y2="3025.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3025.6641" y2="3038.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3038.6641" y2="3038.6641"/><polygon fill="#A80036" points="589,3034.6641,579,3038.6641,589,3042.6641,585,3038.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3020.9219">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="607" y="3020.9219">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="665" y="3020.9219">settlementAccounts</text><path d="M573,3053.6641 L635,3053.6641 L635,3060.6641 L625,3070.6641 L573,3070.6641 L573,3053.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="573" y="3053.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="3067.2324">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="650" y="3066.2988">[state == 'PENDING_SETTLEMENT']</text><path d="M583,3075.9746 L583,3100.9746 L910,3100.9746 L910,3085.9746 L900,3075.9746 L583,3075.9746 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,3075.9746 L900,3085.9746 L910,3085.9746 L900,3075.9746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="589" y="3093.543">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3111.2852" y2="3111.2852"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="578" y="3121.9199">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M583,3130.2402 L583,3155.2402 L924,3155.2402 L924,3140.2402 L914,3130.2402 L583,3130.2402 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M914,3130.2402 L914,3140.2402 L924,3140.2402 L914,3130.2402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="589" y="3147.8086">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3165.5508" y2="3165.5508"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="578" y="3176.1855">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M583,3184.5059 L583,3209.5059 L922,3209.5059 L922,3194.5059 L912,3184.5059 L583,3184.5059 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M912,3184.5059 L912,3194.5059 L922,3194.5059 L912,3184.5059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="589" y="3202.0742">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3219.8164" y2="3219.8164"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="578" y="3230.4512">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M583,3238.7715 L583,3263.7715 L936,3263.7715 L936,3248.7715 L926,3238.7715 L583,3238.7715 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M926,3238.7715 L926,3248.7715 L936,3248.7715 L926,3238.7715 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="589" y="3256.3398">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3274.082" y2="3274.082"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="578" y="3284.7168">[state == 'SETTLED']</text><path d="M583,3293.0371 L583,3318.0371 L835,3318.0371 L835,3303.0371 L825,3293.0371 L583,3293.0371 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M825,3293.0371 L825,3303.0371 L835,3303.0371 L825,3293.0371 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="589" y="3310.6055">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3328.3477" y2="3328.3477"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="578" y="3338.9824">[state == 'ABORTED']</text><path d="M583,3347.3027 L583,3372.3027 L840,3372.3027 L840,3357.3027 L830,3347.3027 L583,3347.3027 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M830,3347.3027 L830,3357.3027 L840,3357.3027 L830,3347.3027 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="589" y="3364.8711">settlementAccounts.abortedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="950" y1="3382.6133" y2="3382.6133"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="578" y="3393.248">[default]</text><path d="M583,3401.5684 L583,3426.5684 L850,3426.5684 L850,3411.5684 L840,3401.5684 L583,3401.5684 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M840,3401.5684 L840,3411.5684 L850,3411.5684 L840,3401.5684 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="589" y="3419.1367">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3471.1895" y2="3471.1895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3471.1895" y2="3484.1895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3484.1895" y2="3484.1895"/><polygon fill="#A80036" points="589,3480.1895,579,3484.1895,589,3488.1895,585,3484.1895" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3466.4473">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="607" y="3466.4473">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="865" y="3466.4473">settlementAccountsInit</text><path d="M583,3497.1895 L583,3522.1895 L1005,3522.1895 L1005,3507.1895 L995,3497.1895 L583,3497.1895 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M995,3497.1895 L995,3507.1895 L1005,3507.1895 L995,3497.1895 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="589" y="3514.7578">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3577.8105" y2="3577.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3577.8105" y2="3590.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3590.8105" y2="3590.8105"/><polygon fill="#A80036" points="589,3586.8105,579,3590.8105,589,3594.8105,585,3590.8105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3573.0684">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="607" y="3573.0684">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="744" y="3573.0684">allWindows</text><path d="M583,3603.8105 L583,3628.8105 L819,3628.8105 L819,3613.8105 L809,3603.8105 L583,3603.8105 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M809,3603.8105 L809,3613.8105 L819,3613.8105 L809,3603.8105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="589" y="3621.3789">let allWindows = {} // declare map</text><path d="M573,3645.1211 L647,3645.1211 L647,3652.1211 L637,3662.1211 L573,3662.1211 L573,3645.1211 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="573" y="3645.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="588" y="3658.6895">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="662" y="3657.7559">[windowsList as window]</text><path d="M583,3667.4316 L583,3768.4316 L885,3768.4316 L885,3677.4316 L875,3667.4316 L583,3667.4316 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M875,3667.4316 L875,3677.4316 L885,3677.4316 L875,3667.4316 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="589" y="3685">allWindows[window.settlementWindowId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="605" y="3700.3105">id: window.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="605" y="3715.6211">state: window.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="605" y="3730.9316">reason: window.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="605" y="3746.2422">createDate: window.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="3761.5527">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="3831.6055" y2="3831.6055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="3831.6055" y2="3844.6055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="3844.6055" y2="3844.6055"/><polygon fill="#A80036" points="589,3840.6055,579,3844.6055,589,3848.6055,585,3844.6055" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="3826.8633">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="607" y="3826.8633">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="744" y="3826.8633">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="868" y="3826.8633">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="895" y="3826.8633">windowsAccounts</text><path d="M583,3857.6055 L583,3897.6055 L862,3897.6055 L862,3867.6055 L852,3857.6055 L583,3857.6055 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M852,3857.6055 L852,3867.6055 L862,3867.6055 L852,3857.6055 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="589" y="3875.1738">let accountsWindows = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="589" y="3890.4844">let windowsAccounts = {} // declare map</text><path d="M563,3914.2266 L637,3914.2266 L637,3921.2266 L627,3931.2266 L563,3931.2266 L563,3914.2266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="628.2285" style="stroke: #000000; stroke-width: 2.0;" width="534" x="563" y="3914.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="578" y="3927.7949">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="652" y="3926.8613">[windowsAccountsList as record]</text><path d="M583,3936.5371 L583,4190.5371 L1083,4190.5371 L1083,3946.5371 L1073,3936.5371 L583,3936.5371 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1073,3936.5371 L1073,3946.5371 L1083,3946.5371 L1073,3936.5371 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="589" y="3954.1055">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="589" y="3969.416">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="589" y="3984.7266">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4000.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="589" y="4015.3477">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="605" y="4030.6582">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="605" y="4045.9688">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="4061.2793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="589" y="4076.5898">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4091.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="589" y="4107.2109">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="605" y="4122.5215">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="4137.832">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="605" y="4153.1426">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="605" y="4168.4531">abortedCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="4183.7637">}</text><path d="M573,4207.5059 L635,4207.5059 L635,4214.5059 L625,4224.5059 L573,4224.5059 L573,4207.5059 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="327.9492" style="stroke: #000000; stroke-width: 2.0;" width="395" x="573" y="4207.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="4221.0742">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="650" y="4220.1406">[state == 'PENDING_SETTLEMENT']</text><path d="M583,4229.8164 L583,4254.8164 L928,4254.8164 L928,4239.8164 L918,4229.8164 L583,4229.8164 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M918,4229.8164 L918,4239.8164 L928,4239.8164 L918,4229.8164 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="589" y="4247.3848">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4265.127" y2="4265.127"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="578" y="4275.7617">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M583,4284.082 L583,4309.082 L942,4309.082 L942,4294.082 L932,4284.082 L583,4284.082 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M932,4284.082 L932,4294.082 L942,4294.082 L932,4284.082 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="589" y="4301.6504">windowsAccounts[wid].psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4319.3926" y2="4319.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="578" y="4330.0273">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M583,4338.3477 L583,4363.3477 L940,4363.3477 L940,4348.3477 L930,4338.3477 L583,4338.3477 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M930,4338.3477 L930,4348.3477 L940,4348.3477 L930,4338.3477 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="589" y="4355.916">windowsAccounts[wid].psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4373.6582" y2="4373.6582"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="578" y="4384.293">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M583,4392.6133 L583,4417.6133 L954,4417.6133 L954,4402.6133 L944,4392.6133 L583,4392.6133 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M944,4392.6133 L944,4402.6133 L954,4402.6133 L944,4392.6133 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="589" y="4410.1816">windowsAccounts[wid].psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4427.9238" y2="4427.9238"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="578" y="4438.5586">[state == 'SETTLED']</text><path d="M583,4446.8789 L583,4471.8789 L853,4471.8789 L853,4456.8789 L843,4446.8789 L583,4446.8789 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M843,4446.8789 L843,4456.8789 L853,4456.8789 L843,4446.8789 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="589" y="4464.4473">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="968" y1="4482.1895" y2="4482.1895"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="578" y="4492.8242">[state == 'ABORTED']</text><path d="M583,4501.1445 L583,4526.1445 L858,4526.1445 L858,4511.1445 L848,4501.1445 L583,4501.1445 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M848,4501.1445 L848,4511.1445 L858,4511.1445 L848,4501.1445 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="589" y="4518.7129">windowsAccounts[wid].abortedCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="4570.7656" y2="4570.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="4570.7656" y2="4583.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="4583.7656" y2="4583.7656"/><polygon fill="#A80036" points="589,4579.7656,579,4583.7656,589,4587.7656,585,4583.7656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="4566.0234">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="607" y="4566.0234">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="853" y="4566.0234">windowsAccountsInit</text><path d="M583,4596.7656 L583,4621.7656 L981,4621.7656 L981,4606.7656 L971,4596.7656 L583,4596.7656 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M971,4596.7656 L971,4606.7656 L981,4606.7656 L971,4596.7656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="589" y="4614.334">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M583,4661.0762 L583,4854.0762 L1277,4854.0762 L1277,4671.0762 L1267,4661.0762 L583,4661.0762 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1267,4661.0762 L1267,4671.0762 L1277,4671.0762 L1267,4661.0762 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="589" y="4678.6445">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="589" y="4693.9551">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="727" y="4693.9551">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="589" y="4709.2656">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="671" y="4709.2656">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="589" y="4724.5762">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="669" y="4724.5762">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="589" y="4739.8867">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="714" y="4739.8867">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="589" y="4755.1973">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="713" y="4755.1973">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="4770.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="589" y="4785.8184">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="797" y="4785.8184">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="851" y="4785.8184">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="589" y="4801.1289">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="674" y="4801.1289">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="589" y="4816.4395">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="708" y="4816.4395">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="589" y="4831.75">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="885" y="4831.75">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="589" y="4847.0605">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="724" y="4847.0605">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M486,4895.8027 L560,4895.8027 L560,4902.8027 L550,4912.8027 L486,4912.8027 L486,4895.8027 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2511.1934" style="stroke: #000000; stroke-width: 2.0;" width="797" x="486" y="4895.8027"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="501" y="4909.3711">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="575" y="4908.4375">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="4934.4238" y2="4934.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="4934.4238" y2="4947.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="4947.4238" y2="4947.4238"/><polygon fill="#A80036" points="589,4943.4238,579,4947.4238,589,4951.4238,585,4947.4238" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="4929.6816">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="607" y="4929.6816">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="750" y="4929.6816">participantPayload</text><path d="M583,4960.4238 L583,5031.4238 L963,5031.4238 L963,4970.4238 L953,4960.4238 L583,4960.4238 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M953,4960.4238 L953,4970.4238 L963,4970.4238 L953,4960.4238 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="589" y="4977.9922">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="589" y="4993.3027">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="589" y="5008.6133">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="589" y="5023.9238">participant = participants[pi]</text><path d="M496,5047.666 L570,5047.666 L570,5054.666 L560,5064.666 L496,5064.666 L496,5047.666 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2352.3301" style="stroke: #000000; stroke-width: 2.0;" width="777" x="496" y="5047.666"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="511" y="5061.2344">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="585" y="5060.3008">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5086.2871" y2="5086.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5086.2871" y2="5099.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5099.2871" y2="5099.2871"/><polygon fill="#A80036" points="589,5095.2871,579,5099.2871,589,5103.2871,585,5099.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5081.5449">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="607" y="5081.5449">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="750" y="5081.5449">accountPayload</text><path d="M583,5112.2871 L583,5137.2871 L975,5137.2871 L975,5122.2871 L965,5112.2871 L583,5112.2871 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M965,5112.2871 L965,5122.2871 L975,5122.2871 L965,5112.2871 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="589" y="5129.8555">let accountPayload = participantPayload.accounts[account]</text><path d="M506,5153.5977 L568,5153.5977 L568,5160.5977 L558,5170.5977 L506,5170.5977 L506,5153.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2239.3984" style="stroke: #000000; stroke-width: 2.0;" width="757" x="506" y="5153.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="521" y="5167.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="583" y="5166.2324">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5192.2188" y2="5192.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5192.2188" y2="5205.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5205.2188" y2="5205.2188"/><polygon fill="#A80036" points="589,5201.2188,579,5205.2188,589,5209.2188,585,5205.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5187.4766">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="607" y="5187.4766">If the account doesn't match the settlement</text><path d="M583,5218.2188 L583,5335.2188 L871,5335.2188 L871,5228.2188 L861,5218.2188 L583,5218.2188 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M861,5218.2188 L861,5228.2188 L871,5228.2188 L861,5218.2188 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5235.7871">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5251.0977">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5266.4082">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5281.7188">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="621" y="5297.0293">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5312.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5327.6504">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5345.3926" y2="5345.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="392" x="511" y="5356.0273">[participantPayload.id != allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5380.6582" y2="5380.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5380.6582" y2="5393.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5393.6582" y2="5393.6582"/><polygon fill="#A80036" points="589,5389.6582,579,5393.6582,589,5397.6582,585,5393.6582" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5375.916">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="607" y="5375.916">If the account doesn't match the participant</text><path d="M583,5406.6582 L583,5523.6582 L967,5523.6582 L967,5416.6582 L957,5406.6582 L583,5406.6582 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M957,5406.6582 L957,5416.6582 L967,5416.6582 L957,5406.6582 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5424.2266">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5439.5371">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5454.8477">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5470.1582">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="621" y="5485.4688">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5500.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5516.0898">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5533.832" y2="5533.832"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="511" y="5544.4668">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5569.0977" y2="5569.0977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5569.0977" y2="5582.0977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5582.0977" y2="5582.0977"/><polygon fill="#A80036" points="589,5578.0977,579,5582.0977,589,5586.0977,585,5582.0977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5564.3555">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="607" y="5564.3555">If the account has been previosly processed (duplicated in the payload)</text><path d="M583,5595.0977 L583,5773.0977 L1102,5773.0977 L1102,5605.0977 L1092,5595.0977 L583,5595.0977 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,5595.0977 L1092,5605.0977 L1102,5605.0977 L1092,5595.0977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5612.666">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5627.9766">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="605" y="5643.2871">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="605" y="5658.5977">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="605" y="5673.9082">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="5689.2188">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="5704.5293">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="621" y="5719.8398">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="621" y="5735.1504">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="5750.4609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5765.7715">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="5783.5137" y2="5783.5137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="371" x="511" y="5794.1484">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="5818.7793" y2="5818.7793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="5818.7793" y2="5831.7793"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="5831.7793" y2="5831.7793"/><polygon fill="#A80036" points="589,5827.7793,579,5831.7793,589,5835.7793,585,5831.7793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="5814.0371">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="607" y="5814.0371">Same-state reason amendment is always allowed</text><path d="M583,5844.7793 L583,6114.7793 L1102,6114.7793 L1102,5854.7793 L1092,5844.7793 L583,5844.7793 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,5844.7793 L1092,5854.7793 L1102,5854.7793 L1092,5844.7793 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="589" y="5862.3477">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="5877.6582">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="5892.9688">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="5908.2793">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="5923.5898">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="5938.9004">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="605" y="5954.2109">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="5969.5215">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="5984.832">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="589" y="6000.1426">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="605" y="6015.4531">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="605" y="6030.7637">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6046.0742">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="605" y="6061.3848">externalReference: accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6076.6953">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="589" y="6092.0059">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="589" y="6107.3164">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6125.0586" y2="6125.0586"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="610" x="511" y="6135.6934">[settlementData.state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6140.0137" y2="6140.0137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="628" x="511" y="6150.6484">[settlementData.state == 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6154.9688" y2="6154.9688"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="511" y="6165.6035">[settlementData.state == 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="6169.9238" y2="6169.9238"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="752" x="511" y="6180.5586">[settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' &amp;&amp; accountPayload.state == 'SETTLED']</text><path d="M583,6188.8789 L583,6228.8789 L1108,6228.8789 L1108,6198.8789 L1098,6188.8789 L583,6188.8789 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1098,6188.8789 L1098,6198.8789 L1108,6198.8789 L1098,6188.8789 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="589" y="6206.4473">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="620" y="6206.4473">: Since we previously checked same-state, here we don't need to match</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="504" x="589" y="6221.7578">allAccounts[account.id].state == settlementData.state. We can safely assume it.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="6259.8105" y2="6259.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="6259.8105" y2="6272.8105"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="6272.8105" y2="6272.8105"/><polygon fill="#A80036" points="589,6268.8105,579,6272.8105,589,6276.8105,585,6272.8105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="6255.0684">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="607" y="6255.0684">Settlement acknowledgement</text><path d="M583,6285.8105 L583,6815.8105 L1148,6815.8105 L1148,6295.8105 L1138,6285.8105 L583,6285.8105 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1138,6285.8105 L1138,6295.8105 L1148,6295.8105 L1138,6285.8105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="589" y="6303.3789">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="6318.6895">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="6334">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="605" y="6349.3105">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6364.6211">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="6379.9316">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="605" y="6395.2422">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="6410.5527">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6425.8633">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="589" y="6441.1738">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="605" y="6456.4844">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="605" y="6471.7949">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="605" y="6487.1055">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="605" y="6502.416">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605" y="6517.7266"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="605" y="6517.7266">settlementTransferId: Uuid() -- only for PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="6533.0371">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="589" y="6548.3477">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="605" y="6563.6582">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="605" y="6578.9688">settlementAccounts.psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="589" y="6594.2793">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="605" y="6609.5898">settlementAccounts.psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="605" y="6624.9004">settlementAccounts.psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="589" y="6640.2109">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="605" y="6655.5215">settlementAccounts.psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="605" y="6670.832">settlementAccounts.psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="589" y="6686.1426">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="605" y="6701.4531">settlementAccounts.psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="605" y="6716.7637">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="6732.0742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="589" y="6747.3848">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="589" y="6762.6953">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="589" y="6778.0059">allAccounts[accountPayload.id].externalReference = accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="589" y="6793.3164">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="589" y="6808.627">let settlementWindowId</text><path d="M573,6832.3691 L647,6832.3691 L647,6839.3691 L637,6849.3691 L573,6849.3691 L573,6832.3691 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="316.9004" style="stroke: #000000; stroke-width: 2.0;" width="517" x="573" y="6832.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="588" y="6845.9375">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="662" y="6845.0039">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M583,6854.6797 L583,7139.6797 L1076,7139.6797 L1076,6864.6797 L1066,6854.6797 L583,6854.6797 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1066,6854.6797 L1066,6864.6797 L1076,6864.6797 L1066,6854.6797 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="589" y="6872.248">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="6887.5586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="589" y="6902.8691">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="605" y="6918.1797">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444" x="605" y="6933.4902">windowsAccounts[settlementWindowId].psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="589" y="6948.8008">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="605" y="6964.1113">windowsAccounts[settlementWindowId].psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="605" y="6979.4219">windowsAccounts[settlementWindowId].psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="589" y="6994.7324">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="605" y="7010.043">windowsAccounts[settlementWindowId].psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="605" y="7025.3535">windowsAccounts[settlementWindowId].psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="589" y="7040.6641">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="605" y="7055.9746">windowsAccounts[settlementWindowId].psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="605" y="7071.2852">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="7086.5957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="589" y="7101.9063">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="605" y="7117.2168">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="589" y="7132.5273">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1263" y1="7157.2695" y2="7157.2695"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="7179.5801" y2="7179.5801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="7179.5801" y2="7192.5801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="7192.5801" y2="7192.5801"/><polygon fill="#A80036" points="589,7188.5801,579,7192.5801,589,7196.5801,585,7192.5801" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7174.8379">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="607" y="7174.8379">All other state transitions are not permitted</text><path d="M583,7205.5801 L583,7383.5801 L1102,7383.5801 L1102,7215.5801 L1092,7205.5801 L583,7205.5801 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1092,7205.5801 L1092,7215.5801 L1102,7215.5801 L1092,7205.5801 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="589" y="7223.1484">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="605" y="7238.459">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="605" y="7253.7695">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="605" y="7269.0801">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="605" y="7284.3906">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="605" y="7299.7012">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="605" y="7315.0117">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="621" y="7330.3223">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="621" y="7345.6328">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="605" y="7360.9434">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="589" y="7376.2539">})</text><path d="M506,7420.9961 L919,7420.9961 L919,7427.9961 L909,7437.9961 L506,7437.9961 L506,7420.9961 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="506" y="7420.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="521" y="7434.5645">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1054,7455.6172,1064,7459.6172,1054,7463.6172,1058,7459.6172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="7459.6172" y2="7459.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7454.875">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="607" y="7454.875">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="935,7472.6172,1207,7472.6172,1217,7483.6172,1207,7495.6172,935,7495.6172,925,7483.6172,935,7472.6172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="937" y="7489.1855">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="589,7518.2383,579,7522.2383,589,7526.2383,585,7522.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="7522.2383" y2="7522.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="7517.4961">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="7517.4961">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="662" y="7517.4961">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="7582.1699" y2="7582.1699"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="7582.1699" y2="7595.1699"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="7595.1699" y2="7595.1699"/><polygon fill="#A80036" points="589,7591.1699,579,7595.1699,589,7599.1699,585,7595.1699" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7562.1172">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="607" y="7546.8066">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="607" y="7562.1172">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="607" y="7577.4277">issue the following update in one knex command</text><polygon fill="#A80036" points="1054,7620.4805,1064,7624.4805,1054,7628.4805,1058,7624.4805" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="7624.4805" y2="7624.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="7619.7383">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="607" y="7619.7383">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="858,7667.4805,1284,7667.4805,1294,7739.4805,1284,7812.4805,858,7812.4805,848,7739.4805,858,7667.4805" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="860" y="7684.0488">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="914" y="7684.0488">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="860" y="7699.3594">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="876" y="7714.6699">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7729.9805"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="876" y="7729.9805">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7745.291"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="876" y="7745.291">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="876" y="7760.6016"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="876" y="7760.6016">-- only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="860" y="7775.9121">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="892" y="7791.2227">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="892" y="7806.5332">.settlementParticipantCurrencyIdList}</text><path d="M506,7832.2754 L568,7832.2754 L568,7839.2754 L558,7849.2754 L506,7849.2754 L506,7832.2754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="506" y="7832.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="521" y="7845.8438">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="583" y="7844.9102">[settlementData.state == 'PENDING_SETTLEMENT']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="7874.5859"/><polygon fill="#EEEEEE" points="513,7874.5859,577,7874.5859,577,7881.5859,567,7891.5859,513,7891.5859,513,7874.5859" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="7889.1543">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="640" y="7908.1543">Settlement Transfer Prepare {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="821" y="7908.1543">6.3.1</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="821" x2="853" y1="7910.1543" y2="7910.1543"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="853" y="7908.1543">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="7923.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="7938.7754">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="7938.7754">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="7954.0859"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1129" y1="7992.1387" y2="7992.1387"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="511" y="8002.7734">[settlementData.state == 'PS_TRANSFERS_RECORDED']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="8031.0938"/><polygon fill="#EEEEEE" points="513,8031.0938,577,8031.0938,577,8038.0938,567,8048.0938,513,8048.0938,513,8031.0938" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="8045.6621">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="640" y="8064.6621">Settlement Transfer Reserve {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="823" y="8064.6621">6.3.2</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="823" x2="855" y1="8066.6621" y2="8066.6621"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="855" y="8064.6621">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8079.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="8095.2832">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="8095.2832">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8110.5938"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506" x2="1129" y1="8148.6465" y2="8148.6465"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="511" y="8159.2813">[settlementData.state == 'PS_TRANSFERS_RESERVED']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="513" y="8187.6016"/><polygon fill="#EEEEEE" points="513,8187.6016,577,8187.6016,577,8194.6016,567,8204.6016,513,8204.6016,513,8187.6016" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="526" y="8202.1699">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="640" y="8221.1699">Settlement Transfer Commit {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="825" y="8221.1699">6.3.3</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="825" x2="857" y1="8223.1699" y2="8223.1699"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="857" y="8221.1699">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8236.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="640" y="8251.791">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="683" y="8251.791">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="644" y="8267.1016"/><path d="M506,8318.1543 L891,8318.1543 L891,8325.1543 L881,8335.1543 L506,8335.1543 L506,8318.1543 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="691.4727" style="stroke: #000000; stroke-width: 2.0;" width="749" x="506" y="8318.1543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="521" y="8331.7227">Prepare and insert settlementWindowStateChange</text><path d="M583,8340.4648 L583,8426.4648 L895,8426.4648 L895,8350.4648 L885,8340.4648 L583,8340.4648 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M885,8340.4648 L885,8350.4648 L895,8350.4648 L885,8340.4648 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="589" y="8358.0332">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="589" y="8373.3438">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="589" y="8388.6543">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="589" y="8403.9648">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="589" y="8419.2754">let windowState</text><path d="M553,8443.0176 L627,8443.0176 L627,8450.0176 L617,8460.0176 L553,8460.0176 L553,8443.0176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="332.7461" style="stroke: #000000; stroke-width: 2.0;" width="676" x="553" y="8443.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="568" y="8456.5859">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="642" y="8455.6523">[let aw IN affectedWindows]</text><path d="M583,8465.3281 L583,8505.3281 L1018,8505.3281 L1018,8475.3281 L1008,8465.3281 L583,8465.3281 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1008,8465.3281 L1008,8475.3281 L1018,8475.3281 L1008,8465.3281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="589" y="8482.8965">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="589" y="8498.207">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M563,8521.9492 L630,8521.9492 L630,8528.9492 L620,8538.9492 L563,8538.9492 L563,8521.9492 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="246.8145" style="stroke: #000000; stroke-width: 2.0;" width="656" x="563" y="8521.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="578" y="8535.5176">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="509" x="645" y="8534.584">[windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="549" x="645" y="8547.5391">|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="547" x="645" y="8560.4941">|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="569" x="645" y="8573.4492">|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="389" x="645" y="8586.4043">|| windowAccounts.settledCount != windowAccountsInit.settledCount]</text><path d="M583,8594.0352 L583,8619.0352 L981,8619.0352 L981,8604.0352 L971,8594.0352 L583,8594.0352 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M971,8594.0352 L971,8604.0352 L981,8604.0352 L971,8594.0352 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="589" y="8611.6035">settlementWindows.push(allWindows[affectedWindows[aw]])</text><path d="M573,8635.3457 L640,8635.3457 L640,8642.3457 L630,8652.3457 L573,8652.3457 L573,8635.3457 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="597" x="573" y="8635.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="588" y="8648.9141">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="296" x="655" y="8647.9805">[windowAccounts.psTransfersCommittedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="655" y="8660.9355">&amp;&amp; windowAccounts.abortedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="655" y="8673.8906">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M583,8681.5215 L583,8752.5215 L1156,8752.5215 L1156,8691.5215 L1146,8681.5215 L583,8681.5215 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1146,8681.5215 L1146,8691.5215 L1156,8691.5215 L1146,8681.5215 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="589" y="8699.0898">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="552" x="589" y="8714.4004">allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="589" y="8729.7109">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="589" y="8745.0215">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="1054,8800.0742,1064,8804.0742,1054,8808.0742,1058,8804.0742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="8804.0742" y2="8804.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8799.332">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="607" y="8799.332">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="972,8817.0742,1170,8817.0742,1180,8828.0742,1170,8840.0742,972,8840.0742,962,8828.0742,972,8817.0742" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="974" y="8833.6426">settlementWindowStateChange</text><polygon fill="#A80036" points="589,8862.6953,579,8866.6953,589,8870.6953,585,8866.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="8866.6953" y2="8866.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="8861.9531">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="8861.9531">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="662" y="8861.9531">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="620" y1="8896.0059" y2="8896.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="620" x2="620" y1="8896.0059" y2="8909.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579" x2="620" y1="8909.0059" y2="8909.0059"/><polygon fill="#A80036" points="589,8905.0059,579,8909.0059,589,8913.0059,585,8909.0059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8891.2637">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="607" y="8891.2637">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="1054,8934.3164,1064,8938.3164,1054,8942.3164,1058,8938.3164" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="8938.3164" y2="8938.3164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="8933.5742">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="607" y="8933.5742">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="906,8981.3164,1235,8981.3164,1245,8992.3164,1235,9004.3164,906,9004.3164,896,8992.3164,906,8981.3164" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="908" y="8997.8848">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="962" y="8997.8848">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1087" y="8997.8848">.currentStateChangeIds</text><path d="M496,9023.627 L828,9023.627 L828,9030.627 L818,9040.627 L496,9040.627 L496,9023.627 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="496" y="9023.627"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="511" y="9037.1953">Prepare and insert settlementStateChange</text><path d="M583,9045.9375 L583,9070.9375 L820,9070.9375 L820,9055.9375 L810,9045.9375 L583,9045.9375 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M810,9045.9375 L810,9055.9375 L820,9055.9375 L810,9045.9375 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="589" y="9063.5059">let settlementStateChanged = true</text><path d="M573,9087.248 L635,9087.248 L635,9094.248 L625,9104.248 L573,9104.248 L573,9087.248 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="573" y="9087.248"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="588" y="9100.8164">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="650" y="9099.8828">[settlementData.state == 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="650" y="9112.8379">&amp;&amp; settlementAccounts.pendingSettlementCount == 0]</text><path d="M583,9120.4688 L583,9160.4688 L1114,9160.4688 L1114,9130.4688 L1104,9120.4688 L583,9120.4688 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1104,9120.4688 L1104,9130.4688 L1114,9130.4688 L1104,9120.4688 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="589" y="9138.0371">settlementData.state = 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="510" x="589" y="9153.3477">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9171.0898" y2="9171.0898"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="578" y="9181.7246">[settlementData.state == 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="321" x="578" y="9194.6797">&amp;&amp; settlementAccounts.psTransfersRecordedCount == 0]</text><path d="M583,9203 L583,9243 L1107,9243 L1107,9213 L1097,9203 L583,9203 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1097,9203 L1097,9213 L1107,9213 L1097,9203 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="589" y="9220.5684">settlementData.state = 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="503" x="589" y="9235.8789">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9253.6211" y2="9253.6211"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="578" y="9264.2559">[settlementData.state == 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="578" y="9277.2109">&amp;&amp; settlementAccounts.psTransfersReservedCount == 0]</text><path d="M583,9285.5313 L583,9325.5313 L1123,9325.5313 L1123,9295.5313 L1113,9285.5313 L583,9285.5313 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1113,9285.5313 L1113,9295.5313 L1123,9295.5313 L1113,9285.5313 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="589" y="9303.0996">settlementData.state = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="589" y="9318.4102">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9336.1523" y2="9336.1523"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="578" y="9346.7871">[settlementData.state == 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="318" x="578" y="9359.7422">&amp;&amp; settlementAccounts.psTransfersCommittedCount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="578" y="9372.6973">&amp;&amp; settlementAccounts.settledCount &gt; 0]</text><path d="M583,9381.0176 L583,9421.0176 L1017,9421.0176 L1017,9391.0176 L1007,9381.0176 L583,9381.0176 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1007,9381.0176 L1007,9391.0176 L1017,9391.0176 L1007,9381.0176 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="589" y="9398.5859">settlementData.state = 'SETTLING'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="589" y="9413.8965">settlementData.reason = 'Some settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9431.6387" y2="9431.6387"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="534" x="578" y="9442.2734">[(settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="578" y="9455.2285">&amp;&amp; settlementAccounts.psTransfersCommittedCount == 0]</text><path d="M583,9463.5488 L583,9503.5488 L1000,9503.5488 L1000,9473.5488 L990,9463.5488 L583,9463.5488 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M990,9463.5488 L990,9473.5488 L1000,9473.5488 L990,9463.5488 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="589" y="9481.1172">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="589" y="9496.4277">settlementData.reason = 'All settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="573" x2="1137" y1="9514.1699" y2="9514.1699"/><path d="M583,9520.1699 L583,9545.1699 L805,9545.1699 L805,9530.1699 L795,9520.1699 L583,9520.1699 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M795,9520.1699 L795,9530.1699 L805,9530.1699 L795,9520.1699 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="589" y="9537.7383">settlementStateChanged = false</text><path d="M506,9568.4805 L573,9568.4805 L573,9575.4805 L563,9585.4805 L506,9585.4805 L506,9568.4805 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="506" y="9568.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="521" y="9582.0488">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="588" y="9581.1152">[settlementStateChanged == true]</text><path d="M583,9590.791 L583,9630.791 L912,9630.791 L912,9600.791 L902,9590.791 L583,9590.791 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M902,9590.791 L902,9600.791 L912,9600.791 L902,9590.791 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="589" y="9608.3594">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="589" y="9623.6699">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1054,9657.7227,1064,9661.7227,1054,9665.7227,1058,9661.7227" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="9661.7227" y2="9661.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="9656.9805">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="607" y="9656.9805">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="996,9674.7227,1145,9674.7227,1155,9685.7227,1145,9697.7227,996,9697.7227,986,9685.7227,996,9674.7227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="998" y="9691.291">settlementStateChange</text><polygon fill="#A80036" points="589,9720.3438,579,9724.3438,589,9728.3438,585,9724.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="583" x2="1070" y1="9724.3438" y2="9724.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="9719.6016">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="617" y="9719.6016">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="662" y="9719.6016">settlementStateChangeId</text><polygon fill="#A80036" points="1054,9749.6543,1064,9753.6543,1054,9757.6543,1058,9753.6543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="578" x2="1060" y1="9753.6543" y2="9753.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="585" y="9748.9121">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="607" y="9748.9121">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="936,9796.6543,1205,9796.6543,1215,9807.6543,1205,9819.6543,936,9819.6543,926,9807.6543,936,9796.6543" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="938" y="9813.2227">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="992" y="9813.2227">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1064" y="9813.2227">.currentStateChangeId</text><polygon fill="#A80036" points="362,9863.2754,352,9867.2754,362,9871.2754,358,9867.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="572" y1="9867.2754" y2="9867.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="9862.5332">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="390" y="9862.5332">Return transaction result</text><path d="M40,9880.2754 L40,10517.2754 L332,10517.2754 L332,9890.2754 L322,9880.2754 L40,9880.2754 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,9880.2754 L322,9890.2754 L332,9890.2754 L322,9880.2754 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="46" y="9897.8438">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="9913.1543">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="9913.1543">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="183" y="9913.1543">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="9928.4648">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="9943.7754">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="78" y="9959.0859">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="78" y="9974.3965">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="78" y="9989.707">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10005.0176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="10020.3281">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="10035.6387">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="51" y="10035.6387">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="132" y="10035.6387">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10050.9492">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="10066.2598">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="78" y="10081.5703">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10096.8809">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="10112.1914">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="110" y="10127.502">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="10142.8125">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="110" y="10158.123">"externalReference": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="10173.4336">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="10188.7441">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="10204.0547">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="10219.3652">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="10234.6758">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="10249.9863">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10265.2969">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="10280.6074">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="110" y="10295.918">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="10311.2285">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="10326.5391">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="10341.8496">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="10357.1602">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="10372.4707">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="110" y="10387.7813">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="110" y="10403.0918">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="126" y="10418.4023">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="126" y="10433.7129">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="10449.0234">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="10464.334">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="10479.6445">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="10494.9551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="10510.2656">]</text><path d="M23,10532.0078 L23,10679.0078 L332,10679.0078 L332,10542.0078 L322,10532.0078 L23,10532.0078 " fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,10532.0078 L322,10542.0078 L332,10542.0078 L322,10532.0078 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="10549.5762">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="10564.8867">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="10580.1973">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="10595.5078">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="10610.8184">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="45" y="10626.1289">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="45" y="10641.4395">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="10656.75">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="10672.0605">]</text><polygon fill="#A80036" points="179,10706.1133,169,10710.1133,179,10714.1133,175,10710.1133" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="173" x2="345" y1="10710.1133" y2="10710.1133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="185" y="10705.3711">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="207" y="10705.3711">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": <string> },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": <string>, "externalReference": <string> },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": <string> },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": <string>, "externalReference": <string> },
                        { "id": 5, "state": "SETTLED", "reason": <string> }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "SETTLED", "reason": <string> }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById routine\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId,
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement windows information
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrieve settlement windows accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT DISTINCT settlementWindowId, participantCurrencyId
            FROM **settlementTransferParticipant**
            WHERE settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsAccountsList**
        deactivate DB

        note right of SETTLE_DAO #lightblue
            All objects below are done for the purposes of the syncronous request.
            If at same point Node process memory limit is reached we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                abortedCount: <integer> // count of accounts in ABORTED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId,
                    reason: reason,
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                    psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                    psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                    psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                    settledCount: <integer>, // count of accounts in SETTLED state
                    abortedCount: <integer> // count of accounts in ABORTED state
                }
            }
            **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                abortedCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts**
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.abortedCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **allWindows**
        note right of SETTLE_DAO #lightgray
            let allWindows = {} // declare map
        end note
        loop windowsList as window
            note right of SETTLE_DAO #lightgray
                allWindows[window.settlementWindowId] = {
                    id: window.settlementWindowId,
                    state: window.settlementWindowStateId,
                    reason: window.reason,
                    createDate: window.createdDate
                }
            end note
        end
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **accountsWindows** and **windowsAccounts**
        note right of SETTLE_DAO #lightgray
            let accountsWindows = {} // declare map
            let windowsAccounts = {} // declare map
        end note
        loop windowsAccountsList as record
            note right of SETTLE_DAO #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid,
                    pendingSettlementCount: 0,
                    settledCount: 0,
                    abortedCount: 0
                }
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].abortedCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of windowsAccounts into **windowsAccountsInit**
        note right of SETTLE_DAO #lightgray
            windowsAccountsInit = Object.assign({}, windowsAccounts)
        end note
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        |||
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id != allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state == 'PENDING_SETTLEMENT' && accountPayload.state == 'PS_TRANSFERS_RECORDED'
                else settlementData.state == 'PS_TRANSFERS_RECORDED' && accountPayload.state == 'PS_TRANSFERS_RESERVED'
                else settlementData.state == 'PS_TRANSFERS_RESERVED' && accountPayload.state == 'PS_TRANSFERS_COMMITTED'
                else settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' && accountPayload.state == 'SETTLED'
                    note right of SETTLE_DAO #lightgray
                        **Note**: Since we previously checked same-state, here we don't need to match
                        allAccounts[account.id].state == settlementData.state. We can safely assume it.
                    end note

                    SETTLE_DAO -> SETTLE_DAO: Settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            <color #blue>settlementTransferId: Uuid() - - only for PS_TRANSFERS_RECORDED</color>
                        })
                        if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.psTransfersRecordedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                            settlementAccounts.psTransfersRecordedCount- -
                            settlementAccounts.psTransfersReservedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                            settlementAccounts.psTransfersReservedCount- -
                            settlementAccounts.psTransfersCommittedCount++
                        } else if (accountPayload.state == 'SETTLED') {
                            settlementAccounts.psTransfersCommittedCount- -
                            settlementAccounts.settledCount++
                        }
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].externalReference = accountPayload.externalReference
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                        let settlementWindowId
                    end note
                    loop let aw IN accountsWindows[accountPayload.id].windows
                        note right of SETTLE_DAO #lightgray
                            settlementWindowId = accountsWindows[accountPayload.id].windows[aw]

                            if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                                windowsAccounts[settlementWindowId].pendingSettlementCount- -
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount- -
                                windowsAccounts[settlementWindowId].psTransfersReservedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                                windowsAccounts[settlementWindowId].psTransfersReservedCount- -
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount++
                            } else if (accountPayload.state == 'SETTLED') {
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount- -
                                windowsAccounts[settlementWindowId].settledCount++
                            }
                            if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                affectedWindows.push(settlementWindowId)
                            }
                        end note
                    end
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId =
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end

        alt settlementData.state == 'PENDING_SETTLEMENT'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Prepare {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg 6.3.1]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RECORDED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Reserve {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg 6.3.2]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RESERVED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Commit {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg 6.3.3]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        end

        group Prepare and insert settlementWindowStateChange
            note right of SETTLE_DAO #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SETTLE_DAO #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount\n|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount\n|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount\n|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount\n|| windowAccounts.settledCount != windowAccountsInit.settledCount
                    note right of SETTLE_DAO #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note

                    opt windowAccounts.psTransfersCommittedCount == 0\n&& windowAccounts.abortedCount == 0\n&& windowAccounts.settledCound > 0
                        note right of SETTLE_DAO #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                end
            end

            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Prepare and insert settlementStateChange
            note right of SETTLE_DAO #lightgray
                let settlementStateChanged = true
            end note
            alt settlementData.state == 'PENDING_SETTLEMENT'\n&& settlementAccounts.pendingSettlementCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RECORDED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RECORDED'\n&& settlementAccounts.psTransfersRecordedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RESERVED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RESERVED'\n&& settlementAccounts.psTransfersReservedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_COMMITTED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'
                end note
            else settlementData.state == 'PS_TRANSFERS_COMMITTED'\n&& settlementAccounts.psTransfersCommittedCount > 0\n&& settlementAccounts.settledCount > 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLING'
                    settlementData.reason = 'Some settlement accounts are SETTLED'
                end note
            else (settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')\n&& settlementAccounts.psTransfersCommittedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All settlement accounts are SETTLED'
                end note
            else
                note right of SETTLE_DAO #lightgray
                    settlementStateChanged = false
                end note
            end
            opt settlementStateChanged == true
                note right of SETTLE_DAO #lightgray
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "externalReference": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>