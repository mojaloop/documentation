<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="8533px" preserveAspectRatio="none" style="width:1508px;height:8533px;" version="1.1" viewBox="0 0 1508 8533" width="1508px" zoomAndPan="magnify"><defs><filter height="300%" id="f1pay4fabkwt0r" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="497.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="8488.5059" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="280" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="295.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="8488.5059" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="436.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="559.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="8488.5059" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1187" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1190" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="8264.2188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="331" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="7888.3867" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="514" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="6933.0645" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="835.7773"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5309.4082"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5474.2715"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6262.1875"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6453.6719"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7295.252"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7387.1836"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="8265.2188" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="6889.7539" style="stroke: #000000; stroke-width: 2.0;" width="838" x="649" y="582.7402"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="679" y="1996.3418"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="746" y="2374.2422"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2430.8633"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2485.1289"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2539.3945"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2593.6602"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2647.9258"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2702.1914"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="2210.9141" style="stroke: #000000; stroke-width: 2.0;" width="797" x="659" y="3045.873"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="2052.0508" style="stroke: #000000; stroke-width: 2.0;" width="777" x="669" y="3197.7363"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="1939.1191" style="stroke: #000000; stroke-width: 2.0;" width="757" x="679" y="3303.668"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3494.4629"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3682.9023"/><rect fill="#FFFFFF" height="341.5449" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3932.584"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4274.1289"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4289.084"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4304.0391"/><rect fill="#FFFFFF" height="687.0664" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4318.9941"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="5006.0605"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="679" y="5270.7871"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="503.1895" style="stroke: #000000; stroke-width: 2.0;" width="643" x="669" y="5682.0664"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="679" y="5706.377"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="679" y="5865.2402"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="679" y="6021.748"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="443.9004" style="stroke: #000000; stroke-width: 2.0;" width="729" x="669" y="6199.2559"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="709" x="679" y="6223.5664"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="669" y="6657.1563"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="746" y="6720.7773"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6803.6191"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6886.1504"/><rect fill="#FFFFFF" height="95.4863" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6968.6816"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="7064.168"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="7146.6992"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="679" y="7202.0098"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="336" x2="336" y1="137.2871" y2="8436.5059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="518.5" x2="518.5" y1="137.2871" y2="8436.5059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="746" x2="746" y1="137.2871" y2="8436.5059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1244" x2="1244" y1="137.2871" y2="8436.5059"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="284" y="134.334">Hub Employee</text><ellipse cx="336" cy="63.7988" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M336,71.7988 L336,98.7988 M323,79.7988 L349,79.7988 M336,98.7988 L323,113.7988 M336,98.7988 L349,113.7988 " fill="none" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="284" y="8449.041">Hub Employee</text><ellipse cx="336" cy="8461.9941" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M336,8469.9941 L336,8496.9941 M323,8477.9941 L349,8477.9941 M336,8496.9941 L323,8511.9941 M336,8496.9941 L349,8511.9941 " fill="none" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="440.5" y="134.334">Settlement Service API</text><path d="M498.5,92.7988 L498.5,116.7988 M498.5,104.7988 L515.5,104.7988 " fill="none" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="527.5" cy="104.7988" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="440.5" y="8449.041">Settlement Service API</text><path d="M498.5,8455.9941 L498.5,8479.9941 M498.5,8467.9941 L515.5,8467.9941 " fill="none" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="527.5" cy="8467.9941" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="689" y="134.334">Settlement DAO</text><ellipse cx="746" cy="104.7988" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="689" y="8449.041">Settlement DAO</text><ellipse cx="746" cy="8467.9941" fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="8481.9941" y2="8481.9941"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1196" y="134.334">Central Store</text><path d="M1226,84.7988 C1226,74.7988 1244,74.7988 1244,74.7988 C1244,74.7988 1262,74.7988 1262,84.7988 L1262,110.7988 C1262,120.7988 1244,120.7988 1244,120.7988 C1244,120.7988 1226,120.7988 1226,110.7988 L1226,84.7988 " fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1226,84.7988 C1226,94.7988 1244,94.7988 1244,94.7988 C1244,94.7988 1262,94.7988 1262,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1196" y="8449.041">Central Store</text><path d="M1226,8461.9941 C1226,8451.9941 1244,8451.9941 1244,8451.9941 C1244,8451.9941 1262,8451.9941 1262,8461.9941 L1262,8487.9941 C1262,8497.9941 1244,8497.9941 1244,8497.9941 C1244,8497.9941 1226,8497.9941 1226,8487.9941 L1226,8461.9941 " fill="#FEFECE" filter="url(#f1pay4fabkwt0r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1226,8461.9941 C1226,8471.9941 1244,8471.9941 1244,8471.9941 C1244,8471.9941 1262,8471.9941 1262,8461.9941 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="8264.2188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="331" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="7888.3867" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="514" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="6933.0645" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="835.7773"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5309.4082"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5474.2715"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6262.1875"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6453.6719"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7295.252"/><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7387.1836"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="8265.2188" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M346,176.5977 L346,492.5977 L1053,492.5977 L1053,186.5977 L1043,176.5977 L346,176.5977 " fill="#FFFF00" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1043,176.5977 L1043,186.5977 L1053,186.5977 L1043,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="352" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="368" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="400" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="400" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="416" y="270.7188">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="613" x="416" y="286.0293">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="416" y="301.3398">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="416" y="316.6504">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="416" y="331.9609">{ "id": 5, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="400" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="384" y="362.582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="400" y="393.2031">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="400" y="408.5137">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="416" y="423.8242">{ "id": 6, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="400" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="368" y="469.7559">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="352" y="485.0664">}</text><polygon fill="#A80036" points="502,519.1191,512,523.1191,502,527.1191,506,523.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="341" x2="508" y1="523.1191" y2="523.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="348" y="518.377">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="361" y="518.377">PUT - /settlement/{id}</text><polygon fill="#A80036" points="729,563.7402,739,567.7402,729,571.7402,733,567.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="524" x2="735" y1="567.7402" y2="567.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="531" y="555.3428">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="544" y="547.6875">updateSettlementById routine</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="544" y="562.998">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="621" y="562.998">2001</text><path d="M649,582.7402 L814,582.7402 L814,589.7402 L804,599.7402 L649,599.7402 L649,582.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="6889.7539" style="stroke: #000000; stroke-width: 2.0;" width="838" x="649" y="582.7402"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="664" y="596.3086">DB TRANSACTION</text><polygon fill="#A80036" points="1227,617.3613,1237,621.3613,1227,625.3613,1231,621.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="621.3613" y2="621.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="616.6191">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="771" y="616.6191">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1057,634.3613,1431,634.3613,1441,706.3613,1431,779.3613,1057,779.3613,1047,706.3613,1057,634.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="1059" y="650.9297">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1075" y="666.2402">ssc.reason, ssc.createdDate, sm.autoPositionReset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1059" y="681.5508">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1099" y="681.5508">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1175" y="681.5508">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1059" y="696.8613">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1091" y="696.8613">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1252" y="696.8613">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="1059" y="712.1719">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1059" y="727.4824">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="1091" y="727.4824">settlementModel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1208" y="727.4824">sm</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="1059" y="742.793">ON sm.settlementModelId = s.settlementModelId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1059" y="758.1035">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1059" y="773.4141">FOR UPDATE</text><polygon fill="#A80036" points="762,802.4668,752,806.4668,762,810.4668,758,806.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="806.4668" y2="806.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="768" y="801.7246">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="781" y="801.7246">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="826" y="801.7246">settlementData</text><polygon fill="#A80036" points="1227,831.7773,1237,835.7773,1227,839.7773,1231,835.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="835.7773" y2="835.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="831.0352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="771" y="831.0352">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1060,848.7773,1428,848.7773,1438,943.7773,1428,1039.7773,1060,1039.7773,1050,943.7773,1060,848.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="1062" y="865.3457">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1078" y="880.6563">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="1078" y="895.9668">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="1078" y="911.2773">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1330" y="911.2773">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1062" y="926.5879">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1102" y="926.5879">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1313" y="926.5879">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1062" y="941.8984">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1094" y="941.8984">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1390" y="941.8984">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1062" y="957.209">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1062" y="972.5195">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1062" y="987.8301">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1094" y="987.8301">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1234" y="987.8301">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1062" y="1003.1406">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="1062" y="1018.4512">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1062" y="1033.7617">FOR UPDATE</text><polygon fill="#A80036" points="762,1062.8145,752,1066.8145,762,1070.8145,758,1066.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="1066.8145" y2="1066.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="768" y="1062.0723">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="781" y="1062.0723">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="826" y="1062.0723">settlementAccountsList</text><path d="M756,1104.8145 L756,1175.8145 L1253,1175.8145 L1253,1114.8145 L1243,1104.8145 L756,1104.8145 " fill="#ADD8E6" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1243,1104.8145 L1243,1114.8145 L1253,1114.8145 L1243,1104.8145 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="762" y="1122.3828">All objects below are for the purpose of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="762" y="1137.6934">If at some point, Node process memory limit is reached, we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="762" y="1153.0039">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="762" y="1168.3145">B. Move to asyncronous processing where we don't need these objects</text><path d="M756,1190.0566 L756,1689.0566 L1419,1689.0566 L1419,1200.0566 L1409,1190.0566 L756,1190.0566 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1409,1190.0566 L1409,1200.0566 L1419,1200.0566 L1409,1190.0566 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="762" y="1207.625">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="762" y="1222.9355">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="869" y="1222.9355">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="762" y="1238.2461">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="924" y="1238.2461">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="1253.5566"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="762" y="1268.8672">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="762" y="1284.1777">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="896" y="1284.1777">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1018" y="1284.1777">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1167" y="1284.1777">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="778" y="1299.4883">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="778" y="1314.7988">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="778" y="1330.1094">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="778" y="1345.4199">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="778" y="1360.7305">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="778" y="1376.041">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="1391.3516">unknownCount:  &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="778" y="1406.6621">settledIdList: &lt;array&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="778" y="1421.9727">changedIdList: &lt;array&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1437.2832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="762" y="1452.5938">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="922" y="1452.5938">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="762" y="1467.9043">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="840" y="1467.9043">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1250" y="1467.9043">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1399" y="1467.9043">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="778" y="1483.2148">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="794" y="1498.5254">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="794" y="1513.8359">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="794" y="1529.1465">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="794" y="1544.457">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="794" y="1559.7676">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="810" y="1575.0781">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="810" y="1590.3887">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="794" y="1605.6992">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="794" y="1621.0098">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="794" y="1636.3203">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="824" y="1636.3203">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="850" y="1636.3203">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="1651.6309">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1666.9414">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="762" y="1682.252">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="782" y="1682.252">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="938" y="1682.252">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="1745.3047" y2="1745.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="1745.3047" y2="1758.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="1758.3047" y2="1758.3047"/><polygon fill="#A80036" points="762,1754.3047,752,1758.3047,762,1762.3047,758,1758.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="1740.5625">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="771" y="1740.5625">Declare and initialize variables</text><path d="M756,1771.3047 L756,1980.3047 L1048,1980.3047 L1048,1781.3047 L1038,1771.3047 L756,1771.3047 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1038,1771.3047 L1038,1781.3047 L1048,1781.3047 L1038,1771.3047 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="762" y="1788.873">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="1804.1836">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="778" y="1819.4941">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="778" y="1834.8047">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="778" y="1850.1152">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="778" y="1865.4258">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="778" y="1880.7363">abortedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778" y="1896.0469">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1911.3574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="762" y="1926.668">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="762" y="1941.9785">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="762" y="1957.2891">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="762" y="1972.5996">let state</text><path d="M679,1996.3418 L753,1996.3418 L753,2003.3418 L743,2013.3418 L679,2013.3418 L679,1996.3418 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="679" y="1996.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="694" y="2009.9102">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="768" y="2008.9766">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="2034.9629" y2="2034.9629"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="2034.9629" y2="2047.9629"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="2047.9629" y2="2047.9629"/><polygon fill="#A80036" points="762,2043.9629,752,2047.9629,762,2051.9629,758,2047.9629" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="2030.2207">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="771" y="2030.2207">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="829" y="2030.2207">allAccounts</text><path d="M756,2060.9629 L756,2314.9629 L1004,2314.9629 L1004,2070.9629 L994,2060.9629 L756,2060.9629 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M994,2060.9629 L994,2070.9629 L1004,2070.9629 L994,2060.9629 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="2078.5313">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="762" y="2093.8418">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="762" y="2109.1523">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="2124.4629"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="762" y="2139.7734">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="778" y="2155.084">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="778" y="2170.3945">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="778" y="2185.7051">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="778" y="2201.0156">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="778" y="2216.3262">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="794" y="2231.6367">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="794" y="2246.9473">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="778" y="2262.2578">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778" y="2277.5684">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="778" y="2292.8789">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="2308.1895">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="2346.2422" y2="2346.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="2346.2422" y2="2359.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="2359.2422" y2="2359.2422"/><polygon fill="#A80036" points="762,2355.2422,752,2359.2422,762,2363.2422,758,2359.2422" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="2341.5">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="771" y="2341.5">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="829" y="2341.5">settlementAccounts</text><path d="M746,2374.2422 L808,2374.2422 L808,2381.2422 L798,2391.2422 L746,2391.2422 L746,2374.2422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="746" y="2374.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="761" y="2387.8105">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="823" y="2386.877">[state == 'PENDING_SETTLEMENT']</text><path d="M756,2396.5527 L756,2421.5527 L1083,2421.5527 L1083,2406.5527 L1073,2396.5527 L756,2396.5527 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1073,2396.5527 L1073,2406.5527 L1083,2406.5527 L1073,2396.5527 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="762" y="2414.1211">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2431.8633" y2="2431.8633"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="751" y="2442.498">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M756,2450.8184 L756,2475.8184 L1097,2475.8184 L1097,2460.8184 L1087,2450.8184 L756,2450.8184 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1087,2450.8184 L1087,2460.8184 L1097,2460.8184 L1087,2450.8184 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="762" y="2468.3867">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2486.1289" y2="2486.1289"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="751" y="2496.7637">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M756,2505.084 L756,2530.084 L1095,2530.084 L1095,2515.084 L1085,2505.084 L756,2505.084 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1085,2505.084 L1085,2515.084 L1095,2515.084 L1085,2505.084 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="762" y="2522.6523">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2540.3945" y2="2540.3945"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="751" y="2551.0293">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M756,2559.3496 L756,2584.3496 L1109,2584.3496 L1109,2569.3496 L1099,2559.3496 L756,2559.3496 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1099,2559.3496 L1099,2569.3496 L1109,2569.3496 L1099,2559.3496 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="762" y="2576.918">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2594.6602" y2="2594.6602"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="751" y="2605.2949">[state == 'SETTLED']</text><path d="M756,2613.6152 L756,2638.6152 L1008,2638.6152 L1008,2623.6152 L998,2613.6152 L756,2613.6152 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M998,2613.6152 L998,2623.6152 L1008,2623.6152 L998,2613.6152 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="762" y="2631.1836">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2648.9258" y2="2648.9258"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="751" y="2659.5605">[state == 'ABORTED']</text><path d="M756,2667.8809 L756,2692.8809 L1013,2692.8809 L1013,2677.8809 L1003,2667.8809 L756,2667.8809 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1003,2667.8809 L1003,2677.8809 L1013,2677.8809 L1003,2667.8809 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="762" y="2685.4492">settlementAccounts.abortedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2703.1914" y2="2703.1914"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="751" y="2713.8262">[default]</text><path d="M756,2722.1465 L756,2747.1465 L1023,2747.1465 L1023,2732.1465 L1013,2722.1465 L756,2722.1465 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1013,2722.1465 L1013,2732.1465 L1023,2732.1465 L1013,2722.1465 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="762" y="2739.7148">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="2791.7676" y2="2791.7676"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="2791.7676" y2="2804.7676"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="2804.7676" y2="2804.7676"/><polygon fill="#A80036" points="762,2800.7676,752,2804.7676,762,2808.7676,758,2804.7676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="2787.0254">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="780" y="2787.0254">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="1038" y="2787.0254">settlementAccountsInit</text><path d="M756,2817.7676 L756,2842.7676 L1178,2842.7676 L1178,2827.7676 L1168,2817.7676 L756,2817.7676 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1168,2817.7676 L1168,2827.7676 L1178,2827.7676 L1168,2817.7676 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="762" y="2835.3359">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><path d="M756,2882.0781 L756,3029.0781 L1450,3029.0781 L1450,2892.0781 L1440,2882.0781 L756,2882.0781 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1440,2882.0781 L1440,2892.0781 L1450,2892.0781 L1440,2882.0781 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="762" y="2899.6465">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="762" y="2914.957">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="900" y="2914.957">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="762" y="2930.2676">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="844" y="2930.2676">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="2945.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="762" y="2960.8887">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="970" y="2960.8887">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1024" y="2960.8887">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="762" y="2976.1992">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="847" y="2976.1992">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="762" y="2991.5098">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1058" y="2991.5098">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="762" y="3006.8203">settlementParticipantCurrencySettledList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="1043" y="3006.8203">= [] // array to collect settled accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="762" y="3022.1309">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="897" y="3022.1309">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M659,3045.873 L733,3045.873 L733,3052.873 L723,3062.873 L659,3062.873 L659,3045.873 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2210.9141" style="stroke: #000000; stroke-width: 2.0;" width="797" x="659" y="3045.873"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="674" y="3059.4414">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="748" y="3058.5078">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3084.4941" y2="3084.4941"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3084.4941" y2="3097.4941"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3097.4941" y2="3097.4941"/><polygon fill="#A80036" points="762,3093.4941,752,3097.4941,762,3101.4941,758,3097.4941" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3079.752">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="780" y="3079.752">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="923" y="3079.752">participantPayload</text><path d="M756,3110.4941 L756,3181.4941 L1136,3181.4941 L1136,3120.4941 L1126,3110.4941 L756,3110.4941 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1126,3110.4941 L1126,3120.4941 L1136,3120.4941 L1126,3110.4941 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="762" y="3128.0625">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="762" y="3143.373">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="762" y="3158.6836">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="762" y="3173.9941">participant = participants[pi]</text><path d="M669,3197.7363 L743,3197.7363 L743,3204.7363 L733,3214.7363 L669,3214.7363 L669,3197.7363 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2052.0508" style="stroke: #000000; stroke-width: 2.0;" width="777" x="669" y="3197.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="684" y="3211.3047">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="758" y="3210.3711">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3236.3574" y2="3236.3574"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3236.3574" y2="3249.3574"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3249.3574" y2="3249.3574"/><polygon fill="#A80036" points="762,3245.3574,752,3249.3574,762,3253.3574,758,3249.3574" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3231.6152">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="780" y="3231.6152">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="923" y="3231.6152">accountPayload</text><path d="M756,3262.3574 L756,3287.3574 L1148,3287.3574 L1148,3272.3574 L1138,3262.3574 L756,3262.3574 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1138,3262.3574 L1138,3272.3574 L1148,3272.3574 L1138,3262.3574 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="762" y="3279.9258">let accountPayload = participantPayload.accounts[account]</text><path d="M679,3303.668 L741,3303.668 L741,3310.668 L731,3320.668 L679,3320.668 L679,3303.668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1939.1191" style="stroke: #000000; stroke-width: 2.0;" width="757" x="679" y="3303.668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="694" y="3317.2363">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="756" y="3316.3027">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3342.2891" y2="3342.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3342.2891" y2="3355.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3355.2891" y2="3355.2891"/><polygon fill="#A80036" points="762,3351.2891,752,3355.2891,762,3359.2891,758,3355.2891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3337.5469">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="780" y="3337.5469">If the account doesn't match the settlement</text><path d="M756,3368.2891 L756,3485.2891 L1044,3485.2891 L1044,3378.2891 L1034,3368.2891 L756,3368.2891 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1034,3368.2891 L1034,3378.2891 L1044,3378.2891 L1034,3368.2891 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3385.8574">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3401.168">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3416.4785">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3431.7891">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="794" y="3447.0996">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3462.4102">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3477.7207">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3495.4629" y2="3495.4629"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="392" x="684" y="3506.0977">[participantPayload.id != allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3530.7285" y2="3530.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3530.7285" y2="3543.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3543.7285" y2="3543.7285"/><polygon fill="#A80036" points="762,3539.7285,752,3543.7285,762,3547.7285,758,3543.7285" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3525.9863">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="780" y="3525.9863">If the account doesn't match the participant</text><path d="M756,3556.7285 L756,3673.7285 L1140,3673.7285 L1140,3566.7285 L1130,3556.7285 L756,3556.7285 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1130,3556.7285 L1130,3566.7285 L1140,3566.7285 L1130,3556.7285 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3574.2969">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3589.6074">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3604.918">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3620.2285">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="794" y="3635.5391">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3650.8496">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3666.1602">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3683.9023" y2="3683.9023"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="684" y="3694.5371">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3719.168" y2="3719.168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3719.168" y2="3732.168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3732.168" y2="3732.168"/><polygon fill="#A80036" points="762,3728.168,752,3732.168,762,3736.168,758,3732.168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3714.4258">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="780" y="3714.4258">If the account has been previosly processed (duplicated in the payload)</text><path d="M756,3745.168 L756,3923.168 L1275,3923.168 L1275,3755.168 L1265,3745.168 L756,3745.168 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,3745.168 L1265,3755.168 L1275,3755.168 L1265,3745.168 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3762.7363">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3778.0469">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="778" y="3793.3574">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="778" y="3808.668">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="778" y="3823.9785">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="3839.2891">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3854.5996">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3869.9102">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="794" y="3885.2207">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3900.5313">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3915.8418">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3933.584" y2="3933.584"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="371" x="684" y="3944.2188">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3968.8496" y2="3968.8496"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3968.8496" y2="3981.8496"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3981.8496" y2="3981.8496"/><polygon fill="#A80036" points="762,3977.8496,752,3981.8496,762,3985.8496,758,3981.8496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3964.1074">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="780" y="3964.1074">Same-state reason amendment is always allowed</text><path d="M756,3994.8496 L756,4264.8496 L1275,4264.8496 L1275,4004.8496 L1265,3994.8496 L756,3994.8496 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,3994.8496 L1265,4004.8496 L1275,4004.8496 L1265,3994.8496 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="762" y="4012.418">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="4027.7285">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="4043.0391">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="4058.3496">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4073.6602">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4088.9707">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="778" y="4104.2813">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="4119.5918">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4134.9023">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="762" y="4150.2129">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="778" y="4165.5234">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="778" y="4180.834">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4196.1445">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="778" y="4211.4551">externalReference: accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4226.7656">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="762" y="4242.0762">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="762" y="4257.3867">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4275.1289" y2="4275.1289"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="610" x="684" y="4285.7637">[settlementData.state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4290.084" y2="4290.084"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="628" x="684" y="4300.7188">[settlementData.state == 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4305.0391" y2="4305.0391"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="684" y="4315.6738">[settlementData.state == 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4319.9941" y2="4319.9941"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="752" x="684" y="4330.6289">[settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' &amp;&amp; accountPayload.state == 'SETTLED']</text><path d="M756,4338.9492 L756,4378.9492 L1257,4378.9492 L1257,4348.9492 L1247,4338.9492 L756,4338.9492 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1247,4338.9492 L1247,4348.9492 L1257,4348.9492 L1247,4338.9492 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="762" y="4356.5176">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="793" y="4356.5176">: Since we previously checked same-state, here we don't need to match</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="762" y="4371.8281">allAccounts[account.id].state == settlementData.state.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="4409.8809" y2="4409.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="4409.8809" y2="4422.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="4422.8809" y2="4422.8809"/><polygon fill="#A80036" points="762,4418.8809,752,4422.8809,762,4426.8809,758,4422.8809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="4405.1387">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="780" y="4405.1387">Settlement acknowledgement</text><path d="M756,4435.8809 L756,4996.8809 L1326,4996.8809 L1326,4445.8809 L1316,4435.8809 L756,4435.8809 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1316,4435.8809 L1316,4445.8809 L1326,4445.8809 L1316,4435.8809 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="762" y="4453.4492">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="4468.7598">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="4484.0703">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="4499.3809">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4514.6914">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4530.002">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="778" y="4545.3125">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="4560.623">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4575.9336">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="762" y="4591.2441">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="778" y="4606.5547">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="778" y="4621.8652">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4637.1758">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4652.4863">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="778" y="4667.7969"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="778" y="4667.7969">settlementTransferId: Uuid() -- only for PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4683.1074">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="762" y="4698.418">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="778" y="4713.7285">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="778" y="4729.0391">settlementAccounts.psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="762" y="4744.3496">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="778" y="4759.6602">settlementAccounts.psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="778" y="4774.9707">settlementAccounts.psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="762" y="4790.2813">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="778" y="4805.5918">settlementAccounts.psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="778" y="4820.9023">settlementAccounts.psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="762" y="4836.2129">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="778" y="4851.5234">settlementParticipantCurrencySettledIdList.push(allAccounts[accountPayload.id].key)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="778" y="4866.834">settlementAccounts.psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="778" y="4882.1445">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="778" y="4897.4551">settlementAccounts.settledIdList.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="4912.7656">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="762" y="4928.0762">settlementAccounts.changedIdList.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="762" y="4943.3867">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="762" y="4958.6973">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="762" y="4974.0078">allAccounts[accountPayload.id].externalReference = accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="762" y="4989.3184">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="5007.0605" y2="5007.0605"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="5029.3711" y2="5029.3711"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="5029.3711" y2="5042.3711"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="5042.3711" y2="5042.3711"/><polygon fill="#A80036" points="762,5038.3711,752,5042.3711,762,5046.3711,758,5042.3711" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5024.6289">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="780" y="5024.6289">All other state transitions are not permitted</text><path d="M756,5055.3711 L756,5233.3711 L1275,5233.3711 L1275,5065.3711 L1265,5055.3711 L756,5055.3711 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,5055.3711 L1265,5065.3711 L1275,5065.3711 L1265,5055.3711 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="5072.9395">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="5088.25">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="778" y="5103.5605">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="778" y="5118.8711">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="778" y="5134.1816">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="5149.4922">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="5164.8027">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="794" y="5180.1133">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="794" y="5195.4238">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="5210.7344">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="5226.0449">})</text><path d="M679,5270.7871 L1092,5270.7871 L1092,5277.7871 L1082,5287.7871 L679,5287.7871 L679,5270.7871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="679" y="5270.7871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="694" y="5284.3555">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1227,5305.4082,1237,5309.4082,1227,5313.4082,1231,5309.4082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="5309.4082" y2="5309.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5304.666">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="780" y="5304.666">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1108,5322.4082,1380,5322.4082,1390,5333.4082,1380,5345.4082,1108,5345.4082,1098,5333.4082,1108,5322.4082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="1110" y="5338.9766">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="762,5368.0293,752,5372.0293,762,5376.0293,758,5372.0293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="5372.0293" y2="5372.0293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="5367.2871">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="5367.2871">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="835" y="5367.2871">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="5431.9609" y2="5431.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="5431.9609" y2="5444.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="5444.9609" y2="5444.9609"/><polygon fill="#A80036" points="762,5440.9609,752,5444.9609,762,5448.9609,758,5444.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5411.9082">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="780" y="5396.5977">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="780" y="5411.9082">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="797" y="5411.9082">settlementParticipantCurrencyIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="1045" y="5411.9082">in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="780" y="5427.2188">issue the following update in one knex command</text><polygon fill="#A80036" points="1227,5470.2715,1237,5474.2715,1227,5478.2715,1231,5474.2715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="5474.2715" y2="5474.2715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5469.5293">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="780" y="5469.5293">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1031,5517.2715,1457,5517.2715,1467,5589.2715,1457,5662.2715,1031,5662.2715,1021,5589.2715,1031,5517.2715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1033" y="5533.8398">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1087" y="5533.8398">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1033" y="5549.1504">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1049" y="5564.4609">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5579.7715"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1049" y="5579.7715">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5595.082"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="1049" y="5595.082">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5610.3926"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1049" y="5610.3926">-- only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1033" y="5625.7031">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="1065" y="5641.0137">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1065" y="5656.3242">.settlementParticipantCurrencyIdList}</text><path d="M669,5682.0664 L736,5682.0664 L736,5689.0664 L726,5699.0664 L669,5699.0664 L669,5682.0664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="503.1895" style="stroke: #000000; stroke-width: 2.0;" width="643" x="669" y="5682.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="684" y="5695.6348">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="751" y="5694.7012">[autoPositionReset == true]</text><path d="M679,5706.377 L741,5706.377 L741,5713.377 L731,5723.377 L679,5723.377 L679,5706.377 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="679" y="5706.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="694" y="5719.9453">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="756" y="5719.0117">[settlementData.state == 'PENDING_SETTLEMENT']</text><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="5748.6875"/><polygon fill="#EEEEEE" points="686,5748.6875,750,5748.6875,750,5755.6875,740,5765.6875,686,5765.6875,686,5748.6875" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="5763.2559">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="813" y="5782.2559">Settlement Transfer Prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5797.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="5812.877">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="5812.877">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5828.1875"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1302" y1="5866.2402" y2="5866.2402"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="684" y="5876.875">[settlementData.state == 'PS_TRANSFERS_RECORDED']</text><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="5905.1953"/><polygon fill="#EEEEEE" points="686,5905.1953,750,5905.1953,750,5912.1953,740,5922.1953,686,5922.1953,686,5905.1953" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="5919.7637">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="813" y="5938.7637">Settlement Transfer Reserve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5954.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="5969.3848">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="5969.3848">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5984.6953"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1302" y1="6022.748" y2="6022.748"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="684" y="6033.3828">[settlementData.state == 'PS_TRANSFERS_RESERVED']</text><rect fill="#FFFFFF" filter="url(#f1pay4fabkwt0r)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="6061.7031"/><polygon fill="#EEEEEE" points="686,6061.7031,750,6061.7031,750,6068.7031,740,6078.7031,686,6078.7031,686,6061.7031" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="6076.2715">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="813" y="6095.2715">Settlement Transfer Commit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="6110.582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="6125.8926">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="6125.8926">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="6141.2031"/><path d="M669,6199.2559 L999,6199.2559 L999,6206.2559 L989,6216.2559 L669,6216.2559 L669,6199.2559 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="443.9004" style="stroke: #000000; stroke-width: 2.0;" width="729" x="669" y="6199.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="684" y="6212.8242">Update aggregations, contents &amp; windows</text><path d="M679,6223.5664 L746,6223.5664 L746,6230.5664 L736,6240.5664 L679,6240.5664 L679,6223.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="709" x="679" y="6223.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="694" y="6237.1348">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="761" y="6236.2012">[settlementParticipantCurrencySettledIdList.length &gt; 0]</text><polygon fill="#A80036" points="1227,6258.1875,1237,6262.1875,1227,6266.1875,1231,6262.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="6262.1875" y2="6262.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6257.4453">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="780" y="6257.4453">Change settlementWindowState where applicable</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1120,6305.1875,1368,6305.1875,1378,6362.1875,1368,6420.1875,1120,6420.1875,1110,6362.1875,1120,6305.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6321.7559">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6337.0664">transferParticipantStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1122" y="6352.377">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1122" y="6367.6875">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1122" y="6382.998">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6398.3086">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1122" y="6413.6191">settlementWindow</text><polygon fill="#A80036" points="1227,6449.6719,1237,6453.6719,1227,6457.6719,1231,6453.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="6453.6719" y2="6453.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6448.9297">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="780" y="6448.9297">Retrieve all affected content (incl. when settled)</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1120,6466.6719,1368,6466.6719,1378,6515.6719,1368,6565.6719,1120,6565.6719,1110,6515.6719,1120,6466.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6483.2402">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1122" y="6498.5508">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1122" y="6513.8613">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1122" y="6529.1719">ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1122" y="6544.4824">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6559.793">settlementWindowStateChange</text><polygon fill="#A80036" points="762,6588.8457,752,6592.8457,762,6596.8457,758,6592.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="6592.8457" y2="6592.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="6588.1035">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="6588.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="835" y="6588.1035">affectedWindowsReport</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="6622.1563" y2="6622.1563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="6622.1563" y2="6635.1563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="6635.1563" y2="6635.1563"/><polygon fill="#A80036" points="762,6631.1563,752,6635.1563,762,6639.1563,758,6635.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6617.4141">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="780" y="6617.4141">Use previous result to produce settlementWindowsData (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="1137" y="6617.4141">swd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1164" y="6617.4141">) array</text><path d="M669,6657.1563 L1001,6657.1563 L1001,6664.1563 L991,6674.1563 L669,6674.1563 L669,6657.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="669" y="6657.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="684" y="6670.7246">Prepare and insert settlementStateChange</text><path d="M756,6679.4668 L756,6704.4668 L993,6704.4668 L993,6689.4668 L983,6679.4668 L756,6679.4668 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M983,6679.4668 L983,6689.4668 L993,6689.4668 L983,6679.4668 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="762" y="6697.0352">let settlementStateChanged = true</text><path d="M746,6720.7773 L808,6720.7773 L808,6727.7773 L798,6737.7773 L746,6737.7773 L746,6720.7773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="746" y="6720.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="761" y="6734.3457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="823" y="6733.4121">[settlementData.state == 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="823" y="6746.3672">&amp;&amp; settlementAccounts.pendingSettlementCount == 0]</text><path d="M756,6753.998 L756,6793.998 L1287,6793.998 L1287,6763.998 L1277,6753.998 L756,6753.998 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1277,6753.998 L1277,6763.998 L1287,6763.998 L1277,6753.998 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="762" y="6771.5664">settlementData.state = 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="510" x="762" y="6786.877">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6804.6191" y2="6804.6191"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="751" y="6815.2539">[settlementData.state == 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="321" x="751" y="6828.209">&amp;&amp; settlementAccounts.psTransfersRecordedCount == 0]</text><path d="M756,6836.5293 L756,6876.5293 L1280,6876.5293 L1280,6846.5293 L1270,6836.5293 L756,6836.5293 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1270,6836.5293 L1270,6846.5293 L1280,6846.5293 L1270,6836.5293 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="762" y="6854.0977">settlementData.state = 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="503" x="762" y="6869.4082">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6887.1504" y2="6887.1504"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="751" y="6897.7852">[settlementData.state == 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="751" y="6910.7402">&amp;&amp; settlementAccounts.psTransfersReservedCount == 0]</text><path d="M756,6919.0605 L756,6959.0605 L1296,6959.0605 L1296,6929.0605 L1286,6919.0605 L756,6919.0605 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1286,6919.0605 L1286,6929.0605 L1296,6929.0605 L1286,6919.0605 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="762" y="6936.6289">settlementData.state = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="762" y="6951.9395">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6969.6816" y2="6969.6816"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="751" y="6980.3164">[settlementData.state == 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="318" x="751" y="6993.2715">&amp;&amp; settlementAccounts.psTransfersCommittedCount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="751" y="7006.2266">&amp;&amp; settlementAccounts.settledCount &gt; 0]</text><path d="M756,7014.5469 L756,7054.5469 L1190,7054.5469 L1190,7024.5469 L1180,7014.5469 L756,7014.5469 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1180,7014.5469 L1180,7024.5469 L1190,7024.5469 L1180,7014.5469 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="762" y="7032.1152">settlementData.state = 'SETTLING'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="762" y="7047.4258">settlementData.reason = 'Some settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="7065.168" y2="7065.168"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="534" x="751" y="7075.8027">[(settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="751" y="7088.7578">&amp;&amp; settlementAccounts.psTransfersCommittedCount == 0]</text><path d="M756,7097.0781 L756,7137.0781 L1173,7137.0781 L1173,7107.0781 L1163,7097.0781 L756,7097.0781 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1163,7097.0781 L1163,7107.0781 L1173,7107.0781 L1163,7097.0781 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="762" y="7114.6465">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="762" y="7129.957">settlementData.reason = 'All settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="7147.6992" y2="7147.6992"/><path d="M756,7153.6992 L756,7178.6992 L978,7178.6992 L978,7163.6992 L968,7153.6992 L756,7153.6992 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,7153.6992 L968,7163.6992 L978,7163.6992 L968,7153.6992 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="762" y="7171.2676">settlementStateChanged = false</text><path d="M679,7202.0098 L746,7202.0098 L746,7209.0098 L736,7219.0098 L679,7219.0098 L679,7202.0098 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="679" y="7202.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="694" y="7215.5781">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="761" y="7214.6445">[settlementStateChanged == true]</text><path d="M756,7224.3203 L756,7264.3203 L1085,7264.3203 L1085,7234.3203 L1075,7224.3203 L756,7224.3203 " fill="#D3D3D3" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1075,7224.3203 L1075,7234.3203 L1085,7234.3203 L1075,7224.3203 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="762" y="7241.8887">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="762" y="7257.1992">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1227,7291.252,1237,7295.252,1227,7299.252,1231,7295.252" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="7295.252" y2="7295.252"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="7290.5098">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="780" y="7290.5098">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1169,7308.252,1318,7308.252,1328,7319.252,1318,7331.252,1169,7331.252,1159,7319.252,1169,7308.252" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1171" y="7324.8203">settlementStateChange</text><polygon fill="#A80036" points="762,7353.873,752,7357.873,762,7361.873,758,7357.873" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="7357.873" y2="7357.873"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="7353.1309">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="7353.1309">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="835" y="7353.1309">settlementStateChangeId</text><polygon fill="#A80036" points="1227,7383.1836,1237,7387.1836,1227,7391.1836,1231,7387.1836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="7387.1836" y2="7387.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="7382.4414">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="780" y="7382.4414">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1pay4fabkwt0r)" points="1109,7430.1836,1378,7430.1836,1388,7441.1836,1378,7453.1836,1109,7453.1836,1099,7441.1836,1109,7430.1836" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1111" y="7446.752">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1165" y="7446.752">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1237" y="7446.752">.currentStateChangeId</text><polygon fill="#A80036" points="535,7496.8047,525,7500.8047,535,7504.8047,531,7500.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="529" x2="745" y1="7500.8047" y2="7500.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="541" y="7496.0625">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="563" y="7496.0625">Return transaction result</text><path d="M23,7513.8047 L23,8380.8047 L505,8380.8047 L505,7523.8047 L495,7513.8047 L23,7513.8047 " fill="#FFFF00" filter="url(#f1pay4fabkwt0r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M495,7513.8047 L495,7523.8047 L505,7523.8047 L495,7513.8047 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="7531.373">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="7546.6836">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="7561.9941">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="7577.3047">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="7592.6152">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7607.9258">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="77" y="7623.2363">"id": swd[m].id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="77" y="7638.5469">"state": swd[m].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="77" y="7653.8574">"reason": swd[m].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="77" y="7669.168">"createdDate": swd[m].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="77" y="7684.4785">"changedDate": swd[m].changedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="77" y="7699.7891">"content": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7715.0996">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="109" y="7730.4102">"id": swd[m].content[n].settlementWindowContentId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="109" y="7745.7207">"state": swd[m].content[n].settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="109" y="7761.0313">"ledgerAccountType": swd[m].content[n].ledgerAccountType,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="109" y="7776.3418">"currencyId": swd[m].content[n].currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="109" y="7791.6523">"createdDate": swd[m].content[n].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="109" y="7806.9629">"changedDate": swd[m].content[n].changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7822.2734">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="7837.584">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7852.8945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="7868.2051">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="7883.5156">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7898.8262">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="77" y="7914.1367">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="77" y="7929.4473">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7944.7578">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="109" y="7960.0684">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="109" y="7975.3789">"state": "&lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="109" y="7990.6895">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="109" y="8006">"externalReference": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="109" y="8021.3105">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="109" y="8036.6211">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="125" y="8051.9316">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="125" y="8067.2422">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="8082.5527">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="93" y="8097.8633">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="8113.1738">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="109" y="8128.4844">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="109" y="8143.7949">"state": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="109" y="8159.1055">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="109" y="8174.416">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="109" y="8189.7266">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="125" y="8205.0371">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="125" y="8220.3477">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="109" y="8235.6582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="109" y="8250.9688">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="125" y="8266.2793">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="125" y="8281.5898">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="8296.9004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="8312.2109">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="8327.5215">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="8342.832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="8358.1426">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="8373.4531">}</text><polygon fill="#A80036" points="347,8407.5059,337,8411.5059,347,8415.5059,343,8411.5059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="341" x2="518" y1="8411.5059" y2="8411.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="353" y="8406.7637">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="375" y="8406.7637">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": <string> },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": <string>, "externalReference": <string> },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": <string> },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": <string>, "externalReference": <string> },
                        { "id": 5, "state": "SETTLED", "reason": <string> }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "SETTLED", "reason": <string> }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById routine\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId,
                ssc.reason, ssc.createdDate, sm.autoPositionReset
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            JOIN **settlementModel** sm
            ON sm.settlementModelId = s.settlementModelId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        |||
        note right of SETTLE_DAO #lightblue
            All objects below are for the purpose of the syncronous request.
            If at some point, Node process memory limit is reached, we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                abortedCount: <integer> // count of accounts in ABORTED state
                unknownCount:  <integer>,
                settledIdList: <array>,
                changedIdList: <array>
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                abortedCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts**
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.abortedCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **settlementParticipantCurrencySettledList** = [] // array to collect settled accounts
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id != allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state == 'PENDING_SETTLEMENT' && accountPayload.state == 'PS_TRANSFERS_RECORDED'
                else settlementData.state == 'PS_TRANSFERS_RECORDED' && accountPayload.state == 'PS_TRANSFERS_RESERVED'
                else settlementData.state == 'PS_TRANSFERS_RESERVED' && accountPayload.state == 'PS_TRANSFERS_COMMITTED'
                else settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' && accountPayload.state == 'SETTLED'
                    note right of SETTLE_DAO #lightgray
                        **Note**: Since we previously checked same-state, here we don't need to match
                        allAccounts[account.id].state == settlementData.state.
                    end note

                    SETTLE_DAO -> SETTLE_DAO: Settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            <color #blue>settlementTransferId: Uuid() - - only for PS_TRANSFERS_RECORDED</color>
                        })
                        if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.psTransfersRecordedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                            settlementAccounts.psTransfersRecordedCount- -
                            settlementAccounts.psTransfersReservedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                            settlementAccounts.psTransfersReservedCount- -
                            settlementAccounts.psTransfersCommittedCount++
                        } else if (accountPayload.state == 'SETTLED') {
                            settlementParticipantCurrencySettledIdList.push(allAccounts[accountPayload.id].key)
                            settlementAccounts.psTransfersCommittedCount- -
                            settlementAccounts.settledCount++
                            settlementAccounts.settledIdList.push(accountPayload.id)
                        }
                        settlementAccounts.changedIdList.push(accountPayload.id)
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].externalReference = accountPayload.externalReference
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto **settlementParticipantCurrencyIdList** in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId =
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end

        opt autoPositionReset == true
            alt settlementData.state == 'PENDING_SETTLEMENT'
                |||
                ref over SETTLE_DAO, DB: Settlement Transfer Prepare\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
                |||
            else settlementData.state == 'PS_TRANSFERS_RECORDED'
                |||
                ref over SETTLE_DAO, DB: Settlement Transfer Reserve\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
                |||
            else settlementData.state == 'PS_TRANSFERS_RESERVED'
                |||
                ref over SETTLE_DAO, DB: Settlement Transfer Commit\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
                |||
            end
        end

        group Update aggregations, contents & windows
            opt settlementParticipantCurrencySettledIdList.length > 0
                SETTLE_DAO -> DB: Change settlementWindowState where applicable 
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    settlementContentAggregation
                    transferParticipantStateChange
                    transferParticipant
                    settlementWindowContentStateChange
                    settlementWindowContent
                    settlementWindowStateChange
                    settlementWindow
                end hnote
            end

            SETTLE_DAO -> DB: Retrieve all affected content (incl. when settled)
            activate DB
            hnote over DB #lightyellow
                settlementContentAggregation
                settlementWindowContent
                settlementWindowContentStateChange
                ledgerAccountType
                settlementWindow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **affectedWindowsReport**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Use previous result to produce settlementWindowsData (**swd**) array
        end

        group Prepare and insert settlementStateChange
            note right of SETTLE_DAO #lightgray
                let settlementStateChanged = true
            end note
            alt settlementData.state == 'PENDING_SETTLEMENT'\n&& settlementAccounts.pendingSettlementCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RECORDED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RECORDED'\n&& settlementAccounts.psTransfersRecordedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RESERVED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RESERVED'\n&& settlementAccounts.psTransfersReservedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_COMMITTED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'
                end note
            else settlementData.state == 'PS_TRANSFERS_COMMITTED'\n&& settlementAccounts.psTransfersCommittedCount > 0\n&& settlementAccounts.settledCount > 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLING'
                    settlementData.reason = 'Some settlement accounts are SETTLED'
                end note
            else (settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')\n&& settlementAccounts.psTransfersCommittedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All settlement accounts are SETTLED'
                end note
            else
                note right of SETTLE_DAO #lightgray
                    settlementStateChanged = false
                end note
            end
            opt settlementStateChanged == true
                note right of SETTLE_DAO #lightgray
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #yellow
        {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": [
                {
                    "id": swd[m].id,
                    "state": swd[m].state,
                    "reason": swd[m].reason,
                    "createdDate": swd[m].createdDate,
                    "changedDate": swd[m].changedDate,
                    "content": [
                        {
                            "id": swd[m].content[n].settlementWindowContentId,
                            "state": swd[m].content[n].settlementWindowStateId,
                            "ledgerAccountType": swd[m].content[n].ledgerAccountType,
                            "currencyId": swd[m].content[n].currencyId,
                            "createdDate": swd[m].content[n].createdDate,
                            "changedDate": swd[m].content[n].changedDate
                        }
                    ]
                }
            ],
            "participants": [
                {
                    "id": <integer>,
                    "accounts": [
                        {
                            "id": <integer>,
                            "state": "<string>,
                            "reason": <string>,
                            "externalReference": <string>,
                            "createdDate": <date>,
                            "netSettlementAmount": {
                                "amount": <decimal>,
                                "currency": <enum>
                            }
                        },
                        {
                            "id": <integer>,
                            "state": <string>,
                            "reason": <string>,
                            "createdDate": <date>,
                            "netSettlementAmount": {
                                "amount": <decimal>,
                                "currency": <enum>
                            },
                            "errorInformation": {
                                "errorCode": <integer>,
                                "errorDescription": <string>
                            }
                        }
                    ]
                }
            ]
        }
    end note

    SSAPI - -> OPERATOR: Return response
    deactivate SSAPI
    deactivate OPERATOR
end
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>