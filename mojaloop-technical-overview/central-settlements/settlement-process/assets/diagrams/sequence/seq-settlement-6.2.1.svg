<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4092px" preserveAspectRatio="none" style="width:1518px;height:4092px;" version="1.1" viewBox="0 0 1518 4092" width="1518px" zoomAndPan="magnify"><defs><filter height="300%" id="fxnx7rqlb5fdv" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="581.5" y="23.5352">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="4046.9453" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="75" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="90.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4046.9453" style="stroke: #A80036; stroke-width: 1.0;" width="422.5" x="318.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="467.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4046.9453" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1113" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1116" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="3838.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="3585.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="400.6348"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="445.2559"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="1817.4277" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="474.5664"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1848.375"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2110.1699"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2218.1016"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2386.5859"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2597.3809"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2769.2441"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2907.1074"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3044.3496"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3182.2129"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3312.4551"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="3823.6582" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="37" y="749.9141"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="43" y="1339.1641"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="2376.6758" style="stroke: #000000; stroke-width: 2.0;" width="1474" x="23" y="1594.2695"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="1620.9434" style="stroke: #000000; stroke-width: 2.0;" width="894" x="593" y="1663.2012"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="603" y="2706.3125"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="613" y="2730.623"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="131" x2="131" y1="137.2871" y2="3994.9453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="400.5" x2="400.5" y1="137.2871" y2="3994.9453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="680" x2="680" y1="137.2871" y2="3994.9453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1170" x2="1170" y1="137.2871" y2="3994.9453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="134.334">Hub Employee</text><ellipse cx="131" cy="63.7988" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,71.7988 L131,98.7988 M118,79.7988 L144,79.7988 M131,98.7988 L118,113.7988 M131,98.7988 L144,113.7988 " fill="none" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="4007.4805">Hub Employee</text><ellipse cx="131" cy="4020.4336" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,4028.4336 L131,4055.4336 M118,4036.4336 L144,4036.4336 M131,4055.4336 L118,4070.4336 M131,4055.4336 L144,4070.4336 " fill="none" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="134.334">Settlement Service API</text><path d="M380.5,92.7988 L380.5,116.7988 M380.5,104.7988 L397.5,104.7988 " fill="none" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="104.7988" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="4007.4805">Settlement Service API</text><path d="M380.5,4014.4336 L380.5,4038.4336 M380.5,4026.4336 L397.5,4026.4336 " fill="none" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="4026.4336" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="623" y="134.334">Settlement DAO</text><ellipse cx="680" cy="104.7988" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="668" x2="692" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="623" y="4007.4805">Settlement DAO</text><ellipse cx="680" cy="4026.4336" fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="668" x2="692" y1="4040.4336" y2="4040.4336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1122" y="134.334">Central Store</text><path d="M1152,84.7988 C1152,74.7988 1170,74.7988 1170,74.7988 C1170,74.7988 1188,74.7988 1188,84.7988 L1188,110.7988 C1188,120.7988 1170,120.7988 1170,120.7988 C1170,120.7988 1152,120.7988 1152,110.7988 L1152,84.7988 " fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1152,84.7988 C1152,94.7988 1170,94.7988 1170,94.7988 C1170,94.7988 1188,94.7988 1188,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1122" y="4007.4805">Central Store</text><path d="M1152,4020.4336 C1152,4010.4336 1170,4010.4336 1170,4010.4336 C1170,4010.4336 1188,4010.4336 1188,4020.4336 L1188,4046.4336 C1188,4056.4336 1170,4056.4336 1170,4056.4336 C1170,4056.4336 1152,4056.4336 1152,4046.4336 L1152,4020.4336 " fill="#FEFECE" filter="url(#fxnx7rqlb5fdv)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1152,4020.4336 C1152,4030.4336 1170,4030.4336 1170,4030.4336 C1170,4030.4336 1188,4030.4336 1188,4020.4336 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="3838.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="3585.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="400.6348"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="445.2559"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="1817.4277" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="474.5664"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1848.375"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2110.1699"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2218.1016"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2386.5859"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2597.3809"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2769.2441"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2907.1074"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3044.3496"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3182.2129"/><rect fill="#FFFFFF" filter="url(#fxnx7rqlb5fdv)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3312.4551"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3823.6582" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M141,176.5977 L141,369.5977 L360,369.5977 L360,186.5977 L350,176.5977 L141,176.5977 " fill="#FFFF00" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M350,176.5977 L350,186.5977 L360,186.5977 L350,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="163" y="209.4766">"settlementModel": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="163" y="224.7871">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="163" y="240.0977">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="255.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="270.7188">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="179" y="286.0293">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="301.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="316.6504">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="331.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="362.582">}</text><polygon fill="#A80036" points="384,396.6348,394,400.6348,384,404.6348,388,400.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="390" y1="400.6348" y2="400.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="143" y="395.8926">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="156" y="395.8926">POST - /settlements</text><polygon fill="#A80036" points="663,441.2559,673,445.2559,663,449.2559,667,445.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="445.2559" y2="445.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="432.8584">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="426" y="425.2031">Request settlementModel</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="440.5137">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="440.5137">2001</text><polygon fill="#A80036" points="1153,470.5664,1163,474.5664,1153,478.5664,1157,474.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="474.5664" y2="474.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="692" y="469.8242">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="705" y="469.8242">Retrieve settlementModel</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="944,487.5664,1396,487.5664,1406,582.5664,1396,678.5664,944,678.5664,934,582.5664,944,487.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="946" y="504.1348">SELECT sg.name settlementGranularity, si.name settlementInterchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="962" y="519.4453">sd.name settlementDelay, sm.ledgerAccountTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="962" y="534.7559">sm.currencyId, sm.requireLiquidityCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="946" y="550.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="986" y="550.0664">settlementModel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1103" y="550.0664">sm</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="565.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="978" y="565.377">settlementGranularity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1131" y="565.377">sg</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="946" y="580.6875">ON sg.settlementGranularityId = sm.settlementGranularityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="595.998">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="978" y="595.998">settlementInterchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="1136" y="595.998">si</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="946" y="611.3086">ON si.settlementInterchangeId = sm.settlementInterchangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="626.6191">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="978" y="626.6191">settlementDelay</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1092" y="626.6191">sd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="946" y="641.9297">ON sd.settlementDelayId = sm.settlementDelayId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="946" y="657.2402">WHERE name = {settlementModelName}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="946" y="672.5508">AND isActive = 1</text><polygon fill="#A80036" points="696,701.6035,686,705.6035,696,709.6035,692,705.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="705.6035" y2="705.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="700.8613">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="715" y="700.8613">Return data</text><polygon fill="#A80036" points="417,730.9141,407,734.9141,417,738.9141,413,734.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="734.9141" y2="734.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="423" y="730.1719">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="436" y="730.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="481" y="730.1719">settlementModelData (smd)</text><path d="M37,749.9141 L121,749.9141 L121,756.9141 L111,766.9141 L37,766.9141 L37,749.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="37" y="749.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="52" y="763.4824">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="136" y="762.5488">[smd.settlementGranularity != 'NET' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="275" x="136" y="775.5039">smd.settlementInterchange != 'MULTILATERAL' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="136" y="788.459">smd.settlementDelay != 'DEFERRED']</text><path d="M411,796.0898 L411,821.0898 L538,821.0898 L538,806.0898 L528,796.0898 L411,796.0898 " fill="#D3D3D3" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,796.0898 L528,806.0898 L538,806.0898 L528,796.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="813.6582">Log ERROR event</text><path d="M47,835.4004 L47,936.4004 L387,936.4004 L387,845.4004 L377,835.4004 L47,835.4004 " fill="#FFFF00" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,835.4004 L377,845.4004 L387,845.4004 L377,835.4004 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="852.9688">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="69" y="868.2793">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="85" y="883.5898">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="85" y="898.9004">"errorDescription": "Invalid settlement model"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="914.2109">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="929.5215">}</text><polygon fill="#A80036" points="147,963.5742,137,967.5742,147,971.5742,143,967.5742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="967.5742" y2="967.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="153" y="962.832">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="166" y="962.832">Respond HTTP - 4xx (Client error)</text><polygon fill="#A80036" points="663,1015.1953,673,1019.1953,663,1023.1953,667,1019.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="1019.1953" y2="1019.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="1006.7979">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="426" y="999.1426">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="1014.4531">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="1014.4531">2001</text><polygon fill="#A80036" points="1153,1044.5059,1163,1048.5059,1153,1052.5059,1157,1048.5059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1048.5059" y2="1048.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="692" y="1043.7637">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="705" y="1043.7637">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="896,1061.5059,1444,1061.5059,1454,1164.5059,1444,1268.5059,896,1268.5059,886,1164.5059,896,1061.5059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="530" x="898" y="1078.0742">SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="898" y="1093.3848">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="938" y="1093.3848">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1067" y="1093.3848">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1108.6953">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="930" y="1108.6953">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1144" y="1108.6953">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="898" y="1124.0059">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1139.3164">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="930" y="1139.3164">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1112" y="1139.3164">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="898" y="1154.627">ON swc.settlementWindowId = sw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1169.9375">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="930" y="1169.9375">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1197" y="1169.9375">swcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="898" y="1185.248">ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="898" y="1200.5586">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="898" y="1215.8691">AND swc.ledgerAccountType = smd.ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="898" y="1231.1797">AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="898" y="1246.4902">AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="898" y="1261.8008">AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')</text><polygon fill="#A80036" points="696,1290.8535,686,1294.8535,696,1298.8535,692,1294.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="1294.8535" y2="1294.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="1290.1113">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="715" y="1290.1113">Return data</text><polygon fill="#A80036" points="417,1320.1641,407,1324.1641,417,1328.1641,413,1324.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="1324.1641" y2="1324.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="1319.4219">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="445" y="1319.4219">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="490" y="1319.4219">windowsData</text><path d="M43,1339.1641 L127,1339.1641 L127,1346.1641 L117,1356.1641 L43,1356.1641 L43,1339.1641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="43" y="1339.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="58" y="1352.7324">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="332" x="142" y="1351.7988">[payload.settlementWindows.length != windowsData.length]</text><path d="M411,1361.4746 L411,1386.4746 L538,1386.4746 L538,1371.4746 L528,1361.4746 L411,1361.4746 " fill="#D3D3D3" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,1361.4746 L528,1371.4746 L538,1371.4746 L528,1361.4746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="1379.043">Log ERROR event</text><path d="M53,1400.7852 L53,1501.7852 L387,1501.7852 L387,1410.7852 L377,1400.7852 L53,1400.7852 " fill="#FFFF00" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,1400.7852 L377,1410.7852 L387,1410.7852 L377,1400.7852 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="59" y="1418.3535">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="75" y="1433.6641">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="91" y="1448.9746">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="91" y="1464.2852">"errorDescription": "Invalid window(s) found"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="75" y="1479.5957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="59" y="1494.9063">}</text><polygon fill="#A80036" points="147,1528.959,137,1532.959,147,1536.959,143,1532.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="1532.959" y2="1532.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="1528.2168">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="175" y="1528.2168">Respond HTTP - 4xx (Client error)</text><path d="M411,1552.959 L411,1577.959 L667,1577.959 L667,1562.959 L657,1552.959 L411,1552.959 " fill="#D3D3D3" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M657,1552.959 L657,1562.959 L667,1562.959 L657,1552.959 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="417" y="1570.5273">All preliminary validations succeeded</text><path d="M23,1594.2695 L179,1594.2695 L179,1601.2695 L169,1611.2695 L23,1611.2695 L23,1594.2695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2376.6758" style="stroke: #000000; stroke-width: 2.0;" width="1474" x="23" y="1594.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="38" y="1607.8379">Main processing</text><polygon fill="#A80036" points="663,1644.2012,673,1648.2012,663,1652.2012,667,1648.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="1648.2012" y2="1648.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1635.8037">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="435" y="1628.1484">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="435" y="1643.459">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="512" y="1643.459">2001</text><path d="M593,1663.2012 L758,1663.2012 L758,1670.2012 L748,1680.2012 L593,1680.2012 L593,1663.2012 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1620.9434" style="stroke: #000000; stroke-width: 2.0;" width="894" x="593" y="1663.2012"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="608" y="1676.7695">DB TRANSACTION</text><path d="M690,1685.5117 L690,1710.5117 L935,1710.5117 L935,1695.5117 L925,1685.5117 L690,1685.5117 " fill="#D3D3D3" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M925,1685.5117 L925,1695.5117 L935,1695.5117 L925,1685.5117 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="696" y="1703.0801">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="716" y="1703.0801">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="872" y="1703.0801">= now()</text><polygon fill="#A80036" points="1153,1737.1328,1163,1741.1328,1153,1745.1328,1157,1741.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1741.1328" y2="1741.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1736.3906">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="714" y="1736.3906">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="1008,1754.1328,1331,1754.1328,1341,1773.1328,1331,1792.1328,1008,1792.1328,998,1773.1328,1008,1754.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1010" y="1770.7012">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1094" y="1770.7012">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1170" y="1770.7012">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1010" y="1786.0117">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,1815.0645,686,1819.0645,696,1823.0645,692,1819.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="1819.0645" y2="1819.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="1814.3223">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="1814.3223">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="769" y="1814.3223">settlementId</text><polygon fill="#A80036" points="1153,1844.375,1163,1848.375,1153,1852.375,1157,1848.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1848.375" y2="1848.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1843.6328">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="714" y="1843.6328">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="872,1891.375,1467,1891.375,1477,1910.375,1467,1929.375,872,1929.375,862,1910.375,872,1891.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="874" y="1907.9434">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="958" y="1907.9434">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1159" y="1907.9434">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="874" y="1923.2539">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1153,1952.3066,1163,1956.3066,1153,1960.3066,1157,1956.3066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1956.3066" y2="1956.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1951.5645">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="714" y="1951.5645">Bind to settlement</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="1063,1999.3066,1277,1999.3066,1287,2041.3066,1277,2083.3066,1063,2083.3066,1053,2041.3066,1063,1999.3066" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1065" y="2015.875">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1081" y="2031.1855">.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1065" y="2046.4961">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1081" y="2061.8066">.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1081" y="2077.1172">.settlementWindowStateId</text><polygon fill="#A80036" points="1153,2106.1699,1163,2110.1699,1153,2114.1699,1157,2110.1699" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2110.1699" y2="2110.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2105.4277">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="714" y="2105.4277">Change state to 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="1046,2153.1699,1294,2153.1699,1304,2172.1699,1294,2191.1699,1046,2191.1699,1036,2172.1699,1046,2153.1699" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1048" y="2169.7383">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1048" y="2185.0488">settlementWindowContent</text><polygon fill="#A80036" points="1153,2214.1016,1163,2218.1016,1153,2222.1016,1157,2218.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2218.1016" y2="2218.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2213.3594">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="714" y="2213.3594">Aggregate settlement net amounts</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="908,2231.1016,1432,2231.1016,1442,2280.1016,1432,2330.1016,908,2330.1016,898,2280.1016,908,2231.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="910" y="2247.6699">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="994" y="2247.6699">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="938" y="2262.9805">(settlementId, participantCurrencyId, netAmount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="520" x="910" y="2278.291">SELECT settlementId, participantCurrencyId, SUM(amount), {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="910" y="2293.6016">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="942" y="2293.6016">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="910" y="2308.9121">WHERE settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="910" y="2324.2227">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="696,2353.2754,686,2357.2754,696,2361.2754,692,2357.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="2357.2754" y2="2357.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="2352.5332">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="2352.5332">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="824" y="2352.5332">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1153,2382.5859,1163,2386.5859,1153,2390.5859,1157,2386.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2386.5859" y2="2386.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2381.8438">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="714" y="2381.8438">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="923,2399.5859,1416,2399.5859,1426,2433.5859,1416,2468.5859,923,2468.5859,913,2433.5859,923,2399.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="925" y="2416.1543">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1009" y="2416.1543">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="953" y="2431.4648">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="925" y="2446.7754">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="953" y="2462.0859">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,2491.1387,686,2495.1387,696,2499.1387,692,2495.1387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="2495.1387" y2="2495.1387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="2490.3965">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="2490.3965">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="824" y="2490.3965">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="727" y1="2555.0703" y2="2555.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="727" x2="727" y1="2555.0703" y2="2568.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686" x2="727" y1="2568.0703" y2="2568.0703"/><polygon fill="#A80036" points="696,2564.0703,686,2568.0703,696,2572.0703,692,2568.0703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2535.0176">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="714" y="2519.707">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="714" y="2535.0176">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="714" y="2550.3281">issue the following update in one knex command</text><polygon fill="#A80036" points="1153,2593.3809,1163,2597.3809,1153,2601.3809,1157,2597.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2597.3809" y2="2597.3809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2592.6387">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="714" y="2592.6387">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="918,2640.3809,1422,2640.3809,1432,2666.3809,1422,2693.3809,918,2693.3809,908,2666.3809,918,2640.3809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="920" y="2656.9492">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="974" y="2656.9492">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="920" y="2672.2598">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="500" x="920" y="2687.5703">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><path d="M603,2706.3125 L677,2706.3125 L677,2713.3125 L667,2723.3125 L603,2723.3125 L603,2706.3125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="603" y="2706.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="618" y="2719.8809">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="692" y="2718.9473">[foreach w in windowsData]</text><path d="M613,2730.623 L680,2730.623 L680,2737.623 L670,2747.623 L613,2747.623 L613,2730.623 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="613" y="2730.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="628" y="2744.1914">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="299" x="695" y="2743.2578">[if w.currentStateChangeId IN ('CLOSED', 'ABORTED')]</text><polygon fill="#A80036" points="1153,2765.2441,1163,2769.2441,1153,2773.2441,1157,2769.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2769.2441" y2="2769.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2764.502">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="714" y="2764.502">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="942,2782.2441,1398,2782.2441,1408,2816.2441,1398,2851.2441,942,2851.2441,932,2816.2441,942,2782.2441" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="944" y="2798.8125">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1028" y="2798.8125">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="960" y="2814.123">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="944" y="2829.4336">VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="960" y="2844.7441">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,2873.7969,686,2877.7969,696,2881.7969,692,2877.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="2877.7969" y2="2877.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="2873.0547">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="2873.0547">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="824" y="2873.0547">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1153,2903.1074,1163,2907.1074,1153,2911.1074,1157,2907.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2907.1074" y2="2907.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2902.3652">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="714" y="2902.3652">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="971,2950.1074,1368,2950.1074,1378,2976.1074,1368,3003.1074,971,3003.1074,961,2976.1074,971,2950.1074" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="973" y="2966.6758">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1027" y="2966.6758">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="973" y="2981.9863">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="973" y="2997.2969">WHERE settlementWindowId = {w.settlementWindowId}</text><polygon fill="#A80036" points="1153,3040.3496,1163,3044.3496,1153,3048.3496,1157,3044.3496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3044.3496" y2="3044.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3039.6074">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="714" y="3039.6074">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="985,3057.3496,1355,3057.3496,1365,3091.3496,1355,3126.3496,985,3126.3496,975,3091.3496,985,3057.3496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="987" y="3073.918">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1071" y="3073.918">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1015" y="3089.2285">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="987" y="3104.5391">VALUES ({settlementId}, PENDING_SETTLEMENT,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1015" y="3119.8496">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,3148.9023,686,3152.9023,696,3156.9023,692,3152.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="3152.9023" y2="3152.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="3148.1602">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="3148.1602">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="769" y="3148.1602">settlementStateChangeId</text><polygon fill="#A80036" points="1153,3178.2129,1163,3182.2129,1153,3186.2129,1157,3182.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3182.2129" y2="3182.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3177.4707">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="714" y="3177.4707">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="996,3225.2129,1344,3225.2129,1354,3251.2129,1344,3278.2129,996,3278.2129,986,3251.2129,996,3225.2129" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="998" y="3241.7813">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1052" y="3241.7813">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="998" y="3257.0918">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="998" y="3272.4023">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1153,3308.4551,1163,3312.4551,1153,3316.4551,1157,3312.4551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3312.4551" y2="3312.4551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3307.7129">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="714" y="3307.7129">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#fxnx7rqlb5fdv)" points="910,3325.4551,1429,3325.4551,1439,3367.4551,1429,3409.4551,910,3409.4551,900,3367.4551,910,3325.4551" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="912" y="3342.0234">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="912" y="3357.334">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="952" y="3357.334">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1163" y="3357.334">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="912" y="3372.6445">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="944" y="3372.6445">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1084" y="3372.6445">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="912" y="3387.9551">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="912" y="3403.2656">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="696,3432.3184,686,3436.3184,696,3440.3184,692,3436.3184" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="3436.3184" y2="3436.3184"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="3431.5762">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="3431.5762">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="769" y="3431.5762">accountData</text><polygon fill="#A80036" points="417,3461.6289,407,3465.6289,417,3469.6289,413,3465.6289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="3465.6289" y2="3465.6289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="3460.8867">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="445" y="3460.8867">Construct and return result</text><path d="M33,3478.6289 L33,3932.6289 L387,3932.6289 L387,3488.6289 L377,3478.6289 L33,3478.6289 " fill="#FFFF00" filter="url(#fxnx7rqlb5fdv)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,3478.6289 L377,3488.6289 L387,3488.6289 L377,3478.6289 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="3496.1973">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="3511.5078">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="55" y="3526.8184">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="55" y="3542.1289">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3557.4395">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="87" y="3572.75">"id": windowsData.settlementWindowIdList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="87" y="3588.0605">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="87" y="3603.3711">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="87" y="3618.6816">"createdDate": windowsData.createdDateList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="87" y="3633.9922">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3649.3027">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="55" y="3664.6133">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="3679.9238">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3695.2344">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="87" y="3710.5449">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="87" y="3725.8555">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3741.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="119" y="3756.4766">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="119" y="3771.7871">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3787.0977">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3802.4082">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="135" y="3817.7188">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="3833.0293">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="3848.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3863.6504">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="3878.9609">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3894.2715">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="3909.582">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="3924.8926">}</text><polygon fill="#A80036" points="147,3958.9453,137,3962.9453,147,3966.9453,143,3962.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="3962.9453" y2="3962.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="3958.2031">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="175" y="3958.2031">Respond HTTP - 201 (Created)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "settlementModel": "string",  
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementModel\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementModel
    activate DB
    hnote over DB #lightyellow
        SELECT sg.name settlementGranularity, si.name settlementInterchange,
            sd.name settlementDelay, sm.ledgerAccountTypeId,
            sm.currencyId, sm.requireLiquidityCheck
        FROM **settlementModel** sm
        JOIN **settlementGranularity** sg
        ON sg.settlementGranularityId = sm.settlementGranularityId
        JOIN **settlementInterchange** si
        ON si.settlementInterchangeId = sm.settlementInterchangeId
        JOIN **settlementDelay** sd
        ON sd.settlementDelayId = sm.settlementDelayId
        WHERE name = {settlementModelName}
        AND isActive = 1
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementModelData (smd)**
    deactivate SETTLE_DAO

    break smd.settlementGranularity != 'NET' ||\nsmd.settlementInterchange != 'MULTILATERAL' ||\nsmd.settlementDelay != 'DEFERRED'
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid settlement model"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end
    
    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        JOIN **settlementWindowContent** swc
        ON swc.settlementWindowId = sw.settlementWindowId
        JOIN **settlementWindowContentStateChange** swcsc
        ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
        AND swc.ledgerAccountType = smd.ledgerAccountType
        AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)
        AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')
        AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    break payload.settlementWindows.length != windowsData.length
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid window(s) found"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end

    note right of SSAPI #lightgray
        All preliminary validations succeeded
    end note

    group Main processing
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Bind to settlement
            activate DB
            hnote over DB #lightyellow
                **settlementWindowContent**
                    .settlementId
                **settlementContentAggregation**
                    .settlementId
                    .settlementWindowStateId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Change state to 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                settlementWindowContentStateChange
                settlementWindowContent
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Aggregate settlement net amounts
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrency**
                       (settlementId, participantCurrencyId, netAmount, createdDate)
                SELECT settlementId, participantCurrencyId, SUM(amount), {transactionTimestamp}
                JOIN **settlementContentAggregation**
                WHERE settlementId = {settlementId}
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            loop foreach w in windowsData
                opt if w.currentStateChangeId IN ('CLOSED', 'ABORTED')
                    SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementWindowStateChange**
                            (settlementWindowId, settlementWindowStateId, reason, createdDate)
                        VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',
                            {payload.reason}, {transactionTimestamp})
                    end hnote
                    SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeId**
                    deactivate DB

                    SETTLE_DAO -> DB: Update pointers to current state change ids
                    activate DB
                    hnote over DB #lightyellow
                        UPDATE **settlementWindow**
                        SET currentStateChangeId = {settlementWindowStateChangeId}
                        WHERE settlementWindowId = {w.settlementWindowId}
                    end hnote
                    deactivate DB
                end
            end

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, PENDING_SETTLEMENT,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": windowsData.settlementWindowIdList,
                        "state": "PENDING_SETTLEMENT",
                        "reason": payload.reason,
                        "createdDate": windowsData.createdDateList,
                        "changedDate": transactionTimestamp
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>