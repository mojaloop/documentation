<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3600px" preserveAspectRatio="none" style="width:1466px;height:3600px;" version="1.1" viewBox="0 0 1466 3600" width="1466px" zoomAndPan="magnify"><defs><filter height="300%" id="f13svlmu8vby5z" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="555.5" y="23.5352">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="3555.1797" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="75" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="90.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="3555.1797" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="318.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="441.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="3555.1797" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1061" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1064" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3323.8926" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3085.8555" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="385.3242"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="429.9453"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1888.2227" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="899.1563"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="459.2559"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="992.0879"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1099.3301"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1207.2617"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1544.8516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1713.3359"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1924.1309"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2047.373"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2242.8574"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2366.0996"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2503.9629"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2634.2051"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3331.8926" style="stroke: #000000; stroke-width: 2.0;" width="1442" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="203.7949" style="stroke: #000000; stroke-width: 2.0;" width="646" x="391" y="627.4297"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="567" x="401" y="721.6719"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="2633.9551" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="845.2246"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1691.7383" style="stroke: #000000; stroke-width: 2.0;" width="874" x="561" y="914.1563"/><rect fill="#FFFFFF" height="186.4844" style="stroke: none; stroke-width: 1.0;" width="1422" x="23" y="3292.6953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="131" x2="131" y1="137.2871" y2="3503.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="400.5" x2="400.5" y1="137.2871" y2="3503.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="628" x2="628" y1="137.2871" y2="3503.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1118" x2="1118" y1="137.2871" y2="3503.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="134.334">Hub Employee</text><ellipse cx="131" cy="63.7988" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,71.7988 L131,98.7988 M118,79.7988 L144,79.7988 M131,98.7988 L118,113.7988 M131,98.7988 L144,113.7988 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="3515.7148">Hub Employee</text><ellipse cx="131" cy="3528.668" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,3536.668 L131,3563.668 M118,3544.668 L144,3544.668 M131,3563.668 L118,3578.668 M131,3563.668 L144,3578.668 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="134.334">Settlement Service API</text><path d="M380.5,92.7988 L380.5,116.7988 M380.5,104.7988 L397.5,104.7988 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="104.7988" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="3515.7148">Settlement Service API</text><path d="M380.5,3522.668 L380.5,3546.668 M380.5,3534.668 L397.5,3534.668 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="3534.668" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="571" y="134.334">Settlement DAO</text><ellipse cx="628" cy="104.7988" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="616" x2="640" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="571" y="3515.7148">Settlement DAO</text><ellipse cx="628" cy="3534.668" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="616" x2="640" y1="3548.668" y2="3548.668"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1070" y="134.334">Central Store</text><path d="M1100,84.7988 C1100,74.7988 1118,74.7988 1118,74.7988 C1118,74.7988 1136,74.7988 1136,84.7988 L1136,110.7988 C1136,120.7988 1118,120.7988 1118,120.7988 C1118,120.7988 1100,120.7988 1100,110.7988 L1100,84.7988 " fill="#FEFECE" filter="url(#f13svlmu8vby5z)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1100,84.7988 C1100,94.7988 1118,94.7988 1118,94.7988 C1118,94.7988 1136,94.7988 1136,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1070" y="3515.7148">Central Store</text><path d="M1100,3528.668 C1100,3518.668 1118,3518.668 1118,3518.668 C1118,3518.668 1136,3518.668 1136,3528.668 L1136,3554.668 C1136,3564.668 1118,3564.668 1118,3564.668 C1118,3564.668 1100,3564.668 1100,3554.668 L1100,3528.668 " fill="#FEFECE" filter="url(#f13svlmu8vby5z)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1100,3528.668 C1100,3538.668 1118,3538.668 1118,3538.668 C1118,3538.668 1136,3538.668 1136,3528.668 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3323.8926" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3085.8555" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="385.3242"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="429.9453"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1888.2227" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="899.1563"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="459.2559"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="992.0879"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1099.3301"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1207.2617"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1544.8516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1713.3359"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1924.1309"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2047.373"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2242.8574"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2366.0996"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2503.9629"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2634.2051"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3331.8926" style="stroke: #000000; stroke-width: 2.0;" width="1442" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M141,176.5977 L141,354.5977 L323,354.5977 L323,186.5977 L313,176.5977 L141,176.5977 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M313,176.5977 L313,186.5977 L323,186.5977 L313,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="163" y="209.4766">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="163" y="224.7871">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="240.0977">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="255.4082">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="179" y="270.7188">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="286.0293">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="301.3398">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="316.6504">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="331.9609">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="347.2715">}</text><polygon fill="#A80036" points="384,381.3242,394,385.3242,384,389.3242,388,385.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="390" y1="385.3242" y2="385.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="143" y="380.582">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="156" y="380.582">POST - /settlements</text><polygon fill="#A80036" points="611,425.9453,621,429.9453,611,433.9453,615,429.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="617" y1="429.9453" y2="429.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="417.5479">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="426" y="409.8926">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="425.2031">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="425.2031">2001</text><polygon fill="#A80036" points="1101,455.2559,1111,459.2559,1101,463.2559,1105,459.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="459.2559" y2="459.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="454.5137">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="653" y="454.5137">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="864,472.2559,1372,472.2559,1382,514.2559,1372,556.2559,864,556.2559,854,514.2559,864,472.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="504" x="866" y="488.8242">SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="866" y="504.1348">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="906" y="504.1348">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1035" y="504.1348">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="866" y="519.4453">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="898" y="519.4453">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1112" y="519.4453">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="866" y="534.7559">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="866" y="550.0664">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="644,579.1191,634,583.1191,644,587.1191,640,583.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="583.1191" y2="583.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="650" y="578.377">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="663" y="578.377">Return data</text><polygon fill="#A80036" points="417,608.4297,407,612.4297,417,616.4297,413,612.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="627" y1="612.4297" y2="612.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="423" y="607.6875">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="436" y="607.6875">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="481" y="607.6875">windowsData</text><path d="M391,627.4297 L821,627.4297 L821,634.4297 L811,644.4297 L391,644.4297 L391,627.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="203.7949" style="stroke: #000000; stroke-width: 2.0;" width="646" x="391" y="627.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="406" y="640.998">Validate all requested windows are found and applicable</text><path d="M411,649.7402 L411,704.7402 L1023,704.7402 L1023,659.7402 L1013,649.7402 L411,649.7402 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1013,649.7402 L1013,659.7402 L1023,659.7402 L1013,649.7402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="591" x="417" y="667.3086">let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="417" y="682.6191">let allSettlementWindowsApplicable = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="417" y="697.9297">let settlementWindow</text><path d="M401,721.6719 L475,721.6719 L475,728.6719 L465,738.6719 L401,738.6719 L401,721.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="567" x="401" y="721.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="416" y="735.2402">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="490" y="734.3066">[w IN windowsData]</text><path d="M411,743.9824 L411,814.9824 L954,814.9824 L954,753.9824 L944,743.9824 L411,743.9824 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M944,743.9824 L944,753.9824 L954,753.9824 L944,743.9824 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="417" y="761.5508">settlementWindow = windowsData[w]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="417" y="776.8613">if (settlementWindow.state != 'CLOSED' &amp;&amp; settlementWindow.state != 'ABORTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="433" y="792.1719">allSettlementWindowsApplicable = false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="417" y="807.4824">}</text><path d="M23,845.2246 L85,845.2246 L85,852.2246 L75,862.2246 L23,862.2246 L23,845.2246 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2633.9551" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="845.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="858.793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="369" x="100" y="857.8594">[allSettlementWindowsFound &amp;&amp; allSettlementWindowsApplicable]</text><polygon fill="#A80036" points="611,895.1563,621,899.1563,611,903.1563,615,899.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="617" y1="899.1563" y2="899.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="886.7588">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="426" y="879.1035">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="894.4141">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="894.4141">2001</text><path d="M561,914.1563 L726,914.1563 L726,921.1563 L716,931.1563 L561,931.1563 L561,914.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1691.7383" style="stroke: #000000; stroke-width: 2.0;" width="874" x="561" y="914.1563"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="576" y="927.7246">DB TRANSACTION</text><path d="M638,936.4668 L638,961.4668 L883,961.4668 L883,946.4668 L873,936.4668 L638,936.4668 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M873,936.4668 L873,946.4668 L883,946.4668 L873,936.4668 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="644" y="954.0352">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="664" y="954.0352">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="820" y="954.0352">= now()</text><polygon fill="#A80036" points="1101,988.0879,1111,992.0879,1101,996.0879,1105,992.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="992.0879" y2="992.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="987.3457">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="653" y="987.3457">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="956,1005.0879,1279,1005.0879,1289,1024.0879,1279,1043.0879,956,1043.0879,946,1024.0879,956,1005.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="958" y="1021.6563">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1042" y="1021.6563">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1118" y="1021.6563">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="958" y="1036.9668">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,1066.0195,634,1070.0195,644,1074.0195,640,1070.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1070.0195" y2="1070.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="650" y="1065.2773">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="663" y="1065.2773">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="708" y="1065.2773">settlementId</text><polygon fill="#A80036" points="1101,1095.3301,1111,1099.3301,1101,1103.3301,1105,1099.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1099.3301" y2="1099.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="1094.5879">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="653" y="1094.5879">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="820,1142.3301,1415,1142.3301,1425,1161.3301,1415,1180.3301,820,1180.3301,810,1161.3301,820,1142.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="822" y="1158.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="906" y="1158.8984">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1107" y="1158.8984">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="822" y="1174.209">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1101,1203.2617,1111,1207.2617,1101,1211.2617,1105,1207.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1207.2617" y2="1207.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1202.5195">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="662" y="1202.5195">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="871,1250.2617,1364,1250.2617,1374,1384.2617,1364,1518.2617,871,1518.2617,861,1384.2617,871,1250.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="873" y="1266.8301">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="957" y="1266.8301">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="901" y="1282.1406">(settlementId, settlementWindowId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="905" y="1297.4512">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="873" y="1312.7617">SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="901" y="1328.0723">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="901" y="1343.3828">{transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="873" y="1358.6934">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="913" y="1358.6934">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1114" y="1358.6934">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1374.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="905" y="1374.0039">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1031" y="1374.0039">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="873" y="1389.3145">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1404.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="905" y="1404.625">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1048" y="1404.625">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="873" y="1419.9355">ON tsc.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="873" y="1435.2461">AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1450.5566">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="905" y="1450.5566">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="1036" y="1450.5566">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="873" y="1465.8672">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="873" y="1481.1777">WHERE ssw.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="873" y="1496.4883">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="909" y="1511.7988">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1101,1540.8516,1111,1544.8516,1101,1548.8516,1105,1544.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1544.8516" y2="1544.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1540.1094">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="662" y="1540.1094">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="856,1557.8516,1380,1557.8516,1390,1606.8516,1380,1656.8516,856,1656.8516,846,1606.8516,856,1557.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="858" y="1574.4199">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="942" y="1574.4199">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="886" y="1589.7305">(settlementId, participantCurrencyId, createdDate, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="520" x="858" y="1605.041">SELECT settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="858" y="1620.3516">FROM settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="858" y="1635.6621">WHERE settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="858" y="1650.9727">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="644,1680.0254,634,1684.0254,644,1688.0254,640,1684.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1684.0254" y2="1684.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="1679.2832">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="1679.2832">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="772" y="1679.2832">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1101,1709.3359,1111,1713.3359,1101,1717.3359,1105,1713.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1713.3359" y2="1713.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1708.5938">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="662" y="1708.5938">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="871,1726.3359,1364,1726.3359,1374,1760.3359,1364,1795.3359,871,1795.3359,861,1760.3359,871,1726.3359" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="873" y="1742.9043">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="957" y="1742.9043">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="901" y="1758.2148">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="873" y="1773.5254">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="901" y="1788.8359">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,1817.8887,634,1821.8887,644,1825.8887,640,1821.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1821.8887" y2="1821.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="1817.1465">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="1817.1465">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="772" y="1817.1465">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="675" y1="1881.8203" y2="1881.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="675" x2="675" y1="1881.8203" y2="1894.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634" x2="675" y1="1894.8203" y2="1894.8203"/><polygon fill="#A80036" points="644,1890.8203,634,1894.8203,644,1898.8203,640,1894.8203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1861.7676">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="662" y="1846.457">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="662" y="1861.7676">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="662" y="1877.0781">issue the following update in one knex command</text><polygon fill="#A80036" points="1101,1920.1309,1111,1924.1309,1101,1928.1309,1105,1924.1309" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1924.1309" y2="1924.1309"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1919.3887">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="662" y="1919.3887">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="866,1967.1309,1370,1967.1309,1380,1993.1309,1370,2020.1309,866,2020.1309,856,1993.1309,866,1967.1309" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="868" y="1983.6992">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="922" y="1983.6992">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="868" y="1999.0098">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="500" x="868" y="2014.3203">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><polygon fill="#A80036" points="1101,2043.373,1111,2047.373,1101,2051.373,1105,2047.373" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2047.373" y2="2047.373"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2042.6309">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="662" y="2042.6309">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="884,2060.373,1352,2060.373,1362,2094.373,1352,2129.373,884,2129.373,874,2094.373,884,2060.373" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="886" y="2076.9414">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="970" y="2076.9414">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="914" y="2092.252">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="886" y="2107.5625">VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="914" y="2122.873">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,2151.9258,634,2155.9258,644,2159.9258,640,2155.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2155.9258" y2="2155.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2151.1836">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="2151.1836">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="772" y="2151.1836">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="675" y1="2200.5469" y2="2200.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="675" x2="675" y1="2200.5469" y2="2213.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634" x2="675" y1="2213.5469" y2="2213.5469"/><polygon fill="#A80036" points="644,2209.5469,634,2213.5469,644,2217.5469,640,2213.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2188.1494">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="662" y="2180.4941">Merge settlementWindowStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="662" y="2195.8047">to payload.settlementWindows.idList</text><polygon fill="#A80036" points="1101,2238.8574,1111,2242.8574,1101,2246.8574,1105,2242.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2242.8574" y2="2242.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2238.1152">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="662" y="2238.1152">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="871,2285.8574,1365,2285.8574,1375,2311.8574,1365,2338.8574,871,2338.8574,861,2311.8574,871,2285.8574" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="873" y="2302.4258">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="927" y="2302.4258">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="873" y="2317.7363">SET currentStateChangeId = {settlementWindowStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="873" y="2333.0469">WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="1101,2362.0996,1111,2366.0996,1101,2370.0996,1105,2366.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2366.0996" y2="2366.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2361.3574">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="662" y="2361.3574">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="933,2379.0996,1303,2379.0996,1313,2413.0996,1303,2448.0996,933,2448.0996,923,2413.0996,933,2379.0996" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="935" y="2395.668">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1019" y="2395.668">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="963" y="2410.9785">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="935" y="2426.2891">VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="963" y="2441.5996">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,2470.6523,634,2474.6523,644,2478.6523,640,2474.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2474.6523" y2="2474.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2469.9102">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="672" y="2469.9102">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="717" y="2469.9102">settlementStateChangeId</text><polygon fill="#A80036" points="1101,2499.9629,1111,2503.9629,1101,2507.9629,1105,2503.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2503.9629" y2="2503.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2499.2207">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="662" y="2499.2207">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="944,2546.9629,1292,2546.9629,1302,2572.9629,1292,2599.9629,944,2599.9629,934,2572.9629,944,2546.9629" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="946" y="2563.5313">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1000" y="2563.5313">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="946" y="2578.8418">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="946" y="2594.1523">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1101,2630.2051,1111,2634.2051,1101,2638.2051,1105,2634.2051" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2634.2051" y2="2634.2051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2629.4629">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="662" y="2629.4629">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="858,2647.2051,1377,2647.2051,1387,2689.2051,1377,2731.2051,858,2731.2051,848,2689.2051,858,2647.2051" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="860" y="2663.7734">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="860" y="2679.084">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="900" y="2679.084">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1111" y="2679.084">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="860" y="2694.3945">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="892" y="2694.3945">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1032" y="2694.3945">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="860" y="2709.7051">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="860" y="2725.0156">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="644,2754.0684,634,2758.0684,644,2762.0684,640,2758.0684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2758.0684" y2="2758.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2753.3262">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="672" y="2753.3262">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="717" y="2753.3262">accountData</text><polygon fill="#A80036" points="417,2783.3789,407,2787.3789,417,2791.3789,413,2787.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="627" y1="2787.3789" y2="2787.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="2782.6367">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="445" y="2782.6367">Construct and return result</text><path d="M33,2800.3789 L33,3254.3789 L387,3254.3789 L387,2810.3789 L377,2800.3789 L33,2800.3789 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,2800.3789 L377,2810.3789 L387,2810.3789 L377,2800.3789 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2817.9473">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="2833.2578">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="55" y="2848.5684">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="55" y="2863.8789">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="2879.1895">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="87" y="2894.5">"id": windowsData.settlementWindowIdList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="87" y="2909.8105">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="87" y="2925.1211">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="87" y="2940.4316">"createdDate": windowsData.createdDateList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="87" y="2955.7422">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="2971.0527">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="55" y="2986.3633">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="3001.6738">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3016.9844">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="87" y="3032.2949">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="87" y="3047.6055">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3062.916">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="119" y="3078.2266">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="119" y="3093.5371">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3108.8477">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3124.1582">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="135" y="3139.4688">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="3154.7793">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="3170.0898">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3185.4004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="3200.7109">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3216.0215">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="3231.332">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="3246.6426">}</text><polygon fill="#A80036" points="147,3280.6953,137,3284.6953,147,3288.6953,143,3284.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="3284.6953" y2="3284.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="3279.9531">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="175" y="3279.9531">Respond HTTP - 201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1445" y1="3293.6953" y2="3293.6953"/><path d="M411,3299.6953 L411,3324.6953 L538,3324.6953 L538,3309.6953 L528,3299.6953 L411,3299.6953 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,3299.6953 L528,3309.6953 L538,3309.6953 L528,3299.6953 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="3317.2637">Log ERROR event</text><path d="M57,3339.0059 L57,3440.0059 L387,3440.0059 L387,3349.0059 L377,3339.0059 L57,3339.0059 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,3339.0059 L377,3349.0059 L387,3349.0059 L377,3339.0059 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="63" y="3356.5742">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="79" y="3371.8848">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="95" y="3387.1953">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="95" y="3402.5059">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="79" y="3417.8164">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="63" y="3433.127">}</text><polygon fill="#A80036" points="142,3467.1797,132,3471.1797,142,3475.1797,138,3471.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="136" x2="400" y1="3471.1797" y2="3471.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="148" y="3466.4375">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="170" y="3466.4375">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    group Validate all requested windows are found and applicable
        note right of SSAPI #lightgray
            let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length
            let allSettlementWindowsApplicable = true
            let settlementWindow
        end note
        loop w IN windowsData
            note right of SSAPI #lightgray
                settlementWindow = windowsData[w]
                if (settlementWindow.state != 'CLOSED' && settlementWindow.state != 'ABORTED') {
                    allSettlementWindowsApplicable = false
                }
            end note
        end loop
    end

    alt allSettlementWindowsFound && allSettlementWindowsApplicable
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementTransferParticipant**
                       (settlementId, settlementWindowId, participantCurrencyId,
                        transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId, 
                       tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),
                       {transactionTimestamp}
                FROM **settlementSettlementWindow** ssw
                JOIN **transferFulfilment** AS tf
                ON tf.settlementWindowId = ssw.settlementWindowId
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId 
                AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE ssw.settlementId = {settlementId}
                GROUP BY ssw.settlementWindowId, tp.participantCurrencyId, 
                         tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrency**
                       (settlementId, participantCurrencyId, createdDate, netAmount)
                SELECT settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)
                FROM settlementTransferParticipant
                WHERE settlementId = {settlementId}
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementWindowStateChangeIdList\nto payload.settlementWindows.idList

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": windowsData.settlementWindowIdList,
                        "state": "PENDING_SETTLEMENT",
                        "reason": payload.reason,
                        "createdDate": windowsData.createdDateList,
                        "changedDate": transactionTimestamp
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>