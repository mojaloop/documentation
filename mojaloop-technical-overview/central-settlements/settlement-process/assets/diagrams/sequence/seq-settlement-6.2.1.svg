<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4456px" preserveAspectRatio="none" style="width:1646px;height:4456px;" version="1.1" viewBox="0 0 1646 4456" width="1646px" zoomAndPan="magnify"><defs><filter height="300%" id="f9zyjyu5cgk8v" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="645.5" y="23.5352">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="4410.8457" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="203" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="218.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4410.8457" style="stroke: #A80036; stroke-width: 1.0;" width="422.5" x="446.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="595.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4410.8457" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1241" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1244" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="4202.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="254" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="3949.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="524" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="2028.2227" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1848.375"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2110.1699"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2218.1016"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2386.5859"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2597.3809"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2769.2441"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2907.1074"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3044.3496"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3182.2129"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3312.4551"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3523.25"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="4187.5586" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="165" y="749.9141"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="171" y="1339.1641"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="2740.5762" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="1594.2695"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="1620.9434" style="stroke: #000000; stroke-width: 2.0;" width="894" x="721" y="1663.2012"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="731" y="2706.3125"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="741" y="2730.623"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="259" x2="259" y1="137.2871" y2="4358.8457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="528.5" x2="528.5" y1="137.2871" y2="4358.8457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="808" x2="808" y1="137.2871" y2="4358.8457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1298" x2="1298" y1="137.2871" y2="4358.8457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="207" y="134.334">Hub Employee</text><ellipse cx="259" cy="63.7988" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M259,71.7988 L259,98.7988 M246,79.7988 L272,79.7988 M259,98.7988 L246,113.7988 M259,98.7988 L272,113.7988 " fill="none" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="207" y="4371.3809">Hub Employee</text><ellipse cx="259" cy="4384.334" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M259,4392.334 L259,4419.334 M246,4400.334 L272,4400.334 M259,4419.334 L246,4434.334 M259,4419.334 L272,4434.334 " fill="none" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="450.5" y="134.334">Settlement Service API</text><path d="M508.5,92.7988 L508.5,116.7988 M508.5,104.7988 L525.5,104.7988 " fill="none" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="537.5" cy="104.7988" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="450.5" y="4371.3809">Settlement Service API</text><path d="M508.5,4378.334 L508.5,4402.334 M508.5,4390.334 L525.5,4390.334 " fill="none" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="537.5" cy="4390.334" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="751" y="134.334">Settlement DAO</text><ellipse cx="808" cy="104.7988" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="796" x2="820" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="751" y="4371.3809">Settlement DAO</text><ellipse cx="808" cy="4390.334" fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="796" x2="820" y1="4404.334" y2="4404.334"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1250" y="134.334">Central Store</text><path d="M1280,84.7988 C1280,74.7988 1298,74.7988 1298,74.7988 C1298,74.7988 1316,74.7988 1316,84.7988 L1316,110.7988 C1316,120.7988 1298,120.7988 1298,120.7988 C1298,120.7988 1280,120.7988 1280,110.7988 L1280,84.7988 " fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1280,84.7988 C1280,94.7988 1298,94.7988 1298,94.7988 C1298,94.7988 1316,94.7988 1316,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1250" y="4371.3809">Central Store</text><path d="M1280,4384.334 C1280,4374.334 1298,4374.334 1298,4374.334 C1298,4374.334 1316,4374.334 1316,4384.334 L1316,4410.334 C1316,4420.334 1298,4420.334 1298,4420.334 C1298,4420.334 1280,4420.334 1280,4410.334 L1280,4384.334 " fill="#FEFECE" filter="url(#f9zyjyu5cgk8v)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1280,4384.334 C1280,4394.334 1298,4394.334 1298,4394.334 C1298,4394.334 1316,4394.334 1316,4384.334 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="4202.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="254" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="3949.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="524" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="2028.2227" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="803" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1848.375"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2110.1699"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2218.1016"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2386.5859"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2597.3809"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2769.2441"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="2907.1074"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3044.3496"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3182.2129"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3312.4551"/><rect fill="#FFFFFF" filter="url(#f9zyjyu5cgk8v)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293" y="3523.25"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4187.5586" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M269,176.5977 L269,369.5977 L488,369.5977 L488,186.5977 L478,176.5977 L269,176.5977 " fill="#FFFF00" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M478,176.5977 L478,186.5977 L488,186.5977 L478,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="275" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="291" y="209.4766">"settlementModel": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="291" y="224.7871">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="291" y="240.0977">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="307" y="255.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="323" y="270.7188">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="307" y="286.0293">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="307" y="301.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="323" y="316.6504">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="307" y="331.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="291" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="275" y="362.582">}</text><polygon fill="#A80036" points="512,396.6348,522,400.6348,512,404.6348,516,400.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="264" x2="518" y1="400.6348" y2="400.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="271" y="395.8926">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="284" y="395.8926">POST - /settlements</text><polygon fill="#A80036" points="791,441.2559,801,445.2559,791,449.2559,795,445.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="534" x2="797" y1="445.2559" y2="445.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="541" y="432.8584">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="554" y="425.2031">Request settlementModel</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="554" y="440.5137">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="631" y="440.5137">2001</text><polygon fill="#A80036" points="1281,470.5664,1291,474.5664,1281,478.5664,1285,474.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="474.5664" y2="474.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="820" y="469.8242">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="833" y="469.8242">Retrieve settlementModel</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1072,487.5664,1524,487.5664,1534,582.5664,1524,678.5664,1072,678.5664,1062,582.5664,1072,487.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1074" y="504.1348">SELECT sg.name settlementGranularity, si.name settlementInterchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="1090" y="519.4453">sd.name settlementDelay, sm.ledgerAccountTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="1090" y="534.7559">sm.currencyId, sm.requireLiquidityCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1074" y="550.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="1114" y="550.0664">settlementModel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1231" y="550.0664">sm</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1074" y="565.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="1106" y="565.377">settlementGranularity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1259" y="565.377">sg</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1074" y="580.6875">ON sg.settlementGranularityId = sm.settlementGranularityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1074" y="595.998">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1106" y="595.998">settlementInterchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="1264" y="595.998">si</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="1074" y="611.3086">ON si.settlementInterchangeId = sm.settlementInterchangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1074" y="626.6191">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1106" y="626.6191">settlementDelay</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1220" y="626.6191">sd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="1074" y="641.9297">ON sd.settlementDelayId = sm.settlementDelayId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="1074" y="657.2402">WHERE name = {settlementModelName}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1074" y="672.5508">AND isActive = 1</text><polygon fill="#A80036" points="824,701.6035,814,705.6035,824,709.6035,820,705.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="705.6035" y2="705.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="830" y="700.8613">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="843" y="700.8613">Return data</text><polygon fill="#A80036" points="545,730.9141,535,734.9141,545,738.9141,541,734.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="539" x2="807" y1="734.9141" y2="734.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="551" y="730.1719">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="564" y="730.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="609" y="730.1719">settlementModelData (smd)</text><path d="M165,749.9141 L249,749.9141 L249,756.9141 L239,766.9141 L165,766.9141 L165,749.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="165" y="749.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="180" y="763.4824">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="264" y="762.5488">[smd.settlementGranularity != 'NET' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="275" x="264" y="775.5039">smd.settlementInterchange != 'MULTILATERAL' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="264" y="788.459">smd.settlementDelay != 'DEFERRED']</text><path d="M539,796.0898 L539,821.0898 L666,821.0898 L666,806.0898 L656,796.0898 L539,796.0898 " fill="#D3D3D3" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M656,796.0898 L656,806.0898 L666,806.0898 L656,796.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="545" y="813.6582">Log ERROR event</text><path d="M175,835.4004 L175,936.4004 L515,936.4004 L515,845.4004 L505,835.4004 L175,835.4004 " fill="#FFFF00" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M505,835.4004 L505,845.4004 L515,845.4004 L505,835.4004 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="181" y="852.9688">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="197" y="868.2793">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="213" y="883.5898">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="213" y="898.9004">"errorDescription": "Invalid settlement model"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="197" y="914.2109">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="181" y="929.5215">}</text><polygon fill="#A80036" points="275,963.5742,265,967.5742,275,971.5742,271,967.5742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="269" x2="523" y1="967.5742" y2="967.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="281" y="962.832">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="294" y="962.832">Respond HTTP - 4xx (Client error)</text><polygon fill="#A80036" points="791,1015.1953,801,1019.1953,791,1023.1953,795,1019.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="534" x2="797" y1="1019.1953" y2="1019.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="541" y="1006.7979">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="554" y="999.1426">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="554" y="1014.4531">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="631" y="1014.4531">2001</text><polygon fill="#A80036" points="1281,1044.5059,1291,1048.5059,1281,1052.5059,1285,1048.5059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="1048.5059" y2="1048.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="820" y="1043.7637">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="833" y="1043.7637">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1024,1061.5059,1572,1061.5059,1582,1164.5059,1572,1268.5059,1024,1268.5059,1014,1164.5059,1024,1061.5059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="530" x="1026" y="1078.0742">SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1026" y="1093.3848">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1066" y="1093.3848">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1195" y="1093.3848">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1026" y="1108.6953">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1058" y="1108.6953">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1272" y="1108.6953">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1026" y="1124.0059">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1026" y="1139.3164">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1058" y="1139.3164">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1240" y="1139.3164">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="1026" y="1154.627">ON swc.settlementWindowId = sw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1026" y="1169.9375">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="1058" y="1169.9375">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1325" y="1169.9375">swcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="1026" y="1185.248">ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="1026" y="1200.5586">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="1026" y="1215.8691">AND swc.ledgerAccountType = smd.ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="1026" y="1231.1797">AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="1026" y="1246.4902">AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="1026" y="1261.8008">AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')</text><polygon fill="#A80036" points="824,1290.8535,814,1294.8535,824,1298.8535,820,1294.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="1294.8535" y2="1294.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="830" y="1290.1113">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="843" y="1290.1113">Return data</text><polygon fill="#A80036" points="545,1320.1641,535,1324.1641,545,1328.1641,541,1324.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="539" x2="807" y1="1324.1641" y2="1324.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="551" y="1319.4219">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="573" y="1319.4219">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="618" y="1319.4219">windowsData</text><path d="M171,1339.1641 L255,1339.1641 L255,1346.1641 L245,1356.1641 L171,1356.1641 L171,1339.1641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="171" y="1339.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="186" y="1352.7324">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="332" x="270" y="1351.7988">[payload.settlementWindows.length != windowsData.length]</text><path d="M539,1361.4746 L539,1386.4746 L666,1386.4746 L666,1371.4746 L656,1361.4746 L539,1361.4746 " fill="#D3D3D3" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M656,1361.4746 L656,1371.4746 L666,1371.4746 L656,1361.4746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="545" y="1379.043">Log ERROR event</text><path d="M181,1400.7852 L181,1501.7852 L515,1501.7852 L515,1410.7852 L505,1400.7852 L181,1400.7852 " fill="#FFFF00" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M505,1400.7852 L505,1410.7852 L515,1410.7852 L505,1400.7852 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="187" y="1418.3535">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="203" y="1433.6641">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="219" y="1448.9746">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="219" y="1464.2852">"errorDescription": "Invalid window(s) found"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="203" y="1479.5957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="187" y="1494.9063">}</text><polygon fill="#A80036" points="275,1528.959,265,1532.959,275,1536.959,271,1532.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="269" x2="523" y1="1532.959" y2="1532.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="281" y="1528.2168">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="303" y="1528.2168">Respond HTTP - 4xx (Client error)</text><path d="M539,1552.959 L539,1577.959 L795,1577.959 L795,1562.959 L785,1552.959 L539,1552.959 " fill="#D3D3D3" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M785,1552.959 L785,1562.959 L795,1562.959 L785,1552.959 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="545" y="1570.5273">All preliminary validations succeeded</text><path d="M23,1594.2695 L179,1594.2695 L179,1601.2695 L169,1611.2695 L23,1611.2695 L23,1594.2695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2740.5762" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="1594.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="38" y="1607.8379">Main processing</text><polygon fill="#A80036" points="791,1644.2012,801,1648.2012,791,1652.2012,795,1648.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="534" x2="797" y1="1648.2012" y2="1648.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="541" y="1635.8037">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="563" y="1628.1484">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="563" y="1643.459">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="640" y="1643.459">2001</text><path d="M721,1663.2012 L886,1663.2012 L886,1670.2012 L876,1680.2012 L721,1680.2012 L721,1663.2012 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1620.9434" style="stroke: #000000; stroke-width: 2.0;" width="894" x="721" y="1663.2012"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="736" y="1676.7695">DB TRANSACTION</text><path d="M818,1685.5117 L818,1710.5117 L1063,1710.5117 L1063,1695.5117 L1053,1685.5117 L818,1685.5117 " fill="#D3D3D3" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1053,1685.5117 L1053,1695.5117 L1063,1695.5117 L1053,1685.5117 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="824" y="1703.0801">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="844" y="1703.0801">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1000" y="1703.0801">= now()</text><polygon fill="#A80036" points="1281,1737.1328,1291,1741.1328,1281,1745.1328,1285,1741.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="1741.1328" y2="1741.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="1736.3906">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="842" y="1736.3906">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1136,1754.1328,1459,1754.1328,1469,1773.1328,1459,1792.1328,1136,1792.1328,1126,1773.1328,1136,1754.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1138" y="1770.7012">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1222" y="1770.7012">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1298" y="1770.7012">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1138" y="1786.0117">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="824,1815.0645,814,1819.0645,824,1823.0645,820,1819.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="1819.0645" y2="1819.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="1814.3223">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="852" y="1814.3223">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="897" y="1814.3223">settlementId</text><polygon fill="#A80036" points="1281,1844.375,1291,1848.375,1281,1852.375,1285,1848.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="1848.375" y2="1848.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="1843.6328">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="842" y="1843.6328">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1000,1891.375,1595,1891.375,1605,1910.375,1595,1929.375,1000,1929.375,990,1910.375,1000,1891.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1002" y="1907.9434">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1086" y="1907.9434">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1287" y="1907.9434">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="1002" y="1923.2539">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1281,1952.3066,1291,1956.3066,1281,1960.3066,1285,1956.3066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="1956.3066" y2="1956.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="1951.5645">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="842" y="1951.5645">Bind to settlement</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1191,1999.3066,1405,1999.3066,1415,2041.3066,1405,2083.3066,1191,2083.3066,1181,2041.3066,1191,1999.3066" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1193" y="2015.875">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1209" y="2031.1855">.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1193" y="2046.4961">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1209" y="2061.8066">.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1209" y="2077.1172">.settlementWindowStateId</text><polygon fill="#A80036" points="1281,2106.1699,1291,2110.1699,1281,2114.1699,1285,2110.1699" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2110.1699" y2="2110.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2105.4277">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="842" y="2105.4277">Change state to 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1174,2153.1699,1422,2153.1699,1432,2172.1699,1422,2191.1699,1174,2191.1699,1164,2172.1699,1174,2153.1699" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1176" y="2169.7383">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1176" y="2185.0488">settlementWindowContent</text><polygon fill="#A80036" points="1281,2214.1016,1291,2218.1016,1281,2222.1016,1285,2218.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2218.1016" y2="2218.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2213.3594">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="842" y="2213.3594">Aggregate settlement net amounts</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1036,2231.1016,1560,2231.1016,1570,2280.1016,1560,2330.1016,1036,2330.1016,1026,2280.1016,1036,2231.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1038" y="2247.6699">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1122" y="2247.6699">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="1066" y="2262.9805">(settlementId, participantCurrencyId, netAmount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="520" x="1038" y="2278.291">SELECT settlementId, participantCurrencyId, SUM(amount), {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1038" y="2293.6016">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1070" y="2293.6016">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1038" y="2308.9121">WHERE settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1038" y="2324.2227">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="824,2353.2754,814,2357.2754,824,2361.2754,820,2357.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="2357.2754" y2="2357.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="2352.5332">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="852" y="2352.5332">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="952" y="2352.5332">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1281,2382.5859,1291,2386.5859,1281,2390.5859,1285,2386.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2386.5859" y2="2386.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2381.8438">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="842" y="2381.8438">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1051,2399.5859,1544,2399.5859,1554,2433.5859,1544,2468.5859,1051,2468.5859,1041,2433.5859,1051,2399.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1053" y="2416.1543">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1137" y="2416.1543">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="1081" y="2431.4648">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="1053" y="2446.7754">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1081" y="2462.0859">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="824,2491.1387,814,2495.1387,824,2499.1387,820,2495.1387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="2495.1387" y2="2495.1387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="2490.3965">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="852" y="2490.3965">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="952" y="2490.3965">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="855" y1="2555.0703" y2="2555.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="855" x2="855" y1="2555.0703" y2="2568.0703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="814" x2="855" y1="2568.0703" y2="2568.0703"/><polygon fill="#A80036" points="824,2564.0703,814,2568.0703,824,2572.0703,820,2568.0703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2535.0176">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="842" y="2519.707">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="842" y="2535.0176">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="842" y="2550.3281">issue the following update in one knex command</text><polygon fill="#A80036" points="1281,2593.3809,1291,2597.3809,1281,2601.3809,1285,2597.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2597.3809" y2="2597.3809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2592.6387">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="842" y="2592.6387">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1046,2640.3809,1550,2640.3809,1560,2666.3809,1550,2693.3809,1046,2693.3809,1036,2666.3809,1046,2640.3809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1048" y="2656.9492">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1102" y="2656.9492">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="1048" y="2672.2598">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="500" x="1048" y="2687.5703">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><path d="M731,2706.3125 L805,2706.3125 L805,2713.3125 L795,2723.3125 L731,2723.3125 L731,2706.3125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="731" y="2706.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="746" y="2719.8809">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="820" y="2718.9473">[foreach w in windowsData]</text><path d="M741,2730.623 L808,2730.623 L808,2737.623 L798,2747.623 L741,2747.623 L741,2730.623 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="741" y="2730.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="756" y="2744.1914">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="299" x="823" y="2743.2578">[if w.currentStateChangeId IN ('CLOSED', 'ABORTED')]</text><polygon fill="#A80036" points="1281,2765.2441,1291,2769.2441,1281,2773.2441,1285,2769.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2769.2441" y2="2769.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2764.502">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="842" y="2764.502">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1070,2782.2441,1526,2782.2441,1536,2816.2441,1526,2851.2441,1070,2851.2441,1060,2816.2441,1070,2782.2441" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1072" y="2798.8125">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1156" y="2798.8125">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="1088" y="2814.123">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="1072" y="2829.4336">VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1088" y="2844.7441">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="824,2873.7969,814,2877.7969,824,2881.7969,820,2877.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="2877.7969" y2="2877.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="2873.0547">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="852" y="2873.0547">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="952" y="2873.0547">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1281,2903.1074,1291,2907.1074,1281,2911.1074,1285,2907.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="2907.1074" y2="2907.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="2902.3652">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="842" y="2902.3652">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1099,2950.1074,1496,2950.1074,1506,2976.1074,1496,3003.1074,1099,3003.1074,1089,2976.1074,1099,2950.1074" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1101" y="2966.6758">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1155" y="2966.6758">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="1101" y="2981.9863">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1101" y="2997.2969">WHERE settlementWindowId = {w.settlementWindowId}</text><polygon fill="#A80036" points="1281,3040.3496,1291,3044.3496,1281,3048.3496,1285,3044.3496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="3044.3496" y2="3044.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="3039.6074">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="842" y="3039.6074">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1113,3057.3496,1483,3057.3496,1493,3091.3496,1483,3126.3496,1113,3126.3496,1103,3091.3496,1113,3057.3496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1115" y="3073.918">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1199" y="3073.918">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1143" y="3089.2285">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1115" y="3104.5391">VALUES ({settlementId}, PENDING_SETTLEMENT,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1143" y="3119.8496">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="824,3148.9023,814,3152.9023,824,3156.9023,820,3152.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="3152.9023" y2="3152.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="3148.1602">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="852" y="3148.1602">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="897" y="3148.1602">settlementStateChangeId</text><polygon fill="#A80036" points="1281,3178.2129,1291,3182.2129,1281,3186.2129,1285,3182.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="3182.2129" y2="3182.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="3177.4707">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="842" y="3177.4707">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1124,3225.2129,1472,3225.2129,1482,3251.2129,1472,3278.2129,1124,3278.2129,1114,3251.2129,1124,3225.2129" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1126" y="3241.7813">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1180" y="3241.7813">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1126" y="3257.0918">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1126" y="3272.4023">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1281,3308.4551,1291,3312.4551,1281,3316.4551,1285,3312.4551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="3312.4551" y2="3312.4551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="3307.7129">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="842" y="3307.7129">Retrieve all content</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1174,3325.4551,1422,3325.4551,1432,3374.4551,1422,3424.4551,1174,3424.4551,1164,3374.4551,1174,3325.4551" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1176" y="3342.0234">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1176" y="3357.334">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1176" y="3372.6445">ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="1176" y="3387.9551">currency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1176" y="3403.2656">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1176" y="3418.5762">settlementWindowStateChange</text><polygon fill="#A80036" points="824,3447.6289,814,3451.6289,824,3455.6289,820,3451.6289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="3451.6289" y2="3451.6289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="3446.8867">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="852" y="3446.8867">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="897" y="3446.8867">settlementWindowContentReport</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="855" y1="3480.9395" y2="3480.9395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="855" x2="855" y1="3480.9395" y2="3493.9395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="814" x2="855" y1="3493.9395" y2="3493.9395"/><polygon fill="#A80036" points="824,3489.9395,814,3493.9395,824,3497.9395,820,3493.9395" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="3476.1973">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="842" y="3476.1973">Use previous result to produce settlementWindowsData (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="1199" y="3476.1973">swd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1226" y="3476.1973">) array</text><polygon fill="#A80036" points="1281,3519.25,1291,3523.25,1281,3527.25,1285,3523.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="813" x2="1287" y1="3523.25" y2="3523.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="820" y="3518.5078">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="842" y="3518.5078">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#f9zyjyu5cgk8v)" points="1038,3536.25,1557,3536.25,1567,3578.25,1557,3620.25,1038,3620.25,1028,3578.25,1038,3536.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="1040" y="3552.8184">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1040" y="3568.1289">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1080" y="3568.1289">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1291" y="3568.1289">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1040" y="3583.4395">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1072" y="3583.4395">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1212" y="3583.4395">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1040" y="3598.75">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="1040" y="3614.0605">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="824,3643.1133,814,3647.1133,824,3651.1133,820,3647.1133" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="818" x2="1297" y1="3647.1133" y2="3647.1133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="830" y="3642.3711">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="852" y="3642.3711">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="897" y="3642.3711">accountData</text><polygon fill="#A80036" points="545,3672.4238,535,3676.4238,545,3680.4238,541,3676.4238" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="539" x2="807" y1="3676.4238" y2="3676.4238"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="551" y="3671.6816">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="573" y="3671.6816">Construct and return result</text><path d="M33,3689.4238 L33,4296.4238 L515,4296.4238 L515,3699.4238 L505,3689.4238 L33,3689.4238 " fill="#FFFF00" filter="url(#f9zyjyu5cgk8v)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M505,3689.4238 L505,3699.4238 L515,3699.4238 L505,3689.4238 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="3706.9922">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="3722.3027">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="55" y="3737.6133">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="55" y="3752.9238">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3768.2344">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="87" y="3783.5449">"id": swd[m].id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="87" y="3798.8555">"state": swd[m].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="87" y="3814.166">"reason": swd[m].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="87" y="3829.4766">"createdDate": swd[m].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="87" y="3844.7871">"changedDate": swd[m].changedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="87" y="3860.0977">"content": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3875.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="119" y="3890.7188">"id": swd[m].content[n].settlementWindowContentId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="119" y="3906.0293">"state": swd[m].content[n].settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="119" y="3921.3398">"ledgerAccountType": swd[m].content[n].ledgerAccountType,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="119" y="3936.6504">"currencyId": swd[m].content[n].currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="119" y="3951.9609">"createdDate": swd[m].content[n].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="119" y="3967.2715">"changedDate": swd[m].content[n].changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3982.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="3997.8926">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4013.2031">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="55" y="4028.5137">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="4043.8242">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4059.1348">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="87" y="4074.4453">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="87" y="4089.7559">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="4105.0664">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="119" y="4120.377">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="119" y="4135.6875">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="4150.998">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="4166.3086">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="135" y="4181.6191">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="4196.9297">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="4212.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="4227.5508">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="4242.8613">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4258.1719">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="4273.4824">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4288.793">}</text><polygon fill="#A80036" points="275,4322.8457,265,4326.8457,275,4330.8457,271,4326.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="269" x2="523" y1="4326.8457" y2="4326.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="281" y="4322.1035">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="303" y="4322.1035">Respond HTTP - 201 (Created)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "settlementModel": "string",  
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementModel\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementModel
    activate DB
    hnote over DB #lightyellow
        SELECT sg.name settlementGranularity, si.name settlementInterchange,
            sd.name settlementDelay, sm.ledgerAccountTypeId,
            sm.currencyId, sm.requireLiquidityCheck
        FROM **settlementModel** sm
        JOIN **settlementGranularity** sg
        ON sg.settlementGranularityId = sm.settlementGranularityId
        JOIN **settlementInterchange** si
        ON si.settlementInterchangeId = sm.settlementInterchangeId
        JOIN **settlementDelay** sd
        ON sd.settlementDelayId = sm.settlementDelayId
        WHERE name = {settlementModelName}
        AND isActive = 1
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementModelData (smd)**
    deactivate SETTLE_DAO

    break smd.settlementGranularity != 'NET' ||\nsmd.settlementInterchange != 'MULTILATERAL' ||\nsmd.settlementDelay != 'DEFERRED'
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid settlement model"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end
    
    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        JOIN **settlementWindowContent** swc
        ON swc.settlementWindowId = sw.settlementWindowId
        JOIN **settlementWindowContentStateChange** swcsc
        ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
        AND swc.ledgerAccountType = smd.ledgerAccountType
        AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)
        AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')
        AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    break payload.settlementWindows.length != windowsData.length
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid window(s) found"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end

    note right of SSAPI #lightgray
        All preliminary validations succeeded
    end note

    group Main processing
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Bind to settlement
            activate DB
            hnote over DB #lightyellow
                **settlementWindowContent**
                    .settlementId
                **settlementContentAggregation**
                    .settlementId
                    .settlementWindowStateId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Change state to 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                settlementWindowContentStateChange
                settlementWindowContent
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Aggregate settlement net amounts
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrency**
                       (settlementId, participantCurrencyId, netAmount, createdDate)
                SELECT settlementId, participantCurrencyId, SUM(amount), {transactionTimestamp}
                JOIN **settlementContentAggregation**
                WHERE settlementId = {settlementId}
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            loop foreach w in windowsData
                opt if w.currentStateChangeId IN ('CLOSED', 'ABORTED')
                    SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementWindowStateChange**
                            (settlementWindowId, settlementWindowStateId, reason, createdDate)
                        VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',
                            {payload.reason}, {transactionTimestamp})
                    end hnote
                    SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeId**
                    deactivate DB

                    SETTLE_DAO -> DB: Update pointers to current state change ids
                    activate DB
                    hnote over DB #lightyellow
                        UPDATE **settlementWindow**
                        SET currentStateChangeId = {settlementWindowStateChangeId}
                        WHERE settlementWindowId = {w.settlementWindowId}
                    end hnote
                    deactivate DB
                end
            end

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, PENDING_SETTLEMENT,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Retrieve all content
        activate DB
        hnote over DB #lightyellow
            settlementWindowContent
            settlementWindowContentStateChange
            ledgerAccountType
            currency
            settlementWindow
            settlementWindowStateChange
        end hnote
        SETTLE_DAO <- - DB: Return **settlementWindowContentReport**
        deactivate DB

        SETTLE_DAO -> SETTLE_DAO: Use previous result to produce settlementWindowsData (**swd**) array

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": swd[m].id,
                        "state": swd[m].state,
                        "reason": swd[m].reason,
                        "createdDate": swd[m].createdDate,
                        "changedDate": swd[m].changedDate,
                        "content": [
                            {
                                "id": swd[m].content[n].settlementWindowContentId,
                                "state": swd[m].content[n].settlementWindowStateId,
                                "ledgerAccountType": swd[m].content[n].ledgerAccountType,
                                "currencyId": swd[m].content[n].currencyId,
                                "createdDate": swd[m].content[n].createdDate,
                                "changedDate": swd[m].content[n].changedDate
                            }
                        ]
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>