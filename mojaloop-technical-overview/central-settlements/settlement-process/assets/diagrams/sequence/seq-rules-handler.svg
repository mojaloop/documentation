<svg xmlns="http://www.w3.org/2000/svg" height="2738" preserveAspectRatio="none" style="width:3090px;height:2738px" width="3090">
  <defs>
    <filter height="300%" id="a" width="300%" x="-1" y="-1">
      <feGaussianBlur result="blurOut" stdDeviation="2"/>
      <feColorMatrix in="blurOut" result="blurOut2" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
      <feOffset dx="4" dy="4" in="blurOut2" result="blurOut3"/>
      <feBlend in="SourceGraphic" in2="blurOut3"/>
    </filter>
  </defs>
  <text font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="299" x="1393.5" y="28.708">
    Rules Handler Consume (Success)
  </text>
  <path fill="#90EE90" stroke="#a80036" d="M26 40.953h2499v2691.414H26z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1206" y="53.02">
    Settlement Service
  </text>
  <path fill="#FFFFE0" stroke="#a80036" d="M2527 40.953h125v2691.414h-125z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="2530" y="53.02">
    Central Services
  </text>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 615.438h10v30H93zM373 132.383h10v2524.688h-10zM819 201.781h10v102.398h-10zM819 853.367h10v419.727h-10zM1881 906.633h10v288.195h-10zM2110 935.766h10v222.93h-10zM2584.5 964.898h10v29.133h-10zM2584.5 1386.625h10v319.523h-10zM2584.5 1759.414h10v30h-10zM2584.5 1866.813h10v30h-10zM2584.5 2020.477h10v107.664h-10zM2584.5 2157.273h10v107.664h-10zM2584.5 2294.07h10v30h-10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M10 139.383h3066v2510.688H10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M317 163.516h1579v399.656H317z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M762 216.781h1124v59.266H762zM20 577.172h3046V2643.07H20z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M317 660.438h378v74.398H317zM297 748.836h2759V2636.07H297z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M317 815.102h2344.5v465.992H317z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M762 868.367h1889.5v376.594H762zM307 1295.094h2739v1289.844H307z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M317 1319.227h2719v1214.578H317z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M2208.5 1721.148H2880v761.523h-671.5z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M2361 1911.813h456v80.531h-456z"/>
  <path fill="#FFF" d="M2208.5 2425.734H2880v56.938h-671.5zM317 2489.672h2719v44.133H317zM307 2540.805h2739v44.133H307zM297 2591.938h2759v44.133H297z"/>
  <path stroke="#a80036" stroke-dasharray="5,5" d="M98 122.383V2667.07M378 122.383V2667.07M824 122.383V2667.07M1885.5 122.383V2667.07M2115 122.383V2667.07M2276.5 122.383V2667.07M2450 122.383V2667.07M2589.5 122.383V2667.07"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 83.086h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 87.086h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="107.081">
    topic-notification
  </text>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 2666.07h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 2670.07h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="2690.065">
    topic-notification
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="327" y="119.081">
    Rules Handler
  </text>
  <circle cx="378" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 78.086l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="327" y="2679.065">
    Rules Handler
  </text>
  <circle cx="378" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 2686.367l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="772" y="119.081">
    Scripts Loader
  </text>
  <circle cx="824" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M812 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="772" y="2679.065">
    Scripts Loader
  </text>
  <circle cx="824" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M812 2712.367h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="1837.5" y="119.081">
    Script Engine
  </text>
  <circle cx="1886" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1874 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="1837.5" y="2679.065">
    Script Engine
  </text>
  <circle cx="1886" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1874 2712.367h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="2054" y="119.081">
    Transaction DAO
  </text>
  <circle cx="2115" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2103 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="2054" y="2679.065">
    Transaction DAO
  </text>
  <circle cx="2115" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2103 2712.367h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="2218.5" y="119.081">
    Settlement DAO
  </text>
  <circle cx="2277" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2265 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="2218.5" y="2679.065">
    Settlement DAO
  </text>
  <circle cx="2277" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2265 2712.367h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="136" x="2379" y="119.081">
    Central Ledger DAO
  </text>
  <circle cx="2450" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2438 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="136" x="2379" y="2679.065">
    Central Ledger DAO
  </text>
  <circle cx="2450" cy="2698.367" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M2438 2712.367h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="2537.5" y="119.081">
    central_ledger
  </text>
  <path d="M2571.5 70.086c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M2571.5 70.086c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="2537.5" y="2679.065">
    central_ledger
  </text>
  <path d="M2571.5 2692.367c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M2571.5 2692.367c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 615.438h10v30H93zM373 132.383h10v2524.688h-10zM819 201.781h10v102.398h-10zM819 853.367h10v419.727h-10zM1881 906.633h10v288.195h-10zM2110 935.766h10v222.93h-10zM2584.5 964.898h10v29.133h-10zM2584.5 1386.625h10v319.523h-10zM2584.5 1759.414h10v30h-10zM2584.5 1866.813h10v30h-10zM2584.5 2020.477h10v107.664h-10zM2584.5 2157.273h10v107.664h-10zM2584.5 2294.07h10v30h-10z"/>
  <path d="M10 139.383h297v7l-10 10H10v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M10 139.383h3066v2510.688H10z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="252" x="25" y="152.45">
    Rules Handler Consume (Success)
  </text>
  <path d="M317 163.516h137v7l-10 10H317v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M317 163.516h1579v399.656H317z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="332" y="176.583">
    Load Scripts
  </text>
  <path fill="#A80036" stroke="#a80036" d="M807 197.781l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M383 201.781h430"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="196.715">
    1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="403" y="196.715">
    load scripts (yaml file) (scriptDirectory)
  </text>
  <path d="M762 216.781h77v7l-10 10h-67v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M762 216.781h1124v59.266H762z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="777" y="229.848">
    loop
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="46" x="854" y="228.992">
    [script]
  </text>
  <path stroke="#a80036" d="M829 255.047h42M871 255.047v13M830 268.047h41"/>
  <path fill="#A80036" stroke="#a80036" d="M840 264.047l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="836" y="249.981">
    2
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1025" x="849" y="249.981">
    validate script type, action and status against enums; validate script is valid JS; validate start and end timestamps; Create a map ScriptMap[type][action][result]
  </text>
  <path fill="#A80036" stroke="#a80036" d="M394 300.18l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M388 304.18h435"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="400" y="299.114">
    3
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="413" y="299.114">
    create script map
  </text>
  <path d="M388 317.18v236h359v-226l-10-10H388" fill="#FF0" filter="url(#a)" stroke="#a80036"/>
  <path d="M737 317.18v10h10l-10-10" fill="#FF0" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="394" y="334.247">
    example:
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="394" y="349.379">
    {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="410" y="364.512">
    scriptType: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="426" y="379.645">
    scriptAction: {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="442" y="394.778">
    scriptStatus: {[
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="458" y="409.911">
    {
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="474" y="425.043">
    name: &quot;interchangeFeeCalculation&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="474" y="440.176">
    startTime: &quot;2020-06-01T00:00:00.000Z&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="474" y="455.309">
    endTime: &quot;2100-12-31T23:59:59.999Z&quot;,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="474" y="470.442">
    script: [vm.Script]
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="458" y="485.575">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="442" y="500.707">
    ]}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="426" y="515.84">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="410" y="530.973">
    }
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="394" y="546.106">
    }
  </text>
  <path d="M20 577.172h224v7l-10 10H20v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M20 577.172h3046V2643.07H20z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="35" y="590.239">
    Process Single Message
  </text>
  <path fill="#A80036" stroke="#a80036" d="M114 611.438l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" d="M108 615.438h264"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="120" y="610.372">
    4
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="133" y="610.372">
    Consume notification event message
  </text>
  <path d="M317 660.438h177v7l-10 10H317v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M317 660.438h378v74.398H317z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="332" y="673.504">
    Validate Message
  </text>
  <path stroke="#a80036" d="M383 713.836h42M425 713.836v13M384 726.836h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 722.836l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="701.204">
    5
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="403" y="693.637">
    Validate event - Rule: message has payload
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="403" y="708.77">
    Error codes:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="497" y="708.77">
    2001
  </text>
  <path d="M297 748.836h64v7l-10 10h-54v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M297 748.836h2759V2636.07H297z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="312" y="761.903">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="376" y="761.046">
    [Rule found]
  </text>
  <path stroke="#a80036" d="M383 787.102h42M425 787.102v13M384 800.102h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 796.102l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="782.036">
    6
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="403" y="782.036">
    check if ScriptMap[type][action][result] has valid script assigned
  </text>
  <path d="M317 815.102h159v7l-10 10H317v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M317 815.102h2344.5v465.992H317z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="332" y="828.168">
    Execute Scripts
  </text>
  <path fill="#A80036" stroke="#a80036" d="M807 849.367l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M383 853.367h430"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="848.301">
    7
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="403" y="848.301">
    execute scripts
  </text>
  <path d="M762 868.367h77v7l-10 10h-67v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M762 868.367h1889.5v376.594H762z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="777" y="881.434">
    loop
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="46" x="854" y="880.578">
    [script]
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1869 902.633l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M829 906.633h1046"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="836" y="901.567">
    8
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="849" y="901.567">
    execute(script, message payload)
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2098 931.766l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1891 935.766h213"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1898" y="930.7">
    9
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="1911" y="930.7">
    Get transaction by transfer Id
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 960.898l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2120 964.898h458.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2127" y="959.832">
    10
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="2149" y="959.832">
    retrieve ILP packet from ilpPacket
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2131 990.031l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M2125 994.031h463.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2137" y="988.965">
    11
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="2159" y="988.965">
    ilpPacket row
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1902 1019.164l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M1896 1023.164h213"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1908" y="1018.098">
    12
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1930" y="1018.098">
    ilpPacket row
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2098 1048.297l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1891 1052.297h213"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1898" y="1047.231">
    13
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1920" y="1047.231">
    Get transaction object
  </text>
  <path stroke="#a80036" d="M2120 1081.43h42M2162 1081.43v13M2121 1094.43h41"/>
  <path fill="#A80036" stroke="#a80036" d="M2131 1090.43l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2127" y="1076.364">
    14
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="2149" y="1076.364">
    decode ILP packet
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1902 1119.563l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M1896 1123.563h213"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1908" y="1118.497">
    15
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="1930" y="1118.497">
    Transaction object
  </text>
  <path stroke="#a80036" d="M1891 1157.695h42M1933 1157.695v13M1886 1170.695h47"/>
  <path fill="#A80036" stroke="#a80036" d="M1896 1166.695l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1898" y="1152.629">
    16
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1920" y="1152.629">
    execute script in sandbox
  </text>
  <path fill="#A80036" stroke="#a80036" d="M840 1190.828l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M834 1194.828h1051"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="846" y="1189.762">
    17
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="868" y="1189.762">
    Ledger entries
  </text>
  <path stroke="#a80036" d="M829 1223.961h42M871 1223.961v13M830 1236.961h41"/>
  <path fill="#A80036" stroke="#a80036" d="M840 1232.96l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="836" y="1218.895">
    18
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="858" y="1218.895">
    Merge results
  </text>
  <path fill="#A80036" stroke="#a80036" d="M394 1269.094l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M388 1273.094h435"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="400" y="1268.028">
    19
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="422" y="1268.028">
    script results
  </text>
  <path d="M307 1295.094h64v7l-10 10h-54v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M307 1295.094h2739v1289.844H307z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="322" y="1308.161">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="386" y="1307.304">
    [Has ledger entries]
  </text>
  <path d="M317 1319.227h433v7l-10 10H317v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M317 1319.227h2719v1214.578H317z"/>
  <text fill="#00F" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="388" x="332" y="1332.293">
    DB TRANSACTION: Validate and Insert ledger entries
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2265 1353.492l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M383 1357.492h1888"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="390" y="1352.426">
    20
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="412" y="1352.426">
    Insert valid ledger entries
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 1382.625l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 1386.625h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="1381.559">
    21
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="2306" y="1381.559">
    Get the records to insert
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2163 1399.625h853l10 140-10 140h-853l-10-140 10-140z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="2165" y="1415.692">
    select {transferId} AS transferId,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="2197" y="1430.825">
    `PC`.`participantCurrencyId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="2197" y="1445.957">
    IFNULL(`T1`.`transferparticipantroletypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="460" x="2229" y="1461.09">
    `T2`.`transferparticipantroletypeId`) as `transferParticipantRoleTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="2197" y="1476.223">
    `E`.`ledgerEntryTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="2197" y="1491.356">
    CASE `P`.`name`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="2213" y="1506.489">
    WHEN {ledgerEntry.payerFspId} THEN {ledgerEntry.amount}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="2213" y="1521.622">
    WHEN {ledgerEntry.payeeFspId} THEN {ledgerEntry.amount * -1}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="2213" y="1536.754">
    ELSE 0
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="2197" y="1551.887">
    END AS `amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="2181" y="1567.02">
    from `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="2181" y="1582.153">
    inner join `participant` as `P` on `P`.`participantId` = `PC`.`participantId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="630" x="2181" y="1597.286">
    inner join `ledgerEntryType` as `E` on `E`.`LedgerAccountTypeId` = `PC`.`LedgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="833" x="2181" y="1612.418">
    left outer join `transferParticipantRoleType` as `T1` on `P`.`name` = {ledgerEntry.payerFspId} and `T1`.`name` = &apos;PAYER_DFSP&apos;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="833" x="2181" y="1627.551">
    left outer join `transferParticipantRoleType` as `T2` on `P`.`name` = {ledgerEntry.payerFspId} and `T2`.`name` = &apos;PAYEE_DFSP&apos;
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="2181" y="1642.684">
    where `E`.`name` = {ledgerEntry.ledgerEntryTypeId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="2181" y="1657.817">
    and `P`.`name` in ({ledgerEntry.payerFspId}, {ledgerEntry.payeeFspId})
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="2181" y="1672.95">
    and `PC`.`currencyId` = {ledgerEntry.currency};
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2288 1702.148l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M2282 1706.148h306.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2294" y="1701.082">
    22
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="2316" y="1701.082">
    recordsToInsert
  </text>
  <path d="M2208.5 1721.148h64v7l-10 10h-54v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M2208.5 1721.148H2880v761.523h-671.5z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="2223.5" y="1734.215">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="2287.5" y="1733.359">
    [Has records to insert]
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 1755.414l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 1759.414h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="1754.348">
    23
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="2306" y="1754.348">
    Insert transferParticipant records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2483 1802.414h212l10 19-10 19h-212l-10-19 10-19z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="2485" y="1818.481">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="2553" y="1818.481">
    transferParticipant
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 1862.813l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 1866.813h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="1861.747">
    24
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="2306" y="1861.747">
    Update positions
  </text>
  <path d="M2361 1911.813h77v7l-10 10h-67v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M2361 1911.813h456v80.531h-456z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="2376" y="1924.879">
    loop
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="2453" y="1924.023">
    [transferParticipant records]
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2381 1933.945h416l10 26-10 27h-416l-10-27 10-26z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="2383" y="1950.012">
    update
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="2432" y="1950.012">
    `participantPosition`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="2383" y="1965.145">
    set `value` = `value` + {record.amount}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="412" x="2383" y="1980.278">
    where `participantCurrencyId` = {record.participantCurrencyId};
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 2016.477l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 2020.477h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="2015.411">
    25
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="2306" y="2015.411">
    Get transferStateChange record
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2466 2033.477h247l10 34-10 34h-247l-10-34 10-34z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="2468" y="2049.544">
    select `transferStateChangeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="2468" y="2064.676">
    from
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="2502" y="2064.676">
    `transferStateChange`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="2468" y="2079.809">
    where `transferId` = {transferId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="2468" y="2094.942">
    and `transferStateId` = &apos;COMMITTED&apos;;
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2288 2124.14l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M2282 2128.141h306.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2294" y="2123.075">
    26
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="2316" y="2123.075">
    transferStateChange record
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 2153.273l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 2157.273h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="2152.207">
    27
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="2306" y="2152.207">
    Get participantPosition record
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2345 2170.273h488l10 34-10 34h-488l-10-34 10-34z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="2347" y="2186.34">
    select `participantPositionId`, `value`, `reservedValue`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="2347" y="2201.473">
    from
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="2381" y="2201.473">
    `participantPosition`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="484" x="2347" y="2216.606">
    where `participantCurrencyId` = {recordsToInsert[0].participantCurrencyId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="2347" y="2231.739">
    OR `participantCurrencyId` = {recordsToInsert[1].participantCurrencyId};
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2288 2260.938l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M2282 2264.938h306.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2294" y="2259.872">
    28
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="2316" y="2259.872">
    participantPosition record
  </text>
  <path fill="#A80036" stroke="#a80036" d="M2572.5 2290.07l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M2277 2294.07h301.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="2289.004">
    29
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="2306" y="2289.004">
    Insert participantPositionChange records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M2319 2337.07h541l10 41-10 42h-541l-10-42 10-41z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="2321" y="2353.137">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="2389" y="2353.137">
    `participantPositionChange`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="524" x="2321" y="2368.27">
    select `participantPositionId`, {transferStateChangeId}, `value`, `reservedValue`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="2321" y="2383.403">
    from `participantPosition`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="537" x="2321" y="2398.536">
    where `participantCurrencyId` = {transferParticipantRecord1.participantCurrencyId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="516" x="2321" y="2413.669">
    or `participantCurrencyId` = {transferParticipantRecord2.participantCurrencyId};
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M2208.5 2426.734H2880"/>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="2213.5" y="2436.945">
    [No records found]
  </text>
  <path stroke="#a80036" d="M2277 2461.672h42M2319 2461.672v13M2278 2474.672h41"/>
  <path fill="#A80036" stroke="#a80036" d="M2288 2470.672l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="2456.606">
    30
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="2311" y="2456.606">
    Error
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M317 2490.672h2719"/>
  <path stroke="#a80036" d="M2277 2512.805h42M2319 2512.805v13M2278 2525.805h41"/>
  <path fill="#A80036" stroke="#a80036" d="M2288 2521.805l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2284" y="2507.739">
    31
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="2311" y="2507.739">
    Rollback on Error
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M307 2541.805h2739"/>
  <path stroke="#a80036" d="M383 2563.938h42M425 2563.938v13M384 2576.938h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 2572.938l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="390" y="2558.872">
    32
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="412" y="2558.872">
    exit
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M297 2592.938h2759"/>
  <path stroke="#a80036" d="M383 2615.07h42M425 2615.07v13M384 2628.07h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 2624.07l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="390" y="2610.004">
    33
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="412" y="2610.004">
    exit
  </text>
</svg>
