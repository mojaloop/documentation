<svg xmlns="http://www.w3.org/2000/svg" height="2474" preserveAspectRatio="none" style="width:1796px;height:2474px" width="1796">
  <defs>
    <filter height="300%" id="a" width="300%" x="-1" y="-1">
      <feGaussianBlur result="blurOut" stdDeviation="2"/>
      <feColorMatrix in="blurOut" result="blurOut2" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
      <feOffset dx="4" dy="4" in="blurOut2" result="blurOut3"/>
      <feBlend in="SourceGraphic" in2="blurOut3"/>
    </filter>
  </defs>
  <text font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="404" x="694" y="28.708">
    Gross Settlement Handler Consume (Success)
  </text>
  <path fill="#90EE90" stroke="#a80036" d="M26 40.953h1042.5v2427.273H26z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="477.75" y="53.02">
    Settlement Service
  </text>
  <path fill="#FFFFE0" stroke="#a80036" d="M1255 40.953h125v2427.273h-125z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="1258" y="53.02">
    Central Services
  </text>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 201.781h10v30H93zM373 132.383h10V2392.93h-10zM1312.5 479.977h10v30h-10zM1312.5 883.102h10v30h-10zM1312.5 1353.688h10v30h-10zM1312.5 1824.273h10v30h-10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M10 139.383h1772V2385.93H10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M20 163.516h1752V2378.93H20z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M276 246.781h419v74.398H276zM246 335.18h1516v1982.813H246z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M256 359.313h1496v1951.68H256z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M266 383.445h1476v1920.547H266z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M276 737.438h735v88.398H276z"/>
  <path fill="#FFF" d="M20 2324.992h1752v53.938H20z"/>
  <path stroke="#a80036" stroke-dasharray="5,5" d="M98 122.383V2402.93M378 122.383V2402.93M694.5 122.383V2402.93M1005.5 122.383V2402.93M1317.5 122.383V2402.93"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 83.086h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 87.086h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="107.081">
    topic-notification
  </text>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 2401.93h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 2405.93h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="2425.925">
    topic-notification
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="286" y="119.081">
    Gross Settlement Handler
  </text>
  <circle cx="378" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 78.086l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="286" y="2414.925">
    Gross Settlement Handler
  </text>
  <circle cx="378" cy="2434.227" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 2422.227l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="604.5" y="119.081">
    Gross Settlement Service
  </text>
  <circle cx="695" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M691 78.086l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="604.5" y="2414.925">
    Gross Settlement Service
  </text>
  <circle cx="695" cy="2434.227" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M691 2422.227l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="947.5" y="119.081">
    Settlement DAO
  </text>
  <circle cx="1006" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M994 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="947.5" y="2414.925">
    Settlement DAO
  </text>
  <circle cx="1006" cy="2434.227" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M994 2448.227h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1265.5" y="119.081">
    central_ledger
  </text>
  <path d="M1299.5 70.086c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1299.5 70.086c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1265.5" y="2414.925">
    central_ledger
  </text>
  <path d="M1299.5 2428.227c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1299.5 2428.227c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 201.781h10v30H93zM373 132.383h10V2392.93h-10zM1312.5 479.977h10v30h-10zM1312.5 883.102h10v30h-10zM1312.5 1353.688h10v30h-10zM1312.5 1824.273h10v30h-10z"/>
  <path d="M10 139.383h385v7l-10 10H10v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M10 139.383h1772V2385.93H10z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="25" y="152.45">
    Gross Settlement Handler Consume (Success)
  </text>
  <path d="M20 163.516h64v7l-10 10H20v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M20 163.516h1752V2378.93H20z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="35" y="176.583">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="99" y="175.726">
    [Consume Single Message]
  </text>
  <path fill="#A80036" stroke="#a80036" d="M114 197.781l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" d="M108 201.781h264"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="120" y="196.715">
    1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="133" y="196.715">
    Consume notification event message
  </text>
  <path d="M276 246.781h177v7l-10 10H276v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M276 246.781h419v74.398H276z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="291" y="259.848">
    Validate Message
  </text>
  <path stroke="#a80036" d="M383 300.18h42M425 300.18v13M384 313.18h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 309.18l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="287.547">
    2
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="403" y="279.981">
    Validate event - Rule: message has payload
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="403" y="295.114">
    Error codes:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="497" y="295.114">
    2001
  </text>
  <path d="M246 335.18h70v7l-10 10h-60v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M246 335.18h1516v1982.813H246z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="261" y="348.247">
    opt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="331" y="347.39">
    [action == &apos;COMMIT&apos;]
  </text>
  <path d="M256 359.313h221v7l-10 10H256v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M256 359.313h1496v1951.68H256z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="176" x="271" y="372.379">
    Retry (default 3 retries)
  </text>
  <path d="M266 383.445h289v7l-10 10H266v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M266 383.445h1476v1920.547H266z"/>
  <text fill="#00F" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="281" y="396.512">
    DB TRANSACTION: settle transfer
  </text>
  <path fill="#A80036" stroke="#a80036" d="M683 417.71l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M383 421.711h306"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="416.645">
    3
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="403" y="416.645">
    Process fulfil message
  </text>
  <path fill="#A80036" stroke="#a80036" d="M994 446.844l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M695 450.844h305"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="445.778">
    4
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="715" y="445.778">
    Get Gross settlement model
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1300.5 475.977l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1006 479.977h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1013" y="474.911">
    5
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="1026" y="474.911">
    Get settlement model records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M912 522.977h810l10 72-10 72H912l-10-72 10-72z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="914" y="539.043">
    SELECT settlementModel.*
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="914" y="554.176">
    FROM
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="954" y="554.176">
    settlementModel
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="930" y="569.309">
    INNER JOIN `participantCurrency` AS `pc` ON `pc`.`currencyId` = `settlementModel`.`currencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="946" y="584.442">
    AND `pc`.`ledgerAccountTypeId` `settlementModel`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="669" x="930" y="599.575">
    INNER JOIN `transferParticipant` AS `tp` ON `tp`.`participantCurrencyId` = `pc`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="790" x="930" y="614.707">
    INNER JOIN settlementGranularity AS `g` ON `g`.`settlementGranularityId` = `settlementModel`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="914" y="629.84">
    WHERE `tp`.`transferId`, {transferId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="930" y="644.973">
    AND `g`.`name`, {settlementGranularityName}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="930" y="660.106">
    AND `settlementModel`.`isActive`, {1};
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1017 689.305l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M1011 693.305h305.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1023" y="688.239">
    6
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1036" y="688.239">
    Gross settlement model result
  </text>
  <path fill="#A80036" stroke="#a80036" d="M706 718.438l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M700 722.438h305"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="712" y="717.372">
    7
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="725" y="717.372">
    Gross settlement model result
  </text>
  <path d="M276 737.438h242v7l-10 10H276v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M276 737.438h735v88.398H276z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="291" y="750.504">
    Validate settlement model
  </text>
  <path stroke="#a80036" d="M695 775.703h42M737 775.703v13M696 788.703h41"/>
  <path fill="#A80036" stroke="#a80036" d="M706 784.703l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="770.637">
    8
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="715" y="770.637">
    Valid Gross settlement model does not exist
  </text>
  <path fill="#A80036" stroke="#a80036" d="M394 813.836l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" d="M388 817.836h306"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="400" y="812.77">
    9
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="413" y="812.77">
    Return true
  </text>
  <path fill="#A80036" stroke="#a80036" d="M994 849.969l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M695 853.969h305"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="848.903">
    10
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="724" y="848.903">
    Settle transfer if CGS
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1300.5 879.102l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1006 883.102h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1013" y="878.036">
    11
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="1035" y="878.036">
    Insert transferParticipant entries
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M936 926.102h762l10 200-10 201H936l-10-201 10-200z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="938" y="942.168">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1006" y="942.168">
    `transferParticipant`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="532" x="1164" y="942.168">
    (transferID, participantCurrencyId, transferParticipantRoleTypeId, ledgerEntryTypeId,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="1070" y="957.301">
    amount)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="938" y="972.434">
    select `TP`.`transferId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="966" y="987.567">
    `TP`.`participantCurrencyId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="966" y="1002.7">
    `TP`.`transferParticipantRoleTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="966" y="1017.832">
    `TP`.`ledgerEntryTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="966" y="1032.965">
    `TP`.`amount` * -1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="938" y="1048.098">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="666" x="974" y="1063.231">
    inner join `participantCurrency` as `PC` on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="974" y="1078.364">
    inner join `settlementModel` as `M` on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="693" x="974" y="1093.497">
    inner join `settlementGranularity` as `G` on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="938" y="1108.629">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="938" y="1123.762">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="938" y="1138.895">
    select `TP`.`transferId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="966" y="1154.028">
    `PC1`.`participantCurrencyId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="966" y="1169.161">
    `TP`.`transferParticipantRoleTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="966" y="1184.293">
    `TP`.`ledgerEntryTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="966" y="1199.426">
    `TP`.`amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="938" y="1214.559">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="666" x="974" y="1229.692">
    inner join `participantCurrency` as `PC` on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="974" y="1244.825">
    inner join `settlementModel` as `M` on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="693" x="974" y="1259.957">
    inner join `settlementGranularity` as `G` on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="974" y="1275.09">
    inner join `participantCurrency` as `PC1`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="620" x="1018" y="1290.223">
    on `PC1`.`currencyId` = `PC`.`currencyId` and `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1030" y="1305.356">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="938" y="1320.489">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;));
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1300.5 1349.688l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1006 1353.688h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1013" y="1348.622">
    12
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="1035" y="1348.622">
    Update participantPosition records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1028 1396.688h579l10 200-10 201h-579l-10-201 10-200z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="1030" y="1412.754">
    update
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1079" y="1412.754">
    `participantPosition`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1237" y="1412.754">
    as `PP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="1046" y="1427.887">
    inner join (select `PC`.`participantCurrencyId`, `TP`.`Amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1098" y="1443.02">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1134" y="1458.153">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1178" y="1473.286">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1134" y="1488.418">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1178" y="1503.551">
    on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1134" y="1518.684">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1178" y="1533.817">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1098" y="1548.95">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1098" y="1564.082">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1098" y="1579.215">
    select `PC1`.`participantCurrencyId`, `TP`.`amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1098" y="1594.348">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1134" y="1609.481">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1178" y="1624.614">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1134" y="1639.747">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1178" y="1654.879">
    on `M`.`ledgerAccountTypeId` = `PC`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1134" y="1670.012">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1178" y="1685.145">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1134" y="1700.278">
    inner join `participantCurrency` as `PC1`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="1178" y="1715.411">
    on `PC1`.`currencyId` = `PC`.`currencyId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1190" y="1730.543">
    `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1190" y="1745.676">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="453" x="1098" y="1760.809">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;)))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="1046" y="1775.942">
    AS TR ON PP.participantCurrencyId = TR.ParticipantCurrencyId
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="1030" y="1791.075">
    set `value` = `PP`.`value` - `TR`.`amount`;
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1300.5 1820.273l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1006 1824.273h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1013" y="1819.207">
    13
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1035" y="1819.207">
    Insert participantPositionChange records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M957 1867.273h720l10 215-10 216H957l-10-216 10-215z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="959" y="1883.34">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1027" y="1883.34">
    `participantPositionChange`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="434" x="1241" y="1883.34">
    (participantPositionId, transferStateChangeId, value, reservedValue)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="667" x="959" y="1898.473">
    select `PP`.`participantPositionId`, `TSC`.`transferStateChangeId`, `PP`.`value`, `PP`.`reservedValue`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="959" y="1913.606">
    from `participantPosition` as `PP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="995" y="1928.739">
    inner join (select `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1043" y="1943.872">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1079" y="1959.004">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1123" y="1974.137">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1079" y="1989.27">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1123" y="2004.403">
    on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1079" y="2019.536">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1123" y="2034.668">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1043" y="2049.801">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1043" y="2064.934">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="1043" y="2080.067">
    select `PC1`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1043" y="2095.2">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1079" y="2110.332">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1123" y="2125.465">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1079" y="2140.598">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="1123" y="2155.731">
    on `PC`.`ledgerAccountTypeId` = `PC`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1079" y="2170.864">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1123" y="2185.997">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="572" x="1079" y="2201.129">
    inner join `participantCurrency` as `PC1` on `PC1`.`currencyId` = `PC`.`currencyId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1259" y="2216.262">
    `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1259" y="2231.395">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="494" x="1043" y="2246.528">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))) AS TR
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="1039" y="2261.661">
    ON PP.participantCurrencyId = TR.ParticipantCurrencyId
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="995" y="2276.794">
    inner join `transferStateChange` as `TSC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="1039" y="2291.926">
    on `TSC`.`transferID` = {transferId} and `TSC`.`transferStateId` = &apos;SETTLED&apos;;
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M20 2325.992h1752"/>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="25" y="2336.203">
    [Consume Batch Messages]
  </text>
  <path d="M149 2344.797v25h215v-15l-10-10H149" fill="#ADD8E6" filter="url(#a)" stroke="#a80036"/>
  <path d="M354 2344.797v10h10l-10-10" fill="#ADD8E6" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="155" y="2361.864">
    To be delivered by future story
  </text>
</svg>
