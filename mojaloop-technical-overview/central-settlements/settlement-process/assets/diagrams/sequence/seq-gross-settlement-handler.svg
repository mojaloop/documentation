<svg xmlns="http://www.w3.org/2000/svg" height="2633" preserveAspectRatio="none" style="width:2061px;height:2633px" width="2061">
  <defs>
    <filter height="300%" id="a" width="300%" x="-1" y="-1">
      <feGaussianBlur result="blurOut" stdDeviation="2"/>
      <feColorMatrix in="blurOut" result="blurOut2" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
      <feOffset dx="4" dy="4" in="blurOut2" result="blurOut3"/>
      <feBlend in="SourceGraphic" in2="blurOut3"/>
    </filter>
  </defs>
  <text font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="404" x="826.5" y="28.708">
    Gross Settlement Handler Consume (Success)
  </text>
  <path fill="#90EE90" stroke="#a80036" d="M26 40.953h1307.5v2586.805H26z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="610.25" y="53.02">
    Settlement Service
  </text>
  <path fill="#FFFFE0" stroke="#a80036" d="M1520 40.953h125v2586.805h-125z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="1523" y="53.02">
    Central Services
  </text>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 201.781h10v30H93zM373 132.383h10v2420.078h-10zM1577.5 479.977h10v30h-10zM1577.5 1042.633h10v30h-10zM1577.5 1513.219h10v30h-10zM1577.5 1983.805h10v30h-10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M10 139.383h2037v2406.078H10z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M20 163.516h2017v2374.945H20z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M276 246.781h419v74.398H276zM256 335.18h1771v2142.344H256z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M266 359.313h1751v2111.211H266z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M276 383.445h1731v2080.078H276z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M584.5 737.438h1060v247.93h-1060z"/>
  <path fill="#FFF" filter="url(#a)" stroke="#000" stroke-width="2" d="M594.5 832.836H1276v145.531H594.5z"/>
  <path fill="#FFF" d="M594.5 892.102H1276v86.266H594.5zM20 2484.523h2017v53.938H20z"/>
  <path stroke="#a80036" stroke-dasharray="5,5" d="M98 122.383v2440.078M378 122.383v2440.078M694.5 122.383v2440.078M1270.5 122.383v2440.078M1582.5 122.383v2440.078"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 83.086h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 87.086h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="107.081">
    topic-notification
  </text>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M34 2561.461h128v30.297H34z"/>
  <path fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="1.5" d="M30 2565.461h128v30.297H30z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="37" y="2585.456">
    topic-notification
  </text>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="286" y="119.081">
    Gross Settlement Handler
  </text>
  <circle cx="378" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 78.086l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="286" y="2574.456">
    Gross Settlement Handler
  </text>
  <circle cx="378" cy="2593.758" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M374 2581.758l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="604.5" y="119.081">
    Gross Settlement Service
  </text>
  <circle cx="695" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M691 78.086l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="604.5" y="2574.456">
    Gross Settlement Service
  </text>
  <circle cx="695" cy="2593.758" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path fill="#A80036" stroke="#a80036" d="M691 2581.758l6-5-2 5 2 5-6-5z"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="1212.5" y="119.081">
    Settlement DAO
  </text>
  <circle cx="1271" cy="90.086" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1259 104.086h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="1212.5" y="2574.456">
    Settlement DAO
  </text>
  <circle cx="1271" cy="2593.758" fill="#FEFECE" filter="url(#a)" stroke="#a80036" stroke-width="2" r="12"/>
  <path stroke="#a80036" stroke-width="2" d="M1259 2607.758h24"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1530.5" y="119.081">
    central_ledger
  </text>
  <path d="M1564.5 70.086c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1564.5 70.086c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <text font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1530.5" y="2574.456">
    central_ledger
  </text>
  <path d="M1564.5 2587.758c0-10 18-10 18-10s18 0 18 10v26c0 10-18 10-18 10s-18 0-18-10v-26" fill="#FEFECE" filter="url(#a)" stroke="#000" stroke-width="1.5"/>
  <path d="M1564.5 2587.758c0 10 18 10 18 10s18 0 18-10" fill="none" stroke="#000" stroke-width="1.5"/>
  <path fill="#FFF" filter="url(#a)" stroke="#a80036" d="M93 201.781h10v30H93zM373 132.383h10v2420.078h-10zM1577.5 479.977h10v30h-10zM1577.5 1042.633h10v30h-10zM1577.5 1513.219h10v30h-10zM1577.5 1983.805h10v30h-10z"/>
  <path d="M10 139.383h385v7l-10 10H10v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M10 139.383h2037v2406.078H10z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="25" y="152.45">
    Gross Settlement Handler Consume (Success)
  </text>
  <path d="M20 163.516h64v7l-10 10H20v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M20 163.516h2017v2374.945H20z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="35" y="176.583">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="99" y="175.726">
    [Consume Single Message]
  </text>
  <path fill="#A80036" stroke="#a80036" d="M114 197.781l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" d="M108 201.781h264"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="120" y="196.715">
    1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="133" y="196.715">
    Consume notification event message
  </text>
  <path d="M276 246.781h177v7l-10 10H276v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M276 246.781h419v74.398H276z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="291" y="259.848">
    Validate Message
  </text>
  <path stroke="#a80036" d="M383 300.18h42M425 300.18v13M384 313.18h41"/>
  <path fill="#A80036" stroke="#a80036" d="M394 309.18l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="287.547">
    2
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="403" y="279.981">
    Validate event - Rule: message has payload
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="403" y="295.114">
    Error codes:
  </text>
  <text fill="red" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="497" y="295.114">
    2001
  </text>
  <path d="M256 335.18h70v7l-10 10h-60v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M256 335.18h1771v2142.344H256z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="271" y="348.247">
    opt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="341" y="347.39">
    [action == &apos;COMMIT&apos;]
  </text>
  <path d="M266 359.313h221v7l-10 10H266v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M266 359.313h1751v2111.211H266z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="176" x="281" y="372.379">
    Retry (default 3 retries)
  </text>
  <path d="M276 383.445h289v7l-10 10H276v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M276 383.445h1731v2080.078H276z"/>
  <text fill="#00F" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="291" y="396.512">
    DB TRANSACTION: settle transfer
  </text>
  <path fill="#A80036" stroke="#a80036" d="M683 417.71l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M383 421.711h306"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="390" y="416.645">
    3
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="403" y="416.645">
    Process fulfil message
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1259 446.844l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M695 450.844h570"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="445.778">
    4
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="715" y="445.778">
    Get Gross settlement model
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1565.5 475.977l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1271 479.977h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1278" y="474.911">
    5
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="1291" y="474.911">
    Get settlement model records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1177 522.977h810l10 72-10 72h-810l-10-72 10-72z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="1179" y="539.043">
    SELECT settlementModel.*
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1179" y="554.176">
    FROM
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1219" y="554.176">
    settlementModel
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1195" y="569.309">
    INNER JOIN `participantCurrency` AS `pc` ON `pc`.`currencyId` = `settlementModel`.`currencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="1211" y="584.442">
    AND `pc`.`ledgerAccountTypeId` `settlementModel`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="669" x="1195" y="599.575">
    INNER JOIN `transferParticipant` AS `tp` ON `tp`.`participantCurrencyId` = `pc`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="790" x="1195" y="614.707">
    INNER JOIN settlementGranularity AS `g` ON `g`.`settlementGranularityId` = `settlementModel`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="1179" y="629.84">
    WHERE `tp`.`transferId`, {transferId}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="1195" y="644.973">
    AND `g`.`name`, {settlementGranularityName}
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="1195" y="660.106">
    AND `settlementModel`.`isActive`, {1};
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1282 689.305l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M1276 693.305h305.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1288" y="688.239">
    6
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1301" y="688.239">
    Gross settlement model result
  </text>
  <path fill="#A80036" stroke="#a80036" d="M706 718.438l-10 4 10 4-4-4z"/>
  <path stroke="#a80036" stroke-dasharray="2,2" d="M700 722.438h570"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="712" y="717.372">
    7
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="725" y="717.372">
    Gross settlement model result
  </text>
  <path d="M584.5 737.438h242v7l-10 10h-232v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M584.5 737.438h1060v247.93h-1060z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="599.5" y="750.504">
    Validate settlement model
  </text>
  <path stroke="#a80036" d="M695 775.703h42M737 775.703v13M696 788.703h41"/>
  <path fill="#A80036" stroke="#a80036" d="M706 784.703l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="770.637">
    8
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="715" y="770.637">
    Valid Gross settlement model with given currency does not exist
  </text>
  <path fill="#A80036" stroke="#a80036" d="M706 813.836l-10 4 10 4-4-4zM1570.5 813.836l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M700 817.836h876.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="712" y="812.77">
    9
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="725" y="812.77">
    Get all settlement models
  </text>
  <path d="M594.5 832.836h64v7l-10 10h-54v-17" fill="#EEE" stroke="#000"/>
  <path fill="none" stroke="#000" stroke-width="2" d="M594.5 832.836H1276v145.531H594.5z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="609.5" y="845.903">
    alt
  </text>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="420" x="673.5" y="845.046">
    [Check if NET settlement model with the transfer currency exists]
  </text>
  <path stroke="#a80036" d="M695 871.102h42M737 871.102v13M696 884.102h41"/>
  <path fill="#A80036" stroke="#a80036" d="M706 880.102l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="866.036">
    10
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="724" y="866.036">
    Return true
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M594.5 893.102H1276"/>
  <path stroke="#a80036" d="M695 915.234h42M737 915.234v13M696 928.234h41"/>
  <path fill="#A80036" stroke="#a80036" d="M706 924.234l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="910.168">
    11
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="540" x="724" y="910.168">
    filter all settlement models by currencyId === null and granularityType === GROSS
  </text>
  <path stroke="#a80036" d="M695 957.367h42M737 957.367v13M696 970.367h41"/>
  <path fill="#A80036" stroke="#a80036" d="M706 966.367l-10 4 10 4-4-4z"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="952.301">
    12
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="724" y="952.301">
    Return default GROSS settlement model
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1259 1009.5l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M695 1013.5h570"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="1008.434">
    13
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="724" y="1008.434">
    Settle transfer if CGS
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1565.5 1038.633l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1271 1042.633h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278" y="1037.567">
    14
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="1300" y="1037.567">
    Insert transferParticipant entries
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1201 1085.633h762l10 200-10 201h-762l-10-201 10-200z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1203" y="1101.7">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1271" y="1101.7">
    `transferParticipant`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="532" x="1429" y="1101.7">
    (transferID, participantCurrencyId, transferParticipantRoleTypeId, ledgerEntryTypeId,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="1335" y="1116.832">
    amount)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1203" y="1131.965">
    select `TP`.`transferId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="1231" y="1147.098">
    `TP`.`participantCurrencyId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="1231" y="1162.231">
    `TP`.`transferParticipantRoleTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="1231" y="1177.364">
    `TP`.`ledgerEntryTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1231" y="1192.497">
    `TP`.`amount` * -1
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1203" y="1207.629">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="666" x="1239" y="1222.762">
    inner join `participantCurrency` as `PC` on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1239" y="1237.895">
    inner join `settlementModel` as `M` on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="693" x="1239" y="1253.028">
    inner join `settlementGranularity` as `G` on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1203" y="1268.161">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1203" y="1283.293">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1203" y="1298.426">
    select `TP`.`transferId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1231" y="1313.559">
    `PC1`.`participantCurrencyId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="1231" y="1328.692">
    `TP`.`transferParticipantRoleTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="1231" y="1343.825">
    `TP`.`ledgerEntryTypeId`,
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1231" y="1358.957">
    `TP`.`amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1203" y="1374.09">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="666" x="1239" y="1389.223">
    inner join `participantCurrency` as `PC` on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1239" y="1404.356">
    inner join `settlementModel` as `M` on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="693" x="1239" y="1419.489">
    inner join `settlementGranularity` as `G` on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1239" y="1434.622">
    inner join `participantCurrency` as `PC1`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="620" x="1283" y="1449.754">
    on `PC1`.`currencyId` = `PC`.`currencyId` and `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1295" y="1464.887">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="1203" y="1480.02">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;));
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1565.5 1509.219l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1271 1513.219h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278" y="1508.153">
    15
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="1300" y="1508.153">
    Update participantPosition records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1293 1556.219h579l10 200-10 201h-579l-10-201 10-200z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="1295" y="1572.286">
    update
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1344" y="1572.286">
    `participantPosition`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1502" y="1572.286">
    as `PP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="1311" y="1587.418">
    inner join (select `PC`.`participantCurrencyId`, `TP`.`Amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1363" y="1602.551">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1399" y="1617.684">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1443" y="1632.817">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1399" y="1647.95">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1443" y="1663.082">
    on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1399" y="1678.215">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1443" y="1693.348">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1363" y="1708.481">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1363" y="1723.614">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1363" y="1738.747">
    select `PC1`.`participantCurrencyId`, `TP`.`amount`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1363" y="1753.879">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1399" y="1769.012">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1443" y="1784.145">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1399" y="1799.278">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1443" y="1814.411">
    on `M`.`ledgerAccountTypeId` = `PC`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1399" y="1829.543">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1443" y="1844.676">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1399" y="1859.809">
    inner join `participantCurrency` as `PC1`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="1443" y="1874.942">
    on `PC1`.`currencyId` = `PC`.`currencyId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1455" y="1890.075">
    `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1455" y="1905.207">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="453" x="1363" y="1920.34">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;)))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="1311" y="1935.473">
    AS TR ON PP.participantCurrencyId = TR.ParticipantCurrencyId
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="1295" y="1950.606">
    set `value` = `PP`.`value` - `TR`.`amount`;
  </text>
  <path fill="#A80036" stroke="#a80036" d="M1565.5 1979.805l10 4-10 4 4-4z"/>
  <path stroke="#a80036" d="M1271 1983.805h300.5"/>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278" y="1978.739">
    16
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1300" y="1978.739">
    Insert participantPositionChange records
  </text>
  <path fill="#FFFFE0" filter="url(#a)" stroke="#a80036" d="M1222 2026.805h720l10 215-10 216h-720l-10-216 10-215z"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1224" y="2042.872">
    insert into
  </text>
  <text font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1292" y="2042.872">
    `participantPositionChange`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="434" x="1506" y="2042.872">
    (participantPositionId, transferStateChangeId, value, reservedValue)
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="667" x="1224" y="2058.004">
    select `PP`.`participantPositionId`, `TSC`.`transferStateChangeId`, `PP`.`value`, `PP`.`reservedValue`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="1224" y="2073.137">
    from `participantPosition` as `PP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1260" y="2088.27">
    inner join (select `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1308" y="2103.403">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1344" y="2118.536">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1388" y="2133.669">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1344" y="2148.801">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="1388" y="2163.934">
    on `PC`.`ledgerAccountTypeId` = `M`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1344" y="2179.067">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1388" y="2194.2">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="1308" y="2209.332">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1308" y="2224.465">
    union
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="1308" y="2239.598">
    select `PC1`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1308" y="2254.731">
    from `transferParticipant` as `TP`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1344" y="2269.864">
    inner join `participantCurrency` as `PC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1388" y="2284.997">
    on `TP`.`participantCurrencyId` = `PC`.`participantCurrencyId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1344" y="2300.129">
    inner join `settlementModel` as `M`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="1388" y="2315.262">
    on `PC`.`ledgerAccountTypeId` = `PC`.`ledgerAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1344" y="2330.395">
    inner join `settlementGranularity` as `G`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="1388" y="2345.528">
    on `M`.`settlementGranularityId` = `G`.`settlementGranularityId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="572" x="1344" y="2360.661">
    inner join `participantCurrency` as `PC1` on `PC1`.`currencyId` = `PC`.`currencyId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1524" y="2375.794">
    `PC1`.`participantId` = `PC`.`participantId` and
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="1524" y="2390.926">
    `PC1`.`ledgerAccountTypeId` = `M`.`settlementAccountTypeId`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="494" x="1308" y="2406.059">
    where (`TP`.`transferId` = {transferId} and (`G`.`name` = &apos;GROSS&apos;))) AS TR
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="1304" y="2421.192">
    ON PP.participantCurrencyId = TR.ParticipantCurrencyId
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="1260" y="2436.325">
    inner join `transferStateChange` as `TSC`
  </text>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="1304" y="2451.457">
    on `TSC`.`transferID` = {transferId} and `TSC`.`transferStateId` = &apos;SETTLED&apos;;
  </text>
  <path stroke="#000" stroke-dasharray="2,2" d="M20 2485.523h2017"/>
  <text font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="25" y="2495.734">
    [Consume Batch Messages]
  </text>
  <path d="M149 2504.328v25h215v-15l-10-10H149" fill="#ADD8E6" filter="url(#a)" stroke="#a80036"/>
  <path d="M354 2504.328v10h10l-10-10" fill="#ADD8E6" stroke="#a80036"/>
  <text font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="155" y="2521.395">
    To be delivered by future story
  </text>
</svg>
