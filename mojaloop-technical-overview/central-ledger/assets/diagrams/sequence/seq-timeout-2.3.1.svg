<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1364px" preserveAspectRatio="none" style="width:944px;height:1364px;" version="1.1" viewBox="0 0 944 1364" width="944px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ral8uz9bc0e6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="362" y="23.5352">2.3.1. Timeout Prepare Handler</text><rect fill="#FFFFE0" height="1319.1016" style="stroke: #A80036; stroke-width: 1.0;" width="787.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="372.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="1139.8379" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="270" y="1223.6133"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="508.5" y="335.5703"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="508.5" y="579.3652"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="759.5" y="364.8809"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="759.5" y="608.6758"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="1132.8379" style="stroke: #000000; stroke-width: 2.0;" width="920" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="441.5" x="23" y="160.0859"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="229.7949" style="stroke: #000000; stroke-width: 2.0;" width="860" x="23" y="281.6387"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="900" x="23" y="525.4336"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="508.3848" style="stroke: #000000; stroke-width: 2.0;" width="330.5" x="23" y="753.2285"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="93" x2="93" y1="118.7754" y2="1285.6133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="274.5" x2="274.5" y1="118.7754" y2="1285.6133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="403.5" x2="403.5" y1="118.7754" y2="1285.6133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="513.5" x2="513.5" y1="118.7754" y2="1285.6133"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="764.5" x2="764.5" y1="118.7754" y2="1285.6133"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="33" y="99.334">Timeout Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="63" y="115.8223">Handler</text><ellipse cx="93" cy="69.7988" fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="89,57.7988,95,52.7988,93,57.7988,95,62.7988,89,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="33" y="1298.1484">Timeout Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="63" y="1314.6367">Handler</text><ellipse cx="93" cy="1333.5898" fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="89,1321.5898,95,1316.5898,93,1321.5898,95,1326.5898,89,1321.5898" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="210.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="206.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="250" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="213.5" y="103.8223">transfer-timeout</text><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="210.5" y="1284.6133"/><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="206.5" y="1288.6133"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="250" y="1309.1484">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="213.5" y="1325.6367">transfer-timeout</text><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="357.5" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="353.5" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="360.5" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="357.5" y="1284.6133"/><rect fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="353.5" y="1288.6133"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="360.5" y="1309.1484">topic-event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="464.5" y="115.8223">Timeout DAO</text><ellipse cx="513.5" cy="86.2871" fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="501.5" x2="525.5" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="464.5" y="1298.1484">Timeout DAO</text><ellipse cx="513.5" cy="1317.1016" fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="501.5" x2="525.5" y1="1331.1016" y2="1331.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="716.5" y="115.8223">Central Store</text><path d="M746.5,66.2871 C746.5,56.2871 764.5,56.2871 764.5,56.2871 C764.5,56.2871 782.5,56.2871 782.5,66.2871 L782.5,92.2871 C782.5,102.2871 764.5,102.2871 764.5,102.2871 C764.5,102.2871 746.5,102.2871 746.5,92.2871 L746.5,66.2871 " fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M746.5,66.2871 C746.5,76.2871 764.5,76.2871 764.5,76.2871 C764.5,76.2871 782.5,76.2871 782.5,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="716.5" y="1298.1484">Central Store</text><path d="M746.5,1311.1016 C746.5,1301.1016 764.5,1301.1016 764.5,1301.1016 C764.5,1301.1016 782.5,1301.1016 782.5,1311.1016 L782.5,1337.1016 C782.5,1347.1016 764.5,1347.1016 764.5,1347.1016 C764.5,1347.1016 746.5,1347.1016 746.5,1337.1016 L746.5,1311.1016 " fill="#FEFECE" filter="url(#f1ral8uz9bc0e6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M746.5,1311.1016 C746.5,1321.1016 764.5,1321.1016 764.5,1321.1016 C764.5,1321.1016 782.5,1321.1016 782.5,1311.1016 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="1139.8379" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="88" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="270" y="1223.6133"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="508.5" y="335.5703"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="508.5" y="579.3652"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="759.5" y="364.8809"/><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="759.5" y="608.6758"/><path d="M13,135.7754 L229,135.7754 L229,142.7754 L219,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1132.8379" style="stroke: #000000; stroke-width: 2.0;" width="920" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="28" y="149.3438">Timeout Prepare Handler</text><path d="M23,160.0859 L238,160.0859 L238,167.0859 L228,177.0859 L23,177.0859 L23,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="441.5" x="23" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="38" y="173.6543">Persist Event Information</text><polygon fill="#A80036" points="392,194.707,402,198.707,392,202.707,396,198.707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98" x2="398" y1="198.707" y2="198.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105" y="193.9648">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="118" y="193.9648">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1ral8uz9bc0e6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="423.5" x="30" y="206.707"/><polygon fill="#EEEEEE" points="30,206.707,94,206.707,94,213.707,84,223.707,30,223.707,30,206.707" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="43" y="221.2754">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="168.75" y="240.2754">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="172.75" y="255.5859"/><path d="M23,281.6387 L124,281.6387 L124,288.6387 L114,298.6387 L23,298.6387 L23,281.6387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="229.7949" style="stroke: #000000; stroke-width: 2.0;" width="860" x="23" y="281.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="56" x="38" y="295.207">Cleanup</text><polygon fill="#A80036" points="496.5,331.5703,506.5,335.5703,496.5,339.5703,500.5,335.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98" x2="502.5" y1="335.5703" y2="335.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105" y="323.1729">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="118" y="315.5176">Cleanup Fulfilled Transfers</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="118" y="330.8281">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="195" y="330.8281">2003</text><polygon fill="#A80036" points="747.5,360.8809,757.5,364.8809,747.5,368.8809,751.5,364.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="518.5" x2="753.5" y1="364.8809" y2="364.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="525.5" y="360.1387">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="538.5" y="360.1387">Delete fuflfilled transfers records</text><polygon fill="#FFFFE0" filter="url(#f1ral8uz9bc0e6)" points="665,407.8809,863,407.8809,873,441.8809,863,476.8809,665,476.8809,655,441.8809,665,407.8809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="667" y="424.4492">DELETE et</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="667" y="439.7598">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="707" y="439.7598">expiringTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="826" y="439.7598">et</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="667" y="455.0703">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="699" y="455.0703">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="825" y="455.0703">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="667" y="470.3809">ON tf.transferId = et.transferId</text><polygon fill="#A80036" points="109,499.4336,99,503.4336,109,507.4336,105,503.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="103" x2="512.5" y1="503.4336" y2="503.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="498.6914">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="128" y="498.6914">Return success</text><path d="M23,525.4336 L148,525.4336 L148,532.4336 L138,542.4336 L23,542.4336 L23,525.4336 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="900" x="23" y="525.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="38" y="539.002">List Expired</text><polygon fill="#A80036" points="496.5,575.3652,506.5,579.3652,496.5,583.3652,500.5,579.3652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98" x2="502.5" y1="579.3652" y2="579.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105" y="566.9678">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="118" y="559.3125">Retrieve Expired Transfers</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="118" y="574.623">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="195" y="574.623">2003</text><polygon fill="#A80036" points="747.5,604.6758,757.5,608.6758,747.5,612.6758,751.5,608.6758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="518.5" x2="753.5" y1="608.6758" y2="608.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="525.5" y="603.9336">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="538.5" y="603.9336">Select using index</text><polygon fill="#FFFFE0" filter="url(#f1ral8uz9bc0e6)" points="626,621.6758,903,621.6758,913,647.6758,903,674.6758,626,674.6758,616,647.6758,626,621.6758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="628" y="638.2441">SELECT *</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="628" y="653.5547">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="668" y="653.5547">expiringTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="628" y="668.8652">WHERE expirationDate &lt; currentTimestamp</text><polygon fill="#A80036" points="529.5,697.918,519.5,701.918,529.5,705.918,525.5,701.918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523.5" x2="763.5" y1="701.918" y2="701.918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="535.5" y="697.1758">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="548.5" y="697.1758">Return expired transfers</text><polygon fill="#A80036" points="109,727.2285,99,731.2285,109,735.2285,105,731.2285" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="103" x2="512.5" y1="731.2285" y2="731.2285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="726.4863">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="128" y="726.4863">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="141" x="173" y="726.4863">expiredTransfersList</text><path d="M23,753.2285 L97,753.2285 L97,760.2285 L87,770.2285 L23,770.2285 L23,753.2285 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="508.3848" style="stroke: #000000; stroke-width: 2.0;" width="330.5" x="23" y="753.2285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="766.7969">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="765.8633">[for each transfer in the list]</text><path d="M103,800.5391 L103,1177.5391 L331,1177.5391 L331,810.5391 L321,800.5391 L103,800.5391 " fill="#FFFF00" filter="url(#f1ral8uz9bc0e6)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M321,800.5391 L321,810.5391 L331,810.5391 L321,800.5391 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="109" y="818.1074">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="833.418">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="125" y="848.7285">id: &lt;uuid&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="125" y="864.0391">from: &lt;switch&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="125" y="879.3496">to: &lt;payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="125" y="894.6602">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="125" y="909.9707">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="141" y="925.2813">headers: null,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="141" y="940.5918">payload: &lt;transfer&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="125" y="955.9023">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="125" y="971.2129">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="141" y="986.5234">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="157" y="1001.834">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="157" y="1017.1445">responseTo: null,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="157" y="1032.4551">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="157" y="1047.7656">action: timeout,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="157" y="1063.0762">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="157" y="1078.3867">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="173" y="1093.6973">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="173" y="1109.0078">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="1124.3184">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="141" y="1139.6289">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="125" y="1154.9395">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="1170.25">}</text><polygon fill="#A80036" points="258,1219.6133,268,1223.6133,258,1227.6133,262,1223.6133" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98" x2="264" y1="1223.6133" y2="1223.6133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="105" y="1211.2158">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="118" y="1203.5605">Publish Timeout event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="118" y="1218.8711">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="195" y="1218.8711">2003</text><!--
@startuml
title 2.3.1. Timeout Prepare Handler 

autonumber


control "Timeout Prepare\nHandler" as TIMEOUT_PREP_HANDLER
collections "topic-\ntransfer-timeout" as TOPIC_TRANSFER_TIMEOUT
collections "topic-event" as EVENT_TOPIC
entity "Timeout DAO" as TIMEOUT_DAO
database "Central Store" as DB

box "Central Service" #lightyellow
    participant TIMEOUT_PREP_HANDLER
    participant TOPIC_TRANSFER_TIMEOUT
    participant EVENT_TOPIC
    participant TIMEOUT_DAO
    participant DB
end box


group Timeout Prepare Handler
    activate TIMEOUT_PREP_HANDLER
    group Persist Event Information
        TIMEOUT_PREP_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_PREP_HANDLER, EVENT_TOPIC :  Event Handler Consume\n
    end

    group Cleanup
        TIMEOUT_PREP_HANDLER -> TIMEOUT_DAO: Cleanup Fulfilled Transfers\n<color #red><b>Error code:</b> 2003</color>
        activate TIMEOUT_DAO
        TIMEOUT_DAO -> DB: Delete fuflfilled transfers records
                activate DB
        deactivate DB
        hnote over DB #lightyellow
            DELETE et
            FROM **expiringTransfer** et
            JOIN **transferFulfilment** tf
            ON tf.transferId = et.transferId
        end note
        TIMEOUT_DAO - -> TIMEOUT_PREP_HANDLER: Return success
        deactivate TIMEOUT_DAO
    end

    group List Expired
        TIMEOUT_PREP_HANDLER -> TIMEOUT_DAO: Retrieve Expired Transfers\n<color #red><b>Error code:</b> 2003</color>
        activate TIMEOUT_DAO
        TIMEOUT_DAO -> DB: Select using index
        activate DB
        hnote over DB #lightyellow
            SELECT *
            FROM **expiringTransfer**
            WHERE expirationDate < currentTimestamp
        end note
        TIMEOUT_DAO <- - DB: Return expired transfers
        deactivate DB
        TIMEOUT_DAO - -> TIMEOUT_PREP_HANDLER: Return **expiredTransfersList**
        deactivate TIMEOUT_DAO
    end



    loop for each transfer in the list
        |||
        note right of TIMEOUT_PREP_HANDLER #yellow
            <color #red><b>Message:</b></color>
            {
                id: <uuid>
                from: <switch>,
                to: <payerFsp>,
                type: application/json
                content: {
                    headers: null,
                    payload: <transfer>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: null,
                        type: transfer,
                        action: timeout,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        TIMEOUT_PREP_HANDLER -> TOPIC_TRANSFER_TIMEOUT: Publish Timeout event\n<color #red><b>Error code:</b> 2003</color>
        activate TOPIC_TRANSFER_TIMEOUT
        deactivate TOPIC_TRANSFER_TIMEOUT
    end

    deactivate TIMEOUT_PREP_HANDLER
end
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>