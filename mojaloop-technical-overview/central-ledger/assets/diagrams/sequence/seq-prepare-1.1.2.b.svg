<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1557px" preserveAspectRatio="none" style="width:1891px;height:1557px;" version="1.1" viewBox="0 0 1891 1557" width="1891px" zoomAndPan="magnify"><defs><filter height="300%" id="f4jp52m1f0n5m" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="376" x="758.5" y="23.5352">1.1.2.b. Position Handler Consume (batch messages)</text><rect fill="#FFFFE0" height="1512.5039" style="stroke: #A80036; stroke-width: 1.0;" width="1808" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="872.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="109" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="1345.2168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1092" y="1419.5039"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469" y="451.3926"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469" y="687.2559"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1576.5" y="869.8086"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="480.7031"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="716.5664"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="899.1191"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="1331.2168" style="stroke: #000000; stroke-width: 2.0;" width="1867" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="870" x="399" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1481" x="389" y="388.4609"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="399" y="412.7715"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1461" x="399" y="831.1875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="114" x2="114" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="489" x2="489" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1097" x2="1097" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1214" x2="1214" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1342" x2="1342" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1474" x2="1474" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1581" x2="1581" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1775" x2="1775" y1="116.2871" y2="1481.5039"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="30" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="27" y="1480.5039"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="23" y="1484.5039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="30" y="1505.0391">topic-transfer-position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="409" y="113.334">Position Event Handler</text><ellipse cx="489" cy="83.7988" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="485,71.7988,491,66.7988,489,71.7988,491,76.7988,485,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="409" y="1494.0391">Position Event Handler</text><ellipse cx="489" cy="1512.9922" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="485,1500.9922,491,1495.9922,489,1500.9922,491,1505.9922,485,1500.9922" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1038" y="76.7988"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1034" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1041" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1038" y="1480.5039"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1034" y="1484.5039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1041" y="1505.0391">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1170" y="113.334">Event-Topic</text><ellipse cx="1214.5" cy="83.7988" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1202.5" x2="1226.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1170" y="1494.0391">Event-Topic</text><ellipse cx="1214.5" cy="1512.9922" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1202.5" x2="1226.5" y1="1526.9922" y2="1526.9922"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1273" y="76.7988"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1269" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1276" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1273" y="1480.5039"/><rect fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1269" y="1484.5039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1276" y="1505.0391">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1426" y="113.334">Position DAO</text><ellipse cx="1474" cy="83.7988" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1462" x2="1486" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1426" y="1494.0391">Position DAO</text><ellipse cx="1474" cy="1512.9922" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1462" x2="1486" y1="1526.9922" y2="1526.9922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1532" y="113.334">Transfer DAO</text><ellipse cx="1581.5" cy="83.7988" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1569.5" x2="1593.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1532" y="1494.0391">Transfer DAO</text><ellipse cx="1581.5" cy="1512.9922" fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1569.5" x2="1593.5" y1="1526.9922" y2="1526.9922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1727" y="113.334">Central Store</text><path d="M1757,63.7988 C1757,53.7988 1775,53.7988 1775,53.7988 C1775,53.7988 1793,53.7988 1793,63.7988 L1793,89.7988 C1793,99.7988 1775,99.7988 1775,99.7988 C1775,99.7988 1757,99.7988 1757,89.7988 L1757,63.7988 " fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1757,63.7988 C1757,73.7988 1775,73.7988 1775,73.7988 C1775,73.7988 1793,73.7988 1793,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1727" y="1494.0391">Central Store</text><path d="M1757,1506.9922 C1757,1496.9922 1775,1496.9922 1775,1496.9922 C1775,1496.9922 1793,1496.9922 1793,1506.9922 L1793,1532.9922 C1793,1542.9922 1775,1542.9922 1775,1542.9922 C1775,1542.9922 1757,1542.9922 1757,1532.9922 L1757,1506.9922 " fill="#FEFECE" filter="url(#f4jp52m1f0n5m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1757,1506.9922 C1757,1516.9922 1775,1516.9922 1775,1516.9922 C1775,1516.9922 1793,1516.9922 1793,1506.9922 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="109" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="1345.2168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1092" y="1419.5039"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469" y="451.3926"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469" y="687.2559"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1576.5" y="869.8086"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="480.7031"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="716.5664"/><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1770" y="899.1191"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1331.2168" style="stroke: #000000; stroke-width: 2.0;" width="1867" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="130,167.9082,120,171.9082,130,175.9082,126,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="124" x2="483" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="136" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="149" y="167.166">Consume Position event batch of messages for Payer</text><path d="M399,216.9082 L614,216.9082 L614,223.9082 L604,233.9082 L399,233.9082 L399,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="870" x="399" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="414" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1202.5,276.5293,1212.5,280.5293,1202.5,284.5293,1206.5,280.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="1208.5" y1="280.5293" y2="280.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="501" y="275.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="514" y="275.7871">Publish event information</text><rect fill="#FFFFFF" filter="url(#f4jp52m1f0n5m)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="852" x="406" y="288.5293"/><polygon fill="#EEEEEE" points="406,288.5293,470,288.5293,470,295.5293,460,305.5293,406,305.5293,406,288.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="419" y="303.0977">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="759" y="322.0977">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="763" y="337.4082"/><path d="M389,388.4609 L463,388.4609 L463,395.4609 L453,405.4609 L389,405.4609 L389,388.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1481" x="389" y="388.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="404" y="402.0293">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="478" y="401.0957">[for each message in batch]</text><path d="M399,412.7715 L698,412.7715 L698,419.7715 L688,429.7715 L399,429.7715 L399,412.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="399" y="412.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="414" y="426.3398">Calculate position and persist change</text><polygon fill="#A80036" points="1457,447.3926,1467,451.3926,1457,455.3926,1461,451.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="1463" y1="451.3926" y2="451.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="501" y="446.6504">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="514" y="446.6504">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1758,476.7031,1768,480.7031,1758,484.7031,1762,480.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479" x2="1764" y1="480.7031" y2="480.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1486" y="475.9609">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1499" y="475.9609">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f4jp52m1f0n5m)" points="1723,523.7031,1827,523.7031,1837,534.7031,1827,546.7031,1723,546.7031,1713,534.7031,1723,523.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1725" y="540.2715">transferPosition</text><polygon fill="#A80036" points="505,569.3242,495,573.3242,505,577.3242,501,573.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="499" x2="1473" y1="573.3242" y2="573.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="511" y="568.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="524" y="568.582">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="536" y1="602.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="536" x2="536" y1="602.6348" y2="615.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="495" x2="536" y1="615.6348" y2="615.6348"/><polygon fill="#A80036" points="505,611.6348,495,615.6348,505,619.6348,501,615.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="501" y="597.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="514" y="597.8926">Calculate latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="536" y1="644.9453" y2="644.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="536" x2="536" y1="644.9453" y2="657.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="495" x2="536" y1="657.9453" y2="657.9453"/><polygon fill="#A80036" points="505,653.9453,495,657.9453,505,661.9453,501,657.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="501" y="640.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="514" y="640.2031">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1457,683.2559,1467,687.2559,1457,691.2559,1461,687.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="1463" y1="687.2559" y2="687.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="501" y="682.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="514" y="682.5137">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1758,712.5664,1768,716.5664,1758,720.5664,1762,716.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479" x2="1764" y1="716.5664" y2="716.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1486" y="711.8242">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1499" y="711.8242">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f4jp52m1f0n5m)" points="1723,759.5664,1827,759.5664,1837,770.5664,1827,782.5664,1723,782.5664,1713,770.5664,1723,759.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1725" y="776.1348">transferPosition</text><polygon fill="#A80036" points="505,805.1875,495,809.1875,505,813.1875,501,809.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="499" x2="1473" y1="809.1875" y2="809.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="511" y="804.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="533" y="804.4453">Return success</text><path d="M399,831.1875 L963,831.1875 L963,838.1875 L953,848.1875 L399,848.1875 L399,831.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1461" x="399" y="831.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="414" y="844.7559">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1564.5,865.8086,1574.5,869.8086,1564.5,873.8086,1568.5,869.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="1570.5" y1="869.8086" y2="869.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="501" y="865.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="523" y="865.0664">Request to persist batch transfer</text><polygon fill="#A80036" points="1758,895.1191,1768,899.1191,1758,903.1191,1762,899.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1586.5" x2="1764" y1="899.1191" y2="899.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1593.5" y="894.377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1615.5" y="894.377">Persist batch transfer</text><polygon fill="#FFFFE0" filter="url(#f4jp52m1f0n5m)" points="1709,942.1191,1840,942.1191,1850,953.1191,1840,965.1191,1709,965.1191,1699,953.1191,1709,942.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1711" y="958.6875">transferStateChange</text><polygon fill="#A80036" points="505,987.7402,495,991.7402,505,995.7402,501,991.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="499" x2="1580.5" y1="991.7402" y2="991.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="511" y="986.998">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="533" y="986.998">Return success</text><path d="M499,1011.7402 L499,1388.7402 L761,1388.7402 L761,1021.7402 L751,1011.7402 L499,1011.7402 " fill="#FFFF00" filter="url(#f4jp52m1f0n5m)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M751,1011.7402 L751,1021.7402 L761,1021.7402 L751,1011.7402 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="505" y="1029.3086">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="505" y="1044.6191">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="521" y="1059.9297">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="521" y="1075.2402">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="521" y="1090.5508">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="521" y="1105.8613">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="521" y="1121.1719">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="537" y="1136.4824">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="537" y="1151.793">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="521" y="1167.1035">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="521" y="1182.4141">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="537" y="1197.7246">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="553" y="1213.0352">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="553" y="1228.3457">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="553" y="1243.6563">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="553" y="1258.9668">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="553" y="1274.2773">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="553" y="1289.5879">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="569" y="1304.8984">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="569" y="1320.209">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="553" y="1335.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="537" y="1350.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="521" y="1366.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="505" y="1381.4512">}</text><polygon fill="#A80036" points="1080,1415.5039,1090,1419.5039,1080,1423.5039,1084,1419.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494" x2="1086" y1="1419.5039" y2="1419.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="501" y="1414.7617">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="523" y="1414.7617">Publish Transfer event</text><!--
@startuml
title 1.1.2.b. Position Handler Consume (batch messages)

autonumber


collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_POSITION
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_TRANSFER_POSITION <- POS_HANDLER: Consume Position event batch of messages for Payer
    activate TOPIC_TRANSFER_POSITION
    deactivate TOPIC_TRANSFER_POSITION

    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS : Event Handler Consume\n
        |||
    end

    loop for each message in batch
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) by incrementing transfer for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist batch transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist batch transfer
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>