<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3817px" preserveAspectRatio="none" style="width:1759px;height:3817px;" version="1.1" viewBox="0 0 1759 3817" width="1759px" zoomAndPan="magnify"><defs><filter height="300%" id="foey90h6opg4k" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="739.5" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3772.4238" style="stroke: #A80036; stroke-width: 1.0;" width="1635.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="796.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="75.5" y="198.707"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="3600.1602" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="886.5" y="2938.0879"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="886.5" y="3601.6699"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1150" y="2487.3242"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1120.3125"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1450.0391"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1684.834"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1922.3184"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="3051.9746"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1149.623"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1479.3496"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1714.1445"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1951.6289"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="3081.2852"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="3586.1602" style="stroke: #000000; stroke-width: 2.0;" width="1735" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="3554.8496" style="stroke: #000000; stroke-width: 2.0;" width="1715" x="23" y="160.0859"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="484.5" x="313" y="243.707"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="464.5" x="323" y="268.0176"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="759.5" x="323" y="363.9492"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1347.5" x="323" y="535.502"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="2942.3047" style="stroke: #000000; stroke-width: 2.0;" width="1435" x="293" y="711.3652"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="1044.5" x="313" y="735.6758"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="1024.5" x="323" y="802.2969"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="1024.5" x="323" y="934.8496"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1435" x="293" y="990.1602"/><rect fill="#FFFFFF" height="2609.2441" style="stroke: none; stroke-width: 1.0;" width="1435" x="293" y="1044.4258"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="2580.2891" style="stroke: #000000; stroke-width: 2.0;" width="1415" x="303" y="1066.3809"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1389" x="313" y="1371.7969"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1369" x="323" y="1396.1074"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1368" x="323" y="1630.9023"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="1795.5938" style="stroke: #000000; stroke-width: 2.0;" width="1395" x="313" y="1844.0762"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1375" x="323" y="1868.3867"/><rect fill="#FFFFFF" height="663.582" style="stroke: none; stroke-width: 1.0;" width="1395" x="313" y="2976.0879"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1375" x="323" y="2998.043"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1715" x="23" y="3660.6699"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="80" x2="80" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="373" x2="373" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="891.5" x2="891.5" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1021.5" x2="1021.5" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1154.5" x2="1154.5" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1287.5" x2="1287.5" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1395.5" x2="1395.5" y1="118.7754" y2="3738.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1612.5" x2="1612.5" y1="118.7754" y2="3738.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="37" y="79.2871"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="33" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="40" y="103.8223">topic-fulfil</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="37" y="3737.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="33" y="3741.9355"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="40" y="3762.4707">topic-fulfil</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="333" y="99.334">Fulfil Event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="343.5" y="115.8223">Handler</text><ellipse cx="373.5" cy="69.7988" fill="#FEFECE" filter="url(#foey90h6opg4k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="369.5,57.7988,375.5,52.7988,373.5,57.7988,375.5,62.7988,369.5,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="333" y="3751.4707">Fulfil Event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="343.5" y="3767.959">Handler</text><ellipse cx="373.5" cy="3786.9121" fill="#FEFECE" filter="url(#foey90h6opg4k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="369.5,3774.9121,375.5,3769.9121,373.5,3774.9121,375.5,3779.9121,369.5,3774.9121" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="825.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="821.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="866.5" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="828.5" y="103.8223">transfer-position</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="825.5" y="3737.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="821.5" y="3741.9355"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="866.5" y="3762.4707">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="828.5" y="3778.959">transfer-position</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="975.5" y="79.2871"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="971.5" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="978.5" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="975.5" y="3737.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="971.5" y="3741.9355"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="978.5" y="3762.4707">topic-event</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1086.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1082.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1130" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="1089.5" y="103.8223">settlement-model</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1086.5" y="3737.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1082.5" y="3741.9355"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1130" y="3762.4707">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="1089.5" y="3778.959">settlement-model</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1241.5" y="62.7988"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1237.5" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1262.5" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1244.5" y="103.8223">notification</text><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1241.5" y="3737.9355"/><rect fill="#FEFECE" filter="url(#foey90h6opg4k)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1237.5" y="3741.9355"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1262.5" y="3762.4707">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1244.5" y="3778.959">notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1347.5" y="115.8223">Position DAO</text><ellipse cx="1395.5" cy="86.2871" fill="#FEFECE" filter="url(#foey90h6opg4k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1383.5" x2="1407.5" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1347.5" y="3751.4707">Position DAO</text><ellipse cx="1395.5" cy="3770.4238" fill="#FEFECE" filter="url(#foey90h6opg4k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1383.5" x2="1407.5" y1="3784.4238" y2="3784.4238"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1564.5" y="115.8223">Central Store</text><path d="M1594.5,66.2871 C1594.5,56.2871 1612.5,56.2871 1612.5,56.2871 C1612.5,56.2871 1630.5,56.2871 1630.5,66.2871 L1630.5,92.2871 C1630.5,102.2871 1612.5,102.2871 1612.5,102.2871 C1612.5,102.2871 1594.5,102.2871 1594.5,92.2871 L1594.5,66.2871 " fill="#FEFECE" filter="url(#foey90h6opg4k)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1594.5,66.2871 C1594.5,76.2871 1612.5,76.2871 1612.5,76.2871 C1612.5,76.2871 1630.5,76.2871 1630.5,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1564.5" y="3751.4707">Central Store</text><path d="M1594.5,3764.4238 C1594.5,3754.4238 1612.5,3754.4238 1612.5,3754.4238 C1612.5,3754.4238 1630.5,3754.4238 1630.5,3764.4238 L1630.5,3790.4238 C1630.5,3800.4238 1612.5,3800.4238 1612.5,3800.4238 C1612.5,3800.4238 1594.5,3800.4238 1594.5,3790.4238 L1594.5,3764.4238 " fill="#FEFECE" filter="url(#foey90h6opg4k)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1594.5,3764.4238 C1594.5,3774.4238 1612.5,3774.4238 1612.5,3774.4238 C1612.5,3774.4238 1630.5,3774.4238 1630.5,3764.4238 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="75.5" y="198.707"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="3600.1602" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="886.5" y="2938.0879"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="886.5" y="3601.6699"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1150" y="2487.3242"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1120.3125"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1450.0391"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1684.834"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="1922.3184"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1390.5" y="3051.9746"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1149.623"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1479.3496"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1714.1445"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="1951.6289"/><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1607.5" y="3081.2852"/><path d="M13,135.7754 L282,135.7754 L282,142.7754 L272,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3586.1602" style="stroke: #000000; stroke-width: 2.0;" width="1735" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="149.3438">Fulfil Handler Consume (Success)</text><path d="M23,160.0859 L85,160.0859 L85,167.0859 L75,177.0859 L23,177.0859 L23,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3554.8496" style="stroke: #000000; stroke-width: 2.0;" width="1715" x="23" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="173.6543">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="172.7207">[Consume Single Message]</text><polygon fill="#A80036" points="96.5,194.707,86.5,198.707,96.5,202.707,92.5,198.707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90.5" x2="367.5" y1="198.707" y2="198.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="102.5" y="193.9648">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="115.5" y="193.9648">Consume Fulfil event message for Payer</text><path d="M313,243.707 L397,243.707 L397,250.707 L387,260.707 L313,260.707 L313,243.707 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="484.5" x="313" y="243.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="328" y="257.2754">break</text><path d="M323,268.0176 L465,268.0176 L465,275.0176 L455,285.0176 L323,285.0176 L323,268.0176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="464.5" x="323" y="268.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="338" y="281.5859">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="321.9492" y2="321.9492"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="321.9492" y2="334.9492"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="334.9492" y2="334.9492"/><polygon fill="#A80036" points="389.5,330.9492,379.5,334.9492,389.5,338.9492,385.5,334.9492" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="309.5518">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="398.5" y="301.8965">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="398.5" y="317.207">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="482.5" y="317.207">2001</text><path d="M323,363.9492 L538,363.9492 L538,370.9492 L528,380.9492 L323,380.9492 L323,363.9492 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="759.5" x="323" y="363.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="338" y="377.5176">Persist Event Information</text><polygon fill="#A80036" points="1010,423.5703,1020,427.5703,1010,431.5703,1014,427.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1016" y1="427.5703" y2="427.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="422.8281">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="398.5" y="422.8281">Publish event information</text><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="741.5" x="330" y="435.5703"/><polygon fill="#EEEEEE" points="330,435.5703,394,435.5703,394,442.5703,384,452.5703,330,452.5703,330,435.5703" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="343" y="450.1387">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="627.75" y="469.1387">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="631.75" y="484.4492"/><path d="M323,535.502 L536,535.502 L536,542.502 L526,552.502 L323,552.502 L323,535.502 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1347.5" x="323" y="535.502"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="338" y="549.0703">Validate Duplicate Check</text><polygon fill="#A80036" points="1600.5,595.123,1610.5,599.123,1600.5,603.123,1604.5,599.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1606.5" y1="599.123" y2="599.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="594.3809">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="398.5" y="594.3809">Request Duplicate Check</text><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1329.5" x="330" y="607.123"/><polygon fill="#EEEEEE" points="330,607.123,394,607.123,394,614.123,384,624.123,330,624.123,330,607.123" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="343" y="621.6914">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="918.25" y="640.6914">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="922.25" y="656.002"/><polygon fill="#A80036" points="389.5,685.3652,379.5,689.3652,389.5,693.3652,385.5,689.3652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1611.5" y1="689.3652" y2="689.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="395.5" y="684.623">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="408.5" y="684.623">Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }</text><path d="M293,711.3652 L355,711.3652 L355,718.3652 L345,728.3652 L293,728.3652 L293,711.3652 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2942.3047" style="stroke: #000000; stroke-width: 2.0;" width="1435" x="293" y="711.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="308" y="724.9336">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="370" y="724">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M313,735.6758 L397,735.6758 L397,742.6758 L387,752.6758 L313,752.6758 L313,735.6758 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="1044.5" x="313" y="735.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="328" y="749.2441">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="774.2969" y2="774.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="774.2969" y2="787.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="787.2969" y2="787.2969"/><polygon fill="#A80036" points="389.5,783.2969,379.5,787.2969,389.5,791.2969,385.5,787.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="769.5547">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="398.5" y="769.5547">stateRecord = await getTransferState(transferId)</text><path d="M323,802.2969 L385,802.2969 L385,809.2969 L375,819.2969 L323,819.2969 L323,802.2969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="1024.5" x="323" y="802.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="338" y="815.8652">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="400" y="814.9316">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#foey90h6opg4k)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1006.5" x="330" y="844.6074"/><polygon fill="#EEEEEE" points="330,844.6074,394,844.6074,394,851.6074,384,861.6074,330,861.6074,330,844.6074" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="343" y="859.1758">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="771.25" y="878.1758">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="775.25" y="893.4863"/><polygon fill="#A80036" points="1275.5,922.8496,1285.5,926.8496,1275.5,930.8496,1279.5,926.8496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1281.5" y1="926.8496" y2="926.8496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="922.1074">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="398.5" y="922.1074">Produce message</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="323" x2="1347.5" y1="935.8496" y2="935.8496"/><path d="M383,941.8496 L383,966.8496 L577,966.8496 L577,951.8496 L567,941.8496 L383,941.8496 " fill="#D3D3D3" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M567,941.8496 L567,951.8496 L577,951.8496 L567,941.8496 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="389" y="959.418">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="293" x2="1728" y1="991.1602" y2="991.1602"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="298" y="1001.7949">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M383,1010.1152 L383,1035.1152 L737,1035.1152 L737,1020.1152 L727,1010.1152 L383,1010.1152 " fill="#D3D3D3" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M727,1010.1152 L727,1020.1152 L737,1020.1152 L727,1010.1152 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="389" y="1027.6836">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="293" x2="1728" y1="1045.4258" y2="1045.4258"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="298" y="1056.0605">[hasDuplicateId == FALSE]</text><path d="M303,1066.3809 L617,1066.3809 L617,1073.3809 L607,1083.3809 L303,1083.3809 L303,1066.3809 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2580.2891" style="stroke: #000000; stroke-width: 2.0;" width="1415" x="303" y="1066.3809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="318" y="1079.9492">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1378.5,1116.3125,1388.5,1120.3125,1378.5,1124.3125,1382.5,1120.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1384.5" y1="1120.3125" y2="1120.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="385.5" y="1107.915">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="398.5" y="1100.2598">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="398.5" y="1115.5703">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="475.5" y="1115.5703">2003</text><polygon fill="#A80036" points="1595.5,1145.623,1605.5,1149.623,1595.5,1153.623,1599.5,1149.623" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1400.5" x2="1601.5" y1="1149.623" y2="1149.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1407.5" y="1144.8809">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1420.5" y="1144.8809">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#foey90h6opg4k)" points="1586,1162.623,1639,1162.623,1649,1173.623,1639,1185.623,1586,1185.623,1576,1173.623,1586,1162.623" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1588" y="1179.1914">transfer</text><polygon fill="#A80036" points="1411.5,1208.2441,1401.5,1212.2441,1411.5,1216.2441,1407.5,1212.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1405.5" x2="1611.5" y1="1212.2441" y2="1212.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1417.5" y="1207.502">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1443.5" y="1207.502"/><polygon fill="#A80036" points="389.5,1237.5547,379.5,1241.5547,389.5,1245.5547,385.5,1241.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1394.5" y1="1241.5547" y2="1241.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1236.8125">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="417.5" y="1236.8125">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="1286.1758" y2="1286.1758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="1286.1758" y2="1299.1758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="1299.1758" y2="1299.1758"/><polygon fill="#A80036" points="389.5,1295.1758,379.5,1299.1758,389.5,1303.1758,385.5,1299.1758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1273.7783">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="407.5" y="1266.123">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="1281.4336">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="1281.4336">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="1343.7969" y2="1343.7969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="1343.7969" y2="1356.7969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="1356.7969" y2="1356.7969"/><polygon fill="#A80036" points="389.5,1352.7969,379.5,1356.7969,389.5,1360.7969,385.5,1356.7969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1331.3994">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="407.5" y="1323.7441">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="1339.0547">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="1339.0547">3303</text><path d="M313,1371.7969 L380,1371.7969 L380,1378.7969 L370,1388.7969 L313,1388.7969 L313,1371.7969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1389" x="313" y="1371.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="328" y="1385.3652">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="395" y="1384.4316">[Transfer.ilpCondition validate successful]</text><path d="M323,1396.1074 L610,1396.1074 L610,1403.1074 L600,1413.1074 L323,1413.1074 L323,1396.1074 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1369" x="323" y="1396.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="338" y="1409.6758">Request current Settlement Window</text><polygon fill="#A80036" points="1378.5,1446.0391,1388.5,1450.0391,1378.5,1454.0391,1382.5,1450.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1384.5" y1="1450.0391" y2="1450.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1437.6416">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="407.5" y="1429.9863">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="1445.2969">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="1445.2969">2003</text><polygon fill="#A80036" points="1595.5,1475.3496,1605.5,1479.3496,1595.5,1483.3496,1599.5,1479.3496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1400.5" x2="1601.5" y1="1479.3496" y2="1479.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1407.5" y="1474.6074">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1429.5" y="1474.6074">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#foey90h6opg4k)" points="1552,1492.3496,1672,1492.3496,1682,1503.3496,1672,1515.3496,1552,1515.3496,1542,1503.3496,1552,1492.3496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1554" y="1508.918">settlementWindow</text><polygon fill="#A80036" points="1411.5,1537.9707,1401.5,1541.9707,1411.5,1545.9707,1407.5,1541.9707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1405.5" x2="1611.5" y1="1541.9707" y2="1541.9707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1417.5" y="1537.2285">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1443.5" y="1537.2285"/><polygon fill="#A80036" points="389.5,1597.9023,379.5,1601.9023,389.5,1605.9023,385.5,1601.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1394.5" y1="1601.9023" y2="1601.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1581.8496">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="417.5" y="1566.5391">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="417.5" y="1581.8496">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="458.5" y="1581.8496">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="417.5" y="1597.1602">state are updated to the next settlement window</text><path d="M323,1630.9023 L483,1630.9023 L483,1637.9023 L473,1647.9023 L323,1647.9023 L323,1630.9023 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1368" x="323" y="1630.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="338" y="1644.4707">Persist fulfilment</text><polygon fill="#A80036" points="1378.5,1680.834,1388.5,1684.834,1378.5,1688.834,1382.5,1684.834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1384.5" y1="1684.834" y2="1684.834"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1672.4365">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="407.5" y="1664.7813">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="1680.0918">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="1680.0918">2003</text><polygon fill="#A80036" points="1595.5,1710.1445,1605.5,1714.1445,1595.5,1718.1445,1599.5,1714.1445" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1400.5" x2="1601.5" y1="1714.1445" y2="1714.1445"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1407.5" y="1709.4023">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1429.5" y="1709.4023">Persist to database</text><polygon fill="#FFFFE0" filter="url(#foey90h6opg4k)" points="1554,1757.1445,1671,1757.1445,1681,1776.1445,1671,1795.1445,1554,1795.1445,1544,1776.1445,1554,1757.1445" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1556" y="1773.7129">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1556" y="1789.0234">transferExtension</text><polygon fill="#A80036" points="389.5,1818.0762,379.5,1822.0762,389.5,1826.0762,385.5,1822.0762" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1394.5" y1="1822.0762" y2="1822.0762"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1817.334">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="417.5" y="1817.334">Return success</text><path d="M313,1844.0762 L375,1844.0762 L375,1851.0762 L365,1861.0762 L313,1861.0762 L313,1844.0762 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1795.5938" style="stroke: #000000; stroke-width: 2.0;" width="1395" x="313" y="1844.0762"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="328" y="1857.6445">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="390" y="1856.7109">[Transfer.ilpCondition validate successful]</text><path d="M323,1868.3867 L779,1868.3867 L779,1875.3867 L769,1885.3867 L323,1885.3867 L323,1868.3867 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1375" x="323" y="1868.3867"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="338" y="1881.9551">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1378.5,1918.3184,1388.5,1922.3184,1378.5,1926.3184,1382.5,1922.3184" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1384.5" y1="1922.3184" y2="1922.3184"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1909.9209">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="407.5" y="1902.2656">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="1917.5762">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="1917.5762">2003</text><polygon fill="#A80036" points="1595.5,1947.6289,1605.5,1951.6289,1595.5,1955.6289,1599.5,1951.6289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1400.5" x2="1601.5" y1="1951.6289" y2="1951.6289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1407.5" y="1946.8867">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1429.5" y="1946.8867">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#foey90h6opg4k)" points="1547,1994.6289,1678,1994.6289,1688,2005.6289,1678,2017.6289,1547,2017.6289,1537,2005.6289,1547,1994.6289" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1549" y="2011.1973">transferStateChange</text><polygon fill="#A80036" points="389.5,2040.25,379.5,2044.25,389.5,2048.25,385.5,2044.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1394.5" y1="2044.25" y2="2044.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="2039.5078">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="417.5" y="2039.5078">Return success</text><path d="M383,2064.25 L383,2456.25 L643,2456.25 L643,2074.25 L633,2064.25 L383,2064.25 " fill="#FFFF00" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M633,2064.25 L633,2074.25 L643,2074.25 L633,2064.25 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="389" y="2081.8184">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="2097.1289">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="405" y="2112.4395">id: &lt;id&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="405" y="2127.75">from: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="405" y="2143.0605">to: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="405" y="2158.3711">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="405" y="2173.6816">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="421" y="2188.9922">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="437" y="2204.3027">transferId: {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="421" y="2219.6133">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="405" y="2234.9238">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="405" y="2250.2344">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="421" y="2265.5449">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="437" y="2280.8555">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="437" y="2296.166">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="437" y="2311.4766">type: setmodel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="437" y="2326.7871">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="437" y="2342.0977">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="437" y="2357.4082">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="453" y="2372.7188">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="453" y="2388.0293">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="437" y="2403.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="421" y="2418.6504">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="405" y="2433.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="2449.2715">}</text><polygon fill="#A80036" points="1138,2483.3242,1148,2487.3242,1138,2491.3242,1142,2487.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1144" y1="2487.3242" y2="2487.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="2482.582">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="407.5" y="2482.582">Route &amp; Publish settlement model event</text><path d="M383,2530.3242 L383,2907.3242 L692,2907.3242 L692,2540.3242 L682,2530.3242 L383,2530.3242 " fill="#FFFF00" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,2530.3242 L682,2540.3242 L692,2540.3242 L682,2530.3242 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="389" y="2547.8926">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="2563.2031">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="405" y="2578.5137">id: &lt;id&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="405" y="2593.8242">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="405" y="2609.1348">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="405" y="2624.4453">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="405" y="2639.7559">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="421" y="2655.0664">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="421" y="2670.377">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="405" y="2685.6875">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="405" y="2700.998">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="421" y="2716.3086">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="437" y="2731.6191">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="437" y="2746.9297">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="437" y="2762.2402">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="437" y="2777.5508">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="437" y="2792.8613">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="437" y="2808.1719">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="453" y="2823.4824">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="453" y="2838.793">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="437" y="2854.1035">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="421" y="2869.4141">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="405" y="2884.7246">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="2900.0352">}</text><polygon fill="#A80036" points="874.5,2934.0879,884.5,2938.0879,874.5,2942.0879,878.5,2938.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="880.5" y1="2938.0879" y2="2938.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="2933.3457">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="407.5" y="2933.3457">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="313" x2="1708" y1="2977.0879" y2="2977.0879"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="318" y="2987.7227">[Validate Fulfil Transfer not successful]</text><path d="M323,2998.043 L727,2998.043 L727,3005.043 L717,3015.043 L323,3015.043 L323,2998.043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1375" x="323" y="2998.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="338" y="3011.6113">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1378.5,3047.9746,1388.5,3051.9746,1378.5,3055.9746,1382.5,3051.9746" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="1384.5" y1="3051.9746" y2="3051.9746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="3039.5771">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="407.5" y="3031.9219">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="407.5" y="3047.2324">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="484.5" y="3047.2324">2003</text><polygon fill="#A80036" points="1595.5,3077.2852,1605.5,3081.2852,1595.5,3085.2852,1599.5,3081.2852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1400.5" x2="1601.5" y1="3081.2852" y2="3081.2852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1407.5" y="3076.543">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1429.5" y="3076.543">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#foey90h6opg4k)" points="1547,3124.2852,1678,3124.2852,1688,3135.2852,1678,3147.2852,1547,3147.2852,1537,3135.2852,1547,3124.2852" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1549" y="3140.8535">transferStateChange</text><polygon fill="#A80036" points="389.5,3169.9063,379.5,3173.9063,389.5,3177.9063,385.5,3173.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383.5" x2="1394.5" y1="3173.9063" y2="3173.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="3169.1641">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="417.5" y="3169.1641">Return success</text><path d="M383,3193.9063 L383,3570.9063 L692,3570.9063 L692,3203.9063 L682,3193.9063 L383,3193.9063 " fill="#FFFF00" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,3193.9063 L682,3203.9063 L692,3203.9063 L682,3193.9063 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="389" y="3211.4746">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="3226.7852">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="405" y="3242.0957">id: &lt;id&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="405" y="3257.4063">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="405" y="3272.7168">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="405" y="3288.0273">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="405" y="3303.3379">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="421" y="3318.6484">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="421" y="3333.959">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="405" y="3349.2695">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="405" y="3364.5801">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="421" y="3379.8906">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="437" y="3395.2012">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="437" y="3410.5117">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="437" y="3425.8223">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="437" y="3441.1328">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="437" y="3456.4434">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="437" y="3471.7539">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="453" y="3487.0645">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="453" y="3502.375">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="437" y="3517.6855">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="421" y="3532.9961">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="405" y="3548.3066">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="3563.6172">}</text><polygon fill="#A80036" points="874.5,3597.6699,884.5,3601.6699,874.5,3605.6699,878.5,3601.6699" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="880.5" y1="3601.6699" y2="3601.6699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="3596.9277">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="407.5" y="3596.9277">Route &amp; Publish Position event for Payer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1738" y1="3661.6699" y2="3661.6699"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="3672.3047">[Consume Batch Messages]</text><path d="M145,3680.625 L145,3705.625 L359,3705.625 L359,3690.625 L349,3680.625 L145,3680.625 " fill="#ADD8E6" filter="url(#foey90h6opg4k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M349,3680.625 L349,3690.625 L359,3690.625 L349,3680.625 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="151" y="3698.1934">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "topic-fulfil" as TOPIC_FULFIL
control "Fulfil Event\nHandler" as FULF_HANDLER
collections "topic-event" as TOPIC_EVENT
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nsettlement-model" as TOPIC_SETMODEL
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS

entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_SETMODEL
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            |||
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume\n
            |||
        end

        group Validate Duplicate Check
            |||
            FULF_HANDLER -> DB: Request Duplicate Check
            ref over FULF_HANDLER, DB:  Request Duplicate Check\n
            DB - -> FULF_HANDLER: Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }
        end

        alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
            break
                FULF_HANDLER -> FULF_HANDLER: stateRecord = await getTransferState(transferId)
                alt endStateList.includes(stateRecord.transferStateId)
                    |||
                    ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Produce message
                else
                    note right of FULF_HANDLER #lightgrey
                        Ignore - resend in progress
                    end note
                end
            end
        else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
            note right of FULF_HANDLER #lightgrey
                Validate Prepare Transfer (failure) - Modified Request
            end note
        else hasDuplicateId == FALSE
            group Validate and persist Transfer Fulfilment
                FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Fetch from database
                activate DB
                hnote over DB #lightyellow
                    transfer
                end note
                DB - -> POS_DAO
                deactivate DB
                FULF_HANDLER <- - POS_DAO: Return transfer
                deactivate POS_DAO
                FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
                FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

                opt Transfer.ilpCondition validate successful
                    group Request current Settlement Window
                        FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Fetch settlementWindowId
                        activate DB
                        hnote over DB #lightyellow
                            settlementWindow
                        end note
                        DB - -> POS_DAO
                        deactivate DB
                        FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                        deactivate POS_DAO
                    end
                end

                group Persist fulfilment
                    FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist to database
                    activate DB
                    deactivate DB
                    hnote over DB #lightyellow
                        transferFulfilment
                        transferExtension
                    end note
                    FULF_HANDLER <- - POS_DAO: Return success
                    deactivate POS_DAO
                end

                alt Transfer.ilpCondition validate successful
                    group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <id>,
                            from: switch,
                            to: switch,
                            type: application/json
                            content: {
                                payload: {
                                    transferId: {id}
                                }
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: setmodel,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_SETMODEL: Route & Publish settlement model event
                    activate TOPIC_SETMODEL
                    deactivate TOPIC_SETMODEL

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <id>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                else Validate Fulfil Transfer not successful
                    group Persist Transfer State (with transferState='ABORTED')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <id>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: abort,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "error",
                                        code: 1
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>