<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3328px" preserveAspectRatio="none" style="width:1670px;height:3328px;" version="1.1" viewBox="0 0 1670 3328" width="1670px" zoomAndPan="magnify"><defs><filter height="300%" id="fo7lhklh4b9ti" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="695" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3282.6152" style="stroke: #A80036; stroke-width: 1.0;" width="1547" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="752" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="3115.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="881" y="2450.7676"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="881" y="3114.3496"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1099.0664"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1428.793"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1663.5879"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1901.0723"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="2564.6543"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1128.377"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1458.1035"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1692.8984"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1930.3828"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="2593.9648"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="3101.3281" style="stroke: #000000; stroke-width: 2.0;" width="1646" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="3070.0176" style="stroke: #000000; stroke-width: 2.0;" width="1626" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="804.5" x="297.5" y="361.4609"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="961.5" x="297.5" y="467.7031"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="2443.9199" style="stroke: #000000; stroke-width: 2.0;" width="1371.5" x="267.5" y="722.4297"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="215.1738" style="stroke: #000000; stroke-width: 2.0;" width="981.5" x="287.5" y="746.7402"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="144.5527" style="stroke: #000000; stroke-width: 2.0;" width="961.5" x="297.5" y="810.3613"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="961.5" x="297.5" y="913.6035"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1371.5" x="267.5" y="968.9141"/><rect fill="#FFFFFF" height="2143.1699" style="stroke: none; stroke-width: 1.0;" width="1371.5" x="267.5" y="1023.1797"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="2114.2148" style="stroke: #000000; stroke-width: 2.0;" width="1351.5" x="277.5" y="1045.1348"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1326.5" x="287.5" y="1350.5508"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1306.5" x="297.5" y="1374.8613"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1304.5" x="297.5" y="1609.6563"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="1329.5195" style="stroke: #000000; stroke-width: 2.0;" width="1331.5" x="287.5" y="1822.8301"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1311.5" x="297.5" y="1847.1406"/><rect fill="#FFFFFF" height="663.582" style="stroke: none; stroke-width: 1.0;" width="1331.5" x="287.5" y="2488.7676"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1311.5" x="297.5" y="2510.7227"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1626" x="23" y="3173.3496"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="886" x2="886" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1039" x2="1039" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1175" x2="1175" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1307" x2="1307" y1="116.2871" y2="3251.6152"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1524" x2="1524" y1="116.2871" y2="3251.6152"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="3250.6152"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="3254.6152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="3275.1504">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="113.334">Fulfil Event Handler</text><ellipse cx="377" cy="83.7988" fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,71.7988,379,66.7988,377,71.7988,379,76.7988,373,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="3264.1504">Fulfil Event Handler</text><ellipse cx="377" cy="3283.1035" fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,3271.1035,379,3266.1035,377,3271.1035,379,3276.1035,373,3271.1035" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="799" y="76.7988"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="795" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="802" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="799" y="3250.6152"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="795" y="3254.6152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="802" y="3275.1504">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="991" y="76.7988"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="987" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="994" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="991" y="3250.6152"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="987" y="3254.6152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="994" y="3275.1504">Event-Topic</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1106" y="76.7988"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1102" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1109" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1106" y="3250.6152"/><rect fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1102" y="3254.6152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1109" y="3275.1504">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1259" y="113.334">Position DAO</text><ellipse cx="1307" cy="83.7988" fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1295" x2="1319" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1259" y="3264.1504">Position DAO</text><ellipse cx="1307" cy="3283.1035" fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1295" x2="1319" y1="3297.1035" y2="3297.1035"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1476" y="113.334">Central Store</text><path d="M1506,63.7988 C1506,53.7988 1524,53.7988 1524,53.7988 C1524,53.7988 1542,53.7988 1542,63.7988 L1542,89.7988 C1542,99.7988 1524,99.7988 1524,99.7988 C1524,99.7988 1506,99.7988 1506,89.7988 L1506,63.7988 " fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1506,63.7988 C1506,73.7988 1524,73.7988 1524,73.7988 C1524,73.7988 1542,73.7988 1542,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1476" y="3264.1504">Central Store</text><path d="M1506,3277.1035 C1506,3267.1035 1524,3267.1035 1524,3267.1035 C1524,3267.1035 1542,3267.1035 1542,3277.1035 L1542,3303.1035 C1542,3313.1035 1524,3313.1035 1524,3313.1035 C1524,3313.1035 1506,3313.1035 1506,3303.1035 L1506,3277.1035 " fill="#FEFECE" filter="url(#fo7lhklh4b9ti)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1506,3277.1035 C1506,3287.1035 1524,3287.1035 1524,3287.1035 C1524,3287.1035 1542,3287.1035 1542,3277.1035 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="3115.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="881" y="2450.7676"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="881" y="3114.3496"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1099.0664"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1428.793"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1663.5879"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="1901.0723"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1302" y="2564.6543"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1128.377"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1458.1035"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1692.8984"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="1930.3828"/><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1519" y="2593.9648"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3101.3281" style="stroke: #000000; stroke-width: 2.0;" width="1646" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3070.0176" style="stroke: #000000; stroke-width: 2.0;" width="1626" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="371" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="119" y="191.4766">Consume Fulfil event message for Payer</text><path d="M287.5,241.2188 L371.5,241.2188 L371.5,248.2188 L361.5,258.2188 L287.5,258.2188 L287.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="302.5" y="254.7871">break</text><path d="M297.5,265.5293 L439.5,265.5293 L439.5,272.5293 L429.5,282.5293 L297.5,282.5293 L297.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="312.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="393,328.4609,383,332.4609,393,336.4609,389,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="402" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="402" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="486" y="314.7188">2001</text><path d="M297.5,361.4609 L512.5,361.4609 L512.5,368.4609 L502.5,378.4609 L297.5,378.4609 L297.5,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="804.5" x="297.5" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="312.5" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="1027.5,396.082,1037.5,400.082,1027.5,404.082,1031.5,400.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1033.5" y1="400.082" y2="400.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="395.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="402" y="395.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="786.5" x="304.5" y="408.082"/><polygon fill="#EEEEEE" points="304.5,408.082,368.5,408.082,368.5,415.082,358.5,425.082,304.5,425.082,304.5,408.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="422.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="624.75" y="441.6504">Event Handler Consume</text><path d="M297.5,467.7031 L519.5,467.7031 L519.5,474.7031 L509.5,484.7031 L297.5,484.7031 L297.5,467.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="961.5" x="297.5" y="467.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="312.5" y="481.2715">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="943.5" x="304.5" y="510.0137"/><polygon fill="#EEEEEE" points="304.5,510.0137,368.5,510.0137,368.5,517.0137,358.5,527.0137,304.5,527.0137,304.5,510.0137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="524.582">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="610.25" y="543.582">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="828.25" y="543.582">FSPIOP-Signature</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="610.25" y="558.8926">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="694.25" y="558.8926">3105/3106</text><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="132.4844" style="stroke: #000000; stroke-width: 2.0;" width="1266.5" x="304.5" y="577.9453"/><polygon fill="#EEEEEE" points="304.5,577.9453,368.5,577.9453,368.5,584.9453,358.5,594.9453,304.5,594.9453,304.5,577.9453" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="592.5137">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="838.25" y="611.5137">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="842.25" y="626.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="838.25" y="642.1348">returns {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="870.25" y="657.4453">hasDuplicateId: Boolean,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="870.25" y="672.7559">hasDuplicateHash: Boolean</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="838.25" y="688.0664">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="842.25" y="703.377"/><path d="M267.5,722.4297 L329.5,722.4297 L329.5,729.4297 L319.5,739.4297 L267.5,739.4297 L267.5,722.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2443.9199" style="stroke: #000000; stroke-width: 2.0;" width="1371.5" x="267.5" y="722.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="282.5" y="735.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="344.5" y="735.0645">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M287.5,746.7402 L371.5,746.7402 L371.5,753.7402 L361.5,763.7402 L287.5,763.7402 L287.5,746.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="215.1738" style="stroke: #000000; stroke-width: 2.0;" width="981.5" x="287.5" y="746.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="302.5" y="760.3086">break</text><path d="M387,769.0508 L387,794.0508 L709,794.0508 L709,779.0508 L699,769.0508 L387,769.0508 " fill="#D3D3D3" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M699,769.0508 L699,779.0508 L709,779.0508 L699,769.0508 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="393" y="786.6191">stateRecord = await getTransferState(transferId)</text><path d="M297.5,810.3613 L359.5,810.3613 L359.5,817.3613 L349.5,827.3613 L297.5,827.3613 L297.5,810.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="144.5527" style="stroke: #000000; stroke-width: 2.0;" width="961.5" x="297.5" y="810.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="312.5" y="823.9297">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="374.5" y="822.9961">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#fo7lhklh4b9ti)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="943.5" x="304.5" y="852.6719"/><polygon fill="#EEEEEE" points="304.5,852.6719,368.5,852.6719,368.5,859.6719,358.5,869.6719,304.5,869.6719,304.5,852.6719" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="867.2402">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="714.25" y="886.2402">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="718.25" y="901.5508"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="297.5" x2="1259" y1="914.6035" y2="914.6035"/><path d="M387,920.6035 L387,945.6035 L581,945.6035 L581,930.6035 L571,920.6035 L387,920.6035 " fill="#D3D3D3" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M571,920.6035 L571,930.6035 L581,930.6035 L571,920.6035 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="393" y="938.1719">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="267.5" x2="1639" y1="969.9141" y2="969.9141"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="272.5" y="980.5488">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M387,988.8691 L387,1013.8691 L741,1013.8691 L741,998.8691 L731,988.8691 L387,988.8691 " fill="#D3D3D3" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M731,988.8691 L731,998.8691 L741,998.8691 L731,988.8691 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="393" y="1006.4375">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="267.5" x2="1639" y1="1024.1797" y2="1024.1797"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="272.5" y="1034.8145">[hasDuplicateId == FALSE]</text><path d="M277.5,1045.1348 L591.5,1045.1348 L591.5,1052.1348 L581.5,1062.1348 L277.5,1062.1348 L277.5,1045.1348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2114.2148" style="stroke: #000000; stroke-width: 2.0;" width="1351.5" x="277.5" y="1045.1348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="292.5" y="1058.7031">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1290,1095.0664,1300,1099.0664,1290,1103.0664,1294,1099.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1296" y1="1099.0664" y2="1099.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="1086.6689">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="402" y="1079.0137">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="1094.3242">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1094.3242">2003</text><polygon fill="#A80036" points="1507,1124.377,1517,1128.377,1507,1132.377,1511,1128.377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1312" x2="1513" y1="1128.377" y2="1128.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1319" y="1123.6348">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1332" y="1123.6348">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#fo7lhklh4b9ti)" points="1497,1141.377,1550,1141.377,1560,1152.377,1550,1164.377,1497,1164.377,1487,1152.377,1497,1141.377" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1499" y="1157.9453">transfer</text><polygon fill="#A80036" points="1323,1186.998,1313,1190.998,1323,1194.998,1319,1190.998" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1317" x2="1523" y1="1190.998" y2="1190.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1329" y="1186.2559">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1346" y="1186.2559"/><polygon fill="#A80036" points="393,1216.3086,383,1220.3086,393,1224.3086,389,1220.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1306" y1="1220.3086" y2="1220.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="1215.5664">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="412" y="1215.5664">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1264.9297" y2="1264.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1264.9297" y2="1277.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1277.9297" y2="1277.9297"/><polygon fill="#A80036" points="393,1273.9297,383,1277.9297,393,1281.9297,389,1277.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="1252.5322">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="402" y="1244.877">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="1260.1875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1260.1875">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1322.5508" y2="1322.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1322.5508" y2="1335.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1335.5508" y2="1335.5508"/><polygon fill="#A80036" points="393,1331.5508,383,1335.5508,393,1339.5508,389,1335.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="1310.1533">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="402" y="1302.498">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="1317.8086">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1317.8086">3303</text><path d="M287.5,1350.5508 L354.5,1350.5508 L354.5,1357.5508 L344.5,1367.5508 L287.5,1367.5508 L287.5,1350.5508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1326.5" x="287.5" y="1350.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="302.5" y="1364.1191">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="369.5" y="1363.1855">[Transfer.ilpCondition validate successful]</text><path d="M297.5,1374.8613 L584.5,1374.8613 L584.5,1381.8613 L574.5,1391.8613 L297.5,1391.8613 L297.5,1374.8613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1306.5" x="297.5" y="1374.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="312.5" y="1388.4297">Request current Settlement Window</text><polygon fill="#A80036" points="1290,1424.793,1300,1428.793,1290,1432.793,1294,1428.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1296" y1="1428.793" y2="1428.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1416.3955">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="411" y="1408.7402">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1424.0508">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1424.0508">2003</text><polygon fill="#A80036" points="1507,1454.1035,1517,1458.1035,1507,1462.1035,1511,1458.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1312" x2="1513" y1="1458.1035" y2="1458.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1319" y="1453.3613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1341" y="1453.3613">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#fo7lhklh4b9ti)" points="1464,1471.1035,1584,1471.1035,1594,1482.1035,1584,1494.1035,1464,1494.1035,1454,1482.1035,1464,1471.1035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1466" y="1487.6719">settlementWindow</text><polygon fill="#A80036" points="1323,1516.7246,1313,1520.7246,1323,1524.7246,1319,1520.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1317" x2="1523" y1="1520.7246" y2="1520.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1329" y="1515.9824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1355" y="1515.9824"/><polygon fill="#A80036" points="393,1576.6563,383,1580.6563,393,1584.6563,389,1580.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1306" y1="1580.6563" y2="1580.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1560.6035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="421" y="1545.293">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="421" y="1560.6035">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="462" y="1560.6035">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="421" y="1575.9141">state are updated to the next settlement window</text><path d="M297.5,1609.6563 L457.5,1609.6563 L457.5,1616.6563 L447.5,1626.6563 L297.5,1626.6563 L297.5,1609.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1304.5" x="297.5" y="1609.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="312.5" y="1623.2246">Persist fulfilment</text><polygon fill="#A80036" points="1290,1659.5879,1300,1663.5879,1290,1667.5879,1294,1663.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1296" y1="1663.5879" y2="1663.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1651.1904">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="411" y="1643.5352">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1658.8457">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1658.8457">2003</text><polygon fill="#A80036" points="1507,1688.8984,1517,1692.8984,1507,1696.8984,1511,1692.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1312" x2="1513" y1="1692.8984" y2="1692.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1319" y="1688.1563">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1341" y="1688.1563">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fo7lhklh4b9ti)" points="1465,1735.8984,1582,1735.8984,1592,1754.8984,1582,1773.8984,1465,1773.8984,1455,1754.8984,1465,1735.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1467" y="1752.4668">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1467" y="1767.7773">transferExtension</text><polygon fill="#A80036" points="393,1796.8301,383,1800.8301,393,1804.8301,389,1800.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1306" y1="1800.8301" y2="1800.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1796.0879">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1796.0879">Return success</text><path d="M287.5,1822.8301 L349.5,1822.8301 L349.5,1829.8301 L339.5,1839.8301 L287.5,1839.8301 L287.5,1822.8301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1329.5195" style="stroke: #000000; stroke-width: 2.0;" width="1331.5" x="287.5" y="1822.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="302.5" y="1836.3984">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="364.5" y="1835.4648">[Transfer.ilpCondition validate successful]</text><path d="M297.5,1847.1406 L753.5,1847.1406 L753.5,1854.1406 L743.5,1864.1406 L297.5,1864.1406 L297.5,1847.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1311.5" x="297.5" y="1847.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="312.5" y="1860.709">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1290,1897.0723,1300,1901.0723,1290,1905.0723,1294,1901.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1296" y1="1901.0723" y2="1901.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1888.6748">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="1881.0195">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1896.3301">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1896.3301">2003</text><polygon fill="#A80036" points="1507,1926.3828,1517,1930.3828,1507,1934.3828,1511,1930.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1312" x2="1513" y1="1930.3828" y2="1930.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1319" y="1925.6406">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1341" y="1925.6406">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fo7lhklh4b9ti)" points="1458,1973.3828,1589,1973.3828,1599,1984.3828,1589,1996.3828,1458,1996.3828,1448,1984.3828,1458,1973.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1460" y="1989.9512">transferStateChange</text><polygon fill="#A80036" points="393,2019.0039,383,2023.0039,393,2027.0039,389,2023.0039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1306" y1="2023.0039" y2="2023.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2018.2617">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2018.2617">Return success</text><path d="M387,2043.0039 L387,2420.0039 L696,2420.0039 L696,2053.0039 L686,2043.0039 L387,2043.0039 " fill="#FFFF00" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2043.0039 L686,2053.0039 L696,2053.0039 L686,2043.0039 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2060.5723">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2075.8828">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2091.1934">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2106.5039">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2121.8145">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2137.125">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2152.4355">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2167.7461">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2183.0566">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2198.3672">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2213.6777">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2228.9883">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2244.2988">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2259.6094">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="2274.9199">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="2290.2305">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2305.541">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="2320.8516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="2336.1621">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="2351.4727">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="2366.7832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2382.0938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2397.4043">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2412.7148">}</text><polygon fill="#A80036" points="869,2446.7676,879,2450.7676,869,2454.7676,873,2450.7676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="875" y1="2450.7676" y2="2450.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2446.0254">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="411" y="2446.0254">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1619" y1="2489.7676" y2="2489.7676"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="292.5" y="2500.4023">[Validate Fulfil Transfer not successful]</text><path d="M297.5,2510.7227 L701.5,2510.7227 L701.5,2517.7227 L691.5,2527.7227 L297.5,2527.7227 L297.5,2510.7227 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1311.5" x="297.5" y="2510.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="312.5" y="2524.291">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1290,2560.6543,1300,2564.6543,1290,2568.6543,1294,2564.6543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1296" y1="2564.6543" y2="2564.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2552.2568">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="2544.6016">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2559.9121">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2559.9121">2003</text><polygon fill="#A80036" points="1507,2589.9648,1517,2593.9648,1507,2597.9648,1511,2593.9648" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1312" x2="1513" y1="2593.9648" y2="2593.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1319" y="2589.2227">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1341" y="2589.2227">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fo7lhklh4b9ti)" points="1458,2636.9648,1589,2636.9648,1599,2647.9648,1589,2659.9648,1458,2659.9648,1448,2647.9648,1458,2636.9648" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1460" y="2653.5332">transferStateChange</text><polygon fill="#A80036" points="393,2682.5859,383,2686.5859,393,2690.5859,389,2686.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1306" y1="2686.5859" y2="2686.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2681.8438">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2681.8438">Return success</text><path d="M387,2706.5859 L387,3083.5859 L696,3083.5859 L696,2716.5859 L686,2706.5859 L387,2706.5859 " fill="#FFFF00" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2706.5859 L686,2716.5859 L696,2716.5859 L686,2706.5859 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2724.1543">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2739.4648">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2754.7754">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2770.0859">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2785.3965">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2800.707">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2816.0176">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2831.3281">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2846.6387">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2861.9492">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2877.2598">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2892.5703">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2907.8809">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2923.1914">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="2938.502">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="441" y="2953.8125">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2969.123">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="2984.4336">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="2999.7441">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="3015.0547">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="3030.3652">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3045.6758">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3060.9863">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3076.2969">}</text><polygon fill="#A80036" points="869,3110.3496,879,3114.3496,869,3118.3496,873,3114.3496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="875" y1="3114.3496" y2="3114.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3109.6074">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="411" y="3109.6074">Route &amp; Publish Position event for Payer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1649" y1="3174.3496" y2="3174.3496"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="3184.9844">[Consume Batch Messages]</text><path d="M149,3193.3047 L149,3218.3047 L363,3218.3047 L363,3203.3047 L353,3193.3047 L149,3193.3047 " fill="#ADD8E6" filter="url(#fo7lhklh4b9ti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,3193.3047 L353,3203.3047 L363,3203.3047 L353,3193.3047 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="155" y="3210.873">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature**\n<color #FF0000><b>Error codes:</b> 3105/3106</color>
        end
        ref over FULF_HANDLER, DB:  Request Duplicate Check\n\nreturns {\n\thasDuplicateId: Boolean,\n\thasDuplicateHash: Boolean\n}\n

        alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
            break
                note right of FULF_HANDLER #lightgrey
                    stateRecord = await getTransferState(transferId)
                end note
                alt endStateList.includes(stateRecord.transferStateId)
                    |||
                    ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                else
                    note right of FULF_HANDLER #lightgrey
                        Ignore - resend in progress
                    end note
                end
            end
        else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
            note right of FULF_HANDLER #lightgrey
                Validate Prepare Transfer (failure) - Modified Request
            end note
        else hasDuplicateId == FALSE
            group Validate and persist Transfer Fulfilment
                FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Fetch from database
                activate DB
                hnote over DB #lightyellow
                    transfer
                end note
                DB - -> POS_DAO
                deactivate DB
                FULF_HANDLER <- - POS_DAO: Return transfer
                deactivate POS_DAO
                FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
                FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

                opt Transfer.ilpCondition validate successful
                    group Request current Settlement Window
                        FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Fetch settlementWindowId
                        activate DB
                        hnote over DB #lightyellow
                            settlementWindow
                        end note
                        DB - -> POS_DAO
                        deactivate DB
                        FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                        deactivate POS_DAO
                    end
                end

                group Persist fulfilment
                    FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist to database
                    activate DB
                    deactivate DB
                    hnote over DB #lightyellow
                        transferFulfilment
                        transferExtension
                    end note
                    FULF_HANDLER <- - POS_DAO: Return success
                    deactivate POS_DAO
                end

                alt Transfer.ilpCondition validate successful
                    group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                else Validate Fulfil Transfer not successful
                    group Persist Transfer State (with transferState='ABORTED')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: abort,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "error",
                                        code: 1
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>