<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3346px" preserveAspectRatio="none" style="width:1679px;height:3346px;" version="1.1" viewBox="0 0 1679 3346" width="1679px" zoomAndPan="magnify"><defs><filter height="300%" id="f18o6cxdh8hdd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="699.5" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3301.373" style="stroke: #A80036; stroke-width: 1.0;" width="1556" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="756.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="3134.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="2469.5254"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="3133.1074"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1117.8242"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1447.5508"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1682.3457"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1919.8301"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="2583.4121"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1147.1348"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1476.8613"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1711.6563"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1949.1406"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="2612.7227"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="3120.0859" style="stroke: #000000; stroke-width: 2.0;" width="1655" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="3088.7754" style="stroke: #000000; stroke-width: 2.0;" width="1635" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="813.5" x="297.5" y="361.4609"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1293.5" x="297.5" y="533.0137"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="2476.2305" style="stroke: #000000; stroke-width: 2.0;" width="1380.5" x="267.5" y="708.877"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="990.5" x="287.5" y="733.1875"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="970.5" x="297.5" y="799.8086"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="970.5" x="297.5" y="932.3613"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1380.5" x="267.5" y="987.6719"/><rect fill="#FFFFFF" height="2143.1699" style="stroke: none; stroke-width: 1.0;" width="1380.5" x="267.5" y="1041.9375"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="2114.2148" style="stroke: #000000; stroke-width: 2.0;" width="1360.5" x="277.5" y="1063.8926"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1335.5" x="287.5" y="1369.3086"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1315.5" x="297.5" y="1393.6191"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1313.5" x="297.5" y="1628.4141"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="1329.5195" style="stroke: #000000; stroke-width: 2.0;" width="1340.5" x="287.5" y="1841.5879"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1320.5" x="297.5" y="1865.8984"/><rect fill="#FFFFFF" height="663.582" style="stroke: none; stroke-width: 1.0;" width="1340.5" x="287.5" y="2507.5254"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1320.5" x="297.5" y="2529.4805"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1635" x="23" y="3192.1074"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="895" x2="895" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1048" x2="1048" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1184" x2="1184" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1316" x2="1316" y1="116.2871" y2="3270.373"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1533" x2="1533" y1="116.2871" y2="3270.373"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="3269.373"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="3273.373"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="3293.9082">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="113.334">Fulfil Event Handler</text><ellipse cx="377" cy="83.7988" fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,71.7988,379,66.7988,377,71.7988,379,76.7988,373,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="3282.9082">Fulfil Event Handler</text><ellipse cx="377" cy="3301.8613" fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,3289.8613,379,3284.8613,377,3289.8613,379,3294.8613,373,3289.8613" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="808" y="76.7988"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="804" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="811" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="808" y="3269.373"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="804" y="3273.373"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="811" y="3293.9082">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1000" y="76.7988"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="996" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1003" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1000" y="3269.373"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="996" y="3273.373"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1003" y="3293.9082">Event-Topic</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1115" y="76.7988"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1111" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1118" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1115" y="3269.373"/><rect fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1111" y="3273.373"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1118" y="3293.9082">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1268" y="113.334">Position DAO</text><ellipse cx="1316" cy="83.7988" fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1304" x2="1328" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1268" y="3282.9082">Position DAO</text><ellipse cx="1316" cy="3301.8613" fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1304" x2="1328" y1="3315.8613" y2="3315.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1485" y="113.334">Central Store</text><path d="M1515,63.7988 C1515,53.7988 1533,53.7988 1533,53.7988 C1533,53.7988 1551,53.7988 1551,63.7988 L1551,89.7988 C1551,99.7988 1533,99.7988 1533,99.7988 C1533,99.7988 1515,99.7988 1515,89.7988 L1515,63.7988 " fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1515,63.7988 C1515,73.7988 1533,73.7988 1533,73.7988 C1533,73.7988 1551,73.7988 1551,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1485" y="3282.9082">Central Store</text><path d="M1515,3295.8613 C1515,3285.8613 1533,3285.8613 1533,3285.8613 C1533,3285.8613 1551,3285.8613 1551,3295.8613 L1551,3321.8613 C1551,3331.8613 1533,3331.8613 1533,3331.8613 C1533,3331.8613 1515,3331.8613 1515,3321.8613 L1515,3295.8613 " fill="#FEFECE" filter="url(#f18o6cxdh8hdd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1515,3295.8613 C1515,3305.8613 1533,3305.8613 1533,3305.8613 C1533,3305.8613 1551,3305.8613 1551,3295.8613 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="3134.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="2469.5254"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="890" y="3133.1074"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1117.8242"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1447.5508"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1682.3457"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="1919.8301"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1311" y="2583.4121"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1147.1348"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1476.8613"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1711.6563"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="1949.1406"/><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1528" y="2612.7227"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3120.0859" style="stroke: #000000; stroke-width: 2.0;" width="1655" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3088.7754" style="stroke: #000000; stroke-width: 2.0;" width="1635" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="371" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="119" y="191.4766">Consume Fulfil event message for Payer</text><path d="M287.5,241.2188 L371.5,241.2188 L371.5,248.2188 L361.5,258.2188 L287.5,258.2188 L287.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="302.5" y="254.7871">break</text><path d="M297.5,265.5293 L439.5,265.5293 L439.5,272.5293 L429.5,282.5293 L297.5,282.5293 L297.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="312.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="393,328.4609,383,332.4609,393,336.4609,389,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="402" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="402" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="486" y="314.7188">2001</text><path d="M297.5,361.4609 L512.5,361.4609 L512.5,368.4609 L502.5,378.4609 L297.5,378.4609 L297.5,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="813.5" x="297.5" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="312.5" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="1036.5,421.082,1046.5,425.082,1036.5,429.082,1040.5,425.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1042.5" y1="425.082" y2="425.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="420.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="402" y="420.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="795.5" x="304.5" y="433.082"/><polygon fill="#EEEEEE" points="304.5,433.082,368.5,433.082,368.5,440.082,358.5,450.082,304.5,450.082,304.5,433.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="447.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="629.25" y="466.6504">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="633.25" y="481.9609"/><path d="M297.5,533.0137 L510.5,533.0137 L510.5,540.0137 L500.5,550.0137 L297.5,550.0137 L297.5,533.0137 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1293.5" x="297.5" y="533.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="312.5" y="546.582">Validate Duplicate Check</text><polygon fill="#A80036" points="1521,592.6348,1531,596.6348,1521,600.6348,1525,596.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1527" y1="596.6348" y2="596.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="591.8926">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="402" y="591.8926">Request Duplicate Check</text><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1275.5" x="304.5" y="604.6348"/><polygon fill="#EEEEEE" points="304.5,604.6348,368.5,604.6348,368.5,611.6348,358.5,621.6348,304.5,621.6348,304.5,604.6348" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="619.2031">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="865.75" y="638.2031">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="869.75" y="653.5137"/><polygon fill="#A80036" points="393,682.877,383,686.877,393,690.877,389,686.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1532" y1="686.877" y2="686.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="682.1348">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="412" y="682.1348">Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }</text><path d="M267.5,708.877 L329.5,708.877 L329.5,715.877 L319.5,725.877 L267.5,725.877 L267.5,708.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2476.2305" style="stroke: #000000; stroke-width: 2.0;" width="1380.5" x="267.5" y="708.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="282.5" y="722.4453">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="344.5" y="721.5117">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M287.5,733.1875 L371.5,733.1875 L371.5,740.1875 L361.5,750.1875 L287.5,750.1875 L287.5,733.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="990.5" x="287.5" y="733.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="302.5" y="746.7559">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="771.8086" y2="771.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="771.8086" y2="784.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="784.8086" y2="784.8086"/><polygon fill="#A80036" points="393,780.8086,383,784.8086,393,788.8086,389,784.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="767.0664">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="402" y="767.0664">stateRecord = await getTransferState(transferId)</text><path d="M297.5,799.8086 L359.5,799.8086 L359.5,806.8086 L349.5,816.8086 L297.5,816.8086 L297.5,799.8086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="970.5" x="297.5" y="799.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="312.5" y="813.377">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="374.5" y="812.4434">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#f18o6cxdh8hdd)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="952.5" x="304.5" y="842.1191"/><polygon fill="#EEEEEE" points="304.5,842.1191,368.5,842.1191,368.5,849.1191,358.5,859.1191,304.5,859.1191,304.5,842.1191" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="856.6875">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="718.75" y="875.6875">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="722.75" y="890.998"/><polygon fill="#A80036" points="1172.5,920.3613,1182.5,924.3613,1172.5,928.3613,1176.5,924.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1178.5" y1="924.3613" y2="924.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="919.6191">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="402" y="919.6191">Produce message</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="297.5" x2="1268" y1="933.3613" y2="933.3613"/><path d="M387,939.3613 L387,964.3613 L581,964.3613 L581,949.3613 L571,939.3613 L387,939.3613 " fill="#D3D3D3" filter="url(#f18o6cxdh8hdd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M571,939.3613 L571,949.3613 L581,949.3613 L571,939.3613 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="393" y="956.9297">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="267.5" x2="1648" y1="988.6719" y2="988.6719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="272.5" y="999.3066">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M387,1007.627 L387,1032.627 L741,1032.627 L741,1017.627 L731,1007.627 L387,1007.627 " fill="#D3D3D3" filter="url(#f18o6cxdh8hdd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M731,1007.627 L731,1017.627 L741,1017.627 L731,1007.627 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="393" y="1025.1953">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="267.5" x2="1648" y1="1042.9375" y2="1042.9375"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="272.5" y="1053.5723">[hasDuplicateId == FALSE]</text><path d="M277.5,1063.8926 L591.5,1063.8926 L591.5,1070.8926 L581.5,1080.8926 L277.5,1080.8926 L277.5,1063.8926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2114.2148" style="stroke: #000000; stroke-width: 2.0;" width="1360.5" x="277.5" y="1063.8926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="292.5" y="1077.4609">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1299,1113.8242,1309,1117.8242,1299,1121.8242,1303,1117.8242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1305" y1="1117.8242" y2="1117.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="1105.4268">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="402" y="1097.7715">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="1113.082">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1113.082">2003</text><polygon fill="#A80036" points="1516,1143.1348,1526,1147.1348,1516,1151.1348,1520,1147.1348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1321" x2="1522" y1="1147.1348" y2="1147.1348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1328" y="1142.3926">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1341" y="1142.3926">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#f18o6cxdh8hdd)" points="1506,1160.1348,1559,1160.1348,1569,1171.1348,1559,1183.1348,1506,1183.1348,1496,1171.1348,1506,1160.1348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1508" y="1176.7031">transfer</text><polygon fill="#A80036" points="1332,1205.7559,1322,1209.7559,1332,1213.7559,1328,1209.7559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1326" x2="1532" y1="1209.7559" y2="1209.7559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1338" y="1205.0137">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1364" y="1205.0137"/><polygon fill="#A80036" points="393,1235.0664,383,1239.0664,393,1243.0664,389,1239.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1315" y1="1239.0664" y2="1239.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1234.3242">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="421" y="1234.3242">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1283.6875" y2="1283.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1283.6875" y2="1296.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1296.6875" y2="1296.6875"/><polygon fill="#A80036" points="393,1292.6875,383,1296.6875,393,1300.6875,389,1296.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1271.29">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="411" y="1263.6348">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1278.9453">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1278.9453">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1341.3086" y2="1341.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1341.3086" y2="1354.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1354.3086" y2="1354.3086"/><polygon fill="#A80036" points="393,1350.3086,383,1354.3086,393,1358.3086,389,1354.3086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1328.9111">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="411" y="1321.2559">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1336.5664">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1336.5664">3303</text><path d="M287.5,1369.3086 L354.5,1369.3086 L354.5,1376.3086 L344.5,1386.3086 L287.5,1386.3086 L287.5,1369.3086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1335.5" x="287.5" y="1369.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="302.5" y="1382.877">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="369.5" y="1381.9434">[Transfer.ilpCondition validate successful]</text><path d="M297.5,1393.6191 L584.5,1393.6191 L584.5,1400.6191 L574.5,1410.6191 L297.5,1410.6191 L297.5,1393.6191 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1315.5" x="297.5" y="1393.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="312.5" y="1407.1875">Request current Settlement Window</text><polygon fill="#A80036" points="1299,1443.5508,1309,1447.5508,1299,1451.5508,1303,1447.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1305" y1="1447.5508" y2="1447.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1435.1533">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="411" y="1427.498">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1442.8086">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1442.8086">2003</text><polygon fill="#A80036" points="1516,1472.8613,1526,1476.8613,1516,1480.8613,1520,1476.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1321" x2="1522" y1="1476.8613" y2="1476.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1328" y="1472.1191">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1350" y="1472.1191">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#f18o6cxdh8hdd)" points="1473,1489.8613,1593,1489.8613,1603,1500.8613,1593,1512.8613,1473,1512.8613,1463,1500.8613,1473,1489.8613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1475" y="1506.4297">settlementWindow</text><polygon fill="#A80036" points="1332,1535.4824,1322,1539.4824,1332,1543.4824,1328,1539.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1326" x2="1532" y1="1539.4824" y2="1539.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1338" y="1534.7402">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1364" y="1534.7402"/><polygon fill="#A80036" points="393,1595.4141,383,1599.4141,393,1603.4141,389,1599.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1315" y1="1599.4141" y2="1599.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1579.3613">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="421" y="1564.0508">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="421" y="1579.3613">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="462" y="1579.3613">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="421" y="1594.6719">state are updated to the next settlement window</text><path d="M297.5,1628.4141 L457.5,1628.4141 L457.5,1635.4141 L447.5,1645.4141 L297.5,1645.4141 L297.5,1628.4141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1313.5" x="297.5" y="1628.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="312.5" y="1641.9824">Persist fulfilment</text><polygon fill="#A80036" points="1299,1678.3457,1309,1682.3457,1299,1686.3457,1303,1682.3457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1305" y1="1682.3457" y2="1682.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1669.9482">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="411" y="1662.293">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1677.6035">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1677.6035">2003</text><polygon fill="#A80036" points="1516,1707.6563,1526,1711.6563,1516,1715.6563,1520,1711.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1321" x2="1522" y1="1711.6563" y2="1711.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1328" y="1706.9141">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1350" y="1706.9141">Persist to database</text><polygon fill="#FFFFE0" filter="url(#f18o6cxdh8hdd)" points="1474,1754.6563,1591,1754.6563,1601,1773.6563,1591,1792.6563,1474,1792.6563,1464,1773.6563,1474,1754.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1476" y="1771.2246">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1476" y="1786.5352">transferExtension</text><polygon fill="#A80036" points="393,1815.5879,383,1819.5879,393,1823.5879,389,1819.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1315" y1="1819.5879" y2="1819.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1814.8457">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1814.8457">Return success</text><path d="M287.5,1841.5879 L349.5,1841.5879 L349.5,1848.5879 L339.5,1858.5879 L287.5,1858.5879 L287.5,1841.5879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1329.5195" style="stroke: #000000; stroke-width: 2.0;" width="1340.5" x="287.5" y="1841.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="302.5" y="1855.1563">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="364.5" y="1854.2227">[Transfer.ilpCondition validate successful]</text><path d="M297.5,1865.8984 L753.5,1865.8984 L753.5,1872.8984 L743.5,1882.8984 L297.5,1882.8984 L297.5,1865.8984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1320.5" x="297.5" y="1865.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="312.5" y="1879.4668">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1299,1915.8301,1309,1919.8301,1299,1923.8301,1303,1919.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1305" y1="1919.8301" y2="1919.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1907.4326">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="1899.7773">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1915.0879">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1915.0879">2003</text><polygon fill="#A80036" points="1516,1945.1406,1526,1949.1406,1516,1953.1406,1520,1949.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1321" x2="1522" y1="1949.1406" y2="1949.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1328" y="1944.3984">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1350" y="1944.3984">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f18o6cxdh8hdd)" points="1467,1992.1406,1598,1992.1406,1608,2003.1406,1598,2015.1406,1467,2015.1406,1457,2003.1406,1467,1992.1406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1469" y="2008.709">transferStateChange</text><polygon fill="#A80036" points="393,2037.7617,383,2041.7617,393,2045.7617,389,2041.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1315" y1="2041.7617" y2="2041.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2037.0195">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2037.0195">Return success</text><path d="M387,2061.7617 L387,2438.7617 L696,2438.7617 L696,2071.7617 L686,2061.7617 L387,2061.7617 " fill="#FFFF00" filter="url(#f18o6cxdh8hdd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2061.7617 L686,2071.7617 L696,2071.7617 L686,2061.7617 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2079.3301">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2094.6406">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2109.9512">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2125.2617">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2140.5723">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2155.8828">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2171.1934">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2186.5039">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2201.8145">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2217.125">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2232.4355">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2247.7461">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2263.0566">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2278.3672">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="2293.6777">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="2308.9883">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2324.2988">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="2339.6094">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="2354.9199">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="2370.2305">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="2385.541">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2400.8516">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2416.1621">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2431.4727">}</text><polygon fill="#A80036" points="878,2465.5254,888,2469.5254,878,2473.5254,882,2469.5254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="884" y1="2469.5254" y2="2469.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2464.7832">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="411" y="2464.7832">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1628" y1="2508.5254" y2="2508.5254"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="292.5" y="2519.1602">[Validate Fulfil Transfer not successful]</text><path d="M297.5,2529.4805 L701.5,2529.4805 L701.5,2536.4805 L691.5,2546.4805 L297.5,2546.4805 L297.5,2529.4805 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1320.5" x="297.5" y="2529.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="312.5" y="2543.0488">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1299,2579.4121,1309,2583.4121,1299,2587.4121,1303,2583.4121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1305" y1="2583.4121" y2="2583.4121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2571.0146">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="2563.3594">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2578.6699">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2578.6699">2003</text><polygon fill="#A80036" points="1516,2608.7227,1526,2612.7227,1516,2616.7227,1520,2612.7227" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1321" x2="1522" y1="2612.7227" y2="2612.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1328" y="2607.9805">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1350" y="2607.9805">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f18o6cxdh8hdd)" points="1467,2655.7227,1598,2655.7227,1608,2666.7227,1598,2678.7227,1467,2678.7227,1457,2666.7227,1467,2655.7227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1469" y="2672.291">transferStateChange</text><polygon fill="#A80036" points="393,2701.3438,383,2705.3438,393,2709.3438,389,2705.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1315" y1="2705.3438" y2="2705.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2700.6016">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2700.6016">Return success</text><path d="M387,2725.3438 L387,3102.3438 L696,3102.3438 L696,2735.3438 L686,2725.3438 L387,2725.3438 " fill="#FFFF00" filter="url(#f18o6cxdh8hdd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2725.3438 L686,2735.3438 L696,2735.3438 L686,2725.3438 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2742.9121">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2758.2227">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2773.5332">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2788.8438">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2804.1543">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2819.4648">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2834.7754">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2850.0859">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2865.3965">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2880.707">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2896.0176">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2911.3281">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2926.6387">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2941.9492">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="2957.2598">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="441" y="2972.5703">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2987.8809">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="3003.1914">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="457" y="3018.502">status: "error",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="3033.8125">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="3049.123">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3064.4336">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3079.7441">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3095.0547">}</text><polygon fill="#A80036" points="878,3129.1074,888,3133.1074,878,3137.1074,882,3133.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="884" y1="3133.1074" y2="3133.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3128.3652">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="411" y="3128.3652">Route &amp; Publish Position event for Payer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1658" y1="3193.1074" y2="3193.1074"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="3203.7422">[Consume Batch Messages]</text><path d="M149,3212.0625 L149,3237.0625 L363,3237.0625 L363,3222.0625 L353,3212.0625 L149,3212.0625 " fill="#ADD8E6" filter="url(#f18o6cxdh8hdd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,3212.0625 L353,3222.0625 L363,3222.0625 L353,3212.0625 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="155" y="3229.6309">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            |||
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume\n
            |||
        end

        group Validate Duplicate Check
            |||
            FULF_HANDLER -> DB: Request Duplicate Check
            ref over FULF_HANDLER, DB:  Request Duplicate Check\n
            DB - -> FULF_HANDLER: Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }
        end

        alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
            break
                FULF_HANDLER -> FULF_HANDLER: stateRecord = await getTransferState(transferId)
                alt endStateList.includes(stateRecord.transferStateId)
                    |||
                    ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Produce message
                else
                    note right of FULF_HANDLER #lightgrey
                        Ignore - resend in progress
                    end note
                end
            end
        else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
            note right of FULF_HANDLER #lightgrey
                Validate Prepare Transfer (failure) - Modified Request
            end note
        else hasDuplicateId == FALSE
            group Validate and persist Transfer Fulfilment
                FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Fetch from database
                activate DB
                hnote over DB #lightyellow
                    transfer
                end note
                DB - -> POS_DAO
                deactivate DB
                FULF_HANDLER <- - POS_DAO: Return transfer
                deactivate POS_DAO
                FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
                FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

                opt Transfer.ilpCondition validate successful
                    group Request current Settlement Window
                        FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Fetch settlementWindowId
                        activate DB
                        hnote over DB #lightyellow
                            settlementWindow
                        end note
                        DB - -> POS_DAO
                        deactivate DB
                        FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                        deactivate POS_DAO
                    end
                end

                group Persist fulfilment
                    FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist to database
                    activate DB
                    deactivate DB
                    hnote over DB #lightyellow
                        transferFulfilment
                        transferExtension
                    end note
                    FULF_HANDLER <- - POS_DAO: Return success
                    deactivate POS_DAO
                end

                alt Transfer.ilpCondition validate successful
                    group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: commit,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "success",
                                        code: 0
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                else Validate Fulfil Transfer not successful
                    group Persist Transfer State (with transferState='ABORTED')
                        FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                        activate POS_DAO
                        POS_DAO -> DB: Persist transfer state
                        activate DB
                        hnote over DB #lightyellow
                            transferStateChange
                        end note
                        deactivate DB
                        POS_DAO - -> FULF_HANDLER: Return success
                        deactivate POS_DAO
                    end

                    note right of FULF_HANDLER #yellow
                        Message:
                        {
                            id: <ID>,
                            from: <transferHeaders.FSPIOP-Source>,
                            to: <transferHeaders.FSPIOP-Destination>,
                            type: application/json,
                            content: {
                                headers: <transferHeaders>,
                                payload: <transferMessage>
                            },
                            metadata: {
                                event: {
                                    id: <uuid>,
                                    responseTo: <previous.uuid>,
                                    type: position,
                                    action: abort,
                                    createdAt: <timestamp>,
                                    state: {
                                        status: "error",
                                        code: 1
                                    }
                                }
                            }
                        }
                    end note
                    FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer
                    activate TOPIC_TRANSFER_POSITION
                    deactivate TOPIC_TRANSFER_POSITION
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>