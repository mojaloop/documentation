<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3414px" preserveAspectRatio="none" style="width:2003px;height:3414px;" version="1.1" viewBox="0 0 2003 3414" width="2003px" zoomAndPan="magnify"><defs><filter height="300%" id="f1dhjlgyl949y3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="861.5" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3369.4648" style="stroke: #A80036; stroke-width: 1.0;" width="1840" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="898.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3202.1777" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980" y="3102.623"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269.5" y="3201.1992"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="681.1875"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="973.6035"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1546.0586"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1750.9219"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2080.6484"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2315.4434"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2552.9277"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="710.498"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1002.9141"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1575.3691"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1780.2324"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2109.959"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2344.7539"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2582.2383"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3188.1777" style="stroke: #000000; stroke-width: 2.0;" width="1979" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3156.8672" style="stroke: #000000; stroke-width: 2.0;" width="1959" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="903.5" x="297.5" y="361.4609"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="467.7031"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="1098.0449" style="stroke: #000000; stroke-width: 2.0;" width="1704.5" x="267.5" y="584.9453"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="785.6289" style="stroke: #000000; stroke-width: 2.0;" width="1667.5" x="277.5" y="890.3613"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="362.3262" style="stroke: #000000; stroke-width: 2.0;" width="1080.5" x="287.5" y="1125.1563"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="263.5" x="297.5" y="1149.4668"/><rect fill="#FFFFFF" height="107.1973" style="stroke: none; stroke-width: 1.0;" width="1080.5" x="287.5" y="1216.0879"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="78.2422" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="1238.043"/><rect fill="#FFFFFF" height="88.5762" style="stroke: none; stroke-width: 1.0;" width="1080.5" x="287.5" y="1323.2852"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="234.5" x="297.5" y="1345.2402"/><rect fill="#FFFFFF" height="75.6211" style="stroke: none; stroke-width: 1.0;" width="1080.5" x="287.5" y="1411.8613"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="348.5" x="297.5" y="1420.8613"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1667.5" x="277.5" y="1494.4824"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="1556.209" style="stroke: #000000; stroke-width: 2.0;" width="1644.5" x="277.5" y="1696.9902"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1619.5" x="287.5" y="2002.4063"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1599.5" x="297.5" y="2026.7168"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1597.5" x="297.5" y="2261.5117"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="771.5137" style="stroke: #000000; stroke-width: 2.0;" width="1624.5" x="287.5" y="2474.6855"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1604.5" x="297.5" y="2498.9961"/><rect fill="#FFFFFF" height="105.5762" style="stroke: none; stroke-width: 1.0;" width="1624.5" x="287.5" y="3140.623"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="3162.5781"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1959" x="23" y="3260.1992"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="985" x2="985" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1138" x2="1138" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1274" x2="1274" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1406" x2="1406" y1="116.2871" y2="3338.4648"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1817" x2="1817" y1="116.2871" y2="3338.4648"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="3337.4648"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="3341.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="3362">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="113.334">Fulfil Event Handler</text><ellipse cx="377" cy="83.7988" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,71.7988,379,66.7988,377,71.7988,379,76.7988,373,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="307.5" y="3351">Fulfil Event Handler</text><ellipse cx="377" cy="3369.9531" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="373,3357.9531,379,3352.9531,377,3357.9531,379,3362.9531,373,3357.9531" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="898" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="894" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="901" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="898" y="3337.4648"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="894" y="3341.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="901" y="3362">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1090" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1086" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1093" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1090" y="3337.4648"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1086" y="3341.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1093" y="3362">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1205" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1201" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1208" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1205" y="3337.4648"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1201" y="3341.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1208" y="3362">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1358" y="113.334">Position DAO</text><ellipse cx="1406" cy="83.7988" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1394" x2="1418" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1358" y="3351">Position DAO</text><ellipse cx="1406" cy="3369.9531" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1394" x2="1418" y1="3383.9531" y2="3383.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1769" y="113.334">Central Store</text><path d="M1799,63.7988 C1799,53.7988 1817,53.7988 1817,53.7988 C1817,53.7988 1835,53.7988 1835,63.7988 L1835,89.7988 C1835,99.7988 1817,99.7988 1817,99.7988 C1817,99.7988 1799,99.7988 1799,89.7988 L1799,63.7988 " fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1799,63.7988 C1799,73.7988 1817,73.7988 1817,73.7988 C1817,73.7988 1835,73.7988 1835,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1769" y="3351">Central Store</text><path d="M1799,3363.9531 C1799,3353.9531 1817,3353.9531 1817,3353.9531 C1817,3353.9531 1835,3353.9531 1835,3363.9531 L1835,3389.9531 C1835,3399.9531 1817,3399.9531 1817,3399.9531 C1817,3399.9531 1799,3399.9531 1799,3389.9531 L1799,3363.9531 " fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1799,3363.9531 C1799,3373.9531 1817,3373.9531 1817,3373.9531 C1817,3373.9531 1835,3373.9531 1835,3363.9531 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3202.1777" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980" y="3102.623"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269.5" y="3201.1992"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="681.1875"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="973.6035"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1546.0586"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1750.9219"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2080.6484"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2315.4434"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="2552.9277"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="710.498"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1002.9141"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1575.3691"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="1780.2324"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2109.959"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2344.7539"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1812" y="2582.2383"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3188.1777" style="stroke: #000000; stroke-width: 2.0;" width="1979" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3156.8672" style="stroke: #000000; stroke-width: 2.0;" width="1959" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="371" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="119" y="191.4766">Consume Fulfil event message for Payer</text><path d="M287.5,241.2188 L371.5,241.2188 L371.5,248.2188 L361.5,258.2188 L287.5,258.2188 L287.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="287.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="302.5" y="254.7871">break</text><path d="M297.5,265.5293 L439.5,265.5293 L439.5,272.5293 L429.5,282.5293 L297.5,282.5293 L297.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="297.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="312.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="393,328.4609,383,332.4609,393,336.4609,389,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="402" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="402" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="486" y="314.7188">2001</text><path d="M297.5,361.4609 L512.5,361.4609 L512.5,368.4609 L502.5,378.4609 L297.5,378.4609 L297.5,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="903.5" x="297.5" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="312.5" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="1126.5,396.082,1136.5,400.082,1126.5,404.082,1130.5,400.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1132.5" y1="400.082" y2="400.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="395.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="402" y="395.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="885.5" x="304.5" y="408.082"/><polygon fill="#EEEEEE" points="304.5,408.082,368.5,408.082,368.5,415.082,358.5,425.082,304.5,425.082,304.5,408.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="422.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="652.25" y="441.6504">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="810.25" y="441.6504">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="810.25" x2="842.25" y1="443.6504" y2="443.6504"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="842.25" y="441.6504">}</text><path d="M297.5,467.7031 L519.5,467.7031 L519.5,474.7031 L509.5,484.7031 L297.5,484.7031 L297.5,467.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="467.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="312.5" y="481.2715">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1042.5" x="304.5" y="510.0137"/><polygon fill="#EEEEEE" points="304.5,510.0137,368.5,510.0137,368.5,517.0137,358.5,527.0137,304.5,527.0137,304.5,510.0137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="524.582">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="572.25" y="543.582">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="790.25" y="543.582">FSPIOP-Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="912.25" y="543.582">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="159" x="916.25" y="543.582">seq-signature-validation</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="916.25" x2="1075.25" y1="545.582" y2="545.582"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1075.25" y="543.582">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="572.25" y="558.8926">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="656.25" y="558.8926">3105/3106</text><path d="M267.5,584.9453 L614.5,584.9453 L614.5,591.9453 L604.5,601.9453 L267.5,601.9453 L267.5,584.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1098.0449" style="stroke: #000000; stroke-width: 2.0;" width="1704.5" x="267.5" y="584.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="282.5" y="598.5137">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="623.5664" y2="623.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="623.5664" y2="636.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="636.5664" y2="636.5664"/><polygon fill="#A80036" points="393,632.5664,383,636.5664,393,640.5664,389,636.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="618.8242">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="402" y="618.8242">Generate transferFulfilmentId uuid</text><polygon fill="#A80036" points="1389,677.1875,1399,681.1875,1389,685.1875,1393,681.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="681.1875" y2="681.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="668.79">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="402" y="661.1348">Request to retrieve transfer fulfilment hashes by transferId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="676.4453">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="676.4453">2003</text><polygon fill="#A80036" points="1800,706.498,1810,710.498,1800,714.498,1804,710.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="710.498" y2="710.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1418" y="705.7559">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="1431" y="705.7559">Request Transfer fulfilment duplicate message hashes</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1681,723.498,1952,723.498,1962,749.498,1952,776.498,1681,776.498,1671,749.498,1681,723.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1683" y="740.0664">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1683" y="755.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="1723" y="755.377">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="1683" y="770.6875">WHERE transferId = request.params.id</text><polygon fill="#A80036" points="1422,799.7402,1412,803.7402,1422,807.7402,1418,803.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1816" y1="803.7402" y2="803.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1428" y="798.998">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1441" y="798.998">Return existing hashes</text><polygon fill="#A80036" points="393,829.0508,383,833.0508,393,837.0508,389,833.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="833.0508" y2="833.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="828.3086">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="412" y="828.3086">Return (list of) transfer fulfil messages hash(es)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="862.3613" y2="862.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="862.3613" y2="875.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="875.3613" y2="875.3613"/><polygon fill="#A80036" points="393,871.3613,383,875.3613,393,879.3613,389,875.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="857.6191">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="402" y="857.6191">Loop the list of returned hashes and compare each entry with the calculated message hash</text><path d="M277.5,890.3613 L339.5,890.3613 L339.5,897.3613 L329.5,907.3613 L277.5,907.3613 L277.5,890.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="785.6289" style="stroke: #000000; stroke-width: 2.0;" width="1667.5" x="277.5" y="890.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="292.5" y="903.9297">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="354.5" y="902.9961">[Hash matched]</text><polygon fill="#A80036" points="1126.5,924.9824,1136.5,928.9824,1126.5,932.9824,1130.5,928.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1132.5" y1="928.9824" y2="928.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="924.2402">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="411" y="924.2402">Publish event information (for duplicate) ( Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="835" y="924.2402">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="835" x2="867" y1="926.2402" y2="926.2402"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="867" y="924.2402">} )</text><polygon fill="#A80036" points="1389,969.6035,1399,973.6035,1389,977.6035,1393,973.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="973.6035" y2="973.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="961.2061">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="411" y="953.5508">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="968.8613">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="968.8613">2003</text><polygon fill="#A80036" points="1800,998.9141,1810,1002.9141,1800,1006.9141,1804,1002.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="1002.9141" y2="1002.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="998.1719">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1440" y="998.1719">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1751,1015.9141,1882,1015.9141,1892,1034.9141,1882,1053.9141,1751,1053.9141,1741,1034.9141,1751,1015.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1753" y="1032.4824">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1753" y="1047.793">transferStateChange</text><polygon fill="#A80036" points="1422,1076.8457,1412,1080.8457,1422,1084.8457,1418,1080.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1816" y1="1080.8457" y2="1080.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1428" y="1076.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1450" y="1076.1035">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="393,1106.1563,383,1110.1563,393,1114.1563,389,1110.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="1110.1563" y2="1110.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1105.4141">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="421" y="1105.4141">Return Transfer Fulfilment and Transfer state</text><path d="M287.5,1125.1563 L349.5,1125.1563 L349.5,1132.1563 L339.5,1142.1563 L287.5,1142.1563 L287.5,1125.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="362.3262" style="stroke: #000000; stroke-width: 2.0;" width="1080.5" x="287.5" y="1125.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="302.5" y="1138.7246">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="185" x="364.5" y="1137.791">[transferFulfilment.isValid == 0]</text><path d="M297.5,1149.4668 L381.5,1149.4668 L381.5,1156.4668 L371.5,1166.4668 L297.5,1166.4668 L297.5,1149.4668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="263.5" x="297.5" y="1149.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="312.5" y="1163.0352">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1188.0879" y2="1188.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1188.0879" y2="1201.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1201.0879" y2="1201.0879"/><polygon fill="#A80036" points="393,1197.0879,383,1201.0879,393,1205.0879,389,1201.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1183.3457">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="411" y="1183.3457">Error handling:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="517" y="1183.3457">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1368" y1="1217.0879" y2="1217.0879"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="292.5" y="1227.7227">[transferState IN ['COMMITTED', 'ABORTED']]</text><path d="M297.5,1238.043 L381.5,1238.043 L381.5,1245.043 L371.5,1255.043 L297.5,1255.043 L297.5,1238.043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="78.2422" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="1238.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="312.5" y="1251.6113">break</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1042.5" x="304.5" y="1255.3535"/><polygon fill="#EEEEEE" points="304.5,1255.3535,368.5,1255.3535,368.5,1262.3535,358.5,1272.3535,304.5,1272.3535,304.5,1255.3535" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="317.5" y="1269.9219">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="677.25" y="1288.9219">Send notification to Participant (Payee) {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="43" x="927.25" y="1288.9219">1.1.4.a</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="927.25" x2="970.25" y1="1290.9219" y2="1290.9219"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="970.25" y="1288.9219">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="681.25" y="1304.2324"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1368" y1="1324.2852" y2="1324.2852"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="292.5" y="1334.9199">[transferState NOT 'RESERVED']</text><path d="M297.5,1345.2402 L381.5,1345.2402 L381.5,1352.2402 L371.5,1362.2402 L297.5,1362.2402 L297.5,1345.2402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="234.5" x="297.5" y="1345.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="312.5" y="1358.8086">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1383.8613" y2="1383.8613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1383.8613" y2="1396.8613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1396.8613" y2="1396.8613"/><polygon fill="#A80036" points="393,1392.8613,383,1396.8613,393,1400.8613,389,1396.8613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1379.1191">16</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1379.1191">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1379.1191">2001</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1368" y1="1412.8613" y2="1412.8613"/><path d="M297.5,1420.8613 L381.5,1420.8613 L381.5,1427.8613 L371.5,1437.8613 L297.5,1437.8613 L297.5,1420.8613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="348.5" x="297.5" y="1420.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="312.5" y="1434.4297">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1459.4824" y2="1459.4824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1459.4824" y2="1472.4824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1472.4824" y2="1472.4824"/><polygon fill="#A80036" points="393,1468.4824,383,1472.4824,393,1476.4824,389,1472.4824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1454.7402">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="411" y="1454.7402">Allow previous request to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="277.5" x2="1945" y1="1495.4824" y2="1495.4824"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="282.5" y="1506.1172">[Hash not matched]</text><polygon fill="#A80036" points="1389,1542.0586,1399,1546.0586,1389,1550.0586,1393,1546.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="1546.0586" y2="1546.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1533.6611">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="411" y="1526.0059">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="1541.3164">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="1541.3164">2003</text><polygon fill="#A80036" points="1800,1571.3691,1810,1575.3691,1800,1579.3691,1804,1575.3691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="1575.3691" y2="1575.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="1570.627">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1440" y="1570.627">Persist hash</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1709,1618.3691,1925,1618.3691,1935,1629.3691,1925,1641.3691,1709,1641.3691,1699,1629.3691,1709,1618.3691" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="1711" y="1634.9375">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="393,1663.9902,383,1667.9902,393,1671.9902,389,1667.9902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="1667.9902" y2="1667.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1663.248">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1663.248">Return success</text><path d="M277.5,1696.9902 L591.5,1696.9902 L591.5,1703.9902 L581.5,1713.9902 L277.5,1713.9902 L277.5,1696.9902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1556.209" style="stroke: #000000; stroke-width: 2.0;" width="1644.5" x="277.5" y="1696.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="292.5" y="1710.5586">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1389,1746.9219,1399,1750.9219,1389,1754.9219,1393,1750.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="1750.9219" y2="1750.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1738.5244">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="411" y="1730.8691">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1746.1797">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1746.1797">2003</text><polygon fill="#A80036" points="1800,1776.2324,1810,1780.2324,1800,1784.2324,1804,1780.2324" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="1780.2324" y2="1780.2324"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="1775.4902">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1440" y="1775.4902">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1790,1793.2324,1843,1793.2324,1853,1804.2324,1843,1816.2324,1790,1816.2324,1780,1804.2324,1790,1793.2324" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1792" y="1809.8008">transfer</text><polygon fill="#A80036" points="1422,1838.8535,1412,1842.8535,1422,1846.8535,1418,1842.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1816" y1="1842.8535" y2="1842.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1428" y="1838.1113">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1454" y="1838.1113"/><polygon fill="#A80036" points="393,1868.1641,383,1872.1641,393,1876.1641,389,1872.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="1872.1641" y2="1872.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1867.4219">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="421" y="1867.4219">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1916.7852" y2="1916.7852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1916.7852" y2="1929.7852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1929.7852" y2="1929.7852"/><polygon fill="#A80036" points="393,1925.7852,383,1929.7852,393,1933.7852,389,1929.7852" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1904.3877">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="411" y="1896.7324">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1912.043">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1912.043">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="1974.4063" y2="1974.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="1974.4063" y2="1987.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="1987.4063" y2="1987.4063"/><polygon fill="#A80036" points="393,1983.4063,383,1987.4063,393,1991.4063,389,1987.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1962.0088">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="411" y="1954.3535">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="1969.6641">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="1969.6641">3303</text><path d="M287.5,2002.4063 L354.5,2002.4063 L354.5,2009.4063 L344.5,2019.4063 L287.5,2019.4063 L287.5,2002.4063 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1619.5" x="287.5" y="2002.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="302.5" y="2015.9746">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="369.5" y="2015.041">[Transfer.ilpCondition validate successful]</text><path d="M297.5,2026.7168 L584.5,2026.7168 L584.5,2033.7168 L574.5,2043.7168 L297.5,2043.7168 L297.5,2026.7168 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1599.5" x="297.5" y="2026.7168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="312.5" y="2040.2852">Request current Settlement Window</text><polygon fill="#A80036" points="1389,2076.6484,1399,2080.6484,1389,2084.6484,1393,2080.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="2080.6484" y2="2080.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2068.251">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="411" y="2060.5957">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2075.9063">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2075.9063">2003</text><polygon fill="#A80036" points="1800,2105.959,1810,2109.959,1800,2113.959,1804,2109.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="2109.959" y2="2109.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="2105.2168">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1440" y="2105.2168">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1757,2122.959,1877,2122.959,1887,2133.959,1877,2145.959,1757,2145.959,1747,2133.959,1757,2122.959" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1759" y="2139.5273">settlementWindow</text><polygon fill="#A80036" points="1422,2168.5801,1412,2172.5801,1422,2176.5801,1418,2172.5801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1816" y1="2172.5801" y2="2172.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1428" y="2167.8379">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1454" y="2167.8379"/><polygon fill="#A80036" points="393,2228.5117,383,2232.5117,393,2236.5117,389,2232.5117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="2232.5117" y2="2232.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2212.459">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="421" y="2197.1484">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="421" y="2212.459">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="462" y="2212.459">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="421" y="2227.7695">state are updated to the next settlement window</text><path d="M297.5,2261.5117 L457.5,2261.5117 L457.5,2268.5117 L447.5,2278.5117 L297.5,2278.5117 L297.5,2261.5117 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1597.5" x="297.5" y="2261.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="312.5" y="2275.0801">Persist fulfilment</text><polygon fill="#A80036" points="1389,2311.4434,1399,2315.4434,1389,2319.4434,1393,2315.4434" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="2315.4434" y2="2315.4434"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2303.0459">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="411" y="2295.3906">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2310.7012">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2310.7012">2003</text><polygon fill="#A80036" points="1800,2340.7539,1810,2344.7539,1800,2348.7539,1804,2344.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="2344.7539" y2="2344.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="2340.0117">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1440" y="2340.0117">Persist to database</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1758,2387.7539,1875,2387.7539,1885,2406.7539,1875,2425.7539,1758,2425.7539,1748,2406.7539,1758,2387.7539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1760" y="2404.3223">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1760" y="2419.6328">transferExtension</text><polygon fill="#A80036" points="393,2448.6855,383,2452.6855,393,2456.6855,389,2452.6855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="2452.6855" y2="2452.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2447.9434">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2447.9434">Return success</text><path d="M287.5,2474.6855 L349.5,2474.6855 L349.5,2481.6855 L339.5,2491.6855 L287.5,2491.6855 L287.5,2474.6855 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="771.5137" style="stroke: #000000; stroke-width: 2.0;" width="1624.5" x="287.5" y="2474.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="302.5" y="2488.2539">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="364.5" y="2487.3203">[Transfer.ilpCondition validate successful]</text><path d="M297.5,2498.9961 L753.5,2498.9961 L753.5,2505.9961 L743.5,2515.9961 L297.5,2515.9961 L297.5,2498.9961 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1604.5" x="297.5" y="2498.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="312.5" y="2512.5645">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1389,2548.9277,1399,2552.9277,1389,2556.9277,1393,2552.9277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1395" y1="2552.9277" y2="2552.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2540.5303">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="411" y="2532.875">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="411" y="2548.1855">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="488" y="2548.1855">2003</text><polygon fill="#A80036" points="1800,2578.2383,1810,2582.2383,1800,2586.2383,1804,2582.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1806" y1="2582.2383" y2="2582.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="2577.4961">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1440" y="2577.4961">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1751,2625.2383,1882,2625.2383,1892,2636.2383,1882,2648.2383,1751,2648.2383,1741,2636.2383,1751,2625.2383" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1753" y="2641.8066">transferStateChange</text><polygon fill="#A80036" points="393,2670.8594,383,2674.8594,393,2678.8594,389,2674.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1405" y1="2674.8594" y2="2674.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="2670.1172">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="2670.1172">Return success</text><path d="M387,2694.8594 L387,3071.8594 L696,3071.8594 L696,2704.8594 L686,2694.8594 L387,2694.8594 " fill="#FFFF00" filter="url(#f1dhjlgyl949y3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,2694.8594 L686,2704.8594 L696,2704.8594 L686,2694.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="2712.4277">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2727.7383">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="409" y="2743.0488">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="409" y="2758.3594">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="409" y="2773.6699">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="409" y="2788.9805">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="2804.291">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="425" y="2819.6016">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="2834.9121">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="2850.2227">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="2865.5332">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="2880.8438">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="2896.1543">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="441" y="2911.4648">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="441" y="2926.7754">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="441" y="2942.0859">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="2957.3965">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="2972.707">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="2988.0176">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="3003.3281">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="3018.6387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3033.9492">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3049.2598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3064.5703">}</text><polygon fill="#A80036" points="968,3098.623,978,3102.623,968,3106.623,972,3102.623" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="974" y1="3102.623" y2="3102.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3097.8809">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="411" y="3097.8809">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="287.5" x2="1912" y1="3141.623" y2="3141.623"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="292.5" y="3152.2578">[Validate Fulfil Transfer not successful]</text><path d="M297.5,3162.5781 L381.5,3162.5781 L381.5,3169.5781 L371.5,3179.5781 L297.5,3179.5781 L297.5,3162.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1060.5" x="297.5" y="3162.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="312.5" y="3176.1465">break</text><polygon fill="#A80036" points="1257.5,3197.1992,1267.5,3201.1992,1257.5,3205.1992,1261.5,3201.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1263.5" y1="3201.1992" y2="3201.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="3196.457">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="411" y="3196.457">Route &amp; Publish Notification event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1982" y1="3261.1992" y2="3261.1992"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="3271.834">[Consume Batch Messages]</text><path d="M149,3280.1543 L149,3305.1543 L363,3305.1543 L363,3290.1543 L353,3280.1543 L149,3280.1543 " fill="#ADD8E6" filter="url(#f1dhjlgyl949y3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,3280.1543 L353,3290.1543 L363,3290.1543 L353,3280.1543 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="155" y="3297.7227">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]}
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature** {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg seq-signature-validation]]} \n<color #FF0000><b>Error codes:</b> 3105/3106</color>
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId uuid
            FULF_HANDLER -> POS_DAO: Request to retrieve transfer fulfilment hashes by transferId\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Request Transfer fulfilment duplicate message hashes
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM **transferFulfilmentDuplicateCheck**
                WHERE transferId = request.params.id
            end note
            activate DB
            POS_DAO <- - DB: Return existing hashes
            deactivate DB
            POS_DAO - -> FULF_HANDLER: Return (list of) transfer fulfil messages hash(es)
            deactivate POS_DAO
            FULF_HANDLER -> FULF_HANDLER: Loop the list of returned hashes and compare each entry with the calculated message hash
            alt Hash matched
                FULF_HANDLER -> TOPIC_EVENT: Publish event information (for duplicate) ( Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} )
                FULF_HANDLER -> POS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                POS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate POS_DAO
                alt transferFulfilment.isValid == 0
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error handling:</b> 3106</color>
                    end
                else transferState IN ['COMMITTED', 'ABORTED']
                    break
                        ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Send notification to Participant (Payee) {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg 1.1.4.a]]} \n
                    end
                else transferState NOT 'RESERVED'
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error code:</b> 2001</color>
                    end
                else
                    break
                        FULF_HANDLER <-> FULF_HANDLER: Allow previous request to complete
                    end
                end
            else Hash not matched
                FULF_HANDLER -> POS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return success
                deactivate POS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Fetch from database
            activate DB
            hnote over DB #lightyellow
                transfer
            end note
            DB - -> POS_DAO
            deactivate DB
            FULF_HANDLER <- - POS_DAO: Return transfer
            deactivate POS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
            FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

            opt Transfer.ilpCondition validate successful
                group Request current Settlement Window
                    FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    DB - -> POS_DAO
                    deactivate DB
                    FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                    deactivate POS_DAO
                end
            end

            group Persist fulfilment
                FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - POS_DAO: Return success
                deactivate POS_DAO
            end

            alt Transfer.ilpCondition validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    POS_DAO - -> FULF_HANDLER: Return success
                    deactivate POS_DAO
                end

                note right of FULF_HANDLER #yellow
                    Message:
                    {
                        id: <ID>,
                        from: <transferHeaders.FSPIOP-Source>,
                        to: <transferHeaders.FSPIOP-Destination>,
                        type: application/json,
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: position,
                                action: commit,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0
                                }
                            }
                        }
                    }
                end note
                FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
                    activate TOPIC_NOTIFICATIONS
                    deactivate TOPIC_NOTIFICATIONS
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>