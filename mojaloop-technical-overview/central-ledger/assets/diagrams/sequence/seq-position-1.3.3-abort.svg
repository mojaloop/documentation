<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4268px" preserveAspectRatio="none" style="width:1646px;height:4268px;" version="1.1" viewBox="0 0 1646 4268" width="1646px" zoomAndPan="magnify"><defs><filter height="300%" id="fhc4fk3mpusav" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="684.5" y="23.5352">1.3.3. Abort Position Handler Consume</text><rect fill="#FFFFE0" height="4223.0039" style="stroke: #A80036; stroke-width: 1.0;" width="1380" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="678.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4055.7168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="1569.7832"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="3030.4766"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="4130.0039"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="211.5293"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="517.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="516.9453"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1675.7148"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="183.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1965.8203"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="3136.4082"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="183.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="3411.2031"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="240.8398"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="570.5664"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="704.8086"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="812.7402"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1705.0254"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2019.4414"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3165.7188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3464.8242"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4041.7168" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1450.1855" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="622.1426" style="stroke: #000000; stroke-width: 2.0;" width="1582" x="33" y="420.7031"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="474.5898" style="stroke: #000000; stroke-width: 2.0;" width="746" x="859" y="531.9453"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1446.6934" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="1621.7832"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="288.1055" style="stroke: #000000; stroke-width: 2.0;" width="1449" x="33" y="1869.5781"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="140.5527" style="stroke: #000000; stroke-width: 2.0;" width="613" x="859" y="1980.8203"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="815.1719" style="stroke: #000000; stroke-width: 2.0;" width="472" x="102" y="2171.6836"/><rect fill="#FFFFFF" height="406.4082" style="stroke: none; stroke-width: 1.0;" width="472" x="102" y="2580.4473"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1085.5273" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="3082.4766"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="288.1055" style="stroke: #000000; stroke-width: 2.0;" width="1449" x="33" y="3314.9609"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="140.5527" style="stroke: #000000; stroke-width: 2.0;" width="613" x="859" y="3426.2031"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="4192.0039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="785" x2="785" y1="116.2871" y2="4192.0039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="917" x2="917" y1="116.2871" y2="4192.0039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1367" x2="1367" y1="116.2871" y2="4192.0039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="4204.5391">Position Handler</text><ellipse cx="102.5" cy="4223.4922" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,4211.4922,104.5,4206.4922,102.5,4211.4922,104.5,4216.4922,98.5,4211.4922" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="716" y="76.7988"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="712" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="719" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="716" y="4191.0039"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="712" y="4195.0039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="719" y="4215.5391">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="869" y="113.334">Position DAO</text><ellipse cx="917" cy="83.7988" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="905" x2="929" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="869" y="4204.5391">Position DAO</text><ellipse cx="917" cy="4223.4922" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="905" x2="929" y1="4237.4922" y2="4237.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="113.334">Central Store</text><path d="M1349,63.7988 C1349,53.7988 1367,53.7988 1367,53.7988 C1367,53.7988 1385,53.7988 1385,63.7988 L1385,89.7988 C1385,99.7988 1367,99.7988 1367,99.7988 C1367,99.7988 1349,99.7988 1349,89.7988 L1349,63.7988 " fill="#FEFECE" filter="url(#fhc4fk3mpusav)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,63.7988 C1349,73.7988 1367,73.7988 1367,73.7988 C1367,73.7988 1385,73.7988 1385,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="4204.5391">Central Store</text><path d="M1349,4217.4922 C1349,4207.4922 1367,4207.4922 1367,4207.4922 C1367,4207.4922 1385,4207.4922 1385,4217.4922 L1385,4243.4922 C1385,4253.4922 1367,4253.4922 1367,4253.4922 C1367,4253.4922 1349,4253.4922 1349,4243.4922 L1349,4217.4922 " fill="#FEFECE" filter="url(#fhc4fk3mpusav)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,4217.4922 C1349,4227.4922 1367,4227.4922 1367,4227.4922 C1367,4227.4922 1385,4227.4922 1385,4217.4922 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4055.7168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="1569.7832"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="3030.4766"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="4130.0039"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="211.5293"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="517.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="516.9453"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1675.7148"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="183.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1965.8203"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="3136.4082"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="183.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="3411.2031"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="240.8398"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="570.5664"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="704.8086"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="812.7402"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1705.0254"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2019.4414"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3165.7188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="3464.8242"/><path d="M13,133.2871 L278,133.2871 L278,140.2871 L268,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4041.7168" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="146.8555">Abort Position Handler Consume</text><path d="M23,157.5977 L90,157.5977 L90,164.5977 L80,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1450.1855" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="171.166">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="105" y="170.2324">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="900,207.5293,910,211.5293,900,215.5293,904,211.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="211.5293" y2="211.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="199.1318">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="206.7871">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="206.7871">2003</text><polygon fill="#A80036" points="1350,236.8398,1360,240.8398,1350,244.8398,1354,240.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="240.8398" y2="240.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="929" y="236.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="942" y="236.0977">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1301,253.8398,1432,253.8398,1442,272.8398,1432,291.8398,1301,291.8398,1291,272.8398,1301,253.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="270.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1303" y="285.7188">transferParticipant</text><polygon fill="#A80036" points="933,314.7715,923,318.7715,933,322.7715,929,318.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="318.7715" y2="318.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="314.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="952" y="314.0293">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,344.082,108.5,348.082,118.5,352.082,114.5,348.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="348.082" y2="348.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="343.3398">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="343.3398">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="392.7031" y2="392.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="392.7031" y2="405.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="405.7031" y2="405.7031"/><polygon fill="#A80036" points="118.5,401.7031,108.5,405.7031,118.5,409.7031,114.5,405.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="380.3057">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="127.5" y="372.6504">Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="387.9609">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="387.9609">2001</text><path d="M33,420.7031 L363,420.7031 L363,427.7031 L353,437.7031 L33,437.7031 L33,420.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="622.1426" style="stroke: #000000; stroke-width: 2.0;" width="1582" x="33" y="420.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="48" y="434.2715">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="459.3242" y2="459.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="459.3242" y2="472.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="472.3242" y2="472.3242"/><polygon fill="#A80036" points="118.5,468.3242,108.5,472.3242,118.5,476.3242,114.5,472.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="454.582">6</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="127.5" y="454.582">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="231.5" y="454.582">= 'EXPIRED_RESERVED'</text><polygon fill="#A80036" points="900,512.9453,910,516.9453,900,520.9453,904,516.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="516.9453" y2="516.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="504.5479">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="127.5" y="496.8926">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="512.2031">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="512.2031">2003</text><path d="M859,531.9453 L1151,531.9453 L1151,538.9453 L1141,548.9453 L859,548.9453 L859,531.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="474.5898" style="stroke: #000000; stroke-width: 2.0;" width="746" x="859" y="531.9453"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="874" y="545.5137">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1350,566.5664,1360,570.5664,1350,574.5664,1354,570.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="570.5664" y2="570.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="929" y="565.8242">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="942" y="565.8242">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1305,583.5664,1428,583.5664,1438,594.5664,1428,606.5664,1305,606.5664,1295,594.5664,1305,583.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1307" y="600.1348">participantPosition</text><polygon fill="#A80036" points="933,629.1875,923,633.1875,933,637.1875,929,633.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="633.1875" y2="633.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="628.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="952" y="628.4453">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="964" y1="662.498" y2="662.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="964" x2="964" y1="662.498" y2="675.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="923" x2="964" y1="675.498" y2="675.498"/><polygon fill="#A80036" points="933,671.498,923,675.498,933,679.498,929,675.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="657.7559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="951" y="657.7559">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1045" y="657.7559">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1350,700.8086,1360,704.8086,1350,708.8086,1354,704.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="704.8086" y2="704.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="700.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="951" y="700.0664">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1274,747.8086,1459,747.8086,1469,766.8086,1459,785.8086,1274,785.8086,1264,766.8086,1274,747.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1276" y="764.377">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1330" y="764.377">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1276" y="779.6875">SET value = latestPosition</text><polygon fill="#A80036" points="1350,808.7402,1360,812.7402,1350,816.7402,1354,812.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="812.7402" y2="812.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="807.998">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="951" y="807.998">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1148,855.7402,1585,855.7402,1595,927.7402,1585,1000.7402,1148,1000.7402,1138,927.7402,1148,855.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1150" y="872.3086">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1198" y="872.3086">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1341" y="872.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="1150" y="887.6191">VALUES (transferStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1154" y="902.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1150" y="918.2402">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1198" y="918.2402">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1150" y="933.5508">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1150" y="948.8613">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1150" y="964.1719">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1150" y="979.4824">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1150" y="994.793">createdDate = new Date()</text><polygon fill="#A80036" points="118.5,1030.8457,108.5,1034.8457,118.5,1038.8457,114.5,1034.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="1034.8457" y2="1034.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1030.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="1030.1035">Return success</text><path d="M112,1054.8457 L112,1523.8457 L516,1523.8457 L516,1064.8457 L506,1054.8457 L112,1054.8457 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,1054.8457 L506,1064.8457 L516,1064.8457 L506,1054.8457 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1072.4141">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1087.7246">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1103.0352">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1118.3457">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1133.6563">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1148.9668">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1164.2773">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="1179.5879">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="1194.8984">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="1210.209">"errorCode": 3300,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="186" y="1225.5195">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="1240.8301">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="1256.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1271.4512">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1286.7617">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1302.0723">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1317.3828">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1332.6934">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1348.0039">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="1363.3145">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="1378.625">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1393.9355">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1409.2461">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="1424.5566">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="1439.8672">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="1455.1777">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1470.4883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1485.7988">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1501.1094">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1516.4199">}</text><polygon fill="#A80036" points="768.5,1565.7832,778.5,1569.7832,768.5,1573.7832,772.5,1569.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="1569.7832" y2="1569.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1557.3857">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="1549.7305">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1565.041">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1565.041">2003</text><path d="M23,1621.7832 L90,1621.7832 L90,1628.7832 L80,1638.7832 L23,1638.7832 L23,1621.7832 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1446.6934" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="1621.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1635.3516">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="105" y="1634.418">[type == 'position' &amp;&amp; (action IN ['reject', 'abort'])]</text><polygon fill="#A80036" points="900,1671.7148,910,1675.7148,900,1679.7148,904,1675.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="1675.7148" y2="1675.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1663.3174">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="1655.6621">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1670.9727">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1670.9727">2003</text><polygon fill="#A80036" points="1350,1701.0254,1360,1705.0254,1350,1709.0254,1354,1705.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="1705.0254" y2="1705.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="1700.2832">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="951" y="1700.2832">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1301,1718.0254,1432,1718.0254,1442,1729.0254,1432,1741.0254,1301,1741.0254,1291,1729.0254,1301,1718.0254" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="1734.5938">transferStateChange</text><polygon fill="#A80036" points="933,1763.6465,923,1767.6465,933,1771.6465,929,1767.6465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="1767.6465" y2="1767.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1762.9043">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="961" y="1762.9043">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,1792.957,108.5,1796.957,118.5,1800.957,114.5,1796.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="1796.957" y2="1796.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1792.2148">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="1792.2148">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1841.5781" y2="1841.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1841.5781" y2="1854.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1854.5781" y2="1854.5781"/><polygon fill="#A80036" points="118.5,1850.5781,108.5,1854.5781,118.5,1858.5781,114.5,1854.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1829.1807">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="637" x="136.5" y="1821.5254">Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1836.8359">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1836.8359">2001</text><path d="M33,1869.5781 L363,1869.5781 L363,1876.5781 L353,1886.5781 L33,1886.5781 L33,1869.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="288.1055" style="stroke: #000000; stroke-width: 2.0;" width="1449" x="33" y="1869.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="48" y="1883.1465">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1908.1992" y2="1908.1992"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1908.1992" y2="1921.1992"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1921.1992" y2="1921.1992"/><polygon fill="#A80036" points="118.5,1917.1992,108.5,1921.1992,118.5,1925.1992,114.5,1921.1992" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1903.457">20</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="136.5" y="1903.457">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="240.5" y="1903.457">= (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )</text><polygon fill="#A80036" points="900,1961.8203,910,1965.8203,900,1969.8203,904,1965.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="1965.8203" y2="1965.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1953.4229">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="1945.7676">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1961.0781">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1961.0781">2003</text><path d="M859,1980.8203 L1253,1980.8203 L1253,1987.8203 L1243,1997.8203 L859,1997.8203 L859,1980.8203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="140.5527" style="stroke: #000000; stroke-width: 2.0;" width="613" x="859" y="1980.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="874" y="1994.3887">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="931" y="1994.3887">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="1182" y="1994.3887">above</text><polygon fill="#A80036" points="1350,2015.4414,1360,2019.4414,1350,2023.4414,1354,2019.4414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="2019.4414" y2="2019.4414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="2014.6992">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="951" y="2014.6992">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1282,2062.4414,1452,2062.4414,1462,2088.4414,1452,2115.4414,1282,2115.4414,1272,2088.4414,1282,2062.4414" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1284" y="2079.0098">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1284" y="2094.3203">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1284" y="2109.6309">participantPositionChange</text><polygon fill="#A80036" points="118.5,2145.6836,108.5,2149.6836,118.5,2153.6836,114.5,2149.6836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="2149.6836" y2="2149.6836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2144.9414">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2144.9414">Return success</text><path d="M102,2171.6836 L164,2171.6836 L164,2178.6836 L154,2188.6836 L102,2188.6836 L102,2171.6836 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="815.1719" style="stroke: #000000; stroke-width: 2.0;" width="472" x="102" y="2171.6836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="117" y="2185.252">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="179" y="2184.3184">[action == 'reject']</text><path d="M112,2193.9941 L112,2570.9941 L396,2570.9941 L396,2203.9941 L386,2193.9941 L112,2193.9941 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M386,2193.9941 L386,2203.9941 L396,2203.9941 L386,2193.9941 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2211.5625">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2226.873">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2242.1836">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2257.4941">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2272.8047">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2288.1152">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2303.4258">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2318.7363">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2334.0469">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2349.3574">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2364.668">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2379.9785">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2395.2891">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="2410.5996">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="166" y="2425.9102">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2441.2207">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2456.5313">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2471.8418">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="182" y="2487.1523">code: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="182" y="2502.4629">description: "action successful"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2517.7734">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2533.084">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2548.3945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2563.7051">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102" x2="574" y1="2581.4473" y2="2581.4473"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="107" y="2592.082">[action == 'abort']</text><path d="M112,2600.4023 L112,2977.4023 L560,2977.4023 L560,2610.4023 L550,2600.4023 L112,2600.4023 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M550,2600.4023 L550,2610.4023 L560,2610.4023 L550,2600.4023 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2617.9707">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2633.2813">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2648.5918">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2663.9023">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2679.2129">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2694.5234">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2709.834">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2725.1445">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2740.4551">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2755.7656">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2771.0762">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2786.3867">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2801.6973">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="2817.0078">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="2832.3184">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2847.6289">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2862.9395">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="2878.25">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="182" y="2893.5605">code: &lt;payload.errorInformation.errorCode || 5000&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="182" y="2908.8711">description: &lt;payload.errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2924.1816">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2939.4922">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2954.8027">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2970.1133">}</text><polygon fill="#A80036" points="768.5,3026.4766,778.5,3030.4766,768.5,3034.4766,772.5,3030.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="3030.4766" y2="3030.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3018.0791">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="3010.4238">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3025.7344">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3025.7344">2003</text><path d="M23,3082.4766 L90,3082.4766 L90,3089.4766 L80,3099.4766 L23,3099.4766 L23,3082.4766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1085.5273" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="23" y="3082.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="3096.0449">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="455" x="105" y="3095.1113">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="900,3132.4082,910,3136.4082,900,3140.4082,904,3136.4082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="3136.4082" y2="3136.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3124.0107">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="3116.3555">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3131.666">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3131.666">2003</text><polygon fill="#A80036" points="1350,3161.7188,1360,3165.7188,1350,3169.7188,1354,3165.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="3165.7188" y2="3165.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="3160.9766">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="951" y="3160.9766">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1301,3178.7188,1432,3178.7188,1442,3189.7188,1432,3201.7188,1301,3201.7188,1291,3189.7188,1301,3178.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="3195.2871">transferStateChange</text><polygon fill="#A80036" points="933,3224.3398,923,3228.3398,933,3232.3398,929,3228.3398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="3228.3398" y2="3228.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="3223.5977">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="961" y="3223.5977">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,3253.6504,108.5,3257.6504,118.5,3261.6504,114.5,3257.6504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="3257.6504" y2="3257.6504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="3252.9082">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="3252.9082">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="3286.9609" y2="3286.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="3286.9609" y2="3299.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="3299.9609" y2="3299.9609"/><polygon fill="#A80036" points="118.5,3295.9609,108.5,3299.9609,118.5,3303.9609,114.5,3299.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3282.2188">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="136.5" y="3282.2188">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,3314.9609 L363,3314.9609 L363,3321.9609 L353,3331.9609 L33,3331.9609 L33,3314.9609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="288.1055" style="stroke: #000000; stroke-width: 2.0;" width="1449" x="33" y="3314.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="48" y="3328.5293">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="3353.582" y2="3353.582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="3353.582" y2="3366.582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="3366.582" y2="3366.582"/><polygon fill="#A80036" points="118.5,3362.582,108.5,3366.582,118.5,3370.582,114.5,3366.582" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3348.8398">30</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="136.5" y="3348.8398">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="240.5" y="3348.8398">= 'FAILED'</text><polygon fill="#A80036" points="900,3407.2031,910,3411.2031,900,3415.2031,904,3411.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="3411.2031" y2="3411.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3398.8057">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="3391.1504">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3406.4609">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3406.4609">2003</text><path d="M859,3426.2031 L1253,3426.2031 L1253,3433.2031 L1243,3443.2031 L859,3443.2031 L859,3426.2031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="140.5527" style="stroke: #000000; stroke-width: 2.0;" width="613" x="859" y="3426.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="874" y="3439.7715">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="931" y="3439.7715">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="1182" y="3439.7715">above</text><polygon fill="#A80036" points="1350,3460.8242,1360,3464.8242,1350,3468.8242,1354,3464.8242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="3464.8242" y2="3464.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="3460.082">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="951" y="3460.082">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1282,3507.8242,1452,3507.8242,1462,3533.8242,1452,3560.8242,1282,3560.8242,1272,3533.8242,1282,3507.8242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1284" y="3524.3926">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1284" y="3539.7031">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1284" y="3555.0137">participantPositionChange</text><polygon fill="#A80036" points="118.5,3591.0664,108.5,3595.0664,118.5,3599.0664,114.5,3595.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="3595.0664" y2="3595.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="3590.3242">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="3590.3242">Return success</text><path d="M112,3615.0664 L112,4084.0664 L516,4084.0664 L516,3625.0664 L506,3615.0664 L112,3615.0664 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,3615.0664 L506,3625.0664 L516,3625.0664 L506,3615.0664 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="3632.6348">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="3647.9453">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="3663.2559">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="3678.5664">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="3693.877">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="3709.1875">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="3724.498">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="3739.8086">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="3755.1191">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="3770.4297">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="186" y="3785.7402">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="3801.0508">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="3816.3613">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="3831.6719">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="3846.9824">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="3862.293">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3877.6035">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3892.9141">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3908.2246">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="3923.5352">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="3938.8457">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3954.1563">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3969.4668">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3984.7773">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="4000.0879">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="4015.3984">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="4030.709">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="4046.0195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="4061.3301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="4076.6406">}</text><polygon fill="#A80036" points="768.5,4126.0039,778.5,4130.0039,768.5,4134.0039,772.5,4130.0039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="4130.0039" y2="4130.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="4117.6064">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="4109.9512">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="4125.2617">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="4125.2617">2003</text><!--
@startuml
title 1.3.3. Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'EXPIRED_RESERVED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** 
                        VALUES (transferStateId)

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3300,
                             "errorDescription": "Transfer expired",
                             "extensionList": <transferMessage.extensionList>
                         }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
    opt type == 'position' && (action IN ['reject', 'abort'])
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        alt action == 'reject'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: reject,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0,
                                description: "action successful"
                            }
                        }
                    }
                }
            end note
        else action == 'abort'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <payload.errorInformation.errorCode || 5000>
                                description: <payload.errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
        end
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end

    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'FAILED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>