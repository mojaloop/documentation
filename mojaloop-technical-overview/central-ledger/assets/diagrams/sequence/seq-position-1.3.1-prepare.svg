<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3796px" preserveAspectRatio="none" style="width:2116px;height:3796px;" version="1.1" viewBox="0 0 2116 3796" width="2116px" zoomAndPan="magnify"><defs><filter height="300%" id="f8pakrkej6bwb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="293" x="912.5" y="23.5352">1.3.1. Prepare Position Handler Consume</text><rect fill="#FFFFE0" height="3751.2617" style="stroke: #A80036; stroke-width: 1.0;" width="1819.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="898.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="3524.0215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="422.5" y="2774.5977"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="422.5" y="3639.2852"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="2123.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="553.5" y="190.8848"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2927.7949"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="375.0586"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="848.2012"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="997.7539"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1105.6855"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1809.9336"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1933.1758"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="2214.5918"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="3011.7266"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="3532.0215" style="stroke: #000000; stroke-width: 2.0;" width="2092" x="13" y="152.2637"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="2037.707" style="stroke: #000000; stroke-width: 2.0;" width="1594" x="501" y="248.1953"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="1348.0723" style="stroke: #000000; stroke-width: 2.0;" width="1879" x="23" y="2329.2129"/><rect fill="#FFFFFF" height="864.6875" style="stroke: none; stroke-width: 1.0;" width="1879" x="23" y="2812.5977"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="1859" x="33" y="2873.8633"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="135.2637" y2="3701.2852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="427" x2="427" y1="135.2637" y2="3701.2852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="558" x2="558" y1="135.2637" y2="3701.2852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1434.5" x2="1434.5" y1="135.2637" y2="3701.2852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1806.5" x2="1806.5" y1="135.2637" y2="3701.2852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="132.3105">Position Handler</text><ellipse cx="102.5" cy="102.7754" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,90.7754,104.5,85.7754,102.5,90.7754,104.5,95.7754,98.5,90.7754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3713.8203">Position Handler</text><ellipse cx="102.5" cy="3732.7734" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3720.7734,104.5,3715.7734,102.5,3720.7734,104.5,3725.7734,98.5,3720.7734" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f8pakrkej6bwb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="358" y="95.7754"/><rect fill="#FEFECE" filter="url(#f8pakrkej6bwb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="354" y="99.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="361" y="120.3105">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f8pakrkej6bwb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="358" y="3700.2852"/><rect fill="#FEFECE" filter="url(#f8pakrkej6bwb)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="354" y="3704.2852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="361" y="3724.8203">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="528" y="99.334">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="511" y="115.8223">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="531.5" y="132.3105">Facade</text><ellipse cx="558.5" cy="69.7988" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="546.5" x2="570.5" y1="83.7988" y2="83.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="528" y="3713.8203">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="511" y="3730.3086">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="531.5" y="3746.7969">Facade</text><ellipse cx="558.5" cy="3765.75" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="546.5" x2="570.5" y1="3779.75" y2="3779.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1386.5" y="132.3105">Position DAO</text><ellipse cx="1434.5" cy="102.7754" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1422.5" x2="1446.5" y1="116.7754" y2="116.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1386.5" y="3713.8203">Position DAO</text><ellipse cx="1434.5" cy="3732.7734" fill="#FEFECE" filter="url(#f8pakrkej6bwb)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1422.5" x2="1446.5" y1="3746.7734" y2="3746.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1758.5" y="132.3105">Central Store</text><path d="M1788.5,82.7754 C1788.5,72.7754 1806.5,72.7754 1806.5,72.7754 C1806.5,72.7754 1824.5,72.7754 1824.5,82.7754 L1824.5,108.7754 C1824.5,118.7754 1806.5,118.7754 1806.5,118.7754 C1806.5,118.7754 1788.5,118.7754 1788.5,108.7754 L1788.5,82.7754 " fill="#FEFECE" filter="url(#f8pakrkej6bwb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1788.5,82.7754 C1788.5,92.7754 1806.5,92.7754 1806.5,92.7754 C1806.5,92.7754 1824.5,92.7754 1824.5,82.7754 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1758.5" y="3713.8203">Central Store</text><path d="M1788.5,3726.7734 C1788.5,3716.7734 1806.5,3716.7734 1806.5,3716.7734 C1806.5,3716.7734 1824.5,3716.7734 1824.5,3726.7734 L1824.5,3752.7734 C1824.5,3762.7734 1806.5,3762.7734 1806.5,3762.7734 C1806.5,3762.7734 1788.5,3762.7734 1788.5,3752.7734 L1788.5,3726.7734 " fill="#FEFECE" filter="url(#f8pakrkej6bwb)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1788.5,3726.7734 C1788.5,3736.7734 1806.5,3736.7734 1806.5,3736.7734 C1806.5,3736.7734 1824.5,3736.7734 1824.5,3726.7734 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="3524.0215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="422.5" y="2774.5977"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="422.5" y="3639.2852"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="2123.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="553.5" y="190.8848"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2927.7949"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="375.0586"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="848.2012"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="997.7539"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1105.6855"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1809.9336"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="1933.1758"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="2214.5918"/><rect fill="#FFFFFF" filter="url(#f8pakrkej6bwb)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1801.5" y="3011.7266"/><path d="M13,152.2637 L293,152.2637 L293,159.2637 L283,169.2637 L13,169.2637 L13,152.2637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3532.0215" style="stroke: #000000; stroke-width: 2.0;" width="2092" x="13" y="152.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="28" y="165.832">Prepare Position Handler Consume</text><polygon fill="#A80036" points="541.5,186.8848,551.5,190.8848,541.5,194.8848,545.5,190.8848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="547.5" y1="190.8848" y2="190.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="186.1426">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="127.5" y="186.1426">Request transfers to be processed</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="220.1953" y2="220.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="220.1953" y2="233.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="233.1953" y2="233.1953"/><polygon fill="#A80036" points="574.5,229.1953,564.5,233.1953,574.5,237.1953,570.5,233.1953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="215.4531">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="583.5" y="215.4531">Check 1st transfer to select the Participant and Currency</text><path d="M501,248.1953 L666,248.1953 L666,255.1953 L656,265.1953 L501,265.1953 L501,248.1953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2037.707" style="stroke: #000000; stroke-width: 2.0;" width="1594" x="501" y="248.1953"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="516" y="261.7637">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="317.4375" y2="317.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="317.4375" y2="330.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="330.4375" y2="330.4375"/><polygon fill="#A80036" points="574.5,326.4375,564.5,330.4375,574.5,334.4375,570.5,330.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="297.3848">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="583.5" y="282.0742">Loop through batch and build list of transferIds and calculate sumTransfersInBatch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="583.5" y="297.3848">checking all in Batch are for the correct Paricipant and Currency</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="583.5" y="312.6953">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="660.5" y="312.6953">2001, 3100</text><polygon fill="#A80036" points="1789.5,371.0586,1799.5,375.0586,1789.5,379.0586,1793.5,375.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="375.0586" y2="375.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="362.6611">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="583.5" y="355.0059">Retrieve current state of all transfers in array from DB with select whereIn</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1206" x="583.5" y="370.3164">(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE =&gt; RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1741,388.0586,1872,388.0586,1882,407.0586,1872,426.0586,1741,426.0586,1731,407.0586,1741,388.0586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1743" y="404.627">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1743" y="419.9375">transferParticipant</text><polygon fill="#A80036" points="574.5,448.9902,564.5,452.9902,574.5,456.9902,570.5,452.9902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="568.5" x2="1805.5" y1="452.9902" y2="452.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="580.5" y="448.248">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="593.5" y="448.248">Return current state of all selected transfers from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="512.9219" y2="512.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="512.9219" y2="525.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="525.9219" y2="525.9219"/><polygon fill="#A80036" points="574.5,521.9219,564.5,525.9219,574.5,529.9219,570.5,525.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="492.8691">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="583.5" y="477.5586">Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="583.5" y="492.8691">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="660.5" y="492.8691">2001</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="696.5" y="492.8691">against failing transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="583.5" y="508.1797">Batch is not rejected as a whole.</text><path d="M568,538.9219 L568,762.9219 L2055,762.9219 L2055,548.9219 L2045,538.9219 L568,538.9219 " fill="#D3D3D3" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2045,538.9219 L2045,548.9219 L2055,548.9219 L2045,538.9219 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="574" y="556.4902">List of transfers used during processing</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="574" y="571.8008">reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="703" y="571.8008">is list of transfers to be processed in the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="574" y="587.1113">abortedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1202" x="696" y="587.1113">is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="574" y="602.4219">processedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1328" x="712" y="602.4219">is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="578" y="617.7324"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="574" y="633.043">Scalar intermidate values used in the algorithm</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="574" y="648.3535">transferAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="686" y="648.3535">= payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="574" y="663.6641">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="722" y="663.6641">= SUM amount against each Transfer in batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="574" y="678.9746">currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="681" y="678.9746">= participantPosition.value</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="574" y="694.2852">reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="691" y="694.2852">= participantPosition.{original}reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="574" y="709.5957">effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="689" y="709.5957">= currentPosition + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="574" y="724.9063">heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="661" y="724.9063">= effectivePosition + sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="574" y="740.2168">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="692" y="740.2168">= participantLimit(NetDebitCap) - effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="574" y="755.5273">sumReserved</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="670" y="755.5273">= SUM of transfers that have met rule criteria and processed</text><path d="M513,777.2695 L513,817.2695 L1851,817.2695 L1851,787.2695 L1841,777.2695 L513,777.2695 " fill="#FBFB77" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1841,777.2695 L1841,787.2695 L1851,787.2695 L1841,777.2695 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="759" x="796.25" y="794.8379">Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="796.25" y="810.1484">and calculate the available position for the Participant to use</text><polygon fill="#A80036" points="1789.5,844.2012,1799.5,848.2012,1789.5,852.2012,1793.5,848.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="848.2012" y2="848.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="843.459">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="583.5" y="843.459">Select effectivePosition FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1745,861.2012,1868,861.2012,1878,872.2012,1868,884.2012,1745,884.2012,1735,872.2012,1745,861.2012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1747" y="877.7695">participantPosition</text><polygon fill="#A80036" points="574.5,906.8223,564.5,910.8223,574.5,914.8223,570.5,910.8223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="568.5" x2="1805.5" y1="910.8223" y2="910.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="580.5" y="906.0801">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="593.5" y="906.0801">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="955.4434" y2="955.4434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="955.4434" y2="968.4434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="968.4434" y2="968.4434"/><polygon fill="#A80036" points="574.5,964.4434,564.5,968.4434,574.5,972.4434,570.5,968.4434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="570.5" y="943.0459">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="583.5" y="935.3906">Increment reservedValue to heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="583.5" y="950.7012">(reservedValue = reservedPosition + sumTransfersInBatch)</text><polygon fill="#A80036" points="1789.5,993.7539,1799.5,997.7539,1789.5,1001.7539,1793.5,997.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="997.7539" y2="997.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="993.0117">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="592.5" y="993.0117">Persist reservedValue</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1668,1040.7539,1945,1040.7539,1955,1059.7539,1945,1078.7539,1668,1078.7539,1658,1059.7539,1668,1040.7539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1670" y="1057.3223">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1724" y="1057.3223">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1670" y="1072.6328">SET reservedValue += sumTransfersInBatch</text><polygon fill="#A80036" points="1789.5,1101.6855,1799.5,1105.6855,1789.5,1109.6855,1793.5,1105.6855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="1105.6855" y2="1105.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1100.9434">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="592.5" y="1100.9434">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1614,1118.6855,1998,1118.6855,2008,1152.6855,1998,1187.6855,1614,1187.6855,1604,1152.6855,1614,1118.6855" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1616" y="1135.2539">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1656" y="1135.2539">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1616" y="1150.5645">WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1616" y="1165.875">AND participantLimit.participantId = payload.payerFsp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1616" y="1181.1855">AND participantLimit.currencyId = payload.amount.currency</text><polygon fill="#A80036" points="574.5,1210.2383,564.5,1214.2383,574.5,1218.2383,570.5,1214.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="568.5" x2="1805.5" y1="1214.2383" y2="1214.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="580.5" y="1209.4961">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="602.5" y="1209.4961">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="1243.5488" y2="1243.5488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="1243.5488" y2="1256.5488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="1256.5488" y2="1256.5488"/><polygon fill="#A80036" points="574.5,1252.5488,564.5,1256.5488,574.5,1260.5488,570.5,1256.5488" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1238.8066">13</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="592.5" y="1238.8066">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="712" x="710.5" y="1238.8066">= participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)</text><path d="M513,1269.5488 L513,1309.5488 L1851,1309.5488 L1851,1279.5488 L1841,1269.5488 L513,1269.5488 " fill="#FBFB77" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1841,1269.5488 L1841,1279.5488 L1851,1279.5488 L1841,1269.5488 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="877.75" y="1287.1172">For each transfer in the batch, validate the availablility of position to meet the transfer amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="877.75" y="1302.4277">this will be as per the position algorithm documented below</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="1355.791" y2="1355.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="1355.791" y2="1368.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="1368.791" y2="1368.791"/><polygon fill="#A80036" points="574.5,1364.791,564.5,1368.791,574.5,1372.791,570.5,1368.791" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1343.3936">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="592.5" y="1335.7383">Validate availablePosition for each tranfser (see algorithm below)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="592.5" y="1351.0488">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="669.5" y="1351.0488">4001</text><path d="M568,1381.791 L568,1651.791 L1939,1651.791 L1939,1391.791 L1929,1381.791 L568,1381.791 " fill="#D3D3D3" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1929,1381.791 L1929,1391.791 L1939,1391.791 L1929,1381.791 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="574" y="1399.3594">01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="557" x="574" y="1414.6699">02: sumProcessed =0 // Record the sum of the transfers already processed in this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1087" x="574" y="1429.9805">03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="574" y="1445.291">04: foreach transfer in reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="590" y="1460.6016">05: sumProcessed += transfer.amount // the total processed so far</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="1020" y="1460.6016">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="590" y="1475.9121">06: if availablePosition &gt;= transfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="606" y="1491.2227">07: transfer.state = "RESERVED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="606" y="1506.5332">08: availablePosition -= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="606" y="1521.8438">09: sumRESERVED += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="590" y="1537.1543">10: else</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="606" y="1552.4648">11: preparedTransfer.state = "ABORTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="669" x="606" y="1567.7754">12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="590" y="1583.0859">13: end if</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1026" x="590" y="1598.3965">14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="541" x="590" y="1613.707">15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="1135" y="1613.707">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="1328" y="1613.707">// the running down of the total reserved value at the begining of the batch.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1334" x="590" y="1629.0176">16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="574" y="1644.3281">16: end foreach</text><path d="M513,1666.0703 L513,1721.0703 L1851,1721.0703 L1851,1676.0703 L1841,1666.0703 L513,1666.0703 " fill="#FBFB77" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1841,1666.0703 L1841,1676.0703 L1851,1676.0703 L1841,1666.0703 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="860" x="582.75" y="1683.6387">Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="645" x="582.75" y="1698.9492">(If there are any alarm limits, process those returning limits in which the threshold has been breached)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1186" x="582.75" y="1714.2598">Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="1767.623" y2="1767.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="1767.623" y2="1780.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="1780.623" y2="1780.623"/><polygon fill="#A80036" points="574.5,1776.623,564.5,1780.623,574.5,1784.623,570.5,1780.623" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1755.2256">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="592.5" y="1747.5703">Assess any limit thresholds on the final position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="592.5" y="1762.8809">adding to alarm list if triggered</text><polygon fill="#A80036" points="1789.5,1805.9336,1799.5,1809.9336,1789.5,1813.9336,1793.5,1809.9336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="1809.9336" y2="1809.9336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1805.1914">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="592.5" y="1805.1914">Persist latest position</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="733.5" y="1805.1914">value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="774.5" y="1805.1914">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="801.5" y="1805.1914">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="903.5" y="1805.1914">to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1682,1852.9336,1931,1852.9336,1941,1878.9336,1931,1905.9336,1682,1905.9336,1672,1878.9336,1682,1852.9336" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1684" y="1869.502">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1738" y="1869.502">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="1684" y="1884.8125">SET value += sumRESERVED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1684" y="1900.123">reservedValue -= sumTransfersInBatch</text><polygon fill="#A80036" points="1789.5,1929.1758,1799.5,1933.1758,1789.5,1937.1758,1793.5,1933.1758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="1933.1758" y2="1933.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="1928.4336">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="592.5" y="1928.4336">Bulk persist transferStateChange for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1537,1976.1758,2075,1976.1758,2085,2010.1758,2075,2045.1758,1537,2045.1758,1527,2010.1758,1537,1976.1758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1539" y="1992.7441">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1626" y="1992.7441">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="1539" y="2008.0547">select for update from transfer table where transferId in ([transferBatch.transferId,...])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="1539" y="2023.3652">build list of transferStateChanges from transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1543" y="2038.6758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="605.5" y1="2071.7285" y2="2071.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="605.5" y1="2071.7285" y2="2084.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="564.5" x2="605.5" y1="2084.7285" y2="2084.7285"/><polygon fill="#A80036" points="574.5,2080.7285,564.5,2084.7285,574.5,2088.7285,570.5,2084.7285" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="2066.9863">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="745" x="592.5" y="2066.9863">Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list</text><path d="M568,2097.7285 L568,2183.7285 L1051,2183.7285 L1051,2107.7285 L1041,2097.7285 L568,2097.7285 " fill="#D3D3D3" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1041,2097.7285 L1041,2107.7285 L1051,2107.7285 L1041,2097.7285 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="574" y="2115.2969">Effectively:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="446" x="590" y="2130.6074">SET transferStateChangeId = processedTransfer.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="590" y="2145.918">participantPositionId = preparedTransfer.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="590" y="2161.2285">value = preparedTransfer.positionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="590" y="2176.5391">reservedValue = preparedTransfer.positionReservedValue</text><polygon fill="#A80036" points="1789.5,2210.5918,1799.5,2214.5918,1789.5,2218.5918,1793.5,2214.5918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="563.5" x2="1795.5" y1="2214.5918" y2="2214.5918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="570.5" y="2209.8496">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="443" x="592.5" y="2209.8496">Bulk persist the participant position change for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1647,2257.5918,1965,2257.5918,1975,2268.5918,1965,2280.5918,1647,2280.5918,1637,2268.5918,1647,2257.5918" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1649" y="2274.1602">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1736" y="2274.1602">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1963" y="2274.1602"/><polygon fill="#A80036" points="118.5,2310.2129,108.5,2314.2129,118.5,2318.2129,114.5,2314.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="557.5" y1="2314.2129" y2="2314.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2309.4707">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="146.5" y="2309.4707">Return a map of transferIds and their transferStateChanges</text><path d="M23,2329.2129 L85,2329.2129 L85,2336.2129 L75,2346.2129 L23,2346.2129 L23,2329.2129 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1348.0723" style="stroke: #000000; stroke-width: 2.0;" width="1879" x="23" y="2329.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="2342.7813">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="100" y="2341.8477">[Calculate &amp; Validate Latest Position Prepare (success)]</text><path d="M112,2351.5234 L112,2728.5234 L374,2728.5234 L374,2361.5234 L364,2351.5234 L112,2351.5234 " fill="#FFFF00" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,2351.5234 L364,2361.5234 L374,2361.5234 L364,2351.5234 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="2369.0918">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2384.4023">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2399.7129">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2415.0234">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2430.334">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2445.6445">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2460.9551">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2476.2656">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2491.5762">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2506.8867">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2522.1973">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2537.5078">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2552.8184">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2568.1289">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2583.4395">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="166" y="2598.75">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2614.0605">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2629.3711">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2644.6816">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2659.9922">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2675.3027">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2690.6133">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2705.9238">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2721.2344">}</text><polygon fill="#A80036" points="410.5,2770.5977,420.5,2774.5977,410.5,2778.5977,414.5,2774.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="416.5" y1="2774.5977" y2="2774.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2762.2002">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="2754.5449">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2769.8555">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2769.8555">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1902" y1="2813.5977" y2="2813.5977"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="28" y="2824.2324">[Calculate &amp; Validate Latest Position Prepare (failure)]</text><path d="M112,2832.5527 L112,2857.5527 L244,2857.5527 L244,2842.5527 L234,2832.5527 L112,2832.5527 " fill="#FF0000" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M234,2832.5527 L234,2842.5527 L244,2842.5527 L234,2832.5527 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="118" y="2850.1211">Validation failure!</text><path d="M33,2873.8633 L584,2873.8633 L584,2880.8633 L574,2890.8633 L33,2890.8633 L33,2873.8633 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="1859" x="33" y="2873.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="506" x="48" y="2887.4316">Persist Transfer State (with transferState='ABORTED' on position check fail)</text><polygon fill="#A80036" points="1417.5,2923.7949,1427.5,2927.7949,1417.5,2931.7949,1421.5,2927.7949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1423.5" y1="2927.7949" y2="2927.7949"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2915.3975">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="136.5" y="2907.7422">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2923.0527">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2923.0527">2003</text><path d="M112,2940.7949 L112,2980.7949 L798,2980.7949 L798,2950.7949 L788,2940.7949 L112,2940.7949 " fill="#D3D3D3" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M788,2940.7949 L788,2950.7949 L798,2950.7949 L788,2940.7949 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="118" y="2958.3633">transferStateChange.state = "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="665" x="118" y="2973.6738">transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><polygon fill="#A80036" points="1789.5,3007.7266,1799.5,3011.7266,1789.5,3015.7266,1793.5,3011.7266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1795.5" y1="3011.7266" y2="3011.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="3006.9844">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1468.5" y="3006.9844">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f8pakrkej6bwb)" points="1741,3054.7266,1872,3054.7266,1882,3065.7266,1872,3077.7266,1741,3077.7266,1731,3065.7266,1741,3054.7266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1743" y="3071.2949">transferStateChange</text><polygon fill="#A80036" points="118.5,3100.3477,108.5,3104.3477,118.5,3108.3477,114.5,3104.3477" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1433.5" y1="3104.3477" y2="3104.3477"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="3099.6055">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="3099.6055">Return success</text><path d="M112,3124.3477 L112,3593.3477 L522,3593.3477 L522,3134.3477 L512,3124.3477 L112,3124.3477 " fill="#FFFF00" filter="url(#f8pakrkej6bwb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,3124.3477 L512,3134.3477 L522,3134.3477 L512,3124.3477 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="3141.916">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3157.2266">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="3172.5371">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="134" y="3187.8477">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="3203.1582">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="3218.4688">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="3233.7793">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="3249.0898">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="3264.4004">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="166" y="3279.7109">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="182" y="3295.0215">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="182" y="3310.332">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="182" y="3325.6426">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3340.9531">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="3356.2637">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="3371.5742">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3386.8848">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3402.1953">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3417.5059">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="3432.8164">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="166" y="3448.127">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3463.4375">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3478.748">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3494.0586">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3509.3691">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3524.6797">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3539.9902">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3555.3008">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3570.6113">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3585.9219">}</text><polygon fill="#A80036" points="410.5,3635.2852,420.5,3639.2852,410.5,3643.2852,414.5,3639.2852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="416.5" y1="3639.2852" y2="3639.2852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3626.8877">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="136.5" y="3619.2324">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3634.543">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3634.543">2003</text><!--
@startuml
title 1.3.1. Prepare Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER

entity "Position\nManagement\nFacade" as POS_MGMT
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_MGMT
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Prepare Position Handler Consume
    POS_HANDLER -> POS_MGMT: Request transfers to be processed
    activate POS_MGMT
    POS_MGMT -> POS_MGMT: Check 1st transfer to select the Participant and Currency
    group <color #blue>DB TRANSACTION</color>
        POS_MGMT -> POS_MGMT: Loop through batch and build list of transferIds and calculate sumTransfersInBatch,\nchecking all in Batch are for the correct Paricipant and Currency\n<color #FF0000><b>Error code:</b> 2001, 3100</color>
        POS_MGMT -> DB: Retrieve current state of all transfers in array from DB with select whereIn\n(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE => RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_MGMT: Return current state of all selected transfers from DB
        deactivate DB
        POS_MGMT <-> POS_MGMT: Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')\n<color #FF0000><b>Error code:</b> 2001</color> against failing transfers\nBatch is not rejected as a whole.

        note right of POS_MGMT #lightgray
            List of transfers used during processing
            **reservedTransfers** is list of transfers to be processed in the batch
            **abortedTransfers** is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)
            **processedTransfers** is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation

            Scalar intermidate values used in the algorithm
            **transferAmount** = payload.amount.amount
            **sumTransfersInBatch** = SUM amount against each Transfer in batch
            **currentPosition** = participantPosition.value
            **reservedPosition** = participantPosition.{original}reservedValue
            **effectivePosition** = currentPosition + reservedPosition
            **heldPosition** = effectivePosition + sumTransfersInBatch
            **availablePosition** = participantLimit(NetDebitCap) - effectivePosition
            **sumReserved** = SUM of transfers that have met rule criteria and processed
        end note
        note over POS_MGMT,DB
            Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch
            and calculate the available position for the Participant to use
        end note
        POS_MGMT -> DB: Select effectivePosition FOR UPDATE from DB for Payer 
        activate DB
        hnote over DB #lightyellow
            participantPosition
        end note
        DB - -> POS_MGMT: Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
        deactivate DB
        POS_MGMT -> POS_MGMT: Increment reservedValue to heldPosition\n(reservedValue = reservedPosition + sumTransfersInBatch)
        POS_MGMT -> DB: Persist reservedValue
        activate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET reservedValue += sumTransfersInBatch
        end note
        deactivate DB
        
        
        POS_MGMT -> DB: Request position limits for Payer Participant
        activate DB
        hnote over DB #lightyellow
            FROM **participantLimit**
            WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'
            AND participantLimit.participantId = payload.payerFsp
            AND participantLimit.currencyId = payload.amount.currency
        end note
        DB - -> POS_MGMT: Return position limits
        deactivate DB
        POS_MGMT <-> POS_MGMT: **availablePosition** = participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)
        note over POS_MGMT,DB
            For each transfer in the batch, validate the availablility of position to meet the transfer amount
            this will be as per the position algorithm documented below
        end note
        POS_MGMT <-> POS_MGMT: Validate availablePosition for each tranfser (see algorithm below)\n<color #FF0000><b>Error code:</b> 4001</color>
        note right of POS_MGMT #lightgray
            01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED 
            02: sumProcessed =0 // Record the sum of the transfers already processed in this batch
            03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position
            04: foreach transfer in reservedTransfers
                05: sumProcessed += transfer.amount // the total processed so far **(NEED TO UPDATE IN CODE)**
                06: if availablePosition >= transfer.amount
                    07: transfer.state = "RESERVED"
                    08: availablePosition -= preparedTransfer.amount
                    09: sumRESERVED += preparedTransfer.amount
                10: else
                    11: preparedTransfer.state = "ABORTED"
                    12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
                13: end if
                14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far
                15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition **(NEED TO UPDATE IN CODE)** // the running down of the total reserved value at the begining of the batch.
                16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }
            16: end foreach
        end note
        note over POS_MGMT,DB
            Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch
            (If there are any alarm limits, process those returning limits in which the threshold has been breached)
            Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position
        end note
        POS_MGMT->POS_MGMT: Assess any limit thresholds on the final position\nadding to alarm list if triggered
        
        POS_MGMT->DB: Persist latest position **value** and **reservedValue** to DB for Payer
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value += sumRESERVED,
                reservedValue -= sumTransfersInBatch
            end note
            activate DB
            deactivate DB

        POS_MGMT -> DB: Bulk persist transferStateChange for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **transferStateChange**
                select for update from transfer table where transferId in ([transferBatch.transferId,...])
                build list of transferStateChanges from transferBatch
                
        end note
        activate DB
        deactivate DB
        
        POS_MGMT->POS_MGMT: Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list

        note right of POS_MGMT #lightgray
            Effectively:  
                SET transferStateChangeId = processedTransfer.transferStateChangeId,
                participantPositionId = preparedTransfer.participantPositionId,
                value = preparedTransfer.positionValue,
                reservedValue = preparedTransfer.positionReservedValue
        end note
        POS_MGMT -> DB: Bulk persist the participant position change for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **participantPositionChange**            
        end note
        activate DB
        deactivate DB
    end
    POS_MGMT - -> POS_HANDLER: Return a map of transferIds and their transferStateChanges
    deactivate POS_MGMT
    alt Calculate & Validate Latest Position Prepare (success)
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
   else Calculate & Validate Latest Position Prepare (failure)
        note right of POS_HANDLER #red: Validation failure!

        group Persist Transfer State (with transferState='ABORTED' on position check fail)
            POS_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            note right of POS_HANDLER #lightgray
                transferStateChange.state = "ABORTED",
                transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            end note
            POS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
   end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>