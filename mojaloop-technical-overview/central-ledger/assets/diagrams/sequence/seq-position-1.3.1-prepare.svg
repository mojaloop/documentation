<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4971px" preserveAspectRatio="none" style="width:2377px;height:4971px;" version="1.1" viewBox="0 0 2377 4971" width="2377px" zoomAndPan="magnify"><defs><filter height="300%" id="f1mgx3c2h27js1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="712" x="833.5" y="23.5352">1.3.1. Prepare Position Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="4925.668" style="stroke: #A80036; stroke-width: 1.0;" width="2080.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="1028.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="4720.4277" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2123.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="814.5" y="190.8848"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1690.5" y="2519.3418"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="375.0586"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="848.2012"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="997.7539"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1105.6855"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1809.9336"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1933.1758"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="2214.5918"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="2603.2734"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2623.252" style="stroke: #000000; stroke-width: 2.0;" width="2353" x="13" y="152.2637"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2037.707" style="stroke: #000000; stroke-width: 2.0;" width="1594" x="762" y="248.1953"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="439.3027" style="stroke: #000000; stroke-width: 2.0;" width="2140" x="23" y="2329.2129"/><rect fill="#FFFFFF" height="364.3711" style="stroke: none; stroke-width: 1.0;" width="2140" x="23" y="2404.1445"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="2120" x="33" y="2465.4102"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="1119.4512" style="stroke: #000000; stroke-width: 2.0;" width="759" x="23" y="2789.5156"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="1088.1406" style="stroke: #000000; stroke-width: 2.0;" width="739" x="33" y="2813.8262"/><rect fill="#FFFFFF" height="542.8926" style="stroke: none; stroke-width: 1.0;" width="739" x="33" y="3359.0742"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="935.7246" style="stroke: #000000; stroke-width: 2.0;" width="759" x="23" y="3922.9668"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="904.4141" style="stroke: #000000; stroke-width: 2.0;" width="739" x="33" y="3947.2773"/><rect fill="#FFFFFF" height="451.0293" style="stroke: none; stroke-width: 1.0;" width="739" x="33" y="4400.6621"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="135.2637" y2="4875.6914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="501" x2="501" y1="135.2637" y2="4875.6914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="673" x2="673" y1="135.2637" y2="4875.6914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="819" x2="819" y1="135.2637" y2="4875.6914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1695.5" x2="1695.5" y1="135.2637" y2="4875.6914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2067.5" x2="2067.5" y1="135.2637" y2="4875.6914"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="132.3105">Position Handler</text><ellipse cx="102.5" cy="102.7754" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,90.7754,104.5,85.7754,102.5,90.7754,104.5,95.7754,98.5,90.7754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="4888.2266">Position Handler</text><ellipse cx="102.5" cy="4907.1797" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,4895.1797,104.5,4890.1797,102.5,4895.1797,104.5,4900.1797,98.5,4895.1797" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="432" y="95.7754"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="428" y="99.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="435" y="120.3105">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="432" y="4874.6914"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="428" y="4878.6914"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="435" y="4899.2266">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="169" x="589" y="95.7754"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="169" x="585" y="99.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="592" y="120.3105">topic-bulk-processing</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="169" x="589" y="4874.6914"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="169" x="585" y="4878.6914"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="592" y="4899.2266">topic-bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="789" y="99.334">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="772" y="115.8223">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="792.5" y="132.3105">Facade</text><ellipse cx="819.5" cy="69.7988" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="807.5" x2="831.5" y1="83.7988" y2="83.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="789" y="4888.2266">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="772" y="4904.7148">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="792.5" y="4921.2031">Facade</text><ellipse cx="819.5" cy="4940.1563" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="807.5" x2="831.5" y1="4954.1563" y2="4954.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1647.5" y="132.3105">Position DAO</text><ellipse cx="1695.5" cy="102.7754" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1683.5" x2="1707.5" y1="116.7754" y2="116.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1647.5" y="4888.2266">Position DAO</text><ellipse cx="1695.5" cy="4907.1797" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1683.5" x2="1707.5" y1="4921.1797" y2="4921.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="2019.5" y="132.3105">Central Store</text><path d="M2049.5,82.7754 C2049.5,72.7754 2067.5,72.7754 2067.5,72.7754 C2067.5,72.7754 2085.5,72.7754 2085.5,82.7754 L2085.5,108.7754 C2085.5,118.7754 2067.5,118.7754 2067.5,118.7754 C2067.5,118.7754 2049.5,118.7754 2049.5,108.7754 L2049.5,82.7754 " fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2049.5,82.7754 C2049.5,92.7754 2067.5,92.7754 2067.5,92.7754 C2067.5,92.7754 2085.5,92.7754 2085.5,82.7754 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="2019.5" y="4888.2266">Central Store</text><path d="M2049.5,4901.1797 C2049.5,4891.1797 2067.5,4891.1797 2067.5,4891.1797 C2067.5,4891.1797 2085.5,4891.1797 2085.5,4901.1797 L2085.5,4927.1797 C2085.5,4937.1797 2067.5,4937.1797 2067.5,4937.1797 C2067.5,4937.1797 2049.5,4937.1797 2049.5,4927.1797 L2049.5,4901.1797 " fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2049.5,4901.1797 C2049.5,4911.1797 2067.5,4911.1797 2067.5,4911.1797 C2067.5,4911.1797 2085.5,4911.1797 2085.5,4901.1797 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="4720.4277" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2123.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="814.5" y="190.8848"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1690.5" y="2519.3418"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="375.0586"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="848.2012"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="997.7539"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1105.6855"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1809.9336"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="1933.1758"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="2214.5918"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2062.5" y="2603.2734"/><path d="M13,152.2637 L293,152.2637 L293,159.2637 L283,169.2637 L13,169.2637 L13,152.2637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2623.252" style="stroke: #000000; stroke-width: 2.0;" width="2353" x="13" y="152.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="28" y="165.832">Prepare Position Handler Consume</text><polygon fill="#A80036" points="802.5,186.8848,812.5,190.8848,802.5,194.8848,806.5,190.8848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="808.5" y1="190.8848" y2="190.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="186.1426">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="127.5" y="186.1426">Request transfers to be processed</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="220.1953" y2="220.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="220.1953" y2="233.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="233.1953" y2="233.1953"/><polygon fill="#A80036" points="835.5,229.1953,825.5,233.1953,835.5,237.1953,831.5,233.1953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="215.4531">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="844.5" y="215.4531">Check 1st transfer to select the Participant and Currency</text><path d="M762,248.1953 L927,248.1953 L927,255.1953 L917,265.1953 L762,265.1953 L762,248.1953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2037.707" style="stroke: #000000; stroke-width: 2.0;" width="1594" x="762" y="248.1953"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="777" y="261.7637">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="317.4375" y2="317.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="317.4375" y2="330.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="330.4375" y2="330.4375"/><polygon fill="#A80036" points="835.5,326.4375,825.5,330.4375,835.5,334.4375,831.5,330.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="297.3848">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="844.5" y="282.0742">Loop through batch and build list of transferIds and calculate sumTransfersInBatch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="844.5" y="297.3848">checking all in Batch are for the correct Paricipant and Currency</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="844.5" y="312.6953">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="921.5" y="312.6953">2001, 3100</text><polygon fill="#A80036" points="2050.5,371.0586,2060.5,375.0586,2050.5,379.0586,2054.5,375.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="375.0586" y2="375.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="362.6611">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="844.5" y="355.0059">Retrieve current state of all transfers in array from DB with select whereIn</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1206" x="844.5" y="370.3164">(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE =&gt; RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="2002,388.0586,2133,388.0586,2143,407.0586,2133,426.0586,2002,426.0586,1992,407.0586,2002,388.0586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="2004" y="404.627">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="2004" y="419.9375">transferParticipant</text><polygon fill="#A80036" points="835.5,448.9902,825.5,452.9902,835.5,456.9902,831.5,452.9902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="829.5" x2="2066.5" y1="452.9902" y2="452.9902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="841.5" y="448.248">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="854.5" y="448.248">Return current state of all selected transfers from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="512.9219" y2="512.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="512.9219" y2="525.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="525.9219" y2="525.9219"/><polygon fill="#A80036" points="835.5,521.9219,825.5,525.9219,835.5,529.9219,831.5,525.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="492.8691">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="844.5" y="477.5586">Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="844.5" y="492.8691">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="921.5" y="492.8691">2001</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="957.5" y="492.8691">against failing transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="844.5" y="508.1797">Batch is not rejected as a whole.</text><path d="M829,538.9219 L829,762.9219 L2316,762.9219 L2316,548.9219 L2306,538.9219 L829,538.9219 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2306,538.9219 L2306,548.9219 L2316,548.9219 L2306,538.9219 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="835" y="556.4902">List of transfers used during processing</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="835" y="571.8008">reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="964" y="571.8008">is list of transfers to be processed in the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="835" y="587.1113">abortedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1202" x="957" y="587.1113">is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="835" y="602.4219">processedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1328" x="973" y="602.4219">is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="839" y="617.7324"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="835" y="633.043">Scalar intermidate values used in the algorithm</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="835" y="648.3535">transferAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="947" y="648.3535">= payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="835" y="663.6641">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="983" y="663.6641">= SUM amount against each Transfer in batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="835" y="678.9746">currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="942" y="678.9746">= participantPosition.value</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="835" y="694.2852">reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="952" y="694.2852">= participantPosition.{original}reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="835" y="709.5957">effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="950" y="709.5957">= currentPosition + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="835" y="724.9063">heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="922" y="724.9063">= effectivePosition + sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="835" y="740.2168">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="953" y="740.2168">= participantLimit(NetDebitCap) - effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="835" y="755.5273">sumReserved</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="931" y="755.5273">= SUM of transfers that have met rule criteria and processed</text><path d="M774,777.2695 L774,817.2695 L2112,817.2695 L2112,787.2695 L2102,777.2695 L774,777.2695 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2102,777.2695 L2102,787.2695 L2112,787.2695 L2102,777.2695 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="759" x="1057.25" y="794.8379">Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="1057.25" y="810.1484">and calculate the available position for the Participant to use</text><polygon fill="#A80036" points="2050.5,844.2012,2060.5,848.2012,2050.5,852.2012,2054.5,848.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="848.2012" y2="848.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="843.459">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="844.5" y="843.459">Select effectivePosition FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="2006,861.2012,2129,861.2012,2139,872.2012,2129,884.2012,2006,884.2012,1996,872.2012,2006,861.2012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="2008" y="877.7695">participantPosition</text><polygon fill="#A80036" points="835.5,906.8223,825.5,910.8223,835.5,914.8223,831.5,910.8223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="829.5" x2="2066.5" y1="910.8223" y2="910.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="841.5" y="906.0801">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="854.5" y="906.0801">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="955.4434" y2="955.4434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="955.4434" y2="968.4434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="968.4434" y2="968.4434"/><polygon fill="#A80036" points="835.5,964.4434,825.5,968.4434,835.5,972.4434,831.5,968.4434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="831.5" y="943.0459">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="844.5" y="935.3906">Increment reservedValue to heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="844.5" y="950.7012">(reservedValue = reservedPosition + sumTransfersInBatch)</text><polygon fill="#A80036" points="2050.5,993.7539,2060.5,997.7539,2050.5,1001.7539,2054.5,997.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="997.7539" y2="997.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="993.0117">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="853.5" y="993.0117">Persist reservedValue</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1929,1040.7539,2206,1040.7539,2216,1059.7539,2206,1078.7539,1929,1078.7539,1919,1059.7539,1929,1040.7539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1931" y="1057.3223">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1985" y="1057.3223">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1931" y="1072.6328">SET reservedValue += sumTransfersInBatch</text><polygon fill="#A80036" points="2050.5,1101.6855,2060.5,1105.6855,2050.5,1109.6855,2054.5,1105.6855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="1105.6855" y2="1105.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1100.9434">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="853.5" y="1100.9434">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1875,1118.6855,2259,1118.6855,2269,1152.6855,2259,1187.6855,1875,1187.6855,1865,1152.6855,1875,1118.6855" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1877" y="1135.2539">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1917" y="1135.2539">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1877" y="1150.5645">WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1877" y="1165.875">AND participantLimit.participantId = payload.payerFsp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1877" y="1181.1855">AND participantLimit.currencyId = payload.amount.currency</text><polygon fill="#A80036" points="835.5,1210.2383,825.5,1214.2383,835.5,1218.2383,831.5,1214.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="829.5" x2="2066.5" y1="1214.2383" y2="1214.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="841.5" y="1209.4961">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="863.5" y="1209.4961">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="1243.5488" y2="1243.5488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="1243.5488" y2="1256.5488"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="1256.5488" y2="1256.5488"/><polygon fill="#A80036" points="835.5,1252.5488,825.5,1256.5488,835.5,1260.5488,831.5,1256.5488" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1238.8066">13</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="853.5" y="1238.8066">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="712" x="971.5" y="1238.8066">= participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)</text><path d="M774,1269.5488 L774,1309.5488 L2112,1309.5488 L2112,1279.5488 L2102,1269.5488 L774,1269.5488 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2102,1269.5488 L2102,1279.5488 L2112,1279.5488 L2102,1269.5488 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="1138.75" y="1287.1172">For each transfer in the batch, validate the availablility of position to meet the transfer amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="1138.75" y="1302.4277">this will be as per the position algorithm documented below</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="1355.791" y2="1355.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="1355.791" y2="1368.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="1368.791" y2="1368.791"/><polygon fill="#A80036" points="835.5,1364.791,825.5,1368.791,835.5,1372.791,831.5,1368.791" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1343.3936">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="853.5" y="1335.7383">Validate availablePosition for each tranfser (see algorithm below)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="853.5" y="1351.0488">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="930.5" y="1351.0488">4001</text><path d="M829,1381.791 L829,1651.791 L2200,1651.791 L2200,1391.791 L2190,1381.791 L829,1381.791 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2190,1381.791 L2190,1391.791 L2200,1391.791 L2190,1381.791 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="835" y="1399.3594">01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="557" x="835" y="1414.6699">02: sumProcessed =0 // Record the sum of the transfers already processed in this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1087" x="835" y="1429.9805">03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="835" y="1445.291">04: foreach transfer in reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="851" y="1460.6016">05: sumProcessed += transfer.amount // the total processed so far</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="1281" y="1460.6016">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="851" y="1475.9121">06: if availablePosition &gt;= transfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="867" y="1491.2227">07: transfer.state = "RESERVED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="867" y="1506.5332">08: availablePosition -= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="867" y="1521.8438">09: sumRESERVED += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="851" y="1537.1543">10: else</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="867" y="1552.4648">11: preparedTransfer.state = "ABORTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="669" x="867" y="1567.7754">12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="851" y="1583.0859">13: end if</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1026" x="851" y="1598.3965">14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="541" x="851" y="1613.707">15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="1396" y="1613.707">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="1589" y="1613.707">// the running down of the total reserved value at the begining of the batch.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1334" x="851" y="1629.0176">16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="835" y="1644.3281">16: end foreach</text><path d="M774,1666.0703 L774,1721.0703 L2112,1721.0703 L2112,1676.0703 L2102,1666.0703 L774,1666.0703 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2102,1666.0703 L2102,1676.0703 L2112,1676.0703 L2102,1666.0703 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="860" x="843.75" y="1683.6387">Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="645" x="843.75" y="1698.9492">(If there are any alarm limits, process those returning limits in which the threshold has been breached)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1186" x="843.75" y="1714.2598">Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="1767.623" y2="1767.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="1767.623" y2="1780.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="1780.623" y2="1780.623"/><polygon fill="#A80036" points="835.5,1776.623,825.5,1780.623,835.5,1784.623,831.5,1780.623" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1755.2256">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="853.5" y="1747.5703">Assess any limit thresholds on the final position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="853.5" y="1762.8809">adding to alarm list if triggered</text><polygon fill="#A80036" points="2050.5,1805.9336,2060.5,1809.9336,2050.5,1813.9336,2054.5,1809.9336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="1809.9336" y2="1809.9336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1805.1914">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="853.5" y="1805.1914">Persist latest position</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="994.5" y="1805.1914">value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1035.5" y="1805.1914">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="1062.5" y="1805.1914">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1164.5" y="1805.1914">to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1943,1852.9336,2192,1852.9336,2202,1878.9336,2192,1905.9336,1943,1905.9336,1933,1878.9336,1943,1852.9336" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1945" y="1869.502">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1999" y="1869.502">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="1945" y="1884.8125">SET value += sumRESERVED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1945" y="1900.123">reservedValue -= sumTransfersInBatch</text><polygon fill="#A80036" points="2050.5,1929.1758,2060.5,1933.1758,2050.5,1937.1758,2054.5,1933.1758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="1933.1758" y2="1933.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="1928.4336">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="853.5" y="1928.4336">Bulk persist transferStateChange for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1798,1976.1758,2336,1976.1758,2346,2010.1758,2336,2045.1758,1798,2045.1758,1788,2010.1758,1798,1976.1758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1800" y="1992.7441">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1887" y="1992.7441">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="1800" y="2008.0547">select for update from transfer table where transferId in ([transferBatch.transferId,...])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="1800" y="2023.3652">build list of transferStateChanges from transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1804" y="2038.6758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="866.5" y1="2071.7285" y2="2071.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866.5" x2="866.5" y1="2071.7285" y2="2084.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="825.5" x2="866.5" y1="2084.7285" y2="2084.7285"/><polygon fill="#A80036" points="835.5,2080.7285,825.5,2084.7285,835.5,2088.7285,831.5,2084.7285" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="2066.9863">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="745" x="853.5" y="2066.9863">Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list</text><path d="M829,2097.7285 L829,2183.7285 L1312,2183.7285 L1312,2107.7285 L1302,2097.7285 L829,2097.7285 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1302,2097.7285 L1302,2107.7285 L1312,2107.7285 L1302,2097.7285 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="835" y="2115.2969">Effectively:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="446" x="851" y="2130.6074">SET transferStateChangeId = processedTransfer.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="851" y="2145.918">participantPositionId = preparedTransfer.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="851" y="2161.2285">value = preparedTransfer.positionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="851" y="2176.5391">reservedValue = preparedTransfer.positionReservedValue</text><polygon fill="#A80036" points="2050.5,2210.5918,2060.5,2214.5918,2050.5,2218.5918,2054.5,2214.5918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824.5" x2="2056.5" y1="2214.5918" y2="2214.5918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="831.5" y="2209.8496">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="443" x="853.5" y="2209.8496">Bulk persist the participant position change for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1908,2257.5918,2226,2257.5918,2236,2268.5918,2226,2280.5918,1908,2280.5918,1898,2268.5918,1908,2257.5918" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="1910" y="2274.1602">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1997" y="2274.1602">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="2224" y="2274.1602"/><polygon fill="#A80036" points="118.5,2310.2129,108.5,2314.2129,118.5,2318.2129,114.5,2314.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="818.5" y1="2314.2129" y2="2314.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2309.4707">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="146.5" y="2309.4707">Return a map of transferIds and their transferStateChanges</text><path d="M23,2329.2129 L85,2329.2129 L85,2336.2129 L75,2346.2129 L23,2346.2129 L23,2329.2129 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="439.3027" style="stroke: #000000; stroke-width: 2.0;" width="2140" x="23" y="2329.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="2342.7813">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="100" y="2341.8477">[Calculate &amp; Validate Latest Position Prepare (success)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2383.1445" y2="2383.1445"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2383.1445" y2="2396.1445"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2396.1445" y2="2396.1445"/><polygon fill="#A80036" points="118.5,2392.1445,108.5,2396.1445,118.5,2400.1445,114.5,2396.1445" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2370.7471">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="136.5" y="2363.0918">Notifications for Position Validation Success</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="353" x="136.5" y="2378.4023">Reference: Postion Validation Success case (Prepare)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2163" y1="2405.1445" y2="2405.1445"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="28" y="2415.7793">[Calculate &amp; Validate Latest Position Prepare (failure)]</text><path d="M112,2424.0996 L112,2449.0996 L244,2449.0996 L244,2434.0996 L234,2424.0996 L112,2424.0996 " fill="#FF0000" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M234,2424.0996 L234,2434.0996 L244,2434.0996 L234,2424.0996 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="118" y="2441.668">Validation failure!</text><path d="M33,2465.4102 L584,2465.4102 L584,2472.4102 L574,2482.4102 L33,2482.4102 L33,2465.4102 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="2120" x="33" y="2465.4102"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="506" x="48" y="2478.9785">Persist Transfer State (with transferState='ABORTED' on position check fail)</text><polygon fill="#A80036" points="1678.5,2515.3418,1688.5,2519.3418,1678.5,2523.3418,1682.5,2519.3418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1684.5" y1="2519.3418" y2="2519.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2506.9443">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="136.5" y="2499.2891">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2514.5996">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2514.5996">2003</text><path d="M112,2532.3418 L112,2572.3418 L798,2572.3418 L798,2542.3418 L788,2532.3418 L112,2532.3418 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M788,2532.3418 L788,2542.3418 L798,2542.3418 L788,2532.3418 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="118" y="2549.9102">transferStateChange.state = "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="665" x="118" y="2565.2207">transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><polygon fill="#A80036" points="2050.5,2599.2734,2060.5,2603.2734,2050.5,2607.2734,2054.5,2603.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1700.5" x2="2056.5" y1="2603.2734" y2="2603.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1707.5" y="2598.5313">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1729.5" y="2598.5313">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="2002,2646.2734,2133,2646.2734,2143,2657.2734,2133,2669.2734,2002,2669.2734,1992,2657.2734,2002,2646.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="2004" y="2662.8418">transferStateChange</text><polygon fill="#A80036" points="118.5,2691.8945,108.5,2695.8945,118.5,2699.8945,114.5,2695.8945" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1694.5" y1="2695.8945" y2="2695.8945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2691.1523">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2691.1523">Return success</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2747.5156" y2="2747.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2747.5156" y2="2760.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2760.5156" y2="2760.5156"/><polygon fill="#A80036" points="118.5,2756.5156,108.5,2760.5156,118.5,2764.5156,114.5,2760.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2735.1182">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="136.5" y="2727.4629">Notifications for failures</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="330" x="136.5" y="2742.7734">Reference: Failure in Postion Validation (Prepare)</text><path d="M23,2789.5156 L398,2789.5156 L398,2796.5156 L388,2806.5156 L23,2806.5156 L23,2789.5156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1119.4512" style="stroke: #000000; stroke-width: 2.0;" width="759" x="23" y="2789.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="330" x="38" y="2803.084">Reference: Failure in Postion Validation (Prepare)</text><path d="M33,2813.8262 L95,2813.8262 L95,2820.8262 L85,2830.8262 L33,2830.8262 L33,2813.8262 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1088.1406" style="stroke: #000000; stroke-width: 2.0;" width="739" x="33" y="2813.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="2827.3945">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="110" y="2826.4609">[If type == 'bulk-prepare']</text><path d="M112,2836.1367 L112,3305.1367 L538,3305.1367 L538,2846.1367 L528,2836.1367 L112,2836.1367 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,2836.1367 L528,2846.1367 L538,2846.1367 L528,2836.1367 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="2853.7051">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2869.0156">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="2884.3262">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="150" y="2899.6367">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="2914.9473">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="150" y="2930.2578">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="150" y="2945.5684">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="166" y="2960.8789">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="166" y="2976.1895">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="182" y="2991.5">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="198" y="3006.8105">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="198" y="3022.1211">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="198" y="3037.4316">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3052.7422">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="3068.0527">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="150" y="3083.3633">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166" y="3098.6738">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="182" y="3113.9844">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="182" y="3129.2949">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="182" y="3144.6055">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="182" y="3159.916">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="182" y="3175.2266">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="182" y="3190.5371">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="198" y="3205.8477">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="198" y="3221.1582">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="198" y="3236.4688">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="3251.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3267.0898">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3282.4004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3297.7109">}</text><polygon fill="#A80036" points="661.5,3347.0742,671.5,3351.0742,661.5,3355.0742,665.5,3351.0742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="667.5" y1="3351.0742" y2="3351.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3338.6768">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="483" x="136.5" y="3331.0215">Publish Position failure event (in Prepare) to Bulk Processing Topic (for Payer)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="136.5" y="3346.332">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="220.5" y="3346.332">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="772" y1="3360.0742" y2="3360.0742"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="38" y="3370.709">[If type == 'prepare']</text><path d="M112,3379.0293 L112,3848.0293 L538,3848.0293 L538,3389.0293 L528,3379.0293 L112,3379.0293 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,3379.0293 L528,3389.0293 L538,3389.0293 L528,3379.0293 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="3396.5977">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3411.9082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="3427.2188">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="150" y="3442.5293">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="3457.8398">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="150" y="3473.1504">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="150" y="3488.4609">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="166" y="3503.7715">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="166" y="3519.082">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="182" y="3534.3926">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="198" y="3549.7031">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="198" y="3565.0137">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="198" y="3580.3242">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3595.6348">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="3610.9453">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="150" y="3626.2559">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166" y="3641.5664">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="182" y="3656.877">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="182" y="3672.1875">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="182" y="3687.498">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="182" y="3702.8086">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="182" y="3718.1191">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="182" y="3733.4297">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="198" y="3748.7402">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="198" y="3764.0508">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="198" y="3779.3613">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="3794.6719">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3809.9824">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3825.293">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3840.6035">}</text><polygon fill="#A80036" points="489.5,3889.9668,499.5,3893.9668,489.5,3897.9668,493.5,3893.9668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="495.5" y1="3893.9668" y2="3893.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3881.5693">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="136.5" y="3873.9141">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3889.2246">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3889.2246">2003</text><path d="M23,3922.9668 L421,3922.9668 L421,3929.9668 L411,3939.9668 L23,3939.9668 L23,3922.9668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="935.7246" style="stroke: #000000; stroke-width: 2.0;" width="759" x="23" y="3922.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="353" x="38" y="3936.5352">Reference: Postion Validation Success case (Prepare)</text><path d="M33,3947.2773 L95,3947.2773 L95,3954.2773 L85,3964.2773 L33,3964.2773 L33,3947.2773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="904.4141" style="stroke: #000000; stroke-width: 2.0;" width="739" x="33" y="3947.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="3960.8457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="110" y="3959.9121">[If type == 'bulk-prepare']</text><path d="M112,3969.5879 L112,4346.5879 L390,4346.5879 L390,3979.5879 L380,3969.5879 L112,3969.5879 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M380,3969.5879 L380,3979.5879 L390,3979.5879 L380,3969.5879 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="3987.1563">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="4002.4668">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="4017.7773">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="150" y="4033.0879">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="150" y="4048.3984">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="150" y="4063.709">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="150" y="4079.0195">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="166" y="4094.3301">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="166" y="4109.6406">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="4124.9512">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="150" y="4140.2617">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166" y="4155.5723">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="182" y="4170.8828">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="182" y="4186.1934">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="182" y="4201.5039">type: bulk-transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="182" y="4216.8145">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="182" y="4232.125">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="182" y="4247.4355">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="198" y="4262.7461">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="198" y="4278.0566">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="4293.3672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="4308.6777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="4323.9883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="4339.2988">}</text><polygon fill="#A80036" points="661.5,4388.6621,671.5,4392.6621,661.5,4396.6621,665.5,4392.6621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="667.5" y1="4392.6621" y2="4392.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="4380.2646">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="136.5" y="4372.6094">Publish Position Success event (in Prepare) to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="136.5" y="4387.9199">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="220.5" y="4387.9199">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="772" y1="4401.6621" y2="4401.6621"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="38" y="4412.2969">[If type == 'prepare']</text><path d="M112,4420.6172 L112,4797.6172 L390,4797.6172 L390,4430.6172 L380,4420.6172 L112,4420.6172 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M380,4420.6172 L380,4430.6172 L390,4430.6172 L380,4420.6172 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="4438.1855">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="4453.4961">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="150" y="4468.8066">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="150" y="4484.1172">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="150" y="4499.4277">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="150" y="4514.7383">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="150" y="4530.0488">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="166" y="4545.3594">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="166" y="4560.6699">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="4575.9805">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="150" y="4591.291">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166" y="4606.6016">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="182" y="4621.9121">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="182" y="4637.2227">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="182" y="4652.5332">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="182" y="4667.8438">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="182" y="4683.1543">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="182" y="4698.4648">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="198" y="4713.7754">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="198" y="4729.0859">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="4744.3965">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="4759.707">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="4775.0176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="4790.3281">}</text><polygon fill="#A80036" points="489.5,4839.6914,499.5,4843.6914,489.5,4847.6914,493.5,4843.6914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="495.5" y1="4843.6914" y2="4843.6914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="4831.2939">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="4823.6387">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="4838.9492">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="4838.9492">2003</text><!--
@startuml
title 1.3.1. Prepare Position Handler Consume (single message, includes individual transfers from Bulk)

autonumber


control "Position Handler" as POS_HANDLER

entity "Position\nManagement\nFacade" as POS_MGMT
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
collections "topic-bulk-processing" as TOPIC_BULK_PROCESSING
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_MGMT
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Prepare Position Handler Consume
    POS_HANDLER -> POS_MGMT: Request transfers to be processed
    activate POS_MGMT
    POS_MGMT -> POS_MGMT: Check 1st transfer to select the Participant and Currency
    group <color #blue>DB TRANSACTION</color>
        POS_MGMT -> POS_MGMT: Loop through batch and build list of transferIds and calculate sumTransfersInBatch,\nchecking all in Batch are for the correct Paricipant and Currency\n<color #FF0000><b>Error code:</b> 2001, 3100</color>
        POS_MGMT -> DB: Retrieve current state of all transfers in array from DB with select whereIn\n(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE => RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_MGMT: Return current state of all selected transfers from DB
        deactivate DB
        POS_MGMT <-> POS_MGMT: Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')\n<color #FF0000><b>Error code:</b> 2001</color> against failing transfers\nBatch is not rejected as a whole.

        note right of POS_MGMT #lightgray
            List of transfers used during processing
            **reservedTransfers** is list of transfers to be processed in the batch
            **abortedTransfers** is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)
            **processedTransfers** is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation

            Scalar intermidate values used in the algorithm
            **transferAmount** = payload.amount.amount
            **sumTransfersInBatch** = SUM amount against each Transfer in batch
            **currentPosition** = participantPosition.value
            **reservedPosition** = participantPosition.{original}reservedValue
            **effectivePosition** = currentPosition + reservedPosition
            **heldPosition** = effectivePosition + sumTransfersInBatch
            **availablePosition** = participantLimit(NetDebitCap) - effectivePosition
            **sumReserved** = SUM of transfers that have met rule criteria and processed
        end note
        note over POS_MGMT,DB
            Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch
            and calculate the available position for the Participant to use
        end note
        POS_MGMT -> DB: Select effectivePosition FOR UPDATE from DB for Payer 
        activate DB
        hnote over DB #lightyellow
            participantPosition
        end note
        DB - -> POS_MGMT: Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
        deactivate DB
        POS_MGMT -> POS_MGMT: Increment reservedValue to heldPosition\n(reservedValue = reservedPosition + sumTransfersInBatch)
        POS_MGMT -> DB: Persist reservedValue
        activate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET reservedValue += sumTransfersInBatch
        end note
        deactivate DB
        
        
        POS_MGMT -> DB: Request position limits for Payer Participant
        activate DB
        hnote over DB #lightyellow
            FROM **participantLimit**
            WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'
            AND participantLimit.participantId = payload.payerFsp
            AND participantLimit.currencyId = payload.amount.currency
        end note
        DB - -> POS_MGMT: Return position limits
        deactivate DB
        POS_MGMT <-> POS_MGMT: **availablePosition** = participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)
        note over POS_MGMT,DB
            For each transfer in the batch, validate the availablility of position to meet the transfer amount
            this will be as per the position algorithm documented below
        end note
        POS_MGMT <-> POS_MGMT: Validate availablePosition for each tranfser (see algorithm below)\n<color #FF0000><b>Error code:</b> 4001</color>
        note right of POS_MGMT #lightgray
            01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED 
            02: sumProcessed =0 // Record the sum of the transfers already processed in this batch
            03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position
            04: foreach transfer in reservedTransfers
                05: sumProcessed += transfer.amount // the total processed so far **(NEED TO UPDATE IN CODE)**
                06: if availablePosition >= transfer.amount
                    07: transfer.state = "RESERVED"
                    08: availablePosition -= preparedTransfer.amount
                    09: sumRESERVED += preparedTransfer.amount
                10: else
                    11: preparedTransfer.state = "ABORTED"
                    12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
                13: end if
                14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far
                15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition **(NEED TO UPDATE IN CODE)** // the running down of the total reserved value at the begining of the batch.
                16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }
            16: end foreach
        end note
        note over POS_MGMT,DB
            Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch
            (If there are any alarm limits, process those returning limits in which the threshold has been breached)
            Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position
        end note
        POS_MGMT->POS_MGMT: Assess any limit thresholds on the final position\nadding to alarm list if triggered
        
        POS_MGMT->DB: Persist latest position **value** and **reservedValue** to DB for Payer
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value += sumRESERVED,
                reservedValue -= sumTransfersInBatch
            end note
            activate DB
            deactivate DB

        POS_MGMT -> DB: Bulk persist transferStateChange for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **transferStateChange**
                select for update from transfer table where transferId in ([transferBatch.transferId,...])
                build list of transferStateChanges from transferBatch
                
        end note
        activate DB
        deactivate DB
        
        POS_MGMT->POS_MGMT: Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list

        note right of POS_MGMT #lightgray
            Effectively:  
                SET transferStateChangeId = processedTransfer.transferStateChangeId,
                participantPositionId = preparedTransfer.participantPositionId,
                value = preparedTransfer.positionValue,
                reservedValue = preparedTransfer.positionReservedValue
        end note
        POS_MGMT -> DB: Bulk persist the participant position change for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **participantPositionChange**            
        end note
        activate DB
        deactivate DB
    end
    POS_MGMT - -> POS_HANDLER: Return a map of transferIds and their transferStateChanges
    deactivate POS_MGMT
    alt Calculate & Validate Latest Position Prepare (success)
        POS_HANDLER -> POS_HANDLER: Notifications for Position Validation Success \n<color Magenta><b>Reference: Postion Validation Success case (Prepare)</b></color>
   else Calculate & Validate Latest Position Prepare (failure)
        note right of POS_HANDLER #red: Validation failure!

        group Persist Transfer State (with transferState='ABORTED' on position check fail)
            POS_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            note right of POS_HANDLER #lightgray
                transferStateChange.state = "ABORTED",
                transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            end note
            POS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        POS_HANDLER -> POS_HANDLER: Notifications for failures\n<color Magenta><b>Reference: Failure in Postion Validation (Prepare) </b></color>
   end
end


group Reference: Failure in Postion Validation (Prepare)
    alt If type == 'bulk-prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Position failure event (in Prepare) to Bulk Processing Topic (for Payer) \n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error code:</b> 2003</color>
    end
    
end

group Reference: Postion Validation Success case (Prepare)
    alt If type == 'bulk-prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Position Success event (in Prepare) to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
    end
    
end

deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>