<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3074px" preserveAspectRatio="none" style="width:1784px;height:3074px;" version="1.1" viewBox="0 0 1784 3074" width="1784px" zoomAndPan="magnify"><defs><filter height="300%" id="f111f2xgtpux8a" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="710" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="3029.084" style="stroke: #A80036; stroke-width: 1.0;" width="1691" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="814" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="2861.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2363.1914"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="2936.084"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1393.9512"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1683.3223"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="787.1191"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1041.9141"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="816.4297"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1071.2246"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1423.2617"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1712.6328"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="2847.7969" style="stroke: #000000; stroke-width: 2.0;" width="1760" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="1395.1035" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="508.7031"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="748.498"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1003.293"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1315.709"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1340.0195"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1491" x="262" y="1592.125"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1614.0801"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="1917.8066"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="941" x="272" y="2401.1914"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="113" x2="113" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="361" x2="361" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="840" x2="840" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="993" x2="993" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1129" x2="1129" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1261" x2="1261" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1376" x2="1376" y1="116.2871" y2="2998.084"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1658" x2="1658" y1="116.2871" y2="2998.084"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="101.334">topic-transfer-prepare</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="2997.084"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="3001.084"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="3021.6191">topic-transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="113.334">Prepare Event Handler</text><ellipse cx="361" cy="83.7988" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,71.7988,363,66.7988,361,71.7988,363,76.7988,357,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="3010.6191">Prepare Event Handler</text><ellipse cx="361" cy="3029.5723" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,3017.5723,363,3012.5723,361,3017.5723,363,3022.5723,357,3017.5723" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="76.7988"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="2997.084"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="3001.084"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="3021.6191">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="76.7988"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="2997.084"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="3001.084"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="3021.6191">Event-Topic</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="76.7988"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="2997.084"/><rect fill="#FEFECE" filter="url(#f111f2xgtpux8a)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="3001.084"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="3021.6191">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="113.334">Position DAO</text><ellipse cx="1261" cy="83.7988" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="3010.6191">Position DAO</text><ellipse cx="1261" cy="3029.5723" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="3043.5723" y2="3043.5723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="113.334">Participant DAO</text><ellipse cx="1376" cy="83.7988" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="3010.6191">Participant DAO</text><ellipse cx="1376" cy="3029.5723" fill="#FEFECE" filter="url(#f111f2xgtpux8a)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="3043.5723" y2="3043.5723"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="113.334">Central Store</text><path d="M1640,63.7988 C1640,53.7988 1658,53.7988 1658,53.7988 C1658,53.7988 1676,53.7988 1676,63.7988 L1676,89.7988 C1676,99.7988 1658,99.7988 1658,99.7988 C1658,99.7988 1640,99.7988 1640,89.7988 L1640,63.7988 " fill="#FEFECE" filter="url(#f111f2xgtpux8a)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,63.7988 C1640,73.7988 1658,73.7988 1658,73.7988 C1658,73.7988 1676,73.7988 1676,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="3010.6191">Central Store</text><path d="M1640,3023.5723 C1640,3013.5723 1658,3013.5723 1658,3013.5723 C1658,3013.5723 1676,3013.5723 1676,3023.5723 L1676,3049.5723 C1676,3059.5723 1658,3059.5723 1658,3059.5723 C1658,3059.5723 1640,3059.5723 1640,3049.5723 L1640,3023.5723 " fill="#FEFECE" filter="url(#f111f2xgtpux8a)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,3023.5723 C1640,3033.5723 1658,3033.5723 1658,3033.5723 C1658,3033.5723 1676,3033.5723 1676,3023.5723 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="2861.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2363.1914"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="2936.084"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1393.9512"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1683.3223"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="787.1191"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1041.9141"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="816.4297"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1071.2246"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1423.2617"/><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1712.6328"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2847.7969" style="stroke: #000000; stroke-width: 2.0;" width="1760" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="129,167.9082,119,171.9082,129,175.9082,125,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="123" x2="355" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="135" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="148" y="167.166">Consume Prepare event message</text><path d="M262,216.9082 L346,216.9082 L346,223.9082 L336,233.9082 L262,233.9082 L262,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="230.4766">break</text><path d="M272,241.2188 L414,241.2188 L414,248.2188 L404,258.2188 L272,258.2188 L272,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="377,304.1504,367,308.1504,377,312.1504,373,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="386" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="386" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="470" y="290.4082">2001</text><path d="M272,337.1504 L487,337.1504 L487,344.1504 L477,354.1504 L272,354.1504 L272,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="287" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="981.5,396.7715,991.5,400.7715,981.5,404.7715,985.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="987.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="386" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="766" x="279" y="408.7715"/><polygon fill="#EEEEEE" points="279,408.7715,343,408.7715,343,415.7715,333,425.7715,279,425.7715,279,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="589" y="442.3398">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="457.6504"/><path d="M252,508.7031 L471,508.7031 L471,515.7031 L461,525.7031 L252,525.7031 L252,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1395.1035" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="267" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="377,556.3242,367,560.3242,377,564.3242,373,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="386" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="377,598.6348,367,602.6348,377,606.6348,373,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="386" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M371,615.6348 L371,670.6348 L736,670.6348 L736,625.6348 L726,615.6348 L371,615.6348 " fill="#D3D3D3" filter="url(#f111f2xgtpux8a)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M726,615.6348 L726,625.6348 L736,625.6348 L726,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="377" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="377" y="663.8242">It may need to be added in future for custom adapters.</text><rect fill="#FFFFFF" filter="url(#f111f2xgtpux8a)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1426" x="279" y="680.5664"/><polygon fill="#EEEEEE" points="279,680.5664,343,680.5664,343,687.5664,333,697.5664,279,697.5664,279,680.5664" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="695.1348">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="862.5" y="714.1348">Transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="918.5" y="714.1348">Prepare Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="866.5" y="729.4453"/><path d="M272,748.498 L414,748.498 L414,755.498 L404,765.498 L272,765.498 L272,748.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="748.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="762.0664">Validate Payer</text><polygon fill="#A80036" points="1359,783.1191,1369,787.1191,1359,791.1191,1363,787.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="787.1191" y2="787.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="782.377">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="386" y="782.377">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1641,812.4297,1651,816.4297,1641,820.4297,1645,816.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="816.4297" y2="816.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1388" y="811.6875">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1401" y="811.6875">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f111f2xgtpux8a)" points="1594,829.4297,1722,829.4297,1732,848.4297,1722,867.4297,1594,867.4297,1584,848.4297,1594,829.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="845.998">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="861.3086">participantCurrency</text><polygon fill="#A80036" points="1392,890.3613,1382,894.3613,1392,898.3613,1388,894.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="894.3613" y2="894.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1398" y="889.6191">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1411" y="889.6191">Return Participant details if it exists</text><polygon fill="#A80036" points="377,919.6719,367,923.6719,377,927.6719,373,923.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="923.6719" y2="923.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="383" y="918.9297">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="396" y="918.9297">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="968.293" y2="968.293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="968.293" y2="981.293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="981.293" y2="981.293"/><polygon fill="#A80036" points="377,977.293,367,981.293,377,985.293,373,981.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="955.8955">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="395" y="948.2402">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="963.5508">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="963.5508">3202</text><path d="M272,1003.293 L416,1003.293 L416,1010.293 L406,1020.293 L272,1020.293 L272,1003.293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1003.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="287" y="1016.8613">Validate Payee</text><polygon fill="#A80036" points="1359,1037.9141,1369,1041.9141,1359,1045.9141,1363,1041.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="1041.9141" y2="1041.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1037.1719">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="395" y="1037.1719">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1641,1067.2246,1651,1071.2246,1641,1075.2246,1645,1071.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="1071.2246" y2="1071.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1388" y="1066.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1410" y="1066.4824">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f111f2xgtpux8a)" points="1594,1084.2246,1722,1084.2246,1732,1103.2246,1722,1122.2246,1594,1122.2246,1584,1103.2246,1594,1084.2246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="1100.793">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="1116.1035">participantCurrency</text><polygon fill="#A80036" points="1392,1145.1563,1382,1149.1563,1392,1153.1563,1388,1149.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="1149.1563" y2="1149.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1398" y="1144.4141">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1420" y="1144.4141">Return Participant details if it exists</text><polygon fill="#A80036" points="377,1174.4668,367,1178.4668,377,1182.4668,373,1178.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="1178.4668" y2="1178.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1173.7246">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="1173.7246">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1223.0879" y2="1223.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1223.0879" y2="1236.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1236.0879" y2="1236.0879"/><polygon fill="#A80036" points="377,1232.0879,367,1236.0879,377,1240.0879,373,1236.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1210.6904">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="395" y="1203.0352">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1218.3457">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1218.3457">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1287.709" y2="1287.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1287.709" y2="1300.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1300.709" y2="1300.709"/><polygon fill="#A80036" points="377,1296.709,367,1300.709,377,1304.709,373,1300.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1275.3115">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="395" y="1267.6563">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1282.9668">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1282.9668">3100</text><path d="M262,1315.709 L324,1315.709 L324,1322.709 L314,1332.709 L262,1332.709 L262,1315.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1315.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="277" y="1329.2773">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="339" y="1328.3438">[Validate Prepare Transfer (success)]</text><path d="M272,1340.0195 L744,1340.0195 L744,1347.0195 L734,1357.0195 L272,1357.0195 L272,1340.0195 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1340.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="287" y="1353.5879">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1244,1389.9512,1254,1393.9512,1244,1397.9512,1248,1393.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="1393.9512" y2="1393.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1381.5537">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="1373.8984">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1389.209">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1389.209">2003</text><polygon fill="#A80036" points="1641,1419.2617,1651,1423.2617,1641,1427.2617,1645,1423.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="1423.2617" y2="1423.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="1418.5195">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="1418.5195">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f111f2xgtpux8a)" points="1592,1466.2617,1723,1466.2617,1733,1508.2617,1723,1550.2617,1592,1550.2617,1582,1508.2617,1592,1466.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="1482.8301">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="1498.1406">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="1513.4512">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="1528.7617">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="1544.0723">ilpPacket</text><polygon fill="#A80036" points="377,1573.125,367,1577.125,377,1581.125,373,1577.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="1577.125" y2="1577.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1572.3828">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="1572.3828">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="262" x2="1753" y1="1593.125" y2="1593.125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="267" y="1603.7598">[Validate Prepare Transfer (failure)]</text><path d="M272,1614.0801 L1055,1614.0801 L1055,1621.0801 L1045,1631.0801 L272,1631.0801 L272,1614.0801 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1614.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="287" y="1627.6484">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1244,1679.3223,1254,1683.3223,1244,1687.3223,1248,1683.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="1683.3223" y2="1683.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1663.2695">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="1647.959">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="395" y="1663.2695">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1678.5801">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1678.5801">2003</text><polygon fill="#A80036" points="1641,1708.6328,1651,1712.6328,1641,1716.6328,1645,1712.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="1712.6328" y2="1712.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="1707.8906">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="1707.8906">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f111f2xgtpux8a)" points="1592,1755.6328,1723,1755.6328,1733,1804.6328,1723,1854.6328,1592,1854.6328,1582,1804.6328,1592,1755.6328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="1772.2012">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="1787.5117">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="1802.8223">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="1818.1328">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1594" y="1833.4434">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="1848.7539">ilpPacket</text><polygon fill="#A80036" points="377,1877.8066,367,1881.8066,377,1885.8066,373,1881.8066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="1881.8066" y2="1881.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1877.0645">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="1877.0645">Return success</text><path d="M272,1917.8066 L334,1917.8066 L334,1924.8066 L324,1934.8066 L272,1934.8066 L272,1917.8066 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="1917.8066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="1931.375">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="349" y="1930.4414">[Validate Prepare Transfer (success)]</text><path d="M371,1940.1172 L371,2317.1172 L633,2317.1172 L633,1950.1172 L623,1940.1172 L371,1940.1172 " fill="#FFFF00" filter="url(#f111f2xgtpux8a)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M623,1940.1172 L623,1950.1172 L633,1950.1172 L623,1940.1172 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="1957.6855">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="1972.9961">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="1988.3066">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="393" y="2003.6172">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="393" y="2018.9277">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2034.2383">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2049.5488">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2064.8594">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="409" y="2080.1699">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="2095.4805">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="2110.791">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="2126.1016">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="2141.4121">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="2156.7227">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="425" y="2172.0332">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="2187.3438">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="2202.6543">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="2217.9648">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="441" y="2233.2754">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="441" y="2248.5859">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2263.8965">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2279.207">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2294.5176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2309.8281">}</text><polygon fill="#A80036" points="823,2359.1914,833,2363.1914,823,2367.1914,827,2363.1914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="829" y1="2363.1914" y2="2363.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2350.7939">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="395" y="2343.1387">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2358.4492">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2358.4492">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1213" y1="2402.1914" y2="2402.1914"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="277" y="2412.8262">[Validate Prepare Transfer (failure)]</text><path d="M371,2421.1465 L371,2890.1465 L978,2890.1465 L978,2431.1465 L968,2421.1465 L371,2421.1465 " fill="#FFFF00" filter="url(#f111f2xgtpux8a)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,2421.1465 L968,2431.1465 L978,2431.1465 L968,2421.1465 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="2438.7148">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2454.0254">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2469.3359">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="393" y="2484.6465">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2499.957">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2515.2676">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2530.5781">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2545.8887">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="409" y="2561.1992">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="425" y="2576.5098">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="441" y="2591.8203">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="441" y="2607.1309">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="441" y="2622.4414">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2637.752">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="2653.0625">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="2668.373">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="2683.6836">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="2698.9941">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="2714.3047">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="425" y="2729.6152">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="2744.9258">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="2760.2363">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="2775.5469">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="441" y="2790.8574">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="441" y="2806.168">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="441" y="2821.4785">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2836.7891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2852.0996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2867.4102">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2882.7207">}</text><polygon fill="#A80036" points="1112.5,2932.084,1122.5,2936.084,1112.5,2940.084,1116.5,2936.084" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1118.5" y1="2936.084" y2="2936.084"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2923.6865">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="395" y="2916.0313">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2931.3418">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2931.3418">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "topic-transfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Event Handler" as PREP_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event message
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note

        ref over PREP_HANDLER, DB:  //Transfer// Prepare Request Duplicate Check\n

        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Prepare Transfer (success)
            group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        else Validate Prepare Transfer (failure)
            group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    transferError
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>