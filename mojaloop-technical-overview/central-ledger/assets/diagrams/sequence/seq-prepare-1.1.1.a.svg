<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3480px" preserveAspectRatio="none" style="width:1794px;height:3480px;" version="1.1" viewBox="0 0 1794 3480" width="1794px" zoomAndPan="magnify"><defs><filter height="300%" id="fy2kkv3v7qj9u" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="715" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="3435.3418" style="stroke: #A80036; stroke-width: 1.0;" width="1691" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="814" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="3268.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2769.4492"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="3342.3418"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1793.209"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="2082.5801"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1186.377"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1441.1719"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1215.6875"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1470.4824"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1822.5195"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="2111.8906"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="3254.0547" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="1801.3613" style="stroke: #000000; stroke-width: 2.0;" width="1531" x="242" y="508.7031"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="1478.0137" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="825.0508"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="215.1738" style="stroke: #000000; stroke-width: 2.0;" width="961" x="262" y="849.3613"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="144.5527" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="912.9824"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="941" x="272" y="1016.2246"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1511" x="252" y="1071.5352"/><rect fill="#FFFFFF" height="1177.2637" style="stroke: none; stroke-width: 1.0;" width="1511" x="252" y="1125.8008"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1147.7559"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1402.5508"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1714.9668"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1739.2773"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1491" x="262" y="1991.3828"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="2013.3379"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="2324.0645"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="941" x="272" y="2807.4492"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="113" x2="113" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="361" x2="361" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="840" x2="840" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="993" x2="993" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1129" x2="1129" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1261" x2="1261" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1376" x2="1376" y1="116.2871" y2="3404.3418"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1658" x2="1658" y1="116.2871" y2="3404.3418"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="101.334">topic-transfer-prepare</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="3403.3418"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="3407.3418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="3427.877">topic-transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="113.334">Prepare Event Handler</text><ellipse cx="361" cy="83.7988" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,71.7988,363,66.7988,361,71.7988,363,76.7988,357,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="3416.877">Prepare Event Handler</text><ellipse cx="361" cy="3435.8301" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,3423.8301,363,3418.8301,361,3423.8301,363,3428.8301,357,3423.8301" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="76.7988"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="3403.3418"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="3407.3418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="3427.877">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="76.7988"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="3403.3418"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="3407.3418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="3427.877">Event-Topic</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="76.7988"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="3403.3418"/><rect fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="3407.3418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="3427.877">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="113.334">Position DAO</text><ellipse cx="1261" cy="83.7988" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="3416.877">Position DAO</text><ellipse cx="1261" cy="3435.8301" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="3449.8301" y2="3449.8301"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="113.334">Participant DAO</text><ellipse cx="1376" cy="83.7988" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="3416.877">Participant DAO</text><ellipse cx="1376" cy="3435.8301" fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="3449.8301" y2="3449.8301"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="113.334">Central Store</text><path d="M1640,63.7988 C1640,53.7988 1658,53.7988 1658,53.7988 C1658,53.7988 1676,53.7988 1676,63.7988 L1676,89.7988 C1676,99.7988 1658,99.7988 1658,99.7988 C1658,99.7988 1640,99.7988 1640,89.7988 L1640,63.7988 " fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,63.7988 C1640,73.7988 1658,73.7988 1658,73.7988 C1658,73.7988 1676,73.7988 1676,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="3416.877">Central Store</text><path d="M1640,3429.8301 C1640,3419.8301 1658,3419.8301 1658,3419.8301 C1658,3419.8301 1676,3419.8301 1676,3429.8301 L1676,3455.8301 C1676,3465.8301 1658,3465.8301 1658,3465.8301 C1658,3465.8301 1640,3465.8301 1640,3455.8301 L1640,3429.8301 " fill="#FEFECE" filter="url(#fy2kkv3v7qj9u)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,3429.8301 C1640,3439.8301 1658,3439.8301 1658,3439.8301 C1658,3439.8301 1676,3439.8301 1676,3429.8301 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="3268.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2769.4492"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="3342.3418"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1793.209"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="2082.5801"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1186.377"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1441.1719"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1215.6875"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1470.4824"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1822.5195"/><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="2111.8906"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3254.0547" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="129,167.9082,119,171.9082,129,175.9082,125,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="123" x2="355" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="135" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="148" y="167.166">Consume Prepare event message</text><path d="M262,216.9082 L346,216.9082 L346,223.9082 L336,233.9082 L262,233.9082 L262,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="230.4766">break</text><path d="M272,241.2188 L414,241.2188 L414,248.2188 L404,258.2188 L272,258.2188 L272,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="377,304.1504,367,308.1504,377,312.1504,373,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="386" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="386" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="470" y="290.4082">2001</text><path d="M272,337.1504 L487,337.1504 L487,344.1504 L477,354.1504 L272,354.1504 L272,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="287" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="981.5,396.7715,991.5,400.7715,981.5,404.7715,985.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="987.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="386" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="766" x="279" y="408.7715"/><polygon fill="#EEEEEE" points="279,408.7715,343,408.7715,343,415.7715,333,425.7715,279,425.7715,279,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="589" y="442.3398">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="457.6504"/><path d="M242,508.7031 L461,508.7031 L461,515.7031 L451,525.7031 L242,525.7031 L242,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1801.3613" style="stroke: #000000; stroke-width: 2.0;" width="1531" x="242" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="257" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="377,556.3242,367,560.3242,377,564.3242,373,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="386" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="377,598.6348,367,602.6348,377,606.6348,373,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="386" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M371,615.6348 L371,670.6348 L736,670.6348 L736,625.6348 L726,615.6348 L371,615.6348 " fill="#D3D3D3" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M726,615.6348 L726,625.6348 L736,625.6348 L726,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="377" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="377" y="663.8242">It may need to be added in future for custom adapters.</text><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="132.4844" style="stroke: #000000; stroke-width: 2.0;" width="1426" x="279" y="680.5664"/><polygon fill="#EEEEEE" points="279,680.5664,343,680.5664,343,687.5664,333,697.5664,279,697.5664,279,680.5664" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="695.1348">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="892.5" y="714.1348">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="729.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="892.5" y="744.7559">returns {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="924.5" y="760.0664">hasDuplicateId: Boolean,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="924.5" y="775.377">hasDuplicateHash: Boolean</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="892.5" y="790.6875">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="805.998"/><path d="M252,825.0508 L314,825.0508 L314,832.0508 L304,842.0508 L252,842.0508 L252,825.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1478.0137" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="825.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="267" y="838.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="329" y="837.6855">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M262,849.3613 L346,849.3613 L346,856.3613 L336,866.3613 L262,866.3613 L262,849.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="215.1738" style="stroke: #000000; stroke-width: 2.0;" width="961" x="262" y="849.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="862.9297">break</text><path d="M371,871.6719 L371,896.6719 L693,896.6719 L693,881.6719 L683,871.6719 L371,871.6719 " fill="#D3D3D3" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M683,871.6719 L683,881.6719 L693,881.6719 L683,871.6719 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="377" y="889.2402">stateRecord = await getTransferState(transferId)</text><path d="M272,912.9824 L334,912.9824 L334,919.9824 L324,929.9824 L272,929.9824 L272,912.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="144.5527" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="912.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="926.5508">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="349" y="925.6172">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#fy2kkv3v7qj9u)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="923" x="279" y="955.293"/><polygon fill="#EEEEEE" points="279,955.293,343,955.293,343,962.293,333,972.293,279,972.293,279,955.293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="969.8613">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="678.5" y="988.8613">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="682.5" y="1004.1719"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1213" y1="1017.2246" y2="1017.2246"/><path d="M371,1023.2246 L371,1048.2246 L565,1048.2246 L565,1033.2246 L555,1023.2246 L371,1023.2246 " fill="#D3D3D3" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M555,1023.2246 L555,1033.2246 L565,1033.2246 L555,1023.2246 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="377" y="1040.793">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1763" y1="1072.5352" y2="1072.5352"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="257" y="1083.1699">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M371,1091.4902 L371,1116.4902 L725,1116.4902 L725,1101.4902 L715,1091.4902 L371,1091.4902 " fill="#D3D3D3" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M715,1091.4902 L715,1101.4902 L725,1101.4902 L715,1091.4902 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="1109.0586">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1763" y1="1126.8008" y2="1126.8008"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="257" y="1137.4355">[hasDuplicateId == FALSE]</text><path d="M272,1147.7559 L414,1147.7559 L414,1154.7559 L404,1164.7559 L272,1164.7559 L272,1147.7559 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1147.7559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="1161.3242">Validate Payer</text><polygon fill="#A80036" points="1359,1182.377,1369,1186.377,1359,1190.377,1363,1186.377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="1186.377" y2="1186.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="1181.6348">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="386" y="1181.6348">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1641,1211.6875,1651,1215.6875,1641,1219.6875,1645,1215.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="1215.6875" y2="1215.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1388" y="1210.9453">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1401" y="1210.9453">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fy2kkv3v7qj9u)" points="1594,1228.6875,1722,1228.6875,1732,1247.6875,1722,1266.6875,1594,1266.6875,1584,1247.6875,1594,1228.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="1245.2559">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="1260.5664">participantCurrency</text><polygon fill="#A80036" points="1392,1289.6191,1382,1293.6191,1392,1297.6191,1388,1293.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="1293.6191" y2="1293.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1398" y="1288.877">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1411" y="1288.877">Return Participant details if it exists</text><polygon fill="#A80036" points="377,1318.9297,367,1322.9297,377,1326.9297,373,1322.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="1322.9297" y2="1322.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="383" y="1318.1875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="396" y="1318.1875">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1367.5508" y2="1367.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1367.5508" y2="1380.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1380.5508" y2="1380.5508"/><polygon fill="#A80036" points="377,1376.5508,367,1380.5508,377,1384.5508,373,1380.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1355.1533">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="395" y="1347.498">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1362.8086">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1362.8086">3202</text><path d="M272,1402.5508 L416,1402.5508 L416,1409.5508 L406,1419.5508 L272,1419.5508 L272,1402.5508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1402.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="287" y="1416.1191">Validate Payee</text><polygon fill="#A80036" points="1359,1437.1719,1369,1441.1719,1359,1445.1719,1363,1441.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="1441.1719" y2="1441.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1436.4297">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="395" y="1436.4297">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1641,1466.4824,1651,1470.4824,1641,1474.4824,1645,1470.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="1470.4824" y2="1470.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1388" y="1465.7402">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1410" y="1465.7402">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fy2kkv3v7qj9u)" points="1594,1483.4824,1722,1483.4824,1732,1502.4824,1722,1521.4824,1594,1521.4824,1584,1502.4824,1594,1483.4824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="1500.0508">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="1515.3613">participantCurrency</text><polygon fill="#A80036" points="1392,1544.4141,1382,1548.4141,1392,1552.4141,1388,1548.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="1548.4141" y2="1548.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1398" y="1543.6719">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1420" y="1543.6719">Return Participant details if it exists</text><polygon fill="#A80036" points="377,1573.7246,367,1577.7246,377,1581.7246,373,1577.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="1577.7246" y2="1577.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1572.9824">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="1572.9824">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1622.3457" y2="1622.3457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1622.3457" y2="1635.3457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1635.3457" y2="1635.3457"/><polygon fill="#A80036" points="377,1631.3457,367,1635.3457,377,1639.3457,373,1635.3457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1609.9482">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="395" y="1602.293">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1617.6035">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1617.6035">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1686.9668" y2="1686.9668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1686.9668" y2="1699.9668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1699.9668" y2="1699.9668"/><polygon fill="#A80036" points="377,1695.9668,367,1699.9668,377,1703.9668,373,1699.9668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1674.5693">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="395" y="1666.9141">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1682.2246">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1682.2246">3100</text><path d="M262,1714.9668 L324,1714.9668 L324,1721.9668 L314,1731.9668 L262,1731.9668 L262,1714.9668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1714.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="277" y="1728.5352">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="339" y="1727.6016">[Validate Prepare Transfer (success)]</text><path d="M272,1739.2773 L744,1739.2773 L744,1746.2773 L734,1756.2773 L272,1756.2773 L272,1739.2773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1739.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="287" y="1752.8457">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1244,1789.209,1254,1793.209,1244,1797.209,1248,1793.209" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="1793.209" y2="1793.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1780.8115">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="1773.1563">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1788.4668">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1788.4668">2003</text><polygon fill="#A80036" points="1641,1818.5195,1651,1822.5195,1641,1826.5195,1645,1822.5195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="1822.5195" y2="1822.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="1817.7773">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="1817.7773">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fy2kkv3v7qj9u)" points="1592,1865.5195,1723,1865.5195,1733,1907.5195,1723,1949.5195,1592,1949.5195,1582,1907.5195,1592,1865.5195" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="1882.0879">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="1897.3984">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="1912.709">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="1928.0195">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="1943.3301">ilpPacket</text><polygon fill="#A80036" points="377,1972.3828,367,1976.3828,377,1980.3828,373,1976.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="1976.3828" y2="1976.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1971.6406">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="1971.6406">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="262" x2="1753" y1="1992.3828" y2="1992.3828"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="267" y="2003.0176">[Validate Prepare Transfer (failure)]</text><path d="M272,2013.3379 L1055,2013.3379 L1055,2020.3379 L1045,2030.3379 L272,2030.3379 L272,2013.3379 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="2013.3379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="287" y="2026.9063">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1244,2078.5801,1254,2082.5801,1244,2086.5801,1248,2082.5801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="2082.5801" y2="2082.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2062.5273">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="2047.2168">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="395" y="2062.5273">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2077.8379">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2077.8379">2003</text><polygon fill="#A80036" points="1641,2107.8906,1651,2111.8906,1641,2115.8906,1645,2111.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="2111.8906" y2="2111.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="2107.1484">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="2107.1484">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fy2kkv3v7qj9u)" points="1592,2154.8906,1723,2154.8906,1733,2203.8906,1723,2253.8906,1592,2253.8906,1582,2203.8906,1592,2154.8906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="2171.459">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="2186.7695">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="2202.0801">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="2217.3906">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1594" y="2232.7012">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="2248.0117">ilpPacket</text><polygon fill="#A80036" points="377,2277.0645,367,2281.0645,377,2285.0645,373,2281.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="2281.0645" y2="2281.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="2276.3223">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="2276.3223">Return success</text><path d="M272,2324.0645 L334,2324.0645 L334,2331.0645 L324,2341.0645 L272,2341.0645 L272,2324.0645 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="2324.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="2337.6328">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="349" y="2336.6992">[Validate Prepare Transfer (success)]</text><path d="M371,2346.375 L371,2723.375 L633,2723.375 L633,2356.375 L623,2346.375 L371,2346.375 " fill="#FFFF00" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M623,2346.375 L623,2356.375 L633,2356.375 L623,2346.375 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="2363.9434">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2379.2539">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2394.5645">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="393" y="2409.875">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="393" y="2425.1855">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2440.4961">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2455.8066">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2471.1172">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="409" y="2486.4277">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="2501.7383">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="2517.0488">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="2532.3594">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="2547.6699">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="2562.9805">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="425" y="2578.291">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="2593.6016">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="2608.9121">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="2624.2227">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="441" y="2639.5332">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="441" y="2654.8438">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2670.1543">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2685.4648">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2700.7754">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2716.0859">}</text><polygon fill="#A80036" points="823,2765.4492,833,2769.4492,823,2773.4492,827,2769.4492" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="829" y1="2769.4492" y2="2769.4492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2757.0518">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="395" y="2749.3965">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2764.707">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2764.707">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1213" y1="2808.4492" y2="2808.4492"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="277" y="2819.084">[Validate Prepare Transfer (failure)]</text><path d="M371,2827.4043 L371,3296.4043 L978,3296.4043 L978,2837.4043 L968,2827.4043 L371,2827.4043 " fill="#FFFF00" filter="url(#fy2kkv3v7qj9u)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,2827.4043 L968,2837.4043 L978,2837.4043 L968,2827.4043 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="2844.9727">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2860.2832">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2875.5938">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="393" y="2890.9043">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2906.2148">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2921.5254">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2936.8359">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2952.1465">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="409" y="2967.457">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="425" y="2982.7676">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="441" y="2998.0781">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="441" y="3013.3887">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="441" y="3028.6992">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3044.0098">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="3059.3203">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="3074.6309">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="3089.9414">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="3105.252">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="3120.5625">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="425" y="3135.873">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="3151.1836">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="3166.4941">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="3181.8047">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="441" y="3197.1152">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="441" y="3212.4258">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="441" y="3227.7363">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3243.0469">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3258.3574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3273.668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="3288.9785">}</text><polygon fill="#A80036" points="1112.5,3338.3418,1122.5,3342.3418,1112.5,3346.3418,1116.5,3342.3418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1118.5" y1="3342.3418" y2="3342.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="3329.9443">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="395" y="3322.2891">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="3337.5996">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="3337.5996">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "topic-transfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Event Handler" as PREP_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event message
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume\n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note

        ref over PREP_HANDLER, DB:  Request Duplicate Check\n\nreturns {\n\thasDuplicateId: Boolean,\n\thasDuplicateHash: Boolean\n}\n

        alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
            break
                note right of PREP_HANDLER #lightgrey
                    stateRecord = await getTransferState(transferId)
                end note
                alt endStateList.includes(stateRecord.transferStateId)
                    |||
                    ref over PREP_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                else
                    note right of PREP_HANDLER #lightgrey
                        Ignore - resend in progress
                    end note
                end
            end
        else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
            note right of PREP_HANDLER #lightgrey
                Validate Prepare Transfer (failure) - Modified Request
            end note
        else hasDuplicateId == FALSE

            group Validate Payer
                PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
                activate PARTICIPANT_DAO
                PARTICIPANT_DAO -> DB: Request Participant details
                hnote over DB #lightyellow
                    participant
                    participantCurrency
                end note
                activate DB
                PARTICIPANT_DAO <- - DB: Return Participant details if it exists
                deactivate DB
                PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
                deactivate PARTICIPANT_DAO
                PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
            end
            group Validate Payee
                PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
                activate PARTICIPANT_DAO
                PARTICIPANT_DAO -> DB: Request Participant details
                hnote over DB #lightyellow
                    participant
                    participantCurrency
                end note
                activate DB
                PARTICIPANT_DAO <- - DB: Return Participant details if it exists
                deactivate DB
                PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
                deactivate PARTICIPANT_DAO
                PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
            end
            PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
            
            alt Validate Prepare Transfer (success)
                group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                    PREP_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer
                    hnote over DB #lightyellow
                        transfer
                        transferParticipant
                        transferStateChange
                        transferExtension
                        ilpPacket
                    end note
                    activate DB
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return success
                    deactivate POS_DAO
                end
            else Validate Prepare Transfer (failure)
                group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                    PREP_HANDLER -> POS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer
                    hnote over DB #lightyellow
                        transfer
                        transferParticipant
                        transferStateChange
                        transferExtension
                        transferError
                        ilpPacket
                    end note
                    activate DB
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return success
                    deactivate POS_DAO
                end
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>