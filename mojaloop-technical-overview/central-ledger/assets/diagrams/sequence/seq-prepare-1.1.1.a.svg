<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3493px" preserveAspectRatio="none" style="width:1794px;height:3493px;" version="1.1" viewBox="0 0 1794 3493" width="1794px" zoomAndPan="magnify"><defs><filter height="300%" id="f1k0r9fys6ovsg" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="715" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="3448.4102" style="stroke: #A80036; stroke-width: 1.0;" width="1691" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="814" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="3281.123" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2782.5176"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="3355.4102"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1806.2773"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="2095.6484"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1257.0664"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1511.8613"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1286.377"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1541.1719"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1835.5879"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="2124.959"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="3267.123" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="1814.4297" style="stroke: #000000; stroke-width: 2.0;" width="1531" x="242" y="508.7031"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1444" x="272" y="687.5664"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="1452.7031" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="863.4297"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="961" x="262" y="887.7402"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="954.3613"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="941" x="272" y="1086.9141"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1511" x="252" y="1142.2246"/><rect fill="#FFFFFF" height="1119.6426" style="stroke: none; stroke-width: 1.0;" width="1511" x="252" y="1196.4902"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1218.4453"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1473.2402"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1728.0352"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1752.3457"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1491" x="262" y="2004.4512"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="2026.4063"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="2337.1328"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="941" x="272" y="2820.5176"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="113" x2="113" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="361" x2="361" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="840" x2="840" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="993" x2="993" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1129" x2="1129" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1261" x2="1261" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1376" x2="1376" y1="116.2871" y2="3417.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1658" x2="1658" y1="116.2871" y2="3417.4102"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="101.334">topic-transfer-prepare</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="3416.4102"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="3420.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="3440.9453">topic-transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="113.334">Prepare Event Handler</text><ellipse cx="361" cy="83.7988" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,71.7988,363,66.7988,361,71.7988,363,76.7988,357,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="3429.9453">Prepare Event Handler</text><ellipse cx="361" cy="3448.8984" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,3436.8984,363,3431.8984,361,3436.8984,363,3441.8984,357,3436.8984" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="753" y="3416.4102"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="749" y="3420.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="756" y="3440.9453">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="945" y="3416.4102"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="941" y="3420.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="948" y="3440.9453">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1060" y="3416.4102"/><rect fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1056" y="3420.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1063" y="3440.9453">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="113.334">Position DAO</text><ellipse cx="1261" cy="83.7988" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1213" y="3429.9453">Position DAO</text><ellipse cx="1261" cy="3448.8984" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1249" x2="1273" y1="3462.8984" y2="3462.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="113.334">Participant DAO</text><ellipse cx="1376" cy="83.7988" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1319" y="3429.9453">Participant DAO</text><ellipse cx="1376" cy="3448.8984" fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1364" x2="1388" y1="3462.8984" y2="3462.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="113.334">Central Store</text><path d="M1640,63.7988 C1640,53.7988 1658,53.7988 1658,53.7988 C1658,53.7988 1676,53.7988 1676,63.7988 L1676,89.7988 C1676,99.7988 1658,99.7988 1658,99.7988 C1658,99.7988 1640,99.7988 1640,89.7988 L1640,63.7988 " fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,63.7988 C1640,73.7988 1658,73.7988 1658,73.7988 C1658,73.7988 1676,73.7988 1676,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1610" y="3429.9453">Central Store</text><path d="M1640,3442.8984 C1640,3432.8984 1658,3432.8984 1658,3432.8984 C1658,3432.8984 1676,3432.8984 1676,3442.8984 L1676,3468.8984 C1676,3478.8984 1658,3478.8984 1658,3478.8984 C1658,3478.8984 1640,3478.8984 1640,3468.8984 L1640,3442.8984 " fill="#FEFECE" filter="url(#f1k0r9fys6ovsg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1640,3442.8984 C1640,3452.8984 1658,3452.8984 1658,3452.8984 C1658,3452.8984 1676,3452.8984 1676,3442.8984 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="3281.123" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="835" y="2782.5176"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1124.5" y="3355.4102"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="1806.2773"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256" y="2095.6484"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1257.0664"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1371" y="1511.8613"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1286.377"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1541.1719"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="1835.5879"/><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1653" y="2124.959"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3267.123" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="129,167.9082,119,171.9082,129,175.9082,125,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="123" x2="355" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="135" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="148" y="167.166">Consume Prepare event message</text><path d="M262,216.9082 L346,216.9082 L346,223.9082 L336,233.9082 L262,233.9082 L262,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="230.4766">break</text><path d="M272,241.2188 L414,241.2188 L414,248.2188 L404,258.2188 L272,258.2188 L272,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="377,304.1504,367,308.1504,377,312.1504,373,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="386" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="386" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="470" y="290.4082">2001</text><path d="M272,337.1504 L487,337.1504 L487,344.1504 L477,354.1504 L272,354.1504 L272,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="784" x="272" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="287" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="981.5,396.7715,991.5,400.7715,981.5,404.7715,985.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="987.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="386" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="766" x="279" y="408.7715"/><polygon fill="#EEEEEE" points="279,408.7715,343,408.7715,343,415.7715,333,425.7715,279,425.7715,279,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="589" y="442.3398">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="593" y="457.6504"/><path d="M242,508.7031 L461,508.7031 L461,515.7031 L451,525.7031 L242,525.7031 L242,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1814.4297" style="stroke: #000000; stroke-width: 2.0;" width="1531" x="242" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="257" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="377,556.3242,367,560.3242,377,564.3242,373,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="386" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="377,598.6348,367,602.6348,377,606.6348,373,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="386" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M371,615.6348 L371,670.6348 L736,670.6348 L736,625.6348 L726,615.6348 L371,615.6348 " fill="#D3D3D3" filter="url(#f1k0r9fys6ovsg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M726,615.6348 L726,625.6348 L736,625.6348 L726,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="377" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="377" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M272,687.5664 L485,687.5664 L485,694.5664 L475,704.5664 L272,704.5664 L272,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="161.8633" style="stroke: #000000; stroke-width: 2.0;" width="1444" x="272" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="287" y="701.1348">Validate Duplicate Check</text><polygon fill="#A80036" points="1646,747.1875,1656,751.1875,1646,755.1875,1650,751.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1652" y1="751.1875" y2="751.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="746.4453">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="386" y="746.4453">Request Duplicate Check</text><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1426" x="279" y="759.1875"/><polygon fill="#EEEEEE" points="279,759.1875,343,759.1875,343,766.1875,333,776.1875,279,776.1875,279,759.1875" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="773.7559">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="915.5" y="792.7559">Request Duplicate Check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="919.5" y="808.0664"/><polygon fill="#A80036" points="377,837.4297,367,841.4297,377,845.4297,373,841.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1657" y1="841.4297" y2="841.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="383" y="836.6875">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="396" y="836.6875">Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }</text><path d="M252,863.4297 L314,863.4297 L314,870.4297 L304,880.4297 L252,880.4297 L252,863.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1452.7031" style="stroke: #000000; stroke-width: 2.0;" width="1511" x="252" y="863.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="267" y="876.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="329" y="876.0645">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == TRUE]</text><path d="M262,887.7402 L346,887.7402 L346,894.7402 L336,904.7402 L262,904.7402 L262,887.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="247.4844" style="stroke: #000000; stroke-width: 2.0;" width="961" x="262" y="887.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="901.3086">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="926.3613" y2="926.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="926.3613" y2="939.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="939.3613" y2="939.3613"/><polygon fill="#A80036" points="377,935.3613,367,939.3613,377,943.3613,373,939.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="921.6191">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="386" y="921.6191">stateRecord = await getTransferState(transferId)</text><path d="M272,954.3613 L334,954.3613 L334,961.3613 L324,971.3613 L272,971.3613 L272,954.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="173.8633" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="954.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="967.9297">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="349" y="966.9961">[endStateList.includes(stateRecord.transferStateId)]</text><rect fill="#FFFFFF" filter="url(#f1k0r9fys6ovsg)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="923" x="279" y="996.6719"/><polygon fill="#EEEEEE" points="279,996.6719,343,996.6719,343,1003.6719,333,1013.6719,279,1013.6719,279,996.6719" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="1011.2402">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="678.5" y="1030.2402">getTransfer callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="682.5" y="1045.5508"/><polygon fill="#A80036" points="1117.5,1074.9141,1127.5,1078.9141,1117.5,1082.9141,1121.5,1078.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1123.5" y1="1078.9141" y2="1078.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="1074.1719">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="386" y="1074.1719">Produce message</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1213" y1="1087.9141" y2="1087.9141"/><path d="M371,1093.9141 L371,1118.9141 L565,1118.9141 L565,1103.9141 L555,1093.9141 L371,1093.9141 " fill="#D3D3D3" filter="url(#f1k0r9fys6ovsg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M555,1093.9141 L555,1103.9141 L565,1103.9141 L555,1093.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="377" y="1111.4824">Ignore - resend in progress</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1763" y1="1143.2246" y2="1143.2246"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="257" y="1153.8594">[hasDuplicateId == TRUE &amp;&amp; hasDuplicateHash == FALSE]</text><path d="M371,1162.1797 L371,1187.1797 L725,1187.1797 L725,1172.1797 L715,1162.1797 L371,1162.1797 " fill="#D3D3D3" filter="url(#f1k0r9fys6ovsg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M715,1162.1797 L715,1172.1797 L725,1172.1797 L715,1162.1797 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="1179.748">Validate Prepare Transfer (failure) - Modified Request</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1763" y1="1197.4902" y2="1197.4902"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="257" y="1208.125">[hasDuplicateId == FALSE]</text><path d="M272,1218.4453 L414,1218.4453 L414,1225.4453 L404,1235.4453 L272,1235.4453 L272,1218.4453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1218.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="1232.0137">Validate Payer</text><polygon fill="#A80036" points="1359,1253.0664,1369,1257.0664,1359,1261.0664,1363,1257.0664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="1257.0664" y2="1257.0664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1252.3242">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="395" y="1252.3242">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1641,1282.377,1651,1286.377,1641,1290.377,1645,1286.377" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="1286.377" y2="1286.377"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1388" y="1281.6348">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1410" y="1281.6348">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1k0r9fys6ovsg)" points="1594,1299.377,1722,1299.377,1732,1318.377,1722,1337.377,1594,1337.377,1584,1318.377,1594,1299.377" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="1315.9453">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="1331.2559">participantCurrency</text><polygon fill="#A80036" points="1392,1360.3086,1382,1364.3086,1392,1368.3086,1388,1364.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="1364.3086" y2="1364.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1398" y="1359.5664">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1420" y="1359.5664">Return Participant details if it exists</text><polygon fill="#A80036" points="377,1389.6191,367,1393.6191,377,1397.6191,373,1393.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="1393.6191" y2="1393.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1388.877">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="1388.877">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1438.2402" y2="1438.2402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1438.2402" y2="1451.2402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1451.2402" y2="1451.2402"/><polygon fill="#A80036" points="377,1447.2402,367,1451.2402,377,1455.2402,373,1451.2402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1425.8428">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="395" y="1418.1875">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1433.498">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1433.498">3202</text><path d="M272,1473.2402 L416,1473.2402 L416,1480.2402 L406,1490.2402 L272,1490.2402 L272,1473.2402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1470" x="272" y="1473.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="287" y="1486.8086">Validate Payee</text><polygon fill="#A80036" points="1359,1507.8613,1369,1511.8613,1359,1515.8613,1363,1511.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1365" y1="1511.8613" y2="1511.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1507.1191">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="395" y="1507.1191">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1641,1537.1719,1651,1541.1719,1641,1545.1719,1645,1541.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1381" x2="1647" y1="1541.1719" y2="1541.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1388" y="1536.4297">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1410" y="1536.4297">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1k0r9fys6ovsg)" points="1594,1554.1719,1722,1554.1719,1732,1573.1719,1722,1592.1719,1594,1592.1719,1584,1573.1719,1594,1554.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1596" y="1570.7402">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1596" y="1586.0508">participantCurrency</text><polygon fill="#A80036" points="1392,1615.1035,1382,1619.1035,1392,1623.1035,1388,1619.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1386" x2="1657" y1="1619.1035" y2="1619.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1398" y="1614.3613">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1420" y="1614.3613">Return Participant details if it exists</text><polygon fill="#A80036" points="377,1644.4141,367,1648.4141,377,1652.4141,373,1648.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1375" y1="1648.4141" y2="1648.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1643.6719">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="1643.6719">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1693.0352" y2="1693.0352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1693.0352" y2="1706.0352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1706.0352" y2="1706.0352"/><polygon fill="#A80036" points="377,1702.0352,367,1706.0352,377,1710.0352,373,1706.0352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1680.6377">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="395" y="1672.9824">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1688.293">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1688.293">3203</text><path d="M262,1728.0352 L324,1728.0352 L324,1735.0352 L314,1745.0352 L262,1745.0352 L262,1728.0352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="262" y="1728.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="277" y="1741.6035">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="339" y="1740.6699">[Validate Prepare Transfer (success)]</text><path d="M272,1752.3457 L744,1752.3457 L744,1759.3457 L734,1769.3457 L272,1769.3457 L272,1752.3457 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="1752.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="287" y="1765.9141">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1244,1802.2773,1254,1806.2773,1244,1810.2773,1248,1806.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="1806.2773" y2="1806.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1793.8799">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="1786.2246">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="1801.5352">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="1801.5352">2003</text><polygon fill="#A80036" points="1641,1831.5879,1651,1835.5879,1641,1839.5879,1645,1835.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="1835.5879" y2="1835.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="1830.8457">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="1830.8457">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f1k0r9fys6ovsg)" points="1592,1878.5879,1723,1878.5879,1733,1920.5879,1723,1962.5879,1592,1962.5879,1582,1920.5879,1592,1878.5879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="1895.1563">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="1910.4668">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="1925.7773">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="1941.0879">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="1956.3984">ilpPacket</text><polygon fill="#A80036" points="377,1985.4512,367,1989.4512,377,1993.4512,373,1989.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="1989.4512" y2="1989.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1984.709">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="1984.709">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="262" x2="1753" y1="2005.4512" y2="2005.4512"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="267" y="2016.0859">[Validate Prepare Transfer (failure)]</text><path d="M272,2026.4063 L1055,2026.4063 L1055,2033.4063 L1045,2043.4063 L272,2043.4063 L272,2026.4063 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="272" y="2026.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="287" y="2039.9746">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1244,2091.6484,1254,2095.6484,1244,2099.6484,1248,2095.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1250" y1="2095.6484" y2="2095.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2075.5957">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="2060.2852">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="395" y="2075.5957">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2090.9063">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2090.9063">2003</text><polygon fill="#A80036" points="1641,2120.959,1651,2124.959,1641,2128.959,1645,2124.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266" x2="1647" y1="2124.959" y2="2124.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273" y="2120.2168">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1295" y="2120.2168">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f1k0r9fys6ovsg)" points="1592,2167.959,1723,2167.959,1733,2216.959,1723,2266.959,1592,2266.959,1582,2216.959,1592,2167.959" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1594" y="2184.5273">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1594" y="2199.8379">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1594" y="2215.1484">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1594" y="2230.459">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1594" y="2245.7695">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1594" y="2261.0801">ilpPacket</text><polygon fill="#A80036" points="377,2290.1328,367,2294.1328,377,2298.1328,373,2294.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1260" y1="2294.1328" y2="2294.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="2289.3906">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="2289.3906">Return success</text><path d="M272,2337.1328 L334,2337.1328 L334,2344.1328 L324,2354.1328 L272,2354.1328 L272,2337.1328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="941" x="272" y="2337.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="2350.7012">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="349" y="2349.7676">[Validate Prepare Transfer (success)]</text><path d="M371,2359.4434 L371,2736.4434 L633,2736.4434 L633,2369.4434 L623,2359.4434 L371,2359.4434 " fill="#FFFF00" filter="url(#f1k0r9fys6ovsg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M623,2359.4434 L623,2369.4434 L633,2369.4434 L623,2359.4434 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="2377.0117">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2392.3223">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2407.6328">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="393" y="2422.9434">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="393" y="2438.2539">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2453.5645">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2468.875">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2484.1855">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="409" y="2499.4961">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="2514.8066">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="2530.1172">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="2545.4277">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="2560.7383">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="2576.0488">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="425" y="2591.3594">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="2606.6699">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="2621.9805">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="2637.291">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="441" y="2652.6016">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="441" y="2667.9121">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="2683.2227">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="2698.5332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="2713.8438">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2729.1543">}</text><polygon fill="#A80036" points="823,2778.5176,833,2782.5176,823,2786.5176,827,2782.5176" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="829" y1="2782.5176" y2="2782.5176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2770.1201">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="395" y="2762.4648">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2777.7754">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2777.7754">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1213" y1="2821.5176" y2="2821.5176"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="277" y="2832.1523">[Validate Prepare Transfer (failure)]</text><path d="M371,2840.4727 L371,3309.4727 L978,3309.4727 L978,2850.4727 L968,2840.4727 L371,2840.4727 " fill="#FFFF00" filter="url(#f1k0r9fys6ovsg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,2840.4727 L968,2850.4727 L978,2850.4727 L968,2840.4727 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="2858.041">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="2873.3516">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2888.6621">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="393" y="2903.9727">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="2919.2832">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="2934.5938">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="2949.9043">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="2965.2148">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="409" y="2980.5254">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="425" y="2995.8359">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="441" y="3011.1465">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="441" y="3026.457">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="441" y="3041.7676">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3057.0781">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="3072.3887">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="3087.6992">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="3103.0098">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="3118.3203">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="3133.6309">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="425" y="3148.9414">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="3164.252">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="3179.5625">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="3194.873">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="441" y="3210.1836">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="441" y="3225.4941">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="441" y="3240.8047">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3256.1152">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3271.4258">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3286.7363">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="3302.0469">}</text><polygon fill="#A80036" points="1112.5,3351.4102,1122.5,3355.4102,1112.5,3359.4102,1116.5,3355.4102" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1118.5" y1="3355.4102" y2="3355.4102"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="3343.0127">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="395" y="3335.3574">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="3350.668">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="3350.668">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "topic-transfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Event Handler" as PREP_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event message
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS:  Event Handler Consume\n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note

        group Validate Duplicate Check
            |||
            PREP_HANDLER -> DB: Request Duplicate Check
            ref over PREP_HANDLER, DB:  Request Duplicate Check\n
            DB - -> PREP_HANDLER: Return { hasDuplicateId: Boolean, hasDuplicateHash: Boolean }
        end

        alt hasDuplicateId == TRUE && hasDuplicateHash == TRUE
            break
                PREP_HANDLER -> PREP_HANDLER: stateRecord = await getTransferState(transferId)
                alt endStateList.includes(stateRecord.transferStateId)
                    |||
                    ref over PREP_HANDLER, TOPIC_NOTIFICATIONS: getTransfer callback\n
                    PREP_HANDLER -> TOPIC_NOTIFICATIONS: Produce message
                else
                    note right of PREP_HANDLER #lightgrey
                        Ignore - resend in progress
                    end note
                end
            end
        else hasDuplicateId == TRUE && hasDuplicateHash == FALSE
            note right of PREP_HANDLER #lightgrey
                Validate Prepare Transfer (failure) - Modified Request
            end note
        else hasDuplicateId == FALSE

            group Validate Payer
                PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
                activate PARTICIPANT_DAO
                PARTICIPANT_DAO -> DB: Request Participant details
                hnote over DB #lightyellow
                    participant
                    participantCurrency
                end note
                activate DB
                PARTICIPANT_DAO <- - DB: Return Participant details if it exists
                deactivate DB
                PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
                deactivate PARTICIPANT_DAO
                PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
            end
            group Validate Payee
                PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
                activate PARTICIPANT_DAO
                PARTICIPANT_DAO -> DB: Request Participant details
                hnote over DB #lightyellow
                    participant
                    participantCurrency
                end note
                activate DB
                PARTICIPANT_DAO <- - DB: Return Participant details if it exists
                deactivate DB
                PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
                deactivate PARTICIPANT_DAO
                PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
            end
            
            alt Validate Prepare Transfer (success)
                group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                    PREP_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer
                    hnote over DB #lightyellow
                        transfer
                        transferParticipant
                        transferStateChange
                        transferExtension
                        ilpPacket
                    end note
                    activate DB
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return success
                    deactivate POS_DAO
                end
            else Validate Prepare Transfer (failure)
                group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                    PREP_HANDLER -> POS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer
                    hnote over DB #lightyellow
                        transfer
                        transferParticipant
                        transferStateChange
                        transferExtension
                        transferError
                        ilpPacket
                    end note
                    activate DB
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return success
                    deactivate POS_DAO
                end
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>