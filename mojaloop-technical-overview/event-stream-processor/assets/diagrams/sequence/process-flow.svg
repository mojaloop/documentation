<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4276px" preserveAspectRatio="none" style="width:3592px;height:4276px;" version="1.1" viewBox="0 0 3592 4276" width="3592px" zoomAndPan="magnify"><defs><filter height="300%" id="fb3zazvr9rghu" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="1682.5" y="23.5352">Event Streaming Processor flow</text><rect fill="#D3D3D3" height="4231.3906" style="stroke: #A80036; stroke-width: 1.0;" width="147" x="28" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="47.5" y="47.0566">Central Services</text><rect fill="#ADD8E6" height="4231.3906" style="stroke: #A80036; stroke-width: 1.0;" width="2830.5" x="227" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="1563.25" y="47.0566">Event Stream Processor</text><rect fill="#B0C4DE" height="4231.3906" style="stroke: #A80036; stroke-width: 1.0;" width="113" x="3273" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="3309" y="47.0566">Cache</text><rect fill="#FFFFE0" height="4231.3906" style="stroke: #A80036; stroke-width: 1.0;" width="187" x="3388" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="3437.5" y="47.0566">Elasticsearch</text><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="96.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="828.5957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="288.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="84.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="560.5" y="1000.5039"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="1627.291" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776.5" y="1084.7461"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="771.4531" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1509.5" y="2712.0371"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="478.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2034.5" y="3483.4902"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="229.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2607.5" y="3961.5273"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="4050.1035" style="stroke: #000000; stroke-width: 2.0;" width="3569" x="12" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="1704.5332" style="stroke: #000000; stroke-width: 2.0;" width="2975" x="486" y="1015.5039"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="1255.0801" style="stroke: #000000; stroke-width: 2.0;" width="2761" x="690" y="1413.3359"/><rect fill="#FFFFFF" height="1136.8379" style="stroke: none; stroke-width: 1.0;" width="2761" x="690" y="1531.5781"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="160.1738" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="700" y="1582.8887"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="232.4844" style="stroke: #000000; stroke-width: 2.0;" width="627.5" x="700" y="1757.0625"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="2530.1738"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="778.4531" style="stroke: #000000; stroke-width: 2.0;" width="2070" x="1362" y="2734.0371"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="675.5215" style="stroke: #000000; stroke-width: 2.0;" width="2050" x="1372" y="2829.9688"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="644.2109" style="stroke: #000000; stroke-width: 2.0;" width="2030" x="1382" y="2854.2793"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="497.6582" style="stroke: #000000; stroke-width: 2.0;" width="2010" x="1392" y="2993.832"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="3047.4531"/><rect fill="#FFFFFF" height="305.7949" style="stroke: none; stroke-width: 1.0;" width="2010" x="1392" y="3185.6953"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="3323.9375"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="457.0371" style="stroke: #000000; stroke-width: 2.0;" width="1479.5" x="1912.5" y="3526.4902"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="396.416" style="stroke: #000000; stroke-width: 2.0;" width="780" x="1922.5" y="3580.1113"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="177.5527" style="stroke: #000000; stroke-width: 2.0;" width="418" x="1932.5" y="3689.043"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="103.9316" style="stroke: #000000; stroke-width: 2.0;" width="398" x="1942.5" y="3755.6641"/><rect fill="#FFFFFF" height="44.3105" style="stroke: none; stroke-width: 1.0;" width="398" x="1942.5" y="3815.2852"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="88.9316" style="stroke: #000000; stroke-width: 2.0;" width="750" x="1942.5" y="3880.5957"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="178.8633" style="stroke: #000000; stroke-width: 2.0;" width="938.5" x="2522.5" y="3997.5273"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="75.9316" style="stroke: #000000; stroke-width: 2.0;" width="918.5" x="2532.5" y="4021.8379"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="101" x2="101" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="293" x2="293" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="565" x2="565" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781" x2="781" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1514" x2="1514" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2039.5" x2="2039.5" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2612.5" x2="2612.5" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2869.5" x2="2869.5" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3000.5" x2="3000.5" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3329" x2="3329" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3416" x2="3416" y1="116.2871" y2="4200.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="3511" x2="3511" y1="116.2871" y2="4200.3906"/><rect fill="#FEFECE" filter="url(#fb3zazvr9rghu)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="36" y="76.7988"/><rect fill="#FEFECE" filter="url(#fb3zazvr9rghu)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="32" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="117" x="39" y="101.334">Notification topic</text><rect fill="#FEFECE" filter="url(#fb3zazvr9rghu)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="36" y="4199.3906"/><rect fill="#FEFECE" filter="url(#fb3zazvr9rghu)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="32" y="4203.3906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="117" x="39" y="4223.9258">Notification topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="231" y="113.334">Topic Observable</text><ellipse cx="293.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="289.5,71.7988,295.5,66.7988,293.5,71.7988,295.5,76.7988,289.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="231" y="4212.9258">Topic Observable</text><ellipse cx="293.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="289.5,4219.8789,295.5,4214.8789,293.5,4219.8789,295.5,4224.8789,289.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="496" y="113.334">Tracing Observable</text><ellipse cx="565.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="561.5,71.7988,567.5,66.7988,565.5,71.7988,567.5,76.7988,561.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="496" y="4212.9258">Tracing Observable</text><ellipse cx="565.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="561.5,4219.8789,567.5,4214.8789,565.5,4219.8789,567.5,4224.8789,561.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="137" x="710" y="113.334">Caching Observable</text><ellipse cx="781.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777.5,71.7988,783.5,66.7988,781.5,71.7988,783.5,76.7988,777.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="137" x="710" y="4212.9258">Caching Observable</text><ellipse cx="781.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777.5,4219.8789,783.5,4214.8789,781.5,4219.8789,783.5,4224.8789,777.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="219" x="1402" y="113.334">Check For Last Span Observable</text><ellipse cx="1514.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1510.5,71.7988,1516.5,66.7988,1514.5,71.7988,1516.5,76.7988,1510.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="219" x="1402" y="4212.9258">Check For Last Span Observable</text><ellipse cx="1514.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1510.5,4219.8789,1516.5,4214.8789,1514.5,4219.8789,1516.5,4224.8789,1510.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="168" x="1952.5" y="113.334">Create Trace Observable</text><ellipse cx="2039.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2035.5,71.7988,2041.5,66.7988,2039.5,71.7988,2041.5,76.7988,2035.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="168" x="1952.5" y="4212.9258">Create Trace Observable</text><ellipse cx="2039.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2035.5,4219.8789,2041.5,4214.8789,2039.5,4219.8789,2041.5,4224.8789,2035.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="134" x="2542.5" y="113.334">Send Trace Handler</text><ellipse cx="2612.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2608.5,71.7988,2614.5,66.7988,2612.5,71.7988,2614.5,76.7988,2608.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="134" x="2542.5" y="4212.9258">Send Trace Handler</text><ellipse cx="2612.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2608.5,4219.8789,2614.5,4214.8789,2612.5,4219.8789,2614.5,4224.8789,2608.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="2801.5" y="113.334">Send Span Handler</text><ellipse cx="2869.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2865.5,71.7988,2871.5,66.7988,2869.5,71.7988,2871.5,76.7988,2865.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="2801.5" y="4212.9258">Send Span Handler</text><ellipse cx="2869.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2865.5,4219.8789,2871.5,4214.8789,2869.5,4219.8789,2871.5,4224.8789,2865.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="2947.5" y="113.334">Cache Handler</text><ellipse cx="3000.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2996.5,71.7988,3002.5,66.7988,3000.5,71.7988,3002.5,76.7988,2996.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="2947.5" y="4212.9258">Cache Handler</text><ellipse cx="3000.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2996.5,4219.8789,3002.5,4214.8789,3000.5,4219.8789,3002.5,4224.8789,2996.5,4219.8789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="99" x="3277" y="113.334">Cache Storage</text><path d="M3311.5,63.7988 C3311.5,53.7988 3329.5,53.7988 3329.5,53.7988 C3329.5,53.7988 3347.5,53.7988 3347.5,63.7988 L3347.5,89.7988 C3347.5,99.7988 3329.5,99.7988 3329.5,99.7988 C3329.5,99.7988 3311.5,99.7988 3311.5,89.7988 L3311.5,63.7988 " fill="#FEFECE" filter="url(#fb3zazvr9rghu)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M3311.5,63.7988 C3311.5,73.7988 3329.5,73.7988 3329.5,73.7988 C3329.5,73.7988 3347.5,73.7988 3347.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="99" x="3277" y="4212.9258">Cache Storage</text><path d="M3311.5,4225.8789 C3311.5,4215.8789 3329.5,4215.8789 3329.5,4215.8789 C3329.5,4215.8789 3347.5,4215.8789 3347.5,4225.8789 L3347.5,4251.8789 C3347.5,4261.8789 3329.5,4261.8789 3329.5,4261.8789 C3329.5,4261.8789 3311.5,4261.8789 3311.5,4251.8789 L3311.5,4225.8789 " fill="#FEFECE" filter="url(#fb3zazvr9rghu)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M3311.5,4225.8789 C3311.5,4235.8789 3329.5,4235.8789 3329.5,4235.8789 C3329.5,4235.8789 3347.5,4235.8789 3347.5,4225.8789 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="3398.5" y="113.334">APM</text><path d="M3396,71.7988 L3396,95.7988 M3396,83.7988 L3413,83.7988 " fill="none" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3425" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="3398.5" y="4212.9258">APM</text><path d="M3396,4219.8789 L3396,4243.8789 M3396,4231.8789 L3413,4231.8789 " fill="none" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3425" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="3451" y="113.334">Elasticsearch API</text><path d="M3490.5,71.7988 L3490.5,95.7988 M3490.5,83.7988 L3507.5,83.7988 " fill="none" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3519.5" cy="83.7988" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="3451" y="4212.9258">Elasticsearch API</text><path d="M3490.5,4219.8789 L3490.5,4243.8789 M3490.5,4231.8789 L3507.5,4231.8789 " fill="none" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="3519.5" cy="4231.8789" fill="#FEFECE" filter="url(#fb3zazvr9rghu)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="96.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="828.5957" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="288.5" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="84.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="560.5" y="1000.5039"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="1627.291" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776.5" y="1084.7461"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="771.4531" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1509.5" y="2712.0371"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="478.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2034.5" y="3483.4902"/><rect fill="#FFFFFF" filter="url(#fb3zazvr9rghu)" height="229.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2607.5" y="3961.5273"/><path d="M12,133.2871 L256,133.2871 L256,140.2871 L246,150.2871 L12,150.2871 L12,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4050.1035" style="stroke: #000000; stroke-width: 2.0;" width="3569" x="12" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="199" x="27" y="146.8555">New Event Message Received</text><polygon fill="#A80036" points="276.5,167.9082,286.5,171.9082,276.5,175.9082,280.5,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="106.5" x2="282.5" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="113.5" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="126.5" y="167.166">Consume Event Message</text><path d="M22,214.9082 L22,897.9082 L560,897.9082 L560,224.9082 L550,214.9082 L22,214.9082 " fill="#FFFF00" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M550,214.9082 L550,224.9082 L560,224.9082 L550,214.9082 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="28" y="232.4766">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="36" y="247.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="44" y="263.0977">"from": "payeefsp",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="44" y="278.4082">"to": "payerfsp",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="44" y="293.7188">"id": "659ee338-c8f8-4c06-8aff-944e6c5cd694",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="44" y="309.0293">"content": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="52" y="324.3398">"headers": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="60" y="339.6504">"content-type": "applicationvnd.interoperability.transfers+json;version=1.0",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="60" y="354.9609">"date": "2019-05-28T16:34:41.000Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="60" y="370.2715">"fspiop-source": "payeefsp",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="60" y="385.582">"fspiop-destination": "payerfsp"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="52" y="400.8926">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="52" y="416.2031">"payload": &lt;payload&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="44" y="431.5137">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="44" y="446.8242">"type": "application/json",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="44" y="462.1348">"metadata": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="52" y="477.4453">"event": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="60" y="492.7559">"id": "3920382d-f78c-4023-adf9-0d7a4a2a3a2f",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="60" y="508.0664">"type": "trace",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="60" y="523.377">"action": "span",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="60" y="538.6875">"createdAt": "2019-05-29T23:18:32.935Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="60" y="553.998">"state": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="68" y="569.3086">"status": "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="68" y="584.6191">"code": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="68" y="599.9297">"description": "action successful"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="60" y="615.2402">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="60" y="630.5508">"responseTo": "1a396c07-47ab-4d68-a7a0-7a1ea36f0012"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="52" y="645.8613">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="52" y="661.1719">"trace": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="60" y="676.4824">"service": "central-ledger-prepare-handler",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="60" y="691.793">"traceId": "bbd7b2c7bbd7b2c7",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="60" y="707.1035">"parentSpanId": "44ba9bbc5840",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="60" y="722.4141">"spanId": "2aa9cd0a7e87",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="60" y="737.7246">"startTimestamp": "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="60" y="753.0352">"finishTimestamp": "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="60" y="768.3457">"tags": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="68" y="783.6563">"transctionId": "659ee338-c8f8-4c06-8aff-944e6c5cd694",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="68" y="798.9668">"transctionType": "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="68" y="814.2773">"parentEventType": "bulk-prepare",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="68" y="829.5879">"parentEventAction": "prepare"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="60" y="844.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="52" y="860.209">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="44" y="875.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="36" y="890.8301">}</text><polygon fill="#A80036" points="3499,924.8828,3509,928.8828,3499,932.8828,3503,928.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298.5" x2="3505" y1="928.8828" y2="928.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="305.5" y="924.1406">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="318.5" y="924.1406">Send message for log purposes to custom index</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="298.5" x2="340.5" y1="958.1934" y2="958.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="340.5" x2="340.5" y1="958.1934" y2="971.1934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="299.5" x2="340.5" y1="971.1934" y2="971.1934"/><polygon fill="#A80036" points="309.5,967.1934,299.5,971.1934,309.5,975.1934,305.5,971.1934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="305.5" y="953.4512">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="318.5" y="953.4512">Verify its tracing event Message</text><polygon fill="#A80036" points="548.5,996.5039,558.5,1000.5039,548.5,1004.5039,552.5,1000.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="293.5" x2="554.5" y1="1000.5039" y2="1000.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="300.5" y="995.7617">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="313.5" y="995.7617">Send Message to Tracing Observable</text><path d="M486,1015.5039 L609,1015.5039 L609,1022.5039 L599,1032.5039 L486,1032.5039 L486,1015.5039 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1704.5332" style="stroke: #000000; stroke-width: 2.0;" width="2975" x="486" y="1015.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="501" y="1029.0723">Cache Span</text><polygon fill="#A80036" points="764.5,1080.7461,774.5,1084.7461,764.5,1088.7461,768.5,1084.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="565.5" x2="770.5" y1="1084.7461" y2="1084.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="572.5" y="1064.6934">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="585.5" y="1049.3828">Send Span Context,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="585.5" y="1064.6934">metadata.State and Content</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="585.5" y="1080.0039">from Message</text><path d="M570,1097.7461 L570,1367.7461 L984,1367.7461 L984,1107.7461 L974,1097.7461 L570,1097.7461 " fill="#FFFF00" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M974,1097.7461 L974,1107.7461 L984,1107.7461 L974,1097.7461 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="576" y="1115.3145">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="584" y="1130.625">spanContext: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="592" y="1145.9355">service: "central-ledger-prepare-handler",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="592" y="1161.2461">traceId: "bbd7b2c7bbd7b2c7",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="592" y="1176.5566">parentSpanId: "44ba9bbc5840",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="592" y="1191.8672">spanId: "2aa9cd0a7e87",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="592" y="1207.1777">startTimestamp: "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="592" y="1222.4883">finishTimestamp: "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="592" y="1237.7988">tags: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="600" y="1253.1094">transctionId: "659ee338-c8f8-4c06-8aff-944e6c5cd694",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="600" y="1268.4199">transctionType: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="600" y="1283.7305">parentEventType: "bulk-prepare",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="600" y="1299.041">parentEventAction: "prepare"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="592" y="1314.3516">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="584" y="1329.6621">state: metadata.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="584" y="1344.9727">content</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="576" y="1360.2832">}</text><polygon fill="#A80036" points="797.5,1394.3359,787.5,1398.3359,797.5,1402.3359,793.5,1398.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="791.5" x2="3328.5" y1="1398.3359" y2="1398.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="803.5" y="1393.5938">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="816.5" y="1393.5938">Get cachedTrace by traceId</text><path d="M690,1413.3359 L752,1413.3359 L752,1420.3359 L742,1430.3359 L690,1430.3359 L690,1413.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1255.0801" style="stroke: #000000; stroke-width: 2.0;" width="2761" x="690" y="1413.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="705" y="1426.9043">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="767" y="1425.9707">[the span should not be cached]</text><polygon fill="#A80036" points="2857.5,1447.957,2867.5,1451.957,2857.5,1455.957,2861.5,1451.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="2863.5" y1="1451.957" y2="1451.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="793.5" y="1447.2148">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="806.5" y="1447.2148">currentSpan</text><polygon fill="#A80036" points="3404.5,1477.2676,3414.5,1481.2676,3404.5,1485.2676,3408.5,1481.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2869.5" x2="3410.5" y1="1481.2676" y2="1481.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="2876.5" y="1476.5254">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="2889.5" y="1476.5254">store to APM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1510.5781" y2="1510.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1510.5781" y2="1523.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1523.5781" y2="1523.5781"/><polygon fill="#A80036" points="797.5,1519.5781,787.5,1523.5781,797.5,1527.5781,793.5,1523.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="793.5" y="1505.8359">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="806.5" y="1505.8359">Complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="3451" y1="1532.5781" y2="1532.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1554.8887" y2="1554.8887"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1554.8887" y2="1567.8887"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1567.8887" y2="1567.8887"/><polygon fill="#A80036" points="797.5,1563.8887,787.5,1567.8887,797.5,1571.8887,793.5,1567.8887" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1550.1465">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="687" x="815.5" y="1550.1465">Validate transactionType, TransactionAction and service to match Config.START_CRITERIA &amp;&amp; !parentSpandId</text><path d="M700,1582.8887 L762,1582.8887 L762,1589.8887 L752,1599.8887 L700,1599.8887 L700,1582.8887 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="160.1738" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="700" y="1582.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="715" y="1596.457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="777" y="1595.5234">[!cachedTrace]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1621.5098" y2="1621.5098"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1621.5098" y2="1634.5098"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1634.5098" y2="1634.5098"/><polygon fill="#A80036" points="797.5,1630.5098,787.5,1634.5098,797.5,1638.5098,793.5,1634.5098" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1616.7676">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="815.5" y="1616.7676">Create new cachedTrace</text><path d="M791,1647.5098 L791,1733.5098 L929,1733.5098 L929,1657.5098 L919,1647.5098 L791,1647.5098 " fill="#FFFF00" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M919,1647.5098 L919,1657.5098 L929,1657.5098 L919,1647.5098 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="797" y="1665.0781">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="805" y="1680.3887">spans: {},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="805" y="1695.6992">masterSpan: null,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="805" y="1711.0098">lastSpan: null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="797" y="1726.3203">}</text><path d="M700,1757.0625 L762,1757.0625 L762,1764.0625 L752,1774.0625 L700,1774.0625 L700,1757.0625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="232.4844" style="stroke: #000000; stroke-width: 2.0;" width="627.5" x="700" y="1757.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="715" y="1770.6309">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="777" y="1769.6973">[!parentSpan]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1795.6836" y2="1795.6836"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1795.6836" y2="1808.6836"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1808.6836" y2="1808.6836"/><polygon fill="#A80036" points="797.5,1804.6836,787.5,1808.6836,797.5,1812.6836,793.5,1808.6836" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1790.9414">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="815.5" y="1790.9414">Generate MasterSpanId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1853.3047" y2="1853.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1853.3047" y2="1866.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1866.3047" y2="1866.3047"/><polygon fill="#A80036" points="797.5,1862.3047,787.5,1866.3047,797.5,1870.3047,793.5,1866.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1840.9072">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="815.5" y="1833.252">Make received span child of masterSpan</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="815.5" y="1848.5625">merge({ parentSpanId: MasterSpanId }, { ...spanContext })</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1926.2363" y2="1926.2363"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1926.2363" y2="1939.2363"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1939.2363" y2="1939.2363"/><polygon fill="#A80036" points="797.5,1935.2363,787.5,1939.2363,797.5,1943.2363,793.5,1939.2363" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1906.1836">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="815.5" y="1890.873">Create MasterSpanContext merge({ tags: { ...tags, masterSpan: MasterSpanId } },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="815.5" y="1906.1836">{ ...spanContext },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="815.5" y="1921.4941">{ spanId: MasterSpanId, service: `master-${tags.transactionType}` })</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="828.5" y1="1968.5469" y2="1968.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="828.5" x2="828.5" y1="1968.5469" y2="1981.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787.5" x2="828.5" y1="1981.5469" y2="1981.5469"/><polygon fill="#A80036" points="797.5,1977.5469,787.5,1981.5469,797.5,1985.5469,793.5,1981.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="1963.8047">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="815.5" y="1963.8047">Add masterSpan to cachedTrace</text><polygon fill="#A80036" points="797.5,2013.8574,787.5,2017.8574,797.5,2021.8574,793.5,2017.8574" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="2988.5,2013.8574,2998.5,2017.8574,2988.5,2021.8574,2992.5,2017.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="791.5" x2="2994.5" y1="2017.8574" y2="2017.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="803.5" y="2013.1152">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="825.5" y="2013.1152">Add span to cachedTrace</text><path d="M791,2030.8574 L791,2484.8574 L1223,2484.8574 L1223,2040.8574 L1213,2030.8574 L791,2030.8574 " fill="#FFFF00" filter="url(#fb3zazvr9rghu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1213,2030.8574 L1213,2040.8574 L1223,2040.8574 L1213,2030.8574 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="797" y="2048.4258">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="805" y="2063.7363">spans: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="813" y="2079.0469">2aa9cd0a7e87: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="813" y="2094.3574">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="813" y="2109.668">content</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="813" y="2124.9785">spanContext: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="821" y="2140.2891">"service": "central-ledger-prepare-handler",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="821" y="2155.5996">"traceId": "bbd7b2c7bbd7b2c7",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="821" y="2170.9102">"parentSpanId":</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="921" y="2170.9102">MasterSpanId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1013" y="2170.9102">,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="821" y="2186.2207">"spanId": "2aa9cd0a7e87",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="821" y="2201.5313">"startTimestamp": "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="821" y="2216.8418">"finishTimestamp": "2015-08-29T11:22:09.815479Z",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="821" y="2232.1523">"tags": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="829" y="2247.4629">"transctionId": "659ee338-c8f8-4c06-8aff-944e6c5cd694",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="829" y="2262.7734">"transctionType": "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="829" y="2278.084">"parentEventType": "bulk-prepare",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="829" y="2293.3945">"parentEventAction": "prepare"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="821" y="2308.7051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="813" y="2324.0156">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="805" y="2339.3262">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="805" y="2354.6367"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="805" y="2354.6367">MasterSpanId:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="904" y="2354.6367">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="813" y="2369.9473">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="813" y="2385.2578">content,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="813" y="2400.5684">MasterSpanContext</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="805" y="2415.8789">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="797" y="2431.1895">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="797" y="2446.5">masterSpan:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="878" y="2446.5">MasterSpanContext</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1009" y="2446.5">,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="797" y="2461.8105">lastSpan: null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="797" y="2477.1211">}</text><polygon fill="#A80036" points="2988.5,2511.1738,2998.5,2515.1738,2988.5,2519.1738,2992.5,2515.1738" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786.5" x2="2994.5" y1="2515.1738" y2="2515.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="793.5" y="2510.4316">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="815.5" y="2510.4316">Update cachedTrace to Cache</text><path d="M2937.5,2530.1738 L2999.5,2530.1738 L2999.5,2537.1738 L2989.5,2547.1738 L2937.5,2547.1738 L2937.5,2530.1738 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="2530.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="2952.5" y="2543.7422">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="3014.5" y="2542.8086">[cachedTrace not staled or expired]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="2568.7949" y2="2568.7949"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="2568.7949" y2="2581.7949"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="2581.7949" y2="2581.7949"/><polygon fill="#A80036" points="3011.5,2577.7949,3001.5,2581.7949,3011.5,2585.7949,3007.5,2581.7949" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="2564.0527">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="3029.5" y="2564.0527">unsubscribe from Scheduler</text><polygon fill="#A80036" points="3317.5,2607.1055,3327.5,2611.1055,3317.5,2615.1055,3321.5,2611.1055" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3323.5" y1="2611.1055" y2="2611.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="2606.3633">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="3029.5" y="2606.3633">record cachedTrace</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="2640.416" y2="2640.416"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="2640.416" y2="2653.416"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="2653.416" y2="2653.416"/><polygon fill="#A80036" points="3011.5,2649.416,3001.5,2653.416,3011.5,2657.416,3007.5,2653.416" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="2635.6738">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="3029.5" y="2635.6738">Reschedule scheduler for handling stale traces</text><polygon fill="#A80036" points="1497.5,2708.0371,1507.5,2712.0371,1497.5,2716.0371,1501.5,2712.0371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="781.5" x2="1503.5" y1="2712.0371" y2="2712.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="788.5" y="2699.6396">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="810.5" y="2691.9844">Send traceId to check if last span has been received</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="810.5" y="2707.2949">and cached</text><path d="M1362,2734.0371 L1536,2734.0371 L1536,2741.0371 L1526,2751.0371 L1362,2751.0371 L1362,2734.0371 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="778.4531" style="stroke: #000000; stroke-width: 2.0;" width="2070" x="1362" y="2734.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="1377" y="2747.6055">Check for last span</text><polygon fill="#A80036" points="1530.5,2768.6582,1520.5,2772.6582,1530.5,2776.6582,1526.5,2772.6582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1524.5" x2="3328.5" y1="2772.6582" y2="2772.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1536.5" y="2767.916">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="1558.5" y="2767.916">Get cachedTrace by traceId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="1561.5" y1="2801.9688" y2="2801.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1561.5" x2="1561.5" y1="2801.9688" y2="2814.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1520.5" x2="1561.5" y1="2814.9688" y2="2814.9688"/><polygon fill="#A80036" points="1530.5,2810.9688,1520.5,2814.9688,1530.5,2818.9688,1526.5,2814.9688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="2797.2266">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="1548.5" y="2797.2266">Sort spans by startTimestamp</text><path d="M1372,2829.9688 L1446,2829.9688 L1446,2836.9688 L1436,2846.9688 L1372,2846.9688 L1372,2829.9688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="675.5215" style="stroke: #000000; stroke-width: 2.0;" width="2050" x="1372" y="2829.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1387" y="2843.5371">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="1461" y="2842.6035">[for currentSpan of SortedSpans]</text><path d="M1382,2854.2793 L1444,2854.2793 L1444,2861.2793 L1434,2871.2793 L1382,2871.2793 L1382,2854.2793 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="644.2109" style="stroke: #000000; stroke-width: 2.0;" width="2030" x="1382" y="2854.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1397" y="2867.8477">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="69" x="1459" y="2866.9141">[parentSpan]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="1561.5" y1="2923.5215" y2="2923.5215"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1561.5" x2="1561.5" y1="2923.5215" y2="2936.5215"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1520.5" x2="1561.5" y1="2936.5215" y2="2936.5215"/><polygon fill="#A80036" points="1530.5,2932.5215,1520.5,2936.5215,1530.5,2940.5215,1526.5,2936.5215" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="2903.4688">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1548.5" y="2888.1582">isError = (errorCode in parentSpan</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="1548.5" y="2903.4688">OR parentSpan status === failed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1548.5" y="2918.7793">OR status === failed)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="1561.5" y1="2965.832" y2="2965.832"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1561.5" x2="1561.5" y1="2965.832" y2="2978.832"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1520.5" x2="1561.5" y1="2978.832" y2="2978.832"/><polygon fill="#A80036" points="1530.5,2974.832,1520.5,2978.832,1530.5,2982.832,1526.5,2978.832" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="2961.0898">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="1548.5" y="2961.0898">apply masterSpan and error tags from parent to current span in cachedTrace</text><path d="M1392,2993.832 L1454,2993.832 L1454,3000.832 L1444,3010.832 L1392,3010.832 L1392,2993.832 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="497.6582" style="stroke: #000000; stroke-width: 2.0;" width="2010" x="1392" y="2993.832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1407" y="3007.4004">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="69" x="1469" y="3006.4668">[!isLastSpan]</text><polygon fill="#A80036" points="2988.5,3028.4531,2998.5,3032.4531,2988.5,3036.4531,2992.5,3032.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="2994.5" y1="3032.4531" y2="3032.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="3027.7109">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="1548.5" y="3027.7109">Update cachedTrace to Cache</text><path d="M2937.5,3047.4531 L2999.5,3047.4531 L2999.5,3054.4531 L2989.5,3064.4531 L2937.5,3064.4531 L2937.5,3047.4531 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="3047.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="2952.5" y="3061.0215">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="3014.5" y="3060.0879">[cachedTrace not staled or expired]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="3086.0742" y2="3086.0742"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="3086.0742" y2="3099.0742"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="3099.0742" y2="3099.0742"/><polygon fill="#A80036" points="3011.5,3095.0742,3001.5,3099.0742,3011.5,3103.0742,3007.5,3099.0742" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3081.332">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="3029.5" y="3081.332">unsubscribe from Scheduler</text><polygon fill="#A80036" points="3317.5,3124.3848,3327.5,3128.3848,3317.5,3132.3848,3321.5,3128.3848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3323.5" y1="3128.3848" y2="3128.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3123.6426">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="3029.5" y="3123.6426">record cachedTrace</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="3157.6953" y2="3157.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="3157.6953" y2="3170.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="3170.6953" y2="3170.6953"/><polygon fill="#A80036" points="3011.5,3166.6953,3001.5,3170.6953,3011.5,3174.6953,3007.5,3170.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3152.9531">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="3029.5" y="3152.9531">Reschedule scheduler for handling stale traces</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1392" x2="3402" y1="3186.6953" y2="3186.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="1561.5" y1="3224.3164" y2="3224.3164"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1561.5" x2="1561.5" y1="3224.3164" y2="3237.3164"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1520.5" x2="1561.5" y1="3237.3164" y2="3237.3164"/><polygon fill="#A80036" points="1530.5,3233.3164,1520.5,3237.3164,1530.5,3241.3164,1526.5,3237.3164" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="3211.9189">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="1548.5" y="3204.2637">Validate transactionType, TransactionAction, service and isError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="1548.5" y="3219.5742">to match Config.START_CRITERIA &amp;&amp; !parentSpandId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="1561.5" y1="3266.627" y2="3266.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1561.5" x2="1561.5" y1="3266.627" y2="3279.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1520.5" x2="1561.5" y1="3279.627" y2="3279.627"/><polygon fill="#A80036" points="1530.5,3275.627,1520.5,3279.627,1530.5,3283.627,1526.5,3279.627" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="3261.8848">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="1548.5" y="3261.8848">cachedTrace.lastSpan = currentSpan.spanContext</text><polygon fill="#A80036" points="2988.5,3304.9375,2998.5,3308.9375,2988.5,3312.9375,2992.5,3308.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1519.5" x2="2994.5" y1="3308.9375" y2="3308.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1526.5" y="3304.1953">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="1548.5" y="3304.1953">Update cachedTrace to Cache</text><path d="M2937.5,3323.9375 L2999.5,3323.9375 L2999.5,3330.9375 L2989.5,3340.9375 L2937.5,3340.9375 L2937.5,3323.9375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.2422" style="stroke: #000000; stroke-width: 2.0;" width="454.5" x="2937.5" y="3323.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="2952.5" y="3337.5059">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="3014.5" y="3336.5723">[cachedTrace not staled or expired]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="3362.5586" y2="3362.5586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="3362.5586" y2="3375.5586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="3375.5586" y2="3375.5586"/><polygon fill="#A80036" points="3011.5,3371.5586,3001.5,3375.5586,3011.5,3379.5586,3007.5,3375.5586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3357.8164">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="3029.5" y="3357.8164">unsubscribe from Scheduler</text><polygon fill="#A80036" points="3317.5,3400.8691,3327.5,3404.8691,3317.5,3408.8691,3321.5,3404.8691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3323.5" y1="3404.8691" y2="3404.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3400.127">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="3029.5" y="3400.127">record cachedTrace</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="3000.5" x2="3042.5" y1="3434.1797" y2="3434.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3042.5" x2="3042.5" y1="3434.1797" y2="3447.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3001.5" x2="3042.5" y1="3447.1797" y2="3447.1797"/><polygon fill="#A80036" points="3011.5,3443.1797,3001.5,3447.1797,3011.5,3451.1797,3007.5,3447.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="3007.5" y="3429.4375">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="3029.5" y="3429.4375">Reschedule scheduler for handling stale traces</text><polygon fill="#A80036" points="2022.5,3479.4902,2032.5,3483.4902,2022.5,3487.4902,2026.5,3483.4902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1514.5" x2="2028.5" y1="3483.4902" y2="3483.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1521.5" y="3478.748">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="1543.5" y="3478.748">Send traceId</text><path d="M1912.5,3526.4902 L2190.5,3526.4902 L2190.5,3533.4902 L2180.5,3543.4902 L1912.5,3543.4902 L1912.5,3526.4902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="457.0371" style="stroke: #000000; stroke-width: 2.0;" width="1479.5" x="1912.5" y="3526.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="1927.5" y="3540.0586">Recreate Trace from Cached Trace</text><polygon fill="#A80036" points="2055.5,3561.1113,2045.5,3565.1113,2055.5,3569.1113,2051.5,3565.1113" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2049.5" x2="3328.5" y1="3565.1113" y2="3565.1113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2061.5" y="3560.3691">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="2083.5" y="3560.3691">get cachedTrace by TraceId</text><path d="M1922.5,3580.1113 L1984.5,3580.1113 L1984.5,3587.1113 L1974.5,3597.1113 L1922.5,3597.1113 L1922.5,3580.1113 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="396.416" style="stroke: #000000; stroke-width: 2.0;" width="780" x="1922.5" y="3580.1113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1937.5" y="3593.6797">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="1999.5" y="3592.7461">[cachedTrace.lastSpan AND cachedTrace.masterSpan]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3618.7324" y2="3618.7324"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3618.7324" y2="3631.7324"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3631.7324" y2="3631.7324"/><polygon fill="#A80036" points="2055.5,3627.7324,2045.5,3631.7324,2055.5,3635.7324,2051.5,3631.7324" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3613.9902">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="2073.5" y="3613.9902">currentSpan = lastSpan</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3661.043" y2="3661.043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3661.043" y2="3674.043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3674.043" y2="3674.043"/><polygon fill="#A80036" points="2055.5,3670.043,2045.5,3674.043,2055.5,3678.043,2051.5,3674.043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3656.3008">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="2073.5" y="3656.3008">resultTrace = [lastSpan]</text><path d="M1932.5,3689.043 L2006.5,3689.043 L2006.5,3696.043 L1996.5,3706.043 L1932.5,3706.043 L1932.5,3689.043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="177.5527" style="stroke: #000000; stroke-width: 2.0;" width="418" x="1932.5" y="3689.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1947.5" y="3702.6113">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="2021.5" y="3701.6777">[for i = 0; i &lt; cachedTrace.spans.length; i++]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3727.6641" y2="3727.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3727.6641" y2="3740.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3740.6641" y2="3740.6641"/><polygon fill="#A80036" points="2055.5,3736.6641,2045.5,3740.6641,2055.5,3744.6641,2051.5,3740.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3722.9219">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="2073.5" y="3722.9219">get parentSpan of currentSpan</text><path d="M1942.5,3755.6641 L2004.5,3755.6641 L2004.5,3762.6641 L1994.5,3772.6641 L1942.5,3772.6641 L1942.5,3755.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="103.9316" style="stroke: #000000; stroke-width: 2.0;" width="398" x="1942.5" y="3755.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1957.5" y="3769.2324">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="69" x="2019.5" y="3768.2988">[parentSpan]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3794.2852" y2="3794.2852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3794.2852" y2="3807.2852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3807.2852" y2="3807.2852"/><polygon fill="#A80036" points="2055.5,3803.2852,2045.5,3807.2852,2055.5,3811.2852,2051.5,3807.2852" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3789.543">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="2073.5" y="3789.543">insert parent span in resultTrace in front</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1942.5" x2="2340.5" y1="3816.2852" y2="3816.2852"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3838.5957" y2="3838.5957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3838.5957" y2="3851.5957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3851.5957" y2="3851.5957"/><polygon fill="#A80036" points="2055.5,3847.5957,2045.5,3851.5957,2055.5,3855.5957,2051.5,3851.5957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3833.8535">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="2073.5" y="3833.8535">break loop</text><path d="M1942.5,3880.5957 L2004.5,3880.5957 L2004.5,3887.5957 L1994.5,3897.5957 L1942.5,3897.5957 L1942.5,3880.5957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="88.9316" style="stroke: #000000; stroke-width: 2.0;" width="750" x="1942.5" y="3880.5957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="1957.5" y="3894.1641">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="2019.5" y="3893.2305">[cachedTrace.masterSpan === currentSpan.spanId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2044.5" x2="2086.5" y1="3919.2168" y2="3919.2168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2086.5" x2="2086.5" y1="3919.2168" y2="3932.2168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2045.5" x2="2086.5" y1="3932.2168" y2="3932.2168"/><polygon fill="#A80036" points="2055.5,3928.2168,2045.5,3932.2168,2055.5,3936.2168,2051.5,3932.2168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2051.5" y="3914.4746">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="2073.5" y="3914.4746">masterSpan.finishTimestamp = resultTrace[resultTrace.length - 1].finishTimestamp</text><polygon fill="#A80036" points="2595.5,3957.5273,2605.5,3961.5273,2595.5,3965.5273,2599.5,3961.5273" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2039.5" x2="2601.5" y1="3961.5273" y2="3961.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2046.5" y="3956.7852">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="2068.5" y="3956.7852">send resultTrace</text><path d="M2522.5,3997.5273 L2642.5,3997.5273 L2642.5,4004.5273 L2632.5,4014.5273 L2522.5,4014.5273 L2522.5,3997.5273 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="178.8633" style="stroke: #000000; stroke-width: 2.0;" width="938.5" x="2522.5" y="3997.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="75" x="2537.5" y="4011.0957">send Trace</text><path d="M2532.5,4021.8379 L2606.5,4021.8379 L2606.5,4028.8379 L2596.5,4038.8379 L2532.5,4038.8379 L2532.5,4021.8379 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.9316" style="stroke: #000000; stroke-width: 2.0;" width="918.5" x="2532.5" y="4021.8379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="2547.5" y="4035.4063">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="2621.5" y="4034.4727">[trace elements]</text><polygon fill="#A80036" points="2857.5,4056.459,2867.5,4060.459,2857.5,4064.459,2861.5,4060.459" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2617.5" x2="2863.5" y1="4060.459" y2="4060.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2624.5" y="4055.7168">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="2646.5" y="4055.7168">send each span</text><polygon fill="#A80036" points="3404.5,4085.7695,3414.5,4089.7695,3404.5,4093.7695,3408.5,4089.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2869.5" x2="3410.5" y1="4089.7695" y2="4089.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2876.5" y="4085.0273">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="2898.5" y="4085.0273">send span to APM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="2617.5" x2="2659.5" y1="4126.0801" y2="4126.0801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2659.5" x2="2659.5" y1="4126.0801" y2="4139.0801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2618.5" x2="2659.5" y1="4139.0801" y2="4139.0801"/><polygon fill="#A80036" points="2628.5,4135.0801,2618.5,4139.0801,2628.5,4143.0801,2624.5,4139.0801" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2624.5" y="4121.3379">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="2646.5" y="4121.3379">unsubscribe scheduler for traceId</text><polygon fill="#A80036" points="3317.5,4164.3906,3327.5,4168.3906,3317.5,4172.3906,3321.5,4168.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2617.5" x2="3323.5" y1="4168.3906" y2="4168.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2624.5" y="4163.6484">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="2646.5" y="4163.6484">drop cachedTrace</text><!--
@startuml
title Event Streaming Processor flow

autonumber



collections "Notification topic" as TOPIC_NOTIFICATIONS
control "Topic Observable" as TOPIC_OBSERVABLE
control "Tracing Observable" as TRACING_OBSERVABLE
control "Caching Observable" as CACHING_OBSERVABLE
control "Check For Last Span Observable" as LASTSPAN_OBSERVABLE
control "Create Trace Observable" as CREATETRACE_OBSERVABLE
control "Cache Handler" as CACHE_HANDLER
control "Send Trace Handler" as TRACE_HANDLER
control "Send Span Handler" as SPAN_SENDER
database "Cache Storage" as CACHE
boundary "APM" as APM
boundary "Elasticsearch API" as ELASTIC

box "Central Services" #lightGray
	participant TOPIC_NOTIFICATIONS
end box

box "Event Stream Processor" #LightBlue
  participant TOPIC_OBSERVABLE
  participant TRACING_OBSERVABLE
  participant CACHING_OBSERVABLE
  participant LASTSPAN_OBSERVABLE
  participant CREATETRACE_OBSERVABLE
  participant TRACE_HANDLER
  participant SPAN_SENDER
  participant CACHE_HANDLER
end box

box "Cache" #LightSteelBlue
  participant CACHE
end box

box "Elasticsearch" #LightYellow
    participant APM
    participant ELASTIC
end box


group New Event Message Received
    TOPIC_NOTIFICATIONS -> TOPIC_OBSERVABLE: Consume Event Message
        activate TOPIC_OBSERVABLE
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        note over TOPIC_OBSERVABLE #yellow
            Message:
              {
                "from": "payeefsp",
                "to": "payerfsp",
                "id": "659ee338-c8f8-4c06-8aff-944e6c5cd694",
                "content": {
                  "headers": {
                    "content-type": "applicationvnd.interoperability.transfers+json;version=1.0",
                    "date": "2019-05-28T16:34:41.000Z",
                    "fspiop-source": "payeefsp",
                    "fspiop-destination": "payerfsp"
                  },
                  "payload": <payload>
                },
                "type": "application/json",
                "metadata": {
                  "event": {
                    "id": "3920382d-f78c-4023-adf9-0d7a4a2a3a2f",
                    "type": "trace",
                    "action": "span",
                    "createdAt": "2019-05-29T23:18:32.935Z",
                    "state": {
                      "status": "success",
                      "code": 0,
                      "description": "action successful"
                    },
                    "responseTo": "1a396c07-47ab-4d68-a7a0-7a1ea36f0012"
                  },
                  "trace": {
                    "service": "central-ledger-prepare-handler",
                    "traceId": "bbd7b2c7bbd7b2c7",
                    "parentSpanId": "44ba9bbc5840",
                    "spanId": "2aa9cd0a7e87",
                    "startTimestamp": "2015-08-29T11:22:09.815479Z",
                    "finishTimestamp": "2015-08-29T11:22:09.815479Z",
                    "tags": {
                      "transctionId": "659ee338-c8f8-4c06-8aff-944e6c5cd694",
                      "transctionType": "transfer",
                      "parentEventType": "bulk-prepare",
                      "parentEventAction": "prepare"
                    }
                  }
                }
              }
          end note
          TOPIC_OBSERVABLE -> ELASTIC: Send message for log purposes to custom index
          TOPIC_OBSERVABLE -> TOPIC_OBSERVABLE: Verify its tracing event Message
          TOPIC_OBSERVABLE -> TRACING_OBSERVABLE: Send Message to Tracing Observable
          deactivate TOPIC_OBSERVABLE
          activate TRACING_OBSERVABLE
            group Cache Span
            TRACING_OBSERVABLE -> CACHING_OBSERVABLE: Send Span Context, \nmetadata.State and Content\nfrom Message
            note right of TRACING_OBSERVABLE #yellow
              {
                spanContext: {
                  service: "central-ledger-prepare-handler",
                  traceId: "bbd7b2c7bbd7b2c7",
                  parentSpanId: "44ba9bbc5840",
                  spanId: "2aa9cd0a7e87",
                  startTimestamp: "2015-08-29T11:22:09.815479Z",
                  finishTimestamp: "2015-08-29T11:22:09.815479Z",
                  tags: {
                    transctionId: "659ee338-c8f8-4c06-8aff-944e6c5cd694",
                    transctionType: "transfer",
                    parentEventType: "bulk-prepare",
                    parentEventAction: "prepare"
                  },
                state: metadata.state,
                content
              }
            end note
                deactivate TRACING_OBSERVABLE
                activate CACHING_OBSERVABLE
                CACHING_OBSERVABLE <- CACHE: Get cachedTrace by traceId
                alt the span should not be cached
                  CACHING_OBSERVABLE -> SPAN_SENDER: currentSpan
                  SPAN_SENDER -> APM: store to APM
                  CACHING_OBSERVABLE -> CACHING_OBSERVABLE: Complete
                else
                  CACHING_OBSERVABLE <-> CACHING_OBSERVABLE: Validate transactionType, TransactionAction and service to match Config.START_CRITERIA && !parentSpandId
                  alt !cachedTrace
                    CACHING_OBSERVABLE -> CACHING_OBSERVABLE: Create new cachedTrace
                    note right of CACHING_OBSERVABLE #yellow
                    { 
                      spans: {},
                      masterSpan: null,
                      lastSpan: null
                    }
                    end note
                  end
                    alt !parentSpan
                      CACHING_OBSERVABLE <-> CACHING_OBSERVABLE: Generate MasterSpanId
                      CACHING_OBSERVABLE <-> CACHING_OBSERVABLE: Make received span child of masterSpan \nmerge({ parentSpanId: MasterSpanId }, { ...spanContext })
                      CACHING_OBSERVABLE <-> CACHING_OBSERVABLE: Create MasterSpanContext merge({ tags: { ...tags, masterSpan: MasterSpanId } }, \n{ ...spanContext }, \n{ spanId: MasterSpanId, service: `master-${tags.transactionType}` })
                      CACHING_OBSERVABLE <-> CACHING_OBSERVABLE: Add masterSpan to cachedTrace
                    end  
                      CACHING_OBSERVABLE <-> CACHE_HANDLER: Add span to cachedTrace
                      note right of CACHING_OBSERVABLE #yellow
                      { 
                        spans: {
                          2aa9cd0a7e87: {
                          state,
                          content 
                          spanContext: {
                            "service": "central-ledger-prepare-handler",
                            "traceId": "bbd7b2c7bbd7b2c7",
                            "parentSpanId": <b>MasterSpanId</b>,
                            "spanId": "2aa9cd0a7e87",
                            "startTimestamp": "2015-08-29T11:22:09.815479Z",
                            "finishTimestamp": "2015-08-29T11:22:09.815479Z",
                            "tags": {
                              "transctionId": "659ee338-c8f8-4c06-8aff-944e6c5cd694",
                              "transctionType": "transfer",
                              "parentEventType": "bulk-prepare",
                              "parentEventAction": "prepare"
                            }   
                          }
                        },
                        <b>MasterSpanId:</b> {
                          state,
                          content,
                          MasterSpanContext
                        }
                      },
                      masterSpan: <b>MasterSpanContext</b>,
                      lastSpan: null
                      }
                      end note     
                      CACHING_OBSERVABLE -> CACHE_HANDLER: Update cachedTrace to Cache
                      alt cachedTrace not staled or expired
                        CACHE_HANDLER -> CACHE_HANDLER: unsubscribe from Scheduler
                        CACHE_HANDLER -> CACHE: record cachedTrace
                        CACHE_HANDLER <-> CACHE_HANDLER: Reschedule scheduler for handling stale traces
                      end
                  end
              CACHING_OBSERVABLE -> LASTSPAN_OBSERVABLE: Send traceId to check if last span has been received\nand cached
              deactivate CACHING_OBSERVABLE
              activate LASTSPAN_OBSERVABLE
              end
              group Check for last span
                LASTSPAN_OBSERVABLE <- CACHE: Get cachedTrace by traceId
                LASTSPAN_OBSERVABLE -> LASTSPAN_OBSERVABLE: Sort spans by startTimestamp
                  loop for currentSpan of SortedSpans 
                    alt parentSpan
                      LASTSPAN_OBSERVABLE -> LASTSPAN_OBSERVABLE: isError = (errorCode in parentSpan \nOR parentSpan status === failed \nOR status === failed)
                      LASTSPAN_OBSERVABLE -> LASTSPAN_OBSERVABLE: apply masterSpan and error tags from parent to current span in cachedTrace
                      alt !isLastSpan
                        LASTSPAN_OBSERVABLE -> CACHE_HANDLER: Update cachedTrace to Cache
                        alt cachedTrace not staled or expired
                          CACHE_HANDLER -> CACHE_HANDLER: unsubscribe from Scheduler
                          CACHE_HANDLER -> CACHE: record cachedTrace
                          CACHE_HANDLER <-> CACHE_HANDLER: Reschedule scheduler for handling stale traces
                        end
                      else
                        LASTSPAN_OBSERVABLE -> LASTSPAN_OBSERVABLE: Validate transactionType, TransactionAction, service and isError \nto match Config.START_CRITERIA && !parentSpandId
                        LASTSPAN_OBSERVABLE -> LASTSPAN_OBSERVABLE: cachedTrace.lastSpan = currentSpan.spanContext
                        LASTSPAN_OBSERVABLE -> CACHE_HANDLER: Update cachedTrace to Cache
                        alt cachedTrace not staled or expired
                          CACHE_HANDLER -> CACHE_HANDLER: unsubscribe from Scheduler
                          CACHE_HANDLER -> CACHE: record cachedTrace
                          CACHE_HANDLER <-> CACHE_HANDLER: Reschedule scheduler for handling stale traces
                        end
                        LASTSPAN_OBSERVABLE -> CREATETRACE_OBSERVABLE: Send traceId
                        deactivate LASTSPAN_OBSERVABLE
                        activate CREATETRACE_OBSERVABLE   
                      end
                    end
                  end
                end
              group Recreate Trace from Cached Trace
                CREATETRACE_OBSERVABLE <- CACHE: get cachedTrace by TraceId
                alt cachedTrace.lastSpan AND cachedTrace.masterSpan
                  CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: currentSpan = lastSpan
                  CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: resultTrace = [lastSpan]
                  loop for i = 0; i < cachedTrace.spans.length; i++
                      CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: get parentSpan of currentSpan
                    alt parentSpan
                      CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: insert parent span in resultTrace in front
                    else
                      CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: break loop
                    end
                  end
                  alt cachedTrace.masterSpan === currentSpan.spanId
                    CREATETRACE_OBSERVABLE -> CREATETRACE_OBSERVABLE: masterSpan.finishTimestamp = resultTrace[resultTrace.length - 1].finishTimestamp  
                    CREATETRACE_OBSERVABLE -> TRACE_HANDLER: send resultTrace
                    deactivate CREATETRACE_OBSERVABLE
                    activate TRACE_HANDLER
                  end
                end
              end
                group send Trace
                  loop trace elements
                    TRACE_HANDLER -> SPAN_SENDER: send each span
                    SPAN_SENDER -> APM: send span to APM 
                  end
                  TRACE_HANDLER -> TRACE_HANDLER: unsubscribe scheduler for traceId
                  TRACE_HANDLER -> CACHE: drop cachedTrace

                end
            end
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 PHT 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>